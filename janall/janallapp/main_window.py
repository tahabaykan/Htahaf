"""
Ana pencere modÃ¼lÃ¼.

!!! Ã–NEMLÄ° DOSYA YOLU UYARISI !!!
=================================
BÃœTÃœN CSV OKUMA VE CSV KAYDETME Ä°ÅLEMLERÄ° StockTracker DÄ°ZÄ°NÄ°NE YAPILMALI!!
StockTracker/janall/ dizinine YAPILMAMALI!!!
KARIÅASAYI Ã–NLEMEK Ä°Ã‡Ä°N BU KURALA MUTLAKA UYULACAK!

Ã–rnek:
âœ… DOÄRU: "janalldata.csv" (StockTracker dizininde)
âŒ YANLIÅ: "janall/janalldata.csv"
=================================
"""

import tkinter as tk
from tkinter import ttk, messagebox, simpledialog
import pandas as pd
import numpy as np
import time
import os
import threading
import queue
from queue import Queue, Empty
from datetime import datetime, date
from typing import Dict, Any
from .etf_panel import ETFPanel
from .order_management import OrderManager, OrderBookWindow
from .bdata_storage import BDataStorage
from .stock_data_manager import StockDataManager
from .exception_manager import ExceptionListManager
from .exception_window import ExceptionListWindow

class MainWindow(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("JanAll")
        
        # Performans optimizasyonu flag'leri
        self.is_mini450_active = False
        self.background_data_cache = {}
        self.background_update_thread = None
        self.background_update_running = False
        
        # Thread-safe UI gÃ¼ncelleme iÃ§in Priority Queue
        # Ã–ncelik: 0 = KullanÄ±cÄ± etkileÅŸimi (en yÃ¼ksek), 1 = Normal UI gÃ¼ncelleme, 2 = Arka plan iÅŸlemleri
        self.ui_queue = Queue()
        self.user_interaction_queue = Queue()  # KullanÄ±cÄ± etkileÅŸimleri iÃ§in ayrÄ± queue (en yÃ¼ksek Ã¶ncelik)
        self.process_ui_queue()
        self.process_user_interactions()  # KullanÄ±cÄ± etkileÅŸimlerini hemen iÅŸle
        
        # Algoritma thread'leri iÃ§in flag'ler
        self.algorithm_threads = {}  # Ã‡alÄ±ÅŸan algoritma thread'lerini takip et
        self.algorithm_thread_lock = threading.Lock()  # Thread yÃ¶netimi iÃ§in lock
        
        # KullanÄ±cÄ± kontrolÃ¼ - her zaman Ã¶ncelikli
        self.user_control_priority = True  # KullanÄ±cÄ± her zaman kontrolÃ¼ elinde tutar
        
        # Multiprocessing iÃ§in AlgoProcessor
        from multiprocessing import Queue as MPQueue
        from .algo import AlgoProcessor
        
        # Process'ler arasÄ± iletiÅŸim iÃ§in queue'lar
        self.algo_command_queue = MPQueue()  # UI'dan process'e komut gÃ¶ndermek iÃ§in
        self.algo_result_queue = MPQueue()  # Process'ten UI'a sonuÃ§ almak iÃ§in
        
        # AlgoProcessor'Ä± baÅŸlat
        self.algo_processor = AlgoProcessor(
            ui_command_queue=self.algo_command_queue,
            ui_result_queue=self.algo_result_queue
        )
        
        # Algo result queue'yu dinle (her 100ms'de bir kontrol et)
        self.process_algo_results()
        
        # Hammer Pro client
        from .hammer_client import HammerClient
        self.hammer = HammerClient(
            host='127.0.0.1',  # localhost
            port=16400,        # varsayÄ±lan port
            password='Nl201090.',  # API ÅŸifresi
            main_window=self  # Main window referansÄ±
        )
        
        # IBKR TWS/Gateway client (ib_insync)
        from .ibkr_client import IBKRClient
        self.ibkr = IBKRClient(
            host='127.0.0.1',  # localhost
            port=4001,         # IBKR Gateway port (4001=live, 4002=paper)
            client_id=1,       # Client ID
            main_window=self   # Main window referansÄ±
        )
        
        # IBKR Native client (TWS API)
        from .ibkr_native_client import IBKRNativeClient
        self.ibkr_native = IBKRNativeClient(
            host='127.0.0.1',  # localhost
            port=4001,         # IBKR Gateway port (4001=live, 4002=paper)
            client_id=2,       # FarklÄ± Client ID (native iÃ§in)
            main_window=self   # Main window referansÄ±
        )
        
        # Mode Manager
        from .mode_manager import ModeManager
        self.mode_manager = ModeManager(
            hammer_client=self.hammer,
            ibkr_client=self.ibkr,
            ibkr_native_client=self.ibkr_native,
            main_window=self  # Controller kontrolÃ¼ iÃ§in
        )
        
        # Mod sistemi
        self.current_mode = "HAMPRO"  # HAMPRO veya IBKR
        self.hampro_mode = True
        self.ibkr_gun_mode = False
        self.ibkr_ped_mode = False
        
        # Order Manager
        self.order_manager = OrderManager(self)
        
        # GÃ¼nlÃ¼k befham.csv kontrolÃ¼
        self.befham_checked_today = False
        self.check_daily_befham()
        # GÃ¼nlÃ¼k befibgun.csv ve befibped.csv kontrolÃ¼ (IBKR iÃ§in)
        self.befibgun_checked_today = False
        self.befibped_checked_today = False
        
        # BDATA Storage
        self.bdata_storage = BDataStorage()
        
        # Stock Data Manager - Ana sayfa verilerini yÃ¶netmek iÃ§in
        self.stock_data_manager = StockDataManager()
        
        # Exception List Manager - Trade edilmemesi gereken hisseleri yÃ¶netir
        self.exception_manager = ExceptionListManager("exception_list.csv")
        
        # ETF verilerini takip etmek iÃ§in
        self.etf_data = {}
        
        # Benchmark hesaplama iÃ§in gerekli veriler
        self.pff_last = None
        self.tlt_last = None
        self.spy_last = None
        self.ief_last = None
        self.iei_last = None
        
        # Benchmark formÃ¼lleri (kupon oranlarÄ±na gÃ¶re) - %20 AZALTILMIÅ KATSAYILAR
        self.benchmark_formulas = {
            'DEFAULT': {'PFF': 1.1, 'TLT': -0.08, 'IEF': 0.0, 'IEI': 0.0},  # PFF*1.1 - TLT*0.08
            'C400': {'PFF': 0.36, 'TLT': 0.36, 'IEF': 0.08, 'IEI': 0.0},
            'C425': {'PFF': 0.368, 'TLT': 0.34, 'IEF': 0.092, 'IEI': 0.0},
            'C450': {'PFF': 0.38, 'TLT': 0.32, 'IEF': 0.10, 'IEI': 0.0},
            'C475': {'PFF': 0.40, 'TLT': 0.30, 'IEF': 0.12, 'IEI': 0.0},
            'C500': {'PFF': 0.32, 'TLT': 0.40, 'IEF': 0.08, 'IEI': 0.0},
            'C525': {'PFF': 0.42, 'TLT': 0.28, 'IEF': 0.14, 'IEI': 0.0},
            'C550': {'PFF': 0.408, 'TLT': 0.2, 'IEF': 0.152, 'IEI': 0.04},
            'C575': {'PFF': 0.44, 'TLT': 0.24, 'IEF': 0.16, 'IEI': 0.0},
            'C600': {'PFF': 0.432, 'TLT': 0.12, 'IEF': 0.168, 'IEI': 0.08},
            'C625': {'PFF': 0.448, 'TLT': 0.08, 'IEF': 0.172, 'IEI': 0.1}
        }
        
        # Ã–nceki ETF fiyatlarÄ± (deÄŸiÅŸim hesaplama iÃ§in)
        self.prev_etf_prices = {}
        
        # Stabil benchmark hesaplama iÃ§in
        self.stable_etf_changes = {}  # Son gÃ¼ncellenmiÅŸ sabit deÄŸerler
        self.etf_changes = {}  # ETF deÄŸiÅŸimleri (stable'dan kopyalanÄ±r)
        self.last_benchmark_update = 0  # Son gÃ¼ncelleme zamanÄ±
        self.benchmark_update_interval = 5.0  # 5 saniyede bir gÃ¼ncelle
        
        # Cache sistemi - hesaplama boÅŸluklarÄ±nÄ± Ã¶nle
        self.last_valid_scores = {}  # Her ticker iÃ§in son geÃ§erli skorlar
        
        # DÃ¶ngÃ¼ Raporu - RUNALL emir kararlarÄ±nÄ± takip
        self.loop_report = []  # Her emir kararÄ± iÃ§in detaylÄ± log
        self.loop_report_start_time = None  # DÃ¶ngÃ¼ baÅŸlangÄ±Ã§ zamanÄ±
        self.loop_report_loop_number = 0  # DÃ¶ngÃ¼ numarasÄ±
        
        # Psfalgo Aktivite Logu - TÃ¼m Psfalgo iÅŸlemlerini takip (uygulama kapanÄ±nca sÄ±fÄ±rlanÄ±r)
        self.psfalgo_activity_log = []  # Her iÅŸlem iÃ§in: {time, action, details, status, reason}
        
        # BaÅŸlangÄ±Ã§ta boÅŸ DataFrame
        self.df = pd.DataFrame()
        
        # Ana CSV dosyasÄ±nÄ± otomatik yÃ¼kle
        self.load_main_csv_on_startup()
        self.tickers = []
        
        # Sayfalama ayarlarÄ±
        self.items_per_page = 15
        self.current_page = 0
        self.total_pages = (len(self.tickers) + self.items_per_page - 1) // self.items_per_page
        
        # SÄ±ralama ayarlarÄ±
        self.sort_column = None
        self.sort_ascending = True
        
        self.setup_ui()
        
        # BaÅŸlangÄ±Ã§ta exposure bilgisini gÃ¼ncelle
        self.after(1000, self.update_exposure_display)  # 1 saniye sonra gÃ¼ncelle
    
    def process_ui_queue(self):
        """UI queue'sunu iÅŸle - thread'lerden gelen UI gÃ¼ncellemelerini main thread'de Ã§alÄ±ÅŸtÄ±r"""
        try:
            # Ã–nce kullanÄ±cÄ± etkileÅŸimlerini iÅŸle (en yÃ¼ksek Ã¶ncelik)
            while True:
                try:
                    callback, args, kwargs = self.user_interaction_queue.get_nowait()
                    callback(*args, **kwargs)
                except Empty:
                    break
            
            # Sonra normal UI gÃ¼ncellemelerini iÅŸle (limitli - kullanÄ±cÄ± etkileÅŸimlerini bloklamamak iÃ§in)
            processed = 0
            max_per_cycle = 5  # Her dÃ¶ngÃ¼de maksimum 5 normal gÃ¼ncelleme
            while processed < max_per_cycle:
                try:
                    callback, args, kwargs = self.ui_queue.get_nowait()
                    callback(*args, **kwargs)
                    processed += 1
                except Empty:
                    break
        except Exception as e:
            print(f"[UI_QUEUE] âš ï¸ Queue iÅŸleme hatasÄ±: {e}")
        finally:
            # Her 50ms'de bir queue'yu kontrol et (daha hÄ±zlÄ± yanÄ±t iÃ§in)
            self.after(50, self.process_ui_queue)
    
    def process_user_interactions(self):
        """KullanÄ±cÄ± etkileÅŸimlerini hemen iÅŸle - en yÃ¼ksek Ã¶ncelik"""
        try:
            while True:
                try:
                    callback, args, kwargs = self.user_interaction_queue.get_nowait()
                    # Hemen Ã§alÄ±ÅŸtÄ±r (bloklamadan)
                    callback(*args, **kwargs)
                except Empty:
                    break
        except Exception as e:
            print(f"[USER_INTERACTION] âš ï¸ KullanÄ±cÄ± etkileÅŸim iÅŸleme hatasÄ±: {e}")
        finally:
            # Her 10ms'de bir kontrol et (Ã§ok hÄ±zlÄ± yanÄ±t iÃ§in)
            self.after(10, self.process_user_interactions)
    
    def safe_ui_call(self, callback, *args, **kwargs):
        """Thread'lerden gÃ¼venli ÅŸekilde UI gÃ¼ncellemesi yapmak iÃ§in (normal Ã¶ncelik)"""
        self.ui_queue.put((callback, args, kwargs))
    
    def priority_ui_call(self, callback, *args, **kwargs):
        """KullanÄ±cÄ± etkileÅŸimleri iÃ§in yÃ¼ksek Ã¶ncelikli UI Ã§aÄŸrÄ±sÄ± - HEMEN Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r"""
        self.user_interaction_queue.put((callback, args, kwargs))
    
    def check_window_focus(self):
        """Pencere odak kontrolÃ¼ - kullanÄ±cÄ± pencereye tÄ±kladÄ±ÄŸÄ±nda Ã¶ne getir"""
        try:
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                if self.psfalgo_window.winfo_exists():
                    try:
                        # Pencere minimize edilmiÅŸse veya arka plandaysa, kullanÄ±cÄ± tÄ±kladÄ±ÄŸÄ±nda Ã¶ne getir
                        # Bu kontrolÃ¼ sÃ¼rekli yapmak yerine, sadece pencere event'lerinde yapalÄ±m
                        # Ama yine de periyodik kontrol yapalÄ±m (daha az sÄ±klÄ±kta)
                        pass
                    except:
                        pass
        except:
            pass
        finally:
            # Her 2 saniyede bir kontrol et (Ã§ok sÄ±k olmasÄ±n, UI'Ä± bloklamasÄ±n)
            self.after(2000, self.check_window_focus)
    
    def process_algo_results(self):
        """AlgoProcessor'dan gelen sonuÃ§larÄ± iÅŸle (multiprocessing queue)"""
        try:
            # TÃ¼m mevcut sonuÃ§larÄ± al (non-blocking)
            while True:
                try:
                    result = self.algo_result_queue.get_nowait()
                    self._handle_algo_result(result)
                except queue.Empty:
                    break
        except Exception as e:
            print(f"[ALGO_RESULT] âš ï¸ SonuÃ§ iÅŸleme hatasÄ±: {e}")
        finally:
            # Her 100ms'de bir kontrol et
            self.after(100, self.process_algo_results)
    
    def _handle_algo_result(self, result: Dict[str, Any]):
        """AlgoProcessor'dan gelen bir sonucu iÅŸle"""
        try:
            algorithm_name = result.get('algorithm_name', 'unknown')
            algorithm_type = result.get('algorithm_type', 'unknown')
            event = result.get('event', 'unknown')
            message = result.get('message', '')
            
            print(f"[ALGO_RESULT] {algorithm_name} ({algorithm_type}): {event} - {message}")
            
            # Event tipine gÃ¶re iÅŸle
            if event == 'started':
                self.safe_ui_call(self.log_message, f"â–¶ï¸ {algorithm_type.upper()} baÅŸlatÄ±ldÄ±: {algorithm_name}")
            elif event == 'completed':
                self.safe_ui_call(self.log_message, f"âœ… {algorithm_type.upper()} tamamlandÄ±: {algorithm_name}")
            elif event == 'error':
                self.safe_ui_call(self.log_message, f"âŒ {algorithm_type.upper()} hatasÄ±: {message}")
            elif event == 'progress':
                # Ä°lerleme mesajlarÄ±
                self.safe_ui_call(self.log_message, f"ğŸ”„ {algorithm_type.upper()}: {message}")
                
                # EÄŸer action varsa (KARBOTU, ADDNEWPOS baÅŸlatma gibi) iÅŸle
                action = result.get('action')
                if action == 'start_karbotu':
                    # KARBOTU'yu multiprocessing ile baÅŸlat
                    karbotu_name = f"karbotu_{int(time.time())}"
                    self.algo_processor.start_algorithm(
                        algorithm_name=karbotu_name,
                        algorithm_type="karbotu",
                        params={'from_runall': True}
                    )
                elif action == 'start_reducemore':
                    # REDUCEMORE'u multiprocessing ile baÅŸlat
                    reducemore_name = f"reducemore_{int(time.time())}"
                    exposure_mode = result.get('exposure_mode', 'DEFANSIVE')
                    self.algo_processor.start_algorithm(
                        algorithm_name=reducemore_name,
                        algorithm_type="reducemore",
                        params={
                            'from_runall': True,
                            'exposure_mode': exposure_mode
                        }
                    )
            elif event == 'runall_callback':
                # KARBOTU/REDUCEMORE tamamlandÄ±, ADDNEWPOS kontrolÃ¼ yap
                action = result.get('action')
                if action == 'check_addnewpos':
                    # ADDNEWPOS kontrolÃ¼ iÃ§in runall_check_karbotu_and_addnewpos benzeri mantÄ±k
                    # Åimdilik basit bir mesaj
                    self.safe_ui_call(self.log_message, "ğŸ”„ KARBOTU/REDUCEMORE tamamlandÄ±, ADDNEWPOS kontrolÃ¼ yapÄ±lÄ±yor...")
                    # TODO: Exposure kontrolÃ¼ yap ve ADDNEWPOS'u baÅŸlat
                elif action == 'start_addnewpos':
                    # ADDNEWPOS'u multiprocessing ile baÅŸlat
                    addnewpos_name = f"addnewpos_{int(time.time())}"
                    self.algo_processor.start_algorithm(
                        algorithm_name=addnewpos_name,
                        algorithm_type="addnewpos",
                        params={'from_runall': True}
                    )
            elif event == 'exposure_check':
                # Exposure kontrolÃ¼ sonucu
                exposure_info = result.get('exposure_info', {})
                pot_total = exposure_info.get('pot_total', 0)
                pot_max_lot = exposure_info.get('pot_max_lot', 63636)
                exposure_mode = exposure_info.get('mode', 'UNKNOWN')
                self.safe_ui_call(self.log_message, f"ğŸ“Š Exposure: Pot Total={pot_total:,}, Pot Max={pot_max_lot:,}, Mode={exposure_mode}")
            elif event == 'order_sent':
                # Emir gÃ¶nderildi mesajlarÄ±
                symbol = result.get('symbol', '')
                side = result.get('side', '')
                quantity = result.get('quantity', 0)
                price = result.get('price', 0)
                self.safe_ui_call(self.log_message, f"ğŸ“¤ {symbol}: {side} {quantity} lot @ ${price:.2f}")
            
        except Exception as e:
            print(f"[ALGO_RESULT] âŒ SonuÃ§ iÅŸleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def show_window_priority(self, window_func, *args, **kwargs):
        """Pencere aÃ§ma fonksiyonlarÄ±nÄ± Ã¶ncelikli olarak Ã§alÄ±ÅŸtÄ±r - KULLANICI Ã–NCELÄ°KLÄ°"""
        def open_window():
            try:
                win = window_func(*args, **kwargs)
                # Pencereyi hemen Ã¶ne getir ve focus ver
                if win:
                    if hasattr(win, 'lift'):
                        win.lift()
                    if hasattr(win, 'focus_force'):
                        win.focus_force()
                    elif hasattr(win, 'focus'):
                        win.focus()
                return win
            except Exception as e:
                print(f"[SHOW_WINDOW_PRIORITY] âŒ Hata: {e}")
                import traceback
                traceback.print_exc()
        
        # Priority queue ile hemen Ã§alÄ±ÅŸtÄ±r
        self.priority_ui_call(open_window)
    
    def load_main_csv_on_startup(self):
        """Uygulama baÅŸlarken ana CSV dosyasÄ±nÄ± otomatik yÃ¼kle"""
        try:
            csv_file = 'janalldata.csv'
            if os.path.exists(csv_file):
                print(f"[STARTUP] INFO Ana CSV dosyasi yukleniyor: {csv_file}")
                self.show_file_data(csv_file, is_main=True)
                print(f"[STARTUP] âœ… Ana CSV dosyasÄ± yÃ¼klendi: {len(self.df)} hisse")
            else:
                print(f"[STARTUP] âš ï¸ Ana CSV dosyasÄ± bulunamadÄ±: {csv_file}")
                print(f"[STARTUP] ğŸ’¡ Benchmark hesaplamalarÄ± iÃ§in CSV dosyasÄ± gerekli!")
        except Exception as e:
            print(f"[STARTUP] ERROR Ana CSV yukleme hatasi: {e}")
        
    def setup_ui(self):
        # Ãœst panel - BaÄŸlantÄ± butonlarÄ±
        top_frame = ttk.Frame(self)
        top_frame.pack(fill='x', padx=5, pady=5)
        
        self.btn_connect = ttk.Button(top_frame, text="Hammer Pro'ya BaÄŸlan", command=self.connect_hammer)
        self.btn_connect.pack(side='left', padx=2)
        
        self.btn_live = ttk.Button(top_frame, text="Live Data BaÅŸlat", command=self.toggle_live_data)
        self.btn_live.pack(side='left', padx=2)
        
        self.btn_prev_close = ttk.Button(top_frame, text="Prev Close Ã‡ek", command=self.fetch_all_prev_close)
        self.btn_prev_close.pack(side='left', padx=2)
        
        # BDATA butonlarÄ±
        bdata_frame = ttk.Frame(top_frame)
        bdata_frame.pack(side='right', padx=2)
        
        self.btn_bdata_export = ttk.Button(bdata_frame, text="BDATA Export", command=self.export_bdata, width=12)
        self.btn_bdata_export.pack(side='left', padx=1)
        
        self.btn_befday_export = ttk.Button(bdata_frame, text="BEFDAY Export", command=self.export_befday, width=12)
        self.btn_befday_export.pack(side='left', padx=1)
        
        self.btn_bdata_clear = ttk.Button(bdata_frame, text="BDATA Clear", command=self.clear_bdata, width=12)
        self.btn_bdata_clear.pack(side='left', padx=1)
        
        # Exception List butonu
        self.btn_exception_list = ttk.Button(bdata_frame, text="Exception List", command=self.open_exception_list, width=12)
        self.btn_exception_list.pack(side='left', padx=1)
        
        # Stock Data Manager Durum butonu
        self.btn_stock_data_status = ttk.Button(bdata_frame, text="Stock Data Status", 
                                              command=self.show_stock_data_status, width=15)
        self.btn_stock_data_status.pack(side='left', padx=1)
        
        # Exposure bilgisi gÃ¶sterimi - Lot BÃ¶lÃ¼cÃ¼ yanÄ±na taÅŸÄ±nacak
        
        # Port Adjuster butonu
        self.btn_port_adjuster = ttk.Button(top_frame, text="Port Adjuster", width=14,
                                           command=self.show_port_adjuster)
        self.btn_port_adjuster.pack(side='left', padx=4)
        
        # PozisyonlarÄ±m butonu
        from .mypositions import show_positions_window
        self.btn_mypos = ttk.Button(top_frame, text="PozisyonlarÄ±m", width=14,
                                    command=lambda: self.show_positions())
        self.btn_mypos.pack(side='left', padx=4)
        
        # Take Profit Longs butonu
        self.btn_take_profit_longs = ttk.Button(top_frame, text="Take Profit Longs", width=16,
                                               command=self.show_take_profit_longs)
        self.btn_take_profit_longs.pack(side='left', padx=4)
        
        # Take Profit Shorts butonu
        self.btn_take_profit_shorts = ttk.Button(top_frame, text="Take Profit Shorts", width=16,
                                                command=self.show_take_profit_shorts)
        self.btn_take_profit_shorts.pack(side='left', padx=4)
        
        # Spreadkusu butonu
        self.btn_spreadkusu = ttk.Button(top_frame, text="Spreadkusu", width=12,
                                        command=self.show_spreadkusu)
        self.btn_spreadkusu.pack(side='left', padx=4)
        
        # Emirlerim butonu
        self.btn_my_orders = ttk.Button(top_frame, text="Emirlerim", width=12,
                                       command=self.show_my_orders)
        self.btn_my_orders.pack(side='left', padx=4)
        
        # BEFHAM butonu (befham.csv)
        from .befpos_exporter import show_befpos_exporter
        self.btn_befpos = ttk.Button(top_frame, text="BEFHAM", width=10,
                                    command=lambda: show_befpos_exporter(self.hammer))
        self.btn_befpos.pack(side='left', padx=4)
        
        # jdata Analiz butonu
        from .myjdata import show_jdata_window
        self.btn_jdata = ttk.Button(top_frame, text="jdata Analiz", width=14,
                                    command=lambda: show_jdata_window(self, self.get_last_price_for_symbol))
        self.btn_jdata.pack(side='left', padx=4)
        
        # Top Ten Bid Buy butonu
        self.btn_top_ten_bid_buy = ttk.Button(top_frame, text="Top Ten Bid Buy", width=16,
                                              command=self.top_ten_bid_buy)
        self.btn_top_ten_bid_buy.pack(side='left', padx=4)
        
        # Bottom Ten Ask Sell butonu
        self.btn_bottom_ten_ask_sell = ttk.Button(top_frame, text="Bottom Ten Ask Sell", width=18,
                                                  command=self.bottom_ten_ask_sell)
        self.btn_bottom_ten_ask_sell.pack(side='left', padx=4)
        
        # Port Adjuster butonu
        self.btn_port_adjuster = ttk.Button(top_frame, text="Port Adjuster", width=14,
                                           command=self.show_port_adjuster)
        self.btn_port_adjuster.pack(side='left', padx=4)
        
        # Order Management ButonlarÄ±
        order_frame = ttk.Frame(self)
        order_frame.pack(fill='x', padx=5, pady=2)
        
        # Order butonlarÄ±
        self.btn_bid_buy = ttk.Button(order_frame, text="Bid Buy", 
                                     command=lambda: self.order_manager.place_order_for_selected('bid_buy'), width=10)
        self.btn_bid_buy.pack(side='left', padx=1)
        
        self.btn_front_buy = ttk.Button(order_frame, text="Front Buy", 
                                       command=lambda: self.order_manager.place_order_for_selected('front_buy'), width=10)
        self.btn_front_buy.pack(side='left', padx=1)
        
        self.btn_ask_buy = ttk.Button(order_frame, text="Ask Buy", 
                                     command=lambda: self.order_manager.place_order_for_selected('ask_buy'), width=10)
        self.btn_ask_buy.pack(side='left', padx=1)
        
        self.btn_ask_sell = ttk.Button(order_frame, text="Ask Sell", 
                                      command=lambda: self.order_manager.place_order_for_selected('ask_sell'), width=10)
        self.btn_ask_sell.pack(side='left', padx=1)
        
        self.btn_front_sell = ttk.Button(order_frame, text="Front Sell", 
                                        command=lambda: self.order_manager.place_order_for_selected('front_sell'), width=10)
        self.btn_front_sell.pack(side='left', padx=1)
        
        # Soft Front butonlarÄ±
        self.btn_soft_front_buy = ttk.Button(order_frame, text="SoftFront Buy", 
                                           command=lambda: self.order_manager.place_order_for_selected('soft_front_buy'), width=12)
        self.btn_soft_front_buy.pack(side='left', padx=1)
        
        self.btn_soft_front_sell = ttk.Button(order_frame, text="SoftFront Sell", 
                                            command=lambda: self.order_manager.place_order_for_selected('soft_front_sell'), width=12)
        self.btn_soft_front_sell.pack(side='left', padx=1)
        
        self.btn_bid_sell = ttk.Button(order_frame, text="Bid Sell", 
                                      command=lambda: self.order_manager.place_order_for_selected('bid_sell'), width=10)
        self.btn_bid_sell.pack(side='left', padx=1)
        
        # Lot seÃ§im frame
        lot_frame = ttk.Frame(self)
        lot_frame.pack(fill='x', padx=5, pady=2)
        
        # Manuel lot giriÅŸi
        ttk.Label(lot_frame, text="Lot:").pack(side='left', padx=2)
        self.lot_entry = ttk.Entry(lot_frame, width=8)
        self.lot_entry.pack(side='left', padx=2)
        self.lot_entry.insert(0, "200")  # Default 200 lot
        
        # Lot butonlarÄ±
        self.btn_lot_25 = ttk.Button(lot_frame, text="%25", 
                                    command=lambda: self.order_manager.set_lot_percentage(25), width=6)
        self.btn_lot_25.pack(side='left', padx=1)
        
        self.btn_lot_50 = ttk.Button(lot_frame, text="%50", 
                                    command=lambda: self.order_manager.set_lot_percentage(50), width=6)
        self.btn_lot_50.pack(side='left', padx=1)
        
        self.btn_lot_75 = ttk.Button(lot_frame, text="%75", 
                                    command=lambda: self.order_manager.set_lot_percentage(75), width=6)
        self.btn_lot_75.pack(side='left', padx=1)
        
        self.btn_lot_100 = ttk.Button(lot_frame, text="%100", 
                                     command=lambda: self.order_manager.set_lot_percentage(100), width=6)
        self.btn_lot_100.pack(side='left', padx=1)
        
        self.btn_lot_avg_adv = ttk.Button(lot_frame, text="Avg Adv", 
                                         command=self.order_manager.set_lot_avg_adv, width=8)
        self.btn_lot_avg_adv.pack(side='left', padx=1)
        
        # SeÃ§im butonlarÄ±
        selection_frame = ttk.Frame(self)
        selection_frame.pack(fill='x', padx=5, pady=2)
        
        self.btn_select_all = ttk.Button(selection_frame, text="TÃ¼mÃ¼nÃ¼ SeÃ§", 
                                       command=self.order_manager.select_all_tickers, width=12)
        self.btn_select_all.pack(side='left', padx=1)
        
        self.btn_deselect_all = ttk.Button(selection_frame, text="TÃ¼mÃ¼nÃ¼ KaldÄ±r", 
                                         command=self.order_manager.deselect_all_tickers, width=12)
        self.btn_deselect_all.pack(side='left', padx=1)
        
        # Mod butonlarÄ± - TÃ¼mÃ¼nÃ¼ SeÃ§ ve TÃ¼mÃ¼nÃ¼ KaldÄ±r butonlarÄ±nÄ±n yanÄ±na taÅŸÄ±ndÄ±
        self.btn_hampro_mode = ttk.Button(selection_frame, text="HAMPRO MOD", width=12,
                                         command=lambda: self.set_mode("HAMPRO"))
        self.btn_hampro_mode.pack(side='left', padx=2)
        
        self.btn_ibkr_gun_mode = ttk.Button(selection_frame, text="IBKR GUN MOD", width=14,
                                           command=lambda: self.set_mode("IBKR_GUN"))
        self.btn_ibkr_gun_mode.pack(side='left', padx=2)
        
        self.btn_ibkr_ped_mode = ttk.Button(selection_frame, text="IBKR PED MOD", width=14,
                                           command=lambda: self.set_mode("IBKR_PED"))
        self.btn_ibkr_ped_mode.pack(side='left', padx=2)
        
        # Tablo - CSV'den gelen tÃ¼m kolonlarÄ± kullan
        # BaÅŸlangÄ±Ã§ta boÅŸ, CSV yÃ¼klendiÄŸinde gÃ¼ncellenecek
        self.columns = ['SeÃ§']  # SeÃ§ kolonu her zaman ilk
        
        # Style ayarla - kÃ¼Ã§Ã¼k font
        style = ttk.Style()
        style.configure("Treeview", font=('Arial', 6))
        style.configure("Treeview.Heading", font=('Arial', 6, 'bold'))
        
        self.table = ttk.Treeview(self, columns=self.columns, show='headings', height=15)
        
        # Ã‡ift tÄ±klama olayÄ±nÄ± baÄŸla
        self.table.bind('<Double-1>', self.on_double_click)
        
        # Checkbox tÄ±klama olayÄ±nÄ± baÄŸla - sadece SeÃ§ kolonu iÃ§in
        self.table.bind('<ButtonRelease-1>', self.on_table_click)
        
        # Kolon baÅŸlÄ±klarÄ± ve geniÅŸlikleri  
        score_columns = [
            'Bid_buy_ucuzluk_skoru', 'Front_buy_ucuzluk_skoru', 'Ask_buy_ucuzluk_skoru',
            'Ask_sell_pahalilik_skoru', 'Front_sell_pahalilik_skoru', 'Bid_sell_pahalilik_skoru',
            'Final_BB_skor', 'Final_FB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor', 'Final_SAS_skor', 'Final_SFS_skor', 'Final_SBS_skor',
            'Spread'
        ]
        benchmark_columns = ['Benchmark_Type', 'Benchmark_Chg']
        
        for col in self.columns:
            # SÄ±ralama fonksiyonunu baÄŸla
            self.table.heading(col, 
                text=col,
                command=lambda c=col: self.sort_by_column(c))
                
            if col in ['PREF IBKR']:
                self.table.column(col, width=35, anchor='w')  # Sol hizalÄ± - Ã§ok dar
            elif col in ['CMON', 'CGRUP']:
                self.table.column(col, width=15, anchor='center')  # En dar
            elif col in ['SMI', 'SHORT_FINAL']:
                self.table.column(col, width=20, anchor='center')  # Dar
            elif col in ['FINAL_THG', 'AVG_ADV']:
                self.table.column(col, width=25, anchor='center')  # Orta
            elif col in score_columns:
                self.table.column(col, width=30, anchor='center')  # Skor kolonlarÄ± - Ã§ok dar
            elif col in benchmark_columns:
                self.table.column(col, width=20, anchor='center') # Benchmark kolonlarÄ± - orta
            else:
                self.table.column(col, width=20, anchor='center')  # Normal - Ã§ok dar
                
        self.table.pack(fill='both', expand=True, padx=5, pady=5)
        
        # Mod butonlarÄ±nÄ± ayarla
        self.setup_mode_buttons()
        
        # CSV dosya butonlarÄ±
        files_frame = ttk.Frame(self)
        files_frame.pack(fill='x', padx=5, pady=5)
        
        # Ana veri butonu
        main_frame = ttk.Frame(files_frame)
        main_frame.pack(fill='x', pady=2)
        
        btn_main = ttk.Button(main_frame, text="JANALLDATA", 
                            command=lambda: self.show_file_data('janalldata.csv', is_main=True))
        btn_main.pack(side='left', padx=2)
        
        # Mini450 butonu - TÃ¼m hisseleri mini gÃ¶rÃ¼nÃ¼mde gÃ¶ster
        btn_mini450 = ttk.Button(main_frame, text="ğŸ” mini450", 
                                command=self.show_mini450_view, 
                                style='Accent.TButton')
        btn_mini450.pack(side='left', padx=5)
        
        # MAJBINA butonu - Filtreleme ve analiz penceresi
        btn_majbina = ttk.Button(main_frame, text="ğŸ” MAJBINA", 
                                command=self.show_majbina_window, 
                                style='Accent.TButton')
        btn_majbina.pack(side='left', padx=5)
        
        # Psfalgo butonu - Pozisyon yÃ¶netimi robotu
        btn_psfalgo = ttk.Button(main_frame, text="ğŸ¤– Psfalgo", 
                                command=self.start_psfalgo_robot, 
                                style='Accent.TButton')
        btn_psfalgo.pack(side='left', padx=5)
        
        # Compare It butonu - PortfÃ¶y karÅŸÄ±laÅŸtÄ±rmasÄ±
        self.btn_compare_it = ttk.Button(main_frame, text="ğŸ“Š Compare It", 
                                        command=self.show_portfolio_comparison,
                                        style='Accent.TButton')
        self.btn_compare_it.pack(side='left', padx=5)
        
        # Lot BÃ¶lÃ¼cÃ¼ butonu - Emirleri 200er lotlar halinde bÃ¶l
        self.lot_divider_enabled = False
        self.btn_lot_divider = ttk.Button(main_frame, text="ğŸ“¦ Lot BÃ¶lÃ¼cÃ¼: OFF", 
                                        command=self.toggle_lot_divider, 
                                        style='Accent.TButton')
        self.btn_lot_divider.pack(side='left', padx=5)
        
        # Exposure bilgisi gÃ¶sterimi - Lot BÃ¶lÃ¼cÃ¼ yanÄ±nda
        self.exposure_label = ttk.Label(main_frame, text="HAMPRO mod aÃ§Ä±k - Long: 0.00 | Short: 0.00 | Total: 0.00", 
                                       font=('Arial', 9, 'bold'), foreground='blue')
        self.exposure_label.pack(side='left', padx=10)
        
        # AyÄ±rÄ±cÄ± Ã§izgi
        separator = ttk.Separator(files_frame, orient='horizontal')
        separator.pack(fill='x', pady=5)
        
        # CSV dosya isimleri - janek_ssfinek dosyalarÄ±nÄ± kullan (prev_close kolonu var)
        csv_files = [
            'janek_ssfinekheldcilizyeniyedi.csv',
            'janek_ssfinekheldcommonsuz.csv',
            'janek_ssfinekhelddeznff.csv',
            'janek_ssfinekheldff.csv',
            'janek_ssfinekheldflr.csv',
            'janek_ssfinekheldgarabetaltiyedi.csv',
            'janek_ssfinekheldkuponlu.csv',
            'janek_ssfinekheldkuponlukreciliz.csv',
            'janek_ssfinekheldkuponlukreorta.csv',
            'janek_ssfinekheldnff.csv',
            'janek_ssfinekheldotelremorta.csv',
            'janek_ssfinekheldsolidbig.csv',
            'janek_ssfinekheldtitrekhc.csv',
            'janek_ssfinekhighmatur.csv',
            'janek_ssfineknotbesmaturlu.csv',
            'janek_ssfineknotcefilliquid.csv',
            'janek_ssfineknottitrekhc.csv',
            'janek_ssfinekrumoreddanger.csv',
            'janek_ssfineksalakilliquid.csv',
            'janek_ssfinekshitremhc.csv'
        ]
        
        # Her satÄ±rda 10 buton olacak ÅŸekilde dÃ¼zenle
        buttons_per_row = 10
        current_frame = ttk.Frame(files_frame)
        current_frame.pack(fill='x', pady=2)
        
        for i, file in enumerate(csv_files):
            # Her 10 butonda bir yeni satÄ±r baÅŸlat
            if i > 0 and i % buttons_per_row == 0:
                current_frame = ttk.Frame(files_frame)
                current_frame.pack(fill='x', pady=2)
            
            # Dosya adÄ±nÄ± kÄ±salt
            short_name = file.replace('janek_ssfinek', '').replace('.csv', '')
            btn = ttk.Button(current_frame, text=short_name, command=lambda f=file: self.show_file_data(f))
            btn.pack(side='left', padx=2)
        
        # SRPAN butonu - Grup butonlarÄ±nÄ±n saÄŸÄ±na ekle
        self.btn_srpan = ttk.Button(current_frame, text="SRPAN", 
                                   command=self.show_srpan_analysis,
                                   style='Accent.TButton')
        self.btn_srpan.pack(side='left', padx=10)
        
        # Pressure Analiz butonu - SRPAN'Ä±n yanÄ±na
        self.btn_pressure = ttk.Button(current_frame, text="ğŸ“Š Pressure Analiz", 
                                       command=self.show_pressure_analysis,
                                       style='Accent.TButton')
        self.btn_pressure.pack(side='left', padx=5)
        
        # BGGG Analiz butonu - Pressure Analiz'in yanÄ±na
        self.btn_bggg = ttk.Button(current_frame, text="ğŸ“ˆ BGGG", 
                                   command=self.show_bggg_analysis,
                                   style='Accent.TButton')
        self.btn_bggg.pack(side='left', padx=5)
        
        # Ticker Alerts butonu - SRPAN'Ä±n yanÄ±na
        self.btn_ticker_alerts = ttk.Button(current_frame, text="ğŸ“Š Ticker Alerts", 
                                           command=self.show_ticker_alerts,
                                           style='Accent.TButton')
        self.btn_ticker_alerts.pack(side='left', padx=5)
        
        # ETF Cardinal butonu - Ticker Alerts'in yanÄ±na
        self.btn_etf_cardinal = ttk.Button(current_frame, text="ğŸ¯ ETF Cardinal", 
                                          command=self.show_etf_cardinal,
                                          style='Accent.TButton')
        self.btn_etf_cardinal.pack(side='left', padx=5)
        
        # TGFilterer butonu - ETF Cardinal'Ä±n yanÄ±na
        self.btn_tgfilterer = ttk.Button(current_frame, text="ğŸ” TGFilterer", 
                                        command=self.show_tgfilterer,
                                        style='Accent.TButton')
        self.btn_tgfilterer.pack(side='left', padx=5)
        
        # SRPAN iÃ§in son seÃ§ilen grup
        self.srpan_current_group = None
        self.srpan_current_data = None
        
        # Ticker Alerts iÃ§in veri yapÄ±larÄ±
        self.ticker_alerts_data = {}  # {symbol: {'high': x, 'low': y, 'last': z}}
        self.ticker_alert_history = []  # Alert geÃ§miÅŸi
        
        # ETF Cardinal iÃ§in veri yapÄ±larÄ±
        self.cardinal_running = False
        self.cardinal_price_history = []  # [{timestamp, PFF, SPY, KRE, IWM, TLT}, ...]
        self.cardinal_settings = {
            'PFF': {'threshold_2min': 0.04, 'threshold_5min': 0.06, 'type': 'absolute'},
            'SPY': {'threshold_2min': 0.4, 'threshold_5min': 0.6, 'type': 'percent'},
            'KRE': {'threshold_2min': 0.4, 'threshold_5min': 0.6, 'type': 'percent'},
            'IWM': {'threshold_2min': 0.5, 'threshold_5min': 0.75, 'type': 'percent'},
            'TLT': {'threshold_2min': 0.40, 'threshold_5min': 0.60, 'type': 'absolute'}
        }
        self.cardinal_window = None
        self.cardinal_after_id = None
        
        # ETF Paneli
        self.etf_panel = ETFPanel(self, self.hammer)
        self.etf_panel.pack(fill='x', padx=5, pady=5)
        
        # AyÄ±rÄ±cÄ± Ã§izgi
        separator = ttk.Separator(self, orient='horizontal')
        separator.pack(fill='x', pady=5)
        
        # Sayfalama kontrolleri
        nav_frame = ttk.Frame(self)
        nav_frame.pack(fill='x', padx=5, pady=5)
        
        self.btn_prev = ttk.Button(nav_frame, text="<", command=self.prev_page)
        self.btn_prev.pack(side='left', padx=2)
        
        self.lbl_page = ttk.Label(nav_frame, text=f"Sayfa {self.current_page + 1} / {self.total_pages}")
        self.lbl_page.pack(side='left', padx=10)
        
        self.btn_next = ttk.Button(nav_frame, text=">", command=self.next_page)
        self.btn_next.pack(side='left', padx=2)
        
        # Ä°lk sayfayÄ± gÃ¶ster
        self.update_table()
        
    def export_bdata(self):
        """BDATA ve BEFDAY CSV'lerini oluÅŸtur"""
        try:
            self.bdata_storage.export_to_csv()
            messagebox.showinfo("BaÅŸarÄ±lÄ±", "BDATA ve BEFDAY CSV'leri oluÅŸturuldu!")
        except Exception as e:
            messagebox.showerror("Hata", f"BDATA export hatasÄ±: {e}")
    
    def export_befday(self):
        """Sadece BEFDAY CSV'sini oluÅŸtur"""
        try:
            summary = self.bdata_storage.get_position_summary_with_snapshot()
            self.bdata_storage.create_befday_csv(summary)
            messagebox.showinfo("BaÅŸarÄ±lÄ±", "BEFDAY CSV'si oluÅŸturuldu!")
        except Exception as e:
            messagebox.showerror("Hata", f"BEFDAY export hatasÄ±: {e}")
    
    def clear_bdata(self):
        """BDATA verilerini temizle"""
        if messagebox.askyesno("Onay", "TÃ¼m BDATA verilerini temizlemek istediÄŸinizden emin misiniz?"):
            try:
                self.bdata_storage.clear_all_data()
                messagebox.showinfo("BaÅŸarÄ±lÄ±", "BDATA verileri temizlendi!")
            except Exception as e:
                messagebox.showerror("Hata", f"BDATA temizleme hatasÄ±: {e}")
    
    def add_manual_fill(self, ticker, direction, price, size):
        """Manuel fill ekle"""
        try:
            self.bdata_storage.add_manual_fill(ticker, direction, price, size)
            print(f"[MANUAL FILL] {ticker} {direction} {size}@{price} eklendi")
        except Exception as e:
            print(f"[MANUAL FILL] Hata: {e}")
    
    def update_etf_data_for_benchmark(self):
        """STABÄ°L ETF benchmark hesaplama - 5 saniyede bir gÃ¼ncelle"""
        try:
            import time
            current_time = time.time()
            
            # 5 saniyede bir gÃ¼ncelle (sÃ¼rekli deÄŸil!)
            if current_time - self.last_benchmark_update < self.benchmark_update_interval:
                return  # HenÃ¼z zamanÄ± gelmedi
            
            # Benchmark ETF'ler
            benchmark_etfs = ['SPY', 'TLT', 'IEF', 'IEI', 'PFF', 'KRE', 'IWM']
            
            # ETF Panel'deki cache'lenmiÅŸ verileri kullan (daha stabil)
            if hasattr(self, 'etf_panel') and self.etf_panel:
                for etf in benchmark_etfs:
                    # ETF Panel'deki aynÄ± veri kaynaÄŸÄ±nÄ± kullan!
                    if etf in self.etf_panel.etf_data:
                        etf_data = self.etf_panel.etf_data[etf]
                        last_price = etf_data.get('last', 0)
                        
                        # ETF Panel'deki CSV'den prev_close al (aynÄ± kaynak!)
                        csv_prev_close = self.etf_panel.get_etf_prev_close(etf)
                        
                        if last_price > 0 and csv_prev_close > 0:
                            # ETF Panel'deki aynÄ± hesaplama yÃ¶ntemi!
                            change_dollars = round(last_price - csv_prev_close, 4)
                            self.stable_etf_changes[etf] = change_dollars
                        else:
                            self.stable_etf_changes[etf] = 0
                    else:
                        # ETF Panel'de yoksa CSV'den al
                        csv_prev_close = self.etf_panel.get_etf_prev_close(etf)
                        if csv_prev_close > 0:
                            # Market data'dan last price al
                            market_data = self.hammer.get_market_data(etf)
                            if market_data:
                                last_price = market_data.get('last', 0)
                                if last_price > 0:
                                    change_dollars = round(last_price - csv_prev_close, 4)
                                    self.stable_etf_changes[etf] = change_dollars
                                else:
                                    self.stable_etf_changes[etf] = 0
                            else:
                                self.stable_etf_changes[etf] = 0
                        else:
                            self.stable_etf_changes[etf] = 0
            
            # Son gÃ¼ncelleme zamanÄ±nÄ± kaydet
            self.last_benchmark_update = current_time
            
            # self.etf_changes'i stable deÄŸerlerle gÃ¼ncelle
            self.etf_changes = self.stable_etf_changes.copy()
                
        except Exception as e:
            pass
    
    def get_benchmark_type_for_ticker(self, ticker):
        """Ticker iÃ§in benchmark tipini belirle (CGRUP'a gÃ¶re)"""
        try:
            # DataFrame'i kontrol et
            if self.df.empty:
                return 'DEFAULT'
            
            # Ticker'Ä± DataFrame'de ara
            ticker_row = self.df[self.df['PREF IBKR'] == ticker]
            
            if ticker_row.empty:
                return 'DEFAULT'
            
            # CGRUP kolonundan deÄŸeri al
            cgrup_str = ticker_row.iloc[0]['CGRUP']
            
            if pd.isna(cgrup_str) or cgrup_str == '':
                return 'DEFAULT'
            
            # CGRUP deÄŸerini benchmark key'e Ã§evir
            # CGRUP deÄŸerleri zaten 'c525' formatÄ±nda geliyor, direkt kullan
            if str(cgrup_str).lower().startswith('c'):
                benchmark_key = str(cgrup_str).upper()  # 'c525' -> 'C525'
            else:
                # Eski format: sayÄ±sal deÄŸer (5.25 -> C525)
                benchmark_key = f"C{int(float(cgrup_str) * 100)}"
            
            if benchmark_key in self.benchmark_formulas:
                return benchmark_key
            else:
                return 'DEFAULT'
                
        except Exception as e:
            return 'DEFAULT'
    
    def get_benchmark_change_for_ticker(self, ticker):
        """STABÄ°L Ticker benchmark deÄŸiÅŸimini hesapla - 2 decimal yuvarlamalÄ±"""
        try:
            # Ã–nce stable ETF verilerini gÃ¼ncelle (5s interval ile)
            self.update_etf_data_for_benchmark()
            
            if not hasattr(self, 'etf_changes') or not self.etf_changes:
                return 0.0
            
            # Ticker'Ä±n benchmark tipini al
            benchmark_type = self.get_benchmark_type_for_ticker(ticker)
            formula = self.benchmark_formulas.get(benchmark_type, self.benchmark_formulas['DEFAULT'])
            
            # STABÄ°L benchmark deÄŸiÅŸimini hesapla (2 decimal yuvarlama)
            benchmark_change = 0.0
            for etf, coefficient in formula.items():
                if etf in self.etf_changes and coefficient != 0:
                    etf_change = round(self.etf_changes[etf], 4)  # ETF change'i yuvarla
                    coefficient_rounded = round(coefficient, 2)    # KatsayÄ±yÄ± yuvarla
                    contribution = etf_change * coefficient_rounded
                    benchmark_change += contribution
            
            # 4 decimal'e yuvarla (stabil sonuÃ§ iÃ§in)
            benchmark_change = round(benchmark_change, 4)
            
            # Benchmark shift deÄŸerini uygula (General BM Shifter)
            if hasattr(self, 'benchmark_shift') and self.benchmark_shift != 0.0:
                benchmark_change = benchmark_change + self.benchmark_shift
                benchmark_change = round(benchmark_change, 4)
            
            return benchmark_change
            
        except Exception as e:
            return 0.0
    
    def connect_hammer(self):
        """Hammer Pro'ya baÄŸlan/baÄŸlantÄ±yÄ± kes"""
        if not self.hammer.connected:
            print("\n[HAMMER] OK Hammer Pro'ya baglaniliyor...")
            print(f"[HAMMER] OK Host: {self.hammer.host}")
            print(f"[HAMMER] OK Port: {self.hammer.port}")
            
            if self.hammer.connect():
                self.btn_connect.config(text="BaÄŸlantÄ±yÄ± Kes")
                print("[HAMMER] OK Baglanti basarili!")
                
                # NFILLED callback'lerini ayarla (fill logging iÃ§in)
                self.setup_nfilled_callbacks()
                
                # BaÄŸlantÄ± kurulduktan sonra befham.csv gÃ¼nlÃ¼k kontrol (00:00-16:30)
                if not self.befham_checked_today:
                    self.check_daily_befham()
            else:
                print("[HAMMER] ERROR Baglanti basarisiz!")
                print("[HAMMER] INFO Kontrol edilecekler:")
                print("   1. Hammer Pro Ã§alÄ±ÅŸÄ±yor mu?")
                print("   2. Port numarasÄ± doÄŸru mu?")
                print("   3. API ÅŸifresi doÄŸru mu?")
        else:
            print("\n[HAMMER] OK Baglanti kesiliyor...")
            self.hammer.disconnect()
            self.btn_connect.config(text="Hammer Pro'ya BaÄŸlan")
            print("[HAMMER] OK Baglanti kesildi.")
            
    def toggle_live_data(self):
        """Live data akÄ±ÅŸÄ±nÄ± baÅŸlat/durdur"""
        if not hasattr(self, 'live_data_running'):
            self.live_data_running = False
            
        if not self.live_data_running:
            # Ã–nce janalldata.csv'yi yÃ¼kle ve tÃ¼m sembollere subscribe ol
            self.show_file_data('janalldata.csv', is_main=True)
            
            # ETF'ler iÃ§in sadece snapshot (L1 subscription yok)
            print("\n[ETF] OK ETF'ler icin snapshot sistemi baslatiliyor...")
            self.etf_panel.subscribe_etfs()  # Sadece snapshot Ã§eker artÄ±k
            
            self.live_data_running = True
            self.btn_live.config(text="Live Data Durdur")
            
            # ETF verilerini gÃ¼ncelleme dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
            self.update_etf_data()
            
            # Ana tabloyu gÃ¼ncelleme dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
            self.update_live_data()
        else:
            self.live_data_running = False
            self.btn_live.config(text="Live Data BaÅŸlat")
            
            # ArtÄ±k snapshot sistemi yok, L1 streaming kullanÄ±yoruz
            
    def fetch_all_prev_close(self):
        """TÃ¼m hisseler iÃ§in previous close deÄŸerlerini Ã§ek - KALDIRILDI!"""
        print("[PREV CLOSE] ğŸš« PREV CLOSE Ã‡EKME Ä°ÅLEMÄ° TAMAMEN KALDIRILDI!")
        print("[PREV CLOSE] ğŸš« Streaming veri kullanÄ±lacak, prev close Ã§ekilmeyecek!")
        return
            
    def fetch_prev_close_for_ticker(self, ticker):
        """Bir hisse iÃ§in previous close deÄŸerini Ã§ek - KALDIRILDI!"""
        print(f"[PREV CLOSE] ğŸš« PREV CLOSE Ã‡EKME Ä°ÅLEMÄ° TAMAMEN KALDIRILDI: {ticker}")
        return
    
    def load_prev_close_from_csv(self):
        """CSV dosyalarÄ±ndan prev_close deÄŸerlerini yÃ¼kle"""
        try:
            # CSV dosyalarÄ±ndan prev_close deÄŸerleri yÃ¼kleniyor...
            
            # janek_ss*.csv dosyalarÄ±nÄ± bul
            csv_files = []
            for file in os.listdir('.'):
                if file.startswith('janek_ss') and file.endswith('.csv'):
                    csv_files.append(file)
            
            # Bulunan dosyalar: {csv_files}
            
            # Cache'i temizle
            if hasattr(self, 'prev_close_cache'):
                delattr(self, 'prev_close_cache')
            self.prev_close_cache = {}
            
            # Her dosyayÄ± oku ve prev_close deÄŸerlerini al
            for csv_file in csv_files:
                try:
                    df_csv = pd.read_csv(csv_file, encoding='utf-8-sig')
                    
                    # PREF IBKR ve prev_close kolonlarÄ±nÄ± kontrol et
                    if 'PREF IBKR' in df_csv.columns and 'prev_close' in df_csv.columns:
                        # {csv_file} okundu: {len(df_csv)} satÄ±r
                        
                        # prev_close deÄŸerlerini cache'le
                        for idx, row in df_csv.iterrows():
                            ticker = row['PREF IBKR']
                            prev_close = row['prev_close']
                            
                            # NaN kontrolÃ¼
                            if pd.notna(prev_close) and prev_close > 0:
                                self.prev_close_cache[ticker] = float(prev_close)
                                # {ticker}: prev_close={prev_close}
                            else:
                                # {ticker}: prev_close={prev_close} (geÃ§ersiz)
                                pass
                    
                    else:
                        # {csv_file}: PREF IBKR veya prev_close kolonu bulunamadÄ±
                        pass
                
                except Exception as e:
                    continue
            
        except Exception as e:
            pass
            
    def update_scores_with_market_data(self):
        """Market data ile skorlarÄ± gÃ¼ncelle - CSV'den prev_close oku"""
        try:
            # ETF verileri otomatik gÃ¼ncelleniyor (5s interval)
            
            # CSV'lerden prev_close deÄŸerlerini yÃ¼kle
            self.load_prev_close_from_csv()
            
            # Sadece gÃ¶rÃ¼nÃ¼r ticker'lar iÃ§in iÅŸle (performans iÃ§in)
            visible_tickers = self.get_visible_tickers()
            
            # PREFERRED STOCK'LAR Ä°Ã‡Ä°N SADECE L1 STREAMING KULLANILACAK!
            # SNAPSHOT Ä°STEKLERÄ° TAMAMEN KALDIRILDI!
            
            for idx, row in self.df.iterrows():
                ticker = row['PREF IBKR']
                
                # Sadece gÃ¶rÃ¼nÃ¼r ticker'lar iÃ§in skorlarÄ± hesapla
                if ticker not in visible_tickers:
                    continue
                    
                # TÃ¼m hisseler iÃ§in iÅŸle (ETF'ler ayrÄ± panelde)
                # Sadece ETF'leri hariÃ§ tut
                etf_list = ["SPY", "TLT", "IEF", "IEI", "PFF", "KRE", "IWM", "SHY", "PGF"]
                if ticker in etf_list:
                    continue
                    
                market_data = self.hammer.get_market_data(ticker)
                
                # Market data'dan deÄŸerleri al (sadece streaming'den)
                bid = market_data.get('bid', 0)
                ask = market_data.get('ask', 0)
                last_price = market_data.get('last', 0)
                
                # DataFrame'den prev_close deÄŸerini al
                df_prev_close = row.get('prev_close', 0)
                # print(f"[DEBUG] {ticker}: DataFrame'den df_prev_close={df_prev_close}")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
                
                if df_prev_close != 'N/A' and df_prev_close > 0:
                    prev_close = float(df_prev_close)
                    # print(f"[DEBUG] {ticker}: DataFrame'den prev_close kullanÄ±lÄ±yor: {prev_close}")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
                else:
                    # Cache'den al (fallback)
                    prev_close = self.get_prev_close_for_symbol(ticker)
                    # print(f"[DEBUG] {ticker}: Cache'den prev_close alÄ±ndÄ±: {prev_close}")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
                
                # DataFrame'e prev_close kolonunu ekle (zaten var ama gÃ¼ncelle)
                self.df.at[idx, 'prev_close'] = prev_close
                
                # Debug: Streaming veri durumunu kontrol et
                if bid == 0 and ask == 0:
                    # print(f"[SKOR] âš ï¸ {ticker} iÃ§in streaming veri yok (bid={bid}, ask={ask})")
                    continue
                    
                # Benchmark deÄŸiÅŸimini hesapla
                benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                benchmark_type = self.get_benchmark_type_for_ticker(ticker)
                
                # SkorlarÄ± hesapla
                scores = self.calculate_scores(ticker, row, bid, ask, last_price, prev_close, benchmark_chg)
                
                # DataFrame'i gÃ¼ncelle
                for col, value in scores.items():
                    try:
                        # Kolonu ekle (yoksa)
                        if col not in self.df.columns:
                            self.df[col] = 'N/A'
                        self.df.at[idx, col] = value
                        # Debug: Ä°lk 3 ticker iÃ§in DataFrame'e yazÄ±lan deÄŸerleri gÃ¶ster
                        # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
                        # if idx < 3 and col in ['Final_BB_skor', 'Final_SAS_skor']:
                        #     print(f"[DATAFRAME] {ticker}: {col} = {value}")
                    except Exception as e:
                        print(f"[DATAFRAME ERROR] {ticker} - {col}: {e}")
                
                # Benchmark deÄŸerlerini gÃ¼ncelle
                self.df.at[idx, 'Benchmark_Type'] = benchmark_type
                self.df.at[idx, 'Benchmark_Chg'] = benchmark_chg
                    
        except Exception as e:
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            pass
            # print(f"[HATA] Skor gÃ¼ncelleme hatasÄ±: {e}")
    
    def calculate_scores_for_all_stocks(self):
        """TÃ¼m hisseler iÃ§in skorlarÄ± hesapla"""
        try:
            if not hasattr(self, 'df') or self.df is None:
                # print("[SKOR] âš ï¸ DataFrame bulunamadÄ±")
                return
            
            # print("[SKOR] ğŸ”„ TÃ¼m hisseler iÃ§in skorlar hesaplanÄ±yor...")
            
            for index, row in self.df.iterrows():
                ticker = row['PREF IBKR']
                
                # Market data al (cache'den Ã¶ncelik ver)
                if self.is_mini450_active:
                    market_data = self.get_cached_market_data(ticker)
                else:
                    market_data = self.hammer.get_market_data(ticker) if hasattr(self, 'hammer') and self.hammer else None
                
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    last_price = float(market_data.get('last', 0))
                else:
                    bid = ask = last_price = 0
                
                # Prev close al
                prev_close = self.get_prev_close_for_symbol(ticker)
                
                # Benchmark change al
                benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                
                # SkorlarÄ± hesapla
                self.calculate_scores(ticker, row, bid, ask, last_price, prev_close, benchmark_chg)
            
            # print("[SKOR] âœ… TÃ¼m skorlar hesaplandÄ±")
            
        except Exception as e:
            # print(f"[SKOR] âŒ Skor hesaplama hatasÄ±: {e}")
            pass
    
    # calculate_scores_for_stock FONKSÄ°YONU KALDIRILDI - YANLIÅ FORMÃœLLER VARDI!
    # ArtÄ±k calculate_scores FONKSÄ°YONU KULLANILIYOR - DOÄRU FORMÃœLLER!
    
    def calculate_scores(self, ticker, row, bid, ask, last_price, prev_close, benchmark_chg=0):
        """Ntahaf formÃ¼llerine gÃ¶re skorlarÄ± hesapla - 800 katsayÄ±sÄ± ile final skorlama - Parametre olarak gelen prev_close kullan"""
        try:
            # Parametre olarak gelen prev_close deÄŸerini kullan (daha gÃ¼venilir!)
            if prev_close <= 0:
                # Fallback: DataFrame'den al
                df_prev_close = row.get('prev_close', 0)
                if df_prev_close != 'N/A' and df_prev_close > 0:
                    prev_close = float(df_prev_close)
                    # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
                    # print(f"[SKOR] âš ï¸ {ticker}: DataFrame'den fallback prev_close={prev_close}")
                else:
                    # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
                    # print(f"[SKOR] âŒ {ticker}: prev_close bulunamadÄ±! DataFrame={df_prev_close}, Parametre={prev_close}")
                    return None
            
            # Spread hesapla
            spread = float(ask) - float(bid) if ask != 'N/A' and bid != 'N/A' and ask > 0 and bid > 0 else 0
            
            # Passive fiyatlar hesapla (Ntahaf formÃ¼lleri)
            pf_bid_buy = float(bid) + (spread * 0.15) if bid > 0 else 0
            pf_front_buy = float(last_price) + 0.01 if last_price > 0 else 0
            pf_ask_buy = float(ask) + 0.01 if ask > 0 else 0
            pf_ask_sell = float(ask) - (spread * 0.15) if ask > 0 else 0
            pf_front_sell = float(last_price) - 0.01 if last_price > 0 else 0
            pf_bid_sell = float(bid) - 0.01 if bid > 0 else 0
            
            # DeÄŸiÅŸimler hesapla (Ntahaf formÃ¼lleri) - DataFrame'den prev_close kullan
            pf_bid_buy_chg = pf_bid_buy - prev_close if prev_close > 0 else 0
            pf_front_buy_chg = pf_front_buy - prev_close if prev_close > 0 else 0
            pf_ask_buy_chg = pf_ask_buy - prev_close if prev_close > 0 else 0
            pf_ask_sell_chg = pf_ask_sell - prev_close if prev_close > 0 else 0
            pf_front_sell_chg = pf_front_sell - prev_close if prev_close > 0 else 0
            pf_bid_sell_chg = pf_bid_sell - prev_close if prev_close > 0 else 0
            
            # Ucuzluk/Pahalilik skorlarÄ± (Ntahaf formÃ¼lleri)
            bid_buy_ucuzluk = pf_bid_buy_chg - benchmark_chg
            front_buy_ucuzluk = pf_front_buy_chg - benchmark_chg
            ask_buy_ucuzluk = pf_ask_buy_chg - benchmark_chg
            ask_sell_pahali = pf_ask_sell_chg - benchmark_chg
            front_sell_pahali = pf_front_sell_chg - benchmark_chg
            bid_sell_pahali = pf_bid_sell_chg - benchmark_chg
            
            # Final skorlar (FINAL_THG varsa kullan, yoksa 0)
            final_thg_raw = row.get('FINAL_THG', 0)
            final_thg = float(final_thg_raw) if final_thg_raw != 'N/A' else 0
            
            # Debug: Ä°lk 3 ticker iÃ§in detaylÄ± bilgi
            if ticker in ['AHL PRE', 'AHL PRD', 'ATH PRD']:
                # print(f"[SKOR DEBUG] {ticker}:")
                # print(f"  prev_close={prev_close}, benchmark_chg={benchmark_chg}")
                # print(f"  pf_bid_buy={pf_bid_buy:.4f}, pf_bid_buy_chg={pf_bid_buy_chg:.4f}")
                # print(f"  bid_buy_ucuzluk={bid_buy_ucuzluk:.4f}")
                # print(f"  FINAL_THG raw={final_thg_raw}, final_thg={final_thg:.2f}")
                # print(f"  final_bb hesaplama: {final_thg:.2f} - 800 * {bid_buy_ucuzluk:.4f} = {final_thg - 800 * bid_buy_ucuzluk:.2f} (800 katsayÄ±sÄ±)")
                # print(f"  [800 KATSAYISI] Final skorlama sistemi gÃ¼ncellendi!")
                pass
            
            def final_skor(final_thg, skor):
                """Final skor hesaplama - 800 katsayÄ±sÄ± ile"""
                return final_thg - 800 * skor
            
            final_bb = final_skor(final_thg, bid_buy_ucuzluk)
            final_fb = final_skor(final_thg, front_buy_ucuzluk)
            final_ab = final_skor(final_thg, ask_buy_ucuzluk)
            final_as = final_skor(final_thg, ask_sell_pahali)
            final_fs = final_skor(final_thg, front_sell_pahali)
            final_bs = final_skor(final_thg, bid_sell_pahali)
            
            # Yeni Final SAS, Final SFS, Final SBS skorlarÄ± (SHORT_FINAL kullanarak - Ã§Ä±karma formÃ¼lÃ¼)
            short_final = float(row.get('SHORT_FINAL', 0)) if row.get('SHORT_FINAL') != 'N/A' else 0
            final_sas = short_final - 800 * ask_sell_pahali if short_final > 0 else 0
            final_sfs = short_final - 800 * front_sell_pahali if short_final > 0 else 0
            final_sbs = short_final - 800 * bid_sell_pahali if short_final > 0 else 0
            
            # BaÅŸarÄ±lÄ± hesaplanan skorlarÄ± cache'e kaydet
            calculated_scores = {
                'Bid_buy_ucuzluk_skoru': round(bid_buy_ucuzluk, 2),
                'Front_buy_ucuzluk_skoru': round(front_buy_ucuzluk, 2),
                'Ask_buy_ucuzluk_skoru': round(ask_buy_ucuzluk, 2),
                'Ask_sell_pahalilik_skoru': round(ask_sell_pahali, 2),
                'Front_sell_pahalilik_skoru': round(front_sell_pahali, 2),
                'Bid_sell_pahalilik_skoru': round(bid_sell_pahali, 2),
                'Final_BB_skor': round(final_bb, 2),
                'Final_FB_skor': round(final_fb, 2),
                'Final_AB_skor': round(final_ab, 2),
                'Final_AS_skor': round(final_as, 2),
                'Final_FS_skor': round(final_fs, 2),
                'Final_BS_skor': round(final_bs, 2),
                'Final_SAS_skor': round(final_sas, 2),
                'Final_SFS_skor': round(final_sfs, 2),
                'Final_SBS_skor': round(final_sbs, 2),
                'Spread': round(spread, 4)
            }
            
            # Cache'e kaydet
            if not hasattr(self, 'last_valid_scores'):
                self.last_valid_scores = {}
            self.last_valid_scores[ticker] = calculated_scores
            
            return calculated_scores
        except Exception as e:
            # Cache'den son geÃ§erli deÄŸerleri al (varsa)
            if hasattr(self, 'last_valid_scores') and ticker in self.last_valid_scores:
                cached_scores = self.last_valid_scores[ticker]
                print(f"[CACHE] {ticker} iÃ§in cached skorlar kullanÄ±lÄ±yor")
                return cached_scores
            else:
                print(f"[HATA] Skor hesaplama hatasÄ±: {e}")
                return {
                    'Bid_buy_ucuzluk_skoru': 0,
                    'Front_buy_ucuzluk_skoru': 0,
                    'Ask_buy_ucuzluk_skoru': 0,
                    'Ask_sell_pahalilik_skoru': 0,
                    'Front_sell_pahalilik_skoru': 0,
                    'Bid_sell_pahalilik_skoru': 0,
                    'Final_BB_skor': 0,
                    'Final_FB_skor': 0,
                    'Final_AB_skor': 0,
                    'Final_AS_skor': 0,
                    'Final_FS_skor': 0,
                    'Final_BS_skor': 0,
                    'Final_SAS_skor': 0,
                    'Final_SFS_skor': 0,
                    'Final_SBS_skor': 0,
                    'Spread': 0
                }

    def update_live_data(self):
        if not self.live_data_running:
            return
            
        # GUI gÃ¼ncellemesini daha az sÄ±klÄ±kta yap (mini450'de)
        if hasattr(self, 'is_mini450_active') and self.is_mini450_active:
            # Mini450 modunda GUI gÃ¼ncellemesini yavaÅŸlat
            self.update_table()
            self.update_scores_with_market_data() # SkorlarÄ± gÃ¼ncelle
            self.after(3000, self.update_live_data)  # Mini450'de 3 saniyede bir
        else:
            # Normal modda hÄ±zlÄ± gÃ¼ncelleme
            self.update_table()
            self.update_scores_with_market_data() # SkorlarÄ± gÃ¼ncelle
            self.after(1000, self.update_live_data)  # Normal modda 1 saniyede bir
        
    def update_etf_data(self):
        """ETF verilerini gÃ¼ncelle"""
        if not self.live_data_running:
            return
            
        try:
            # Her ETF iÃ§in market verilerini al ve paneli gÃ¼ncelle
            for symbol in self.etf_panel.etf_list:
                market_data = self.hammer.get_market_data(symbol)
                self.etf_panel.update_etf_data(symbol, market_data)
                
            # ETF display'ini gÃ¼ncelle (ana tabloyu etkilemeden)
            self.etf_panel.update_etf_display()
                
        except Exception as e:
            print(f"[HATA] ETF gÃ¼ncelleme hatasÄ±: {e}")
            
        # Her 2 saniyede bir gÃ¼ncelle (ana tablodan baÄŸÄ±msÄ±z)
        self.after(2000, self.update_etf_data)
        
    def get_visible_tickers(self):
        start_idx = self.current_page * self.items_per_page
        end_idx = min(start_idx + self.items_per_page, len(self.tickers))
        return self.tickers[start_idx:end_idx]
        
    def sort_by_column(self, column):
        """SeÃ§ilen kolona gÃ¶re sÄ±rala"""
        if self.sort_column == column:
            # AynÄ± kolona tekrar tÄ±klandÄ±, sÄ±ralama yÃ¶nÃ¼nÃ¼ deÄŸiÅŸtir
            self.sort_ascending = not self.sort_ascending
        else:
            # Yeni kolon seÃ§ildi, artan sÄ±ralama ile baÅŸla
            self.sort_column = column
            self.sort_ascending = True
            
        # DataFrame'i sÄ±rala
        try:
            # SayÄ±sal kolonlar iÃ§in nan'larÄ± sona at
            if column in ['FINAL_THG', 'AVG_ADV', 'SMI', 'SHORT_FINAL', 'SMA63 chg', 'SMA246 chg', 'SMA 246 CHG', 'GORT', 'Bid', 'Ask', 'Last', 'Volume']:
                # Ã–nce string 'N/A' deÄŸerlerini NaN'a Ã§evir
                self.df[column] = pd.to_numeric(self.df[column], errors='coerce')
                
            # SÄ±rala
            self.df = self.df.sort_values(
                by=column,
                ascending=self.sort_ascending,
                na_position='last'
            )
            
            # SÄ±ralanmÄ±ÅŸ ticker listesini gÃ¼ncelle
            self.tickers = self.df['PREF IBKR'].tolist()
            
            # BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
            direction = "â†‘" if self.sort_ascending else "â†“"
            for col in self.table["columns"]:
                if col == column:
                    self.table.heading(col, text=f"{col} {direction}")
                else:
                    self.table.heading(col, text=col)
                    
            # Tabloyu gÃ¼ncelle
            self.current_page = 0  # Ä°lk sayfaya dÃ¶n
            self.update_table()
            
        except Exception as e:
            print(f"[HATA] SÄ±ralama hatasÄ± ({column}): {e}")
        
    def update_table(self):
        # Mevcut seÃ§imleri kaydet
        selected_items = {}
        for item in self.table.get_children():
            ticker = self.table.set(item, 'PREF IBKR')
            is_selected = self.table.set(item, 'SeÃ§') == 'âœ“'
            if is_selected:
                selected_items[ticker] = True
        
        # GÃ¶rÃ¼nÃ¼r ticker'larÄ± al
        visible_tickers = self.get_visible_tickers()
        
        # Tabloyu temizle ve yeniden oluÅŸtur (sadece ilk kez veya sayfa deÄŸiÅŸtiÄŸinde)
        if not hasattr(self, '_last_visible_tickers') or self._last_visible_tickers != visible_tickers:
            # Tabloyu temizle
            for item in self.table.get_children():
                self.table.delete(item)
            
            # Yeni gÃ¶rÃ¼nÃ¼r preferred stock'lara REAL-TIME L1 subscribe ol (sadece preferred stock'lar)
            if hasattr(self, 'live_data_running') and self.live_data_running:
                print(f"\n[PREF] ğŸ”„ {len(visible_tickers)} preferred stock iÃ§in REAL-TIME L1 streaming...")
                
                # Preferred stock'larÄ± kaydet
                self.preferred_tickers = [ticker for ticker in visible_tickers 
                                        if " PR" in ticker or " PRA" in ticker or " PRC" in ticker]
                
                for ticker in self.preferred_tickers:
                    self.hammer.subscribe_symbol(ticker)  # ArtÄ±k bu L1 streaming yapacak (real-time)
                    print(f"[PREF] âœ… {ticker} L1 streaming baÅŸlatÄ±ldÄ±")
                
                # 2s snapshot sistemi IPTAL - artÄ±k real-time L1 streaming kullanÄ±yoruz!
            
            # Her ticker iÃ§in satÄ±r ekle
            for ticker in visible_tickers:
                try:
                    # CSV'den statik verileri al
                    row_data = self.df[self.df['PREF IBKR'] == ticker].iloc[0]
                    
                    # Statik deÄŸerleri formatla
                    final_thg = row_data.get('FINAL_THG', 'N/A')
                    if isinstance(final_thg, (int, float)) and not np.isnan(final_thg):
                        final_thg = f"{final_thg:.2f}"
                        
                    avg_adv = row_data.get('AVG_ADV', 'N/A')
                    if isinstance(avg_adv, (int, float)) and not np.isnan(avg_adv):
                        avg_adv = f"{avg_adv:.2f}"
                        
                    smi = row_data.get('SMI', 'N/A')
                    if isinstance(smi, (int, float)) and not np.isnan(smi):
                        smi = f"{smi:.4f}"
                        
                    short_final = row_data.get('SHORT_FINAL', 'N/A')
                    if isinstance(short_final, (int, float)) and not np.isnan(short_final):
                        short_final = f"{short_final:.2f}"
                    
                    # Skor deÄŸerlerini al
                    bid_buy_ucuzluk = row_data.get('Bid_buy_ucuzluk_skoru', 'N/A')
                    front_buy_ucuzluk = row_data.get('Front_buy_ucuzluk_skoru', 'N/A')
                    ask_buy_ucuzluk = row_data.get('Ask_buy_ucuzluk_skoru', 'N/A')
                    ask_sell_pahali = row_data.get('Ask_sell_pahalilik_skoru', 'N/A')
                    front_sell_pahali = row_data.get('Front_sell_pahalilik_skoru', 'N/A')
                    bid_sell_pahali = row_data.get('Bid_sell_pahalilik_skoru', 'N/A')
                    final_bb = row_data.get('Final_BB_skor', 'N/A')
                    final_fb = row_data.get('Final_FB_skor', 'N/A')
                    final_ab = row_data.get('Final_AB_skor', 'N/A')
                    final_as = row_data.get('Final_AS_skor', 'N/A')
                    final_fs = row_data.get('Final_FS_skor', 'N/A')
                    final_bs = row_data.get('Final_BS_skor', 'N/A')
                    spread = row_data.get('Spread', 'N/A')
                    
                    # Benchmark deÄŸerlerini al
                    benchmark_type = row_data.get('Benchmark_Type', 'N/A')
                    benchmark_chg = row_data.get('Benchmark_Chg', 'N/A')
                    
                    # Skor deÄŸerlerini formatla
                    def format_score(value):
                        if isinstance(value, (int, float)) and not np.isnan(value):
                            return f"{value:.2f}"
                        return 'N/A'
                    
                    # SeÃ§im durumunu kontrol et
                    selection_status = "âœ“" if ticker in selected_items else ""
                    
                    # CSV'den mevcut kolonlarÄ± al (show_file_data'dan available_columns kullan)
                    # Bu satÄ±rlarÄ± kaldÄ±rdÄ±k Ã§Ã¼nkÃ¼ available_columns zaten show_file_data'da tanÄ±mlanmÄ±ÅŸ
                    
                    # SeÃ§ kolonu ile baÅŸla
                    row_values = [selection_status]
                    
                    # CSV'den belirli kolonlarÄ± ekle (SMA63 chg ve SMA246 chg kolonlarÄ± eklendi)
                    available_columns = [col for col in ['PREF IBKR', 'prev_close', 'CMON', 'CGRUP', 'FINAL_THG', 'AVG_ADV', 'SMI', 'SMA63 chg', 'SMA246 chg', 'SMA 246 CHG', 'SHORT_FINAL'] if col in self.df.columns]
                    
                    # prev_close kolonu kontrolÃ¼ (janek_ssfinek dosyalarÄ±nda mevcut olmalÄ±)
                    # Debug mesajlarÄ± kapatÄ±ldÄ± - performans iÃ§in
                    # if 'prev_close' not in self.df.columns:
                    #     print(f"[UPDATE_TABLE] âš ï¸ prev_close kolonu bulunamadÄ±")
                    # else:
                    #     print(f"[UPDATE_TABLE] âœ… prev_close kolonu bulundu")
                    for col in available_columns:
                        value = row_data.get(col, 'N/A')
                        if isinstance(value, (int, float)) and not np.isnan(value):
                            if col in ['SMI']:
                                value = f"{value:.4f}"
                            elif col in ['prev_close']:
                                value = f"{value:.2f}"
                            else:
                                value = f"{value:.2f}"
                        row_values.append(value)
                    
                    # Skor kolonlarÄ±nÄ± ekle (kendi hesapladÄ±ÄŸÄ±mÄ±z)
                    score_columns = [
                        'Bid_buy_ucuzluk_skoru', 'Front_buy_ucuzluk_skoru', 'Ask_buy_ucuzluk_skoru',
                        'Ask_sell_pahalilik_skoru', 'Front_sell_pahalilik_skoru', 'Bid_sell_pahalilik_skoru',
                        'Final_BB_skor', 'Final_FB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor', 'Final_SAS_skor', 'Final_SFS_skor', 'Final_SBS_skor',
                        'Spread', 'Fbtot', 'SFStot'
                    ]
                    
                    for col in score_columns:
                        value = row_data.get(col, 'N/A')
                        if col in ['Fbtot', 'SFStot']:
                            # Fbtot ve SFStot string olarak saklanÄ±yor (Ã¶rn: "1.2345")
                            if value != 'N/A' and value is not None:
                                try:
                                    # String deÄŸeri float'a Ã§evir ve formatla
                                    float_value = float(value)
                                    value = f"{float_value:.4f}"
                                except (ValueError, TypeError):
                                    value = 'N/A'
                        elif isinstance(value, (int, float)) and not np.isnan(value):
                            value = f"{value:.2f}"
                        row_values.append(value)
                    
                    # Benchmark kolonlarÄ±nÄ± ekle (kendi hesapladÄ±ÄŸÄ±mÄ±z)
                    benchmark_type = row_data.get('Benchmark_Type', 'N/A')
                    benchmark_chg = row_data.get('Benchmark_Chg', 'N/A')
                    if isinstance(benchmark_chg, (int, float)) and not np.isnan(benchmark_chg):
                        benchmark_chg = f"{benchmark_chg:.2f}"
                    row_values.extend([benchmark_type, benchmark_chg])
                    
                    # GORT kolonunu ekle (cache'lenmiÅŸ hesaplama)
                    # Ã–nce DataFrame'den kontrol et (daha Ã¶nce hesaplanmÄ±ÅŸ olabilir)
                    gort_value = None
                    if ticker in self.df['PREF IBKR'].values:
                        ticker_idx = self.df[self.df['PREF IBKR'] == ticker].index[0]
                        if 'GORT' in self.df.columns:
                            existing_gort = self.df.at[ticker_idx, 'GORT']
                            if pd.notna(existing_gort) and existing_gort != 0:
                                gort_value = existing_gort
                    
                    # DataFrame'de yoksa hesapla (cache mekanizmasÄ± iÃ§inde)
                    if gort_value is None:
                        gort_value = self.calculate_gort(ticker)
                        # DataFrame'e de kaydet (sÄ±ralama iÃ§in)
                        if ticker in self.df['PREF IBKR'].values:
                            ticker_idx = self.df[self.df['PREF IBKR'] == ticker].index[0]
                            self.df.at[ticker_idx, 'GORT'] = gort_value if isinstance(gort_value, (int, float)) and not np.isnan(gort_value) else np.nan
                    
                    if isinstance(gort_value, (int, float)) and not np.isnan(gort_value):
                        gort_value = f"{gort_value:.2f}"
                    else:
                        gort_value = 'N/A'
                    row_values.append(gort_value)
                    
                    # Live kolonlarÄ± ekle (baÅŸlangÄ±Ã§ta N/A)
                    row_values.extend(['N/A', 'N/A', 'N/A', 'N/A'])  # Bid, Ask, Last, Volume
                except Exception as e:
                    print(f"[HATA] {ticker} iÃ§in veri hatasÄ±: {e}")
                    selection_status = "âœ“" if ticker in selected_items else ""
                    # Dinamik olarak kolon sayÄ±sÄ±nÄ± hesapla
                    total_columns = len(self.columns) - 1  # 'SeÃ§' kolonunu Ã§Ä±kar
                    row_values = [selection_status] + [ticker] + ['N/A'] * (total_columns - 1)
                
                # SatÄ±rÄ± ekle
                self.table.insert('', 'end', values=row_values)
            
            # GÃ¶rÃ¼nÃ¼r ticker'larÄ± kaydet
            self._last_visible_tickers = visible_tickers
            
            # Stock Data Manager'Ä± gÃ¼ncelle - Ana tablo verilerini kaydet
            if not self.df.empty:
                self.stock_data_manager.update_stock_data_from_main_table(self.df, self.columns)
        
        # Sadece live data kolonlarÄ±nÄ± gÃ¼ncelle (seÃ§imleri koruyarak)
        for item in self.table.get_children():
            ticker = self.table.set(item, 'PREF IBKR')
            if ticker in visible_tickers:
                try:
                    # Hammer Pro'dan live verileri al
                    market_data = self.hammer.get_market_data(ticker)
                    if not market_data:
                        continue
                        
                    bid_raw = market_data.get('bid', 0)
                    ask_raw = market_data.get('ask', 0)
                    last_raw = market_data.get('last', 0)
                    volume_raw = market_data.get('volume', 0)
                    is_live = market_data.get('is_live', False)
                    

                    
                    # Format deÄŸerleri (0 ise N/A)
                    bid = f"{bid_raw:.2f}" if bid_raw > 0 else "N/A"
                    ask = f"{ask_raw:.2f}" if ask_raw > 0 else "N/A"
                    last = f"{last_raw:.2f}" if last_raw > 0 else "N/A"
                    volume = f"{int(volume_raw):,}" if volume_raw > 0 else "N/A"
                    
                    # Live kolonlarÄ± gÃ¼ncelle
                    self.table.set(item, 'Bid', bid)
                    self.table.set(item, 'Ask', ask)
                    self.table.set(item, 'Last', last)
                    self.table.set(item, 'Volume', volume)
                    
                    # SKORLARI GERÃ‡EK VERÄ°LERLE HESAPLA!
                    if bid_raw > 0 and ask_raw > 0 and last_raw > 0:
                        # CSV'den row verisini al
                        csv_row = self.df[self.df['PREF IBKR'] == ticker]
                        if not csv_row.empty:
                            row_data = csv_row.iloc[0]
                            prev_close = market_data.get('prevClose', 0)
                            
                            # PREFERRED STOCK'LAR Ä°Ã‡Ä°N SNAPSHOT TAMAMEN KALDIRILDI!
                            # Sadece streaming veri kullanÄ±lacak
                            if " PR" in ticker:
                                # print(f"[SKOR] ğŸš« SNAPSHOT KALDIRILDI: {ticker} - Sadece streaming kullanÄ±lacak!")
                                pass
                            
                            # Benchmark tipini ve deÄŸiÅŸimini hesapla
                            benchmark_type = self.get_benchmark_type_for_ticker(ticker)
                            benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                            
                            # Benchmark bilgilerini tabloya yaz
                            if 'Benchmark_Type' in self.columns:
                                self.table.set(item, 'Benchmark_Type', benchmark_type)
                            if 'Benchmark_Chg' in self.columns:
                                self.table.set(item, 'Benchmark_Chg', f"{benchmark_chg:.4f}")
                            
                            # SKORLARI TEKRAR HESAPLAMA KALDIRILDI! DataFrame'de zaten doÄŸru deÄŸerler var
                            # from .update_janalldata_with_scores import calculate_scores
                            # scores = calculate_scores(row_data, bid_raw, ask_raw, last_raw, prev_close, benchmark_chg)
                            
                            # TÃœM SKORLARI DataFrame'den al (zaten doÄŸru hesaplanmÄ±ÅŸ)
                            all_scores = {
                                'Bid_buy_ucuzluk_skoru': row_data.get('Bid_buy_ucuzluk_skoru', 'N/A'),
                                'Front_buy_ucuzluk_skoru': row_data.get('Front_buy_ucuzluk_skoru', 'N/A'),
                                'Ask_buy_ucuzluk_skoru': row_data.get('Ask_buy_ucuzluk_skoru', 'N/A'),
                                'Ask_sell_pahalilik_skoru': row_data.get('Ask_sell_pahalilik_skoru', 'N/A'),
                                'Front_sell_pahalilik_skoru': row_data.get('Front_sell_pahalilik_skoru', 'N/A'),
                                'Bid_sell_pahalilik_skoru': row_data.get('Bid_sell_pahalilik_skoru', 'N/A'),
                                'Final_BB_skor': row_data.get('Final_BB_skor', 'N/A'),
                                'Final_FB_skor': row_data.get('Final_FB_skor', 'N/A'),
                                'Final_AB_skor': row_data.get('Final_AB_skor', 'N/A'),
                                'Final_AS_skor': row_data.get('Final_AS_skor', 'N/A'),
                                'Final_FS_skor': row_data.get('Final_FS_skor', 'N/A'),
                                'Final_BS_skor': row_data.get('Final_BS_skor', 'N/A'),
                                'Final_SAS_skor': row_data.get('Final_SAS_skor', 'N/A'),
                                'Final_SFS_skor': row_data.get('Final_SFS_skor', 'N/A'),
                                'Final_SBS_skor': row_data.get('Final_SBS_skor', 'N/A'),
                                'Spread': row_data.get('Spread', 'N/A')
                            }
                            
                            # Debug: DataFrame'den alÄ±nan deÄŸerleri gÃ¶ster
                            if ticker in ['AHL PRE', 'AHL PRD', 'ATH PRD']:
                                # print(f"[DATAFRAME_READ] {ticker}: Final_BB_skor={all_scores['Final_BB_skor']}, Final_SAS_skor={all_scores['Final_SAS_skor']}")
                                pass
                            
                            # TÃœM SKORLARI tabloya yaz (DataFrame'den alÄ±nan deÄŸerler)
                            for score_name, score_value in all_scores.items():
                                if score_name in self.columns:
                                    if isinstance(score_value, (int, float)) and not np.isnan(score_value):
                                        self.table.set(item, score_name, f"{score_value:.2f}")
                                    else:
                                        self.table.set(item, score_name, 'N/A')
                            

                    
                    # Live data satÄ±rlarÄ±nÄ± yeÅŸil yap
                    if is_live:
                        self.table.item(item, tags=('live_data',))
                    else:
                        self.table.item(item, tags=())
                        
                except Exception as e:
                    print(f"[HATA] {ticker} iÃ§in live data gÃ¼ncelleme hatasÄ±: {e}")
        
        # Live data satÄ±rlarÄ±nÄ± yeÅŸil yap
        self.table.tag_configure('live_data', background='lightgreen')
        
        # Sayfa bilgisini gÃ¼ncelle
        self.lbl_page.config(text=f"Sayfa {self.current_page + 1} / {self.total_pages}")
        
    def prev_page(self):
        if self.current_page > 0:
            self.current_page -= 1
            self.update_table()
            
    def next_page(self):
        if self.current_page < self.total_pages - 1:
            self.current_page += 1
            self.update_table()
            
    def on_double_click(self, event):
        """Tabloda Ã§ift tÄ±klanan satÄ±r iÃ§in OrderBook penceresini aÃ§"""
        try:
            # TÄ±klanan konumu kontrol et
            item_id = self.table.identify('item', event.x, event.y)
            if not item_id:  # Tablo dÄ±ÅŸÄ±na tÄ±klandÄ±
                return
                
            # TÄ±klanan satÄ±rÄ± seÃ§
            self.table.selection_set(item_id)
            
            # SeÃ§ili satÄ±rÄ± al
            selection = self.table.selection()
            if not selection:  # SeÃ§ili satÄ±r yoksa
                return
                
            item = selection[0]
            # SeÃ§ilen satÄ±rÄ±n verilerini al
            values = self.table.item(item)['values']
            if not values:
                return
                
            # Ä°lk kolon PREF IBKR
            symbol = values[1]  # SeÃ§ kolonu sonrasÄ± PREF IBKR
            
            # OrderBook penceresini aÃ§ (order butonlarÄ± ile)
            OrderBookWindow(self, symbol, self.hammer)
            
        except Exception as e:
            print(f"[HATA] OrderBook aÃ§Ä±lÄ±rken hata: {e}")
        
    def on_table_click(self, event):
        """Tabloya tÄ±klanan satÄ±rÄ±n seÃ§im durumunu deÄŸiÅŸtir"""
        try:
            # TÄ±klanan konumu kontrol et
            region = self.table.identify_region(event.x, event.y)
            if region != "cell":
                return
                
            # TÄ±klanan kolonu kontrol et
            column = self.table.identify_column(event.x)
            if column != "#1":  # Sadece SeÃ§ kolonuna tÄ±klandÄ±ÄŸÄ±nda iÅŸlem yap
                return
                
            # TÄ±klanan satÄ±rÄ± bul
            item_id = self.table.identify('item', event.x, event.y)
            if not item_id:  # Tablo dÄ±ÅŸÄ±na tÄ±klandÄ±
                return
                
            # SeÃ§im durumunu deÄŸiÅŸtir
            current = self.table.set(item_id, "SeÃ§")
            new_value = "âœ“" if current != "âœ“" else ""
            self.table.set(item_id, "SeÃ§", new_value)
            
            # Debug iÃ§in yazdÄ±r
            ticker = self.table.set(item_id, "PREF IBKR")
            print(f"âœ… {ticker} {'seÃ§ildi' if new_value == 'âœ“' else 'seÃ§imi kaldÄ±rÄ±ldÄ±'}")
            
        except Exception as e:
            print(f"[HATA] Tabloya tÄ±klanan satÄ±r seÃ§imi hatasÄ±: {e}")
        
    def show_file_data(self, filename, is_main=False):
        """SeÃ§ilen CSV dosyasÄ±ndaki verileri gÃ¶ster"""
        try:
            # CSV'yi oku
            df = pd.read_csv(filename)
            
            # SRPAN iÃ§in mevcut grubu kaydet
            self.srpan_current_group = filename.replace('janek_ssfinek', '').replace('.csv', '')
            self.srpan_current_data = df.copy()
            
            # Pressure Analiz iÃ§in de aynÄ± veriyi kaydet
            if 'janek_ssfinek' in filename:
                self.pressure_current_group = filename.replace('janek_ssfinek', '').replace('.csv', '')
                self.pressure_current_data = df.copy()
            
            # CSV'den sadece belirli kolonlarÄ± al - SMA63 chg ve SMA246 chg kolonlarÄ± eklendi
            csv_columns_to_show = ['PREF IBKR', 'prev_close', 'CMON', 'CGRUP', 'FINAL_THG', 'AVG_ADV', 'SMI', 'SMA63 chg', 'SMA246 chg', 'SMA 246 CHG', 'SHORT_FINAL']
            
            # Sadece mevcut kolonlarÄ± al (yoksa hata vermesin)
            available_columns = [col for col in csv_columns_to_show if col in df.columns]
            
            # prev_close kolonu kontrolÃ¼ (janek_ssfinek dosyalarÄ±nda mevcut olmalÄ±)
            # Debug mesajlarÄ± kapatÄ±ldÄ± - performans iÃ§in
            # if 'prev_close' not in df.columns:
            #     print(f"[CSV] âš ï¸ prev_close kolonu bulunamadÄ±: {filename}")
            # else:
            #     print(f"[CSV] OK prev_close kolonu bulundu: {filename}")
            
            # Skor kolonlarÄ± (kendi hesapladÄ±ÄŸÄ±mÄ±z)
            score_columns = [
                'Bid_buy_ucuzluk_skoru', 'Front_buy_ucuzluk_skoru', 'Ask_buy_ucuzluk_skoru',
                'Ask_sell_pahalilik_skoru', 'Front_sell_pahalilik_skoru', 'Bid_sell_pahalilik_skoru',
                'Final_BB_skor', 'Final_FB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor', 'Final_SAS_skor', 'Final_SFS_skor', 'Final_SBS_skor',
                'Spread', 'Fbtot', 'SFStot'
            ]
            
            # Benchmark kolonlarÄ± (kendi hesapladÄ±ÄŸÄ±mÄ±z)
            benchmark_columns = ['Benchmark_Type', 'Benchmark_Chg']
            
            # GORT kolonu (hesaplanacak)
            gort_columns = ['GORT']
            
            # Live kolonlarÄ± (Hammer Pro'dan)
            live_columns = ['Bid', 'Ask', 'Last', 'Volume']
            
            # Toplam kolon sÄ±rasÄ±
            self.columns = ['SeÃ§'] + available_columns + score_columns + benchmark_columns + gort_columns + live_columns
            
            # Tabloyu yeniden oluÅŸtur
            self.table.destroy()
            self.table = ttk.Treeview(self, columns=self.columns, show='headings', height=15)
            
            # Ã‡ift tÄ±klama olayÄ±nÄ± baÄŸla
            self.table.bind('<Double-1>', self.on_double_click)
            
            # Checkbox tÄ±klama olayÄ±nÄ± baÄŸla - sadece SeÃ§ kolonu iÃ§in
            self.table.bind('<ButtonRelease-1>', self.on_table_click)
            
            # Kolon baÅŸlÄ±klarÄ± ve geniÅŸlikleri
            for col in self.columns:
                # SÄ±ralama fonksiyonunu baÄŸla
                self.table.heading(col, 
                    text=col,
                    command=lambda c=col: self.sort_by_column(c))
                    
                if col in ['PREF IBKR']:
                    self.table.column(col, width=35, anchor='w')  # Sol hizalÄ± - Ã§ok dar
                elif col in ['prev_close']:
                    self.table.column(col, width=25, anchor='center')  # prev_close iÃ§in orta geniÅŸlik
                elif col in ['CMON', 'CGRUP']:
                    self.table.column(col, width=15, anchor='center')  # En dar
                elif col in ['SMI', 'SMA63 chg', 'SMA246 chg', 'SMA 246 CHG', 'SHORT_FINAL', 'GORT']:
                    self.table.column(col, width=20, anchor='center')  # Dar
                elif col in ['FINAL_THG', 'AVG_ADV']:
                    self.table.column(col, width=25, anchor='center')  # Orta
                elif 'skor' in col.lower() or 'final' in col.lower():
                    self.table.column(col, width=30, anchor='center')  # Skor kolonlarÄ± - Ã§ok dar
                elif 'benchmark' in col.lower():
                    self.table.column(col, width=20, anchor='center') # Benchmark kolonlarÄ± - orta
                else:
                    self.table.column(col, width=20, anchor='center')  # Normal - Ã§ok dar
                    
            self.table.pack(fill='both', expand=True, padx=5, pady=5)
            
            # Tabloyu temizle
            for item in self.table.get_children():
                self.table.delete(item)
                
            # Ticker'larÄ± al
            self.tickers = df['PREF IBKR'].tolist()
            
            # Sayfalama ayarlarÄ±nÄ± gÃ¼ncelle
            self.current_page = 0
            self.total_pages = (len(self.tickers) + self.items_per_page - 1) // self.items_per_page
            
            # Yeni verileri gÃ¶ster
            self.df = df
            
            # BGGG kolonunu temizle (normal mini450'de BGGG kolonu olmamalÄ±)
            if 'BGGG AYRISMA' in self.df.columns:
                self.df = self.df.drop(columns=['BGGG AYRISMA'])
                print(f"[MINI450] ğŸ§¹ BGGG AYRISMA kolonu temizlendi (normal mini450 modu)")
            
            # Live data iÃ§in tÃ¼m sembollere subscribe ol
            if is_main:
                print("\n[HAMMER] ğŸ”„ TÃ¼m sembollere subscribe olunuyor...")
                for ticker in self.tickers:
                    self.hammer.subscribe_symbol(ticker)
            
            # TÃœM PENCERELERDE SKORLARI HESAPLA! (Ana pencere ve grup pencereleri)
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[CSV] ğŸ”„ {filename}: Skorlar hesaplanÄ±yor...")
            
            # Ã–nce skorlarÄ± hesapla
            self.calculate_scores_for_all_stocks()
            
            # Åimdi DataFrame'e skor kolonlarÄ±nÄ± ekle
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[CSV] ğŸ”„ {filename}: DataFrame'e skor kolonlarÄ± ekleniyor...")
            
            # Skor kolonlarÄ±
            score_columns = [
                'Bid_buy_ucuzluk_skoru', 'Front_buy_ucuzluk_skoru', 'Ask_buy_ucuzluk_skoru',
                'Ask_sell_pahalilik_skoru', 'Front_sell_pahalilik_skoru', 'Bid_sell_pahalilik_skoru',
                'Final_BB_skor', 'Final_FB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor', 'Final_SAS_skor', 'Final_SFS_skor', 'Final_SBS_skor',
                'Spread'
            ]
            
            # Her hisse iÃ§in skorlarÄ± hesapla ve DataFrame'e ekle
            for index, row in self.df.iterrows():
                ticker = row['PREF IBKR']
                
                # Hammer'dan live verileri al
                market_data = self.hammer.get_market_data(ticker) if hasattr(self, 'hammer') and self.hammer else None
                if market_data:
                    bid_raw = float(market_data.get('bid', 0))
                    ask_raw = float(market_data.get('ask', 0))
                    last_raw = float(market_data.get('last', 0))
                    prev_close = float(market_data.get('prevClose', 0))
                    
                    # Benchmark deÄŸiÅŸimini hesapla
                    benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                    
                    # SkorlarÄ± hesapla - DOÄRU FONKSÄ°YONU KULLAN!
                    scores = self.calculate_scores(ticker, row, bid_raw, ask_raw, last_raw, prev_close, benchmark_chg)
                    
                    # DataFrame'e skorlarÄ± yaz
                    if scores:
                        for score_name, score_value in scores.items():
                            if score_name in score_columns:
                                self.df.at[index, score_name] = score_value
                
                # GORT deÄŸerini hesapla ve DataFrame'e ekle
                gort_value = self.calculate_gort(ticker)
                self.df.at[index, 'GORT'] = gort_value if isinstance(gort_value, (int, float)) and not np.isnan(gort_value) else np.nan
            
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[CSV] âœ… {filename}: Skorlar hesaplandÄ± ve DataFrame'e eklendi")
            
            # Mini450 iÃ§in Fbtot ve SFStot hesapla (skorlar DataFrame'e yazÄ±ldÄ±ktan SONRA)
            if self.is_mini450_active:
                # Fbtot ve SFStot kolonlarÄ±nÄ± baÅŸlat (yoksa)
                if 'Fbtot' not in self.df.columns:
                    self.df['Fbtot'] = 'N/A'
                if 'SFStot' not in self.df.columns:
                    self.df['SFStot'] = 'N/A'
                
                # Debug: Skor kolonlarÄ±nÄ± kontrol et
                if 'Final_FB_skor' in self.df.columns:
                    fb_count = self.df['Final_FB_skor'].notna().sum()
                    fb_positive = (pd.to_numeric(self.df['Final_FB_skor'], errors='coerce') > 0).sum()
                    print(f"ğŸ” Debug: Final_FB_skor - Toplam: {len(self.df)}, Not NA: {fb_count}, > 0: {fb_positive}")
                else:
                    print("âš ï¸ Debug: Final_FB_skor kolonu yok!")
                
                if 'Final_SFS_skor' in self.df.columns:
                    sfs_count = self.df['Final_SFS_skor'].notna().sum()
                    sfs_positive = (pd.to_numeric(self.df['Final_SFS_skor'], errors='coerce') > 0).sum()
                    print(f"ğŸ” Debug: Final_SFS_skor - Toplam: {len(self.df)}, Not NA: {sfs_count}, > 0: {sfs_positive}")
                else:
                    print("âš ï¸ Debug: Final_SFS_skor kolonu yok!")
                
                print("ğŸ”„ Mini450: Skorlar DataFrame'e yazÄ±ldÄ±, ÅŸimdi Fbtot ve SFStot hesaplanÄ±yor...")
                self.df = self.calculate_fbtot_sfstot_for_mini450(self.df)
                df = self.df  # GÃ¼ncellenmiÅŸ df'yi kullan
                
                # Debug: Hesaplanan deÄŸerleri kontrol et
                fbtot_count = (self.df['Fbtot'] != 'N/A').sum()
                sfstot_count = (self.df['SFStot'] != 'N/A').sum()
                print(f"ğŸ” Debug: Hesaplama sonrasÄ± - Fbtot != N/A: {fbtot_count}/{len(self.df)}, SFStot != N/A: {sfstot_count}/{len(self.df)}")
                    
            # SÄ±ralama sÄ±fÄ±rla
            self.sort_column = None
            self.sort_ascending = True
            
            # _last_visible_tickers'Ä± sÄ±fÄ±rla (yeni dosya yÃ¼klendiÄŸinde tablo yeniden Ã§izilsin)
            if hasattr(self, '_last_visible_tickers'):
                delattr(self, '_last_visible_tickers')
                
            self.update_table()
            
            # BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
            if is_main:
                self.title("JanAll - TÃ¼m Veriler")
            else:
                short_name = filename.replace('ssfinek', '').replace('.csv', '')
                self.title(f"JanAll - {short_name}")
                
            # Debug mesajlarÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[CSV] âœ… {filename} yÃ¼klendi")
            # print(f"[CSV] â„¹ï¸ {len(df)} satÄ±r")
            # print(f"[CSV] ğŸ“‹ Mevcut Kolonlar: {', '.join(available_columns)}")
            # print(f"[CSV] ğŸ“‹ Toplam Kolon SayÄ±sÄ±: {len(self.columns)}")
            
            # Stock Data Manager'Ä± CSV verileri ile gÃ¼ncelle
            self.stock_data_manager.update_stock_data_from_csv(filename, df)
            
        except Exception as e:
                print(f"[CSV] ERROR Dosya okuma hatasi ({filename}): {e}")
    
    def get_prev_close_for_symbol(self, symbol: str) -> float:
        """Symbol iÃ§in prev close deÄŸerini dÃ¶ndÃ¼r - cache'den oku"""
        try:
            # Cache'den kontrol et
            if hasattr(self, 'prev_close_cache') and symbol in self.prev_close_cache:
                value = float(self.prev_close_cache[symbol])
                # print(f"[PREV CLOSE] âœ“ {symbol}: cache'den prev_close={value}")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
                return value
            
            # ETF Panel'den al
            if hasattr(self, 'etf_panel') and self.etf_panel:
                if symbol in self.etf_panel.etf_prev_close_data:
                    value = float(self.etf_panel.etf_prev_close_data[symbol])
                    # print(f"[PREV CLOSE] âœ“ {symbol}: ETF panel'den prev_close={value}")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
                    return value
            
            # print(f"[PREV CLOSE] âŒ {symbol}: prev_close cache'de bulunamadÄ±")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
            # if hasattr(self, 'prev_close_cache'):
            #     print(f"[PREV CLOSE] ğŸ“‹ Cache'deki ticker'lar: {list(self.prev_close_cache.keys())[:10]}...")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
            # else:
            #     print(f"[PREV CLOSE] ğŸ“‹ Cache boÅŸ!")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
            return 0.0
            
        except Exception as e:
            # print(f"[PREV CLOSE] âŒ {symbol} genel hata: {e}")  # Debug mesajÄ± kaldÄ±rÄ±ldÄ±
            return 0.0
    
    def get_last_price_for_symbol(self, symbol: str) -> float:
        """Symbol iÃ§in son fiyatÄ± dÃ¶ndÃ¼r - PREF IBKR formatÄ±nÄ± Hammer Pro formatÄ±na Ã§evirerek"""
        try:
            # PREF IBKR formatÄ±nÄ± Hammer Pro formatÄ±na Ã§evir
            from .myjdata import get_hammer_symbol_from_pref_ibkr
            hammer_symbol = get_hammer_symbol_from_pref_ibkr(symbol)
            
            # Hammer Pro'dan market data al
            if hasattr(self, 'hammer') and self.hammer:
                market_data = self.hammer.get_market_data(hammer_symbol)
                if market_data and 'last' in market_data:
                    last_price = float(market_data['last'])
                    return last_price
        
            # ETF Panel'den al
            if hasattr(self, 'etf_panel') and self.etf_panel:
                if symbol in self.etf_panel.etf_data:
                    last_price = float(self.etf_panel.etf_data[symbol].get('last', 0))
                    return last_price
        
            return 0.0
        except Exception as e:
            print(f"[MAIN] âŒ {symbol} fiyat alma hatasÄ±: {e}")
            return 0.0
    
    def get_final_thg_for_symbol(self, symbol: str) -> float:
        """Symbol iÃ§in FINAL_THG deÄŸerini dÃ¶ndÃ¼r - janek_ss dosyalarÄ±ndan oku"""
        try:
            # Ã–nce cache'den kontrol et
            if hasattr(self, 'final_thg_data') and symbol in self.final_thg_data:
                return float(self.final_thg_data[symbol])
            
            # janek_ss dosyalarÄ±ndan oku
            import glob
            import pandas as pd
            
            # TÃ¼m janek_ss dosyalarÄ±nÄ± bul (ana dizinde)
            janek_files = glob.glob('janek_ss*.csv')
            
            for janek_file in janek_files:
                try:
                    # DosyayÄ± oku
                    df = pd.read_csv(janek_file, encoding='utf-8-sig')
                    
                    # PREF IBKR ve FINAL_THG kolonlarÄ± var mÄ± kontrol et
                    if 'PREF IBKR' in df.columns and 'FINAL_THG' in df.columns:
                        # Symbol'Ã¼ bul
                        row = df[df['PREF IBKR'] == symbol]
                        if not row.empty:
                            final_thg = row['FINAL_THG'].iloc[0]
                            if pd.notna(final_thg):
                                # Cache'e kaydet
                                if not hasattr(self, 'final_thg_data'):
                                    self.final_thg_data = {}
                                self.final_thg_data[symbol] = float(final_thg)
                                print(f"[FINAL_THG] âœ“ {symbol}: {final_thg} ({janek_file})")
                                return float(final_thg)
                except Exception as e:
                    print(f"[FINAL_THG] âš ï¸ {janek_file} okuma hatasÄ±: {e}")
                    continue
            
            print(f"[FINAL_THG] âŒ {symbol}: FINAL_THG bulunamadÄ±")
            return 0.0
            
        except Exception as e:
            print(f"[FINAL_THG] âŒ {symbol} genel hata: {e}")
            return 0.0
    
    def top_ten_bid_buy(self):
        """Top Ten Bid Buy - En yÃ¼ksek Final_BB_skorlu %10 hisse iÃ§in bid buy emirleri"""
        try:
            print("[TOP TEN] ğŸ”„ Top Ten Bid Buy baÅŸlatÄ±lÄ±yor...")
            
            # CSV dosyasÄ±nÄ± sÄ±fÄ±rla (yeni iÅŸlem baÅŸlÄ±yor)
            self.reset_pref_csv()
            
            # TÃ¼m skorlarÄ± hesapla
            self.calculate_scores_for_all_stocks()
            
            # Grup dosyalarÄ± (belirtilen sÄ±rayla)
            groups = ['helddeznff', 'heldff', 'heldflr', 'heldgarabetaltiyedi', 'heldkuponlu', 
                     'heldkuponlukreciliz', 'heldkuponlukreorta', 'heldnff', 'heldotelremorta', 
                     'heldsolidbig', 'heldtitrekhc', 'highmatur', 'notcefilliquid', 'nottitrekhc', 'shitremhc']
            
            for group in groups:
                try:
                    print(f"[TOP TEN] ğŸ”„ {group} grubu iÅŸleniyor...")
                    
                    # GRUP BUTONUNA BASTIÄINDA AÃ‡ILAN PENCEREDEKÄ° DATAFRAME'Ä° BUL
                    group_window = self.find_group_window(group)
                    if group_window and hasattr(group_window, 'df'):
                        group_df = group_window.df  # AÃ§Ä±lan penceredeki DataFrame
                        print(f"[TOP TEN] ğŸ“‹ {group}: AÃ§Ä±lan penceredeki DataFrame'de {len(group_df)} hisse var")
                        
                        # Debug: AÃ§Ä±lan penceredeki DataFrame'in ilk birkaÃ§ hissesini gÃ¶ster
                        if len(group_df) > 0:
                            first_tickers = group_df['PREF IBKR'].head(5).tolist()
                            print(f"[DEBUG] AÃ§Ä±lan penceredeki DataFrame'de ilk 5 hisse: {first_tickers}")
                            
                            # Debug: AÃ§Ä±lan penceredeki DataFrame'de skor kolonlarÄ± var mÄ± kontrol et
                            if 'Final_BB_skor' in group_df.columns:
                                print(f"[DEBUG] âœ… AÃ§Ä±lan penceredeki DataFrame'de Final_BB_skor kolonu var")
                                # Ä°lk birkaÃ§ hissenin skorlarÄ±nÄ± gÃ¶ster
                                for ticker in first_tickers[:3]:
                                    if ticker in group_df['PREF IBKR'].values:
                                        row = group_df[group_df['PREF IBKR'] == ticker].iloc[0]
                                        score = row.get('Final_BB_skor', 'N/A')
                                        print(f"[DEBUG] {ticker}: Final_BB_skor = {score}")
                            else:
                                print(f"[DEBUG] âŒ AÃ§Ä±lan penceredeki DataFrame'de Final_BB_skor kolonu yok!")
                                print(f"[DEBUG] Mevcut kolonlar: {list(group_df.columns)}")
                                
                                # Skorlar yoksa hesapla!
                                print(f"[DEBUG] ğŸ”„ {group} penceresinde skorlar hesaplanÄ±yor...")
                                group_window.calculate_scores_for_all_stocks()
                                print(f"[DEBUG] âœ… {group} penceresinde skorlar hesaplandÄ±")
                                
                                # Åimdi tekrar kontrol et
                                if 'Final_BB_skor' in group_df.columns:
                                    print(f"[DEBUG] âœ… ArtÄ±k Final_BB_skor kolonu var!")
                                else:
                                    print(f"[DEBUG] âŒ Hala Final_BB_skor kolonu yok!")
                    else:
                        print(f"[TOP TEN] âš ï¸ {group}: AÃ§Ä±lan pencere bulunamadÄ±, butona tÄ±klanÄ±yor...")
                        
                        # GRUP BUTONUNU BUL VE TIKLA!
                        group_button = self.find_group_button(group)
                        if group_button:
                            print(f"[TOP TEN] ğŸ”˜ {group} butonu bulundu, tÄ±klanÄ±yor...")
                            group_button.invoke()  # Butona tÄ±kla
                            
                            # Pencere aÃ§Ä±lsÄ±n
                            import time
                            time.sleep(1)
                            
                            # Åimdi tekrar pencereyi bul
                            print(f"[TOP TEN] ğŸ” {group} penceresi tekrar aranÄ±yor...")
                            group_window = self.find_group_window(group)
                            if group_window and hasattr(group_window, 'df'):
                                group_df = group_window.df
                                print(f"[TOP TEN] âœ… {group}: Pencere aÃ§Ä±ldÄ± ve bulundu! {len(group_df)} hisse")
                            else:
                                print(f"[TOP TEN] âŒ {group}: Pencere hala bulunamadÄ±, ana DataFrame kullanÄ±lÄ±yor")
                                group_df = self.df
                        else:
                            print(f"[TOP TEN] âŒ {group} butonu bulunamadÄ±, ana DataFrame kullanÄ±lÄ±yor")
                            group_df = self.df
                        
                        # Debug: Ana DataFrame'deki ilk birkaÃ§ hisseyi gÃ¶ster
                        if len(group_df) > 0:
                            first_tickers = group_df['PREF IBKR'].head(5).tolist()
                            print(f"[DEBUG] Ana DataFrame'de ilk 5 hisse: {first_tickers}")
                            
                            # Debug: Ana DataFrame'de skor kolonlarÄ± var mÄ± kontrol et
                            if 'Final_BB_skor' in group_df.columns:
                                print(f"[DEBUG] âœ… Ana DataFrame'de Final_BB_skor kolonu var")
                            else:
                                print(f"[DEBUG] âŒ Ana DataFrame'de Final_BB_skor kolonu yok!")
                        
                        # Debug: Ana DataFrame'de hangi kolonlar var kontrol et
                        print(f"[DEBUG] Ana DataFrame'deki kolonlar: {list(group_df.columns)}")
                    
                    # TÃœM SAYFALARI TARA - SADECE Ä°LK SAYFA DEÄÄ°L!
                    print(f"[TOP TEN] ğŸ” {group}: TÃ¼m sayfalar taranÄ±yor...")
                    
                    # Toplam sayfa sayÄ±sÄ±nÄ± al
                    total_pages = getattr(group_window, 'total_pages', 1)
                    print(f"[TOP TEN] ğŸ“„ {group}: Toplam {total_pages} sayfa bulundu")
                    
                    # TÃ¼m sayfalardaki hisseleri topla
                    all_group_stocks = []
                    
                    for page in range(total_pages):
                        print(f"[TOP TEN] ğŸ“„ {group}: Sayfa {page + 1}/{total_pages} taranÄ±yor...")
                        
                        # SayfayÄ± deÄŸiÅŸtir
                        if hasattr(group_window, 'go_to_page'):
                            group_window.go_to_page(page)
                            # Sayfa deÄŸiÅŸince biraz bekle
                            import time
                            time.sleep(1)
                        
                        # Bu sayfadaki hisseleri al
                        current_page_df = group_window.df if hasattr(group_window, 'df') else group_df
                        
                        for index, row in current_page_df.iterrows():
                            ticker = row['PREF IBKR']
                            
                            # SKORU KENDÄ°MÄ°Z HESAPLAYALIM - DATAFRAME'DEN OKUMAYALIM!
                            print(f"[DEBUG] {ticker}: Skor hesaplanÄ±yor...")
                            
                            # Market data al
                            market_data = self.hammer.get_market_data(ticker) if hasattr(self, 'hammer') and self.hammer else None
                            if market_data:
                                bid_raw = float(market_data.get('bid', 0))
                                ask_raw = float(market_data.get('ask', 0))
                                last_raw = float(market_data.get('last', 0))
                                prev_close = float(market_data.get('prevClose', 0))
                                
                                # Benchmark deÄŸiÅŸimini hesapla
                                benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                                
                                # SkorlarÄ± hesapla - DOÄRU FONKSÄ°YONU KULLAN!
                                scores = self.calculate_scores(ticker, row, bid_raw, ask_raw, last_raw, prev_close, benchmark_chg)
                                
                                if scores and 'Final_BB_skor' in scores:
                                    final_bb_skor = scores['Final_BB_skor']
                                    print(f"[DEBUG] {ticker}: Hesaplanan Final_BB_skor={final_bb_skor}")
                                else:
                                    print(f"[DEBUG] {ticker}: Skor hesaplanamadÄ±")
                                    final_bb_skor = 0
                            else:
                                print(f"[DEBUG] {ticker}: Market data alÄ±namadÄ±")
                                final_bb_skor = 0
                            
                            all_group_stocks.append({
                                'symbol': ticker,
                                'Final_BB_skor': final_bb_skor
                            })
                            print(f"[DEBUG] {ticker}: Sayfa {page + 1}'den Final_BB_skor={final_bb_skor}")
                    
                    print(f"[TOP TEN] ğŸ“Š {group}: TÃ¼m sayfalardan toplam {len(all_group_stocks)} hisse bulundu")
                    
                    # Duplicate hisseleri kaldÄ±r
                    group_stocks = []
                    seen_symbols = set()
                    for stock in all_group_stocks:
                        if stock['symbol'] not in seen_symbols:
                            group_stocks.append(stock)
                            seen_symbols.add(stock['symbol'])
                    
                    print(f"[TOP TEN] ğŸ“Š {group}: Unique {len(group_stocks)} hisse (duplicate'ler kaldÄ±rÄ±ldÄ±)")
                    
                    if len(group_stocks) == 0:
                        print(f"[TOP TEN] âš ï¸ {group}: Uygun hisse bulunamadÄ±")
                        continue
                    
                    if len(group_stocks) == 0:
                        print(f"[TOP TEN] âš ï¸ {group}: Uygun hisse bulunamadÄ±")
                        continue
                    
                    # En yÃ¼ksek %10'u seÃ§ (min 1, max 8)
                    total_stocks = len(group_stocks)
                    select_count = max(1, min(8, round(total_stocks * 0.1)))
                    
                    # Final_BB_skor'a gÃ¶re sÄ±rala (yÃ¼ksekten dÃ¼ÅŸÃ¼ÄŸe)
                    group_stocks.sort(key=lambda x: x['Final_BB_skor'], reverse=True)
                    top_stocks = group_stocks[:select_count]
                    
                    if len(top_stocks) == 0:
                        print(f"[TOP TEN] âš ï¸ {group}: Uygun hisse bulunamadÄ±")
                        continue
                    
                    print(f"[TOP TEN] âœ… {group}: {len(top_stocks)} hisse seÃ§ildi (top %10)")
                    
                    # Onay penceresi aÃ§
                    symbols = [stock['symbol'] for stock in top_stocks]
                    scores = [stock['Final_BB_skor'] for stock in top_stocks]
                    
                    # Onay penceresi aÃ§ ve kullanÄ±cÄ±nÄ±n yanÄ±tÄ±nÄ± bekle
                    confirmation_win = self.show_order_confirmation(
                        title=f"Top Ten Bid Buy - {group}",
                        symbols=symbols,
                        scores=scores,
                        order_type="bid_buy",
                        group=group
                    )
                    
                    # wait_window() kaldÄ±rÄ±ldÄ± - GUI'yi bloklamamak iÃ§in
                    if confirmation_win:
                        print(f"[TOP TEN] âœ… {group}: Onay penceresi aÃ§Ä±ldÄ± (non-blocking)")
                    else:
                        print(f"[TOP TEN] âŒ {group}: Onay penceresi aÃ§Ä±lamadÄ±!")
                    
                except Exception as e:
                    print(f"[TOP TEN] âŒ {group} hatasÄ±: {e}")
                    continue
                    
        except Exception as e:
            print(f"[TOP TEN] âŒ Genel hata: {e}")
    
    def find_group_button(self, group):
        """Grup butonunu bul"""
        try:
            # files_frame'i bul
            files_frame = None
            for widget in self.winfo_children():
                if hasattr(widget, 'winfo_children'):
                    for child in widget.winfo_children():
                        if hasattr(child, 'winfo_children'):
                            for grandchild in child.winfo_children():
                                if hasattr(grandchild, 'cget'):
                                    try:
                                        text = grandchild.cget('text')
                                        if text and group.lower() in text.lower():
                                            return grandchild
                                    except:
                                        continue
            return None
        except Exception as e:
            print(f"[TOP TEN] âŒ Buton arama hatasÄ±: {e}")
            return None
    
    def find_group_window(self, group):
        """Grup penceresini bul - TÃ¼m aÃ§Ä±k pencereleri tara"""
        try:
            print(f"[DEBUG] {group} grubu iÃ§in pencere aranÄ±yor...")
            
            # TÃœM AÃ‡IK PENCERELERÄ° BUL - FARKLI YÃ–NTEMLER DENE
            import tkinter as tk
            
            # 1. YÃ–NTEM: Ana penceredeki tÃ¼m child widget'larÄ± tara
            all_windows = []
            
            # Ana pencereyi ekle
            all_windows.append(self)
            
            # Ana penceredeki tÃ¼m child widget'larÄ± recursive olarak tara
            def scan_widgets(widget):
                try:
                    for child in widget.winfo_children():
                        # Her child'Ä± ekle
                        all_windows.append(child)
                        # Recursive olarak devam et
                        scan_widgets(child)
                except:
                    pass
            
            scan_widgets(self)
            
            print(f"[DEBUG] Bulunan toplam widget sayÄ±sÄ±: {len(all_windows)}")
            print(f"[DEBUG] Widget tÃ¼rleri: {[w.__class__.__name__ for w in all_windows[:10]]}...")
            
            # 2. YÃ–NTEM: Her widget'Ä± kontrol et
            for window in all_windows:
                try:
                    # Title var mÄ± kontrol et
                    if hasattr(window, 'title'):
                        title = window.title()
                        print(f"[DEBUG] Widget title: {title}")
                        
                        # DataFrame var mÄ± kontrol et
                        if hasattr(window, 'df'):
                            print(f"[DEBUG] Widget'da df var, uzunluk: {len(window.df)}")
                            
                            # Grup adÄ±nÄ± title'da ara
                            if group.lower() in title.lower():
                                print(f"[DEBUG] âœ… {group} grubu iÃ§in pencere bulundu: {title}")
                                return window
                            else:
                                print(f"[DEBUG] âŒ {group} grubu iÃ§in uygun deÄŸil: {title}")
                        else:
                            print(f"[DEBUG] Widget'da df yok")
                    else:
                        print(f"[DEBUG] Widget'da title yok")
                        
                except Exception as e:
                    print(f"[DEBUG] Widget kontrol hatasÄ±: {e}")
                    continue
            
            # 3. YÃ–NTEM: Toplevel pencereleri de tara
            print(f"[DEBUG] Toplevel pencereler aranÄ±yor...")
            for widget in all_windows:
                try:
                    if isinstance(widget, tk.Toplevel):
                        print(f"[DEBUG] Toplevel bulundu: {widget}")
                        if hasattr(widget, 'title'):
                            title = widget.title()
                            print(f"[DEBUG] Toplevel title: {title}")
                            if hasattr(widget, 'df') and group.lower() in title.lower():
                                print(f"[DEBUG] âœ… {group} grubu iÃ§in Toplevel pencere bulundu: {title}")
                                return widget
                except:
                    continue
            
            print(f"[DEBUG] âŒ {group} grubu iÃ§in hiÃ§ pencere bulunamadÄ±!")
            return None
            
        except Exception as e:
            print(f"[TOP TEN] âŒ Pencere arama hatasÄ±: {e}")
            return None
    
    def bottom_ten_ask_sell(self):
        """Bottom Ten Ask Sell - En dÃ¼ÅŸÃ¼k Final_SAS_skorlu %10 hisse iÃ§in ask sell emirleri"""
        try:
            print("[BOTTOM TEN] ğŸ”„ Bottom Ten Ask Sell baÅŸlatÄ±lÄ±yor...")
            
            # CSV dosyasÄ±nÄ± sÄ±fÄ±rla (yeni iÅŸlem baÅŸlÄ±yor)
            self.reset_pref_csv()
            
            # TÃ¼m skorlarÄ± hesapla
            self.calculate_scores_for_all_stocks()
            
            # Sadece belirtilen gruplar
            groups = ['heldkuponlu', 'helddeznff', 'heldkuponlukreciliz', 'heldkuponlukreorta', 
                     'heldgarabetaltiyedi', 'heldnff', 'heldotelremorta']
            
            for group in groups:
                try:
                    print(f"[BOTTOM TEN] ğŸ”„ {group} grubu iÅŸleniyor...")
                    
                    # CSV dosyasÄ±nÄ± yÃ¼kle
                    csv_file = f"janek_ssfinek{group}.csv"
                    
                    # Dosya var mÄ± kontrol et
                    if not os.path.exists(csv_file):
                        print(f"[BOTTOM TEN] âš ï¸ {csv_file} dosyasÄ± bulunamadÄ±")
                        continue
                    
                    # DosyayÄ± yÃ¼kle ve DataFrame'e aktar
                    self.show_file_data(csv_file)
                    
                    # TÃ¼m sayfalarÄ± tara
                    group_stocks = []
                    current_page = 0
                    max_pages = 50  # GÃ¼venlik iÃ§in maksimum sayfa sayÄ±sÄ±
                    
                    while current_page < max_pages:
                        # Mevcut sayfadaki hisseleri iÅŸle
                        for index, row in self.df.iterrows():
                            ticker = row['PREF IBKR']
                            
                            # Final_SAS_skor'u kontrol et
                            if 'Final_SAS_skor' in self.df.columns:
                                final_sas_skor = row.get('Final_SAS_skor', 0)
                                group_stocks.append({
                                    'symbol': ticker,
                                    'Final_SAS_skor': final_sas_skor
                                })
                            else:
                                # Skor yoksa hesapla
                                market_data = self.hammer.get_market_data(ticker) if hasattr(self, 'hammer') and self.hammer else None
                                
                                if market_data:
                                    bid = float(market_data.get('bid', 0))
                                    ask = float(market_data.get('ask', 0))
                                    last_price = float(market_data.get('last', 0))
                                else:
                                    bid = ask = last_price = 0
                                
                                # Prev close al
                                prev_close = self.get_prev_close_for_symbol(ticker)
                                
                                # Benchmark change al
                                benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                                
                                # SkorlarÄ± hesapla - DOÄRU FONKSÄ°YONU KULLAN!
                                scores = self.calculate_scores(ticker, row, bid, ask, last_price, prev_close, benchmark_chg)
                                
                                if scores and 'Final_SAS_skor' in scores:
                                    final_sas_skor = scores['Final_SAS_skor']
                                    group_stocks.append({
                                        'symbol': ticker,
                                        'Final_SAS_skor': final_sas_skor
                                    })
                                else:
                                    final_sas_skor = 0
                        
                        # Sonraki sayfaya geÃ§
                        self.next_page()
                        current_page += 1
                        
                        # EÄŸer sayfa deÄŸiÅŸmediyse (son sayfa) dÃ¶ngÃ¼yÃ¼ kÄ±r
                        if len(self.df) == 0:
                            break
                    
                    print(f"[BOTTOM TEN] ğŸ“Š {group}: Toplam {len(group_stocks)} hisse bulundu")
                    
                    if len(group_stocks) == 0:
                        print(f"[BOTTOM TEN] âš ï¸ {group}: Grupta hisse bulunamadÄ±")
                        continue
                    
                    # Duplicate hisseleri kaldÄ±r (aynÄ± symbol'den sadece birini al)
                    unique_stocks = []
                    seen_symbols = set()
                    for stock in group_stocks:
                        if stock['symbol'] not in seen_symbols:
                            unique_stocks.append(stock)
                            seen_symbols.add(stock['symbol'])
                    
                    print(f"[BOTTOM TEN] ğŸ“Š {group}: Unique {len(unique_stocks)} hisse (duplicate'ler kaldÄ±rÄ±ldÄ±)")
                    
                    if len(unique_stocks) == 0:
                        print(f"[BOTTOM TEN] âš ï¸ {group}: Unique hisse bulunamadÄ±")
                        continue
                    
                    # En dÃ¼ÅŸÃ¼k %10'u seÃ§ (min 1, max 8) - unique_stocks Ã¼zerinden
                    total_unique_stocks = len(unique_stocks)
                    select_count = max(1, min(8, round(total_unique_stocks * 0.1)))
                    
                    # Final_SAS_skor'a gÃ¶re sÄ±rala (dÃ¼ÅŸÃ¼kten yÃ¼kseÄŸe - en dÃ¼ÅŸÃ¼k skorlular)
                    unique_stocks.sort(key=lambda x: x['Final_SAS_skor'])
                    bottom_stocks = unique_stocks[:select_count]
                    
                    print(f"[BOTTOM TEN] âœ… {group}: {len(bottom_stocks)} hisse seÃ§ildi (bottom %10)")
                    
                    # Onay penceresi aÃ§
                    symbols = [stock['symbol'] for stock in bottom_stocks]
                    scores = [stock['Final_SAS_skor'] for stock in bottom_stocks]
                    
                    # Onay penceresi aÃ§ ve kullanÄ±cÄ±nÄ±n yanÄ±tÄ±nÄ± bekle
                    confirmation_win = self.show_order_confirmation(
                        title=f"Bottom Ten Ask Sell - {group}",
                        symbols=symbols,
                        scores=scores,
                        order_type="ask_sell",
                        group=group
                    )
                    
                    # wait_window() kaldÄ±rÄ±ldÄ± - GUI'yi bloklamamak iÃ§in
                    if confirmation_win:
                        print(f"[BOTTOM TEN] âœ… {group}: Onay penceresi aÃ§Ä±ldÄ± (non-blocking)")
                    
                except Exception as e:
                    print(f"[BOTTOM TEN] âŒ {group} hatasÄ±: {e}")
                    continue
                    
        except Exception as e:
            print(f"[BOTTOM TEN] âŒ Genel hata: {e}")
    
    def show_order_confirmation(self, title, symbols, scores, order_type, group):
        """Emir onay penceresi - DetaylÄ± bilgilerle"""
        import tkinter as tk
        from tkinter import ttk
        
        win = tk.Toplevel(self)
        win.title(title)
        win.geometry("1200x600")
        # transient ve grab_set kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
        
        # BaÅŸlÄ±k
        ttk.Label(win, text=f"{title}\n{len(symbols)} hisse seÃ§ildi", 
                 font=('Arial', 12, 'bold')).pack(pady=10)
        
        # Tablo - DetaylÄ± bilgiler (checkbox'lÄ±)
        cols = ['select', 'symbol', 'order_info', 'bid', 'ask', 'spread', 'last', 'score', 'avg_adv', 'maxalw']
        if order_type == "ask_sell":
            headers = ['SeÃ§', 'Symbol', 'Emir Bilgisi', 'Bid', 'Ask', 'Spread', 'Last', 'Final SAS Skor', 'AVG_ADV', 'MAXALW']
        else:
            headers = ['SeÃ§', 'Symbol', 'Emir Bilgisi', 'Bid', 'Ask', 'Spread', 'Last', 'Final BB Skor', 'AVG_ADV', 'MAXALW']
        tree = ttk.Treeview(win, columns=cols, show='headings', height=15)
        
        for c, h in zip(cols, headers):
            tree.heading(c, text=h)
            if c == 'select':
                tree.column(c, width=50, anchor='center')
            elif c == 'symbol':
                tree.column(c, width=100, anchor='center')
            elif c == 'order_info':
                tree.column(c, width=200, anchor='center')
            elif c in ['avg_adv', 'maxalw']:
                tree.column(c, width=80, anchor='center')
            else:
                tree.column(c, width=120, anchor='center')
        
        tree.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Verileri ekle - DetaylÄ± bilgilerle (checkbox'lÄ±)
        # Lot hesaplamasÄ±: MAXALW/4 bazÄ±nda, 200-800 arasÄ±nda sÄ±nÄ±rlÄ±
        def calculate_lot_size(maxalw):
            """MAXALW/4 bazÄ±nda lot hesapla, 200-800 arasÄ±nda sÄ±nÄ±rla"""
            if maxalw <= 0:
                return 200  # Default minimum
            
            # MAXALW/4 hesapla
            calculated_lot = maxalw / 4
            
            # 100'lÃ¼ÄŸe yuvarla
            rounded_lot = round(calculated_lot / 100) * 100
            
            # 200-800 arasÄ±nda sÄ±nÄ±rla
            if rounded_lot < 200:
                return 200
            elif rounded_lot > 800:
                return 800
            else:
                return rounded_lot
        
        # SeÃ§ili hisseleri takip etmek iÃ§in
        selected_symbols = []
        symbol_lots = {}  # Her hisse iÃ§in lot bilgisini sakla
        
        for symbol, score in zip(symbols, scores):
            # Market data al
            market_data = self.hammer.get_market_data(symbol) if hasattr(self, 'hammer') and self.hammer else None
            
            if market_data:
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                spread = ask - bid if ask > 0 and bid > 0 else 0
            else:
                bid = ask = last = spread = 0
            
            # Emir fiyatÄ±nÄ± hesapla
            if order_type == "bid_buy":
                order_price = bid + spread * 0.15
                order_direction = "BUY"
            else:  # ask_sell
                order_price = ask - spread * 0.15
                order_direction = "SELL"
            
            # AVG_ADV ve MAXALW deÄŸerlerini al (kural bazlÄ±)
            avg_adv = self.get_avg_adv_from_csv(symbol)
            divisor = getattr(self, 'rule_avg_adv_divisor', 10)
            maxalw = avg_adv / divisor if avg_adv > 0 else 0
            
            # Her hisse iÃ§in MAXALW/4 bazÄ±nda lot hesapla
            individual_lot = calculate_lot_size(maxalw)
            
            # Debug: Lot hesaplama detaylarÄ±
            print(f"[LOT CALC] {symbol}: MAXALW={maxalw:.0f}, MAXALW/4={maxalw/4:.0f}, Rounded={individual_lot}")
            
            # Lot bilgisini sakla
            symbol_lots[symbol] = individual_lot
            
            # Emir bilgisi
            order_info = f"{individual_lot} lot {order_direction} @ ${order_price:.2f} (HIDDEN)"
            
            # VarsayÄ±lan olarak seÃ§ili (âœ“)
            item = tree.insert('', 'end', values=[
                "âœ“",  # SeÃ§ili
                symbol,
                order_info,
                f"${bid:.2f}" if bid > 0 else "N/A",
                f"${ask:.2f}" if ask > 0 else "N/A",
                f"${spread:.2f}" if spread > 0 else "N/A",
                f"${last:.2f}" if last > 0 else "N/A",
                f"{score:.2f}",
                f"{avg_adv:.0f}",
                f"{maxalw:.0f}"
            ])
            
            # VarsayÄ±lan olarak seÃ§ili
            selected_symbols.append(symbol)
        
        # Checkbox tÄ±klama fonksiyonu
        def toggle_selection(event):
            region = tree.identify_region(event.x, event.y)
            if region == "cell":
                column = tree.identify_column(event.x)
                if column == "#1":  # SeÃ§ kolonu
                    item = tree.identify_row(event.y)
                    if item:
                        values = list(tree.item(item)['values'])
                        if values[0] == "âœ“":  # SeÃ§ili ise
                            values[0] = "â˜"  # SeÃ§imi kaldÄ±r
                            if values[1] in selected_symbols:
                                selected_symbols.remove(values[1])
                        else:  # SeÃ§ili deÄŸilse
                            values[0] = "âœ“"  # SeÃ§
                            if values[1] not in selected_symbols:
                                selected_symbols.append(values[1])
                        tree.item(item, values=values)
        
        # Tablo tÄ±klama olayÄ±nÄ± baÄŸla
        tree.bind('<Button-1>', toggle_selection)
        
        # Butonlar
        button_frame = ttk.Frame(win)
        button_frame.pack(pady=10)
        
        def save_to_trades_csv():
            """SeÃ§ili emirleri trades.csv formatÄ±nda kaydet"""
            try:
                if not selected_symbols:
                    messagebox.showwarning("UyarÄ±", "HiÃ§ hisse seÃ§ilmedi!")
                    return
                
                print(f"[CSV SAVE] ğŸ”„ {len(selected_symbols)} seÃ§ili emir trades.csv'ye kaydediliyor...")
                
                # CSV satÄ±rlarÄ±
                csv_rows = []
                
                for symbol in selected_symbols:
                    # Market data al
                    market_data = self.hammer.get_market_data(symbol) if hasattr(self, 'hammer') and self.hammer else None
                    
                    if market_data:
                        bid = float(market_data.get('bid', 0))
                        ask = float(market_data.get('ask', 0))
                        spread = ask - bid if ask > 0 and bid > 0 else 0
                    else:
                        bid = ask = spread = 0
                    
                    # Emir fiyatÄ±nÄ± hesapla
                    if order_type == "bid_buy":
                        order_price = bid + spread * 0.15
                        action = "BUY"
                    else:  # ask_sell
                        order_price = ask - spread * 0.15
                        action = "SELL"
                    
                    # Lot miktarÄ±nÄ± al
                    individual_lot = symbol_lots.get(symbol, 200)
                    
                    # Lot BÃ¶lÃ¼cÃ¼ aktifse lotlarÄ± bÃ¶l
                    if self.lot_divider_enabled:
                        lot_parts = self.divide_lot_size(individual_lot)
                        print(f"[CSV SAVE] ğŸ”„ {symbol}: {individual_lot} lot -> {lot_parts} parÃ§alara bÃ¶lÃ¼ndÃ¼")
                        
                        # Her parÃ§a iÃ§in ayrÄ± CSV satÄ±rÄ± oluÅŸtur
                        for i, lot_part in enumerate(lot_parts):
                            csv_row = [
                                action,                           # Action: BUY/SELL
                                lot_part,                         # Quantity: Lot miktarÄ±
                                symbol,                           # Symbol: Ticker
                                'STK',                           # SecType: STK
                                'SMART/AMEX',                    # Exchange: SMART/AMEX
                                'USD',                           # Currency: USD
                                'DAY',                           # TimeInForce: DAY
                                'LMT',                           # OrderType: LMT
                                round(order_price, 2),           # LmtPrice: Fiyat
                                'Basket',                        # BasketTag: Basket
                                'U21016730',                     # Account: U21016730
                                'Basket',                        # OrderRef: Basket
                                'TRUE',                          # Hidden: TRUE
                                'TRUE'                           # OutsideRth: TRUE
                            ]
                            csv_rows.append(csv_row)
                    else:
                        # Lot BÃ¶lÃ¼cÃ¼ kapalÄ±ysa normal ÅŸekilde tek satÄ±r
                        csv_row = [
                            action,                           # Action: BUY/SELL
                            individual_lot,                   # Quantity: Lot miktarÄ±
                            symbol,                           # Symbol: Ticker
                            'STK',                           # SecType: STK
                            'SMART/AMEX',                    # Exchange: SMART/AMEX
                            'USD',                           # Currency: USD
                            'DAY',                           # TimeInForce: DAY
                            'LMT',                           # OrderType: LMT
                            round(order_price, 2),           # LmtPrice: Fiyat
                            'Basket',                        # BasketTag: Basket
                            'U21016730',                     # Account: U21016730
                            'Basket',                        # OrderRef: Basket
                            'TRUE',                          # Hidden: TRUE
                            'TRUE'                           # OutsideRth: TRUE
                        ]
                        csv_rows.append(csv_row)
                    
                    print(f"[CSV SAVE] ğŸ“ {symbol}: {action} {individual_lot} lot @ ${order_price:.2f}")
                
                # CSV dosyasÄ±na kaydet (her seferinde yeni dosya)
                import csv
                import os
                
                csv_filename = 'trades.csv'
                
                # Her seferinde yeni dosya oluÅŸtur (0'dan yaz)
                with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                    writer = csv.writer(csvfile)
                    
                    # Header yaz
                    csv_headers = ['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 
                                  'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 
                                  'OrderRef', 'Hidden', 'OutsideRth']
                    writer.writerow(csv_headers)
                    
                    # Emirleri yaz
                    writer.writerows(csv_rows)
                
                print(f"[CSV SAVE] âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                
            except Exception as e:
                print(f"[CSV SAVE] âŒ CSV kaydetme hatasÄ±: {e}")
                messagebox.showerror("Hata", f"CSV kaydetme hatasÄ±: {e}")
        
        def confirm_order():
            """SeÃ§ili emirleri gÃ¶nder"""
            try:
                if not selected_symbols:
                    print(f"[ORDER] âš ï¸ {group}: HiÃ§ hisse seÃ§ilmedi!")
                    win.destroy()
                    return
                
                print(f"[ORDER] ğŸ”„ {group}: {len(selected_symbols)} seÃ§ili hisse iÃ§in emirler gÃ¶nderiliyor...")
                
                for symbol in selected_symbols:
                    # Symbol mapping (PR -> -)
                    hammer_symbol = symbol.replace(" PR", "-")
                    
                    # Market data al
                    market_data = self.hammer.get_market_data(symbol)
                    
                    if order_type == "bid_buy":
                        # Bid buy: bid + spread*0.15
                        if market_data and 'bid' in market_data and 'ask' in market_data:
                            bid = float(market_data['bid'])
                            ask = float(market_data['ask'])
                            spread = ask - bid
                            price = bid + spread * 0.15
                        else:
                            print(f"[ORDER] âš ï¸ {symbol}: Bid/Ask fiyatÄ± bulunamadÄ±")
                            continue
                    else:  # ask_sell
                        # Ask sell: ask - spread*0.15
                        if market_data and 'ask' in market_data and 'bid' in market_data:
                            ask = float(market_data['ask'])
                            bid = float(market_data['bid'])
                            spread = ask - bid
                            price = ask - spread * 0.15
                        else:
                            print(f"[ORDER] âš ï¸ {symbol}: Ask/Bid fiyatÄ± bulunamadÄ±")
                            continue
                    
                    # Her hisse iÃ§in hesaplanan lot'u kullan
                    individual_lot = symbol_lots.get(symbol, 200)  # Default 200
                    
                    # Emir gÃ¶nder (mevcut moda gÃ¶re)
                    if hasattr(self, 'mode_manager'):
                        success = self.mode_manager.place_order(
                            symbol=hammer_symbol,
                            side="BUY" if order_type == "bid_buy" else "SELL",
                            quantity=individual_lot,
                            price=price,
                            order_type="LIMIT",
                            hidden=True
                        )
                        
                        if success:
                            print(f"[ORDER] âœ… {symbol}: {order_type} emri gÃ¶nderildi - {individual_lot} lot @ ${price:.2f}")
                        else:
                            print(f"[ORDER] âŒ {symbol}: {order_type} emri gÃ¶nderilemedi")
                    else:
                        # Fallback to direct hammer
                        self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="BUY" if order_type == "bid_buy" else "SELL",
                            quantity=individual_lot,
                            price=price,
                            order_type="LIMIT"
                        )
                    
                    print(f"[ORDER] âœ… {symbol}: {order_type} emri gÃ¶nderildi - {individual_lot} lot @ ${price:.2f} (MAXALW/4: {individual_lot})")
                
                print(f"[ORDER] âœ… {group} grubu iÃ§in {len(selected_symbols)} emir gÃ¶nderildi")
                win.destroy()
                
            except Exception as e:
                print(f"[ORDER] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                win.destroy()
        
        def cancel_order():
            """Ä°ptal et"""
            print(f"[ORDER] âŒ {group} grubu iÃ§in emirler iptal edildi")
            win.destroy()
        
        ttk.Button(button_frame, text="SeÃ§ili Emirleri GÃ¶nder", command=confirm_order, 
                  style='Accent.TButton').pack(side='left', padx=5)
        ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv, 
                  style='Accent.TButton').pack(side='left', padx=5)
        ttk.Button(button_frame, text="Ä°ptal Et", command=cancel_order).pack(side='left', padx=5)
        
        # Pencere referansÄ±nÄ± dÃ¶ndÃ¼r
        return win
    
    def show_positions(self):
        """Mevcut moda gÃ¶re pozisyonlarÄ±m penceresini aÃ§ - KULLANICI Ã–NCELÄ°KLÄ°"""
        # Hemen Ã§alÄ±ÅŸtÄ±r (kullanÄ±cÄ± etkileÅŸimi - en yÃ¼ksek Ã¶ncelik)
        def open_positions():
            try:
                if self.mode_manager.is_hampro_mode():
                    from .mypositions import show_positions_window
                    win = show_positions_window(self, self.get_last_price_for_symbol)
                    # Pencereyi hemen Ã¶ne getir
                    if win:
                        win.lift()
                        win.focus_force()
                elif self.mode_manager.is_ibkr_mode():
                    from .ibkr_positions import show_ibkr_positions_window
                    win = show_ibkr_positions_window(self, self.get_last_price_for_symbol)
                    # Pencereyi hemen Ã¶ne getir
                    if win:
                        win.lift()
                        win.focus_force()
            except Exception as e:
                print(f"[SHOW_POSITIONS] âŒ Hata: {e}")
        
        # Priority queue ile hemen Ã§alÄ±ÅŸtÄ±r
        self.priority_ui_call(open_positions)
    
    def set_mode(self, mode):
        """Modu deÄŸiÅŸtir ve GUI'yi gÃ¼ncelle"""
        if self.mode_manager.set_mode(mode):
            self.current_mode = mode
            self.hampro_mode = (mode == "HAMPRO")
            self.ibkr_gun_mode = (mode == "IBKR_GUN")
            self.ibkr_ped_mode = (mode == "IBKR_PED")
            
            # Buton gÃ¶rÃ¼nÃ¼mlerini gÃ¼ncelle
            if mode == "HAMPRO":
                self.btn_hampro_mode.configure(style="Accent.TButton")
                self.btn_ibkr_gun_mode.configure(style="TButton")
                self.btn_ibkr_ped_mode.configure(style="TButton")
            elif mode == "IBKR_GUN":
                self.btn_hampro_mode.configure(style="TButton")
                self.btn_ibkr_gun_mode.configure(style="Accent.TButton")
                self.btn_ibkr_ped_mode.configure(style="TButton")
            elif mode == "IBKR_PED":
                self.btn_hampro_mode.configure(style="TButton")
                self.btn_ibkr_gun_mode.configure(style="TButton")
                self.btn_ibkr_ped_mode.configure(style="Accent.TButton")
            
            print(f"[MAIN] ğŸ”„ Mod deÄŸiÅŸtirildi: {mode}")
            
            # Exposure bilgisini gÃ¼ncelle
            self.update_exposure_display()
            
            # BaÄŸlantÄ± durumlarÄ±nÄ± kontrol et
            status = self.mode_manager.get_connection_status()
            print(f"[MAIN] ğŸ“Š BaÄŸlantÄ± durumlarÄ±: {status}")
            
            # IBKR moduna geÃ§ildiyse baÄŸlantÄ±yÄ± kontrol et
            if mode in ["IBKR_GUN", "IBKR_PED"]:
                # Native IBKR client'i Ã¶ncelikle baÄŸla
                if not self.ibkr_native.is_connected():
                    print("[MAIN] âš ï¸ IBKR Native Gateway'e baÄŸlanÄ±lÄ±yor...")
                    if self.ibkr_native.connect_to_ibkr():
                        print("[MAIN] âœ… IBKR Native Gateway baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±")
                    else:
                        print("[MAIN] âŒ IBKR Native Gateway baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z")
                else:
                    print("[MAIN] âœ… IBKR Native Gateway zaten baÄŸlÄ±")
                
                # ib_insync client'i de baÄŸla (yedek olarak)
                if not self.ibkr.is_connected():
                    print("[MAIN] âš ï¸ IBKR ib_insync Gateway'e baÄŸlanÄ±lÄ±yor...")
                    if self.ibkr.connect_to_ibkr():
                        print("[MAIN] âœ… IBKR ib_insync Gateway baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±")
                    else:
                        print("[MAIN] âŒ IBKR ib_insync Gateway baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z")
                else:
                    print("[MAIN] âœ… IBKR ib_insync Gateway zaten baÄŸlÄ±")
                
                # NFILLED callback'lerini ayarla (IBKR fill logging iÃ§in)
                self.setup_nfilled_callbacks()

                # IBKR moduna geÃ§iÅŸte befibgun.csv veya befibped.csv gÃ¼nlÃ¼k kontrol (00:00-16:30)
                if mode == "IBKR_GUN":
                    if not self.befibgun_checked_today:
                        self.check_daily_befib()
                elif mode == "IBKR_PED":
                    if not self.befibped_checked_today:
                        self.check_daily_befib()
    
    def show_take_profit_longs(self):
        """Take Profit Longs penceresini aÃ§ - Sadece long pozisyonlar (quantity > 0) - KULLANICI Ã–NCELÄ°KLÄ°"""
        def open_take_profit_longs():
            try:
                from .take_profit_panel import TakeProfitPanel
                panel = TakeProfitPanel(self, "longs")
                # Pencereyi hemen Ã¶ne getir
                if hasattr(panel, 'win') and panel.win:
                    panel.win.lift()
                    panel.win.focus_force()
            except Exception as e:
                print(f"[SHOW_TAKE_PROFIT_LONGS] âŒ Hata: {e}")
        
        # Priority queue ile hemen Ã§alÄ±ÅŸtÄ±r
        self.priority_ui_call(open_take_profit_longs)
    
    def show_take_profit_shorts(self):
        """Take Profit Shorts penceresini aÃ§ - Sadece short pozisyonlar (quantity < 0) - KULLANICI Ã–NCELÄ°KLÄ°"""
        def open_take_profit_shorts():
            try:
                from .take_profit_panel import TakeProfitPanel
                panel = TakeProfitPanel(self, "shorts")
                # Pencereyi hemen Ã¶ne getir
                if hasattr(panel, 'win') and panel.win:
                    panel.win.lift()
                    panel.win.focus_force()
            except Exception as e:
                print(f"[SHOW_TAKE_PROFIT_SHORTS] âŒ Hata: {e}")
        
        # Priority queue ile hemen Ã§alÄ±ÅŸtÄ±r
        self.priority_ui_call(open_take_profit_shorts)
    
    def execute_croplit6(self):
        """Croplit6: Spread > 0.06, Longs iÃ§in Ask Sell PahalÄ±lÄ±k > -0.06, Shorts iÃ§in Bid Buy Ucuzluk < 0.06"""
        self.execute_croplit(spread_threshold=0.06)
    
    def execute_croplit9(self):
        """Croplit9: Spread > 0.09, Longs iÃ§in Ask Sell PahalÄ±lÄ±k > -0.06, Shorts iÃ§in Bid Buy Ucuzluk < 0.06"""
        self.execute_croplit(spread_threshold=0.09)
    
    def execute_croplit(self, spread_threshold=0.06):
        """
        Croplit iÅŸlemini yÃ¼rÃ¼t: Take Profit Longs ve Shorts panellerini aÃ§, koÅŸullarÄ± kontrol et, emir gÃ¶nder
        
        Args:
            spread_threshold: Spread eÅŸiÄŸi (0.06 veya 0.09)
        """
        try:
            print(f"[CROPLIT] ğŸ”ª Croplit baÅŸlatÄ±lÄ±yor (Spread > {spread_threshold})...")
            
            # Take Profit Longs panelini aÃ§ ve pozisyonlarÄ± yÃ¼kle
            from .take_profit_panel import TakeProfitPanel
            longs_panel = TakeProfitPanel(self, "longs")
            self.after(500, lambda: self.process_croplit_long_positions(longs_panel, spread_threshold))
            
            # Take Profit Shorts panelini aÃ§ ve pozisyonlarÄ± yÃ¼kle
            shorts_panel = TakeProfitPanel(self, "shorts")
            self.after(1000, lambda: self.process_croplit_short_positions(shorts_panel, spread_threshold))
            
        except Exception as e:
            print(f"[CROPLIT] âŒ Hata: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Croplit hatasÄ±: {e}")
    
    def process_croplit_long_positions(self, panel, spread_threshold):
        """Long pozisyonlar iÃ§in Croplit iÅŸlemini yÃ¼rÃ¼t"""
        try:
            print(f"[CROPLIT] ğŸ” Long pozisyonlar kontrol ediliyor...")
            
            # PozisyonlarÄ± bekle (yÃ¼klenene kadar)
            import time
            time.sleep(1)  # PozisyonlarÄ±n yÃ¼klenmesi iÃ§in bekle
            
            orders_to_send = []
            
            for pos in panel.positions:
                symbol = pos['symbol']
                qty = abs(pos['qty'])  # Long pozisyon miktarÄ± (pozitif)
                ask_sell_pahalilik = pos.get('ask_sell_pahalilik_skoru', 0.0)
                
                # Spread deÄŸerini mini450'den al
                spread = 0.0
                if hasattr(self, 'df') and not self.df.empty:
                    symbol_row = self.df[self.df['PREF IBKR'] == symbol]
                    if not symbol_row.empty and 'Spread' in self.df.columns:
                        spread_val = symbol_row['Spread'].iloc[0]
                        if pd.notna(spread_val) and spread_val != 'N/A':
                            try:
                                spread = float(spread_val)
                            except:
                                spread = 0.0
                
                # EÄŸer mini450'de yoksa market data'dan al
                if spread == 0.0:
                    market_data = self.hammer.get_market_data(symbol)
                    if market_data:
                        bid = float(market_data.get('bid', 0))
                        ask = float(market_data.get('ask', 0))
                        spread = ask - bid
                
                if spread == 0.0:
                    continue
                
                # KoÅŸullarÄ± kontrol et
                if spread <= spread_threshold:
                    print(f"[CROPLIT] âš ï¸ {symbol}: Spread {spread:.4f} <= {spread_threshold}, atlandÄ±")
                    continue
                
                if ask_sell_pahalilik <= -0.06:
                    print(f"[CROPLIT] âš ï¸ {symbol}: Ask Sell PahalÄ±lÄ±k {ask_sell_pahalilik:.4f} <= -0.06, atlandÄ±")
                    continue
                
                if qty < 200:
                    # 200'den kÃ¼Ã§Ã¼kse ne kadar varsa o kadar
                    order_qty = int(qty)
                else:
                    # %10 hesapla ve 100'lÃ¼k birime yuvarla
                    order_qty = int(qty * 0.1)
                    # 100'lÃ¼k birime yuvarla (aÅŸaÄŸÄ±)
                    order_qty = (order_qty // 100) * 100
                    if order_qty < 200:
                        order_qty = 200  # Minimum 200
                
                if order_qty > 0:
                    # Market data al (fiyat hesaplama iÃ§in)
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        continue
                    ask = float(market_data.get('ask', 0))
                    bid = float(market_data.get('bid', 0))
                    if ask == 0 or bid == 0:
                        continue
                    
                    # Ask Sell fiyatÄ± hesapla
                    ask_sell_price = ask - (spread * 0.15)
                    
                    orders_to_send.append({
                        'symbol': symbol,
                        'side': 'SELL',
                        'quantity': order_qty,
                        'price': ask_sell_price,
                        'original_qty': qty
                    })
                    
                    print(f"[CROPLIT] âœ… {symbol}: {order_qty} lot Ask Sell @ ${ask_sell_price:.2f} (Orijinal: {qty}, Spread: {spread:.4f}, PahalÄ±lÄ±k: {ask_sell_pahalilik:.4f})")
            
            # Emirleri gÃ¶nder
            if orders_to_send:
                self.send_croplit_orders(orders_to_send, "Longs")
            else:
                print(f"[CROPLIT] âš ï¸ Long pozisyonlar iÃ§in uygun emir bulunamadÄ±")
                
        except Exception as e:
            print(f"[CROPLIT] âŒ Long pozisyon iÅŸleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def process_croplit_short_positions(self, panel, spread_threshold):
        """Short pozisyonlar iÃ§in Croplit iÅŸlemini yÃ¼rÃ¼t"""
        try:
            print(f"[CROPLIT] ğŸ” Short pozisyonlar kontrol ediliyor...")
            
            # PozisyonlarÄ± bekle (yÃ¼klenene kadar)
            import time
            time.sleep(1)  # PozisyonlarÄ±n yÃ¼klenmesi iÃ§in bekle
            
            orders_to_send = []
            
            for pos in panel.positions:
                symbol = pos['symbol']
                qty = abs(pos['qty'])  # Short pozisyon miktarÄ± (pozitif)
                bid_buy_ucuzluk = pos.get('bid_buy_ucuzluk_skoru', 0.0)
                
                # Spread deÄŸerini mini450'den al
                spread = 0.0
                if hasattr(self, 'df') and not self.df.empty:
                    symbol_row = self.df[self.df['PREF IBKR'] == symbol]
                    if not symbol_row.empty and 'Spread' in self.df.columns:
                        spread_val = symbol_row['Spread'].iloc[0]
                        if pd.notna(spread_val) and spread_val != 'N/A':
                            try:
                                spread = float(spread_val)
                            except:
                                spread = 0.0
                
                # EÄŸer mini450'de yoksa market data'dan al
                if spread == 0.0:
                    market_data = self.hammer.get_market_data(symbol)
                    if market_data:
                        bid = float(market_data.get('bid', 0))
                        ask = float(market_data.get('ask', 0))
                        spread = ask - bid
                
                if spread == 0.0:
                    continue
                
                # KoÅŸullarÄ± kontrol et
                if spread <= spread_threshold:
                    print(f"[CROPLIT] âš ï¸ {symbol}: Spread {spread:.4f} <= {spread_threshold}, atlandÄ±")
                    continue
                
                if bid_buy_ucuzluk >= 0.06:
                    print(f"[CROPLIT] âš ï¸ {symbol}: Bid Buy Ucuzluk {bid_buy_ucuzluk:.4f} >= 0.06, atlandÄ±")
                    continue
                
                if qty < 200:
                    # 200'den kÃ¼Ã§Ã¼kse ne kadar varsa o kadar
                    order_qty = int(qty)
                else:
                    # %10 hesapla ve 100'lÃ¼k birime yuvarla
                    order_qty = int(qty * 0.1)
                    # 100'lÃ¼k birime yuvarla (aÅŸaÄŸÄ±)
                    order_qty = (order_qty // 100) * 100
                    if order_qty < 200:
                        order_qty = 200  # Minimum 200
                
                if order_qty > 0:
                    # Market data al (fiyat hesaplama iÃ§in)
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        continue
                    ask = float(market_data.get('ask', 0))
                    bid = float(market_data.get('bid', 0))
                    if ask == 0 or bid == 0:
                        continue
                    
                    # Bid Buy fiyatÄ± hesapla
                    bid_buy_price = bid + (spread * 0.15)
                    
                    orders_to_send.append({
                        'symbol': symbol,
                        'side': 'BUY',
                        'quantity': order_qty,
                        'price': bid_buy_price,
                        'original_qty': qty
                    })
                    
                    print(f"[CROPLIT] âœ… {symbol}: {order_qty} lot Bid Buy @ ${bid_buy_price:.2f} (Orijinal: {qty}, Spread: {spread:.4f}, Ucuzluk: {bid_buy_ucuzluk:.4f})")
            
            # Emirleri gÃ¶nder
            if orders_to_send:
                self.send_croplit_orders(orders_to_send, "Shorts")
            else:
                print(f"[CROPLIT] âš ï¸ Short pozisyonlar iÃ§in uygun emir bulunamadÄ±")
                
        except Exception as e:
            print(f"[CROPLIT] âŒ Short pozisyon iÅŸleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def send_croplit_orders(self, orders, position_type):
        """Croplit emirlerini gÃ¶nder"""
        try:
            print(f"[CROPLIT] ğŸ“¤ {len(orders)} {position_type} emri gÃ¶nderiliyor...")
            
            success_count = 0
            error_count = 0
            
            for order in orders:
                symbol = order['symbol']
                side = order['side']
                quantity = order['quantity']
                price = order['price']
                
                # Symbol mapping (PR -> -)
                hammer_symbol = symbol.replace(" PR", "-")
                
                # Mevcut moda gÃ¶re emir gÃ¶nder
                if hasattr(self, 'mode_manager'):
                    success = self.mode_manager.place_order(
                        symbol=hammer_symbol,
                        side=side,
                        quantity=quantity,
                        price=price,
                        order_type="LIMIT",
                        hidden=True
                    )
                    
                    if success:
                        print(f"[CROPLIT] âœ… {symbol}: {side} {quantity} lot @ ${price:.2f}")
                        success_count += 1
                        
                        self.log_psfalgo_activity(
                            action=f"CROPLIT {position_type} Emir",
                            details=f"{symbol}: {side} {quantity} lot @ ${price:.2f}",
                            status="SUCCESS",
                            category="CROPLIT"
                        )
                    else:
                        print(f"[CROPLIT] âŒ {symbol}: Emir gÃ¶nderilemedi")
                        error_count += 1
                        
                        self.log_psfalgo_activity(
                            action=f"CROPLIT {position_type} BaÅŸarÄ±sÄ±z",
                            details=f"{symbol}: Emir gÃ¶nderilemedi",
                            status="ERROR",
                            category="CROPLIT"
                        )
                else:
                    print(f"[CROPLIT] âŒ Mode manager bulunamadÄ±")
                    error_count += 1
                    
                    self.log_psfalgo_activity(
                        action=f"CROPLIT {position_type} Hata",
                        details=f"{symbol}: Mode manager bulunamadÄ±",
                        status="ERROR",
                        category="CROPLIT"
                    )
            
            # SonuÃ§ mesajÄ±
            result_msg = f"Croplit {position_type} Emirleri:\n\n"
            result_msg += f"âœ… BaÅŸarÄ±lÄ±: {success_count}\n"
            result_msg += f"âŒ HatalÄ±: {error_count}\n"
            result_msg += f"ğŸ“Š Toplam: {len(orders)}"
            
            messagebox.showinfo("Croplit SonuÃ§", result_msg)
            print(f"[CROPLIT] âœ… {position_type} iÅŸlemi tamamlandÄ±: {success_count} baÅŸarÄ±lÄ±, {error_count} hatalÄ±")
            
        except Exception as e:
            print(f"[CROPLIT] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Emir gÃ¶nderme hatasÄ±: {e}")
    
    def show_spreadkusu(self):
        """Spreadkusu penceresini aÃ§ - Spread >= 0.20 olan hisseler - KULLANICI Ã–NCELÄ°KLÄ°"""
        def open_spreadkusu():
            try:
                from .spreadkusu_panel import SpreadkusuPanel
                panel = SpreadkusuPanel(self)
                # Pencereyi hemen Ã¶ne getir
                if hasattr(panel, 'win') and panel.win:
                    panel.win.lift()
                    panel.win.focus_force()
            except Exception as e:
                print(f"[SHOW_SPREADKUSU] âŒ Hata: {e}")
        
        # Priority queue ile hemen Ã§alÄ±ÅŸtÄ±r
        self.priority_ui_call(open_spreadkusu)
    
    def runall_execute_qpcal(self):
        """RUNALL iÃ§in Qpcal iÅŸlemini yÃ¼rÃ¼t: Spreadkusu panel aÃ§, Qpcal butonuna tÄ±kla, Runqp'a bas, emirleri gÃ¶nder"""
        try:
            print("[RUNALL] ğŸ”„ Qpcal iÅŸlemi baÅŸlatÄ±lÄ±yor...")
            self.log_message("ğŸ”„ Qpcal iÅŸlemi baÅŸlatÄ±lÄ±yor...")
            
            # Spreadkusu panel'i aÃ§ veya mevcut panel'i kullan
            if not hasattr(self, 'spreadkusu_panel') or not self.spreadkusu_panel:
                print("[RUNALL] ğŸ“Š Spreadkusu panel aÃ§Ä±lÄ±yor...")
                from .spreadkusu_panel import SpreadkusuPanel
                self.spreadkusu_panel = SpreadkusuPanel(self)
                # Veri yÃ¼klenmesini bekle (2 saniye - daha gÃ¼venli)
                self.after(2000, lambda: self._runall_qpcal_after_panel_ready())
            else:
                # Mevcut panel'i kullan (ama Ã¶ne getirme - kullanÄ±cÄ± isterse aÃ§abilir)
                try:
                    if self.spreadkusu_panel.win.winfo_exists():
                        print("[RUNALL] ğŸ“Š Mevcut Spreadkusu panel kullanÄ±lÄ±yor (arka planda)...")
                        # lift() ve focus() kaldÄ±rÄ±ldÄ± - kullanÄ±cÄ± isterse pencereyi aÃ§abilir
                        # Veri yÃ¼klenmesini bekle (2 saniye - daha gÃ¼venli)
                        self.after(2000, lambda: self._runall_qpcal_after_panel_ready())
                    else:
                        # Pencere kapanmÄ±ÅŸsa yeniden aÃ§
                        print("[RUNALL] ğŸ“Š Spreadkusu panel yeniden aÃ§Ä±lÄ±yor...")
                        from .spreadkusu_panel import SpreadkusuPanel
                        self.spreadkusu_panel = SpreadkusuPanel(self)
                        # Veri yÃ¼klenmesini bekle (2 saniye - daha gÃ¼venli)
                        self.after(2000, lambda: self._runall_qpcal_after_panel_ready())
                except Exception as e:
                    print(f"[RUNALL] âš ï¸ Spreadkusu panel kontrolÃ¼ hatasÄ±: {e}, yeniden aÃ§Ä±lÄ±yor...")
                    # Pencere kapanmÄ±ÅŸsa yeniden aÃ§
                    from .spreadkusu_panel import SpreadkusuPanel
                    self.spreadkusu_panel = SpreadkusuPanel(self)
                    # Veri yÃ¼klenmesini bekle (2 saniye - daha gÃ¼venli)
                    self.after(2000, lambda: self._runall_qpcal_after_panel_ready())
        
        except Exception as e:
            print(f"[RUNALL] âŒ Qpcal iÅŸlemi hatasÄ±: {e}")
            self.log_message(f"âŒ Qpcal iÅŸlemi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            
            # Hata olsa bile 2 dakika sonra restart yap
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            should_continue = runall_running or runall_allowed
            
            if should_continue:
                print("[RUNALL] âš ï¸ Qpcal hatasÄ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                self.log_message("âš ï¸ Qpcal hatasÄ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                # 2 dakika bekle, sonra emirleri iptal et
                self.after(120000, lambda: self.runall_cancel_orders_and_restart())
    
    def _runall_qpcal_after_panel_ready(self):
        """Spreadkusu panel hazÄ±r olduktan sonra Qpcal'i baÅŸlat"""
        try:
            # Qpcal callback'i: Emirler gÃ¶nderildikten sonra 2 dakika sayacÄ±nÄ± baÅŸlat
            def qpcal_complete_callback():
                try:
                    print("[RUNALL] âœ… Qpcal emirleri gÃ¶nderildi, 2 dakika sayacÄ± baÅŸlatÄ±lÄ±yor...")
                    self.log_message("âœ… Qpcal emirleri gÃ¶nderildi, 2 dakika sayacÄ± baÅŸlatÄ±lÄ±yor...")
                    
                    # Qpcal penceresini kapat
                    if hasattr(self, 'spreadkusu_panel') and self.spreadkusu_panel:
                        try:
                            if hasattr(self.spreadkusu_panel, 'qpcal_window') and self.spreadkusu_panel.qpcal_window:
                                if self.spreadkusu_panel.qpcal_window.winfo_exists():
                                    self.spreadkusu_panel.qpcal_window.destroy()
                        except:
                            pass
                    
                    # 2 dakika sonra emirleri iptal et ve tekrar baÅŸla
                    def schedule_cancel_and_restart():
                        print(f"[RUNALL] â° schedule_cancel_and_restart() Ã§aÄŸrÄ±ldÄ± (Qpcal sonrasÄ±)")
                        runall_still_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                        runall_still_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                        should_proceed = runall_still_running or runall_still_allowed
                        print(f"[RUNALL] ğŸ” schedule_cancel_and_restart iÃ§inde: runall_loop_running={runall_still_running}, runall_allowed_mode={runall_still_allowed}, should_proceed={should_proceed}")
                        if should_proceed:
                            # runall_loop_running'i True yap (eÄŸer runall_allowed_mode aktifse)
                            if runall_still_allowed and not runall_still_running:
                                self.runall_loop_running = True
                                print(f"[RUNALL] âœ… runall_loop_running True yapÄ±ldÄ± (runall_allowed_mode aktif)")
                            
                            # Tamamlanan dÃ¶ngÃ¼ sayÄ±sÄ±nÄ± gÃ¶ster
                            completed_loops = self.runall_loop_count if hasattr(self, 'runall_loop_count') else 0
                            self.log_message(f"â° 2 dakika geÃ§ti, {completed_loops}. dÃ¶ngÃ¼ iÃ§in emirler iptal ediliyor...")
                            print(f"[RUNALL] â° 2 dakika geÃ§ti, {completed_loops}. dÃ¶ngÃ¼ iÃ§in emirler iptal ediliyor...")
                            self.runall_cancel_orders_and_restart()
                        else:
                            print(f"[RUNALL] âš ï¸ RUNALL dÃ¶ngÃ¼sÃ¼ durdurulmuÅŸ, callback iptal edildi")
                    
                    print(f"[RUNALL] â° 120 saniye (2 dakika) sonra schedule_cancel_and_restart() Ã§aÄŸrÄ±lacak (Qpcal sonrasÄ±)")
                    self.after(120000, schedule_cancel_and_restart)  # 2 dakika bekleme
                    self.runall_addnewpos_callback_set = False
                except Exception as e:
                    print(f"[RUNALL] âŒ Qpcal callback hatasÄ±: {e}")
                    self.log_message(f"âŒ Qpcal callback hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
            
            # Qpcal penceresini aÃ§ ve callback'i geÃ§ir
            if hasattr(self, 'spreadkusu_panel') and self.spreadkusu_panel:
                print("[RUNALL] ğŸ”„ Qpcal penceresi aÃ§Ä±lÄ±yor...")
                self.spreadkusu_panel.show_qpcal_window(on_complete_callback=qpcal_complete_callback)
            else:
                print("[RUNALL] âŒ Spreadkusu panel bulunamadÄ±!")
                self.log_message("âŒ Spreadkusu panel bulunamadÄ±!")
                # Hata durumunda 2 dakika sonra restart yap
                runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                should_continue = runall_running or runall_allowed
                
                if should_continue:
                    print("[RUNALL] âš ï¸ Qpcal hatasÄ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                    self.log_message("âš ï¸ Qpcal hatasÄ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                    # 2 dakika bekle, sonra emirleri iptal et
                    self.after(120000, lambda: self.runall_cancel_orders_and_restart())
        except Exception as e:
            print(f"[RUNALL] âŒ Qpcal baÅŸlatma hatasÄ±: {e}")
            self.log_message(f"âŒ Qpcal baÅŸlatma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            
            # Hata olsa bile 2 dakika sonra restart yap
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            should_continue = runall_running or runall_allowed
            
            if should_continue:
                print("[RUNALL] âš ï¸ Qpcal hatasÄ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                self.log_message("âš ï¸ Qpcal hatasÄ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                # 2 dakika bekle, sonra emirleri iptal et
                self.after(120000, lambda: self.runall_cancel_orders_and_restart())
    
    def show_port_adjuster(self):
        """Port Adjuster penceresini aÃ§"""
        from .port_adjuster import PortAdjusterWindow
        port_window = PortAdjusterWindow(self)
        
        # Stock Data Manager referansÄ±nÄ± geÃ§
        port_window.set_stock_data_manager(self.stock_data_manager)
        
        # Port Adjuster window referansÄ±nÄ± dÃ¶ndÃ¼r (ADDNEWPOS iÃ§in)
        return port_window
    
    def show_portfolio_comparison(self):
        """Portfolio Comparison penceresini aÃ§"""
        from .portfolio_comparison import PortfolioComparisonWindow
        PortfolioComparisonWindow(self)
    
    def show_my_orders(self):
        """Emirlerim penceresini aÃ§ - Mod-aware - KULLANICI Ã–NCELÄ°KLÄ°"""
        def open_orders():
            try:
                # Mevcut moda gÃ¶re emirleri gÃ¶ster
                if hasattr(self, 'mode_manager'):
                    if self.mode_manager.is_hampro_mode():
                        print("[MAIN] ğŸ”„ HAMPRO modunda emirler gÃ¶steriliyor...")
                        # Hammer Pro'dan emirleri gÃ¶ster
                        from .myorders import show_orders_window
                        win = show_orders_window(self)
                        # Pencereyi hemen Ã¶ne getir
                        if win:
                            win.lift()
                            win.focus_force()
                    elif self.mode_manager.is_ibkr_mode():
                        print("[MAIN] ğŸ”„ IBKR modunda emirler gÃ¶steriliyor...")
                        # IBKR'den emirleri gÃ¶ster
                        from .ibkr_orders import show_ibkr_orders_window
                        win = show_ibkr_orders_window(self)
                        # Pencereyi hemen Ã¶ne getir
                        if win:
                            win.lift()
                            win.focus_force()
                    else:
                        print("[MAIN] âš ï¸ Mod belirlenemedi, HAMPRO kullanÄ±lÄ±yor...")
                        from .myorders import show_orders_window
                        win = show_orders_window(self)
                        if win:
                            win.lift()
                            win.focus_force()
                else:
                    print("[MAIN] âš ï¸ Mode manager bulunamadÄ±, HAMPRO kullanÄ±lÄ±yor...")
                    from .myorders import show_orders_window
                    win = show_orders_window(self)
                    if win:
                        win.lift()
                        win.focus_force()
            except Exception as e:
                print(f"[SHOW_MY_ORDERS] âŒ Hata: {e}")
        
        # Priority queue ile hemen Ã§alÄ±ÅŸtÄ±r
        self.priority_ui_call(open_orders)
    
    def reset_trades_csv(self):
        """trades.csv dosyasÄ±nÄ± sÄ±fÄ±rla - yeni iÅŸlem baÅŸlÄ±yor"""
        try:
            import os
            
            csv_filename = 'trades.csv'
            
            # Dosya varsa sÄ±fÄ±rla
            if os.path.exists(csv_filename):
                # Mevcut dosyayÄ± yedekle
                import time
                backup_filename = f'trades_backup_{int(time.time())}.csv'
                os.rename(csv_filename, backup_filename)
                print(f"[CSV RESET] ğŸ’¾ Mevcut trades.csv yedeklendi: {backup_filename}")
            
            # Yeni boÅŸ dosya oluÅŸtur (sadece baÅŸlÄ±klarla)
            import csv
            csv_headers = ['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 
                          'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 
                          'OrderRef', 'Hidden', 'OutsideRth']
            
            with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.writer(csvfile)
                writer.writerow(csv_headers)
            
            print(f"[CSV RESET] âœ… trades.csv sÄ±fÄ±rlandÄ±, yeni iÅŸlem baÅŸlÄ±yor")
            
        except Exception as e:
            print(f"[CSV RESET] âŒ CSV sÄ±fÄ±rlama hatasÄ±: {e}")
    
    def show_mini450_view(self):
        """
        JANALLDATA'daki tÃ¼m 450 hisseyi tek sayfada mini gÃ¶rÃ¼nÃ¼mde gÃ¶ster.
        Bu sayede tÃ¼m hisseler iÃ§in aynÄ± anda live data request atÄ±labilir.
        """
        try:
            print("ğŸ” MÄ°NÄ°450 GÃ–RÃœNÃœMÃœ AÃ‡ILIYOR...")
            print("=" * 60)
            
            # Mini450 aktif flag'ini set et (performans optimizasyonu iÃ§in)
            self.is_mini450_active = True
            
            # Arka plan data gÃ¼ncelleme thread'ini baÅŸlat
            self.start_background_data_update()
            
            # Hammer Pro baÄŸlantÄ±sÄ±nÄ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer.connected:
                messagebox.showwarning("UyarÄ±", "Ã–nce Hammer Pro'ya baÄŸlanÄ±n!")
                return
                
            # Live data'nÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin ol
            if not hasattr(self, 'live_data_running') or not self.live_data_running:
                messagebox.showwarning("UyarÄ±", "Ã–nce Live Data'yÄ± baÅŸlatÄ±n!")
                return
            
            # JANALLDATA dosyasÄ±nÄ± yÃ¼kle
            if not os.path.exists('janalldata.csv'):
                messagebox.showerror("Hata", "janalldata.csv dosyasÄ± bulunamadÄ±!")
                return
            
            # Mevcut durumu kaydet
            self.original_items_per_page = self.items_per_page
            self.original_current_page = self.current_page
            
            # CSV'yi yÃ¼kle (Fbtot/SFStot hesaplamasÄ± show_file_data iÃ§inde skorlar hesaplandÄ±ktan sonra yapÄ±lacak)
            df = pd.read_csv('janalldata.csv')
            print(f"ğŸ“Š JANALLDATA yÃ¼klendi: {len(df)} hisse")
            
            # TÃ¼m hisseleri tek sayfada gÃ¶stermek iÃ§in items_per_page'i artÄ±r
            self.items_per_page = len(df)  # TÃ¼m hisseleri tek sayfada gÃ¶ster
            self.current_page = 0
            
            # Normal show_file_data mantÄ±ÄŸÄ±nÄ± kullan ama mini gÃ¶rÃ¼nÃ¼m iÃ§in optimize et
            # Fbtot/SFStot hesaplamasÄ± show_file_data iÃ§inde skorlar hesaplandÄ±ktan sonra yapÄ±lacak
            self.show_file_data('janalldata.csv', is_main=True)
            
            # Tablo satÄ±r yÃ¼ksekliÄŸini kÃ¼Ã§Ã¼lt (mini gÃ¶rÃ¼nÃ¼m)
            self.table.configure(height=25)  # Daha fazla satÄ±r gÃ¶ster
            
            # Font boyutunu kÃ¼Ã§Ã¼lt
            style = ttk.Style()
            style.configure("Mini.Treeview", font=('Arial', 8))  # KÃ¼Ã§Ã¼k font
            style.configure("Mini.Treeview.Heading", font=('Arial', 8, 'bold'))
            self.table.configure(style="Mini.Treeview")
            
            # Kolon geniÅŸliklerini kÃ¼Ã§Ã¼lt
            for col in self.columns:
                if col == 'PREF IBKR':
                    self.table.column(col, width=80)  # Sembol kolonu
                elif col in ['Bid', 'Ask', 'Last']:
                    self.table.column(col, width=50)  # Fiyat kolonlarÄ±
                elif col == 'SMA63 chg':
                    self.table.column(col, width=45)  # SMA63 chg kolonu
                elif col in ['SMA246 chg', 'SMA 246 CHG']:
                    self.table.column(col, width=50)  # SMA246 chg kolonu
                elif col == 'GORT':
                    self.table.column(col, width=50)  # GORT kolonu
                elif col in ['Final_FB_skor', 'Final_SFS_skor', 'Final_BB_skor']:
                    self.table.column(col, width=60)  # Skor kolonlarÄ±  
                else:
                    self.table.column(col, width=40)  # DiÄŸer kolonlar
            
            print(f"ğŸ” Mini450 gÃ¶rÃ¼nÃ¼mÃ¼ aktif: {len(df)} hisse tek sayfada")
            print(f"ğŸ“¡ TÃ¼m hisseler iÃ§in live data request'leri atÄ±lÄ±yor...")
            
            # BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
            self.title("JanAll - Mini450 GÃ¶rÃ¼nÃ¼mÃ¼ (TÃ¼m Hisseler)")
            
            # Normal buton ekle (Ã§Ä±kÄ±ÅŸ iÃ§in)
            self.add_normal_view_button()
            
            messagebox.showinfo("Mini450 Aktif", 
                              f"âœ… Mini450 gÃ¶rÃ¼nÃ¼mÃ¼ aktif!\n\n"
                              f"ğŸ“Š {len(df)} hisse tek sayfada gÃ¶steriliyor\n"
                              f"ğŸ“¡ TÃ¼m hisseler iÃ§in live data alÄ±nÄ±yor\n"
                              f"ğŸ” ArtÄ±k tÃ¼m skorlar hesaplanacak!\n\n"
                              f"Normal gÃ¶rÃ¼nÃ¼me dÃ¶nmek iÃ§in 'Normal GÃ¶rÃ¼nÃ¼m' butonuna basÄ±n.")
            
        except Exception as e:
            print(f"âŒ Mini450 gÃ¶rÃ¼nÃ¼mÃ¼ hatasÄ±: {e}")
            messagebox.showerror("Hata", f"Mini450 gÃ¶rÃ¼nÃ¼mÃ¼ hatasÄ±: {e}")
            
            # Hata durumunda orijinal duruma dÃ¶n
            self.restore_normal_view()
    
    def add_normal_view_button(self):
        """Normal gÃ¶rÃ¼nÃ¼me dÃ¶nmek iÃ§in buton ekle"""
        if not hasattr(self, 'normal_view_button'):
            # Buton frame'i bul veya oluÅŸtur
            if hasattr(self, 'files_frame'):
                files_frame = self.children[list(self.children.keys())[2]]  # files_frame'i bul
                for child in files_frame.winfo_children():
                    if isinstance(child, ttk.Frame):
                        main_frame = child
                        break
                
                # Normal gÃ¶rÃ¼nÃ¼m butonu ekle
                self.normal_view_button = ttk.Button(main_frame, text="ğŸ”™ Normal GÃ¶rÃ¼nÃ¼m", 
                                                   command=self.restore_normal_view)
                self.normal_view_button.pack(side='left', padx=5)
    
    def restore_normal_view(self):
        """Normal gÃ¶rÃ¼nÃ¼me geri dÃ¶n"""
        try:
            # Mini450 flag'ini sÄ±fÄ±rla (performans optimizasyonu)
            self.is_mini450_active = False
            
            # Arka plan thread'ini durdur
            self.stop_background_data_update()
            
            # Orijinal deÄŸerleri geri yÃ¼kle
            if hasattr(self, 'original_items_per_page'):
                self.items_per_page = self.original_items_per_page
                self.current_page = self.original_current_page
                
                # Sayfa sayÄ±sÄ±nÄ± yeniden hesapla
                if hasattr(self, 'tickers'):
                    self.total_pages = max(1, (len(self.tickers) + self.items_per_page - 1) // self.items_per_page)
                
                # Tabloyu normale dÃ¶ndÃ¼r
                self.table.configure(height=15)  # Normal yÃ¼kseklik
                
                # Font'u normale dÃ¶ndÃ¼r
                style = ttk.Style()
                style.configure("Treeview", font=('Arial', 9))
                style.configure("Treeview.Heading", font=('Arial', 9, 'bold'))
                self.table.configure(style="Treeview")
                
                # Kolon geniÅŸliklerini normale dÃ¶ndÃ¼r
                for col in self.columns:
                    if col == 'SeÃ§':
                        self.table.column(col, width=30, anchor='center')
                    elif col == 'PREF IBKR':
                        self.table.column(col, width=100, anchor='center')
                    elif col in ['Bid', 'Ask', 'Last', 'Volume']:
                        self.table.column(col, width=70, anchor='center')
                    elif col in ['Final_FB_skor', 'Final_SFS_skor', 'Final_BB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor']:
                        self.table.column(col, width=80, anchor='center')
                    elif col == 'SMA63 chg':
                        self.table.column(col, width=60, anchor='center')  # SMA63 chg kolonu
                    elif col in ['SMA246 chg', 'SMA 246 CHG']:
                        self.table.column(col, width=60, anchor='center')  # SMA246 chg kolonu
                    elif col == 'GORT':
                        self.table.column(col, width=60, anchor='center')  # GORT kolonu
                    else:
                        self.table.column(col, width=60, anchor='center')
                
                # Tabloyu gÃ¼ncelle
                self.update_table()
                
                # Normal gÃ¶rÃ¼nÃ¼m butonunu kaldÄ±r
                if hasattr(self, 'normal_view_button'):
                    self.normal_view_button.destroy()
                    delattr(self, 'normal_view_button')
                
                # BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
                self.title("JanAll - Normal GÃ¶rÃ¼nÃ¼m")
                
                print("ğŸ”™ Normal gÃ¶rÃ¼nÃ¼me dÃ¶nÃ¼ldÃ¼")
                
        except Exception as e:
            print(f"âŒ Normal gÃ¶rÃ¼nÃ¼me dÃ¶nÃ¼ÅŸ hatasÄ±: {e}")
    
    def start_background_data_update(self):
        """Arka plan data gÃ¼ncelleme thread'ini baÅŸlat"""
        if not self.background_update_running:
            self.background_update_running = True
            self.background_update_thread = threading.Thread(
                target=self.background_data_worker, 
                daemon=True
            )
            self.background_update_thread.start()
            print("ğŸ”§ Arka plan data gÃ¼ncelleme thread'i baÅŸlatÄ±ldÄ±")
    
    def stop_background_data_update(self):
        """Arka plan data gÃ¼ncelleme thread'ini durdur"""
        self.background_update_running = False
        if self.background_update_thread:
            print("ğŸ”§ Arka plan data gÃ¼ncelleme thread'i durduruluyor...")
    
    def background_data_worker(self):
        """Arka plan thread - data cache gÃ¼ncelleme"""
        while self.background_update_running:
            try:
                if self.is_mini450_active and hasattr(self, 'df') and not self.df.empty:
                    # Mini450 aktifken arka planda data cache'i gÃ¼ncelle
                    for _, row in self.df.iterrows():
                        if not self.background_update_running:
                            break
                            
                        ticker = row.get('PREF IBKR', '')
                        if ticker and hasattr(self, 'hammer') and self.hammer.connected:
                            try:
                                # Market data al ve cache'e koy
                                market_data = self.hammer.get_market_data(ticker)
                                if market_data:
                                    self.background_data_cache[ticker] = {
                                        'market_data': market_data,
                                        'timestamp': time.time()
                                    }
                                
                                # CPU yÃ¼kÃ¼nÃ¼ azaltmak iÃ§in kÄ±sa bekle
                                time.sleep(0.1)
                                
                            except Exception as e:
                                # Sessizce devam et
                                pass
                
                # Arka plan gÃ¼ncellemesi: 5 saniyede bir
                time.sleep(5)
                
            except Exception as e:
                print(f"[BACKGROUND] âŒ Arka plan hatasÄ±: {e}")
                time.sleep(5)
        
        print("ğŸ”§ Arka plan data gÃ¼ncelleme thread'i durdu")
    
    def get_cached_market_data(self, ticker):
        """Cache'den market data al (3 saniyeden eski deÄŸilse)"""
        if ticker in self.background_data_cache:
            cache_entry = self.background_data_cache[ticker]
            age = time.time() - cache_entry['timestamp']
            if age < 3:  # 3 saniyeden yeni ise
                return cache_entry['market_data']
        
        # Cache'de yoksa veya eskiyse normal yoldan al
        if hasattr(self, 'hammer') and self.hammer.connected:
            return self.hammer.get_market_data(ticker)
        return None

    def scan_all_pages_for_scores(self):
        """
        TÃ¼m grup dosyalarÄ±nÄ±n tÃ¼m sayfalarÄ±nÄ± tarayarak skorlarÄ± hesapla.
        Bu sayede TUMCSV ayarlamasÄ± yapÄ±lÄ±rken gerÃ§ek skorlar kullanÄ±labilir.
        Thread kullanarak UI'Ä± donmadan Ã§alÄ±ÅŸÄ±r.
        """
        try:
            # Thread'de Ã§alÄ±ÅŸtÄ±r
            import threading
            def scan_thread():
                try:
                    print("ğŸš€ TÃœM SAYFALAR TARANACAK - SKORLAR HESAPLANACAK!")
                    print("=" * 80)
                    
                    # Hammer Pro baÄŸlantÄ±sÄ±nÄ± kontrol et
                    if not hasattr(self, 'hammer') or not self.hammer.connected:
                        self.after(0, lambda: messagebox.showwarning("UyarÄ±", "Ã–nce Hammer Pro'ya baÄŸlanÄ±n!"))
                        return
                        
                    # Live data'nÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin ol
                    if not hasattr(self, 'live_data_running') or not self.live_data_running:
                        self.after(0, lambda: messagebox.showwarning("UyarÄ±", "Ã–nce Live Data'yÄ± baÅŸlatÄ±n!"))
                        return
                    
                    # CSV dosya listesi (grup butonlarÄ±ndaki dosyalar)
                    csv_files = [
                        'janek_ssfinekheldcilizyeniyedi.csv',
                        'janek_ssfinekheldcommonsuz.csv', 
                        'janek_ssfinekhelddeznff.csv',
                        'janek_ssfinekheldff.csv',
                        'janek_ssfinekheldflr.csv',
                        'janek_ssfinekheldgarabetaltiyedi.csv',
                        'janek_ssfinekheldkuponlu.csv',
                        'janek_ssfinekheldkuponlukreciliz.csv',
                        'janek_ssfinekheldkuponlukreorta.csv',
                        'janek_ssfinekheldnff.csv',
                        'janek_ssfinekheldotelremorta.csv',
                        'janek_ssfinekheldsolidbig.csv',
                        'janek_ssfinekheldtitrekhc.csv',
                        'janek_ssfinekhighmatur.csv',
                        'janek_ssfineknotbesmaturlu.csv',
                        'janek_ssfineknotcefilliquid.csv',
                        'janek_ssfineknottitrekhc.csv',
                        'janek_ssfinekrumoreddanger.csv',
                        'janek_ssfineksalakilliquid.csv',
                        'janek_ssfinekshitremhc.csv'
                    ]
                    
                    progress_msg = f"Toplam {len(csv_files)} grup dosyasÄ± taranacak..."
                    print(f"ğŸ“‹ {progress_msg}")
                    
                    # Mevcut durumu kaydet
                    original_df = self.df.copy() if hasattr(self, 'df') else None
                    original_page = self.current_page
                    original_tickers = self.tickers.copy() if hasattr(self, 'tickers') else []
                    
                    total_stocks_scanned = 0
                    total_scores_calculated = 0
                    
                    # Her grup dosyasÄ±nÄ± tara
                    for file_idx, file_name in enumerate(csv_files):
                        if not os.path.exists(file_name):
                            print(f"âš ï¸ {file_name} bulunamadÄ±, atlanÄ±yor")
                            continue
                            
                        print(f"\nğŸ“Š [{file_idx+1}/{len(csv_files)}] Ä°ÅŸleniyor: {file_name}")
                        
                        try:
                            # DosyayÄ± geÃ§ici olarak yÃ¼kle (gÃ¶rÃ¼nÃ¼r hale getirmeden)
                            temp_df = pd.read_csv(file_name)
                            print(f"   âœ… Dosya okundu: {len(temp_df)} hisse")
                            
                            if len(temp_df) == 0:
                                print(f"   âš ï¸ Dosya boÅŸ, atlanÄ±yor")
                                continue
                            
                            # GeÃ§ici olarak bu dosyayÄ± ana dosya yap (skorlarÄ± hesaplayabilmek iÃ§in)
                            self.df = temp_df
                            self.tickers = temp_df['PREF IBKR'].tolist()
                            
                            # Sayfa sayÄ±sÄ±nÄ± hesapla 
                            self.total_pages = max(1, (len(self.tickers) + self.items_per_page - 1) // self.items_per_page)
                            
                            print(f"   ğŸ“„ Toplam {self.total_pages} sayfa taranacak")
                            
                            # TÃ¼m sayfalarÄ± tara
                            for page in range(self.total_pages):
                                self.current_page = page
                                visible_tickers = self.get_visible_tickers()
                                
                                print(f"   ğŸ“„ Sayfa {page+1}/{self.total_pages}: {len(visible_tickers)} hisse")
                                
                                # Bu sayfadaki her hisse iÃ§in skorlarÄ± hesapla
                                for ticker in visible_tickers:
                                    total_stocks_scanned += 1
                                    
                                    try:
                                        # CSV'den bu hissenin verilerini al
                                        row_data = temp_df[temp_df['PREF IBKR'] == ticker]
                                        if row_data.empty:
                                            continue
                                            
                                        row = row_data.iloc[0]
                                        
                                        # Market data al (live)
                                        market_data = self.hammer.get_market_data(ticker)
                                        if market_data:
                                            bid_raw = float(market_data.get('bid', 0))
                                            ask_raw = float(market_data.get('ask', 0))
                                            last_raw = float(market_data.get('last', 0))
                                            prev_close = float(market_data.get('prevClose', 0))
                                            
                                            # Benchmark deÄŸiÅŸimini hesapla
                                            benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                                            
                                            # SkorlarÄ± hesapla
                                            scores = self.calculate_scores(ticker, row, bid_raw, ask_raw, last_raw, prev_close, benchmark_chg)
                                            
                                            if scores:
                                                total_scores_calculated += 1
                                                
                                                # DataFrame'e skorlarÄ± kaydet
                                                idx = temp_df[temp_df['PREF IBKR'] == ticker].index[0]
                                                for score_name, score_value in scores.items():
                                                    temp_df.at[idx, score_name] = score_value
                                                
                                                # Ä°lk 3 hisse iÃ§in debug bilgisi
                                                if total_scores_calculated <= 3:
                                                    final_fb = scores.get('Final_FB_skor', 'N/A')
                                                    final_sfs = scores.get('Final_SFS_skor', 'N/A')
                                                    print(f"      âœ… {ticker}: Final_FB_skor={final_fb:.2f}, Final_SFS_skor={final_sfs:.2f}")
                                            
                                        else:
                                            print(f"      âš ï¸ {ticker}: Market data alÄ±namadÄ±")
                                            
                                    except Exception as e:
                                        print(f"      âŒ {ticker} iÃ§in skor hesaplama hatasÄ±: {e}")
                                        continue
                                
                                # Her 5 sayfada bir ilerleme bilgisi
                                if (page + 1) % 5 == 0:
                                    print(f"   ğŸ”„ Ä°lerleme: {page+1}/{self.total_pages} sayfa tamamlandÄ±")
                            
                            # Bu dosyanÄ±n gÃ¼ncellenmiÅŸ halini kaydet (skorlarla birlikte)
                            temp_df.to_csv(file_name, index=False)
                            print(f"   ğŸ’¾ {file_name} skorlarla gÃ¼ncellendi")
                            
                        except Exception as e:
                            print(f"   âŒ {file_name} iÅŸlenirken hata: {e}")
                            continue
                    
                    # Orijinal durumu geri yÃ¼kle
                    if original_df is not None:
                        self.df = original_df
                        self.tickers = original_tickers
                        self.current_page = original_page
                        self.total_pages = max(1, (len(self.tickers) + self.items_per_page - 1) // self.items_per_page)
                        self.after(0, self.update_table)
                    
                    # SonuÃ§ mesajÄ±
                    result_msg = f"âœ… Tarama tamamlandÄ±!\n\nToplam {total_stocks_scanned} hisse taranÄ±\n{total_scores_calculated} skor hesaplandÄ±"
                    print(f"\n{result_msg}")
                    self.after(0, lambda: messagebox.showinfo("BaÅŸarÄ±lÄ±", result_msg))
                    
                except Exception as e:
                    error_msg = f"Tarama sÄ±rasÄ±nda hata: {e}"
                    print(f"âŒ {error_msg}")
                    self.after(0, lambda: messagebox.showerror("Hata", error_msg))
            
            # Thread'i baÅŸlat
            thread = threading.Thread(target=scan_thread, daemon=True)
            thread.start()
            
        except Exception as e:
            print(f"âŒ Tarama baÅŸlatma hatasÄ±: {e}")
            messagebox.showerror("Hata", f"Tarama baÅŸlatÄ±lamadÄ±: {e}")

    def get_avg_adv_from_csv(self, symbol):
        """CSV'den AVG_ADV deÄŸerini al"""
        try:
            # CSV dosyalarÄ±ndan AVG_ADV deÄŸerini bul
            import glob
            import pandas as pd
            
            # TÃ¼m ssfinek CSV dosyalarÄ±nÄ± bul
            csv_files = glob.glob('ssfinek*.csv')
            
            for csv_file in csv_files:
                try:
                    # DosyayÄ± oku
                    df = pd.read_csv(csv_file, encoding='utf-8-sig')
                    
                    # PREF IBKR ve AVG_ADV kolonlarÄ± var mÄ± kontrol et
                    if 'PREF IBKR' in df.columns and 'AVG_ADV' in df.columns:
                        # Symbol'Ã¼ bul
                        row = df[df['PREF IBKR'] == symbol]
                        if not row.empty:
                            avg_adv = row['AVG_ADV'].iloc[0]
                            if pd.notna(avg_adv) and avg_adv != 'N/A':
                                return float(avg_adv)
                except Exception as e:
                    continue
            
            return 0.0
        except:
            return 0.0
    
    def show_stock_data_status(self):
        """Stock Data Manager durumunu gÃ¶ster"""
        try:
            if not hasattr(self, 'stock_data_manager') or not self.stock_data_manager:
                messagebox.showinfo("Durum", "Stock Data Manager henÃ¼z baÅŸlatÄ±lmamÄ±ÅŸ!")
                return
            
            # Durum Ã¶zetini al
            summary = self.stock_data_manager.get_data_summary()
            
            if summary:
                status_text = f"""Stock Data Manager Durumu:

ğŸ“Š Toplam Hisse: {summary.get('total_stocks', 0)}
âœ… GeÃ§erli Veri: {summary.get('valid_stocks', 0)}
â° SÃ¼resi DolmuÅŸ: {summary.get('expired_stocks', 0)}
ğŸ“ CSV DosyalarÄ±: {', '.join(summary.get('csv_files', []))}
ğŸ• Son GÃ¼ncelleme: {time.strftime('%H:%M:%S', time.localtime(summary.get('last_update', 0)))}

ğŸ’¡ Ã–rnek KullanÄ±m:
â€¢ Port Adjuster'da "Hisse Veri Ã‡ek" butonuna tÄ±klayÄ±n
â€¢ Hisse sembolÃ¼ girin (Ã¶rn: CFG PRE) ve "Ara" butonuna tÄ±klayÄ±n
â€¢ Final_FB_skor, Final_SFS_skor gibi verileri gÃ¶rebilirsiniz"""
                
                messagebox.showinfo("Stock Data Manager Durumu", status_text)
            else:
                messagebox.showinfo("Durum", "Durum bilgisi alÄ±namadÄ±!")
                
        except Exception as e:
            messagebox.showerror("Hata", f"Durum gÃ¶sterilirken hata: {e}")
            print(f"[STOCK_DATA_STATUS] âŒ Hata: {e}")
    
    # SNAPSHOT FONKSÄ°YONLARI KALDIRILDI - ArtÄ±k sadece L1 streaming kullanÄ±yoruz!
    
    def check_daily_befham(self):
        """GÃ¼nlÃ¼k befham.csv kontrolÃ¼ - Sadece 00:00-16:30 arasÄ±, gÃ¼nde 1 kez"""
        try:
            # Zaman penceresi: 00:00 - 16:30 (Yerel saat)
            now = datetime.now()
            window_end = now.replace(hour=16, minute=30, second=0, microsecond=0)

            # 16:30 - 23:59 arasÄ±nda asla Ã§alÄ±ÅŸtÄ±rma
            if now >= window_end:
                return

            # Mevcut befham.csv dosyasÄ±nÄ± kontrol et
            befpos_file = "befham.csv"
            
            # EÄŸer bugÃ¼n iÃ§in befpos dosyasÄ± varsa, tekrar Ã§alÄ±ÅŸtÄ±rma
            if os.path.exists(befpos_file):
                try:
                    mtime = datetime.fromtimestamp(os.path.getmtime(befpos_file))
                    if mtime.date() == now.date():
                        print(f"[BEFHAM] OK bugun icin mevcut: {befpos_file}")
                        self.befham_checked_today = True
                        return
                except Exception:
                    pass
            
            # Hammer Pro baÄŸlantÄ±sÄ± kontrolÃ¼
            if not self.hammer or not getattr(self.hammer, 'connected', False):
                print(f"[BEFHAM] WARN Hammer Pro baglantisi yok, befham.csv calistirilamadi")
                return
            
            print(f"[BEFHAM] OK befham.csv calistiriliyor...")
            
            # befham.csv Ã§alÄ±ÅŸtÄ±r
            self.run_befpos_csv()
            self.befham_checked_today = True
            
        except Exception as e:
            print(f"[BEFHAM] ERROR Gunluk kontrol hatasi: {e}")
    
    def run_befpos_csv(self):
        """befham.csv dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±r ve pozisyonlarÄ± kaydet"""
        try:
            # Hammer Pro'dan pozisyonlarÄ± al
            positions = self.hammer.get_positions_direct()
            if not positions:
                print("[BEFHAM] WARN Pozisyon verisi alinmadi")
                return
            
            # Pozisyon verilerini DataFrame'e Ã§evir
            position_data = []
            for pos in positions:
                symbol = pos.get('symbol', '')
                qty = pos.get('qty', None)
                if qty is None:
                    qty = pos.get('quantity', 0)
                avg_price = pos.get('avg_cost', None)
                if avg_price is None:
                    avg_price = pos.get('average_price', 0.0)
                market_value = pos.get('market_value', None)
                if market_value is None:
                    try:
                        market_value = float(qty) * float(avg_price)
                    except Exception:
                        market_value = 0.0
                unreal = pos.get('unrealized_pnl', 0.0)
                realized = pos.get('realized_pnl', 0.0)
                position_data.append({
                    'Symbol': symbol,
                    'Quantity': qty,
                    'AveragePrice': avg_price,
                    'MarketValue': market_value,
                    'UnrealizedPnL': unreal,
                    'RealizedPnL': realized,
                    'Timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                })
            
            # DataFrame oluÅŸtur
            df = pd.DataFrame(position_data)
            
            # Dosya adÄ±
            filename = "befham.csv"
            
            # CSV'ye kaydet
            df.to_csv(filename, index=False)
            print(f"[BEFHAM] OK Pozisyonlar kaydedildi: {filename} ({len(position_data)} pozisyon)")
            
        except Exception as e:
            print(f"[BEFHAM] ERROR befham.csv calistirma hatasi: {e}")

    def check_daily_befib(self):
        """GÃ¼nlÃ¼k befibgun.csv veya befibped.csv kontrolÃ¼ - Sadece 00:00-16:30 arasÄ±, gÃ¼nde 1 kez"""
        try:
            now = datetime.now()
            window_end = now.replace(hour=16, minute=30, second=0, microsecond=0)
            if now >= window_end:
                return
            
            # Aktif modu kontrol et
            active_account = self.mode_manager.get_active_account()
            if active_account == "IBKR_GUN":
                befib_file = "befibgun.csv"
            elif active_account == "IBKR_PED":
                befib_file = "befibped.csv"
            else:
                return  # IBKR modu deÄŸilse Ã§alÄ±ÅŸtÄ±rma
            
            if os.path.exists(befib_file):
                try:
                    mtime = datetime.fromtimestamp(os.path.getmtime(befib_file))
                    if mtime.date() == now.date():
                        print(f"[BEFIB] OK bugun icin mevcut: {befib_file}")
                        # Mod bazlÄ± flag'i gÃ¼ncelle
                        if active_account == "IBKR_GUN":
                            self.befibgun_checked_today = True
                        elif active_account == "IBKR_PED":
                            self.befibped_checked_today = True
                        return
                except Exception:
                    pass
            # IBKR baÄŸlantÄ±sÄ± kontrolÃ¼ (native veya ib_insync)
            ib_connected = False
            try:
                ib_connected = self.ibkr_native.is_connected() or self.ibkr.is_connected()
            except Exception:
                ib_connected = False
            if not ib_connected:
                print(f"[BEFIB] WARN IBKR baglantisi yok, {befib_file} calistirilamadi")
                return
            print(f"[BEFIB] OK {befib_file} calistiriliyor...")
            self.run_befib_csv()
            # Mod bazlÄ± flag'i gÃ¼ncelle
            if active_account == "IBKR_GUN":
                self.befibgun_checked_today = True
            elif active_account == "IBKR_PED":
                self.befibped_checked_today = True
        except Exception as e:
            print(f"[BEFIB] ERROR Gunluk kontrol hatasi: {e}")

    def run_befib_csv(self):
        """befibgun.csv veya befibped.csv dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±r ve IBKR pozisyonlarÄ±nÄ± kaydet"""
        try:
            # Aktif modu kontrol et
            active_account = self.mode_manager.get_active_account()
            if active_account == "IBKR_GUN":
                filename = "befibgun.csv"
            elif active_account == "IBKR_PED":
                filename = "befibped.csv"
            else:
                print(f"[BEFIB] WARN Aktif mod IBKR deÄŸil: {active_account}")
                return
            
            # IBKR'den pozisyonlarÄ± al (Ã¶ncelik: native)
            positions = []
            try:
                if self.ibkr_native.is_connected():
                    positions = self.ibkr_native.get_positions()
            except Exception:
                positions = []
            if not positions:
                try:
                    if self.ibkr.is_connected():
                        positions = self.ibkr.get_positions()
                except Exception:
                    positions = []
            if not positions:
                print(f"[BEFIB] WARN Pozisyon verisi alinmadi")
                return
            position_data = []
            for pos in positions:
                symbol = pos.get('symbol', '')
                qty = pos.get('qty', None)
                if qty is None:
                    qty = pos.get('quantity', 0)
                avg_cost = pos.get('avg_cost', None)
                if avg_cost is None:
                    avg_cost = pos.get('average_price', 0.0)
                market_price = pos.get('market_price', None)
                market_value = pos.get('market_value', None)
                if market_value is None:
                    try:
                        price = market_price if market_price not in (None, 0) else avg_cost
                        market_value = float(qty) * float(price)
                    except Exception:
                        market_value = 0.0
                unreal = pos.get('unrealized_pnl', pos.get('unrealizedPnL', 0.0))
                realized = pos.get('realized_pnl', pos.get('realizedPnL', 0.0))
                position_data.append({
                    'Symbol': symbol,
                    'Quantity': qty,
                    'AveragePrice': avg_cost,
                    'MarketValue': market_value,
                    'UnrealizedPnL': unreal,
                    'RealizedPnL': realized,
                    'Timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                })
            df = pd.DataFrame(position_data)
            df.to_csv(filename, index=False)
            print(f"[BEFIB] OK Pozisyonlar kaydedildi: {filename} ({len(position_data)} pozisyon)")
        except Exception as e:
            print(f"[BEFIB] ERROR befib csv calistirma hatasi: {e}")
    
    def start_psfalgo_robot(self):
        """Psfalgo robotunu baÅŸlat"""
        try:
            print("[PSFALGO] ğŸ¤– Robot baÅŸlatÄ±lÄ±yor...")
            
            # EÄŸer pencere zaten aÃ§Ä±ksa, Ã¶nce kapat
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        self.psfalgo_window.destroy()
                except:
                    pass
            
            # Robot penceresi oluÅŸtur
            self.psfalgo_window = tk.Toplevel(self)
            self.psfalgo_window.title("Psfalgo Robot - Pozisyon YÃ¶netimi")
            self.psfalgo_window.geometry("1000x700")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            # Minimize butonu ekle (baÅŸlÄ±k Ã§ubuÄŸuna)
            self.psfalgo_window.attributes('-toolwindow', False)  # Minimize butonunu gÃ¶ster
            
            # Pencere kapatÄ±ldÄ±ÄŸÄ±nda temizlik yap
            def on_closing():
                self.psfalgo_running = False
                self.psfalgo_window.destroy()
                self.psfalgo_window = None
            
            self.psfalgo_window.protocol("WM_DELETE_WINDOW", on_closing)
            
            # Pencereyi Ã¶ne getirme fonksiyonu
            def bring_to_front():
                """Pencereyi zorla Ã¶ne getir - bot Ã§alÄ±ÅŸÄ±rken bile Ã§alÄ±ÅŸÄ±r"""
                try:
                    if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                        if self.psfalgo_window.winfo_exists():
                            # Ã–nce topmost yap (en Ã¼ste getir) - UI thread'ini bloklamadan
                            self.psfalgo_window.attributes('-topmost', True)
                            # Pencereyi Ã¶ne getir
                            self.psfalgo_window.lift()
                            # Ana pencereyi de gÃ¼ncelle (UI thread'i bloklamasÄ±n)
                            self.update_idletasks()
                            # Odaklan
                            self.psfalgo_window.focus_force()
                            # update_idletasks ile UI'Ä± gÃ¼ncelle
                            self.psfalgo_window.update_idletasks()
                            # 100ms sonra topmost'u kaldÄ±r (normal moda dÃ¶ndÃ¼r)
                            self.psfalgo_window.after(100, lambda: self.psfalgo_window.attributes('-topmost', False))
                            print("[PSFALGO] âœ… Pencere Ã¶ne getirildi")
                except Exception as e:
                    print(f"[PSFALGO] âš ï¸ Pencere Ã¶ne getirme hatasÄ±: {e}")
            
            self.bring_psfalgo_window_to_front = bring_to_front
            
            # Pencere event'lerine tÄ±klama kontrolÃ¼ ekle - kullanÄ±cÄ± pencereye tÄ±kladÄ±ÄŸÄ±nda Ã¶ne getir
            def on_window_click(event):
                """Pencereye tÄ±klandÄ±ÄŸÄ±nda Ã¶ne getir - HEMEN Ã§alÄ±ÅŸÄ±r"""
                try:
                    # Hemen Ã¶ne getir (UI thread'ini bloklamadan) - TOPMOST ile zorla
                    self.psfalgo_window.attributes('-topmost', True)
                    self.psfalgo_window.lift()
                    self.psfalgo_window.focus_force()
                    # update_idletasks'i ayrÄ± bir after() ile Ã§aÄŸÄ±r (bloklamasÄ±n)
                    self.psfalgo_window.after_idle(lambda: self.psfalgo_window.update_idletasks())
                    # 100ms sonra topmost'u kaldÄ±r (normal moda dÃ¶ndÃ¼r)
                    self.psfalgo_window.after(100, lambda: self.psfalgo_window.attributes('-topmost', False))
                except:
                    pass
            
            # Pencere tÄ±klama event'lerini dinle
            self.psfalgo_window.bind('<Button-1>', on_window_click)
            self.psfalgo_window.bind('<Button-3>', on_window_click)  # SaÄŸ tÄ±k da
            self.psfalgo_window.bind('<FocusIn>', lambda e: (self.psfalgo_window.attributes('-topmost', True), self.psfalgo_window.lift(), self.psfalgo_window.focus_force(), self.psfalgo_window.after(100, lambda: self.psfalgo_window.attributes('-topmost', False))))
            self.psfalgo_window.bind('<Map>', lambda e: self.psfalgo_window.lift())  # Pencere gÃ¶rÃ¼nÃ¼r olduÄŸunda
            self.psfalgo_window.bind('<Enter>', lambda e: self.psfalgo_window.lift())  # Mouse pencereye girdiÄŸinde
            
            # SÃœREKLI Ã‡ALIÅAN PENCERE Ã–NE GETÄ°RME - Her 1 saniyede bir pencereyi Ã¶ne getir (bot Ã§alÄ±ÅŸÄ±rken bile)
            def force_window_to_front():
                """SÃ¼rekli Ã§alÄ±ÅŸan pencere Ã¶ne getirme - bot Ã§alÄ±ÅŸÄ±rken bile pencereye tÄ±klanabilir"""
                try:
                    if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                        if self.psfalgo_window.winfo_exists():
                            try:
                                # Pencere gÃ¶rÃ¼nÃ¼r mÃ¼ kontrol et
                                if self.psfalgo_window.winfo_viewable():
                                    # Pencereyi sÃ¼rekli Ã¶ne getir (ama topmost yapma - sadece lift)
                                    self.psfalgo_window.lift()
                                    # Ana pencereyi de gÃ¼ncelle
                                    self.update_idletasks()
                            except:
                                pass
                except:
                    pass
                finally:
                    # Her 1 saniyede bir kontrol et (bot Ã§alÄ±ÅŸÄ±rken bile pencereye tÄ±klanabilir)
                    if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                        if self.psfalgo_window.winfo_exists():
                            self.psfalgo_window.after(1000, force_window_to_front)
            
            # SÃ¼rekli Ã§alÄ±ÅŸan mekanizmayÄ± baÅŸlat
            self.psfalgo_window.after(1000, force_window_to_front)
            
            # Ana pencereye de klavye kÄ±sayolu ekle (psfalgo_window aÃ§Ä±kken)
            def bring_psfalgo_to_front(event=None):
                if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                    if self.psfalgo_window.winfo_exists():
                        bring_to_front()
                return "break"  # Event propagation'Ä± durdur
            
            self.bind('<Control-f>', bring_psfalgo_to_front)
            self.bind('<F5>', bring_psfalgo_to_front)
            
            # Robot durumu
            self.psfalgo_running = False
            self.psfalgo_positions = {}  # Pozisyon takibi
            self.psfalgo_trades = {}     # Trade takibi (3 saatlik kontrol iÃ§in)
            self.controller_enabled = False  # Controller modu (ON/OFF)
            self.excluded_tickers = set()  # Excluded ticker'lar (RUNALL ve diÄŸer fonksiyonlar iÃ§in)
            self.runall_allowed_mode = False  # RUNALL Allowed modu (otomatik onay)
            self.runall_loop_running = False  # RUNALL dÃ¶ngÃ¼sÃ¼ Ã§alÄ±ÅŸÄ±yor mu
            self.runall_loop_count = 0  # RUNALL dÃ¶ngÃ¼ sayacÄ±
            
            # Benchmark shift deÄŸeri (General BM Shifter iÃ§in)
            # CSV'den yÃ¼kle, yoksa 0.0 default
            self.load_benchmark_shift_from_csv()
            
            # Excluded ticker'larÄ± CSV'den yÃ¼kle
            self.load_excluded_tickers_from_csv()
            
            # KurallarÄ± CSV'den yÃ¼kle (varsayÄ±lan deÄŸerler)
            self.rule_max_change_multiplier = 0.75  # MAXALW * bu deÄŸer = Max Change
            self.rule_single_max_position_multiplier = 1.0  # MAXALW * bu deÄŸer = Tek pozisyon limiti
            self.rule_avg_adv_divisor = 10  # AVG_ADV / bu deÄŸer = MAXALW
            self.rule_min_lot = 400  # Minimum lot deÄŸeri
            
            # ADDNEWPOS KurallarÄ± (Pozisyon ArtÄ±rma)
            # Format: {eÅŸik_yÃ¼zdesi: (maxalw_carpani, portfoy_yuzde_limiti)}
            self.addnewpos_rules = {
                1: (0.50, 5.0),    # < %1: MAXALWÃ—0.50, PortfÃ¶yÃ—%5
                3: (0.40, 4.0),    # %1-2.99: MAXALWÃ—0.40, PortfÃ¶yÃ—%4
                5: (0.30, 3.0),    # %3-4.99: MAXALWÃ—0.30, PortfÃ¶yÃ—%3
                7: (0.20, 2.0),    # %5-6.99: MAXALWÃ—0.20, PortfÃ¶yÃ—%2
                10: (0.10, 1.5),   # %7-9.99: MAXALWÃ—0.10, PortfÃ¶yÃ—%1.5
                100: (0.05, 1.0)   # >= %10: MAXALWÃ—0.05, PortfÃ¶yÃ—%1
            }
            
            # ADDNEWPOS Exposure Limit AyarÄ± (Kalan exposure'a gÃ¶re lot ayarlama yÃ¼zdesi)
            # Default: %60 (0-100 arasÄ± ayarlanabilir)
            # %100 = Eski hali (tam exposure doldurur)
            # %60 = Kalan exposure'Ä±n %60'Ä±nÄ± kullanÄ±r
            self.addnewpos_exposure_percentage = 60
            
            # KARBOTU/REDUCEMORE KurallarÄ± (Pozisyon Azaltma)
            # Format: {eÅŸik_yÃ¼zdesi: (maxalw_carpani, befday_carpani)}
            # None = sÄ±nÄ±rsÄ±z
            self.reduce_rules = {
                3: (None, None),    # < %3: SÄ±nÄ±rsÄ±z (ama ters poz. yasak)
                5: (0.75, 0.75),    # %3-4.99: MAXALWÃ—0.75, BefQtyÃ—0.75
                7: (0.60, 0.60),    # %5-6.99: MAXALWÃ—0.60, BefQtyÃ—0.60
                10: (0.50, 0.50),   # %7-9.99: MAXALWÃ—0.50, BefQtyÃ—0.50
                100: (0.40, 0.40)   # >= %10: MAXALWÃ—0.40, BefQtyÃ—0.40
            }
            
            self.load_rules_from_csv()
            
            # Emir cache'i (60 saniyede bir gÃ¼ncellenecek)
            import time
            self.orders_cache = []
            self.orders_cache_time = time.time() - 61  # Ä°lk Ã§aÄŸrÄ±da hemen gÃ¼ncellensin
            self.orders_cache_interval = 10  # 10 saniye (60'tan 10'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ - daha sÄ±k gÃ¼ncelleme)
            
            # Pozisyonlar iÃ§in cache
            self.positions_cache = {}  # {account: positions_list}
            self.positions_cache_time = {}  # {account: timestamp}
            
            # GORT hesaplamalarÄ± iÃ§in cache (grup dosyalarÄ± ve ortalamalar)
            self.gort_cache = {}  # {symbol: gort_value}
            self.group_avg_cache = {}  # {(group, cgrup, 'sma63' or 'sma246'): avg_value}
            self.group_file_cache = {}  # {group: DataFrame} - Grup dosyalarÄ±nÄ± cache'le
            self.gort_cache_time = time.time() - 61  # Ä°lk Ã§aÄŸrÄ±da hemen gÃ¼ncellensin
            self.gort_cache_interval = 300  # 5 dakika (300 saniye) - Grup dosyalarÄ± nadiren deÄŸiÅŸir
            
            self.setup_psfalgo_ui()
            
            # JFIN filtrelerini CSV'den yÃ¼kle (UI oluÅŸturulduktan sonra)
            self.load_psfalgo_filters_from_csv()
            
            # Ä°lk cache gÃ¼ncellemesini yap (asenkron olarak)
            self.psfalgo_window.after(1000, self.get_cached_orders)  # 1 saniye sonra ilk gÃ¼ncelleme
            
        except Exception as e:
            print(f"[PSFALGO] âŒ Robot baÅŸlatma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Psfalgo robot baÅŸlatÄ±lamadÄ±: {e}")
    
    def setup_psfalgo_ui(self):
        """Psfalgo robot UI'Ä±nÄ± oluÅŸtur"""
        # BaÅŸlÄ±k ve kontrol butonlarÄ± frame
        title_frame = ttk.Frame(self.psfalgo_window)
        title_frame.pack(fill='x', padx=10, pady=5)
        
        # BaÅŸlÄ±k
        title_label = ttk.Label(title_frame, text="Psfalgo Robot - Pozisyon YÃ¶netimi", 
                               font=("Arial", 14, "bold"))
        title_label.pack(side='left')
        
        # SaÄŸ Ã¼st frame (filtreler ve kontroller iÃ§in)
        right_top_frame = ttk.Frame(title_frame)
        right_top_frame.pack(side='right')
        
        # JFIN Filtreleri Ã§erÃ§evesi (saÄŸ Ã¼ste, kompakt)
        filters_frame = ttk.LabelFrame(right_top_frame, text="ğŸ” JFIN Filtreleri", padding=5)
        filters_frame.pack(side='left', padx=5)
        
        # Long Filters (BB ve FB iÃ§in) - kompakt tek satÄ±r
        long_filters_frame = ttk.Frame(filters_frame)
        long_filters_frame.pack(fill='x', padx=2, pady=2)
        
        ttk.Label(long_filters_frame, text="Long:", font=("Arial", 8, "bold")).pack(side='left', padx=2)
        # Long SMA63 Chg
        ttk.Label(long_filters_frame, text="SMA:", font=("Arial", 7)).pack(side='left', padx=1)
        self.long_sma_filter_var = tk.StringVar(value="-1.6")
        self.long_sma_filter_entry = ttk.Entry(long_filters_frame, textvariable=self.long_sma_filter_var, width=6)
        self.long_sma_filter_entry.pack(side='left', padx=1)
        self.long_sma_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(long_filters_frame, text="<", variable=self.long_sma_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(long_filters_frame, text=">", variable=self.long_sma_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Long FBtot
        ttk.Label(long_filters_frame, text="FBtot:", font=("Arial", 7)).pack(side='left', padx=1)
        self.long_fbtot_filter_var = tk.StringVar(value="")
        self.long_fbtot_filter_entry = ttk.Entry(long_filters_frame, textvariable=self.long_fbtot_filter_var, width=6)
        self.long_fbtot_filter_entry.pack(side='left', padx=1)
        self.long_fbtot_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(long_filters_frame, text="<", variable=self.long_fbtot_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(long_filters_frame, text=">", variable=self.long_fbtot_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Long Gort
        ttk.Label(long_filters_frame, text="Gort:", font=("Arial", 7)).pack(side='left', padx=1)
        self.long_gort_filter_var = tk.StringVar(value="")
        self.long_gort_filter_entry = ttk.Entry(long_filters_frame, textvariable=self.long_gort_filter_var, width=6)
        self.long_gort_filter_entry.pack(side='left', padx=1)
        self.long_gort_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(long_filters_frame, text="<", variable=self.long_gort_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(long_filters_frame, text=">", variable=self.long_gort_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Short Filters (SAS ve SFS iÃ§in) - kompakt tek satÄ±r
        short_filters_frame = ttk.Frame(filters_frame)
        short_filters_frame.pack(fill='x', padx=2, pady=2)
        
        ttk.Label(short_filters_frame, text="Short:", font=("Arial", 8, "bold")).pack(side='left', padx=2)
        # Short SMA63 Chg
        ttk.Label(short_filters_frame, text="SMA:", font=("Arial", 7)).pack(side='left', padx=1)
        self.short_sma_filter_var = tk.StringVar(value="")
        self.short_sma_filter_entry = ttk.Entry(short_filters_frame, textvariable=self.short_sma_filter_var, width=6)
        self.short_sma_filter_entry.pack(side='left', padx=1)
        self.short_sma_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(short_filters_frame, text="<", variable=self.short_sma_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(short_filters_frame, text=">", variable=self.short_sma_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Short SFStot
        ttk.Label(short_filters_frame, text="SFStot:", font=("Arial", 7)).pack(side='left', padx=1)
        self.short_sfstot_filter_var = tk.StringVar(value="")
        self.short_sfstot_filter_entry = ttk.Entry(short_filters_frame, textvariable=self.short_sfstot_filter_var, width=6)
        self.short_sfstot_filter_entry.pack(side='left', padx=1)
        self.short_sfstot_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(short_filters_frame, text="<", variable=self.short_sfstot_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(short_filters_frame, text=">", variable=self.short_sfstot_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Short Gort
        ttk.Label(short_filters_frame, text="Gort:", font=("Arial", 7)).pack(side='left', padx=1)
        self.short_gort_filter_var = tk.StringVar(value="")
        self.short_gort_filter_entry = ttk.Entry(short_filters_frame, textvariable=self.short_gort_filter_var, width=6)
        self.short_gort_filter_entry.pack(side='left', padx=1)
        self.short_gort_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(short_filters_frame, text="<", variable=self.short_gort_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(short_filters_frame, text=">", variable=self.short_gort_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Filtreleri Kaydet butonu
        save_filters_btn = ttk.Button(filters_frame, text="ğŸ’¾ Kaydet", width=8,
                                     command=self.show_save_filters_dialog)
        save_filters_btn.pack(side='left', padx=5, pady=2)
        
        # Pencere kontrol butonlarÄ± (saÄŸ Ã¼st)
        window_controls = ttk.Frame(right_top_frame)
        window_controls.pack(side='left', padx=5)
        
        # Ã–ne Getir butonu (bot Ã§alÄ±ÅŸÄ±rken pencereyi Ã¶ne almak iÃ§in)
        bring_to_front_btn = ttk.Button(window_controls, text="â¬†ï¸ Ã–ne Getir", width=12,
                                        command=self.bring_psfalgo_window_to_front)
        bring_to_front_btn.pack(side='left', padx=2)
        
        # Alta Al (Minimize) butonu
        minimize_btn = ttk.Button(window_controls, text="ğŸ—• Alta Al", width=10,
                                  command=lambda: self.psfalgo_window.iconify())
        minimize_btn.pack(side='left', padx=2)
        
        # Klavye kÄ±sayolu: Ctrl+F veya F5 ile pencereyi Ã¶ne getir
        self.psfalgo_window.bind('<Control-f>', lambda e: self.bring_psfalgo_window_to_front())
        self.psfalgo_window.bind('<F5>', lambda e: self.bring_psfalgo_window_to_front())
        self.psfalgo_window.bind('<Control-F>', lambda e: self.bring_psfalgo_window_to_front())
        
        # Exposure ayarlarÄ± Ã§erÃ§evesi
        exposure_frame = ttk.LabelFrame(self.psfalgo_window, text="ğŸ’° Exposure AyarlarÄ±", padding=10)
        exposure_frame.pack(fill='x', padx=10, pady=5)
        
        # Exposure limit input
        ttk.Label(exposure_frame, text="Exposure Limit ($):").grid(row=0, column=0, padx=5, pady=5, sticky='w')
        self.exposure_limit_var = tk.StringVar(value="1200000")  # Default 1.2M
        ttk.Entry(exposure_frame, textvariable=self.exposure_limit_var, width=15).grid(row=0, column=1, padx=5, pady=5, sticky='w')
        
        # Ortalama hisse fiyatÄ±
        ttk.Label(exposure_frame, text="Ortalama Hisse FiyatÄ± ($):").grid(row=0, column=2, padx=5, pady=5, sticky='w')
        self.avg_price_var = tk.StringVar(value="22")  # Default 22
        ttk.Entry(exposure_frame, textvariable=self.avg_price_var, width=10).grid(row=0, column=3, padx=5, pady=5, sticky='w')
        
        # Butonlar iÃ§in yeni frame (Ortalama Hisse FiyatÄ±'nÄ±n yanÄ±nda)
        buttons_frame = ttk.Frame(exposure_frame)
        buttons_frame.grid(row=0, column=4, rowspan=2, padx=10, pady=5, sticky='nw')
        
        # ButonlarÄ± grid olarak dÃ¼zenle (2 satÄ±r x 3 kolon)
        # Ä°lk satÄ±r
        self.controller_btn = ttk.Button(buttons_frame, text="ğŸ›ï¸ Controller: OFF", 
                                         command=self.toggle_controller, 
                                         style='Accent.TButton', width=15)
        self.controller_btn.grid(row=0, column=0, padx=2, pady=2, sticky='ew')
        
        self.karbotu_btn = ttk.Button(buttons_frame, text="ğŸ¯ KARBOTU", 
                                     command=self.start_karbotu_automation, 
                                     style='Accent.TButton', width=15)
        self.karbotu_btn.grid(row=0, column=1, padx=2, pady=2, sticky='ew')
        
        self.reducemore_btn = ttk.Button(buttons_frame, text="ğŸ“‰ REDUCEMORE", 
                                         command=self.start_reducemore_automation, 
                                         style='Accent.TButton', width=15)
        self.reducemore_btn.grid(row=0, column=2, padx=2, pady=2, sticky='ew')
        
        # Ä°kinci satÄ±r
        self.excluder_btn = ttk.Button(buttons_frame, text="ğŸš« Excluder", 
                                       command=self.show_excluder_dialog, 
                                       style='Accent.TButton', width=15)
        self.excluder_btn.grid(row=1, column=0, padx=2, pady=2, sticky='ew')
        
        self.addnewpos_btn = ttk.Button(buttons_frame, text="â• ADDNEWPOS", 
                                       command=self.start_addnewpos_automation, 
                                       style='Accent.TButton', width=15)
        self.addnewpos_btn.grid(row=1, column=1, padx=2, pady=2, sticky='ew')
        
        self.bm_shifter_btn = ttk.Button(buttons_frame, text="ğŸ“Š BM Shifter", 
                                        command=self.show_bm_shifter_dialog, 
                                        style='Accent.TButton', width=15)
        self.bm_shifter_btn.grid(row=1, column=2, padx=2, pady=2, sticky='ew')
        
        # ÃœÃ§Ã¼ncÃ¼ satÄ±r - Kurallar butonu ve DÃ¶ngÃ¼ Raporu butonu
        self.kurallar_btn = ttk.Button(buttons_frame, text="ğŸ“‹ Kurallar", 
                                       command=self.show_rules_dialog, 
                                       style='Accent.TButton', width=15)
        self.kurallar_btn.grid(row=2, column=0, padx=2, pady=2, sticky='ew')
        
        # DÃ¶ngÃ¼ Raporu butonu - RUNALL emirlerinin detaylÄ± raporunu gÃ¶sterir
        self.loop_report_btn = ttk.Button(buttons_frame, text="ğŸ“Š DÃ¶ngÃ¼ Raporu", 
                                          command=self.show_loop_report_window, 
                                          style='Accent.TButton', width=15)
        self.loop_report_btn.grid(row=2, column=1, padx=2, pady=2, sticky='ew')
        
        # Psfalgo Alg Raporu butonu - TÃ¼m Psfalgo aktivitelerini gÃ¶sterir
        self.psfalgo_alg_raporu_btn = ttk.Button(buttons_frame, text="ğŸ“ˆ Alg Raporu", 
                                                 command=self.show_psfalgo_alg_raporu, 
                                                 style='Accent.TButton', width=15)
        self.psfalgo_alg_raporu_btn.grid(row=2, column=2, padx=2, pady=2, sticky='ew')
        
        # DÃ¶rdÃ¼ncÃ¼ satÄ±r - Croplit butonlarÄ±
        self.croplit6_btn = ttk.Button(buttons_frame, text="ğŸ”ª Croplit6", 
                                      command=self.execute_croplit6, 
                                      style='Accent.TButton', width=15)
        self.croplit6_btn.grid(row=3, column=0, padx=2, pady=2, sticky='ew')
        
        self.croplit9_btn = ttk.Button(buttons_frame, text="ğŸ”ª Croplit9", 
                                      command=self.execute_croplit9, 
                                      style='Accent.TButton', width=15)
        self.croplit9_btn.grid(row=3, column=1, padx=2, pady=2, sticky='ew')
        
        # BeÅŸinci satÄ±r - ADDNEWPOS Mod radio butonlarÄ±
        self.addnewpos_mode_var = tk.StringVar(value="addlong_only")  # VarsayÄ±lan: addlong only
        
        addmode_frame = ttk.Frame(buttons_frame)
        addmode_frame.grid(row=4, column=0, columnspan=3, padx=2, pady=5, sticky='w')
        
        ttk.Label(addmode_frame, text="ADDNEWPOS Mod:", font=("Arial", 9, "bold")).pack(side='left', padx=(0, 5))
        
        # addlong only butonu (varsayÄ±lan seÃ§ili)
        self.btn_addlong_only = ttk.Radiobutton(addmode_frame, text="ğŸ“ˆ AddLong Only", 
                                                variable=self.addnewpos_mode_var, 
                                                value="addlong_only",
                                                command=self.on_addnewpos_mode_changed)
        self.btn_addlong_only.pack(side='left', padx=3)
        
        # addshort only butonu
        self.btn_addshort_only = ttk.Radiobutton(addmode_frame, text="ğŸ“‰ AddShort Only", 
                                                 variable=self.addnewpos_mode_var, 
                                                 value="addshort_only",
                                                 command=self.on_addnewpos_mode_changed)
        self.btn_addshort_only.pack(side='left', padx=3)
        
        # addboth butonu
        self.btn_addboth = ttk.Radiobutton(addmode_frame, text="ğŸ”„ AddBoth", 
                                           variable=self.addnewpos_mode_var, 
                                           value="addboth",
                                           command=self.on_addnewpos_mode_changed)
        self.btn_addboth.pack(side='left', padx=3)
        
        # Grid kolonlarÄ±nÄ± eÅŸit geniÅŸlikte yap
        buttons_frame.columnconfigure(0, weight=1)
        buttons_frame.columnconfigure(1, weight=1)
        buttons_frame.columnconfigure(2, weight=1)
        
        # Pot Expo Limit input (yeni)
        ttk.Label(exposure_frame, text="Pot Expo Limit ($):").grid(row=1, column=0, padx=5, pady=5, sticky='w')
        self.pot_expo_limit_var = tk.StringVar(value="1400000")  # Default 1.4M
        ttk.Entry(exposure_frame, textvariable=self.pot_expo_limit_var, width=15).grid(row=1, column=1, padx=5, pady=5, sticky='w')
        
        # Hesaplanan max lot
        self.max_lot_label = ttk.Label(exposure_frame, text="Max Lot: 54,545", font=("Arial", 10, "bold"), foreground='green')
        self.max_lot_label.grid(row=2, column=0, columnspan=4, padx=5, pady=5, sticky='w')
        
        # Pot Max Lot (yeni)
        self.pot_max_lot_label = ttk.Label(exposure_frame, text="Pot Max Lot: 63,636", font=("Arial", 10, "bold"), foreground='purple')
        self.pot_max_lot_label.grid(row=3, column=0, columnspan=4, padx=5, pady=5, sticky='w')
        
        # Defansif/Ofansif eÅŸik bilgisi
        self.threshold_label = ttk.Label(exposure_frame, text="Defansif EÅŸik: 52,545 lot | Ofansif DÃ¶nÃ¼ÅŸ: 50,909 lot", 
                                        font=("Arial", 9), foreground='blue')
        self.threshold_label.grid(row=4, column=0, columnspan=4, padx=5, pady=5, sticky='w')
        
        # Mevcut lot bilgisi
        self.current_lot_label = ttk.Label(exposure_frame, text="Mevcut Lot: 0 | Mode: -", 
                                          font=("Arial", 10, "bold"), foreground='red')
        self.current_lot_label.grid(row=5, column=0, columnspan=4, padx=5, pady=5, sticky='w')
        
        # DeÄŸiÅŸiklikleri hesapla
        def calculate_exposure():
            try:
                exposure_limit = float(self.exposure_limit_var.get())
                pot_expo_limit = float(self.pot_expo_limit_var.get())
                avg_price = float(self.avg_price_var.get())
                
                max_lot = int(exposure_limit / avg_price)
                pot_max_lot = int(pot_expo_limit / avg_price)
                defensive_threshold = int(max_lot * 0.955)  # %95.5
                offensive_threshold = int(max_lot * 0.927)  # %92.7
                
                self.max_lot_label.config(text=f"Max Lot: {max_lot:,}")
                self.pot_max_lot_label.config(text=f"Pot Max Lot: {pot_max_lot:,}")
                self.threshold_label.config(text=f"Defansif EÅŸik: {defensive_threshold:,} lot | Ofansif DÃ¶nÃ¼ÅŸ: {offensive_threshold:,} lot")
            except ValueError:
                pass
        
        self.exposure_limit_var.trace('w', lambda *args: calculate_exposure())
        self.pot_expo_limit_var.trace('w', lambda *args: calculate_exposure())
        self.avg_price_var.trace('w', lambda *args: calculate_exposure())
        calculate_exposure()
        
        # Kontrol butonlarÄ±
        control_frame = ttk.Frame(self.psfalgo_window)
        control_frame.pack(fill='x', padx=10, pady=5)
        
        self.start_btn = ttk.Button(control_frame, text="Robot BaÅŸlat", 
                                   command=self.start_psfalgo_monitoring)
        self.start_btn.pack(side='left', padx=5)
        
        self.stop_btn = ttk.Button(control_frame, text="Robot Durdur", 
                                  command=self.stop_psfalgo_monitoring, state='disabled')
        self.stop_btn.pack(side='left', padx=5)
        
        # RUNALL butonu
        self.runall_btn = ttk.Button(control_frame, text="â–¶ï¸ RUNALL", 
                                     command=self.run_all_sequence, 
                                     style='Accent.TButton')
        self.runall_btn.pack(side='left', padx=5)
        
        # RUNALL DURDUR butonu (baÅŸlangÄ±Ã§ta gizli)
        self.runall_stop_btn = ttk.Button(control_frame, text="â¹ï¸ RUNALL DURDUR", 
                                          command=self.stop_runall_loop, 
                                          style='Danger.TButton',
                                          state='disabled')
        self.runall_stop_btn.pack(side='left', padx=5)
        
        # RUNALL dÃ¶ngÃ¼ sayacÄ± label'Ä±
        self.runall_loop_label = ttk.Label(control_frame, 
                                          text="DÃ¶ngÃ¼: 0", 
                                          font=("Arial", 11, "bold"), 
                                          foreground='blue')
        self.runall_loop_label.pack(side='left', padx=10)
        
        # Allowed checkbox - RUNALL modunda otomatik onay iÃ§in
        self.runall_allowed_var = tk.BooleanVar(value=False)
        self.runall_allowed_checkbox = ttk.Checkbutton(control_frame, 
                                                       text="âœ… Allowed (Otomatik Onay)", 
                                                       variable=self.runall_allowed_var)
        self.runall_allowed_checkbox.pack(side='left', padx=5)
        
        # Lot BÃ¶lÃ¼cÃ¼ checkbox - RUNALL modunda otomatik Lot BÃ¶lÃ¼cÃ¼ aÃ§ma iÃ§in
        self.runall_lot_divider_var = tk.BooleanVar(value=False)
        self.runall_lot_divider_checkbox = ttk.Checkbutton(control_frame, 
                                                           text="ğŸ“¦ Lot BÃ¶lÃ¼cÃ¼ (Otomatik AÃ§)", 
                                                           variable=self.runall_lot_divider_var)
        self.runall_lot_divider_checkbox.pack(side='left', padx=5)
        
        # RevOrderMod checkbox - RUNALL modunda otomatik RevOrder aÃ§ma iÃ§in
        self.revorder_mod_var = tk.BooleanVar(value=False)
        self.revorder_mod_checkbox = ttk.Checkbutton(control_frame, 
                                                      text="ğŸ”„ RevOrderMod (Otomatik Kar Alma)", 
                                                      variable=self.revorder_mod_var)
        self.revorder_mod_checkbox.pack(side='left', padx=5)
        
        # BM Shift deÄŸeri gÃ¶sterimi
        current_shift = getattr(self, 'benchmark_shift', 0.0)
        self.bm_shift_label = ttk.Label(control_frame, text=f"BM Shift: {current_shift:.4f}", 
                                       font=("Arial", 9), foreground='blue')
        self.bm_shift_label.pack(side='left', padx=5)
        
        # Excluded ticker'larÄ± sakla
        self.excluded_tickers = set()  # Set olarak sakla (hÄ±zlÄ± arama iÃ§in)
        
        # Durum etiketi
        self.status_label = ttk.Label(control_frame, text="Durum: Durduruldu", 
                                     font=("Arial", 10))
        self.status_label.pack(side='right', padx=5)
        
        # Pozisyon tablosu
        table_frame = ttk.Frame(self.psfalgo_window)
        table_frame.pack(fill='both', expand=True, padx=10, pady=5)
        
        # Tablo kolonlarÄ± - Befday Cost, Todays Cost, Last Price eklendi
        columns = ('Symbol', 'Current Qty', 'Potential Qty', 'Befday Cost', 'Todays Cost', 'Last Price', 'Befday Qty', 'Todays Qty Chg', 'Pozisyon DeÄŸiÅŸikliÄŸi', 'Max Change', 'MAXALW', '3H Change', 'Open Orders', 'Max Add Long', 'Max Add Short', 'Status')
        self.psfalgo_tree = ttk.Treeview(table_frame, columns=columns, show='headings', height=15)
        
        # Kolon geniÅŸlikleri - her kolon iÃ§in Ã¶zel geniÅŸlik
        column_widths = {
            'Symbol': 90,
            'Current Qty': 85,
            'Potential Qty': 85,
            'Befday Cost': 85,
            'Todays Cost': 85,
            'Last Price': 80,
            'Befday Qty': 80,
            'Todays Qty Chg': 90,
            'Pozisyon DeÄŸiÅŸikliÄŸi': 120,
            'Max Change': 85,
            'MAXALW': 70,
            '3H Change': 75,
            'Open Orders': 80,
            'Max Add Long': 90,
            'Max Add Short': 90,
            'Status': 130
        }
        
        for col in columns:
            self.psfalgo_tree.heading(col, text=col)
            self.psfalgo_tree.column(col, width=column_widths.get(col, 80))
        
        # Scrollbar
        scrollbar = ttk.Scrollbar(table_frame, orient='vertical', command=self.psfalgo_tree.yview)
        self.psfalgo_tree.configure(yscrollcommand=scrollbar.set)
        
        self.psfalgo_tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        # Log alanÄ±
        log_frame = ttk.LabelFrame(self.psfalgo_window, text="Robot LoglarÄ±")
        log_frame.pack(fill='x', padx=10, pady=5)
        
        self.log_text = tk.Text(log_frame, height=8, width=100)
        log_scrollbar = ttk.Scrollbar(log_frame, orient='vertical', command=self.log_text.yview)
        self.log_text.configure(yscrollcommand=log_scrollbar.set)
        
        self.log_text.pack(side='left', fill='both', expand=True)
        log_scrollbar.pack(side='right', fill='y')
        
        # Ä°lk pozisyon verilerini yÃ¼kle
        # PozisyonlarÄ± thread'de yÃ¼kle (UI'Ä± bloklamamak iÃ§in)
        self.load_psfalgo_positions_async()
        
        # Ä°lk exposure kontrolÃ¼nÃ¼ yap (thread'de, UI'Ä± bloklamaz)
        self.check_exposure_limits_async(callback=lambda info: (
            self.after(0, lambda: self.current_lot_label.config(
                text="BaÄŸlantÄ± bekleniyor...", foreground='orange'
            ) if info.get('mode') == 'ERROR' else None)
        ))
    
    def load_psfalgo_positions_async(self):
        """Psfalgo pozisyonlarÄ±nÄ± thread'de yÃ¼kle (UI'Ä± bloklamaz)"""
        import threading
        thread = threading.Thread(target=self._load_psfalgo_positions_thread, daemon=True)
        thread.start()
    
    def _load_psfalgo_positions_thread(self):
        """Thread'de pozisyon verilerini yÃ¼kle - TÃ¼m bloklayan iÅŸlemler burada"""
        try:
            # Aktif modu kontrol et
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            # Log mesajÄ±nÄ± main thread'de gÃ¶ster (thread-safe)
            self.safe_ui_call(self.log_message, f"ğŸ”„ Aktif mod: {active_account} - Pozisyonlar Ã§ekiliyor...")
            
            # Aktif hesaptan pozisyonlarÄ± al (cache'den veya direkt)
            # Lock kullanarak aynÄ± anda sadece bir thread pozisyon Ã§eksin
            import threading
            if not hasattr(self, '_positions_lock'):
                self._positions_lock = threading.Lock()
            
            positions = []
            with self._positions_lock:
                # Ã–nce cache'den kontrol et (5 saniye iÃ§inde Ã§ekilmiÅŸse cache'den kullan)
                import time
                cache_key = active_account
                current_time = time.time()
                
                if (hasattr(self, 'positions_cache') and 
                    cache_key in self.positions_cache and
                    hasattr(self, 'positions_cache_time') and
                    cache_key in self.positions_cache_time and
                    (current_time - self.positions_cache_time.get(cache_key, 0)) < 5.0):  # 5 saniye cache
                    positions = self.positions_cache[cache_key].copy()  # Copy yap ki deÄŸiÅŸmesin
                    self.safe_ui_call(self.log_message, f"âœ… {active_account}: {len(positions)} pozisyon cache'den alÄ±ndÄ±")
                else:
                    # Cache yok veya eski, yeni pozisyon Ã§ek
                    if active_account in ["IBKR_GUN", "IBKR_PED"]:
                        # IBKR mod - IBKR pozisyonlarÄ±nÄ± al (GUN veya PED)
                        if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                            positions = self.mode_manager.ibkr_native_client.get_positions()
                            self.safe_ui_call(self.log_message, f"âœ… IBKR Native'dan {len(positions)} pozisyon alÄ±ndÄ± ({active_account})")
                        elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                            positions = self.mode_manager.ibkr_client.get_positions()
                            self.safe_ui_call(self.log_message, f"âœ… IBKR Client'dan {len(positions)} pozisyon alÄ±ndÄ± ({active_account})")
                        else:
                            self.safe_ui_call(self.log_message, f"âŒ IBKR baÄŸlantÄ±sÄ± yok! ({active_account}) LÃ¼tfen Ã¶nce baÄŸlanÄ±n.")
                            return
                    else:  # HAMPRO
                        # HAMPRO mod - Hammer Pro pozisyonlarÄ±nÄ± al
                        if self.hammer and self.hammer.connected:
                            positions = self.hammer.get_positions_direct()
                            self.safe_ui_call(self.log_message, f"âœ… HAMPRO'dan {len(positions)} pozisyon alÄ±ndÄ±")
                            # Debug: Pozisyon yapÄ±sÄ±nÄ± logla
                            if positions:
                                self.safe_ui_call(self.log_message, f"ğŸ” Ä°lk pozisyon Ã¶rneÄŸi: {positions[0]}")
                            else:
                                self.safe_ui_call(self.log_message, "âš ï¸ HAMPRO'dan pozisyon dÃ¶ndÃ¼ ama liste boÅŸ!")
                        else:
                            self.safe_ui_call(self.log_message, "âŒ HAMPRO baÄŸlantÄ±sÄ± yok! LÃ¼tfen Ã¶nce baÄŸlanÄ±n.")
                            return
                    
                    # Cache'i gÃ¼ncelle
                    if not hasattr(self, 'positions_cache'):
                        self.positions_cache = {}
                    if not hasattr(self, 'positions_cache_time'):
                        self.positions_cache_time = {}
                    self.positions_cache[cache_key] = positions.copy()  # Copy yap
                    self.positions_cache_time[cache_key] = current_time
            
            if not positions:
                self.after(0, lambda: self.log_message("âš ï¸ Pozisyon bulunamadÄ±!"))
                return
            
            # Duplicate pozisyonlarÄ± filtrele ve birleÅŸtir (aynÄ± symbol iÃ§in quantity'leri topla)
            unique_positions = {}
            for pos in positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '') or pos.get('ticker', '') or pos.get('Ticker', '')
                if not symbol:
                    continue
                
                qty = pos.get('qty', None) or pos.get('quantity', None) or pos.get('Quantity', None)
                if qty is None:
                    continue
                
                try:
                    qty_float = float(qty)
                except (ValueError, TypeError):
                    continue
                
                # Duplicate pozisyonlarÄ± birleÅŸtir
                if symbol in unique_positions:
                    unique_positions[symbol] += qty_float
                else:
                    unique_positions[symbol] = qty_float
            
            # Duplicate pozisyon uyarÄ±sÄ±
            if len(positions) != len(unique_positions):
                self.safe_ui_call(self.log_message, f"âš ï¸ {len(positions) - len(unique_positions)} duplicate pozisyon birleÅŸtirildi (Toplam: {len(positions)} â†’ Unique: {len(unique_positions)})")
            
            if not unique_positions:
                self.safe_ui_call(self.log_message, "âš ï¸ Pozisyon bulunamadÄ±!")
                return
            
            # PozisyonlarÄ± DataFrame'e Ã§evir
            position_data = []
            for symbol, qty_float in unique_positions.items():
                if qty_float != 0:  # Sadece 0 olmayan pozisyonlarÄ± ekle
                    position_data.append({
                        'Symbol': symbol,
                        'Quantity': qty_float
                    })
            
            if not position_data:
                self.safe_ui_call(self.log_message, "âš ï¸ Pozisyon verisi parse edilemedi veya tÃ¼m pozisyonlar 0!")
                self.safe_ui_call(self.log_message, f"ğŸ” Toplam {len(positions)} pozisyon geldi ama parse edilemedi")
                return
            
            df = pd.DataFrame(position_data)
            
            # TÃ¼m pozisyon verilerini thread'de hazÄ±rla (UI widget'larÄ±na eriÅŸmeden)
            prepared_data = []
            print(f"[PSFALGO] ğŸ”„ {len(df)} pozisyon iÃ§in veri hazÄ±rlanÄ±yor...")
            
            for idx, row in df.iterrows():
                try:
                    symbol = row['Symbol']
                    quantity = row['Quantity']
                    
                    # GÃ¼n baÅŸÄ± pozisyonu al (befib/befham'dan) - CSV okuma thread'de
                    befday_qty = self.load_bef_position(symbol)
                    
                    # BugÃ¼nkÃ¼ deÄŸiÅŸim hesapla
                    todays_qty_chg = quantity - befday_qty
                    
                    # MAXALW deÄŸerini al (AVG_ADV / rule_avg_adv_divisor) - CSV okuma thread'de
                    maxalw = self.get_maxalw_for_symbol(symbol)
                    # Max Change = MAXALW * rule_max_change_multiplier (varsayÄ±lan 0.75)
                    multiplier = getattr(self, 'rule_max_change_multiplier', 0.75)
                    max_change = int(maxalw * multiplier) if maxalw > 0 else 0
                    
                    # AÃ§Ä±k emirleri kontrol et (cache'den, hÄ±zlÄ±)
                    open_orders_count = self.get_open_orders_count(symbol, use_cache=True)
                    
                    # Emir analizi yap (cache'den, hÄ±zlÄ±)
                    order_analysis = self.analyze_order_impact(symbol, quantity)
                    
                    # Yeni kolonlar: Befday Cost, Todays Cost, Last Price - CSV okuma thread'de
                    befday_cost = self.get_prev_close_for_psfalgo(symbol)
                    todays_cost = self.get_todays_cost_for_psfalgo(symbol, quantity, befday_qty)
                    last_price = self.get_last_price_for_psfalgo(symbol)
                    
                    # Pozisyon deÄŸiÅŸikliÄŸi hesapla
                    position_change = self.calculate_position_change(befday_qty, todays_qty_chg)
                    
                    # Veriyi hazÄ±rla (UI gÃ¼ncellemesi iÃ§in)
                    prepared_data.append({
                        'symbol': symbol,
                        'quantity': quantity,
                        'display_quantity': f"{quantity:.0f}" if quantity >= 0 else f"{quantity:.0f}",
                        'befday_qty': befday_qty,
                        'todays_qty_chg': todays_qty_chg,
                        'maxalw': maxalw,
                        'max_change': max_change,
                        'open_orders_count': open_orders_count,
                        'order_analysis': order_analysis,
                        'befday_cost': befday_cost,
                        'todays_cost': todays_cost,
                        'last_price': last_price,
                        'position_change': position_change
                    })
                except Exception as e:
                    print(f"[PSFALGO] âš ï¸ {symbol} pozisyonu hazÄ±rlanÄ±rken hata: {e}")
                    import traceback
                    traceback.print_exc()
                    continue
            
            # Debug: Pozisyon verilerini logla
            print(f"[PSFALGO] ğŸ“Š {len(prepared_data)} pozisyon hazÄ±rlandÄ±, UI'ya gÃ¶nderiliyor...")
            if prepared_data:
                print(f"[PSFALGO] ğŸ” Ä°lk pozisyon Ã¶rneÄŸi: {prepared_data[0]['symbol']} - Qty: {prepared_data[0]['quantity']}")
            
            # UI gÃ¼ncellemesini main thread'de yap (thread-safe)
            self.safe_ui_call(self._update_ui_with_positions, prepared_data)
            
        except Exception as e:
            # Hata mesajÄ±nÄ± da main thread'de gÃ¶ster (thread-safe)
            self.safe_ui_call(self.log_message, f"âŒ Pozisyon yÃ¼kleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def _update_ui_with_positions(self, prepared_data):
        """UI'Ä± hazÄ±rlanmÄ±ÅŸ pozisyon verileri ile gÃ¼ncelle (main thread'de Ã§alÄ±ÅŸÄ±r)"""
        try:
            # Pencere ve tree widget'Ä±nÄ±n var olduÄŸunu kontrol et
            if not hasattr(self, 'psfalgo_window') or not self.psfalgo_window:
                print("[PSFALGO] âš ï¸ Pencere bulunamadÄ±, pozisyonlar yÃ¼klenemiyor")
                return
            
            if not hasattr(self, 'psfalgo_tree') or not self.psfalgo_tree:
                print("[PSFALGO] âš ï¸ Tree widget bulunamadÄ±, pozisyonlar yÃ¼klenemiyor")
                return
            
            # Pencere hala aÃ§Ä±k mÄ± kontrol et
            try:
                if not self.psfalgo_window.winfo_exists():
                    print("[PSFALGO] âš ï¸ Pencere kapatÄ±lmÄ±ÅŸ, pozisyonlar yÃ¼klenemiyor")
                    return
            except:
                print("[PSFALGO] âš ï¸ Pencere kontrolÃ¼ baÅŸarÄ±sÄ±z, pozisyonlar yÃ¼klenemiyor")
                return
            
            # Tabloyu temizle
            for item in self.psfalgo_tree.get_children():
                self.psfalgo_tree.delete(item)
            
            # PozisyonlarÄ± tabloya ekle
            print(f"[PSFALGO] ğŸ“‹ {len(prepared_data)} pozisyon tabloya ekleniyor...")
            for data in prepared_data:
                symbol = data['symbol']
                quantity = data['quantity']
                
                try:
                    self.psfalgo_tree.insert('', 'end', values=[
                        symbol,
                        data['display_quantity'],
                        f"{data['order_analysis']['potential_position']:.0f}",  # Potansiyel pozisyon
                        f"${data['befday_cost']:.2f}" if data['befday_cost'] > 0 else "N/A",  # Befday Cost
                        f"${data['todays_cost']:.2f}" if data['todays_cost'] > 0 else "",  # Todays Cost
                        f"${data['last_price']:.2f}" if data['last_price'] > 0 else "N/A",  # Last Price
                        f"{data['befday_qty']:.0f}",  # Befday Qty
                        f"{data['todays_qty_chg']:+.0f}",  # Todays Qty Chg
                        data['position_change'],  # Pozisyon DeÄŸiÅŸikliÄŸi
                        f"{data['max_change']}",  # Max Change
                        f"{data['maxalw']:.0f}",  # MAXALW
                        "0",  # 3 saatlik deÄŸiÅŸim
                        f"{data['open_orders_count']}",  # AÃ§Ä±k emir sayÄ±sÄ±
                        f"{data['order_analysis']['max_additional_long']:.0f}",  # Max ek long
                        f"{data['order_analysis']['max_additional_short']:.0f}",  # Max ek short
                        "HazÄ±r"
                    ])
                    
                    # Pozisyon verilerini sakla
                    self.psfalgo_positions[symbol] = {
                        'quantity': quantity,
                        'befday_qty': data['befday_qty'],
                        'todays_qty_chg': data['todays_qty_chg'],
                        'maxalw': data['maxalw'],
                        'max_change': data['max_change'],
                        'three_hour_change': 0,
                        'last_trade_time': None,
                        'befday_cost': data['befday_cost'],
                        'todays_cost': data['todays_cost'],
                        'last_price': data['last_price']
                    }
                except Exception as e:
                    print(f"[PSFALGO] âš ï¸ {symbol} pozisyonu eklenirken hata: {e}")
                    continue
            
            print(f"[PSFALGO] âœ… {len(prepared_data)} pozisyon tabloya eklendi")
            self.log_message(f"âœ… {len(prepared_data)} pozisyon yÃ¼klendi")
            
        except Exception as e:
            self.log_message(f"âŒ UI gÃ¼ncelleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def calculate_position_change(self, befday_qty, todays_qty_chg):
        """
        Pozisyon deÄŸiÅŸikliÄŸi tipini hesapla
        
        Args:
            befday_qty: GÃ¼n baÅŸÄ± pozisyon miktarÄ±
            todays_qty_chg: BugÃ¼nkÃ¼ pozisyon deÄŸiÅŸikliÄŸi
            
        Returns:
            str: "Long ArttÄ±rma", "Long Azaltma", "Short ArttÄ±rma", "Short Azaltma"
        """
        try:
            befday_qty = float(befday_qty) if befday_qty else 0.0
            todays_qty_chg = float(todays_qty_chg) if todays_qty_chg else 0.0
            
            # Ã–zel durum: Befday Qty = 0
            if befday_qty == 0:
                if todays_qty_chg > 0:
                    return "Long ArttÄ±rma"
                elif todays_qty_chg < 0:
                    return "Short ArttÄ±rma"
                else:
                    return "-"
            
            # Befday Qty pozitif (Long pozisyon)
            if befday_qty > 0:
                if todays_qty_chg > 0:
                    return "Long ArttÄ±rma"
                elif todays_qty_chg < 0:
                    return "Long Azaltma"
                else:
                    return "-"
            
            # Befday Qty negatif (Short pozisyon)
            elif befday_qty < 0:
                if todays_qty_chg < 0:  # Negatif deÄŸiÅŸiklik = daha negatif = short arttÄ±rma
                    return "Short ArttÄ±rma"
                elif todays_qty_chg > 0:  # Pozitif deÄŸiÅŸiklik = daha az negatif = short azaltma
                    return "Short Azaltma"
                else:
                    return "-"
            
            return "-"
            
        except Exception as e:
            print(f"[PSFALGO] âŒ Pozisyon deÄŸiÅŸikliÄŸi hesaplama hatasÄ±: {e}")
            return "-"
    
    def get_maxalw_for_symbol(self, symbol):
        """Hisse iÃ§in MAXALW deÄŸerini al (AVG_ADV / rule_avg_adv_divisor)"""
        try:
            # AVG_ADV deÄŸerini al
            avg_adv = self.get_avg_adv_from_csv(symbol)
            
            # Kural deÄŸerini al (varsayÄ±lan 10)
            divisor = getattr(self, 'rule_avg_adv_divisor', 10)
            
            # MAXALW = AVG_ADV / divisor
            maxalw = avg_adv / divisor if avg_adv > 0 else 0
            
            return maxalw
        except Exception as e:
            print(f"[PSFALGO] âŒ {symbol} MAXALW hesaplama hatasÄ±: {e}")
            return 0
    
    def get_prev_close_for_psfalgo(self, symbol):
        """Psfalgo iÃ§in previous close deÄŸerini al (Befday Cost)"""
        try:
            # Ã–nce prev_close_cache'den al
            if hasattr(self, 'prev_close_cache') and symbol in self.prev_close_cache:
                return self.prev_close_cache[symbol]
            
            # Cache yoksa CSV'lerden yÃ¼kle
            self.load_prev_close_from_csv()
            
            if hasattr(self, 'prev_close_cache') and symbol in self.prev_close_cache:
                return self.prev_close_cache[symbol]
            
            # Hala bulunamadÄ±ysa mini450'den al
            if hasattr(self, 'stock_data_manager') and self.stock_data_manager:
                stock_data = self.stock_data_manager.get_stock_data(symbol)
                if stock_data and 'prev_close' in stock_data:
                    prev_close = stock_data.get('prev_close', 0)
                    if prev_close > 0:
                        return prev_close
            
            return 0
        except Exception as e:
            print(f"[PSFALGO] âŒ {symbol} prev_close alma hatasÄ±: {e}")
            return 0
    
    def get_last_price_for_psfalgo(self, symbol):
        """Psfalgo iÃ§in last price deÄŸerini al"""
        try:
            # Hammer'dan market data al
            if hasattr(self, 'hammer') and self.hammer and self.hammer.connected:
                market_data = self.hammer.get_market_data(symbol)
                if market_data:
                    last_price = market_data.get('last', 0)
                    if last_price > 0:
                        return last_price
            
            # mini450'den al (fallback)
            if hasattr(self, 'stock_data_manager') and self.stock_data_manager:
                stock_data = self.stock_data_manager.get_stock_data(symbol)
                if stock_data:
                    last_price = stock_data.get('last', stock_data.get('Last', 0))
                    if last_price > 0:
                        return last_price
            
            return 0
        except Exception as e:
            print(f"[PSFALGO] âŒ {symbol} last price alma hatasÄ±: {e}")
            return 0
    
    def get_todays_cost_for_psfalgo(self, symbol, current_qty, befday_qty):
        """
        Psfalgo iÃ§in bugÃ¼n yapÄ±lan pozisyon artÄ±rÄ±mlarÄ±nÄ±n ortalama maliyetini hesapla (Todays Cost)
        
        Ã–nce IBKR Native Client'dan bugÃ¼nkÃ¼ filled emirleri Ã§eker, yoksa nfilled dosyalarÄ±ndan okur
        
        Pozisyon artÄ±rÄ±mÄ± kontrolÃ¼:
        - Long iÃ§in: befday_qty >= 0 ve current_qty > befday_qty ise artÄ±rÄ±m var
        - Short iÃ§in: befday_qty <= 0 ve current_qty < befday_qty ise short artÄ±rÄ±m var
        
        Returns:
            Todays Cost (ortalama alÄ±m/satÄ±m fiyatÄ±) veya 0 (artÄ±rÄ±m yoksa)
        """
        try:
            # Pozisyon deÄŸiÅŸimi
            qty_change = current_qty - befday_qty
            
            # Pozisyon artÄ±rÄ±mÄ± var mÄ± kontrol et
            # Long artÄ±rÄ±m: qty_change > 0 ve befday_qty >= 0 (veya short'tan long'a geÃ§iÅŸ)
            # Short artÄ±rÄ±m: qty_change < 0 ve befday_qty <= 0 (veya long'dan short'a geÃ§iÅŸ)
            
            is_long_increase = False
            is_short_increase = False
            
            if befday_qty >= 0 and current_qty > befday_qty:
                # Long pozisyon artÄ±ÅŸÄ±
                is_long_increase = True
            elif befday_qty <= 0 and current_qty < befday_qty:
                # Short pozisyon artÄ±ÅŸÄ±
                is_short_increase = True
            
            if not is_long_increase and not is_short_increase:
                # Pozisyon artÄ±rÄ±mÄ± yok (azalma veya deÄŸiÅŸim yok)
                return 0
            
            # Ã–NCE IBKR Native Client'dan bugÃ¼nkÃ¼ filled emirleri Ã§ek
            filled_orders = []
            if hasattr(self, 'mode_manager') and self.mode_manager:
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client:
                    native_client = self.mode_manager.ibkr_native_client
                    if native_client.is_connected():
                        all_filled = native_client.get_todays_filled_orders()
                        # Symbol'e gÃ¶re filtrele
                        symbol_variants = [symbol]
                        if '-' in symbol:
                            symbol_variants.append(symbol.replace('-', ' PR'))
                        elif ' PR' in symbol:
                            parts = symbol.split(' PR')
                            if len(parts) == 2:
                                symbol_variants.append(f"{parts[0]}-{parts[1]}")
                        
                        for fill in all_filled:
                            fill_symbol = fill.get('symbol', '')
                            if fill_symbol in symbol_variants:
                                filled_orders.append(fill)
            
            # IBKR'den filled emirler varsa onlarÄ± kullan
            if filled_orders:
                total_qty = 0
                total_value = 0
                
                for fill in filled_orders:
                    fill_qty = abs(float(fill.get('fill_qty', 0) or fill.get('qty', 0)))
                    fill_price = float(fill.get('fill_price', 0) or fill.get('price', 0))
                    
                    if fill_qty <= 0 or fill_price <= 0:
                        continue
                    
                    # Action kolonundan yÃ¶n belirle
                    action = str(fill.get('action', '')).lower()
                    is_buy = 'buy' in action
                    is_sell = 'sell' in action
                    
                    if is_long_increase and is_buy:
                        # Long artÄ±rÄ±m - sadece buy iÅŸlemlerini say
                        total_qty += fill_qty
                        total_value += fill_qty * fill_price
                    elif is_short_increase and is_sell:
                        # Short artÄ±rÄ±m - sadece sell iÅŸlemlerini say
                        total_qty += fill_qty
                        total_value += fill_qty * fill_price
                
                if total_qty > 0:
                    avg_cost = total_value / total_qty
                    return round(avg_cost, 2)
            
            # IBKR'den filled emir yoksa nfilled dosyasÄ±ndan oku (fallback)
            import pandas as pd
            import os
            from datetime import datetime
            
            filename = self.get_nfilled_filename()
            janall_dir = os.path.dirname(os.path.abspath(__file__))
            janall_dir = os.path.dirname(janall_dir)  # janallapp -> janall
            nfilled_file = os.path.join(janall_dir, filename)
            
            if not os.path.exists(nfilled_file):
                return 0
            
            df = pd.read_csv(nfilled_file, encoding='utf-8-sig')
            
            if df.empty:
                return 0
            
            # Symbol eÅŸleÅŸtirmesi iÃ§in normalize et
            symbol_variants = [symbol]
            if '-' in symbol:
                symbol_variants.append(symbol.replace('-', ' PR'))
            elif ' PR' in symbol:
                # "F PRC" -> "F-C" formatÄ± iÃ§in de kontrol et
                parts = symbol.split(' PR')
                if len(parts) == 2:
                    symbol_variants.append(f"{parts[0]}-{parts[1]}")
            
            # Symbol'e gÃ¶re filtrele (nfilled zaten sadece bugÃ¼nÃ¼n verilerini iÃ§eriyor)
            symbol_df = df[df['symbol'].isin(symbol_variants)]
            
            if symbol_df.empty:
                return 0
            
            # Pozisyon artÄ±rÄ±mÄ± yÃ¶nÃ¼ne gÃ¶re iÅŸlemleri filtrele
            total_qty = 0
            total_value = 0
            
            for _, row in symbol_df.iterrows():
                fill_qty = abs(float(row.get('fill_qty', 0)))
                fill_price = float(row.get('fill_price', 0))
                
                if fill_qty <= 0 or fill_price <= 0:
                    continue
                
                # Action kolonundan yÃ¶n belirle
                action = str(row.get('action', '')).lower()
                is_buy = 'buy' in action
                is_sell = 'sell' in action
                
                if is_long_increase and is_buy:
                    # Long artÄ±rÄ±m - sadece buy iÅŸlemlerini say
                    total_qty += fill_qty
                    total_value += fill_qty * fill_price
                elif is_short_increase and is_sell:
                    # Short artÄ±rÄ±m - sadece sell iÅŸlemlerini say
                    total_qty += fill_qty
                    total_value += fill_qty * fill_price
            
            if total_qty > 0:
                avg_cost = total_value / total_qty
                return round(avg_cost, 2)
            
            return 0
            
        except Exception as e:
            print(f"[PSFALGO] âŒ {symbol} todays cost hesaplama hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return 0
    
    def load_bef_position(self, symbol):
        """befib veya befham dosyasÄ±ndan gÃ¼n baÅŸÄ± pozisyonu oku"""
        try:
            import pandas as pd
            import os
            
            # Aktif moda gÃ¶re dosya seÃ§
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            if active_account == "IBKR_GUN":
                bef_file = "befibgun.csv"
            elif active_account == "IBKR_PED":
                bef_file = "befibped.csv"
            else:  # HAMPRO
                bef_file = "befham.csv"
            
            # Dosya var mÄ± kontrol et
            if not os.path.exists(bef_file):
                print(f"[CONTROLLER] âš ï¸ {bef_file} dosyasÄ± bulunamadÄ±")
                return 0
            
            # CSV'yi oku
            df = pd.read_csv(bef_file)
            
            # Symbol kolonunu bul (Symbol veya PREF IBKR olabilir)
            symbol_col = None
            if 'Symbol' in df.columns:
                symbol_col = 'Symbol'
            elif 'PREF IBKR' in df.columns:
                symbol_col = 'PREF IBKR'
            
            if symbol_col is None:
                print(f"[CONTROLLER] âš ï¸ {bef_file} dosyasÄ±nda Symbol kolonu bulunamadÄ±")
                return 0
            
            # Quantity kolonunu bul
            qty_col = None
            if 'Quantity' in df.columns:
                qty_col = 'Quantity'
            elif 'qty' in df.columns:
                qty_col = 'qty'
            
            if qty_col is None:
                print(f"[CONTROLLER] âš ï¸ {bef_file} dosyasÄ±nda Quantity kolonu bulunamadÄ±")
                return 0
            
            # Symbol'Ã¼ bul
            row = df[df[symbol_col] == symbol]
            if row.empty:
                # Pozisyon yok (0 olarak dÃ¶ndÃ¼r)
                return 0
            
            # Quantity deÄŸerini al
            qty = row[qty_col].iloc[0]
            return float(qty) if pd.notna(qty) else 0
            
        except Exception as e:
            print(f"[CONTROLLER] âŒ {symbol} BEF pozisyon okuma hatasÄ±: {e}")
            return 0
    
    # ============================================
    # NFILLED - Filled Orders Logging Sistemi
    # ============================================
    
    def get_nfilled_filename(self):
        """Aktif moda gÃ¶re nfilled dosya adÄ±nÄ± dÃ¶ndÃ¼r
        
        Returns:
            str: nfilledped.csv, nfilledgun.csv veya nfilledham.csv
        """
        try:
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if getattr(self, 'ibkr_ped_mode', False):
                    active_account = "IBKR_PED"
                elif getattr(self, 'ibkr_gun_mode', False):
                    active_account = "IBKR_GUN"
                elif getattr(self, 'hampro_mode', False):
                    active_account = "HAMPRO"
                else:
                    active_account = "HAMPRO"  # VarsayÄ±lan
            
            if active_account == "IBKR_PED":
                return "nfilledped.csv"
            elif active_account == "IBKR_GUN":
                return "nfilledgun.csv"
            else:  # HAMPRO
                return "nfilledham.csv"
        except Exception as e:
            print(f"[NFILLED] âŒ Dosya adÄ± belirleme hatasÄ±: {e}")
            return "nfilledham.csv"  # VarsayÄ±lan
    
    def check_and_reset_nfilled_for_new_day(self):
        """GÃ¼n deÄŸiÅŸikliÄŸini kontrol et, yeni gÃ¼nse dosyayÄ± sÄ±fÄ±rla
        
        Returns:
            bool: True ise dosya sÄ±fÄ±rlandÄ± veya yeni oluÅŸturuldu
        """
        try:
            import pandas as pd
            import os
            from datetime import datetime
            
            filename = self.get_nfilled_filename()
            today_str = datetime.now().strftime("%Y-%m-%d")
            
            # Dosya yolunu janall dizinine yÃ¶nlendir
            janall_dir = os.path.dirname(os.path.abspath(__file__))
            janall_dir = os.path.dirname(janall_dir)  # janallapp -> janall
            filepath = os.path.join(janall_dir, filename)
            
            # Dosya yoksa boÅŸ oluÅŸtur
            if not os.path.exists(filepath):
                self._create_empty_nfilled_file(filepath)
                print(f"[NFILLED] âœ… {filename} oluÅŸturuldu")
                return True
            
            # Dosya varsa ilk kaydÄ±n tarihini kontrol et
            df = pd.read_csv(filepath, encoding='utf-8-sig')
            
            if df.empty:
                return False  # BoÅŸ dosya, sÄ±fÄ±rlamaya gerek yok
            
            # fill_time kolonunun ilk deÄŸerinden tarihi al
            if 'fill_time' in df.columns:
                first_fill_time = str(df['fill_time'].iloc[0])
                first_date = first_fill_time[:10]  # YYYY-MM-DD formatÄ±
                
                # Tarih bugÃ¼nden farklÄ±ysa dosyayÄ± sÄ±fÄ±rla
                if first_date != today_str:
                    print(f"[NFILLED] ğŸ”„ Yeni gÃ¼n algÄ±landÄ±! Eski: {first_date}, BugÃ¼n: {today_str}")
                    print(f"[NFILLED] ğŸ—‘ï¸ {filename} sÄ±fÄ±rlanÄ±yor...")
                    self._create_empty_nfilled_file(filepath)
                    return True
            
            return False
            
        except Exception as e:
            print(f"[NFILLED] âŒ GÃ¼n kontrolÃ¼ hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def _create_empty_nfilled_file(self, filepath):
        """BoÅŸ nfilled dosyasÄ± oluÅŸtur (sadece baÅŸlÄ±klarla)"""
        try:
            import pandas as pd
            
            # Kolon baÅŸlÄ±klarÄ± (jdatalog ile uyumlu ama daha basit)
            columns = ['order_id', 'symbol', 'action', 'fill_qty', 'fill_price', 'fill_time']
            df = pd.DataFrame(columns=columns)
            df.to_csv(filepath, index=False, encoding='utf-8-sig')
            print(f"[NFILLED] ğŸ“ BoÅŸ dosya oluÅŸturuldu: {filepath}")
        except Exception as e:
            print(f"[NFILLED] âŒ BoÅŸ dosya oluÅŸturma hatasÄ±: {e}")
    
    def save_fill_to_nfilled(self, fill_data):
        """Fill verisini nfilled dosyasÄ±na kaydet
        
        Args:
            fill_data: dict with keys: order_id, symbol, action, qty, price, time
        """
        try:
            import pandas as pd
            import os
            from datetime import datetime
            
            # Ã–nce gÃ¼n kontrolÃ¼ yap
            self.check_and_reset_nfilled_for_new_day()
            
            filename = self.get_nfilled_filename()
            
            # Dosya yolunu janall dizinine yÃ¶nlendir
            janall_dir = os.path.dirname(os.path.abspath(__file__))
            janall_dir = os.path.dirname(janall_dir)  # janallapp -> janall
            filepath = os.path.join(janall_dir, filename)
            
            # Symbol dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (Hammer formatÄ±ndan PREF IBKR formatÄ±na)
            symbol = fill_data.get('symbol', '')
            if '-' in symbol:
                # F-C -> F PRC formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
                parts = symbol.split('-')
                if len(parts) == 2:
                    symbol = f"{parts[0]} PR{parts[1]}"
            
            # Yeni kayÄ±t
            new_row = {
                'order_id': fill_data.get('order_id', f"fill_{int(datetime.now().timestamp())}"),
                'symbol': symbol,
                'action': fill_data.get('action', fill_data.get('side', 'Unknown')),
                'fill_qty': fill_data.get('qty', fill_data.get('fill_qty', 0)),
                'fill_price': fill_data.get('price', fill_data.get('fill_price', 0)),
                'fill_time': fill_data.get('time', fill_data.get('fill_time', datetime.now().isoformat()))
            }
            
            # Mevcut dosyayÄ± oku veya boÅŸ oluÅŸtur
            if os.path.exists(filepath):
                df = pd.read_csv(filepath, encoding='utf-8-sig')
            else:
                df = pd.DataFrame(columns=['order_id', 'symbol', 'action', 'fill_qty', 'fill_price', 'fill_time'])
            
            # Duplicate kontrolÃ¼ (aynÄ± order_id varsa ekleme)
            if 'order_id' in df.columns and new_row['order_id'] in df['order_id'].values:
                print(f"[NFILLED] âš ï¸ Duplicate order_id atlandÄ±: {new_row['order_id']}")
                return False
            
            # Yeni kaydÄ± ekle
            df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
            
            # Kaydet
            df.to_csv(filepath, index=False, encoding='utf-8-sig')
            
            # Action'a gÃ¶re qty'yi iÅŸaretle (Buy pozitif, Sell negatif)
            action = new_row['action'].lower() if new_row['action'] else ''
            qty_display = new_row['fill_qty']
            if 'sell' in action:
                qty_display = -abs(qty_display)
            
            print(f"[NFILLED] âœ… Fill kaydedildi: {new_row['symbol']} {qty_display} @ ${new_row['fill_price']:.2f}")
            
            return True
            
        except Exception as e:
            print(f"[NFILLED] âŒ Fill kaydetme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def setup_nfilled_callbacks(self):
        """Fill callback'lerini ayarla - Hammer ve IBKR iÃ§in"""
        try:
            # Hammer Pro fill callback
            if hasattr(self, 'hammer') and self.hammer:
                def on_hammer_fill(fill_data):
                    """Hammer fill callback"""
                    try:
                        print(f"[NFILLED] ğŸ”” Hammer fill algÄ±landÄ±: {fill_data}")
                        self.save_fill_to_nfilled(fill_data)
                    except Exception as e:
                        print(f"[NFILLED] âŒ Hammer fill callback hatasÄ±: {e}")
                
                self.hammer.on_fill = on_hammer_fill
                print("[NFILLED] âœ… Hammer fill callback ayarlandÄ±")
            
            # IBKR fill callback (eÄŸer varsa)
            if hasattr(self, 'mode_manager'):
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client:
                    # IBKR Native client iÃ§in execution callback
                    def on_ibkr_execution(exec_data):
                        """IBKR execution callback"""
                        try:
                            print(f"[NFILLED] ğŸ”” IBKR execution algÄ±landÄ±: {exec_data}")
                            fill_data = {
                                'order_id': exec_data.get('execId', exec_data.get('orderId', '')),
                                'symbol': exec_data.get('symbol', ''),
                                'action': exec_data.get('side', exec_data.get('action', '')),
                                'qty': exec_data.get('shares', exec_data.get('qty', 0)),
                                'price': exec_data.get('price', exec_data.get('avgPrice', 0)),
                                'time': exec_data.get('time', '')
                            }
                            self.save_fill_to_nfilled(fill_data)
                        except Exception as e:
                            print(f"[NFILLED] âŒ IBKR execution callback hatasÄ±: {e}")
                    
                    # IBKR client'a callback ekle (eÄŸer destekliyorsa)
                    if hasattr(self.mode_manager.ibkr_native_client, 'on_execution'):
                        self.mode_manager.ibkr_native_client.on_execution = on_ibkr_execution
                        print("[NFILLED] âœ… IBKR execution callback ayarlandÄ±")
            
            print("[NFILLED] âœ… Fill callback'leri hazÄ±r")
            
        except Exception as e:
            print(f"[NFILLED] âŒ Callback ayarlama hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def get_todays_fills_from_nfilled(self, symbol):
        """nfilled dosyasÄ±ndan bugÃ¼nkÃ¼ fill'leri al
        
        Args:
            symbol: Hisse sembolÃ¼ (PREF IBKR formatÄ±nda)
        
        Returns:
            list: Fill kayÄ±tlarÄ± listesi
        """
        try:
            import pandas as pd
            import os
            from datetime import datetime
            
            filename = self.get_nfilled_filename()
            
            # Dosya yolunu janall dizinine yÃ¶nlendir
            janall_dir = os.path.dirname(os.path.abspath(__file__))
            janall_dir = os.path.dirname(janall_dir)  # janallapp -> janall
            filepath = os.path.join(janall_dir, filename)
            
            if not os.path.exists(filepath):
                return []
            
            df = pd.read_csv(filepath, encoding='utf-8-sig')
            
            if df.empty:
                return []
            
            # Symbol eÅŸleÅŸtirmesi iÃ§in normalize et
            symbol_variants = [symbol]
            if '-' in symbol:
                symbol_variants.append(symbol.replace('-', ' PR'))
            elif ' PR' in symbol:
                # "F PRC" -> "F-C" formatÄ± iÃ§in de kontrol et
                parts = symbol.split(' PR')
                if len(parts) == 2:
                    symbol_variants.append(f"{parts[0]}-{parts[1]}")
            
            # Symbol'e gÃ¶re filtrele
            symbol_df = df[df['symbol'].isin(symbol_variants)]
            
            if symbol_df.empty:
                return []
            
            # Dict listesi olarak dÃ¶ndÃ¼r
            fills = []
            for _, row in symbol_df.iterrows():
                fills.append({
                    'order_id': row.get('order_id', ''),
                    'symbol': row.get('symbol', ''),
                    'action': row.get('action', ''),
                    'fill_qty': float(row.get('fill_qty', 0)),
                    'fill_price': float(row.get('fill_price', 0)),
                    'fill_time': row.get('fill_time', '')
                })
            
            return fills
            
        except Exception as e:
            print(f"[NFILLED] âŒ {symbol} fill'leri okuma hatasÄ±: {e}")
            return []
    
    def get_open_orders_sum(self, symbol, use_cache=False):
        """AÃ§Ä±k emirlerin toplam miktarÄ±nÄ± hesapla (potansiyel fill)"""
        try:
            # Cache kullanÄ±lÄ±yorsa cache'den al, deÄŸilse direkt Ã§ek
            if use_cache and hasattr(self, 'orders_cache'):
                orders = self.get_cached_orders()
            else:
                # Aktif hesaptan aÃ§Ä±k emirleri al
                if hasattr(self, 'mode_manager'):
                    active_account = self.mode_manager.get_active_account()
                else:
                    active_account = "HAMPRO" if self.hampro_mode else "IBKR"
                
                orders = []
                if active_account == "IBKR":
                    if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                        orders = self.mode_manager.ibkr_native_client.get_open_orders()
                    elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                        orders = self.mode_manager.ibkr_client.get_orders_direct()
                else:  # HAMPRO
                    if self.hammer and self.hammer.connected:
                        orders = self.hammer.get_open_orders()
            
            # Symbol'e gÃ¶re filtrele ve topla
            total_qty = 0
            for order in orders:
                order_symbol = order.get('symbol', '') or order.get('Symbol', '')
                
                # Symbol eÅŸleÅŸtirmesi (tam eÅŸleÅŸme veya preferred stock formatÄ±)
                is_match = False
                if order_symbol == symbol:
                    is_match = True
                elif '-' in order_symbol:
                    # Preferred stock formatÄ±: "SYMBOL-A" -> "SYMBOL PRA"
                    base, suffix = order_symbol.split('-', 1)
                    if base == symbol.replace(' PR', '').split()[0]:
                        is_match = True
                elif ' PR' in symbol and order_symbol == symbol.replace(' PR', ''):
                    # Symbol "ABC PRC" ama order "ABC" formatÄ±nda
                    is_match = True
                
                if is_match:
                    # Remaining quantity kullan (filled deÄŸil, kalan miktar)
                    remaining = order.get('remaining', None) or order.get('Remaining', None)
                    qty = order.get('quantity', 0) or order.get('qty', 0) or order.get('Quantity', 0) or 0
                    
                    # EÄŸer remaining varsa onu kullan (daha doÄŸru)
                    if remaining is not None and remaining > 0:
                        qty = float(remaining)
                    else:
                        qty = float(qty)
                    
                    side = order.get('side', '').upper() or order.get('Side', '').upper() or order.get('action', '').upper() or order.get('Action', '').upper()
                    
                    # Status kontrolÃ¼ - sadece aÃ§Ä±k emirleri say
                    status = order.get('status', '').upper() or order.get('Status', '').upper()
                    if status in ['CANCELLED', 'FILLED', 'REJECTED', 'API CANCELLED']:
                        continue  # Bu emirler artÄ±k aÃ§Ä±k deÄŸil
                    
                    if side == 'BUY':
                        total_qty += qty
                    elif side == 'SELL':
                        total_qty -= qty
            
            return total_qty
            
        except Exception as e:
            print(f"[CONTROLLER] âŒ {symbol} aÃ§Ä±k emir toplama hatasÄ±: {e}")
            return 0
    
    def check_position_direction_change(self, current_qty, order_side, order_qty, gÃ¼n_baÅŸÄ±_pozisyon=None, open_orders_qty=0):
        """
        Pozisyon tÃ¼rÃ¼ deÄŸiÅŸimini kontrol et - GÃ¼n baÅŸÄ± pozisyon bazÄ±nda (aÃ§Ä±k emirler dahil)
        
        Args:
            current_qty: Mevcut pozisyon
            order_side: BUY/SELL
            order_qty: Ä°stenen emir miktarÄ±
            gÃ¼n_baÅŸÄ±_pozisyon: GÃ¼n baÅŸÄ± pozisyon (befib/befham'dan)
            open_orders_qty: AÃ§Ä±k emirler toplamÄ± (potansiyel fill)
        
        Returns: (allowed, adjusted_qty, needs_rounding, reason)
        """
        try:
            # GÃ¼n baÅŸÄ± pozisyon tÃ¼rÃ¼ (eÄŸer verilmiÅŸse)
            if gÃ¼n_baÅŸÄ±_pozisyon is not None:
                if gÃ¼n_baÅŸÄ±_pozisyon > 0:
                    gÃ¼n_baÅŸÄ±_type = 'LONG'
                elif gÃ¼n_baÅŸÄ±_pozisyon < 0:
                    gÃ¼n_baÅŸÄ±_type = 'SHORT'
                else:
                    gÃ¼n_baÅŸÄ±_type = 'ZERO'
            else:
                gÃ¼n_baÅŸÄ±_type = None
            
            # Mevcut potansiyel pozisyon (aÃ§Ä±k emirler dahil)
            current_potential = current_qty + open_orders_qty
            
            # Mevcut pozisyon tÃ¼rÃ¼
            if current_potential > 0:
                current_type = 'LONG'
            elif current_potential < 0:
                current_type = 'SHORT'
            else:
                current_type = 'ZERO'
            
            # Yeni emir eklendikten sonra potansiyel pozisyon
            if order_side.upper() == 'BUY':
                potential_qty = current_potential + order_qty
            else:  # SELL
                potential_qty = current_potential - order_qty
            
            # Potansiyel pozisyon tÃ¼rÃ¼
            if potential_qty > 0:
                potential_type = 'LONG'
            elif potential_qty < 0:
                potential_type = 'SHORT'
            else:
                potential_type = 'ZERO'
            
            # GÃœN BAÅI POZÄ°SYON BAZINDA KONTROL (Ã–ncelikli)
            if gÃ¼n_baÅŸÄ±_type is not None:
                if gÃ¼n_baÅŸÄ±_type == 'LONG' and potential_type == 'SHORT':
                    # GÃ¼n baÅŸÄ± long pozisyon â†’ potansiyel short olmamalÄ±
                    # Emir miktarÄ±nÄ± mevcut potansiyel pozisyona indir (tam 0'a getir)
                    # current_potential pozitif olmalÄ± ki 0'a getirebilsin
                    if current_potential > 0:
                        adjusted_qty = current_potential  # Tam lot (Ã¶rn: 247)
                        return False, adjusted_qty, False, f"GÃ¼n baÅŸÄ± long pozisyon ({gÃ¼n_baÅŸÄ±_pozisyon:.0f}) short'a geÃ§emez - emir {current_potential:.0f} lot'a indirildi (0'a getirmek iÃ§in)"
                    else:
                        # Zaten short'a geÃ§miÅŸ, emir gÃ¶nderilemez
                        return False, 0, False, f"GÃ¼n baÅŸÄ± long pozisyon ({gÃ¼n_baÅŸÄ±_pozisyon:.0f}) zaten short'a geÃ§miÅŸ - emir engellendi"
                
                elif gÃ¼n_baÅŸÄ±_type == 'SHORT' and potential_type == 'LONG':
                    # GÃ¼n baÅŸÄ± short pozisyon â†’ potansiyel long olmamalÄ±
                    # Emir miktarÄ±nÄ± mevcut potansiyel pozisyona indir (tam 0'a getir)
                    if current_potential < 0:
                        adjusted_qty = abs(current_potential)  # Tam lot
                        return False, adjusted_qty, False, f"GÃ¼n baÅŸÄ± short pozisyon ({gÃ¼n_baÅŸÄ±_pozisyon:.0f}) long'a geÃ§emez - emir {abs(current_potential):.0f} lot'a indirildi (0'a getirmek iÃ§in)"
                    else:
                        # Zaten long'a geÃ§miÅŸ, emir gÃ¶nderilemez
                        return False, 0, False, f"GÃ¼n baÅŸÄ± short pozisyon ({gÃ¼n_baÅŸÄ±_pozisyon:.0f}) zaten long'a geÃ§miÅŸ - emir engellendi"
            
            # Mevcut pozisyon bazÄ±nda kontrol (backup - gÃ¼n baÅŸÄ± bilgisi yoksa)
            if current_type == 'LONG' and potential_type == 'SHORT':
                # Long'dan short'a geÃ§iÅŸ engellenmeli
                if current_potential > 0:
                    adjusted_qty = current_potential  # Tam lot (0'a getirmek iÃ§in)
                    return False, adjusted_qty, False, "Long pozisyon short'a geÃ§emez - emir 0'a getirmek iÃ§in ayarlandÄ±"
                else:
                    return False, 0, False, "Long pozisyon zaten short'a geÃ§miÅŸ - emir engellendi"
            
            elif current_type == 'SHORT' and potential_type == 'LONG':
                # Short'dan long'a geÃ§iÅŸ engellenmeli
                if current_potential < 0:
                    adjusted_qty = abs(current_potential)  # Tam lot (0'a getirmek iÃ§in)
                    return False, adjusted_qty, False, "Short pozisyon long'a geÃ§emez - emir 0'a getirmek iÃ§in ayarlandÄ±"
                else:
                    return False, 0, False, "Short pozisyon zaten long'a geÃ§miÅŸ - emir engellendi"
            
            else:
                # GeÃ§iÅŸ yok veya 0'dan geÃ§iÅŸ (izinli)
                return True, order_qty, True, "Pozisyon tÃ¼rÃ¼ korunuyor - normal yuvarlama yapÄ±labilir"
                
        except Exception as e:
            print(f"[CONTROLLER] âŒ Pozisyon tÃ¼rÃ¼ kontrol hatasÄ±: {e}")
            return True, order_qty, True, f"Hata: {e}"
    
    def check_maxalw_limits(self, symbol, current_qty, open_orders_qty, new_order_qty, order_side, gÃ¼n_baÅŸÄ±_pozisyon, maxalw, is_reduce_order=False):
        """
        MAXALW limitleri kontrolÃ¼
        
        Args:
            is_reduce_order: True ise pozisyon AZALTMA emri (KARBOTU/REDUCEMORE), False ise pozisyon ARTIRMA emri
            Pozisyon azaltma durumlarÄ±nda toplam pozisyon limiti kontrolÃ¼ YAPILMAZ (Ã§Ã¼nkÃ¼ zaten azaltmak istiyoruz)
        
        Returns: (allowed_qty, reason)
        """
        try:
            # Mevcut potansiyel pozisyon (aÃ§Ä±k emirler dahil)
            current_potential = current_qty + open_orders_qty
            
            # Yeni emir eklendikten sonra potansiyel pozisyon (BUY/SELL yÃ¶nÃ¼ne gÃ¶re)
            if order_side.upper() == 'BUY':
                potential_position = current_potential + new_order_qty
            else:  # SELL
                potential_position = current_potential - new_order_qty
            
            # Limit 1: Toplam pozisyon MAXALW'yi geÃ§memeli (abs ile) - emir miktarÄ± ayarlanÄ±r
            # ANCAK: POZISYON AZALTMA (KARBOTU/REDUCEMORE) durumunda bu kontrol YAPILMAZ!
            # Ã‡Ã¼nkÃ¼ zaten pozisyonu azaltmak istiyoruz, MAXALW Ã¼zerinde olmasÄ± sorun deÄŸil
            if is_reduce_order:
                # Pozisyon azaltma - toplam pozisyon limiti kontrolÃ¼ YAPILMAZ
                limit_1_allowed = new_order_qty  # Tam emir miktarÄ± kabul edilir
                limit_1_reason = "Toplam pozisyon limiti: Pozisyon azaltma - kontrol atlandÄ±"
            else:
                # Pozisyon artÄ±rma - toplam pozisyon limiti kontrolÃ¼ YAPILIR
                abs_potential = abs(potential_position)
                current_abs = abs(current_potential)
                
                if abs_potential > maxalw:
                    # Limit aÅŸÄ±lÄ±yor, ne kadar eklenebilir?
                    if current_abs >= maxalw:
                        limit_1_allowed = 0
                        limit_1_reason = f"Toplam pozisyon limiti: Zaten MAXALW'ye ulaÅŸtÄ± ({current_abs:.0f} >= {maxalw:.0f}), emir engellendi"
                    else:
                        # Kalan kapasite (yÃ¶nÃ¼ dikkate alarak)
                        limit_1_allowed = maxalw - current_abs
                        if limit_1_allowed < new_order_qty:
                            limit_1_reason = f"Toplam pozisyon limiti: Emir {new_order_qty} â†’ {limit_1_allowed:.0f} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ (MAXALW: {maxalw:.0f}, mevcut: {current_abs:.0f})"
                        else:
                            limit_1_reason = f"Toplam pozisyon limiti OK"
                else:
                    # Limit iÃ§inde, tam emir miktarÄ± kabul edilebilir (ama diÄŸer limitlere de bakÄ±lacak)
                    limit_1_allowed = maxalw - current_abs
                    if limit_1_allowed > new_order_qty:
                        limit_1_allowed = new_order_qty
                    limit_1_reason = f"Toplam pozisyon limiti OK"
            
            # Limit 2: GÃ¼nlÃ¼k deÄŸiÅŸim MAXALW*multiplier'Ä± geÃ§memeli (abs ile) - emir miktarÄ± ayarlanÄ±r
            multiplier = getattr(self, 'rule_max_change_multiplier', 0.75)
            maxalw_daily_limit = maxalw * multiplier
            
            # Mevcut gÃ¼nlÃ¼k deÄŸiÅŸim (aÃ§Ä±k emirler dahil)
            current_daily_change = abs(current_potential - gÃ¼n_baÅŸÄ±_pozisyon)
            
            # Yeni emir eklendikten sonra gÃ¼nlÃ¼k deÄŸiÅŸim
            potential_daily_change = abs(potential_position - gÃ¼n_baÅŸÄ±_pozisyon)
            
            if potential_daily_change > maxalw_daily_limit:
                # Limit aÅŸÄ±lÄ±yor, ne kadar eklenebilir?
                if current_daily_change >= maxalw_daily_limit:
                    limit_2_allowed = 0
                    limit_2_reason = f"GÃ¼nlÃ¼k deÄŸiÅŸim limiti: Zaten limit dolu ({current_daily_change:.0f} >= {maxalw_daily_limit:.0f}), emir engellendi"
                else:
                    # Kalan gÃ¼nlÃ¼k deÄŸiÅŸim hakkÄ±
                    # Emir miktarÄ± Ã¶yle ayarlanmalÄ± ki potansiyel deÄŸiÅŸim limiti aÅŸmasÄ±n
                    limit_2_allowed = maxalw_daily_limit - current_daily_change
                    if limit_2_allowed < new_order_qty:
                        limit_2_reason = f"GÃ¼nlÃ¼k deÄŸiÅŸim limiti: Emir {new_order_qty} â†’ {limit_2_allowed:.0f} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ (Limit: {maxalw_daily_limit:.0f}, mevcut deÄŸiÅŸim: {current_daily_change:.0f})"
                    else:
                        limit_2_reason = f"GÃ¼nlÃ¼k deÄŸiÅŸim limiti OK"
            else:
                # Limit iÃ§inde, kalan kapasite hesapla
                limit_2_allowed = maxalw_daily_limit - current_daily_change
                if limit_2_allowed > new_order_qty:
                    limit_2_allowed = new_order_qty
                limit_2_reason = f"GÃ¼nlÃ¼k deÄŸiÅŸim limiti OK"
            
            # Limit 3: Ters yÃ¶nde gÃ¼n baÅŸÄ± pozisyonunu aÅŸmamalÄ± (emir miktarÄ± ayarlanÄ±r)
            # GÃ¼n baÅŸÄ± pozisyonun mutlak deÄŸeri
            abs_befday = abs(gÃ¼n_baÅŸÄ±_pozisyon)
            
            # GÃ¼nlÃ¼k deÄŸiÅŸim (iÅŸaretli)
            current_daily_change_signed = current_potential - gÃ¼n_baÅŸÄ±_pozisyon
            potential_daily_change_signed = potential_position - gÃ¼n_baÅŸÄ±_pozisyon
            
            # Ters yÃ¶nde geÃ§iÅŸ var mÄ± kontrol et
            if gÃ¼n_baÅŸÄ±_pozisyon > 0 and potential_position < 0:
                # GÃ¼n baÅŸÄ± long â†’ potansiyel short (ters yÃ¶n)
                # Emir miktarÄ±nÄ± ayarla: pozisyonu 0'a getir ama ters yÃ¶ne geÃ§irme
                # current_potential pozitif olmalÄ± (hala long)
                # Emir miktarÄ±: pozisyonu 0'a getirmek iÃ§in gereken miktar
                if current_potential > 0:
                    # Pozisyonu 0'a getirmek iÃ§in gereken miktar
                    limit_3_allowed = current_potential
                    limit_3_reason = f"Ters yÃ¶n limiti: Emir {new_order_qty} â†’ {limit_3_allowed:.0f} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ (pozisyon 0'a getirmek iÃ§in, gÃ¼n baÅŸÄ±: {abs_befday:.0f})"
                else:
                    # Zaten short'a geÃ§miÅŸ, emir gÃ¶nderilemez
                    limit_3_allowed = 0
                    limit_3_reason = f"Ters yÃ¶n limiti: Zaten short'a geÃ§ilmiÅŸ, emir engellendi (gÃ¼n baÅŸÄ±: {abs_befday:.0f})"
            elif gÃ¼n_baÅŸÄ±_pozisyon < 0 and potential_position > 0:
                # GÃ¼n baÅŸÄ± short â†’ potansiyel long (ters yÃ¶n)
                # Emir miktarÄ±nÄ± ayarla: pozisyonu 0'a getir ama ters yÃ¶ne geÃ§irme
                # current_potential negatif olmalÄ± (hala short)
                # Emir miktarÄ±: pozisyonu 0'a getirmek iÃ§in gereken miktar
                if current_potential < 0:
                    # Pozisyonu 0'a getirmek iÃ§in gereken miktar (abs ile)
                    limit_3_allowed = abs(current_potential)
                    limit_3_reason = f"Ters yÃ¶n limiti: Emir {new_order_qty} â†’ {limit_3_allowed:.0f} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ (pozisyon 0'a getirmek iÃ§in, gÃ¼n baÅŸÄ±: {abs_befday:.0f})"
                else:
                    # Zaten long'a geÃ§miÅŸ, emir gÃ¶nderilemez
                    limit_3_allowed = 0
                    limit_3_reason = f"Ters yÃ¶n limiti: Zaten long'a geÃ§ilmiÅŸ, emir engellendi (gÃ¼n baÅŸÄ±: {abs_befday:.0f})"
            else:
                # Ters yÃ¶nde geÃ§iÅŸ yok, bu limit geÃ§erli deÄŸil
                limit_3_allowed = new_order_qty  # SÄ±nÄ±rsÄ±z (diÄŸer limitler kontrol edilecek)
                limit_3_reason = f"Ters yÃ¶n kontrolÃ¼ gerekmiyor"
            
            # ÃœÃ§ limitten kÃ¼Ã§Ã¼k olanÄ± seÃ§
            allowed_qty = min(limit_1_allowed, limit_2_allowed, limit_3_allowed, new_order_qty)
            allowed_qty = max(0, allowed_qty)  # Negatif olamaz
            
            if allowed_qty == 0:
                reason = f"MAXALW limiti: {limit_1_reason} | {limit_2_reason} | {limit_3_reason}"
            elif allowed_qty != new_order_qty:
                reason = f"MAXALW limiti: {limit_1_reason} | {limit_2_reason} | {limit_3_reason} â†’ Emir {new_order_qty} â†’ {allowed_qty} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼"
            else:
                reason = f"MAXALW limiti OK: Limit1={limit_1_allowed:.0f}, Limit2={limit_2_allowed:.0f}, Limit3={limit_3_allowed:.0f}"
            
            return allowed_qty, reason
            
        except Exception as e:
            print(f"[CONTROLLER] âŒ MAXALW limit kontrol hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return 0, f"Hata: {e}"
    
    def check_pot_total_limit(self, symbol, order_side, order_qty):
        """
        Pot Toplam limit kontrolÃ¼ - Sadece pozisyon arttÄ±rma emirleri iÃ§in
        
        Returns: (adjusted_qty, reason)
        """
        try:
            # Pot Toplam hesapla
            pot_info = self.calculate_potential_total()
            current_pot_total = pot_info.get('pot_total', 0)
            
            # Pot Max Lot hesapla
            pot_expo_limit = float(self.pot_expo_limit_var.get())
            avg_price = float(self.avg_price_var.get())
            pot_max_lot = int(pot_expo_limit / avg_price)
            
            # Bu emir pozisyon arttÄ±rma mÄ±? (Emir pozisyon arttÄ±rma ise kontrol et)
            # EÄŸer Pot Toplam + Emir > Pot Max Lot ise, emri dÃ¼ÅŸÃ¼r
            new_pot_total = current_pot_total + order_qty
            if new_pot_total > pot_max_lot:
                adjusted_qty = max(0, pot_max_lot - current_pot_total)
                reason = f"Pot Toplam limiti: {current_pot_total:,} + {order_qty:,} = {new_pot_total:,} > {pot_max_lot:,} â†’ Emir {order_qty:,} â†’ {adjusted_qty:,} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼"
                return adjusted_qty, reason
            
            return order_qty, "Pot Toplam limiti OK"
            
        except Exception as e:
            print(f"[CONTROLLER] âŒ Pot Toplam limit kontrol hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return order_qty, f"Hata: {e}"
    
    def check_jfin_daily_change_limit(self, symbol, current_qty, open_orders_qty, order_qty, order_side, gÃ¼n_baÅŸÄ±_pozisyon):
        """
        JFIN Hesaplanan Lot Ã— 2 kontrolÃ¼ - ADDNEWPOS iÃ§in gÃ¼nlÃ¼k deÄŸiÅŸim limiti
        
        Kural: Hesaplanan Lot Ã— 2 > BugÃ¼nkÃ¼ DeÄŸiÅŸim olmalÄ±
        
        Args:
            symbol: Hisse sembolÃ¼
            current_qty: Mevcut pozisyon
            open_orders_qty: AÃ§Ä±k emirler toplamÄ±
            order_qty: Ä°stenen emir miktarÄ±
            order_side: BUY/SELL
            gÃ¼n_baÅŸÄ±_pozisyon: GÃ¼n baÅŸÄ± pozisyon
        
        Returns: (allowed_qty, reason)
        """
        try:
            # FinalThgLotDistributor'dan JFIN hesaplanan lot bilgisini al
            jfin_calculated_lot = 0
            # ADDNEWPOS ÅŸu an sadece BB ile Ã§alÄ±ÅŸÄ±yor, bu yÃ¼zden 'BB' sekmesini kullan
            jfin_tab = 'BB'  # VarsayÄ±lan olarak BB (ADDNEWPOS ÅŸu an sadece BB kullanÄ±yor)
            
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                if hasattr(self.addnewpos_final_thg, 'get_jfin_calculated_lot'):
                    jfin_calculated_lot = self.addnewpos_final_thg.get_jfin_calculated_lot(symbol, order_side, jfin_tab)
            
            # EÄŸer JFIN bilgisi bulunamadÄ±ysa kontrol atla
            if jfin_calculated_lot <= 0:
                return order_qty, "JFIN hesaplanan lot bilgisi bulunamadÄ± - kontrol atlandÄ±"
            
            # Limit = Hesaplanan Lot Ã— 2
            daily_change_limit = jfin_calculated_lot * 2
            
            # Mevcut potansiyel pozisyon (aÃ§Ä±k emirler dahil)
            current_potential = current_qty + open_orders_qty
            
            # BugÃ¼nkÃ¼ deÄŸiÅŸim hesapla (mutlak deÄŸerle)
            if gÃ¼n_baÅŸÄ±_pozisyon is not None:
                bugÃ¼nkÃ¼_deÄŸiÅŸim = abs(current_potential - gÃ¼n_baÅŸÄ±_pozisyon)
            else:
                # GÃ¼n baÅŸÄ± pozisyon bilgisi yoksa, mevcut pozisyonu kullan
                bugÃ¼nkÃ¼_deÄŸiÅŸim = abs(current_potential)
            
            # Yeni emir eklendikten sonra bugÃ¼nkÃ¼ deÄŸiÅŸim
            if order_side.upper() == 'BUY':
                potential_position = current_potential + order_qty
            else:  # SELL
                potential_position = current_potential - order_qty
            
            if gÃ¼n_baÅŸÄ±_pozisyon is not None:
                potential_daily_change = abs(potential_position - gÃ¼n_baÅŸÄ±_pozisyon)
            else:
                potential_daily_change = abs(potential_position)
            
            # Kontrol: Potential Daily Change <= Limit olmalÄ±
            if potential_daily_change > daily_change_limit:
                # Limit aÅŸÄ±lÄ±yor, ne kadar eklenebilir?
                if bugÃ¼nkÃ¼_deÄŸiÅŸim >= daily_change_limit:
                    # Zaten limit dolu
                    allowed_qty = 0
                    reason = f"JFIN gÃ¼nlÃ¼k deÄŸiÅŸim limiti: Zaten limit dolu (BugÃ¼nkÃ¼ deÄŸiÅŸim: {bugÃ¼nkÃ¼_deÄŸiÅŸim:.0f} >= Limit: {daily_change_limit:.0f}, Hesaplanan Lot: {jfin_calculated_lot:.0f})"
                else:
                    # Kalan kapasite
                    remaining_capacity = daily_change_limit - bugÃ¼nkÃ¼_deÄŸiÅŸim
                    
                    # EÄŸer kalan kapasite 200'den azsa, emir gÃ¶nderilmemeli
                    if remaining_capacity < 200:
                        allowed_qty = 0
                        reason = f"JFIN gÃ¼nlÃ¼k deÄŸiÅŸim limiti: Kalan kapasite {remaining_capacity:.0f} < 200 lot - emir engellendi (BugÃ¼nkÃ¼ deÄŸiÅŸim: {bugÃ¼nkÃ¼_deÄŸiÅŸim:.0f}, Limit: {daily_change_limit:.0f}, Hesaplanan Lot: {jfin_calculated_lot:.0f})"
                    else:
                        # Emir miktarÄ±nÄ± kalan kapasiteye gÃ¶re ayarla
                        allowed_qty = min(order_qty, remaining_capacity)
                        if allowed_qty < order_qty:
                            reason = f"JFIN gÃ¼nlÃ¼k deÄŸiÅŸim limiti: Emir {order_qty} â†’ {allowed_qty:.0f} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ (BugÃ¼nkÃ¼ deÄŸiÅŸim: {bugÃ¼nkÃ¼_deÄŸiÅŸim:.0f}, Limit: {daily_change_limit:.0f}, Hesaplanan Lot: {jfin_calculated_lot:.0f})"
                        else:
                            reason = f"JFIN gÃ¼nlÃ¼k deÄŸiÅŸim limiti OK"
            else:
                # Limit iÃ§inde
                allowed_qty = order_qty
                reason = f"JFIN gÃ¼nlÃ¼k deÄŸiÅŸim limiti OK (BugÃ¼nkÃ¼ deÄŸiÅŸim: {bugÃ¼nkÃ¼_deÄŸiÅŸim:.0f}, Limit: {daily_change_limit:.0f}, Hesaplanan Lot: {jfin_calculated_lot:.0f})"
            
            allowed_qty = max(0, allowed_qty)  # Negatif olamaz
            return allowed_qty, reason
            
        except Exception as e:
            print(f"[CONTROLLER] âŒ JFIN gÃ¼nlÃ¼k deÄŸiÅŸim limit kontrol hatasÄ± ({symbol}): {e}")
            import traceback
            traceback.print_exc()
            return order_qty, f"Hata: {e}"
    
    def controller_check_order(self, symbol, order_side, requested_qty, is_reduce_order=False):
        """
        Controller ON iken emir kontrolÃ¼
        
        Args:
            symbol: Sembol
            order_side: "BUY" veya "SELL"
            requested_qty: Ä°stenen emir miktarÄ±
            is_reduce_order: True ise pozisyon AZALTMA emri (KARBOTU/REDUCEMORE), False ise pozisyon ARTIRMA emri
        
        Returns: (allowed, adjusted_qty, reason)
        """
        try:
            # Controller kapalÄ±ysa kontrol yapma
            if not hasattr(self, 'controller_enabled') or not self.controller_enabled:
                return True, requested_qty, "Controller kapalÄ±"
            
            # Aktif hesaptan mevcut pozisyonu al
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            # Mevcut pozisyonu bul (cache'lenmiÅŸ pozisyonlardan)
            current_qty = 0
            positions = self.get_cached_positions(active_account)
            
            # Symbol'e gÃ¶re pozisyonu bul
            for pos in positions:
                pos_symbol = pos.get('symbol') or pos.get('Symbol', '')
                if pos_symbol == symbol:
                    current_qty = pos.get('quantity', 0) or pos.get('qty', 0) or 0
                    break
            
            # AÃ§Ä±k emirler toplamÄ± (cache'lenmiÅŸ emirlerden)
            open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
            
            # GÃ¼n baÅŸÄ± pozisyon
            gÃ¼n_baÅŸÄ±_pozisyon = self.load_bef_position(symbol)
            
            # MAXALW deÄŸeri
            maxalw = self.get_maxalw_for_symbol(symbol)
            if maxalw <= 0:
                print(f"[CONTROLLER] âš ï¸ {symbol} iÃ§in MAXALW deÄŸeri bulunamadÄ±")
                return True, requested_qty, "MAXALW deÄŸeri bulunamadÄ± - kontrol atlandÄ±"
            
            # 1. POZISYON TÃœRÃœ KONTROLÃœ (GÃ¼n baÅŸÄ± pozisyon bazÄ±nda, aÃ§Ä±k emirler dahil)
            pos_allowed, pos_adjusted_qty, needs_rounding, pos_reason = self.check_position_direction_change(
                current_qty, order_side, requested_qty, gÃ¼n_baÅŸÄ±_pozisyon, open_orders_qty
            )
            
            # 2. MAXALW LÄ°MÄ°TLERÄ° KONTROLÃœ
            # POZISYON AZALTMA (KARBOTU/REDUCEMORE) durumunda toplam pozisyon limiti kontrolÃ¼ YAPILMAZ
            # Ã‡Ã¼nkÃ¼ zaten pozisyonu azaltmak istiyoruz, MAXALW Ã¼zerinde olmasÄ± sorun deÄŸil
            maxalw_allowed_qty, maxalw_reason = self.check_maxalw_limits(
                symbol, current_qty, open_orders_qty, pos_adjusted_qty, order_side, gÃ¼n_baÅŸÄ±_pozisyon, maxalw, is_reduce_order=is_reduce_order
            )
            
            # 3. POT TOPLAM LÄ°MÄ°T KONTROLÃœ (sadece pozisyon arttÄ±rma emirleri iÃ§in)
            # Emir pozisyon arttÄ±rma mÄ± kontrol et
            is_position_increase = False
            if order_side == 'BUY' and current_qty >= 0:
                # Long pozisyon var veya 0, BUY emri arttÄ±rma
                is_position_increase = True
            elif order_side == 'SELL' and current_qty < 0:
                # Short pozisyon var, SELL emri arttÄ±rma (short artar)
                is_position_increase = True
            
            pot_allowed_qty = maxalw_allowed_qty
            pot_reason = ""
            if is_position_increase:
                pot_allowed_qty, pot_reason = self.check_pot_total_limit(symbol, order_side, maxalw_allowed_qty)
            
            # 3.5. JFIN HESAPLANAN LOT Ã— 2 KONTROLÃœ (ADDNEWPOS iÃ§in - sadece pozisyon arttÄ±rma emirleri iÃ§in)
            jfin_allowed_qty = pot_allowed_qty
            jfin_reason = ""
            if is_position_increase:
                # ADDNEWPOS durumunda mÄ± kontrol et (RUNALL Ã§alÄ±ÅŸÄ±yorsa ve ADDNEWPOS baÅŸlatÄ±ldÄ±ysa)
                is_addnewpos = (hasattr(self, 'runall_loop_running') and self.runall_loop_running) or \
                              (hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started)
                
                if is_addnewpos:
                    jfin_allowed_qty, jfin_reason = self.check_jfin_daily_change_limit(
                        symbol, current_qty, open_orders_qty, pot_allowed_qty, order_side, gÃ¼n_baÅŸÄ±_pozisyon
                    )
            
            # 4. FÄ°NAL EMÄ°R MÄ°KTARI
            final_qty = min(pos_adjusted_qty, maxalw_allowed_qty, pot_allowed_qty, jfin_allowed_qty)
            final_qty = max(0, final_qty)  # Negatif olamaz
            
            # 4. YUVARLAMA KARARI
            if needs_rounding and final_qty == requested_qty:
                # Normal durum: Yuvarlama yapÄ±labilir (KARBOTU/REDUCEMORE kurallarÄ±)
                # Burada yuvarlama fonksiyonu Ã§aÄŸrÄ±labilir (opsiyonel)
                final_qty = int(final_qty)  # Åimdilik tam sayÄ±
            else:
                # GeÃ§iÅŸ durumu: Yuvarlama YOK, tam lot
                final_qty = int(final_qty)  # Tam lot (Ã¶rn: 330)
            
            # SonuÃ§
            if final_qty == 0:
                reason_parts = [pos_reason, maxalw_reason]
                if pot_reason:
                    reason_parts.append(pot_reason)
                if jfin_reason:
                    reason_parts.append(jfin_reason)
                return False, 0, f"Emir engellendi: {' | '.join(reason_parts)}"
            elif final_qty != requested_qty:
                reason_parts = [pos_reason, maxalw_reason]
                if pot_reason:
                    reason_parts.append(pot_reason)
                if jfin_reason:
                    reason_parts.append(jfin_reason)
                return True, final_qty, f"Emir ayarlandÄ±: {requested_qty} â†’ {final_qty} | {' | '.join(reason_parts)}"
            else:
                reason_parts = [pos_reason, maxalw_reason]
                if pot_reason:
                    reason_parts.append(pot_reason)
                if jfin_reason:
                    reason_parts.append(jfin_reason)
                return True, final_qty, f"Emir onaylandÄ±: {' | '.join(reason_parts)}"
                
        except Exception as e:
            print(f"[CONTROLLER] âŒ Emir kontrol hatasÄ± ({symbol}): {e}")
            import traceback
            traceback.print_exc()
            return True, requested_qty, f"Hata: {e}"
    
    def start_psfalgo_monitoring(self):
        """Psfalgo robotunu baÅŸlat"""
        self.psfalgo_running = True
        self.start_btn.config(state='disabled')
        self.stop_btn.config(state='normal')
        self.status_label.config(text="Durum: Ã‡alÄ±ÅŸÄ±yor")
        
        self.log_message("OK Psfalgo robot baslatildi")
        
        # Otomatik: Take Profit Longs akÄ±ÅŸÄ±nÄ± baÅŸlat
        try:
            self.auto_take_profit_longs_selection()
        except Exception as e:
            self.log_message(f"ERROR TP Longs otomasyonu: {e}")
        
        # Robot dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
        self.psfalgo_monitoring_loop()
    
    def stop_psfalgo_monitoring(self):
        """Psfalgo robotunu durdur"""
        self.psfalgo_running = False
        self.start_btn.config(state='normal')
        self.stop_btn.config(state='disabled')
        self.status_label.config(text="Durum: Durduruldu")
        
        self.log_message("â¹ï¸ Psfalgo robot durduruldu")
    
    def psfalgo_monitoring_loop(self):
        """Psfalgo robot ana dÃ¶ngÃ¼sÃ¼ - Exposure kontrolÃ¼ ile"""
        if not self.psfalgo_running:
            return
        
        # Pencere hala var mÄ± kontrol et
        if not hasattr(self, 'psfalgo_window') or not self.psfalgo_window:
            return
        
        try:
            # Exposure kontrolÃ¼ yap (thread'de, UI'Ä± bloklamaz)
            self.check_exposure_limits_async(callback=lambda exposure_info: (
                self.after(0, lambda: self._process_exposure_info(exposure_info))
            ))
            
            # Pot Toplam kontrolÃ¼ (Controller ON ise ve 60 saniyede bir)
            if hasattr(self, 'controller_enabled') and self.controller_enabled:
                pot_info = self.calculate_potential_total()
                pot_total = pot_info.get('pot_total', 0)
                pot_max_lot = int(float(self.pot_expo_limit_var.get()) / float(self.avg_price_var.get()))
                
                # ADDNEWPOS butonu durumu
                if current_mode == "OFANSIF" and pot_total < pot_max_lot:
                    if hasattr(self, 'addnewpos_btn'):
                        self.addnewpos_btn.config(state='normal')
                else:
                    if hasattr(self, 'addnewpos_btn'):
                        self.addnewpos_btn.config(state='disabled')
            
            # Mod kontrolÃ¼
            if current_mode == "DEFANSIVE":
                self.log_message(f"ğŸ›¡ï¸ DEFANSIVE MOD: Sadece KARBOTU iÅŸlemleri yapÄ±labilir (pozisyon artÄ±rma yasak)")
            elif current_mode == "OFANSIF":
                self.log_message(f"âš¡ OFANSIF MOD: Hem KARBOTU hem ADDPOS iÅŸlemleri yapÄ±labilir")
            else:
                self.log_message(f"ğŸ”¶ GEÃ‡IÅ MOD: Dikkatli ilerle")
            
            # 60 saniye sonra tekrar Ã§alÄ±ÅŸtÄ±r (Controller ON ise daha sÄ±k kontrol)
            # Ama pozisyon gÃ¼ncellemesi cache'den alÄ±nacak, bu yÃ¼zden daha sÄ±k Ã§alÄ±ÅŸabilir
            interval = 60000 if (hasattr(self, 'controller_enabled') and self.controller_enabled) else 300000
            self.psfalgo_window.after(interval, self.psfalgo_monitoring_loop)
            
        except Exception as e:
            self.log_message(f"âŒ Robot dÃ¶ngÃ¼ hatasÄ±: {e}")
            # Hata olsa bile devam et
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                self.psfalgo_window.after(300000, self.psfalgo_monitoring_loop)

    def auto_take_profit_longs_selection(self):
        """Take Profit Longs penceresini aÃ§, filtrele ve Ask Sell onay penceresini hazÄ±rla"""
        try:
            from .take_profit_panel import TakeProfitPanel
            panel = TakeProfitPanel(self, "longs")

            def do_select_and_open():
                try:
                    # Table hazÄ±r mÄ±? deÄŸilse tekrar dene
                    if len(panel.tree.get_children()) == 0 or not hasattr(panel, 'positions') or not panel.positions:
                        panel.win.after(400, do_select_and_open)
                        return
                    # SeÃ§imleri temizle
                    try:
                        panel.deselect_all_positions()
                    except Exception:
                        pass

                    selected_any = False
                    for item in panel.tree.get_children():
                        try:
                            symbol = panel.tree.set(item, 'symbol')
                            qty_str = panel.tree.set(item, 'qty')
                            fbtot_str = panel.tree.set(item, 'fbtot')

                            # Miktar
                            try:
                                qty = float(qty_str)
                            except Exception:
                                qty = 0.0

                            # FBtot (N/A veya boÅŸ ise atla)
                            # Fbtot: N/A/boÅŸ/0.00 olanlarÄ± atla
                            try:
                                fbtot_val = float(fbtot_str)
                                if fbtot_val == 0.0:
                                    continue
                            except Exception:
                                continue

                            if qty >= 100 and fbtot_val < 1.60:
                                panel.tree.set(item, 'select', 'âœ“')
                                # SatÄ±r deÄŸerlerinden avg_cost ve qty'yi alÄ±p sÃ¶zlÃ¼ÄŸe yaz
                                values = panel.tree.item(item)['values']
                                try:
                                    avg_cost_str = values[3]
                                    if isinstance(avg_cost_str, str):
                                        avg_cost_clean = avg_cost_str.replace('$', '').replace(',', '').strip()
                                        avg_cost = float(avg_cost_clean) if avg_cost_clean else 0.0
                                    else:
                                        avg_cost = float(avg_cost_str)
                                except Exception:
                                    avg_cost = 0.0
                                panel.selected_positions[symbol] = { 'avg_cost': avg_cost, 'qty': qty }
                                selected_any = True
                        except Exception:
                            continue

                    panel.update_selection_count()

                    if not selected_any:
                        self.log_message("INFO TP Longs: Kriterlere uyan pozisyon bulunamadÄ± (qty>=100, fbtot<1.60)")
                        return

                    # %50 lot ayarla ve Ask Sell onay penceresini aÃ§
                    panel.set_lot_percentage(50)
                    panel.place_orders("Ask Sell")
                except Exception as e:
                    self.log_message(f"ERROR TP Longs secim/ackis: {e}")

            # Panel oluÅŸtuktan sonra kÄ±sa gecikmeyle Ã§alÄ±ÅŸtÄ±r (UI hazÄ±r olsun)
            panel.win.after(600, do_select_and_open)
        except Exception as e:
            self.log_message(f"ERROR TP Longs otomasyon init: {e}")
    
    def check_exposure_limits_async(self, callback=None):
        """Exposure limitlerini thread'de kontrol et (UI'Ä± bloklamaz)"""
        import threading
        thread = threading.Thread(target=self._check_exposure_limits_thread, args=(callback,), daemon=True)
        thread.start()
    
    def check_exposure_limits(self):
        """Exposure limitlerini kontrol et - Senkron versiyon (geriye uyumluluk iÃ§in)"""
        import queue
        result_queue = queue.Queue()
        self.check_exposure_limits_async(callback=lambda info: result_queue.put(info))
        try:
            return result_queue.get(timeout=10)  # 10 saniye timeout
        except queue.Empty:
            return {'mode': 'ERROR', 'can_add_positions': False}
    
    def _check_exposure_limits_thread(self, callback=None):
        """Thread'de exposure limitlerini kontrol et - TÃ¼m bloklayan iÅŸlemler burada"""
        try:
            # Exposure parametrelerini al
            exposure_limit = float(self.exposure_limit_var.get())
            avg_price = float(self.avg_price_var.get())
            
            # Max lot hesapla
            max_lot = int(exposure_limit / avg_price)
            defensive_threshold = int(max_lot * 0.955)  # %95.5
            offensive_threshold = int(max_lot * 0.927)  # %92.7
            
            # Aktif mod bilgisi
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            # Log mesajlarÄ±nÄ± topla (main thread'de gÃ¶sterilecek)
            log_messages = [f"ğŸ“Š Exposure kontrolÃ¼ baÅŸlatÄ±ldÄ± - Aktif hesap: {active_account}"]
            
            # Aktif hesaptan pozisyonlarÄ± al (cache'den veya direkt - lock ile)
            import threading
            if not hasattr(self, '_positions_lock'):
                self._positions_lock = threading.Lock()
            
            positions = []
            with self._positions_lock:
                # Ã–nce cache'den kontrol et (5 saniye iÃ§inde Ã§ekilmiÅŸse cache'den kullan)
                import time
                cache_key = active_account
                current_time = time.time()
                
                if (hasattr(self, 'positions_cache') and 
                    cache_key in self.positions_cache and
                    hasattr(self, 'positions_cache_time') and
                    cache_key in self.positions_cache_time and
                    (current_time - self.positions_cache_time.get(cache_key, 0)) < 5.0):  # 5 saniye cache
                    positions = self.positions_cache[cache_key].copy()  # Copy yap ki deÄŸiÅŸmesin
                    log_messages.append(f"âœ… {active_account}: {len(positions)} pozisyon cache'den alÄ±ndÄ±")
                else:
                    # Cache yok veya eski, yeni pozisyon Ã§ek
                    if active_account == "HAMPRO":
                        # HAMPRO mod kontrolÃ¼
                        if not self.hammer or not self.hammer.connected:
                            error_result = {'mode': 'ERROR', 'can_add_positions': False}
                            self.after(0, lambda: (
                                self.log_message("âš ï¸ HAMPRO baÄŸlantÄ±sÄ± yok!"),
                                self.current_lot_label.config(text="HAMPRO baÄŸlantÄ±sÄ± yok!", foreground='red')
                            ))
                            if callback:
                                callback(error_result)
                            return
                        
                        positions = self.hammer.get_positions_direct()
                        log_messages.append(f"âœ… HAMPRO'dan {len(positions)} pozisyon alÄ±ndÄ±")
                        
                    elif active_account in ["IBKR_GUN", "IBKR_PED"]:
                        # IBKR mod kontrolÃ¼ (GUN veya PED)
                        if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                            positions = self.mode_manager.ibkr_native_client.get_positions()
                            log_messages.append(f"âœ… IBKR Native'dan {len(positions)} pozisyon alÄ±ndÄ± ({active_account})")
                        elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                            positions = self.mode_manager.ibkr_client.get_positions()
                            log_messages.append(f"âœ… IBKR Client'dan {len(positions)} pozisyon alÄ±ndÄ± ({active_account})")
                        else:
                            error_result = {'mode': 'ERROR', 'can_add_positions': False}
                            self.after(0, lambda: (
                                self.log_message(f"âš ï¸ IBKR baÄŸlantÄ±sÄ± yok! ({active_account})"),
                                self.current_lot_label.config(text=f"IBKR baÄŸlantÄ±sÄ± yok! ({active_account})", foreground='red')
                            ))
                            if callback:
                                callback(error_result)
                            return
                    else:
                        # Bilinmeyen mod
                        error_result = {'mode': 'ERROR', 'can_add_positions': False}
                        self.after(0, lambda: self.log_message(f"âš ï¸ Bilinmeyen mod: {active_account}"))
                        if callback:
                            callback(error_result)
                        return
                    
                    # Cache'i gÃ¼ncelle (sadece pozisyonlar baÅŸarÄ±yla Ã§ekildiyse)
                    if not hasattr(self, 'positions_cache'):
                        self.positions_cache = {}
                    if not hasattr(self, 'positions_cache_time'):
                        self.positions_cache_time = {}
                    self.positions_cache[cache_key] = positions.copy()  # Copy yap
                    self.positions_cache_time[cache_key] = current_time
            
            # Duplicate pozisyonlarÄ± filtrele (aynÄ± symbol iÃ§in sadece bir pozisyon)
            unique_positions = {}
            for pos in positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '') or pos.get('ticker', '') or pos.get('Ticker', '')
                if not symbol:
                    continue
                
                # EÄŸer bu symbol zaten varsa, quantity'leri topla (duplicate pozisyonlarÄ± birleÅŸtir)
                qty_value = pos.get('quantity') or pos.get('qty') or pos.get('Quantity')
                if qty_value is None:
                    continue
                
                try:
                    qty = float(qty_value)
                except (ValueError, TypeError):
                    continue
                
                if symbol in unique_positions:
                    # Duplicate pozisyon - quantity'leri topla
                    unique_positions[symbol] += qty
                else:
                    unique_positions[symbol] = qty
            
            # Toplam lot hesapla (long pozisyonlar + abs(short pozisyonlar))
            total_lots = 0
            long_lots = 0
            short_lots = 0
            
            # Debug: Ä°lk 3 pozisyonun yapÄ±sÄ±nÄ± gÃ¶ster
            if len(positions) > 0:
                log_messages.append(f"ğŸ” Ä°lk pozisyon Ã¶rneÄŸi: {positions[0]}")
            
            # Unique pozisyonlarÄ± say
            for symbol, qty in unique_positions.items():
                try:
                    qty_int = int(qty)
                except (ValueError, TypeError):
                    continue
                
                if qty_int > 0:
                    long_lots += qty_int
                elif qty_int < 0:
                    short_lots += abs(qty_int)
                
                total_lots += abs(qty_int)
            
            # Duplicate pozisyon uyarÄ±sÄ±
            if len(positions) != len(unique_positions):
                log_messages.append(f"âš ï¸ {len(positions) - len(unique_positions)} duplicate pozisyon birleÅŸtirildi")
            
            # Modu belirle
            if total_lots > defensive_threshold:
                mode = "DEFANSIVE"  # Sadece KARBOTU
                mode_color = 'red'
            elif total_lots < offensive_threshold:
                mode = "OFANSIF"  # Hem KARBOTU hem ADDPOS
                mode_color = 'green'
            else:
                mode = "GEÃ‡IÅ"  # GeÃ§iÅŸ modu
                mode_color = 'orange'
            
            # Pot Toplam hesapla (Controller ON ise)
            pot_total = 0
            if hasattr(self, 'controller_enabled') and self.controller_enabled:
                pot_info = self.calculate_potential_total()
                pot_total = pot_info.get('pot_total', total_lots)
                log_messages.append(f"ğŸ“Š Pot Toplam: {pot_total:,} lot (Mevcut: {total_lots:,}, ArttÄ±rma: {pot_info.get('pot_increase', 0):,}, Azaltma: {pot_info.get('pot_decrease', 0):,})")
            
            # Pot Max Lot hesapla
            pot_expo_limit = float(self.pot_expo_limit_var.get())
            pot_max_lot = int(pot_expo_limit / avg_price)
            
            # SonuÃ§ verisini hazÄ±rla
            result = {
                'mode': mode,
                'total_lots': total_lots,
                'long_lots': long_lots,
                'short_lots': short_lots,
                'max_lot': max_lot,
                'pot_max_lot': pot_max_lot,
                'pot_total': pot_total,
                'defensive_threshold': defensive_threshold,
                'offensive_threshold': offensive_threshold,
                'can_add_positions': (mode == "OFANSIF" or mode == "GEÃ‡IÅ"),
                'active_account': active_account,
                'mode_color': mode_color,
                'log_messages': log_messages
            }
            
            # UI gÃ¼ncellemelerini main thread'de yap
            self.after(0, lambda: self._update_ui_with_exposure_info(result))
            
            # Callback'i Ã§aÄŸÄ±r (varsa)
            if callback:
                callback(result)
            
        except Exception as e:
            # Hata mesajÄ±nÄ± da main thread'de gÃ¶ster
            error_result = {'mode': 'ERROR', 'can_add_positions': False}
            self.after(0, lambda: self.log_message(f"âŒ Exposure kontrol hatasÄ±: {e}"))
            if callback:
                callback(error_result)
            import traceback
            traceback.print_exc()
    
    def _update_ui_with_exposure_info(self, result):
        """UI'Ä± exposure bilgileri ile gÃ¼ncelle (main thread'de Ã§alÄ±ÅŸÄ±r)"""
        try:
            mode = result['mode']
            mode_color = result['mode_color']
            total_lots = result['total_lots']
            long_lots = result['long_lots']
            short_lots = result['short_lots']
            pot_total = result['pot_total']
            active_account = result['active_account']
            max_lot = result['max_lot']
            defensive_threshold = result['defensive_threshold']
            offensive_threshold = result['offensive_threshold']
            log_messages = result.get('log_messages', [])
            
            # Log mesajlarÄ±nÄ± gÃ¶ster
            for msg in log_messages:
                self.log_message(msg)
            
            # UI gÃ¼ncelle
            if pot_total > 0:
                self.current_lot_label.config(
                    text=f"Hesap: {active_account} | Long: {long_lots:,} | Short: {short_lots:,} | Toplam: {total_lots:,} | Pot Toplam: {pot_total:,} | Mode: {mode}", 
                    foreground=mode_color
                )
            else:
                self.current_lot_label.config(
                    text=f"Hesap: {active_account} | Long: {long_lots:,} | Short: {short_lots:,} | Toplam: {total_lots:,} | Mode: {mode}", 
                    foreground=mode_color
                )
            
            # DetaylÄ± log
            self.log_message(f"ğŸ’° Exposure: {total_lots:,} / {max_lot:,} lot ({total_lots/max_lot*100:.1f}%) | Mode: {mode}")
            self.log_message(f"ğŸ“ˆ Long: {long_lots:,} lot | Short: {short_lots:,} lot | Toplam: {total_lots:,} lot")
            self.log_message(f"ğŸ¯ EÅŸikler: Defansif={defensive_threshold:,} lot (%95.5) | Ofansif dÃ¶nÃ¼ÅŸ={offensive_threshold:,} lot (%92.7)")
            
        except Exception as e:
            self.log_message(f"âŒ UI gÃ¼ncelleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def _process_exposure_info(self, exposure_info):
        """Exposure bilgisini iÅŸle ve pozisyonlarÄ± gÃ¼ncelle"""
        try:
            current_mode = exposure_info.get('mode', 'UNKNOWN')
            can_add_positions = exposure_info.get('can_add_positions', False)
            
            # PozisyonlarÄ± gÃ¼ncelle (thread'de, UI'Ä± bloklamaz)
            self.update_psfalgo_positions_async()
            
            # DiÄŸer iÅŸlemler burada devam edebilir...
            
        except Exception as e:
            self.log_message(f"âŒ Exposure bilgisi iÅŸleme hatasÄ±: {e}")
    
    def update_psfalgo_positions_async(self):
        """Psfalgo pozisyonlarÄ±nÄ± thread'de gÃ¼ncelle (UI'Ä± bloklamaz)"""
        import threading
        thread = threading.Thread(target=self._update_psfalgo_positions_thread, daemon=True)
        thread.start()
    
    def _update_psfalgo_positions_thread(self):
        """Thread'de pozisyon gÃ¼ncellemesi yap - TÃ¼m bloklayan iÅŸlemler burada"""
        try:
            # Aktif modu kontrol et
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            # Aktif moda gÃ¶re pozisyonlarÄ± al
            if active_account in ["IBKR_GUN", "IBKR_PED"]:
                # IBKR pozisyonlarÄ±nÄ± al (GUN veya PED)
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                    current_positions = self.mode_manager.ibkr_native_client.get_positions()
                elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                    current_positions = self.mode_manager.ibkr_client.get_positions()
                else:
                    current_positions = []
            else:  # HAMPRO
                # HAMPRO pozisyonlarÄ±nÄ± al
                if self.hammer and self.hammer.connected:
                    current_positions = self.hammer.get_positions_direct()
                    # Log mesajlarÄ±nÄ± main thread'de gÃ¶ster
                    self.after(0, lambda: self.log_message(f"ğŸ”„ update_psfalgo_positions: {len(current_positions)} pozisyon alÄ±ndÄ±"))
                    if current_positions:
                        self.after(0, lambda: self.log_message(f"ğŸ” update_psfalgo_positions: Ä°lk pozisyon Ã¶rneÄŸi: {current_positions[0]}"))
                else:
                    current_positions = []
                    self.after(0, lambda: self.log_message("âŒ update_psfalgo_positions: HAMPRO baÄŸlantÄ±sÄ± yok!"))
            
            if not current_positions:
                # Log mesajÄ±nÄ± main thread'de gÃ¶ster
                self.after(0, lambda: self.log_message("âš ï¸ update_psfalgo_positions: Pozisyon bulunamadÄ±!"))
                return
            
            # GÃ¼ncelleme verilerini topla (UI gÃ¼ncellemesi iÃ§in)
            update_data = []
            log_messages = []
            
            # PozisyonlarÄ± gÃ¼ncelle (thread'de tÃ¼m hesaplamalarÄ± yap)
            for pos in current_positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '')
                current_qty = pos.get('quantity', None) or pos.get('qty', None) or pos.get('Quantity', 0)
                if current_qty is None:
                    current_qty = 0
                
                if symbol in self.psfalgo_positions:
                    old_qty = self.psfalgo_positions[symbol]['quantity']
                    change = current_qty - old_qty
                    
                    # EÄŸer deÄŸiÅŸim varsa, kontrolleri yap (thread'de)
                    if change != 0:
                        # Pozisyon deÄŸiÅŸim tÃ¼rÃ¼nÃ¼ belirle
                        change_type, change_amount = self.determine_position_change_type(symbol, old_qty, current_qty)
                        
                        # MAXALW limitini kontrol et
                        maxalw_ok, maxalw_msg = self.check_maxalw_limit(symbol, change_type, change_amount)
                        
                        # 3 saatlik limiti kontrol et
                        three_hour_ok, three_hour_msg = self.check_three_hour_limit(symbol, change_amount)
                        
                        # Log mesajlarÄ±nÄ± topla
                        log_messages.append(f"ğŸ“Š {symbol}: {change_type} ({change_amount:+.0f})")
                        log_messages.append(f"   MAXALW: {maxalw_msg}")
                        log_messages.append(f"   3H: {three_hour_msg}")
                        
                        # EÄŸer limitler aÅŸÄ±ldÄ±ysa uyarÄ± ver
                        if not maxalw_ok or not three_hour_ok:
                            log_messages.append(f"âš ï¸ {symbol} LÄ°MÄ°T AÅILDI!")
                    
                    # AÃ§Ä±k emirleri kontrol et (cache'den, hÄ±zlÄ±)
                    open_orders_count = self.get_open_orders_count(symbol, use_cache=True)
                    if open_orders_count > 0:
                        log_messages.append(f"ğŸ“‹ {symbol}: {open_orders_count} aÃ§Ä±k emir mevcut")
                    
                    # Emir analizi yap (cache'den, hÄ±zlÄ±)
                    order_analysis = self.analyze_order_impact(symbol, current_qty)
                    if order_analysis['long_increase_orders'] > 0 or order_analysis['long_decrease_orders'] > 0 or order_analysis['short_increase_orders'] > 0 or order_analysis['short_decrease_orders'] > 0:
                        log_messages.append(f"ğŸ“Š {symbol} Emir Analizi:")
                        log_messages.append(f"   Long ArtÄ±rma: {order_analysis['long_increase_orders']}")
                        log_messages.append(f"   Long Azaltma: {order_analysis['long_decrease_orders']}")
                        log_messages.append(f"   Short ArtÄ±rma: {order_analysis['short_increase_orders']}")
                        log_messages.append(f"   Short Azaltma: {order_analysis['short_decrease_orders']}")
                        log_messages.append(f"   Potansiyel Pozisyon: {order_analysis['potential_position']}")
                        log_messages.append(f"   Max Ek Long: {order_analysis['max_additional_long']}")
                        log_messages.append(f"   Max Ek Short: {order_analysis['max_additional_short']}")
                        
                        # MAXALW kontrolÃ¼ (CSV okuma thread'de)
                        maxalw = self.get_maxalw_for_symbol(symbol)
                        if abs(order_analysis['potential_position']) > maxalw:
                            log_messages.append(f"âš ï¸ {symbol} MAXALW AÅILDI! Potansiyel: {abs(order_analysis['potential_position'])} > {maxalw}")
                    
                    # GÃ¼ncelleme verisini topla
                    update_data.append({
                        'symbol': symbol,
                        'current_qty': current_qty,
                        'change': change,
                        'old_qty': old_qty
                    })
            
            # UI gÃ¼ncellemelerini main thread'de yap
            self.after(0, lambda: self._update_ui_with_position_updates(update_data, log_messages))
            
        except Exception as e:
            # Hata mesajÄ±nÄ± da main thread'de gÃ¶ster
            self.after(0, lambda: self.log_message(f"âŒ Pozisyon gÃ¼ncelleme hatasÄ±: {e}"))
            import traceback
            traceback.print_exc()
    
    def _update_ui_with_position_updates(self, update_data, log_messages):
        """UI'Ä± pozisyon gÃ¼ncellemeleri ile gÃ¼ncelle (main thread'de Ã§alÄ±ÅŸÄ±r)"""
        try:
            # Log mesajlarÄ±nÄ± gÃ¶ster
            for msg in log_messages:
                self.log_message(msg)
            
            # PozisyonlarÄ± gÃ¼ncelle
            for data in update_data:
                symbol = data['symbol']
                current_qty = data['current_qty']
                change = data['change']
                old_qty = data['old_qty']
                
                # Pozisyon deÄŸiÅŸimini kaydet
                if symbol in self.psfalgo_positions:
                    self.psfalgo_positions[symbol]['quantity'] = current_qty
                    self.psfalgo_positions[symbol]['three_hour_change'] += change
                    
                    # Tabloyu gÃ¼ncelle
                    self.update_psfalgo_table_row(symbol, current_qty, change)
                    
        except Exception as e:
            self.log_message(f"âŒ UI gÃ¼ncelleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def update_psfalgo_table_row(self, symbol, quantity, change):
        """Psfalgo tablosundaki satÄ±rÄ± gÃ¼ncelle
        
        Kolon sÄ±rasÄ±:
        0: Symbol, 1: Current Qty, 2: Potential Qty, 3: Befday Cost, 4: Todays Cost, 
        5: Last Price, 6: Befday Qty, 7: Todays Qty Chg, 8: Max Change, 9: MAXALW, 
        10: 3H Change, 11: Open Orders, 12: Max Add Long, 13: Max Add Short, 14: Status
        """
        try:
            for item in self.psfalgo_tree.get_children():
                values = self.psfalgo_tree.item(item)['values']
                if values[0] == symbol:
                    # SatÄ±rÄ± gÃ¼ncelle
                    new_values = list(values)
                    
                    # GÃ¼n baÅŸÄ± pozisyonu al
                    befday_qty = self.psfalgo_positions[symbol].get('befday_qty', 0)
                    if befday_qty == 0:
                        befday_qty = self.load_bef_position(symbol)
                        self.psfalgo_positions[symbol]['befday_qty'] = befday_qty
                    
                    # BugÃ¼nkÃ¼ deÄŸiÅŸim hesapla
                    todays_qty_chg = quantity - befday_qty
                    self.psfalgo_positions[symbol]['todays_qty_chg'] = todays_qty_chg
                    
                    # Short pozisyonlarÄ± eksi ile gÃ¶ster
                    new_values[1] = f"{quantity:.0f}"  # Current Qty
                    
                    # Emir analizi yap
                    order_analysis = self.analyze_order_impact(symbol, quantity)
                    new_values[2] = f"{order_analysis['potential_position']:.0f}"  # Potansiyel pozisyon
                    
                    # Befday Cost (prev_close) gÃ¼ncelle
                    befday_cost = self.get_prev_close_for_psfalgo(symbol)
                    new_values[3] = f"${befday_cost:.2f}" if befday_cost > 0 else "N/A"  # Befday Cost
                    self.psfalgo_positions[symbol]['befday_cost'] = befday_cost
                    
                    # Todays Cost gÃ¼ncelle (bugÃ¼nkÃ¼ ortalama maliyet)
                    todays_cost = self.get_todays_cost_for_psfalgo(symbol, quantity, befday_qty)
                    new_values[4] = f"${todays_cost:.2f}" if todays_cost > 0 else ""  # Todays Cost
                    self.psfalgo_positions[symbol]['todays_cost'] = todays_cost
                    
                    # Last Price gÃ¼ncelle
                    last_price = self.get_last_price_for_psfalgo(symbol)
                    new_values[5] = f"${last_price:.2f}" if last_price > 0 else "N/A"  # Last Price
                    self.psfalgo_positions[symbol]['last_price'] = last_price
                    
                    new_values[6] = f"{befday_qty:.0f}"  # Befday Qty
                    new_values[7] = f"{todays_qty_chg:+.0f}"  # Todays Qty Chg
                    
                    # Max Change gÃ¼ncelle (MAXALW * rule_max_change_multiplier)
                    maxalw = self.psfalgo_positions[symbol]['maxalw']
                    multiplier = getattr(self, 'rule_max_change_multiplier', 0.75)
                    max_change = int(maxalw * multiplier) if maxalw > 0 else 0
                    new_values[8] = f"{max_change}"  # Max Change
                    new_values[9] = f"{maxalw:.0f}"  # MAXALW
                    
                    new_values[10] = f"{self.psfalgo_positions[symbol]['three_hour_change']:.0f}"  # 3H Change
                    
                    # AÃ§Ä±k emirleri gÃ¼ncelle
                    open_orders_count = self.get_open_orders_count(symbol)
                    new_values[11] = f"{open_orders_count}"  # Open Orders
                    
                    new_values[12] = f"{order_analysis['max_additional_long']:.0f}"  # Max ek long
                    new_values[13] = f"{order_analysis['max_additional_short']:.0f}"  # Max ek short
                    
                    # Durum kontrolÃ¼
                    max_change = self.psfalgo_positions[symbol]['max_change']
                    three_hour_change = abs(self.psfalgo_positions[symbol]['three_hour_change'])
                    
                    # Potansiyel pozisyon MAXALW kontrolÃ¼
                    maxalw = self.psfalgo_positions[symbol]['maxalw']
                    potential_position = order_analysis['potential_position']
                    
                    # GÃ¼n baÅŸÄ± pozisyon tÃ¼rÃ¼ kontrolÃ¼
                    befday_qty = self.psfalgo_positions[symbol].get('befday_qty', 0)
                    position_type_violation = False
                    if befday_qty > 0 and potential_position < 0:
                        position_type_violation = True
                    elif befday_qty < 0 and potential_position > 0:
                        position_type_violation = True
                    
                    if position_type_violation:
                        new_values[14] = "âš ï¸ Pozisyon TÃ¼rÃ¼ Ä°hlali"
                    elif abs(potential_position) > maxalw:
                        new_values[14] = "âš ï¸ MAXALW AÅŸÄ±ldÄ±"
                    elif three_hour_change > max_change:
                        new_values[14] = "âš ï¸ 3H Limit AÅŸÄ±ldÄ±"
                    else:
                        new_values[14] = "âœ… Normal"
                    
                    self.psfalgo_tree.item(item, values=new_values)
                    break
                    
        except Exception as e:
            self.log_message(f"âŒ Tablo gÃ¼ncelleme hatasÄ±: {e}")
    
    def get_cached_orders(self):
        """Cache'lenmiÅŸ emirleri al veya gÃ¼ncelle (60 saniyede bir)"""
        try:
            import time
            current_time = time.time()
            
            # Cache sÃ¼resi dolmuÅŸ mu kontrol et (60 saniye)
            if current_time - self.orders_cache_time > self.orders_cache_interval:
                # Cache'i gÃ¼ncelle
                if hasattr(self, 'mode_manager'):
                    self.orders_cache = self.mode_manager.get_orders()
                    self.orders_cache_time = current_time
                    # DEBUG: Log kapatÄ±ldÄ± - sÃ¼rekli terminal loglarÄ±nÄ± dolduruyordu
                    # print(f"[PSFALGO] ğŸ”„ Emir cache gÃ¼ncellendi ({len(self.orders_cache)} emir)")
                else:
                    self.orders_cache = []
            
            return self.orders_cache
        except Exception as e:
            print(f"[PSFALGO] âŒ Emir cache hatasÄ±: {e}")
            return []
    
    def get_cached_positions(self, active_account=None):
        """Cache'lenmiÅŸ pozisyonlarÄ± dÃ¶ndÃ¼r (60 saniye cache)"""
        try:
            import time
            current_time = time.time()
            
            # Aktif hesabÄ± belirle
            if active_account is None:
                if hasattr(self, 'mode_manager'):
                    active_account = self.mode_manager.get_active_account()
                else:
                    if self.hampro_mode:
                        active_account = "HAMPRO"
                    elif self.ibkr_gun_mode:
                        active_account = "IBKR_GUN"
                    elif self.ibkr_ped_mode:
                        active_account = "IBKR_PED"
                    else:
                        active_account = "HAMPRO"
            
            # Cache key'i aktif hesaba gÃ¶re
            cache_key = active_account
            
            # Cache yoksa veya sÃ¼resi dolmuÅŸsa yenile
            if cache_key not in getattr(self, 'positions_cache', {}) or \
               cache_key not in getattr(self, 'positions_cache_time', {}) or \
               (current_time - self.positions_cache_time.get(cache_key, 0)) > self.orders_cache_interval:  # AynÄ± interval (60 saniye)
                
                # Cache dict'leri oluÅŸtur
                if not hasattr(self, 'positions_cache'):
                    self.positions_cache = {}
                if not hasattr(self, 'positions_cache_time'):
                    self.positions_cache_time = {}
                
                # Cache'i gÃ¼ncelle
                self.positions_cache[cache_key] = []
                self.positions_cache_time[cache_key] = current_time
                
                # Aktif moda gÃ¶re pozisyonlarÄ± Ã§ek
                if active_account in ["IBKR_GUN", "IBKR_PED"]:
                    if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                        self.positions_cache[cache_key] = self.mode_manager.ibkr_native_client.get_positions()
                    elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                        self.positions_cache[cache_key] = self.mode_manager.ibkr_client.get_positions()
                else:  # HAMPRO
                    if self.hammer and self.hammer.connected:
                        self.positions_cache[cache_key] = self.hammer.get_positions_direct()
            
            return self.positions_cache.get(cache_key, [])
        except Exception as e:
            print(f"[PSFALGO] âŒ Pozisyon cache hatasÄ±: {e}")
            return []
    
    def get_open_orders_count(self, symbol, use_cache=False):
        """Belirli bir sembol iÃ§in aÃ§Ä±k emir sayÄ±sÄ±nÄ± dÃ¶ndÃ¼r
        
        Args:
            symbol: Sembol adÄ±
            use_cache: True ise cache'lenmiÅŸ emirleri kullan, False ise direkt API'den Ã§ek
        """
        try:
            # Cache kullanÄ±lÄ±yorsa cache'den al, deÄŸilse direkt Ã§ek
            if use_cache and hasattr(self, 'orders_cache'):
                orders = self.get_cached_orders()
            else:
                # Aktif hesaptan aÃ§Ä±k emirleri al
                if hasattr(self, 'mode_manager'):
                    active_account = self.mode_manager.get_active_account()
                else:
                    active_account = "HAMPRO" if self.hampro_mode else "IBKR"
                
                orders = []
                if active_account in ["IBKR_GUN", "IBKR_PED"]:
                    if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                        orders = self.mode_manager.ibkr_native_client.get_open_orders() if hasattr(self.mode_manager.ibkr_native_client, 'get_open_orders') else []
                    elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                        orders = self.mode_manager.ibkr_client.get_orders_direct() if hasattr(self.mode_manager.ibkr_client, 'get_orders_direct') else []
                else:  # HAMPRO
                    if self.hammer and self.hammer.connected:
                        orders = self.hammer.get_open_orders() if hasattr(self.hammer, 'get_open_orders') else []
            
            if not orders:
                return 0
            
            # Symbol iÃ§in aÃ§Ä±k emirleri say
            count = 0
            for order in orders:
                order_symbol = order.get('symbol', '')
                # Symbol eÅŸleÅŸtirmesi (display symbol ile)
                if order_symbol == symbol:
                    count += 1
                # Alternatif eÅŸleÅŸtirme (base symbol ile)
                elif '-' in order_symbol:
                    base_symbol = order_symbol.split('-')[0]
                    if base_symbol == symbol.replace(' PR', ''):
                        count += 1
            
            return count
            
        except Exception as e:
            self.log_message(f"âŒ AÃ§Ä±k emir kontrol hatasÄ± ({symbol}): {e}")
            return 0
    
    def calculate_potential_total(self):
        """
        Pot Toplam hesapla: Mevcut pozisyon + AÃ§Ä±k emirler (arttÄ±rma - azaltma)
        
        Returns:
            dict: {
                'current_total': int,      # Mevcut toplam lot (ABS)
                'pot_total': int,          # Potansiyel toplam lot (ABS)
                'pot_increase': int,       # Potansiyel arttÄ±rma emirleri toplamÄ±
                'pot_decrease': int,       # Potansiyel azaltma emirleri toplamÄ±
                'by_symbol': dict          # Her hisse iÃ§in detay
            }
        """
        try:
            # Aktif modu kontrol et
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            # Mevcut pozisyonlarÄ± al
            positions = []
            if active_account == "HAMPRO":
                if self.hammer and self.hammer.connected:
                    positions = self.hammer.get_positions_direct()
            elif active_account in ["IBKR_GUN", "IBKR_PED"]:
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                    positions = self.mode_manager.ibkr_native_client.get_positions()
                elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                    positions = self.mode_manager.ibkr_client.get_positions()
            
            # AÃ§Ä±k emirleri al (cache'den)
            orders = self.get_cached_orders()
            
            # GÃ¼n baÅŸÄ± pozisyonlarÄ± yÃ¼kle (tÃ¼m semboller iÃ§in)
            bef_positions = {}
            for pos in positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '')
                if symbol:
                    bef_positions[symbol] = self.load_bef_position(symbol)
            
            # Her hisse iÃ§in analiz
            current_total = 0
            pot_total = 0
            pot_increase_total = 0
            pot_decrease_total = 0
            by_symbol = {}
            
            # TÃ¼m sembolleri topla (pozisyonlar + emirler)
            all_symbols = set()
            for pos in positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '')
                if symbol:
                    all_symbols.add(symbol)
            for order in orders:
                symbol = order.get('symbol', '') or order.get('Symbol', '')
                if symbol:
                    all_symbols.add(symbol)
            
            for symbol in all_symbols:
                # Mevcut pozisyon
                current_pos = 0
                for pos in positions:
                    pos_symbol = pos.get('symbol', '') or pos.get('Symbol', '')
                    if pos_symbol == symbol:
                        qty = pos.get('quantity') or pos.get('qty') or pos.get('Quantity', 0)
                        current_pos = float(qty) if qty else 0
                        break
                
                # GÃ¼n baÅŸÄ± pozisyon
                bef_pos = bef_positions.get(symbol, 0)
                
                # AÃ§Ä±k emirleri analiz et
                pot_increase = 0  # Pozisyon arttÄ±rma emirleri
                pot_decrease = 0  # Pozisyon azaltma emirleri
                
                for order in orders:
                    order_symbol = order.get('symbol', '') or order.get('Symbol', '')
                    if order_symbol != symbol:
                        continue
                    
                    # Status kontrolÃ¼
                    status = order.get('status', '').upper() or order.get('Status', '').upper()
                    if status in ['CANCELLED', 'FILLED', 'REJECTED', 'API CANCELLED']:
                        continue
                    
                    # Remaining quantity
                    remaining = order.get('remaining', None) or order.get('Remaining', None)
                    if remaining is not None and remaining > 0:
                        order_qty = abs(float(remaining))
                    else:
                        order_qty = abs(float(order.get('qty', 0) or order.get('quantity', 0) or 0))
                    
                    if order_qty == 0:
                        continue
                    
                    # Emir tÃ¼rÃ¼
                    order_action = order.get('action', '').upper() or order.get('Action', '').upper() or order.get('side', '').upper() or order.get('Side', '').upper()
                    
                    # Pozisyon arttÄ±rma/azaltma analizi
                    if current_pos >= 0:  # Long pozisyon var veya 0
                        if order_action in ['BUY', 'LONG']:
                            # Long artÄ±rma
                            pot_increase += order_qty
                        elif order_action in ['SELL', 'SHORT']:
                            # Long azaltma
                            pot_decrease += order_qty
                    else:  # Short pozisyon var
                        if order_action in ['SELL', 'SHORT']:
                            # Short artÄ±rma
                            pot_increase += order_qty
                        elif order_action in ['BUY', 'LONG']:
                            # Short azaltma
                            pot_decrease += order_qty
                
                # Potansiyel pozisyon hesapla
                if current_pos >= 0:
                    pot_pos = current_pos + pot_increase - pot_decrease
                else:
                    pot_pos = current_pos - pot_increase + pot_decrease
                
                # Toplamlara ekle (ABS)
                current_total += abs(current_pos)
                pot_total += abs(pot_pos)
                pot_increase_total += pot_increase
                pot_decrease_total += pot_decrease
                
                # Detay kaydet
                by_symbol[symbol] = {
                    'current': current_pos,
                    'bef': bef_pos,
                    'pot_increase': pot_increase,
                    'pot_decrease': pot_decrease,
                    'pot': pot_pos
                }
            
            return {
                'current_total': int(current_total),
                'pot_total': int(pot_total),
                'pot_increase': int(pot_increase_total),
                'pot_decrease': int(pot_decrease_total),
                'by_symbol': by_symbol
            }
            
        except Exception as e:
            print(f"[POT TOTAL] âŒ Hesaplama hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return {
                'current_total': 0,
                'pot_total': 0,
                'pot_increase': 0,
                'pot_decrease': 0,
                'by_symbol': {}
            }
    
    def analyze_order_impact(self, symbol, current_position):
        """
        Belirli bir sembol iÃ§in emirlerin pozisyon Ã¼zerindeki etkisini analiz eder
        
        Args:
            symbol: Hisse sembolÃ¼
            current_position: Mevcut pozisyon (pozitif=long, negatif=short)
            
        Returns:
            dict: {
                'long_increase_orders': int,  # Long artÄ±rma emirleri toplamÄ±
                'long_decrease_orders': int,  # Long azaltma emirleri toplamÄ±
                'short_increase_orders': int, # Short artÄ±rma emirleri toplamÄ±
                'short_decrease_orders': int, # Short azaltma emirleri toplamÄ±
                'potential_position': int,    # Potansiyel pozisyon
                'max_additional_long': int,   # Maksimum ek long emir
                'max_additional_short': int   # Maksimum ek short emir
            }
        """
        try:
            # Cache'lenmiÅŸ emirleri al (60 saniyede bir gÃ¼ncellenir)
            orders = self.get_cached_orders()
            if not orders:
                return {
                    'long_increase_orders': 0,
                    'long_decrease_orders': 0,
                    'short_increase_orders': 0,
                    'short_decrease_orders': 0,
                    'potential_position': current_position,
                    'max_additional_long': 0,
                    'max_additional_short': 0
                }
            
            # Emir analizi
            long_increase = 0  # Long artÄ±rma emirleri
            long_decrease = 0  # Long azaltma emirleri
            short_increase = 0 # Short artÄ±rma emirleri
            short_decrease = 0 # Short azaltma emirleri
            
            for order in orders:
                order_symbol = order.get('symbol', '') or order.get('Symbol', '')
                order_action = order.get('action', '').upper() or order.get('Action', '').upper() or order.get('side', '').upper() or order.get('Side', '').upper()
                
                # Remaining quantity kullan (daha doÄŸru)
                remaining = order.get('remaining', None) or order.get('Remaining', None)
                if remaining is not None and remaining > 0:
                    order_qty = abs(float(remaining))
                else:
                    order_qty = abs(float(order.get('qty', 0) or order.get('quantity', 0) or order.get('Quantity', 0) or 0))
                
                # Status kontrolÃ¼ - sadece aÃ§Ä±k emirleri say
                status = order.get('status', '').upper() or order.get('Status', '').upper()
                if status in ['CANCELLED', 'FILLED', 'REJECTED', 'API CANCELLED']:
                    continue  # Bu emirler artÄ±k aÃ§Ä±k deÄŸil
                
                # Symbol eÅŸleÅŸtirmesi
                is_match = False
                if order_symbol == symbol:
                    is_match = True
                elif '-' in order_symbol:
                    base_symbol = order_symbol.split('-')[0]
                    if base_symbol == symbol.replace(' PR', ''):
                        is_match = True
                
                if is_match and order_qty > 0:
                    if order_action in ['BUY', 'LONG']:
                        if current_position >= 0:
                            # Long pozisyon var veya yok, BUY emri long artÄ±rÄ±r
                            long_increase += order_qty
                        else:
                            # Short pozisyon var, BUY emri short azaltÄ±r
                            short_decrease += order_qty
                    elif order_action in ['SELL', 'SHORT']:
                        if current_position > 0:
                            # Long pozisyon var, SELL emri long azaltÄ±r
                            long_decrease += order_qty
                        else:
                            # Long pozisyon yok, SELL emri short artÄ±rÄ±r
                            short_increase += order_qty
            
            # Potansiyel pozisyon hesapla
            potential_position = current_position + long_increase - long_decrease - short_increase + short_decrease
            
            # MAXALW deÄŸerini al
            maxalw = self.get_maxalw_for_symbol(symbol)
            
            # Maksimum ek emir hesapla
            max_additional_long = 0
            max_additional_short = 0
            
            if current_position >= 0:
                # Long pozisyon var veya yok
                current_long = max(0, current_position)
                max_additional_long = max(0, maxalw - current_long - long_increase + long_decrease)
                max_additional_short = max(0, maxalw - short_increase + short_decrease)
            else:
                # Short pozisyon var
                current_short = abs(current_position)
                max_additional_short = max(0, maxalw - current_short - short_increase + short_decrease)
                max_additional_long = max(0, maxalw - long_increase + long_decrease)
            
            return {
                'long_increase_orders': long_increase,
                'long_decrease_orders': long_decrease,
                'short_increase_orders': short_increase,
                'short_decrease_orders': short_decrease,
                'potential_position': potential_position,
                'max_additional_long': max_additional_long,
                'max_additional_short': max_additional_short
            }
            
        except Exception as e:
            self.log_message(f"âŒ Emir analiz hatasÄ± ({symbol}): {e}")
            return {
                'long_increase_orders': 0,
                'long_decrease_orders': 0,
                'short_increase_orders': 0,
                'short_decrease_orders': 0,
                'potential_position': current_position,
                'max_additional_long': 0,
                'max_additional_short': 0
            }
    
    def log_message(self, message):
        """Psfalgo log mesajÄ± ekle"""
        try:
            timestamp = datetime.now().strftime("%H:%M:%S")
            log_entry = f"[{timestamp}] {message}\n"
            self.log_text.insert(tk.END, log_entry)
            self.log_text.see(tk.END)
        except Exception:
            pass
    
    def add_to_loop_report(self, symbol, action, lot, price, status, step_name, conditions_checked, conditions_passed, conditions_failed, final_reason):
        """
        DÃ¶ngÃ¼ raporuna detaylÄ± emir kararÄ± ekle
        
        Args:
            symbol: Hisse sembolÃ¼
            action: 'BUY' veya 'SELL'
            lot: Lot miktarÄ±
            price: Emir fiyatÄ±
            status: 'SENT' (gÃ¶nderildi) veya 'BLOCKED' (engellendi)
            step_name: Hangi adÄ±mda (Ã¶r: 'KARBOTU Step 2')
            conditions_checked: Kontrol edilen koÅŸullar listesi
            conditions_passed: GeÃ§ilen koÅŸullar listesi  
            conditions_failed: TakÄ±lan koÅŸullar listesi
            final_reason: Son karar nedeni
        """
        try:
            report_entry = {
                'time': datetime.now().strftime('%H:%M:%S'),
                'symbol': symbol,
                'action': action,
                'lot': lot,
                'price': price,
                'status': status,
                'step_name': step_name,
                'conditions_checked': conditions_checked,
                'conditions_passed': conditions_passed,
                'conditions_failed': conditions_failed,
                'final_reason': final_reason
            }
            self.loop_report.append(report_entry)
            
            # KÄ±sa log da ekle
            status_icon = "âœ…" if status == "SENT" else "âŒ"
            print(f"[DÃ–NGÃœ RAPOR] {status_icon} {symbol} {action} {lot} lot @ ${price:.2f} - {final_reason}")
            
        except Exception as e:
            print(f"[DÃ–NGÃœ RAPOR] Hata: {e}")
    
    def clear_loop_report(self):
        """DÃ¶ngÃ¼ raporunu temizle - Yeni dÃ¶ngÃ¼ baÅŸlarken Ã§aÄŸrÄ±lÄ±r"""
        self.loop_report = []
        self.loop_report_start_time = datetime.now()
        print(f"[DÃ–NGÃœ RAPOR] ğŸ”„ Rapor temizlendi, yeni dÃ¶ngÃ¼ baÅŸladÄ±: {self.loop_report_start_time.strftime('%H:%M:%S')}")
    
    def show_loop_report_window(self):
        """DÃ¶ngÃ¼ Raporu penceresini gÃ¶ster - KULLANICI Ã–NCELÄ°KLÄ°"""
        def open_loop_report():
            try:
                # Pencere oluÅŸtur
                report_win = tk.Toplevel(self)
                report_win.title(f"DÃ¶ngÃ¼ Raporu - DÃ¶ngÃ¼ #{self.loop_report_loop_number}")
                report_win.geometry("1200x700")
                
                # Pencereyi hemen Ã¶ne getir
                report_win.lift()
                report_win.focus_force()
                
                # BaÅŸlÄ±k frame
                header_frame = ttk.Frame(report_win)
                header_frame.pack(fill='x', padx=10, pady=5)
                
                # DÃ¶ngÃ¼ bilgisi
                start_time_str = self.loop_report_start_time.strftime('%H:%M:%S') if self.loop_report_start_time else 'N/A'
                ttk.Label(header_frame, text=f"ğŸ“Š DÃ¶ngÃ¼ #{self.loop_report_loop_number} | BaÅŸlangÄ±Ã§: {start_time_str}", 
                         font=('Arial', 12, 'bold')).pack(side='left')
                
                # Ä°statistikler
                sent_count = sum(1 for r in self.loop_report if r['status'] == 'SENT')
                blocked_count = sum(1 for r in self.loop_report if r['status'] == 'BLOCKED')
                ttk.Label(header_frame, text=f"âœ… GÃ¶nderilen: {sent_count} | âŒ Engellenen: {blocked_count}", 
                         font=('Arial', 10)).pack(side='right')
                
                # Notebook (tabs)
                notebook = ttk.Notebook(report_win)
                notebook.pack(fill='both', expand=True, padx=10, pady=5)
                
                # Tab 1: TÃ¼m Emirler
                all_frame = ttk.Frame(notebook)
                notebook.add(all_frame, text="ğŸ“‹ TÃ¼m Emirler")
                self._create_report_table(all_frame, self.loop_report)
                
                # Tab 2: GÃ¶nderilen Emirler
                sent_frame = ttk.Frame(notebook)
                notebook.add(sent_frame, text="âœ… GÃ¶nderilen")
                sent_reports = [r for r in self.loop_report if r['status'] == 'SENT']
                self._create_report_table(sent_frame, sent_reports)
                
                # Tab 3: Engellenen Emirler
                blocked_frame = ttk.Frame(notebook)
                notebook.add(blocked_frame, text="âŒ Engellenen")
                blocked_reports = [r for r in self.loop_report if r['status'] == 'BLOCKED']
                self._create_report_table(blocked_frame, blocked_reports)
                
                # Tab 4: DetaylÄ± Log
                detail_frame = ttk.Frame(notebook)
                notebook.add(detail_frame, text="ğŸ“ DetaylÄ± Log")
                self._create_detailed_log(detail_frame)
                
                # Alt butonlar
                btn_frame = ttk.Frame(report_win)
                btn_frame.pack(fill='x', padx=10, pady=5)
                
                ttk.Button(btn_frame, text="ğŸ”„ Yenile", command=lambda: self._refresh_report_window(report_win)).pack(side='left', padx=5)
                ttk.Button(btn_frame, text="ğŸ’¾ CSV'ye Kaydet", command=self._save_loop_report_to_csv).pack(side='left', padx=5)
                ttk.Button(btn_frame, text="ğŸ—‘ï¸ Temizle", command=lambda: self._clear_and_refresh(report_win)).pack(side='left', padx=5)
                ttk.Button(btn_frame, text="âŒ Kapat", command=report_win.destroy).pack(side='right', padx=5)
                
            except Exception as e:
                print(f"[DÃ–NGÃœ RAPOR] Pencere hatasÄ±: {e}")
                import traceback
                traceback.print_exc()
        
        # Priority queue ile hemen Ã§alÄ±ÅŸtÄ±r
        self.priority_ui_call(open_loop_report)
    
    def _create_report_table(self, parent, reports):
        """Rapor tablosu oluÅŸtur"""
        # Scrollable frame
        canvas = tk.Canvas(parent)
        scrollbar = ttk.Scrollbar(parent, orient="vertical", command=canvas.yview)
        scrollable_frame = ttk.Frame(canvas)
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # Treeview
        columns = ('time', 'symbol', 'action', 'lot', 'price', 'status', 'step', 'reason')
        tree = ttk.Treeview(scrollable_frame, columns=columns, show='headings', height=20)
        
        tree.heading('time', text='Saat')
        tree.heading('symbol', text='Sembol')
        tree.heading('action', text='Ä°ÅŸlem')
        tree.heading('lot', text='Lot')
        tree.heading('price', text='Fiyat')
        tree.heading('status', text='Durum')
        tree.heading('step', text='AdÄ±m')
        tree.heading('reason', text='Sebep')
        
        tree.column('time', width=70)
        tree.column('symbol', width=100)
        tree.column('action', width=60)
        tree.column('lot', width=60)
        tree.column('price', width=80)
        tree.column('status', width=80)
        tree.column('step', width=120)
        tree.column('reason', width=400)
        
        # RaporlarÄ± ekle
        for report in reports:
            status_text = "âœ… GÃ¶nderildi" if report['status'] == 'SENT' else "âŒ Engellendi"
            price_text = f"${report['price']:.2f}" if report['price'] > 0 else "N/A"
            
            values = (
                report['time'],
                report['symbol'],
                report['action'],
                report['lot'],
                price_text,
                status_text,
                report['step_name'],
                report['final_reason']
            )
            
            tag = 'sent' if report['status'] == 'SENT' else 'blocked'
            tree.insert('', 'end', values=values, tags=(tag,))
        
        tree.tag_configure('sent', background='#90EE90')  # AÃ§Ä±k yeÅŸil
        tree.tag_configure('blocked', background='#FFB6C1')  # AÃ§Ä±k kÄ±rmÄ±zÄ±
        
        tree.pack(fill='both', expand=True)
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
    
    def _create_detailed_log(self, parent):
        """DetaylÄ± log gÃ¶rÃ¼nÃ¼mÃ¼ oluÅŸtur"""
        text = tk.Text(parent, wrap=tk.WORD, font=('Consolas', 9))
        scrollbar = ttk.Scrollbar(parent, orient="vertical", command=text.yview)
        text.configure(yscrollcommand=scrollbar.set)
        
        for report in self.loop_report:
            status_icon = "âœ…" if report['status'] == 'SENT' else "âŒ"
            price_text = f"${report['price']:.2f}" if report['price'] > 0 else "N/A"
            
            # BaÅŸlÄ±k
            text.insert(tk.END, f"\n{'='*80}\n")
            text.insert(tk.END, f"{status_icon} {report['time']} | {report['symbol']} | {report['action']} {report['lot']} lot @ {price_text}\n")
            text.insert(tk.END, f"AdÄ±m: {report['step_name']}\n")
            text.insert(tk.END, f"{'='*80}\n\n")
            
            # Kontrol edilen koÅŸullar
            text.insert(tk.END, "ğŸ“‹ KONTROL EDÄ°LEN KOÅULLAR:\n")
            for cond in report.get('conditions_checked', []):
                text.insert(tk.END, f"   â€¢ {cond}\n")
            
            # GeÃ§ilen koÅŸullar
            text.insert(tk.END, "\nâœ… GEÃ‡Ä°LEN KOÅULLAR:\n")
            for cond in report.get('conditions_passed', []):
                text.insert(tk.END, f"   âœ“ {cond}\n")
            
            # TakÄ±lan koÅŸullar
            if report.get('conditions_failed'):
                text.insert(tk.END, "\nâŒ TAKILDIÄI KOÅUL:\n")
                for cond in report.get('conditions_failed', []):
                    text.insert(tk.END, f"   âœ— {cond}\n")
            
            # Son karar
            text.insert(tk.END, f"\nğŸ“Œ SONUÃ‡: {report['final_reason']}\n")
        
        text.config(state='disabled')
        text.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
    
    def _refresh_report_window(self, win):
        """Rapor penceresini yenile"""
        win.destroy()
        self.show_loop_report_window()
    
    def _clear_and_refresh(self, win):
        """Raporu temizle ve yenile"""
        self.loop_report = []
        win.destroy()
        self.show_loop_report_window()
    
    def _save_loop_report_to_csv(self):
        """DÃ¶ngÃ¼ raporunu CSV'ye kaydet"""
        try:
            import pandas as pd
            if not self.loop_report:
                messagebox.showinfo("Bilgi", "Kaydedilecek rapor yok!")
                return
            
            df = pd.DataFrame(self.loop_report)
            filename = f"dongu_raporu_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
            df.to_csv(filename, index=False, encoding='utf-8-sig')
            messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Rapor kaydedildi: {filename}")
            
        except Exception as e:
            messagebox.showerror("Hata", f"Kaydetme hatasÄ±: {e}")
    
    # ==================== PSFALGO AKTÄ°VÄ°TE LOGU ====================
    
    def log_psfalgo_activity(self, action, details, status="INFO", reason="", category="GENEL", 
                             symbol="", step_name="", fbtot=None, sfstot=None, pahalilik=None, ucuzluk=None,
                             maxalw=None, gort=None, sma_chg=None, lot_percentage=None, calculated_lot=None,
                             daily_limit=None, current_daily_change=None, remaining_allowance=None,
                             controller_result=None, min_lot_check=None, conditions_checked=None,
                             conditions_passed=None, conditions_failed=None, revorder_info=None,
                             loop_number=None):
        """
        Psfalgo'da yapÄ±lan her iÅŸlemi detaylÄ± logla
        
        Args:
            action: Ä°ÅŸlem adÄ± (Ã¶r: 'KARBOTU BaÅŸlatÄ±ldÄ±', 'Emir GÃ¶nderildi')
            details: Detaylar (Ã¶r: 'AAL: BUY 500 lot @ $15.20')
            status: 'SUCCESS', 'BLOCKED', 'ERROR', 'INFO', 'WARNING'
            reason: Engelleme/hata sebebi
            category: 'KARBOTU', 'REDUCEMORE', 'ADDNEWPOS', 'CROPLIT', 'RUNALL', 'CONTROLLER', 'REVORDER', 'GENEL'
            symbol: Hisse sembolÃ¼
            step_name: Hangi adÄ±m (Ã¶r: 'KARBOTU Step 2', 'ADDNEWPOS')
            fbtot: Fbtot deÄŸeri
            sfstot: SFStot deÄŸeri
            pahalilik: Ask Sell PahalÄ±lÄ±k veya benzeri
            ucuzluk: Bid Buy Ucuzluk veya benzeri
            maxalw: MAXALW deÄŸeri
            gort: GORT deÄŸeri
            sma_chg: SMA63CHG deÄŸeri
            lot_percentage: Lot yÃ¼zdesi
            calculated_lot: Hesaplanan lot
            daily_limit: GÃ¼nlÃ¼k limit
            current_daily_change: Mevcut gÃ¼nlÃ¼k deÄŸiÅŸim
            remaining_allowance: Kalan hak
            controller_result: Controller sonucu
            min_lot_check: Minimum lot kontrolÃ¼ sonucu
            conditions_checked: Kontrol edilen koÅŸullar listesi
            conditions_passed: GeÃ§ilen koÅŸullar listesi
            conditions_failed: TakÄ±lan koÅŸullar listesi
            revorder_info: RevOrder bilgileri
            loop_number: RUNALL dÃ¶ngÃ¼ numarasÄ±
        """
        try:
            # EÄŸer loop_number verilmemiÅŸse, mevcut dÃ¶ngÃ¼ numarasÄ±nÄ± kullan
            if loop_number is None:
                loop_number = getattr(self, 'runall_loop_count', 0)
            
            log_entry = {
                'time': datetime.now().strftime('%H:%M:%S'),
                'timestamp': datetime.now(),
                'category': category,
                'action': action,
                'details': details,
                'status': status,
                'reason': reason,
                'symbol': symbol,
                'step_name': step_name,
                'fbtot': fbtot,
                'sfstot': sfstot,
                'pahalilik': pahalilik,
                'ucuzluk': ucuzluk,
                'maxalw': maxalw,
                'gort': gort,
                'sma_chg': sma_chg,
                'lot_percentage': lot_percentage,
                'calculated_lot': calculated_lot,
                'daily_limit': daily_limit,
                'current_daily_change': current_daily_change,
                'remaining_allowance': remaining_allowance,
                'controller_result': controller_result,
                'min_lot_check': min_lot_check,
                'conditions_checked': conditions_checked or [],
                'conditions_passed': conditions_passed or [],
                'conditions_failed': conditions_failed or [],
                'revorder_info': revorder_info,
                'loop_number': loop_number
            }
            self.psfalgo_activity_log.append(log_entry)
            
            # Konsola da yazdÄ±r
            status_icons = {
                'SUCCESS': 'âœ…',
                'BLOCKED': 'âŒ',
                'ERROR': 'âš ï¸',
                'INFO': 'â„¹ï¸',
                'WARNING': 'âš ï¸'
            }
            icon = status_icons.get(status, 'â€¢')
            print(f"[PSFALGO LOG] {icon} [{category}] {action}: {details}")
            if reason:
                print(f"             â””â”€ Sebep: {reason}")
                
        except Exception as e:
            print(f"[PSFALGO LOG] Loglama hatasÄ±: {e}")
    
    def show_psfalgo_alg_raporu(self):
        """Psfalgo Algoritma Raporu penceresini gÃ¶ster - Son RUNALL dÃ¶ngÃ¼sÃ¼ne odaklan - KULLANICI Ã–NCELÄ°KLÄ°"""
        def open_psfalgo_report():
            try:
                # Pencere oluÅŸtur
                report_win = tk.Toplevel(self)
                report_win.title("Psfalgo Algoritma Raporu - Son RUNALL DÃ¶ngÃ¼sÃ¼")
                report_win.geometry("1600x900")
                
                # Pencereyi hemen Ã¶ne getir
                report_win.lift()
                report_win.focus_force()
                
                # Son RUNALL dÃ¶ngÃ¼ numarasÄ±nÄ± al
                current_loop = getattr(self, 'runall_loop_count', 0)
                
                # Son dÃ¶ngÃ¼ye ait loglarÄ± filtrele
                last_loop_logs = [r for r in self.psfalgo_activity_log 
                                 if r.get('loop_number', 0) == current_loop or 
                                    (current_loop == 0 and len(self.psfalgo_activity_log) > 0)]
                
                # EÄŸer son dÃ¶ngÃ¼ logu yoksa, CSV'den oku (algraporu.csv)
                if not last_loop_logs:
                    csv_filename = "algraporu.csv"
                    try:
                        import os
                        if os.path.exists(csv_filename):
                            print(f"[ALG RAPOR] ğŸ“‚ CSV'den okunuyor: {csv_filename}")
                            df = pd.read_csv(csv_filename, encoding='utf-8-sig')
                            # DataFrame'i dict listesine Ã§evir
                            last_loop_logs = df.to_dict('records')
                            print(f"[ALG RAPOR] âœ… CSV'den {len(last_loop_logs)} kayÄ±t okundu")
                            # DÃ¶ngÃ¼ numarasÄ±nÄ± CSV'den al (eÄŸer varsa)
                            if last_loop_logs and 'loop_number' in last_loop_logs[0]:
                                csv_loop = last_loop_logs[0].get('loop_number', 0)
                                if csv_loop > 0:
                                    current_loop = csv_loop
                                    print(f"[ALG RAPOR] ğŸ“Š CSV'den dÃ¶ngÃ¼ numarasÄ±: {current_loop}")
                        else:
                            print(f"[ALG RAPOR] âš ï¸ CSV dosyasÄ± bulunamadÄ±: {csv_filename}")
                            # En son loglarÄ± al (son 100)
                            last_loop_logs = self.psfalgo_activity_log[-100:] if len(self.psfalgo_activity_log) > 100 else self.psfalgo_activity_log
                    except Exception as e:
                        print(f"[ALG RAPOR] âŒ CSV okuma hatasÄ±: {e}")
                        import traceback
                        traceback.print_exc()
                        # Hata durumunda en son loglarÄ± al
                        last_loop_logs = self.psfalgo_activity_log[-100:] if len(self.psfalgo_activity_log) > 100 else self.psfalgo_activity_log
                
                # BaÅŸlÄ±k frame
                header_frame = ttk.Frame(report_win)
                header_frame.pack(fill='x', padx=10, pady=5)
                
                # Ä°statistikler
                total_count = len(last_loop_logs)
                success_count = sum(1 for r in last_loop_logs if r['status'] == 'SUCCESS')
                blocked_count = sum(1 for r in last_loop_logs if r['status'] == 'BLOCKED')
                error_count = sum(1 for r in last_loop_logs if r['status'] == 'ERROR')
                
                ttk.Label(header_frame, text=f"ğŸ“Š Psfalgo Algoritma Raporu - DÃ¶ngÃ¼ #{current_loop}", 
                         font=('Arial', 14, 'bold')).pack(side='left')
                
                stats_text = f"Toplam: {total_count} | âœ… BaÅŸarÄ±lÄ±: {success_count} | âŒ Engellenen: {blocked_count} | âš ï¸ Hata: {error_count}"
                ttk.Label(header_frame, text=stats_text, font=('Arial', 10)).pack(side='right')
                
                # Notebook (tabs)
                notebook = ttk.Notebook(report_win)
                notebook.pack(fill='both', expand=True, padx=10, pady=5)
                
                # Tab 1: DetaylÄ± Emir Raporu (YENÄ° - Ã‡ok detaylÄ±)
                detail_frame = ttk.Frame(notebook)
                notebook.add(detail_frame, text="ğŸ“‹ DetaylÄ± Emir Raporu")
                self._create_detailed_order_report(detail_frame, last_loop_logs)
                
                # Tab 2: TÃ¼m Aktiviteler
                all_frame = ttk.Frame(notebook)
                notebook.add(all_frame, text="ğŸ“‹ TÃ¼m Aktiviteler")
                self._create_psfalgo_activity_table(all_frame, last_loop_logs)
                
                # Tab 3: Kategorilere GÃ¶re
                categories = ['KARBOTU', 'REDUCEMORE', 'ADDNEWPOS', 'CROPLIT', 'RUNALL', 'CONTROLLER', 'REVORDER']
                for cat in categories:
                    cat_frame = ttk.Frame(notebook)
                    cat_logs = [r for r in last_loop_logs if r['category'] == cat]
                    if cat_logs:  # Sadece log varsa tab ekle
                        notebook.add(cat_frame, text=f"ğŸ”¹ {cat}")
                        self._create_psfalgo_activity_table(cat_frame, cat_logs)
                
                # Tab: Sadece BaÅŸarÄ±lÄ±
                success_frame = ttk.Frame(notebook)
                success_logs = [r for r in last_loop_logs if r['status'] == 'SUCCESS']
                notebook.add(success_frame, text="âœ… BaÅŸarÄ±lÄ±")
                self._create_psfalgo_activity_table(success_frame, success_logs)
                
                # Tab: Sadece Engellenen
                blocked_frame = ttk.Frame(notebook)
                blocked_logs = [r for r in last_loop_logs if r['status'] == 'BLOCKED']
                notebook.add(blocked_frame, text="âŒ Engellenen")
                self._create_psfalgo_activity_table(blocked_frame, blocked_logs)
                
                # Tab: DetaylÄ± Log (text view)
                detail_text_frame = ttk.Frame(notebook)
                notebook.add(detail_text_frame, text="ğŸ“ DetaylÄ± Log (Text)")
                self._create_psfalgo_detailed_log(detail_text_frame, last_loop_logs)
                
                # Alt butonlar
                btn_frame = ttk.Frame(report_win)
                btn_frame.pack(fill='x', padx=10, pady=5)
                
                ttk.Button(btn_frame, text="ğŸ”„ Yenile", 
                          command=lambda: self._refresh_psfalgo_report(report_win)).pack(side='left', padx=5)
                ttk.Button(btn_frame, text="ğŸ’¾ CSV'ye Kaydet (algraporu.csv)", 
                          command=lambda: self._save_psfalgo_log_to_csv(filename="algraporu.csv", show_message=True)).pack(side='left', padx=5)
                ttk.Button(btn_frame, text="ğŸ—‘ï¸ Temizle", 
                          command=lambda: self._clear_psfalgo_log(report_win)).pack(side='left', padx=5)
                ttk.Button(btn_frame, text="âŒ Kapat", 
                          command=report_win.destroy).pack(side='right', padx=5)
                
            except Exception as e:
                print(f"[PSFALGO RAPOR] Pencere hatasÄ±: {e}")
                import traceback
                traceback.print_exc()
        
        # Priority queue ile hemen Ã§alÄ±ÅŸtÄ±r
        self.priority_ui_call(open_psfalgo_report)
    
    def _create_psfalgo_activity_table(self, parent, logs):
        """Psfalgo aktivite tablosu oluÅŸtur"""
        # Frame ve scrollbar
        table_frame = ttk.Frame(parent)
        table_frame.pack(fill='both', expand=True, padx=5, pady=5)
        
        # Treeview
        columns = ('time', 'category', 'action', 'details', 'status', 'reason')
        tree = ttk.Treeview(table_frame, columns=columns, show='headings', height=25)
        
        # Scrollbar
        vsb = ttk.Scrollbar(table_frame, orient="vertical", command=tree.yview)
        hsb = ttk.Scrollbar(table_frame, orient="horizontal", command=tree.xview)
        tree.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
        
        tree.heading('time', text='Saat')
        tree.heading('category', text='Kategori')
        tree.heading('action', text='Ä°ÅŸlem')
        tree.heading('details', text='Detaylar')
        tree.heading('status', text='Durum')
        tree.heading('reason', text='Sebep/AÃ§Ä±klama')
        
        tree.column('time', width=70, minwidth=70)
        tree.column('category', width=100, minwidth=80)
        tree.column('action', width=200, minwidth=150)
        tree.column('details', width=400, minwidth=200)
        tree.column('status', width=80, minwidth=60)
        tree.column('reason', width=350, minwidth=200)
        
        # LoglarÄ± ekle
        for log in logs:
            status_map = {
                'SUCCESS': 'âœ… BaÅŸarÄ±lÄ±',
                'BLOCKED': 'âŒ Engellendi',
                'ERROR': 'âš ï¸ Hata',
                'INFO': 'â„¹ï¸ Bilgi',
                'WARNING': 'âš ï¸ UyarÄ±'
            }
            status_text = status_map.get(log['status'], log['status'])
            
            values = (
                log['time'],
                log['category'],
                log['action'],
                log['details'],
                status_text,
                log.get('reason', '')
            )
            
            # Renk etiketleri
            if log['status'] == 'SUCCESS':
                tag = 'success'
            elif log['status'] == 'BLOCKED':
                tag = 'blocked'
            elif log['status'] == 'ERROR':
                tag = 'error'
            else:
                tag = 'info'
            
            tree.insert('', 'end', values=values, tags=(tag,))
        
        tree.tag_configure('success', background='#90EE90')  # AÃ§Ä±k yeÅŸil
        tree.tag_configure('blocked', background='#FFB6C1')  # AÃ§Ä±k kÄ±rmÄ±zÄ±
        tree.tag_configure('error', background='#FFD700')    # SarÄ±
        tree.tag_configure('info', background='#E0E0E0')     # AÃ§Ä±k gri
        
        # Pack
        tree.pack(side='left', fill='both', expand=True)
        vsb.pack(side='right', fill='y')
        hsb.pack(side='bottom', fill='x')
    
    def _create_detailed_order_report(self, parent, logs):
        """DetaylÄ± emir raporu oluÅŸtur - Her emir iÃ§in neden gÃ¶nderildi/engellendi aÃ§Ä±klamasÄ±"""
        # Scrollable frame
        canvas = tk.Canvas(parent)
        scrollbar = ttk.Scrollbar(parent, orient="vertical", command=canvas.yview)
        scrollable_frame = ttk.Frame(canvas)
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # Sadece emir ile ilgili loglarÄ± filtrele
        order_logs = [r for r in logs if r['action'] in ['EMIR_ILETILDI', 'EMIR_BLOKE', 'EMIR_HATASI']]
        
        if not order_logs:
            ttk.Label(scrollable_frame, text="HenÃ¼z emir logu yok", font=('Arial', 12)).pack(pady=20)
        else:
            for idx, log in enumerate(order_logs):
                # Her emir iÃ§in detaylÄ± frame
                order_frame = ttk.LabelFrame(scrollable_frame, padding=10)
                order_frame.pack(fill='x', padx=10, pady=5)
                
                # BaÅŸlÄ±k
                status_icons = {
                    'SUCCESS': 'âœ…',
                    'BLOCKED': 'âŒ',
                    'ERROR': 'âš ï¸',
                    'INFO': 'â„¹ï¸',
                    'WARNING': 'âš ï¸'
                }
                icon = status_icons.get(log['status'], 'â€¢')
                
                title_text = f"{icon} [{log['time']}] {log.get('symbol', 'N/A')} - {log['action']} - {log['details']}"
                title_label = ttk.Label(order_frame, text=title_text, font=('Arial', 11, 'bold'))
                title_label.pack(anchor='w', pady=(0, 5))
                
                # DetaylÄ± bilgiler
                details_text = tk.Text(order_frame, wrap=tk.WORD, font=('Consolas', 9), height=15, width=100)
                details_text.pack(fill='both', expand=True, padx=5, pady=5)
                
                # Rapor iÃ§eriÄŸi oluÅŸtur
                report_lines = []
                report_lines.append("=" * 100)
                report_lines.append(f"EMÄ°R DURUMU: {log['status']}")
                report_lines.append("=" * 100)
                report_lines.append("")
                
                # Temel bilgiler
                report_lines.append("ğŸ“Œ TEMEL BÄ°LGÄ°LER:")
                report_lines.append(f"   â€¢ Sembol: {log.get('symbol', 'N/A')}")
                report_lines.append(f"   â€¢ Kategori: {log.get('category', 'N/A')}")
                report_lines.append(f"   â€¢ AdÄ±m: {log.get('step_name', 'N/A')}")
                report_lines.append(f"   â€¢ Detay: {log.get('details', 'N/A')}")
                report_lines.append(f"   â€¢ Sebep: {log.get('reason', 'N/A')}")
                report_lines.append("")
                
                # Neden seÃ§ildi / Neden engellendi
                if log['status'] == 'SUCCESS':
                    report_lines.append("âœ… NEDEN GÃ–NDERÄ°LDÄ°:")
                else:
                    report_lines.append("âŒ NEDEN ENGELLENDÄ°:")
                
                # Filtreleme kriterleri
                if log.get('fbtot') is not None:
                    report_lines.append(f"   â€¢ Fbtot: {log['fbtot']}")
                if log.get('sfstot') is not None:
                    report_lines.append(f"   â€¢ SFStot: {log['sfstot']}")
                if log.get('pahalilik') is not None:
                    report_lines.append(f"   â€¢ PahalÄ±lÄ±k: {log['pahalilik']}")
                if log.get('ucuzluk') is not None:
                    report_lines.append(f"   â€¢ Ucuzluk: {log['ucuzluk']}")
                if log.get('sma_chg') is not None:
                    report_lines.append(f"   â€¢ SMA63CHG: {log['sma_chg']}")
                if log.get('gort') is not None:
                    report_lines.append(f"   â€¢ GORT: {log['gort']}")
                report_lines.append("")
                
                # Lot hesaplama
                if log.get('lot_percentage') is not None:
                    report_lines.append("ğŸ“Š LOT HESAPLAMA:")
                    report_lines.append(f"   â€¢ Lot YÃ¼zdesi: %{log['lot_percentage']}")
                    if log.get('calculated_lot') is not None:
                        report_lines.append(f"   â€¢ Hesaplanan Lot: {log['calculated_lot']:.0f}")
                    report_lines.append("")
                
                # Limitler
                report_lines.append("ğŸ”’ LÄ°MÄ°TLER VE KURALLAR:")
                if log.get('maxalw') is not None:
                    report_lines.append(f"   â€¢ MAXALW: {log['maxalw']:.0f}")
                if log.get('daily_limit') is not None:
                    report_lines.append(f"   â€¢ GÃ¼nlÃ¼k Limit: {log['daily_limit']:.0f}")
                if log.get('current_daily_change') is not None:
                    report_lines.append(f"   â€¢ Mevcut GÃ¼nlÃ¼k DeÄŸiÅŸim: {log['current_daily_change']:.0f}")
                if log.get('remaining_allowance') is not None:
                    report_lines.append(f"   â€¢ Kalan Hak: {log['remaining_allowance']:.0f}")
                if log.get('min_lot_check') is not None:
                    report_lines.append(f"   â€¢ Minimum Lot KontrolÃ¼: {log['min_lot_check']}")
                report_lines.append("")
                
                # Controller sonucu
                if log.get('controller_result'):
                    report_lines.append("ğŸ›ï¸ CONTROLLER KONTROLÃœ:")
                    report_lines.append(f"   â€¢ SonuÃ§: {log['controller_result']}")
                    report_lines.append("")
                
                # Kontrol edilen koÅŸullar
                if log.get('conditions_checked'):
                    report_lines.append("ğŸ“‹ KONTROL EDÄ°LEN KOÅULLAR:")
                    for cond in log['conditions_checked']:
                        report_lines.append(f"   â€¢ {cond}")
                    report_lines.append("")
                
                # GeÃ§ilen koÅŸullar
                if log.get('conditions_passed'):
                    report_lines.append("âœ… GEÃ‡Ä°LEN KOÅULLAR:")
                    for cond in log['conditions_passed']:
                        report_lines.append(f"   âœ“ {cond}")
                    report_lines.append("")
                
                # TakÄ±lan koÅŸullar
                if log.get('conditions_failed'):
                    report_lines.append("âŒ TAKILDIÄI KOÅULLAR:")
                    for cond in log['conditions_failed']:
                        report_lines.append(f"   âœ— {cond}")
                    report_lines.append("")
                
                # RevOrder bilgisi
                if log.get('revorder_info'):
                    report_lines.append("ğŸ”„ REVORDER BÄ°LGÄ°SÄ°:")
                    report_lines.append(f"   â€¢ {log['revorder_info']}")
                    report_lines.append("")
                
                # SonuÃ§
                report_lines.append("=" * 100)
                if log['status'] == 'SUCCESS':
                    report_lines.append("âœ… SONUÃ‡: Emir baÅŸarÄ±yla gÃ¶nderildi")
                elif log['status'] == 'BLOCKED':
                    report_lines.append("âŒ SONUÃ‡: Emir engellendi - YukarÄ±daki kurallar/kÄ±sÄ±tlar nedeniyle")
                else:
                    report_lines.append("âš ï¸ SONUÃ‡: Emir hatasÄ± oluÅŸtu")
                report_lines.append("=" * 100)
                
                # Text'e ekle
                full_text = "\n".join(report_lines)
                details_text.insert('1.0', full_text)
                details_text.config(state='disabled')
        
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
    
    def _create_psfalgo_detailed_log(self, parent, logs=None):
        """Psfalgo detaylÄ± log gÃ¶rÃ¼nÃ¼mÃ¼"""
        if logs is None:
            logs = self.psfalgo_activity_log
        
        text = tk.Text(parent, wrap=tk.WORD, font=('Consolas', 9))
        scrollbar = ttk.Scrollbar(parent, orient="vertical", command=text.yview)
        text.configure(yscrollcommand=scrollbar.set)
        
        for log in logs:
            status_icons = {
                'SUCCESS': 'âœ…',
                'BLOCKED': 'âŒ',
                'ERROR': 'âš ï¸',
                'INFO': 'â„¹ï¸',
                'WARNING': 'âš ï¸'
            }
            icon = status_icons.get(log['status'], 'â€¢')
            
            text.insert(tk.END, f"\n{'â”€'*80}\n")
            text.insert(tk.END, f"{icon} [{log['time']}] [{log['category']}] {log['action']}\n")
            text.insert(tk.END, f"   Detay: {log['details']}\n")
            if log.get('reason'):
                text.insert(tk.END, f"   Sebep: {log['reason']}\n")
        
        text.config(state='disabled')
        text.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
    
    def _refresh_psfalgo_report(self, win):
        """Rapor penceresini yenile"""
        win.destroy()
        self.show_psfalgo_alg_raporu()
    
    def _clear_psfalgo_log(self, win):
        """Psfalgo logunu temizle"""
        self.psfalgo_activity_log = []
        win.destroy()
        self.show_psfalgo_alg_raporu()
    
    def _save_psfalgo_log_to_csv(self, filename="algraporu.csv", show_message=False):
        """Psfalgo logunu CSV'ye kaydet (varsayÄ±lan: algraporu.csv, overwrite eder)"""
        try:
            # Son dÃ¶ngÃ¼ye ait loglarÄ± filtrele
            current_loop = getattr(self, 'runall_loop_count', 0)
            last_loop_logs = [r for r in self.psfalgo_activity_log 
                             if r.get('loop_number', 0) == current_loop or 
                                (current_loop == 0 and len(self.psfalgo_activity_log) > 0)]
            
            # EÄŸer son dÃ¶ngÃ¼ logu yoksa, tÃ¼m loglarÄ± al
            if not last_loop_logs:
                last_loop_logs = self.psfalgo_activity_log
            
            if not last_loop_logs:
                if show_message:
                    messagebox.showinfo("Bilgi", "Kaydedilecek log yok!")
                return False
            
            # timestamp'i Ã§Ä±kar (csv'ye yazÄ±lamaz)
            logs_for_csv = []
            for log in last_loop_logs:
                log_copy = {k: v for k, v in log.items() if k != 'timestamp'}
                logs_for_csv.append(log_copy)
            
            df = pd.DataFrame(logs_for_csv)
            df.to_csv(filename, index=False, encoding='utf-8-sig')
            
            if show_message:
                messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Log kaydedildi: {filename}")
            
            print(f"[ALG RAPOR] âœ… CSV kaydedildi: {filename} ({len(logs_for_csv)} kayÄ±t)")
            return True
            
        except Exception as e:
            print(f"[ALG RAPOR] âŒ CSV kaydetme hatasÄ±: {e}")
            if show_message:
                messagebox.showerror("Hata", f"Kaydetme hatasÄ±: {e}")
            return False
    
    def run_all_sequence(self, from_restart=False):
        """RUNALL butonu: Lot bÃ¶lÃ¼cÃ¼ aÃ§ â†’ Controller ON â†’ KARBOTU baÅŸlat â†’ ADDNEWPOS â†’ 1 dk bekle â†’ Emirleri iptal et â†’ Tekrar baÅŸla (sÃ¼rekli dÃ¶ngÃ¼)
        
        Args:
            from_restart: True ise restart'tan geliyor demektir, dÃ¶ngÃ¼ kontrolÃ¼nÃ¼ atla
        
        NOT: Bu fonksiyon artÄ±k multiprocessing ile ayrÄ± process'te Ã§alÄ±ÅŸÄ±r - UI'Ä± bloklamaz!
        """
        print(f"[RUNALL] ğŸ¯ run_all_sequence FONKSÄ°YONU Ã‡AÄRILDI! from_restart={from_restart}")
        try:
            # Algoritma adÄ± oluÅŸtur
            algorithm_name = f"runall_{int(time.time())}"
            print(f"[RUNALL] ğŸ”§ Algoritma adÄ±: {algorithm_name}")
            
            # RUNALL parametrelerini hazÄ±rla
            # Exposure parametrelerini al
            exposure_limit = float(self.exposure_limit_var.get()) if hasattr(self, 'exposure_limit_var') else 5000000
            avg_price = float(self.avg_price_var.get()) if hasattr(self, 'avg_price_var') else 100
            pot_expo_limit = float(self.pot_expo_limit_var.get()) if hasattr(self, 'pot_expo_limit_var') else 6363600
            
            params = {
                'from_restart': from_restart,
                'runall_allowed_mode': hasattr(self, 'runall_allowed_var') and self.runall_allowed_var.get() if hasattr(self, 'runall_allowed_var') else False,
                'mode': self.mode_manager.get_active_account() if hasattr(self, 'mode_manager') else 'HAMPRO',
                'exposure_limit': exposure_limit,
                'avg_price': avg_price,
                'pot_expo_limit': pot_expo_limit,
            }
            
            # Threading ile RUNALL'Ä± baÅŸlat (multiprocessing pickle hatasÄ± nedeniyle)
            # Multiprocessing weakref hatasÄ± veriyor, bu yÃ¼zden threading kullanÄ±yoruz
            import threading
            
            def run_sequence_thread():
                try:
                    print(f"[RUNALL] ğŸ§µ Thread baÅŸladÄ±: {threading.current_thread().name}")
                    print(f"[RUNALL] ğŸ” _run_all_sequence_impl Ã§aÄŸrÄ±lÄ±yor...")
                    self._run_all_sequence_impl(from_restart=from_restart)
                    print(f"[RUNALL] âœ… _run_all_sequence_impl tamamlandÄ±")
                except Exception as e:
                    print(f"[RUNALL] âŒ Thread hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    self.safe_ui_call(lambda: self.log_message(f"âŒ RUNALL thread hatasÄ±: {e}"))
            print(f"[RUNALL] ğŸ”§ Thread oluÅŸturuluyor...")
            thread = threading.Thread(target=run_sequence_thread, daemon=True, name="RUNALL_Sequence")
            print(f"[RUNALL] ğŸš€ Thread baÅŸlatÄ±lÄ±yor...")
            thread.start()
            print(f"[RUNALL] âœ… Thread baÅŸlatÄ±ldÄ±: {thread.name}, is_alive={thread.is_alive()}")
            
            # Thread'i takip et
            if not hasattr(self, 'algorithm_threads'):
                self.algorithm_threads = {}
            self.algorithm_threads['runall_sequence'] = thread
            
            print(f"[RUNALL] âœ… RUNALL threading ile baÅŸlatÄ±ldÄ±")
            self.safe_ui_call(self.log_message, f"â–¶ï¸ RUNALL baÅŸlatÄ±ldÄ± (Thread)")
                
        except Exception as e:
            print(f"[RUNALL] âŒ RUNALL baÅŸlatma hatasÄ±: {e}")
            self.safe_ui_call(self.log_message, f"âŒ RUNALL baÅŸlatma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def _run_all_sequence_impl(self, from_restart=False):
        """RUNALL sequence'Ä±n gerÃ§ek implementasyonu (thread'de Ã§alÄ±ÅŸÄ±r)"""
        try:
            print(f"[RUNALL] ğŸ¯ _run_all_sequence_impl FONKSÄ°YONU Ã‡AÄRILDI! from_restart={from_restart}")
            
            # RUNALL Allowed modunu kontrol et
            if hasattr(self, 'runall_allowed_var'):
                self.runall_allowed_mode = self.runall_allowed_var.get()
            else:
                self.runall_allowed_mode = False
            
            print(f"[RUNALL] ğŸ” Allowed Mode: {self.runall_allowed_mode}")
            
            # RUNALL dÃ¶ngÃ¼sÃ¼ durumu kontrolÃ¼ (toggle)
            if not hasattr(self, 'runall_loop_running'):
                self.runall_loop_running = False
                self.runall_loop_count = 0
            
            # EÄŸer dÃ¶ngÃ¼ Ã§alÄ±ÅŸÄ±yorsa durdur (ama restart'tan geliyorsa atla)
            if self.runall_loop_running and not from_restart:
                self.stop_runall_loop()
                return
            
            # DÃ¶ngÃ¼yÃ¼ baÅŸlat
            self.runall_loop_running = True
            
            # TÄ±klanmÄ±ÅŸ butonlarÄ± ve kapatÄ±lmÄ±ÅŸ pencereleri temizle (yeni dÃ¶ngÃ¼ baÅŸladÄ±ÄŸÄ±nda)
            if hasattr(self, '_clicked_buttons'):
                self._clicked_buttons.clear()
            if hasattr(self, '_closed_windows'):
                self._closed_windows.clear()
            
            print("[RUNALL] â–¶ï¸ RUNALL sÄ±rasÄ± baÅŸlatÄ±lÄ±yor...")
            self.safe_ui_call(self.log_message, "â–¶ï¸ RUNALL sÄ±rasÄ± baÅŸlatÄ±lÄ±yor...")
            
            # Psfalgo aktivite logu
            self.safe_ui_call(self.log_psfalgo_activity,
                action="RUNALL BaÅŸlatÄ±ldÄ±",
                details=f"Allowed Mode: {self.runall_allowed_mode}",
                status="INFO",
                category="RUNALL"
            )
            
            # Buton metnini gÃ¼ncelle (UI thread'de)
            def update_buttons():
                if hasattr(self, 'runall_btn'):
                    self.runall_btn.config(text="â–¶ï¸ RUNALL", state='disabled')
                if hasattr(self, 'runall_stop_btn'):
                    self.runall_stop_btn.config(state='normal')
            self.safe_ui_call(update_buttons)
            
            # DÃ¶ngÃ¼ sayacÄ±nÄ± artÄ±r (her zaman artÄ±r, restart'tan geliyorsa da)
            self.runall_loop_count += 1
            
            # DÃ¶ngÃ¼ raporunu temizle (yeni dÃ¶ngÃ¼ baÅŸlÄ±yor)
            self.clear_loop_report()
            self.loop_report_loop_number = self.runall_loop_count
            
            print(f"[RUNALL] ğŸ”„ {self.runall_loop_count}. dÃ¶ngÃ¼ baÅŸlatÄ±lÄ±yor...")
            self.safe_ui_call(self.log_message, f"ğŸ”„ {self.runall_loop_count}. dÃ¶ngÃ¼ baÅŸlatÄ±lÄ±yor...")
            
            # DÃ¶ngÃ¼ sayacÄ± label'Ä±nÄ± gÃ¼ncelle (UI thread'de)
            def update_loop_label():
                if hasattr(self, 'runall_loop_label'):
                    self.runall_loop_label.config(text=f"DÃ¶ngÃ¼: {self.runall_loop_count}")
            self.safe_ui_call(update_loop_label)
            
            # Bot pencereleri Ã¶ne getirmeyecek - kullanÄ±cÄ± istediÄŸi pencereye geÃ§ebilir
            # Psfalgo penceresi arka planda kalabilir, kullanÄ±cÄ± isterse aÃ§abilir
            
            # AdÄ±m 1: Lot bÃ¶lÃ¼cÃ¼ kontrolÃ¼ (checkbox'tan kontrol edilecek)
            if hasattr(self, 'runall_lot_divider_var'):
                lot_divider_enabled = self.runall_lot_divider_var.get()
                if lot_divider_enabled and not self.lot_divider_enabled:
                    self.lot_divider_enabled = True
                    def update_lot_divider():
                        self.btn_lot_divider.config(text="ğŸ“¦ Lot BÃ¶lÃ¼cÃ¼: ON")
                        self.btn_lot_divider.config(style='Success.TButton')
                    self.safe_ui_call(update_lot_divider)
                    print("[RUNALL] âœ… AdÄ±m 1: Lot BÃ¶lÃ¼cÃ¼ aÃ§Ä±ldÄ± (checkbox aktif)")
                    self.safe_ui_call(self.log_message, "âœ… AdÄ±m 1: Lot BÃ¶lÃ¼cÃ¼ aÃ§Ä±ldÄ± (checkbox aktif)")
                elif not lot_divider_enabled:
                    print("[RUNALL] â„¹ï¸ AdÄ±m 1: Lot BÃ¶lÃ¼cÃ¼ checkbox iÅŸaretli deÄŸil, aÃ§Ä±lmayacak")
                    self.safe_ui_call(self.log_message, "â„¹ï¸ AdÄ±m 1: Lot BÃ¶lÃ¼cÃ¼ checkbox iÅŸaretli deÄŸil")
                else:
                    print("[RUNALL] â„¹ï¸ AdÄ±m 1: Lot BÃ¶lÃ¼cÃ¼ zaten aÃ§Ä±k")
                    self.safe_ui_call(self.log_message, "â„¹ï¸ AdÄ±m 1: Lot BÃ¶lÃ¼cÃ¼ zaten aÃ§Ä±k")
            else:
                print("[RUNALL] â„¹ï¸ AdÄ±m 1: Lot BÃ¶lÃ¼cÃ¼ checkbox bulunamadÄ±, aÃ§Ä±lmayacak")
                self.safe_ui_call(self.log_message, "â„¹ï¸ AdÄ±m 1: Lot BÃ¶lÃ¼cÃ¼ checkbox bulunamadÄ±")
            
            # AdÄ±m 2: Controller'Ä± ON yap (aktif moda gÃ¶re doÄŸru CSV kullanÄ±lacak)
            if not self.controller_enabled:
                self.controller_enabled = True
                def update_controller():
                    self.controller_btn.config(text="ğŸ›ï¸ Controller: ON")
                    self.controller_btn.config(style='Success.TButton')
                self.safe_ui_call(update_controller)
                
                # Aktif modu logla
                active_account = self.mode_manager.get_active_account()
                if active_account == "IBKR_GUN":
                    csv_file = "befibgun.csv"
                elif active_account == "IBKR_PED":
                    csv_file = "befibped.csv"
                elif active_account == "HAMPRO":
                    csv_file = "befham.csv"
                else:
                    csv_file = "bilinmeyen"
                
                print(f"[RUNALL] âœ… AdÄ±m 2: Controller ON yapÄ±ldÄ± (CSV: {csv_file})")
                self.safe_ui_call(self.log_message, f"âœ… AdÄ±m 2: Controller ON yapÄ±ldÄ± (CSV: {csv_file})")
            else:
                print("[RUNALL] â„¹ï¸ AdÄ±m 2: Controller zaten ON")
                self.safe_ui_call(self.log_message, "â„¹ï¸ AdÄ±m 2: Controller zaten ON")
            
            # AdÄ±m 3: Pot Toplam kontrolÃ¼ ve ADDNEWPOS butonu durumu (thread'de yapÄ±lacak)
            def check_exposure_and_start_karbotu():
                """Exposure kontrolÃ¼nÃ¼ thread'de yap ve KARBOTU'yu baÅŸlat"""
                try:
                    print("[RUNALL] ğŸ” check_exposure_and_start_karbotu Ã‡AÄRILDI!")
                    # Exposure kontrolÃ¼ (async - callback ile sonuÃ§ al)
                    exposure_result = {'ready': False}
                    def exposure_callback(exposure_info):
                        print(f"[RUNALL] âœ… Exposure callback Ã§aÄŸrÄ±ldÄ±: mode={exposure_info.get('mode')}")
                        exposure_result['info'] = exposure_info
                        exposure_result['ready'] = True
                    
                    print("[RUNALL] ğŸ” check_exposure_limits_async Ã§aÄŸrÄ±lÄ±yor...")
                    # Async exposure kontrolÃ¼ baÅŸlat
                    self.check_exposure_limits_async(callback=exposure_callback)
                    
                    # Sonucu bekle (ama UI'Ä± bloklamadan)
                    import time
                    timeout = 5  # 5 saniye timeout (10'dan 5'e dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ - daha hÄ±zlÄ±)
                    elapsed = 0
                    check_interval = 0.1  # 100ms bekle
                    while not exposure_result['ready'] and elapsed < timeout:
                        time.sleep(check_interval)
                        elapsed += check_interval
                        if elapsed % 1.0 < check_interval:  # Her saniye log
                            print(f"[RUNALL] â³ Exposure kontrolÃ¼ bekleniyor... ({elapsed:.1f}/{timeout}s)")
                    
                    if not exposure_result['ready']:
                        print(f"[RUNALL] âš ï¸ Exposure kontrolÃ¼ timeout! ({timeout} saniye) - KARBOTU varsayÄ±lan modda baÅŸlatÄ±lÄ±yor...")
                        self.safe_ui_call(self.log_message, f"âš ï¸ Exposure kontrolÃ¼ timeout! ({timeout} saniye) - KARBOTU varsayÄ±lan modda baÅŸlatÄ±lÄ±yor...")
                        # Hata olsa bile KARBOTU'yu baÅŸlat (varsayÄ±lan OFANSIF modunda)
                        self.runall_waiting_for_karbotu = True
                        self.runall_addnewpos_triggered = False
                        self.safe_ui_call(self.start_karbotu_automation)
                        return
                    
                    exposure_info = exposure_result['info']
                    pot_total = exposure_info.get('pot_total', 0)
                    pot_max_lot = exposure_info.get('pot_max_lot', 63636)
                    total_lots = exposure_info.get('total_lots', 0)
                    max_lot = exposure_info.get('max_lot', 54545)
                    mode = exposure_info.get('mode', 'UNKNOWN')
                    
                    # UI thread'ine geÃ§iÅŸ yaparak buton durumlarÄ±nÄ± gÃ¼ncelle
                    def update_ui():
                        # Pot Toplam kontrolÃ¼
                        if pot_total > 0 and pot_total >= pot_max_lot:
                            print(f"[RUNALL] âš ï¸ Pot Toplam limiti aÅŸÄ±ldÄ±: {pot_total:,} / {pot_max_lot:,}")
                            self.log_message(f"âš ï¸ Pot Toplam limiti aÅŸÄ±ldÄ±: {pot_total:,} / {pot_max_lot:,}")
                            # ADDNEWPOS butonunu pasif yap
                            if hasattr(self, 'addnewpos_btn'):
                                self.addnewpos_btn.config(state='disabled')
                        else:
                            # ADDNEWPOS butonu durumu
                            if mode == "OFANSIF" and pot_total < pot_max_lot:
                                if hasattr(self, 'addnewpos_btn'):
                                    self.addnewpos_btn.config(state='normal')
                                    print(f"[RUNALL] âœ… ADDNEWPOS aktif: Pot Toplam {pot_total:,} < Pot Max {pot_max_lot:,}")
                                    self.log_message(f"âœ… ADDNEWPOS aktif: Pot Toplam {pot_total:,} < Pot Max {pot_max_lot:,}")
                            else:
                                if hasattr(self, 'addnewpos_btn'):
                                    self.addnewpos_btn.config(state='disabled')
                        
                        # AdÄ±m 4: Mode'a gÃ¶re KARBOTU veya REDUCEMORE baÅŸlat
                        if mode == "OFANSIF":
                            print("[RUNALL] âœ… AdÄ±m 4: Mode=OFANSIF â†’ KARBOTU baÅŸlatÄ±lÄ±yor...")
                            self.log_message("âœ… AdÄ±m 4: Mode=OFANSIF â†’ KARBOTU baÅŸlatÄ±lÄ±yor...")
                            
                            # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
                            self.update_idletasks()
                            
                            # KARBOTU bitince otomatik ADDNEWPOS tetikleme iÃ§in callback ekle
                            self.runall_waiting_for_karbotu = True
                            self.runall_addnewpos_triggered = False  # ADDNEWPOS'un sadece bir kez tetiklenmesini saÄŸla
                            
                            # KARBOTU'yu non-blocking baÅŸlat
                            self.after(100, self.start_karbotu_automation)
                        else:
                            # DEFANSIF veya GECIS modunda REDUCEMORE kullan
                            print(f"[RUNALL] âœ… AdÄ±m 4: Mode={mode} â†’ REDUCEMORE baÅŸlatÄ±lÄ±yor...")
                            self.log_message(f"âœ… AdÄ±m 4: Mode={mode} â†’ REDUCEMORE baÅŸlatÄ±lÄ±yor...")
                            
                            # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
                            self.update_idletasks()
                            
                            # REDUCEMORE bitince otomatik ADDNEWPOS tetikleme iÃ§in callback ekle
                            self.runall_waiting_for_reducemore = True
                            self.runall_addnewpos_triggered = False  # ADDNEWPOS'un sadece bir kez tetiklenmesini saÄŸla
                            
                            # REDUCEMORE'u non-blocking baÅŸlat
                            self.after(100, self.start_reducemore_automation)
                    
                    # UI thread'ine geÃ§iÅŸ yap (safe_ui_call kullan)
                    self.safe_ui_call(update_ui)
                    
                except Exception as e:
                    print(f"[RUNALL] âŒ Exposure kontrolÃ¼ hatasÄ±: {e}")
                    self.log_message(f"âŒ Exposure kontrolÃ¼ hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile KARBOTU'yu baÅŸlat
                    self.after(0, lambda: self.start_karbotu_automation())
            
            # Exposure kontrolÃ¼nÃ¼ thread'de yap
            import threading
            exposure_thread = threading.Thread(target=check_exposure_and_start_karbotu, daemon=True)
            exposure_thread.start()
            
            # KARBOTU bitince kontrol et (her 5 saniyede bir kontrol) - SADECE BACKUP olarak
            # AsÄ±l tetikleme karbotu_proceed_to_next_step ve karbotu_step_13'ten gelecek
            # self.after(5000, self.runall_check_karbotu_and_addnewpos)  # YORUM SATIRI - Ã‡ift tetiklemeyi Ã¶nlemek iÃ§in
            
            print("[RUNALL] âœ… RUNALL sÄ±rasÄ± baÅŸlatÄ±ldÄ± (Mode'a gÃ¶re KARBOTU veya REDUCEMORE Ã§alÄ±ÅŸÄ±yor, bitince ADDNEWPOS kontrol edilecek)")
            self.log_message("âœ… RUNALL sÄ±rasÄ± baÅŸlatÄ±ldÄ± (Mode'a gÃ¶re KARBOTU veya REDUCEMORE Ã§alÄ±ÅŸÄ±yor, bitince ADDNEWPOS kontrol edilecek)")
            
            # Allowed modunda otomatik onay baÅŸlat
            if self.runall_allowed_mode:
                print("[RUNALL] âœ… Allowed modu aktif - Otomatik onay sistemi Ã§alÄ±ÅŸÄ±yor")
                self.log_message("âœ… Allowed modu aktif - Otomatik onay sistemi Ã§alÄ±ÅŸÄ±yor")
                self.start_runall_auto_confirm_loop()
            
        except Exception as e:
            print(f"[RUNALL] âŒ RUNALL hatasÄ±: {e}")
            self.log_message(f"âŒ RUNALL hatasÄ±: {e}")
            if not self.runall_allowed_mode:
                messagebox.showerror("Hata", f"RUNALL baÅŸlatÄ±lamadÄ±: {e}")
    
    def load_excluded_tickers_from_csv(self):
        """excluder_psfalgo.csv dosyasÄ±ndan excluded ticker'larÄ± yÃ¼kle"""
        try:
            import pandas as pd
            import os
            
            csv_file = "excluder_psfalgo.csv"
            
            if not hasattr(self, 'excluded_tickers'):
                self.excluded_tickers = set()
            
            if os.path.exists(csv_file):
                df = pd.read_csv(csv_file)
                
                # Symbol veya Ticker kolonunu bul
                symbol_col = None
                if 'Symbol' in df.columns:
                    symbol_col = 'Symbol'
                elif 'Ticker' in df.columns:
                    symbol_col = 'Ticker'
                elif len(df.columns) > 0:
                    symbol_col = df.columns[0]  # Ä°lk kolonu kullan
                
                if symbol_col:
                    tickers = df[symbol_col].dropna().astype(str).str.strip().str.upper()
                    self.excluded_tickers = set(tickers.tolist())
                    print(f"[EXCLUDER] âœ… {len(self.excluded_tickers)} ticker CSV'den yÃ¼klendi")
                else:
                    print(f"[EXCLUDER] âš ï¸ CSV dosyasÄ±nda uygun kolon bulunamadÄ±")
            else:
                print(f"[EXCLUDER] â„¹ï¸ CSV dosyasÄ± bulunamadÄ±, boÅŸ liste baÅŸlatÄ±lÄ±yor")
                self.excluded_tickers = set()
                
        except Exception as e:
            print(f"[EXCLUDER] âŒ CSV yÃ¼kleme hatasÄ±: {e}")
            if not hasattr(self, 'excluded_tickers'):
                self.excluded_tickers = set()
    
    def save_excluded_tickers_to_csv(self):
        """Excluded ticker'larÄ± excluder_psfalgo.csv dosyasÄ±na kaydet"""
        try:
            import pandas as pd
            
            csv_file = "excluder_psfalgo.csv"
            
            if not hasattr(self, 'excluded_tickers') or not self.excluded_tickers:
                # BoÅŸ liste ise CSV'yi sil veya boÅŸ DataFrame kaydet
                df = pd.DataFrame(columns=['Symbol'])
                df.to_csv(csv_file, index=False)
                print(f"[EXCLUDER] âœ… CSV dosyasÄ± temizlendi")
            else:
                # Ticker'larÄ± DataFrame'e Ã§evir
                tickers_list = sorted(list(self.excluded_tickers))
                df = pd.DataFrame({'Symbol': tickers_list})
                df.to_csv(csv_file, index=False)
                print(f"[EXCLUDER] âœ… {len(tickers_list)} ticker CSV'ye kaydedildi: {csv_file}")
                
        except Exception as e:
            print(f"[EXCLUDER] âŒ CSV kaydetme hatasÄ±: {e}")
            raise
    
    def load_rules_from_csv(self):
        """kurallar.csv dosyasÄ±ndan kurallarÄ± yÃ¼kle"""
        try:
            import pandas as pd
            import os
            
            csv_file = "kurallar.csv"
            
            if os.path.exists(csv_file):
                df = pd.read_csv(csv_file)
                
                # Her kural iÃ§in deÄŸeri oku
                for _, row in df.iterrows():
                    rule_name = row.get('Kural', '')
                    rule_value = row.get('Deger', 0)
                    
                    try:
                        # Temel kurallar
                        if rule_name == 'max_change_multiplier':
                            self.rule_max_change_multiplier = float(rule_value)
                        elif rule_name == 'single_max_position_multiplier':
                            self.rule_single_max_position_multiplier = float(rule_value)
                        elif rule_name == 'avg_adv_divisor':
                            self.rule_avg_adv_divisor = float(rule_value)
                        elif rule_name == 'min_lot':
                            self.rule_min_lot = int(float(rule_value))
                        
                        # ADDNEWPOS KurallarÄ±
                        elif rule_name.startswith('addnewpos_'):
                            parts = rule_name.split('_')
                            if len(parts) >= 3:
                                threshold = int(parts[1])
                                field = parts[2]
                                if threshold in self.addnewpos_rules:
                                    current = self.addnewpos_rules[threshold]
                                    if field == 'maxalw':
                                        self.addnewpos_rules[threshold] = (float(rule_value), current[1])
                                    elif field == 'port':
                                        self.addnewpos_rules[threshold] = (current[0], float(rule_value))
                        
                        # ADDNEWPOS Exposure Percentage
                        elif rule_name == 'addnewpos_exposure_percentage':
                            self.addnewpos_exposure_percentage = float(rule_value)
                            # 0-100 arasÄ± kontrol
                            if not (0 <= self.addnewpos_exposure_percentage <= 100):
                                self.addnewpos_exposure_percentage = 60
                        
                        # REDUCE KurallarÄ±
                        elif rule_name.startswith('reduce_'):
                            parts = rule_name.split('_')
                            if len(parts) >= 3:
                                threshold = int(parts[1])
                                field = parts[2]
                                if threshold in self.reduce_rules:
                                    current = self.reduce_rules[threshold]
                                    val = None if rule_value == 'None' or rule_value == '' else float(rule_value)
                                    if field == 'maxalw':
                                        self.reduce_rules[threshold] = (val, current[1])
                                    elif field == 'befday':
                                        self.reduce_rules[threshold] = (current[0], val)
                                        
                    except (ValueError, TypeError) as e:
                        print(f"[KURALLAR] âš ï¸ Kural parse hatasÄ±: {rule_name} = {rule_value} - {e}")
                
                print(f"[KURALLAR] âœ… Kurallar CSV'den yÃ¼klendi:")
                print(f"   Temel: Max Change={self.rule_max_change_multiplier}, SingleMax={self.rule_single_max_position_multiplier}, AVG_ADVÃ·={self.rule_avg_adv_divisor}, MinLot={self.rule_min_lot}")
                print(f"   ADDNEWPOS: {self.addnewpos_rules}")
                print(f"   REDUCE: {self.reduce_rules}")
            else:
                print(f"[KURALLAR] â„¹ï¸ CSV dosyasÄ± bulunamadÄ±, varsayÄ±lan deÄŸerler kullanÄ±lÄ±yor")
                
        except Exception as e:
            print(f"[KURALLAR] âŒ CSV yÃ¼kleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def save_rules_to_csv(self):
        """KurallarÄ± kurallar.csv dosyasÄ±na kaydet"""
        try:
            import pandas as pd
            
            csv_file = "kurallar.csv"
            
            # DataFrame oluÅŸtur - Temel kurallar
            data = [
                {'Kural': 'max_change_multiplier', 'Deger': self.rule_max_change_multiplier, 'Aciklama': 'Max Change = MAXALW * bu deÄŸer'},
                {'Kural': 'single_max_position_multiplier', 'Deger': self.rule_single_max_position_multiplier, 'Aciklama': 'Tek Pozisyon Limiti = MAXALW * bu deÄŸer'},
                {'Kural': 'avg_adv_divisor', 'Deger': self.rule_avg_adv_divisor, 'Aciklama': 'MAXALW = AVG_ADV / bu deÄŸer'},
                {'Kural': 'min_lot', 'Deger': self.rule_min_lot, 'Aciklama': 'Minimum lot deÄŸeri'}
            ]
            
            # ADDNEWPOS KurallarÄ±
            for threshold, (maxalw_mult, port_pct) in self.addnewpos_rules.items():
                data.append({'Kural': f'addnewpos_{threshold}_maxalw', 'Deger': maxalw_mult, 'Aciklama': f'ADDNEWPOS <%{threshold}: MAXALW Ã§arpanÄ±'})
                data.append({'Kural': f'addnewpos_{threshold}_port', 'Deger': port_pct, 'Aciklama': f'ADDNEWPOS <%{threshold}: PortfÃ¶y % limiti'})
            
            # ADDNEWPOS Exposure Percentage
            data.append({'Kural': 'addnewpos_exposure_percentage', 'Deger': self.addnewpos_exposure_percentage, 'Aciklama': 'ADDNEWPOS kalan exposure ayarÄ± (%0-100, default: 60)'})
            
            # REDUCE KurallarÄ±
            for threshold, (maxalw_mult, befday_mult) in self.reduce_rules.items():
                maxalw_val = 'None' if maxalw_mult is None else maxalw_mult
                befday_val = 'None' if befday_mult is None else befday_mult
                data.append({'Kural': f'reduce_{threshold}_maxalw', 'Deger': maxalw_val, 'Aciklama': f'REDUCE <%{threshold}: MAXALW Ã§arpanÄ±'})
                data.append({'Kural': f'reduce_{threshold}_befday', 'Deger': befday_val, 'Aciklama': f'REDUCE <%{threshold}: BefQty Ã§arpanÄ±'})
            
            df = pd.DataFrame(data)
            df.to_csv(csv_file, index=False)
            
            print(f"[KURALLAR] âœ… Kurallar CSV'ye kaydedildi: {csv_file}")
            print(f"   Temel: Max Change={self.rule_max_change_multiplier}, SingleMax={self.rule_single_max_position_multiplier}, AVG_ADVÃ·={self.rule_avg_adv_divisor}, MinLot={self.rule_min_lot}")
                
        except Exception as e:
            print(f"[KURALLAR] âŒ CSV kaydetme hatasÄ±: {e}")
            raise
    
    def show_rules_dialog(self):
        """Kurallar dialog penceresini gÃ¶ster - GeliÅŸmiÅŸ versiyon"""
        try:
            dialog = tk.Toplevel(self.psfalgo_window)
            dialog.title("ğŸ“‹ PSFAlgo KurallarÄ±")
            dialog.geometry("800x650")
            dialog.transient(self.psfalgo_window)
            # grab_set() kaldÄ±rÄ±ldÄ± - GUI'yi bloklamamak iÃ§in
            
            # BaÅŸlÄ±k
            title_label = ttk.Label(dialog, text="PSFAlgo Kural AyarlarÄ±", 
                                   font=("Arial", 14, "bold"))
            title_label.pack(pady=5)
            
            # Notebook (Tab sistemi)
            notebook = ttk.Notebook(dialog)
            notebook.pack(fill='both', expand=True, padx=10, pady=5)
            
            # ============ TAB 1: TEMEL KURALLAR ============
            basic_tab = ttk.Frame(notebook)
            notebook.add(basic_tab, text="âš™ï¸ Temel Kurallar")
            
            basic_frame = ttk.LabelFrame(basic_tab, text="Temel Hesaplama KurallarÄ±", padding=15)
            basic_frame.pack(fill='both', expand=True, padx=10, pady=10)
            
            # Kural 1: Max Change
            rule1_frame = ttk.Frame(basic_frame)
            rule1_frame.pack(fill='x', pady=8)
            ttk.Label(rule1_frame, text="Max Change (Todays Chg limiti):", font=("Arial", 10, "bold"), width=30).pack(side='left')
            ttk.Label(rule1_frame, text="MAXALW Ã—", font=("Arial", 10)).pack(side='left', padx=5)
            self.rule1_var = tk.StringVar(value=str(self.rule_max_change_multiplier))
            ttk.Entry(rule1_frame, textvariable=self.rule1_var, width=8).pack(side='left', padx=2)
            
            # Kural 2: Single Max Position
            rule2_frame = ttk.Frame(basic_frame)
            rule2_frame.pack(fill='x', pady=8)
            ttk.Label(rule2_frame, text="Tek Pozisyon Limiti:", font=("Arial", 10, "bold"), width=30).pack(side='left')
            ttk.Label(rule2_frame, text="MAXALW Ã—", font=("Arial", 10)).pack(side='left', padx=5)
            self.rule2_var = tk.StringVar(value=str(self.rule_single_max_position_multiplier))
            ttk.Entry(rule2_frame, textvariable=self.rule2_var, width=8).pack(side='left', padx=2)
            
            # Kural 3: AVG_ADV Divisor
            rule3_frame = ttk.Frame(basic_frame)
            rule3_frame.pack(fill='x', pady=8)
            ttk.Label(rule3_frame, text="MAXALW HesabÄ±:", font=("Arial", 10, "bold"), width=30).pack(side='left')
            ttk.Label(rule3_frame, text="AVG_ADV Ã·", font=("Arial", 10)).pack(side='left', padx=5)
            self.rule3_var = tk.StringVar(value=str(self.rule_avg_adv_divisor))
            ttk.Entry(rule3_frame, textvariable=self.rule3_var, width=8).pack(side='left', padx=2)
            
            # Kural 4: Minimum Lot
            rule4_frame = ttk.Frame(basic_frame)
            rule4_frame.pack(fill='x', pady=8)
            ttk.Label(rule4_frame, text="Minimum Lot DeÄŸeri:", font=("Arial", 10, "bold"), width=30).pack(side='left')
            self.rule_min_lot_var = tk.StringVar(value=str(self.rule_min_lot))
            ttk.Entry(rule4_frame, textvariable=self.rule_min_lot_var, width=8).pack(side='left', padx=5)
            ttk.Label(rule4_frame, text="(MAXALWÃ—Ã§arpan < bu deÄŸer ise, bu deÄŸer kullanÄ±lÄ±r)", font=("Arial", 8), foreground="gray").pack(side='left', padx=5)
            
            # ============ TAB 2: ADDNEWPOS KURALLARI ============
            addnewpos_tab = ttk.Frame(notebook)
            notebook.add(addnewpos_tab, text="â• ADDNEWPOS (Poz. ArtÄ±rma)")
            
            addnewpos_frame = ttk.LabelFrame(addnewpos_tab, text="Pozisyon ArtÄ±rma KurallarÄ± (BefQty / PortfÃ¶y OranÄ±na GÃ¶re)", padding=10)
            addnewpos_frame.pack(fill='both', expand=True, padx=10, pady=10)
            
            # BaÅŸlÄ±k satÄ±rÄ±
            header_frame = ttk.Frame(addnewpos_frame)
            header_frame.pack(fill='x', pady=5)
            ttk.Label(header_frame, text="EÅŸik (<%)", font=("Arial", 9, "bold"), width=12).pack(side='left', padx=5)
            ttk.Label(header_frame, text="MAXALW Ã‡arpanÄ±", font=("Arial", 9, "bold"), width=15).pack(side='left', padx=5)
            ttk.Label(header_frame, text="PortfÃ¶y % Limiti", font=("Arial", 9, "bold"), width=15).pack(side='left', padx=5)
            ttk.Label(header_frame, text="AÃ§Ä±klama", font=("Arial", 9, "bold")).pack(side='left', padx=5)
            
            ttk.Separator(addnewpos_frame, orient='horizontal').pack(fill='x', pady=5)
            
            # ADDNEWPOS deÄŸiÅŸkenleri
            self.addnewpos_vars = {}
            addnewpos_descriptions = {
                1: "BefQty < %1 (KÃ¼Ã§Ã¼k/Yeni poz.)",
                3: "BefQty %1 - %2.99",
                5: "BefQty %3 - %4.99",
                7: "BefQty %5 - %6.99",
                10: "BefQty %7 - %9.99",
                100: "BefQty >= %10 (BÃ¼yÃ¼k poz.)"
            }
            
            for threshold in [1, 3, 5, 7, 10, 100]:
                row_frame = ttk.Frame(addnewpos_frame)
                row_frame.pack(fill='x', pady=3)
                
                maxalw_mult, port_pct = self.addnewpos_rules.get(threshold, (0.5, 5.0))
                
                ttk.Label(row_frame, text=f"< {threshold}%" if threshold < 100 else "â‰¥ 10%", width=12).pack(side='left', padx=5)
                
                maxalw_var = tk.StringVar(value=str(maxalw_mult))
                ttk.Entry(row_frame, textvariable=maxalw_var, width=10).pack(side='left', padx=5)
                
                port_var = tk.StringVar(value=str(port_pct))
                ttk.Entry(row_frame, textvariable=port_var, width=10).pack(side='left', padx=5)
                
                ttk.Label(row_frame, text=addnewpos_descriptions.get(threshold, ""), font=("Arial", 8), foreground="gray").pack(side='left', padx=5)
                
                self.addnewpos_vars[threshold] = (maxalw_var, port_var)
            
            # ADDNEWPOS Exposure Limit AyarÄ±
            exposure_frame = ttk.LabelFrame(addnewpos_tab, text="ADDNEWPOS Kalan Exposure AyarÄ±", padding=10)
            exposure_frame.pack(fill='x', padx=10, pady=10)
            
            exposure_desc_frame = ttk.Frame(exposure_frame)
            exposure_desc_frame.pack(fill='x', pady=5)
            ttk.Label(exposure_desc_frame, text="Kalan exposure'a gÃ¶re lot ayarlama yÃ¼zdesi:", font=("Arial", 10, "bold"), width=40).pack(side='left', padx=5)
            self.addnewpos_exposure_var = tk.StringVar(value=str(self.addnewpos_exposure_percentage))
            exposure_entry = ttk.Entry(exposure_desc_frame, textvariable=self.addnewpos_exposure_var, width=8)
            exposure_entry.pack(side='left', padx=5)
            ttk.Label(exposure_desc_frame, text="%", font=("Arial", 10)).pack(side='left', padx=2)
            
            exposure_info_frame = ttk.Frame(exposure_frame)
            exposure_info_frame.pack(fill='x', padx=5, pady=5)
            ttk.Label(exposure_info_frame, text="ğŸ“Œ %100 = Eski hali (tam exposure doldurur)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            ttk.Label(exposure_info_frame, text="ğŸ“Œ %60 (default) = Kalan exposure'Ä±n %60'Ä±nÄ± kullanÄ±r", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            ttk.Label(exposure_info_frame, text="ğŸ“Œ Ã–rnek: 10,000 lot kalan exposure varsa, %60 ile 6,000 lot alÄ±nÄ±r", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            
            # AÃ§Ä±klama
            info_frame = ttk.Frame(addnewpos_tab)
            info_frame.pack(fill='x', padx=10, pady=5)
            ttk.Label(info_frame, text="ğŸ“Œ Limit = min(MAXALW Ã— Ã‡arpan, PortfÃ¶y Ã— % Limit)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            ttk.Label(info_frame, text="ğŸ“Œ MAXALW Ã— Ã‡arpan < Min Lot ise, Min Lot kullanÄ±lÄ±r", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            
            # ============ TAB 3: REDUCE KURALLARI ============
            reduce_tab = ttk.Frame(notebook)
            notebook.add(reduce_tab, text="ğŸ“‰ KARBOTU/REDUCEMORE (Poz. Azaltma)")
            
            reduce_frame = ttk.LabelFrame(reduce_tab, text="Pozisyon Azaltma KurallarÄ± (BefQty / PortfÃ¶y OranÄ±na GÃ¶re)", padding=10)
            reduce_frame.pack(fill='both', expand=True, padx=10, pady=10)
            
            # BaÅŸlÄ±k satÄ±rÄ±
            header_frame2 = ttk.Frame(reduce_frame)
            header_frame2.pack(fill='x', pady=5)
            ttk.Label(header_frame2, text="EÅŸik (<%)", font=("Arial", 9, "bold"), width=12).pack(side='left', padx=5)
            ttk.Label(header_frame2, text="MAXALW Ã‡arpanÄ±", font=("Arial", 9, "bold"), width=15).pack(side='left', padx=5)
            ttk.Label(header_frame2, text="BefQty Ã‡arpanÄ±", font=("Arial", 9, "bold"), width=15).pack(side='left', padx=5)
            ttk.Label(header_frame2, text="AÃ§Ä±klama", font=("Arial", 9, "bold")).pack(side='left', padx=5)
            
            ttk.Separator(reduce_frame, orient='horizontal').pack(fill='x', pady=5)
            
            # REDUCE deÄŸiÅŸkenleri
            self.reduce_vars = {}
            reduce_descriptions = {
                3: "BefQty < %3 (SÄ±nÄ±rsÄ±z, ters poz. yasak)",
                5: "BefQty %3 - %4.99",
                7: "BefQty %5 - %6.99",
                10: "BefQty %7 - %9.99",
                100: "BefQty >= %10 (BÃ¼yÃ¼k poz.)"
            }
            
            for threshold in [3, 5, 7, 10, 100]:
                row_frame = ttk.Frame(reduce_frame)
                row_frame.pack(fill='x', pady=3)
                
                maxalw_mult, befday_mult = self.reduce_rules.get(threshold, (0.5, 0.5))
                
                ttk.Label(row_frame, text=f"< {threshold}%" if threshold < 100 else "â‰¥ 10%", width=12).pack(side='left', padx=5)
                
                maxalw_val = "" if maxalw_mult is None else str(maxalw_mult)
                maxalw_var = tk.StringVar(value=maxalw_val)
                ttk.Entry(row_frame, textvariable=maxalw_var, width=10).pack(side='left', padx=5)
                
                befday_val = "" if befday_mult is None else str(befday_mult)
                befday_var = tk.StringVar(value=befday_val)
                ttk.Entry(row_frame, textvariable=befday_var, width=10).pack(side='left', padx=5)
                
                ttk.Label(row_frame, text=reduce_descriptions.get(threshold, ""), font=("Arial", 8), foreground="gray").pack(side='left', padx=5)
                
                self.reduce_vars[threshold] = (maxalw_var, befday_var)
            
            # AÃ§Ä±klama
            info_frame2 = ttk.Frame(reduce_tab)
            info_frame2.pack(fill='x', padx=10, pady=5)
            ttk.Label(info_frame2, text="ğŸ“Œ Limit = min(MAXALW Ã— Ã‡arpan, BefQty Ã— Ã‡arpan)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            ttk.Label(info_frame2, text="ğŸ“Œ BoÅŸ bÄ±rakÄ±lan deÄŸerler = SÄ±nÄ±rsÄ±z (ama ters pozisyona geÃ§iÅŸ yasak)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            ttk.Label(info_frame2, text="ğŸ“Œ BefQty < Min Lot ise, tamamÄ± satÄ±labilir (ÅŸart aranmaz)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            
            # ============ BUTONLAR ============
            button_frame = ttk.Frame(dialog)
            button_frame.pack(fill='x', padx=20, pady=10)
            
            def save_and_close():
                try:
                    # Temel kurallarÄ± gÃ¼ncelle
                    self.rule_max_change_multiplier = float(self.rule1_var.get())
                    self.rule_single_max_position_multiplier = float(self.rule2_var.get())
                    self.rule_avg_adv_divisor = float(self.rule3_var.get())
                    self.rule_min_lot = int(float(self.rule_min_lot_var.get()))
                    
                    # ADDNEWPOS kurallarÄ±nÄ± gÃ¼ncelle
                    for threshold, (maxalw_var, port_var) in self.addnewpos_vars.items():
                        try:
                            maxalw_val = float(maxalw_var.get())
                            port_val = float(port_var.get())
                            self.addnewpos_rules[threshold] = (maxalw_val, port_val)
                        except ValueError:
                            pass
                    
                    # ADDNEWPOS Exposure Percentage gÃ¼ncelle
                    try:
                        exposure_pct = float(self.addnewpos_exposure_var.get())
                        # 0-100 arasÄ± kontrol
                        if 0 <= exposure_pct <= 100:
                            self.addnewpos_exposure_percentage = exposure_pct
                        else:
                            messagebox.showwarning("UyarÄ±", "Exposure yÃ¼zdesi 0-100 arasÄ± olmalÄ±dÄ±r. VarsayÄ±lan deÄŸer (%60) kullanÄ±ldÄ±.")
                            self.addnewpos_exposure_percentage = 60
                    except ValueError:
                        messagebox.showwarning("UyarÄ±", "GeÃ§ersiz exposure yÃ¼zdesi. VarsayÄ±lan deÄŸer (%60) kullanÄ±ldÄ±.")
                        self.addnewpos_exposure_percentage = 60
                    
                    # REDUCE kurallarÄ±nÄ± gÃ¼ncelle
                    for threshold, (maxalw_var, befday_var) in self.reduce_vars.items():
                        try:
                            maxalw_val = None if maxalw_var.get().strip() == '' else float(maxalw_var.get())
                            befday_val = None if befday_var.get().strip() == '' else float(befday_var.get())
                            self.reduce_rules[threshold] = (maxalw_val, befday_val)
                        except ValueError:
                            pass
                    
                    # CSV'ye kaydet
                    self.save_rules_to_csv()
                    
                    # Pozisyon tablosunu yenile
                    self.load_psfalgo_positions_async()
                    
                    self.log_message("âœ… TÃ¼m kurallar gÃ¼ncellendi ve kaydedildi")
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", "Kurallar kaydedildi ve uygulandÄ±!")
                    dialog.destroy()
                    
                except ValueError as e:
                    messagebox.showerror("Hata", f"GeÃ§ersiz deÄŸer: {e}")
                except Exception as e:
                    messagebox.showerror("Hata", f"Kaydetme hatasÄ±: {e}")
            
            def reset_to_defaults():
                # Temel kurallar
                self.rule1_var.set("0.75")
                self.rule2_var.set("1.0")
                self.rule3_var.set("10")
                self.rule_min_lot_var.set("400")
                
                # ADDNEWPOS varsayÄ±lanlarÄ±
                defaults_addnewpos = {1: (0.50, 5.0), 3: (0.40, 4.0), 5: (0.30, 3.0), 7: (0.20, 2.0), 10: (0.10, 1.5), 100: (0.05, 1.0)}
                for threshold, (maxalw_var, port_var) in self.addnewpos_vars.items():
                    m, p = defaults_addnewpos.get(threshold, (0.5, 5.0))
                    maxalw_var.set(str(m))
                    port_var.set(str(p))
                
                # ADDNEWPOS Exposure Percentage varsayÄ±lanÄ±
                self.addnewpos_exposure_var.set("60")
                
                # REDUCE varsayÄ±lanlarÄ±
                defaults_reduce = {3: (None, None), 5: (0.75, 0.75), 7: (0.60, 0.60), 10: (0.50, 0.50), 100: (0.40, 0.40)}
                for threshold, (maxalw_var, befday_var) in self.reduce_vars.items():
                    m, b = defaults_reduce.get(threshold, (0.5, 0.5))
                    maxalw_var.set("" if m is None else str(m))
                    befday_var.set("" if b is None else str(b))
            
            ttk.Button(button_frame, text="ğŸ’¾ Kaydet ve Kapat", command=save_and_close, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal", command=dialog.destroy).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ğŸ”„ VarsayÄ±lana DÃ¶n", command=reset_to_defaults).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KURALLAR] âŒ Dialog hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Kurallar penceresi aÃ§Ä±lamadÄ±: {e}")
    
    def round_lot(self, lot, is_reduce=False, remaining_position=0):
        """
        Lot yuvarlamasÄ± yap
        - 100'lÃ¼k tam sayÄ±ya yuvarla
        - 200'den kÃ¼Ã§Ã¼kse 200'e yuvarla
        - Pozisyon azaltmada kalan < 200 ise 0'a getir
        """
        if lot <= 0:
            return 0
        
        # 100'e yuvarla
        rounded = round(lot / 100) * 100
        
        # 200'den kÃ¼Ã§Ã¼kse 200 yap
        if rounded < 200:
            rounded = 200
        
        # Pozisyon azaltmada, kalan pozisyon 200'den az olacaksa tamamÄ±nÄ± sat
        if is_reduce and remaining_position > 0:
            if remaining_position - rounded < 200 and remaining_position - rounded > 0:
                rounded = remaining_position  # TamamÄ±nÄ± sat (0'a getir)
        
        return int(rounded)
    
    def get_portfolio_size(self):
        """Potansiyel portfÃ¶y bÃ¼yÃ¼klÃ¼ÄŸÃ¼nÃ¼ hesapla (lot cinsinden)"""
        try:
            pot_expo_limit = float(self.pot_expo_limit_var.get())
            avg_price = float(self.avg_price_var.get())
            return int(pot_expo_limit / avg_price)
        except:
            return 63636  # VarsayÄ±lan: 1.4M / 22
    
    def get_befday_portfolio_ratio(self, befday_qty):
        """BefDay Qty'nin portfÃ¶y iÃ§indeki yÃ¼zdesini hesapla"""
        portfolio_size = self.get_portfolio_size()
        if portfolio_size <= 0:
            return 0
        return (abs(befday_qty) / portfolio_size) * 100
    
    def get_addnewpos_limit(self, symbol, maxalw, befday_qty):
        """
        ADDNEWPOS iÃ§in gÃ¼nlÃ¼k limit hesapla
        
        Returns: (limit_lot, reason)
        """
        try:
            portfolio_size = self.get_portfolio_size()
            ratio = self.get_befday_portfolio_ratio(befday_qty)
            
            # Hangi eÅŸiÄŸe dÃ¼ÅŸÃ¼yor?
            thresholds = sorted(self.addnewpos_rules.keys())
            selected_threshold = thresholds[-1]  # VarsayÄ±lan en bÃ¼yÃ¼k
            
            for threshold in thresholds:
                if ratio < threshold:
                    selected_threshold = threshold
                    break
            
            maxalw_mult, port_pct = self.addnewpos_rules.get(selected_threshold, (0.5, 5.0))
            
            # Limit 1: MAXALW Ã— Ã§arpan (minimum rule_min_lot)
            limit1 = maxalw * maxalw_mult
            if limit1 < self.rule_min_lot:
                limit1 = self.rule_min_lot
            
            # Limit 2: PortfÃ¶y Ã— yÃ¼zde
            limit2 = portfolio_size * (port_pct / 100)
            
            # Ä°kisinin minimumu
            final_limit = min(limit1, limit2)
            final_limit = self.round_lot(final_limit)
            
            reason = f"BefQty={befday_qty:.0f} (Port %{ratio:.1f}), EÅŸik=<%{selected_threshold}, " \
                    f"Limit1=MAXALWÃ—{maxalw_mult}={limit1:.0f}, Limit2=PortÃ—%{port_pct}={limit2:.0f}, " \
                    f"Final={final_limit}"
            
            return final_limit, reason
            
        except Exception as e:
            print(f"[ADDNEWPOS LIMIT] âŒ Hesaplama hatasÄ±: {e}")
            return self.rule_min_lot, f"Hata: {e}"
    
    def get_reduce_limit(self, symbol, maxalw, befday_qty):
        """
        KARBOTU/REDUCEMORE iÃ§in gÃ¼nlÃ¼k azaltma limiti hesapla
        
        Returns: (limit_lot, reason, is_unlimited)
        """
        try:
            abs_befday = abs(befday_qty)
            
            # EÄŸer BefQty < min_lot ise, tamamÄ± satÄ±labilir (ÅŸart aranmaz)
            if abs_befday < self.rule_min_lot:
                return abs_befday, f"BefQty={befday_qty:.0f} < MinLot={self.rule_min_lot}, tamamÄ± satÄ±labilir", True
            
            portfolio_size = self.get_portfolio_size()
            ratio = self.get_befday_portfolio_ratio(befday_qty)
            
            # Hangi eÅŸiÄŸe dÃ¼ÅŸÃ¼yor?
            thresholds = sorted(self.reduce_rules.keys())
            selected_threshold = thresholds[-1]  # VarsayÄ±lan en bÃ¼yÃ¼k
            
            for threshold in thresholds:
                if ratio < threshold:
                    selected_threshold = threshold
                    break
            
            maxalw_mult, befday_mult = self.reduce_rules.get(selected_threshold, (0.5, 0.5))
            
            # None = sÄ±nÄ±rsÄ±z (ama ters pozisyona geÃ§iÅŸ yasak)
            if maxalw_mult is None and befday_mult is None:
                return abs_befday, f"BefQty={befday_qty:.0f} (Port %{ratio:.1f}), EÅŸik=<%{selected_threshold}, SÄ±nÄ±rsÄ±z (ters poz. yasak)", True
            
            # Limit 1: MAXALW Ã— Ã§arpan (minimum rule_min_lot)
            limit1 = float('inf')
            if maxalw_mult is not None:
                limit1 = maxalw * maxalw_mult
                if limit1 < self.rule_min_lot:
                    limit1 = self.rule_min_lot
            
            # Limit 2: BefQty Ã— Ã§arpan
            limit2 = float('inf')
            if befday_mult is not None:
                limit2 = abs_befday * befday_mult
            
            # Ä°kisinin minimumu
            final_limit = min(limit1, limit2)
            if final_limit == float('inf'):
                final_limit = abs_befday
            
            final_limit = self.round_lot(final_limit, is_reduce=True, remaining_position=abs_befday)
            
            reason = f"BefQty={befday_qty:.0f} (Port %{ratio:.1f}), EÅŸik=<%{selected_threshold}, " \
                    f"Limit1=MAXALWÃ—{maxalw_mult}={limit1:.0f}, Limit2=BefQtyÃ—{befday_mult}={limit2:.0f}, " \
                    f"Final={final_limit}"
            
            return final_limit, reason, False
            
        except Exception as e:
            print(f"[REDUCE LIMIT] âŒ Hesaplama hatasÄ±: {e}")
            return self.rule_min_lot, f"Hata: {e}", False
    
    def check_addnewpos_limits(self, symbol, current_qty, befday_qty, order_qty, order_side, maxalw):
        """
        ADDNEWPOS emirleri iÃ§in limit kontrolÃ¼
        
        Returns: (allowed, adjusted_qty, reason)
        """
        try:
            # GÃ¼nlÃ¼k limit hesapla
            daily_limit, limit_reason = self.get_addnewpos_limit(symbol, maxalw, befday_qty)
            
            # Mevcut gÃ¼nlÃ¼k deÄŸiÅŸim
            current_change = abs(current_qty - befday_qty)
            
            # Kalan hak
            remaining_allowance = daily_limit - current_change
            if remaining_allowance < 0:
                remaining_allowance = 0
            
            # Emir miktarÄ± kalan haktan fazla mÄ±?
            if order_qty > remaining_allowance:
                if remaining_allowance <= 0:
                    return False, 0, f"ADDNEWPOS Limit: GÃ¼nlÃ¼k limit doldu ({current_change:.0f}/{daily_limit:.0f})"
                else:
                    adjusted = self.round_lot(remaining_allowance)
                    return True, adjusted, f"ADDNEWPOS Limit: Emir {order_qty} â†’ {adjusted} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ ({limit_reason})"
            
            return True, order_qty, f"ADDNEWPOS Limit OK: {current_change:.0f}+{order_qty} <= {daily_limit:.0f}"
            
        except Exception as e:
            print(f"[ADDNEWPOS CHECK] âŒ Hata: {e}")
            return True, order_qty, f"Hata: {e}"
    
    def check_reduce_limits(self, symbol, current_qty, befday_qty, order_qty, order_side, maxalw):
        """
        KARBOTU/REDUCEMORE emirleri iÃ§in limit kontrolÃ¼
        
        Returns: (allowed, adjusted_qty, reason)
        """
        try:
            abs_befday = abs(befday_qty)
            
            # GÃ¼nlÃ¼k limit hesapla
            daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
            
            # Mevcut gÃ¼nlÃ¼k deÄŸiÅŸim (azaltma yÃ¶nÃ¼nde)
            current_change = abs(current_qty - befday_qty)
            
            # SÄ±nÄ±rsÄ±z ise, sadece ters pozisyona geÃ§memeye dikkat et
            if is_unlimited:
                # Ters pozisyona geÃ§iÅŸ kontrolÃ¼
                if befday_qty > 0 and current_qty - order_qty < 0:
                    # Long â†’ Short geÃ§iÅŸi engellenecek
                    adjusted = current_qty  # Mevcut pozisyonu 0'a getir
                    return True, adjusted, f"REDUCE: Ters poz. yasak, emir {order_qty} â†’ {adjusted} (0'a getir)"
                elif befday_qty < 0 and current_qty + order_qty > 0:
                    # Short â†’ Long geÃ§iÅŸi engellenecek
                    adjusted = abs(current_qty)
                    return True, adjusted, f"REDUCE: Ters poz. yasak, emir {order_qty} â†’ {adjusted} (0'a getir)"
                
                return True, order_qty, f"REDUCE Limit OK (SÄ±nÄ±rsÄ±z): {limit_reason}"
            
            # Kalan hak
            remaining_allowance = daily_limit - current_change
            if remaining_allowance < 0:
                remaining_allowance = 0
            
            # Emir miktarÄ± kalan haktan fazla mÄ±?
            if order_qty > remaining_allowance:
                if remaining_allowance <= 0:
                    return False, 0, f"REDUCE Limit: GÃ¼nlÃ¼k limit doldu ({current_change:.0f}/{daily_limit:.0f})"
                else:
                    adjusted = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                    return True, adjusted, f"REDUCE Limit: Emir {order_qty} â†’ {adjusted} lot'a dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ ({limit_reason})"
            
            return True, order_qty, f"REDUCE Limit OK: {current_change:.0f}+{order_qty} <= {daily_limit:.0f}"
            
        except Exception as e:
            print(f"[REDUCE CHECK] âŒ Hata: {e}")
            return True, order_qty, f"Hata: {e}"
    
    def load_benchmark_shift_from_csv(self):
        """benchmark_shift.csv dosyasÄ±ndan benchmark shift deÄŸerini yÃ¼kle"""
        try:
            import pandas as pd
            import os
            
            csv_file = "benchmark_shift.csv"
            
            if os.path.exists(csv_file):
                df = pd.read_csv(csv_file)
                
                # Shift deÄŸerini bul
                if 'shift_value' in df.columns:
                    shift_value = df['shift_value'].iloc[0]
                elif 'benchmark_shift' in df.columns:
                    shift_value = df['benchmark_shift'].iloc[0]
                elif len(df.columns) > 0:
                    shift_value = df.iloc[0, 0]  # Ä°lk kolonun ilk deÄŸeri
                else:
                    shift_value = 0.0
                
                # Float'a Ã§evir
                try:
                    self.benchmark_shift = float(shift_value)
                    print(f"[BM SHIFTER] âœ… Benchmark shift deÄŸeri CSV'den yÃ¼klendi: {self.benchmark_shift:.4f}")
                except (ValueError, TypeError):
                    self.benchmark_shift = 0.0
                    print(f"[BM SHIFTER] âš ï¸ CSV'deki deÄŸer geÃ§ersiz, default 0.0 kullanÄ±lÄ±yor")
            else:
                # CSV yoksa default 0.0
                self.benchmark_shift = 0.0
                print(f"[BM SHIFTER] â„¹ï¸ CSV dosyasÄ± bulunamadÄ±, default 0.0 kullanÄ±lÄ±yor")
                
        except Exception as e:
            print(f"[BM SHIFTER] âŒ CSV yÃ¼kleme hatasÄ±: {e}")
            self.benchmark_shift = 0.0  # Hata durumunda default
    
    def save_benchmark_shift_to_csv(self, shift_value):
        """Benchmark shift deÄŸerini benchmark_shift.csv dosyasÄ±na kaydet"""
        try:
            import pandas as pd
            
            csv_file = "benchmark_shift.csv"
            
            # DataFrame oluÅŸtur
            df = pd.DataFrame({'shift_value': [shift_value]})
            df.to_csv(csv_file, index=False)
            
            print(f"[BM SHIFTER] âœ… Benchmark shift deÄŸeri CSV'ye kaydedildi: {shift_value:.4f}")
                
        except Exception as e:
            print(f"[BM SHIFTER] âŒ CSV kaydetme hatasÄ±: {e}")
            raise
    
    def load_psfalgo_filters_from_csv(self):
        """psfalgofilters.csv dosyasÄ±ndan JFIN filtrelerini yÃ¼kle"""
        try:
            import pandas as pd
            import os
            
            csv_file = "psfalgofilters.csv"
            
            if os.path.exists(csv_file):
                df = pd.read_csv(csv_file)
                
                # Long filtreleri yÃ¼kle
                if 'long_sma_value' in df.columns:
                    long_sma_val = str(df['long_sma_value'].iloc[0]) if pd.notna(df['long_sma_value'].iloc[0]) else "-1.6"
                    if hasattr(self, 'long_sma_filter_var'):
                        self.long_sma_filter_var.set(long_sma_val)
                if 'long_sma_type' in df.columns:
                    long_sma_typ = str(df['long_sma_type'].iloc[0]) if pd.notna(df['long_sma_type'].iloc[0]) else "below"
                    if hasattr(self, 'long_sma_filter_type'):
                        self.long_sma_filter_type.set(long_sma_typ)
                
                if 'long_fbtot_value' in df.columns:
                    long_fbtot_val = str(df['long_fbtot_value'].iloc[0]) if pd.notna(df['long_fbtot_value'].iloc[0]) else ""
                    if hasattr(self, 'long_fbtot_filter_var'):
                        self.long_fbtot_filter_var.set(long_fbtot_val)
                if 'long_fbtot_type' in df.columns:
                    long_fbtot_typ = str(df['long_fbtot_type'].iloc[0]) if pd.notna(df['long_fbtot_type'].iloc[0]) else "below"
                    if hasattr(self, 'long_fbtot_filter_type'):
                        self.long_fbtot_filter_type.set(long_fbtot_typ)
                
                if 'long_gort_value' in df.columns:
                    long_gort_val = str(df['long_gort_value'].iloc[0]) if pd.notna(df['long_gort_value'].iloc[0]) else ""
                    if hasattr(self, 'long_gort_filter_var'):
                        self.long_gort_filter_var.set(long_gort_val)
                if 'long_gort_type' in df.columns:
                    long_gort_typ = str(df['long_gort_type'].iloc[0]) if pd.notna(df['long_gort_type'].iloc[0]) else "below"
                    if hasattr(self, 'long_gort_filter_type'):
                        self.long_gort_filter_type.set(long_gort_typ)
                
                # Short filtreleri yÃ¼kle
                if 'short_sma_value' in df.columns:
                    short_sma_val = str(df['short_sma_value'].iloc[0]) if pd.notna(df['short_sma_value'].iloc[0]) else ""
                    if hasattr(self, 'short_sma_filter_var'):
                        self.short_sma_filter_var.set(short_sma_val)
                if 'short_sma_type' in df.columns:
                    short_sma_typ = str(df['short_sma_type'].iloc[0]) if pd.notna(df['short_sma_type'].iloc[0]) else "below"
                    if hasattr(self, 'short_sma_filter_type'):
                        self.short_sma_filter_type.set(short_sma_typ)
                
                if 'short_sfstot_value' in df.columns:
                    short_sfstot_val = str(df['short_sfstot_value'].iloc[0]) if pd.notna(df['short_sfstot_value'].iloc[0]) else ""
                    if hasattr(self, 'short_sfstot_filter_var'):
                        self.short_sfstot_filter_var.set(short_sfstot_val)
                if 'short_sfstot_type' in df.columns:
                    short_sfstot_typ = str(df['short_sfstot_type'].iloc[0]) if pd.notna(df['short_sfstot_type'].iloc[0]) else "below"
                    if hasattr(self, 'short_sfstot_filter_type'):
                        self.short_sfstot_filter_type.set(short_sfstot_typ)
                
                if 'short_gort_value' in df.columns:
                    short_gort_val = str(df['short_gort_value'].iloc[0]) if pd.notna(df['short_gort_value'].iloc[0]) else ""
                    if hasattr(self, 'short_gort_filter_var'):
                        self.short_gort_filter_var.set(short_gort_val)
                if 'short_gort_type' in df.columns:
                    short_gort_typ = str(df['short_gort_type'].iloc[0]) if pd.notna(df['short_gort_type'].iloc[0]) else "below"
                    if hasattr(self, 'short_gort_filter_type'):
                        self.short_gort_filter_type.set(short_gort_typ)
                
                print(f"[PSFALGO FILTERS] âœ… Filtreler CSV'den yÃ¼klendi: {csv_file}")
            else:
                print(f"[PSFALGO FILTERS] â„¹ï¸ CSV dosyasÄ± bulunamadÄ±, varsayÄ±lan deÄŸerler kullanÄ±lÄ±yor")
                
        except Exception as e:
            print(f"[PSFALGO FILTERS] âŒ CSV yÃ¼kleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def save_psfalgo_filters_to_csv(self):
        """JFIN filtrelerini psfalgofilters.csv dosyasÄ±na kaydet"""
        try:
            import pandas as pd
            
            csv_file = "psfalgofilters.csv"
            
            # Mevcut filtre deÄŸerlerini al
            long_sma_value = self.long_sma_filter_var.get() if hasattr(self, 'long_sma_filter_var') else "-1.6"
            long_sma_type = self.long_sma_filter_type.get() if hasattr(self, 'long_sma_filter_type') else "below"
            long_fbtot_value = self.long_fbtot_filter_var.get() if hasattr(self, 'long_fbtot_filter_var') else ""
            long_fbtot_type = self.long_fbtot_filter_type.get() if hasattr(self, 'long_fbtot_filter_type') else "below"
            long_gort_value = self.long_gort_filter_var.get() if hasattr(self, 'long_gort_filter_var') else ""
            long_gort_type = self.long_gort_filter_type.get() if hasattr(self, 'long_gort_filter_type') else "below"
            
            short_sma_value = self.short_sma_filter_var.get() if hasattr(self, 'short_sma_filter_var') else ""
            short_sma_type = self.short_sma_filter_type.get() if hasattr(self, 'short_sma_filter_type') else "below"
            short_sfstot_value = self.short_sfstot_filter_var.get() if hasattr(self, 'short_sfstot_filter_var') else ""
            short_sfstot_type = self.short_sfstot_filter_type.get() if hasattr(self, 'short_sfstot_filter_type') else "below"
            short_gort_value = self.short_gort_filter_var.get() if hasattr(self, 'short_gort_filter_var') else ""
            short_gort_type = self.short_gort_filter_type.get() if hasattr(self, 'short_gort_filter_type') else "below"
            
            # DataFrame oluÅŸtur
            df = pd.DataFrame({
                'long_sma_value': [long_sma_value],
                'long_sma_type': [long_sma_type],
                'long_fbtot_value': [long_fbtot_value],
                'long_fbtot_type': [long_fbtot_type],
                'long_gort_value': [long_gort_value],
                'long_gort_type': [long_gort_type],
                'short_sma_value': [short_sma_value],
                'short_sma_type': [short_sma_type],
                'short_sfstot_value': [short_sfstot_value],
                'short_sfstot_type': [short_sfstot_type],
                'short_gort_value': [short_gort_value],
                'short_gort_type': [short_gort_type]
            })
            
            df.to_csv(csv_file, index=False)
            print(f"[PSFALGO FILTERS] âœ… Filtreler CSV'ye kaydedildi: {csv_file}")
            
        except Exception as e:
            print(f"[PSFALGO FILTERS] âŒ CSV kaydetme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            raise
    
    def show_save_filters_dialog(self):
        """Filtreleri kaydetme dialog penceresi gÃ¶ster"""
        try:
            dialog = tk.Toplevel(self.psfalgo_window)
            dialog.title("Filtreleri Kaydet")
            dialog.geometry("300x150")
            dialog.transient(self.psfalgo_window)
            # grab_set() kaldÄ±rÄ±ldÄ± - GUI'yi bloklamamak iÃ§in
            
            # Pencereyi ortala
            dialog.update_idletasks()
            x = (dialog.winfo_screenwidth() // 2) - (300 // 2)
            y = (dialog.winfo_screenheight() // 2) - (150 // 2)
            dialog.geometry(f"300x150+{x}+{y}")
            
            # Mesaj
            msg_label = ttk.Label(dialog, text="Filtreleri kaydetmek istiyor musunuz?", 
                                 font=("Arial", 10))
            msg_label.pack(pady=20)
            
            # Butonlar
            button_frame = ttk.Frame(dialog)
            button_frame.pack(pady=10)
            
            def save_and_close():
                try:
                    self.save_psfalgo_filters_to_csv()
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", "Filtreler baÅŸarÄ±yla kaydedildi!", parent=dialog)
                    dialog.destroy()
                except Exception as e:
                    messagebox.showerror("Hata", f"Kaydetme hatasÄ±: {e}", parent=dialog)
            
            save_btn = ttk.Button(button_frame, text="ğŸ’¾ Kaydet ve Kapat", 
                                  command=save_and_close, width=15)
            save_btn.pack(side='left', padx=5)
            
            cancel_btn = ttk.Button(button_frame, text="âŒ Ä°ptal", 
                                    command=dialog.destroy, width=15)
            cancel_btn.pack(side='left', padx=5)
            
        except Exception as e:
            print(f"[PSFALGO FILTERS] âŒ Dialog hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            
            print(f"[BM SHIFTER] âœ… Benchmark shift deÄŸeri CSV'ye kaydedildi: {shift_value:.4f}")
                
        except Exception as e:
            print(f"[BM SHIFTER] âŒ CSV kaydetme hatasÄ±: {e}")
            raise
    
    def show_excluder_dialog(self):
        """Excluder dialog'unu gÃ¶ster - Ticker'larÄ± exclude etmek iÃ§in"""
        try:
            from tkinter import messagebox
            
            # CSV'den yÃ¼kle
            self.load_excluded_tickers_from_csv()
            
            # Dialog penceresi oluÅŸtur
            dialog = tk.Toplevel(self.psfalgo_window)
            dialog.title("ğŸš« Excluder - Ticker Exclude Listesi")
            dialog.geometry("600x500")
            dialog.transient(self.psfalgo_window)
            # grab_set() kaldÄ±rÄ±ldÄ± - GUI'yi bloklamamak iÃ§in
            
            # Ana frame
            main_frame = ttk.Frame(dialog)
            main_frame.pack(fill='both', expand=True, padx=10, pady=10)
            
            # AÃ§Ä±klama
            info_label = ttk.Label(main_frame, 
                                  text="Exclude edilecek ticker'larÄ± yÃ¶netin",
                                  font=("Arial", 10, "bold"))
            info_label.pack(pady=5)
            
            # Liste kutusu ve scrollbar
            list_frame = ttk.Frame(main_frame)
            list_frame.pack(fill='both', expand=True, pady=10)
            
            scrollbar = ttk.Scrollbar(list_frame)
            scrollbar.pack(side='right', fill='y')
            
            listbox = tk.Listbox(list_frame, height=12, yscrollcommand=scrollbar.set, selectmode=tk.EXTENDED)
            listbox.pack(side='left', fill='both', expand=True)
            scrollbar.config(command=listbox.yview)
            
            # Mevcut ticker'larÄ± listbox'a yÃ¼kle
            if hasattr(self, 'excluded_tickers') and self.excluded_tickers:
                for ticker in sorted(self.excluded_tickers):
                    listbox.insert(tk.END, ticker)
            
            # Ekleme alanÄ±
            add_frame = ttk.Frame(main_frame)
            add_frame.pack(fill='x', pady=5)
            
            ttk.Label(add_frame, text="Yeni Ticker Ekle (virgÃ¼lle ayÄ±rÄ±n):", font=("Arial", 9)).pack(anchor='w')
            
            entry_frame = ttk.Frame(add_frame)
            entry_frame.pack(fill='x', pady=5)
            
            entry_widget = ttk.Entry(entry_frame, width=50)
            entry_widget.pack(side='left', fill='x', expand=True, padx=(0, 5))
            
            def add_tickers():
                """Yeni ticker'lar ekle"""
                try:
                    text_content = entry_widget.get().strip()
                    if not text_content:
                        return
                    
                    # VirgÃ¼lle ayÄ±r ve temizle
                    new_tickers = [t.strip().upper() for t in text_content.split(',') if t.strip()]
                    
                    if not hasattr(self, 'excluded_tickers'):
                        self.excluded_tickers = set()
                    
                    added_count = 0
                    for ticker in new_tickers:
                        if ticker and ticker not in self.excluded_tickers:
                            self.excluded_tickers.add(ticker)
                            listbox.insert(tk.END, ticker)
                            added_count += 1
                    
                    if added_count > 0:
                        # Listbox'Ä± sÄ±rala
                        items = list(listbox.get(0, tk.END))
                        listbox.delete(0, tk.END)
                        for item in sorted(items):
                            listbox.insert(tk.END, item)
                        
                        entry_widget.delete(0, tk.END)
                        self.log_message(f"âœ… {added_count} ticker eklendi")
                    else:
                        messagebox.showinfo("Bilgi", "Ticker'lar zaten listede veya geÃ§ersiz")
                        
                except Exception as e:
                    messagebox.showerror("Hata", f"Ticker eklenemedi: {e}")
            
            add_btn = ttk.Button(entry_frame, text="â• Ekle", command=add_tickers)
            add_btn.pack(side='left')
            
            # Butonlar
            button_frame = ttk.Frame(main_frame)
            button_frame.pack(fill='x', pady=10)
            
            def delete_selected():
                """SeÃ§ili ticker'larÄ± sil"""
                try:
                    selected_indices = listbox.curselection()
                    if not selected_indices:
                        messagebox.showinfo("Bilgi", "LÃ¼tfen silmek iÃ§in ticker seÃ§in")
                        return
                    
                    # SeÃ§ili ticker'larÄ± al
                    selected_tickers = [listbox.get(i) for i in selected_indices]
                    
                    # Set'ten sil
                    for ticker in selected_tickers:
                        if ticker in self.excluded_tickers:
                            self.excluded_tickers.remove(ticker)
                    
                    # Listbox'tan sil (ters sÄ±rada sil ki index kaymasÄ±n)
                    for i in reversed(selected_indices):
                        listbox.delete(i)
                    
                    self.log_message(f"âœ… {len(selected_tickers)} ticker silindi")
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(selected_tickers)} ticker silindi")
                    
                except Exception as e:
                    messagebox.showerror("Hata", f"Ticker silinemedi: {e}")
            
            def select_all():
                """TÃ¼m ticker'larÄ± seÃ§"""
                listbox.selection_set(0, tk.END)
            
            def clear_all():
                """TÃ¼m ticker'larÄ± sil"""
                if not hasattr(self, 'excluded_tickers') or not self.excluded_tickers:
                    messagebox.showinfo("Bilgi", "Liste zaten boÅŸ")
                    return
                
                if messagebox.askyesno("Onay", "TÃ¼m ticker'larÄ± silmek istediÄŸinize emin misiniz?"):
                    self.excluded_tickers = set()
                    listbox.delete(0, tk.END)
                    self.log_message("âœ… TÃ¼m ticker'lar silindi")
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", "TÃ¼m ticker'lar silindi")
            
            def save_and_close():
                """Kaydet ve kapat"""
                try:
                    self.save_excluded_tickers_to_csv()
                    self.log_message(f"âœ… {len(self.excluded_tickers)} ticker CSV'ye kaydedildi")
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(self.excluded_tickers)} ticker kaydedildi")
                    dialog.destroy()
                except Exception as e:
                    messagebox.showerror("Hata", f"Kaydetme hatasÄ±: {e}")
            
            def cancel_dialog():
                """Dialog'u iptal et"""
                dialog.destroy()
            
            # ButonlarÄ± oluÅŸtur
            ttk.Button(button_frame, text="âœ… Kaydet ve Kapat", command=save_and_close).pack(side='left', padx=5)
            ttk.Button(button_frame, text="âŒ Ä°ptal", command=cancel_dialog).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ğŸ—‘ï¸ SeÃ§ileni Sil", command=delete_selected).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ğŸ“‹ TÃ¼mÃ¼nÃ¼ SeÃ§", command=select_all).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ğŸ—‘ï¸ TÃ¼mÃ¼nÃ¼ Sil", command=clear_all).pack(side='left', padx=5)
            
        except Exception as e:
            messagebox.showerror("Hata", f"Dialog oluÅŸturulamadÄ±: {e}")
            self.log_message(f"âŒ Excluder dialog hatasÄ±: {e}")
    
    def show_bm_shifter_dialog(self):
        """General BM Shifter dialog'unu gÃ¶ster - Benchmark shift deÄŸeri girmek iÃ§in"""
        try:
            from tkinter import messagebox
            
            # Dialog penceresi oluÅŸtur
            dialog = tk.Toplevel(self.psfalgo_window)
            dialog.title("ğŸ“Š General BM Shifter")
            dialog.geometry("450x280")
            dialog.transient(self.psfalgo_window)
            # grab_set() kaldÄ±rÄ±ldÄ± - GUI'yi bloklamamak iÃ§in
            
            # Ana frame
            main_frame = ttk.Frame(dialog)
            main_frame.pack(fill='both', expand=True, padx=20, pady=20)
            
            # AÃ§Ä±klama
            info_label = ttk.Label(main_frame, 
                                  text="Benchmark shift deÄŸerini girin\n(Negatif deÄŸer benchmark'Ä± dÃ¼ÅŸÃ¼rÃ¼r, pozitif deÄŸer yÃ¼kseltir)",
                                  font=("Arial", 10),
                                  justify='center')
            info_label.pack(pady=10)
            
            # Mevcut deÄŸeri gÃ¶ster
            current_shift = getattr(self, 'benchmark_shift', 0.0)
            current_label = ttk.Label(main_frame, 
                                     text=f"Mevcut Shift: {current_shift:.4f}",
                                     font=("Arial", 9),
                                     foreground='blue')
            current_label.pack(pady=5)
            
            # GiriÅŸ alanÄ±
            input_frame = ttk.Frame(main_frame)
            input_frame.pack(pady=10)
            
            ttk.Label(input_frame, text="Shift DeÄŸeri:", font=("Arial", 9)).pack(side='left', padx=5)
            
            shift_var = tk.StringVar(value=str(current_shift))
            shift_entry = ttk.Entry(input_frame, textvariable=shift_var, width=15)
            shift_entry.pack(side='left', padx=5)
            shift_entry.select_range(0, tk.END)  # TÃ¼m metni seÃ§
            shift_entry.focus()  # Odaklan
            
            # Butonlar
            button_frame = ttk.Frame(main_frame)
            button_frame.pack(pady=15)
            
            def apply_shift():
                """Shift deÄŸerini uygula"""
                try:
                    shift_value = float(shift_var.get().strip())
                    
                    # Shift deÄŸerini kaydet
                    self.benchmark_shift = shift_value
                    
                    # CSV'ye kaydet
                    self.save_benchmark_shift_to_csv(shift_value)
                    
                    # Label'Ä± gÃ¼ncelle
                    if hasattr(self, 'bm_shift_label'):
                        self.bm_shift_label.config(text=f"BM Shift: {shift_value:.4f}")
                    
                    # Log mesajÄ±
                    self.log_message(f"ğŸ“Š Benchmark shift deÄŸeri gÃ¼ncellendi: {shift_value:.4f}")
                    print(f"[BM SHIFTER] âœ… Benchmark shift deÄŸeri gÃ¼ncellendi: {shift_value:.4f}")
                    
                    # Bilgi mesajÄ±
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", 
                                      f"Benchmark shift deÄŸeri gÃ¼ncellendi: {shift_value:.4f}\n\n"
                                      f"TÃ¼m benchmark hesaplamalarÄ± bu deÄŸerle shift edilecek.")
                    
                    dialog.destroy()
                    
                    # TÃ¼m skorlarÄ± yeniden hesapla (shift deÄŸeri deÄŸiÅŸtiÄŸi iÃ§in)
                    self.calculate_scores_for_all_stocks()
                    
                except ValueError:
                    messagebox.showerror("Hata", "LÃ¼tfen geÃ§erli bir sayÄ± girin (Ã¶rn: -0.10 veya 0.05)")
                except Exception as e:
                    messagebox.showerror("Hata", f"Shift deÄŸeri uygulanamadÄ±: {e}")
                    print(f"[BM SHIFTER] âŒ Hata: {e}")
                    import traceback
                    traceback.print_exc()
            
            def reset_shift():
                """Shift deÄŸerini sÄ±fÄ±rla"""
                try:
                    self.benchmark_shift = 0.0
                    
                    # CSV'ye kaydet
                    self.save_benchmark_shift_to_csv(0.0)
                    
                    # Label'Ä± gÃ¼ncelle
                    if hasattr(self, 'bm_shift_label'):
                        self.bm_shift_label.config(text="BM Shift: 0.00")
                    
                    # Entry'yi gÃ¼ncelle
                    shift_var.set("0.0")
                    
                    # Log mesajÄ±
                    self.log_message("ğŸ“Š Benchmark shift deÄŸeri sÄ±fÄ±rlandÄ±")
                    print("[BM SHIFTER] âœ… Benchmark shift deÄŸeri sÄ±fÄ±rlandÄ±")
                    
                    # Bilgi mesajÄ±
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", "Benchmark shift deÄŸeri sÄ±fÄ±rlandÄ±.\nBenchmark deÄŸerleri orijinal haline dÃ¶ndÃ¼.")
                    
                    dialog.destroy()
                    
                    # TÃ¼m skorlarÄ± yeniden hesapla
                    self.calculate_scores_for_all_stocks()
                    
                except Exception as e:
                    messagebox.showerror("Hata", f"Shift deÄŸeri sÄ±fÄ±rlanamadÄ±: {e}")
                    print(f"[BM SHIFTER] âŒ Hata: {e}")
            
            def cancel_dialog():
                """Dialog'u iptal et"""
                dialog.destroy()
            
            # Enter tuÅŸu ile uygula
            shift_entry.bind('<Return>', lambda e: apply_shift())
            
            ttk.Button(button_frame, text="Uygula", command=apply_shift, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="SÄ±fÄ±rla", command=reset_shift).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal", command=cancel_dialog).pack(side='left', padx=5)
            
        except Exception as e:
            messagebox.showerror("Hata", f"Dialog aÃ§Ä±lamadÄ±: {e}")
            print(f"[BM SHIFTER] âŒ Dialog hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def is_ticker_excluded(self, symbol):
        """Ticker exclude edilmiÅŸ mi kontrol et"""
        if not hasattr(self, 'excluded_tickers'):
            return False
        return symbol.upper() in self.excluded_tickers
    
    def start_addnewpos_automation(self, from_runall=False):
        """
        ADDNEWPOS otomasyonu: Port Adjuster â†’ CSV YÃ¼kle â†’ Final FB&SFS â†’ Grup AÄŸÄ±rlÄ±klarÄ± â†’ TUMCSV â†’ BB Long Filtre â†’ JFIN %50 BB â†’ Exclude Kontrol â†’ Emir GÃ¶nder
        
        Args:
            from_runall: True ise RUNALL'dan Ã§aÄŸrÄ±ldÄ± (exposure kontrolÃ¼ yapÄ±lacak), False ise manuel Ã§aÄŸrÄ±ldÄ± (direkt baÅŸlatÄ±lacak)
        """
        try:
            print("[ADDNEWPOS] â–¶ï¸ ADDNEWPOS otomasyonu baÅŸlatÄ±lÄ±yor...")
            self.log_message("â–¶ï¸ ADDNEWPOS otomasyonu baÅŸlatÄ±lÄ±yor...")
            
            # Psfalgo aktivite logu
            source = "RUNALL" if from_runall else "Manuel"
            self.log_psfalgo_activity(
                action="ADDNEWPOS BaÅŸlatÄ±ldÄ±",
                details=f"Kaynak: {source}",
                status="INFO",
                category="ADDNEWPOS"
            )
            
            # RUNALL'dan Ã§aÄŸrÄ±lmadÄ±ysa (manuel Ã§aÄŸrÄ±ldÄ±ysa) exposure kontrolÃ¼ yapma, direkt baÅŸlat
            if not from_runall:
                print("[ADDNEWPOS] â„¹ï¸ Manuel olarak baÅŸlatÄ±ldÄ±, exposure kontrolÃ¼ yapÄ±lmÄ±yor")
                self.log_message("â„¹ï¸ Manuel olarak baÅŸlatÄ±ldÄ±, exposure kontrolÃ¼ yapÄ±lmÄ±yor")
            
            # Excluded ticker'larÄ± yÃ¼kle
            self.load_excluded_tickers_from_csv()
            
            # AdÄ±m 1: Port Adjuster penceresini aÃ§ (non-blocking)
            self.log_message("ğŸ“‹ AdÄ±m 1: Port Adjuster penceresi aÃ§Ä±lÄ±yor...")
            
            # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
            self.update_idletasks()
            
            # Port Adjuster penceresini aÃ§
            port_adjuster_window = self.show_port_adjuster()
            
            # Port Adjuster referansÄ±nÄ± sakla
            self.addnewpos_port_adjuster = port_adjuster_window
            
            # GUI'yi tekrar gÃ¼ncelle (pencere aÃ§Ä±ldÄ±ktan sonra)
            self.update_idletasks()
            
            # Port Adjuster penceresinin aÃ§Ä±lmasÄ±nÄ± bekle (non-blocking)
            self.after(1000, lambda: self.addnewpos_step_2_csv_yukle(port_adjuster_window))
            
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ Otomasyon baÅŸlatma hatasÄ±: {e}")
            self.log_message(f"âŒ ADDNEWPOS baÅŸlatma hatasÄ±: {e}")
            self.log_psfalgo_activity(
                action="ADDNEWPOS Hata",
                details=str(e),
                status="ERROR",
                category="ADDNEWPOS"
            )
            import traceback
            traceback.print_exc()
            from tkinter import messagebox
            messagebox.showerror("Hata", f"ADDNEWPOS baÅŸlatÄ±lamadÄ±: {e}")
            
            # RUNALL'dan Ã§aÄŸrÄ±ldÄ±ysa ve hata olduysa bile 2 dakika sonra restart yap
            if from_runall:
                runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                should_continue = runall_running or runall_allowed
                
                if should_continue:
                    print("[RUNALL] âš ï¸ ADDNEWPOS baÅŸlatÄ±lamadÄ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                    self.log_message("âš ï¸ ADDNEWPOS baÅŸlatÄ±lamadÄ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                    # 2 dakika bekle, sonra emirleri iptal et
                    self.after(120000, lambda: self.runall_cancel_orders_and_restart())
    
    def addnewpos_step_2_csv_yukle(self, port_adjuster_window):
        """AdÄ±m 2: CSV'den YÃ¼kle butonuna tÄ±kla"""
        try:
            self.log_message("ğŸ“‹ AdÄ±m 2: CSV'den YÃ¼kle butonuna tÄ±klanÄ±yor...")
            
            # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
            self.update_idletasks()
            
            # Port Adjuster window kontrolÃ¼
            if port_adjuster_window is None:
                print("[ADDNEWPOS] âŒ Port Adjuster window None")
                self.log_message("âŒ AdÄ±m 2: Port Adjuster penceresi bulunamadÄ±")
                return
            
            # Port Adjuster penceresindeki CSV'den YÃ¼kle butonunu bul ve tÄ±kla (non-blocking)
            if hasattr(port_adjuster_window, 'load_settings_from_csv'):
                # CSV yÃ¼kleme iÅŸlemini thread'de yap (bloklayÄ±cÄ± olabilir)
                def load_csv_thread():
                    try:
                        port_adjuster_window.load_settings_from_csv()
                        # UI thread'ine geÃ§iÅŸ yap
                        self.after(0, lambda: self._addnewpos_csv_loaded(port_adjuster_window))
                    except Exception as e:
                        print(f"[ADDNEWPOS] âŒ CSV yÃ¼kleme hatasÄ±: {e}")
                        self.after(0, lambda: self.log_message(f"âŒ CSV yÃ¼kleme hatasÄ±: {e}"))
                
                import threading
                thread = threading.Thread(target=load_csv_thread, daemon=True)
                thread.start()
            else:
                print(f"[ADDNEWPOS] âŒ Port Adjuster'da load_settings_from_csv bulunamadÄ±")
                self.log_message("âŒ AdÄ±m 2: CSV'den YÃ¼kle butonu bulunamadÄ±")
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AdÄ±m 2 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 2 hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def _addnewpos_csv_loaded(self, port_adjuster_window):
        """CSV yÃ¼klendikten sonra Ã§aÄŸrÄ±lÄ±r"""
        try:
            print("[ADDNEWPOS] âœ… CSV'den YÃ¼kle tamamlandÄ±")
            self.log_message("âœ… AdÄ±m 2: CSV'den YÃ¼kle tamamlandÄ±")
            
            # GUI'yi gÃ¼ncelle
            self.update_idletasks()
            
            # Messagebox'Ä± otomatik kapat (eÄŸer aÃ§Ä±ldÄ±ysa) ve sonraki adÄ±ma geÃ§
            self.after(500, lambda: self.addnewpos_close_messagebox())
            
            # Popup'larÄ± kapat ve pencere kapanmasÄ±nÄ± bekle
            def proceed_to_step_3():
                # GUI'yi gÃ¼ncelle
                self.update_idletasks()
                # Popup'larÄ± tekrar kontrol et
                self.addnewpos_close_messagebox()
                # Sonraki adÄ±ma geÃ§ (non-blocking)
                self.after(100, lambda: self.addnewpos_step_3_final_fb_sfs(port_adjuster_window))
            
            # KÄ±sa bir bekleme sonrasÄ± devam et
            self.after(1500, proceed_to_step_3)
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ CSV yÃ¼kleme sonrasÄ± hatasÄ±: {e}")
            self.log_message(f"âŒ CSV yÃ¼kleme sonrasÄ± hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def wait_for_window_close(self, window, callback, max_wait=5000, check_interval=200):
        """
        Pencere kapanana kadar bekle, sonra callback'i Ã§aÄŸÄ±r
        
        Args:
            window: Kontrol edilecek pencere (Toplevel veya widget)
            callback: Pencere kapandÄ±ktan sonra Ã§aÄŸrÄ±lacak fonksiyon
            max_wait: Maksimum bekleme sÃ¼resi (ms)
            check_interval: Kontrol aralÄ±ÄŸÄ± (ms)
        """
        if window is None:
            # Pencere yoksa direkt callback'i Ã§aÄŸÄ±r
            callback()
            return
        
        start_time = time.time() * 1000  # ms cinsinden
        
        def check_window():
            current_time = time.time() * 1000
            elapsed = current_time - start_time
            
            # Maksimum bekleme sÃ¼resi aÅŸÄ±ldÄ±ysa devam et
            if elapsed >= max_wait:
                print(f"[WAIT] â±ï¸ Maksimum bekleme sÃ¼resi aÅŸÄ±ldÄ± ({max_wait}ms), devam ediliyor...")
                callback()
                return
            
            # Pencere hala aÃ§Ä±k mÄ± kontrol et
            try:
                if hasattr(window, 'winfo_exists'):
                    if not window.winfo_exists():
                        print(f"[WAIT] âœ… Pencere kapatÄ±ldÄ±, devam ediliyor...")
                        callback()
                        return
                elif hasattr(window, 'win'):
                    if not window.win.winfo_exists():
                        print(f"[WAIT] âœ… Pencere kapatÄ±ldÄ±, devam ediliyor...")
                        callback()
                        return
            except:
                # Pencere zaten kapanmÄ±ÅŸ olabilir
                print(f"[WAIT] âœ… Pencere kapatÄ±ldÄ± (exception), devam ediliyor...")
                callback()
                return
            
            # Popup'larÄ± kontrol et ve kapat
            self.runall_auto_confirm_messagebox()
            
            # Tekrar kontrol et
            self.after(check_interval, check_window)
        
        # Ä°lk kontrolÃ¼ baÅŸlat
        self.after(check_interval, check_window)
    
    def addnewpos_close_messagebox(self):
        """AÃ§Ä±k messagebox'larÄ± otomatik kapat - Daha agresif versiyon"""
        try:
            # Ã–nce runall_auto_confirm_messagebox'Ä± Ã§aÄŸÄ±r (daha gÃ¼Ã§lÃ¼)
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                self.runall_auto_confirm_messagebox()
            
            # TÃ¼m aÃ§Ä±k Toplevel pencerelerini kontrol et (recursive)
            def find_and_close_all_messageboxes(parent):
                try:
                    for widget in parent.winfo_children():
                        if isinstance(widget, tk.Toplevel):
                            try:
                                title = widget.title().lower()
                                # Messagebox pencerelerini tespit et (daha geniÅŸ keyword listesi)
                                if any(keyword in title for keyword in [
                                    'baÅŸarÄ±lÄ±', 'success', 'tamamlandÄ±', 'completed', 'tamam', 'ok', 
                                    'uyarÄ±', 'warning', 'hata', 'error', 'info', 'information',
                                    'bilgi', 'mesaj', 'message', 'onay', 'confirm', 'lot hesaplama',
                                    'cercop', 'otomatik seÃ§im', 'emir sonucu', 'emir Ã¶zeti'
                                ]) or title == '':
                                    # "OK" veya "Tamam" butonunu bul ve tÄ±kla (daha agresif)
                                    def find_ok_button(parent_widget, depth=0):
                                        if depth > 15:
                                            return False
                                        try:
                                            for child in parent_widget.winfo_children():
                                                if isinstance(child, (tk.Button, ttk.Button)):
                                                    try:
                                                        text = str(child.cget('text')).lower().strip()
                                                        if any(keyword in text for keyword in [
                                                            'ok', 'tamam', 'okay', 'kabul', 'accept', 
                                                            'onayla', 'confirm', 'evet', 'yes'
                                                        ]):
                                                            # Ä°ptal butonlarÄ±nÄ± atla
                                                            if any(cancel in text for cancel in ['iptal', 'cancel', 'reddet', 'no', 'hayÄ±r']):
                                                                continue
                                                            child.invoke()
                                                            print(f"[ADDNEWPOS] âœ… Messagebox kapatÄ±ldÄ±: '{text}' ({widget.title()})")
                                                            # KÄ±sa bir bekleme ekle
                                                            self.after(100, lambda: None)
                                                            return True
                                                    except:
                                                        pass
                                                # Recursive olarak devam et
                                                if find_ok_button(child, depth + 1):
                                                    return True
                                        except:
                                            pass
                                        return False
                                    
                                    if find_ok_button(widget):
                                        # Pencereyi de kapat (eÄŸer hala aÃ§Ä±ksa)
                                        try:
                                            if widget.winfo_exists():
                                                widget.destroy()
                                        except:
                                            pass
                            except:
                                pass
                        # Recursive olarak devam et
                        find_and_close_all_messageboxes(widget)
                except:
                    pass
            
            # Ana pencereden baÅŸla
            find_and_close_all_messageboxes(self)
            
            # Port Adjuster ve FinalThgLotDistributor pencerelerini de kontrol et
            if hasattr(self, 'addnewpos_port_adjuster') and self.addnewpos_port_adjuster:
                if hasattr(self.addnewpos_port_adjuster, 'win'):
                    find_and_close_all_messageboxes(self.addnewpos_port_adjuster.win)
            
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                if hasattr(self.addnewpos_final_thg, 'win'):
                    find_and_close_all_messageboxes(self.addnewpos_final_thg.win)
            
            # Psfalgo penceresini de kontrol et
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    find_and_close_all_messageboxes(self.psfalgo_window)
                except:
                    pass
                    
        except Exception as e:
            print(f"[ADDNEWPOS] âš ï¸ Messagebox kapatma hatasÄ±: {e}")
    
    def addnewpos_step_3_final_fb_sfs(self, port_adjuster_window):
        """AdÄ±m 3: 3. Step - Final FB & SFS butonuna tÄ±kla"""
        try:
            self.log_message("ğŸ“‹ AdÄ±m 3: Final FB & SFS penceresi aÃ§Ä±lÄ±yor...")
            
            # Port Adjuster penceresinin hala aÃ§Ä±k olduÄŸunu kontrol et
            if not port_adjuster_window or not hasattr(port_adjuster_window, 'win'):
                print("[ADDNEWPOS] âŒ Port Adjuster penceresi geÃ§ersiz")
                self.log_message("âŒ AdÄ±m 3: Port Adjuster penceresi geÃ§ersiz")
                return
            
            try:
                port_adjuster_window.win.winfo_exists()
            except tk.TclError:
                print("[ADDNEWPOS] âŒ Port Adjuster penceresi kapatÄ±lmÄ±ÅŸ")
                self.log_message("âŒ AdÄ±m 3: Port Adjuster penceresi kapatÄ±lmÄ±ÅŸ")
                return
            
            # Port Adjuster'daki Final FB & SFS butonuna tÄ±kla
            if hasattr(port_adjuster_window, 'show_final_thg_distributor'):
                try:
                    final_thg_distributor = port_adjuster_window.show_final_thg_distributor()
                    print("[ADDNEWPOS] âœ… Final FB & SFS penceresi aÃ§Ä±ldÄ±")
                    self.log_message("âœ… AdÄ±m 3: Final FB & SFS penceresi aÃ§Ä±ldÄ±")
                    
                    # FinalThgLotDistributor referansÄ±nÄ± sakla
                    if final_thg_distributor:
                        self.addnewpos_final_thg = final_thg_distributor
                        # Final THG penceresinin baÅŸarÄ±yla aÃ§Ä±ldÄ±ÄŸÄ±nÄ± kontrol et
                        if hasattr(final_thg_distributor, 'win'):
                            try:
                                final_thg_distributor.win.winfo_exists()
                                print("[ADDNEWPOS] âœ… Final THG penceresi doÄŸrulandÄ±")
                            except tk.TclError:
                                print("[ADDNEWPOS] âš ï¸ Final THG penceresi geÃ§ersiz")
                                return
                    elif hasattr(port_adjuster_window, 'final_thg_distributor'):
                        self.addnewpos_final_thg = port_adjuster_window.final_thg_distributor
                    else:
                        print("[ADDNEWPOS] âš ï¸ FinalThgLotDistributor referansÄ± alÄ±namadÄ±")
                        self.addnewpos_port_adjuster = port_adjuster_window
                    
                    # Popup'larÄ± kapat ve sonraki adÄ±ma geÃ§
                    def proceed_to_step_4():
                        # Popup'larÄ± kontrol et ve kapat
                        self.addnewpos_close_messagebox()
                        
                        # Port Adjuster penceresini minimize et (kapatma, Ã§Ã¼nkÃ¼ Final THG'nin parent'Ä±)
                        # Final THG penceresi Port Adjuster'Ä±n child'Ä± olduÄŸu iÃ§in kapatmÄ±yoruz
                        if port_adjuster_window and hasattr(port_adjuster_window, 'win'):
                            try:
                                if port_adjuster_window.win.winfo_exists():
                                    print("[ADDNEWPOS] ğŸ“¦ Port Adjuster penceresi minimize ediliyor (Final THG aÃ§Ä±k)...")
                                    self.log_message("ğŸ“¦ Port Adjuster penceresi minimize ediliyor...")
                                    port_adjuster_window.win.iconify()  # Minimize et, kapatma
                            except:
                                pass
                        
                        # Sonraki adÄ±ma geÃ§
                        self.addnewpos_step_4_grup_agirliklari()
                    
                    self.after(1000, proceed_to_step_4)
                except tk.TclError as e:
                    print(f"[ADDNEWPOS] âŒ Final THG penceresi aÃ§Ä±lÄ±rken hata: {e}")
                    self.log_message(f"âŒ AdÄ±m 3: Final THG penceresi aÃ§Ä±lamadÄ±: {e}")
                    # Hata mesajÄ±nÄ± Allowed modunda otomatik kapat
                    if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                        self.after(500, lambda: self.addnewpos_close_messagebox())
            else:
                print("[ADDNEWPOS] âŒ Port Adjuster'da show_final_thg_distributor bulunamadÄ±")
                self.log_message("âŒ AdÄ±m 3: Final FB & SFS butonu bulunamadÄ±")
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AdÄ±m 3 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 3 hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_step_4_grup_agirliklari(self):
        """AdÄ±m 4: Grup AÄŸÄ±rlÄ±klarÄ±nÄ± YÃ¼kle butonuna tÄ±kla"""
        try:
            self.log_message("ğŸ“‹ AdÄ±m 4: Grup AÄŸÄ±rlÄ±klarÄ±nÄ± YÃ¼kle...")
            
            # FinalThgLotDistributor referansÄ±nÄ± al
            final_thg = None
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                final_thg = self.addnewpos_final_thg
            elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                self.addnewpos_final_thg = final_thg
            
            if final_thg and hasattr(final_thg, 'load_group_weights'):
                final_thg.load_group_weights()
                print("[ADDNEWPOS] âœ… Grup AÄŸÄ±rlÄ±klarÄ±nÄ± YÃ¼kle tamamlandÄ±")
                self.log_message("âœ… AdÄ±m 4: Grup AÄŸÄ±rlÄ±klarÄ±nÄ± YÃ¼kle tamamlandÄ±")
                
                # Messagebox'Ä± otomatik kapat ve popup'larÄ± kontrol et
                def proceed_to_step_5():
                    # Popup'larÄ± tekrar kontrol et ve kapat
                    self.addnewpos_close_messagebox()
                    # Sonraki adÄ±ma geÃ§
                    self.addnewpos_step_5_tumcsv()
                
                self.after(500, lambda: self.addnewpos_close_messagebox())
                self.after(1500, proceed_to_step_5)
            else:
                print("[ADDNEWPOS] âŒ FinalThgLotDistributor veya load_group_weights bulunamadÄ±")
                self.log_message("âŒ AdÄ±m 4: Grup AÄŸÄ±rlÄ±klarÄ±nÄ± YÃ¼kle butonu bulunamadÄ±")
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AdÄ±m 4 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 4 hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_step_5_tumcsv(self):
        """AdÄ±m 5: TUMCSV AyarlamasÄ± Yap butonuna tÄ±kla"""
        try:
            self.log_message("ğŸ“‹ AdÄ±m 5: TUMCSV AyarlamasÄ± Yap...")
            
            # FinalThgLotDistributor referansÄ±nÄ± al
            final_thg = None
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                final_thg = self.addnewpos_final_thg
            elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                self.addnewpos_final_thg = final_thg
            
            if final_thg and hasattr(final_thg, 'apply_tumcsv_rules'):
                final_thg.apply_tumcsv_rules()
                print("[ADDNEWPOS] âœ… TUMCSV AyarlamasÄ± tamamlandÄ±")
                self.log_message("âœ… AdÄ±m 5: TUMCSV AyarlamasÄ± tamamlandÄ±")
                
                # Messagebox'Ä± otomatik kapat (TUMCSV iÅŸlemi uzun sÃ¼rebilir)
                def proceed_to_step_6():
                    # Popup'larÄ± tekrar kontrol et ve kapat
                    self.addnewpos_close_messagebox()
                    # Sonraki adÄ±ma geÃ§
                    self.addnewpos_step_6_bb_filter()
                
                self.after(2000, lambda: self.addnewpos_close_messagebox())
                self.after(3500, proceed_to_step_6)
            else:
                print("[ADDNEWPOS] âŒ FinalThgLotDistributor veya apply_tumcsv_rules bulunamadÄ±")
                self.log_message("âŒ AdÄ±m 5: TUMCSV AyarlamasÄ± butonu bulunamadÄ±")
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AdÄ±m 5 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 5 hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_step_6_bb_filter(self):
        """AdÄ±m 6: BBlong sekmesinde SMA63CHG filtresini -1.6'dan kÃ¼Ã§Ã¼k olacak ÅŸekilde ayarla ve Uygula"""
        try:
            self.log_message("ğŸ“‹ AdÄ±m 6: BB Long sekmesinde SMA63CHG filtresi uygulanÄ±yor...")
            
            # FinalThgLotDistributor referansÄ±nÄ± al
            final_thg = None
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                final_thg = self.addnewpos_final_thg
            elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                self.addnewpos_final_thg = final_thg
            
            if final_thg:
                # Pencere referansÄ±nÄ±n geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                win_valid = False
                if hasattr(final_thg, 'win'):
                    try:
                        # Pencere hala var mÄ± kontrol et
                        if final_thg.win.winfo_exists():
                            win_valid = True
                    except:
                        win_valid = False
                
                if not win_valid:
                    print("[ADDNEWPOS] âš ï¸ Final FB & SFS penceresi geÃ§ersiz, yeniden aÃ§Ä±lÄ±yor...")
                    self.log_message("âš ï¸ Final FB & SFS penceresi geÃ§ersiz, yeniden aÃ§Ä±lÄ±yor...")
                    # Port Adjuster'dan yeniden aÃ§
                    if hasattr(self, 'addnewpos_port_adjuster') and self.addnewpos_port_adjuster:
                        if hasattr(self.addnewpos_port_adjuster, 'show_final_thg_distributor'):
                            final_thg = self.addnewpos_port_adjuster.show_final_thg_distributor()
                            self.addnewpos_final_thg = final_thg
                            # Pencere aÃ§Ä±lmasÄ±nÄ± bekle
                            self.after(2000, lambda: self.addnewpos_step_6_bb_filter())
                            return
                    else:
                        print("[ADDNEWPOS] âŒ Port Adjuster referansÄ± bulunamadÄ±")
                        self.log_message("âŒ AdÄ±m 6: Port Adjuster referansÄ± bulunamadÄ±")
                        return
                
                # BB Long sekmesine geÃ§ (notebook'u kontrol et)
                notebook_found = False
                if hasattr(final_thg, 'win') and final_thg.win.winfo_exists():
                    try:
                        # Notebook'u bul ve BB Long sekmesine geÃ§
                        for widget in final_thg.win.winfo_children():
                            if isinstance(widget, ttk.Notebook):
                                # BB Long sekmesine geÃ§ (index 0)
                                widget.select(0)
                                print("[ADDNEWPOS] âœ… BB Long sekmesine geÃ§ildi")
                                notebook_found = True
                                break
                    except Exception as e:
                        print(f"[ADDNEWPOS] âš ï¸ Notebook bulma hatasÄ±: {e}")
                
                # Psfalgo'dan Long filtrelerini al
                long_sma_value = self.long_sma_filter_var.get().strip() if hasattr(self, 'long_sma_filter_var') else "-1.6"
                long_sma_type = self.long_sma_filter_type.get() if hasattr(self, 'long_sma_filter_type') else "below"
                long_fbtot_value = self.long_fbtot_filter_var.get().strip() if hasattr(self, 'long_fbtot_filter_var') else ""
                long_fbtot_type = self.long_fbtot_filter_type.get() if hasattr(self, 'long_fbtot_filter_type') else "below"
                long_gort_value = self.long_gort_filter_var.get().strip() if hasattr(self, 'long_gort_filter_var') else ""
                long_gort_type = self.long_gort_filter_type.get() if hasattr(self, 'long_gort_filter_type') else "below"
                
                print(f"[ADDNEWPOS] ğŸ“Š Long Filtreler: SMA={long_sma_type} {long_sma_value}, FBtot={long_fbtot_type} {long_fbtot_value}, Gort={long_gort_type} {long_gort_value}")
                self.log_message(f"ğŸ“Š Long Filtreler: SMA={long_sma_type} {long_sma_value}, FBtot={long_fbtot_type} {long_fbtot_value}, Gort={long_gort_type} {long_gort_value}")
                
                # BB Long filtrelerini uygula
                if hasattr(final_thg, 'bb_sma_filter_var'):
                    try:
                        # SMA63 Chg filtresi
                        final_thg.bb_sma_filter_var.set(long_sma_value)
                        if hasattr(final_thg, 'bb_filter_type'):
                            final_thg.bb_filter_type.set(long_sma_type)
                        
                        # FBtot filtresi
                        if hasattr(final_thg, 'bb_fbtot_filter_var'):
                            final_thg.bb_fbtot_filter_var.set(long_fbtot_value)
                        if hasattr(final_thg, 'bb_fbtot_filter_type'):
                            final_thg.bb_fbtot_filter_type.set(long_fbtot_type)
                        
                        # Gort filtresi
                        if hasattr(final_thg, 'bb_gort_filter_var'):
                            final_thg.bb_gort_filter_var.set(long_gort_value)
                        if hasattr(final_thg, 'bb_gort_filter_type'):
                            final_thg.bb_gort_filter_type.set(long_gort_type)
                        
                        # Filtreyi uygula
                        if hasattr(final_thg, 'apply_bb_filter'):
                            final_thg.apply_bb_filter()
                            print("[ADDNEWPOS] âœ… BB Long filtreleri uygulandÄ±")
                            self.log_message("âœ… AdÄ±m 6: BB Long filtreleri uygulandÄ±")
                    except Exception as e:
                        print(f"[ADDNEWPOS] âŒ BB Long filtre ayarlama hatasÄ±: {e}")
                        self.log_message(f"âŒ BB Long filtre ayarlama hatasÄ±: {e}")
                        import traceback
                        traceback.print_exc()
                
                # FB Long filtrelerini uygula
                if hasattr(final_thg, 'fb_sma_filter_var'):
                    try:
                        # SMA63 Chg filtresi
                        final_thg.fb_sma_filter_var.set(long_sma_value)
                        if hasattr(final_thg, 'fb_filter_type'):
                            final_thg.fb_filter_type.set(long_sma_type)
                        
                        # FBtot filtresi
                        if hasattr(final_thg, 'fb_fbtot_filter_var'):
                            final_thg.fb_fbtot_filter_var.set(long_fbtot_value)
                        if hasattr(final_thg, 'fb_fbtot_filter_type'):
                            final_thg.fb_fbtot_filter_type.set(long_fbtot_type)
                        
                        # Gort filtresi
                        if hasattr(final_thg, 'fb_gort_filter_var'):
                            final_thg.fb_gort_filter_var.set(long_gort_value)
                        if hasattr(final_thg, 'fb_gort_filter_type'):
                            final_thg.fb_gort_filter_type.set(long_gort_type)
                        
                        # Filtreyi uygula
                        if hasattr(final_thg, 'apply_fb_filter'):
                            final_thg.apply_fb_filter()
                            print("[ADDNEWPOS] âœ… FB Long filtreleri uygulandÄ±")
                            self.log_message("âœ… AdÄ±m 6: FB Long filtreleri uygulandÄ±")
                    except Exception as e:
                        print(f"[ADDNEWPOS] âŒ FB Long filtre ayarlama hatasÄ±: {e}")
                        self.log_message(f"âŒ FB Long filtre ayarlama hatasÄ±: {e}")
                        import traceback
                        traceback.print_exc()
                
                # Popup'larÄ± kapat ve sonraki adÄ±ma geÃ§
                def proceed_to_step_7():
                    # Popup'larÄ± kontrol et ve kapat
                    self.addnewpos_close_messagebox()
                    # Sonraki adÄ±ma geÃ§
                    self.addnewpos_step_7_jfin_50_bb()
                
                self.after(500, lambda: self.addnewpos_close_messagebox())
                self.after(1500, proceed_to_step_7)
            else:
                print("[ADDNEWPOS] âŒ FinalThgLotDistributor referansÄ± bulunamadÄ±")
                self.log_message("âŒ AdÄ±m 6: Final FB & SFS penceresi bulunamadÄ±")
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AdÄ±m 6 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 6 hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_step_7_jfin_mode_based(self):
        """AdÄ±m 7: Mode'a gÃ¶re JFIN emirlerini aÃ§ (BB Long / SAS Short / Her ikisi)"""
        try:
            # ADDNEWPOS modunu al
            mode = self.get_addnewpos_mode()
            
            if mode == 'addlong_only':
                # Sadece BB Long
                self.log_message("ğŸ“‹ AdÄ±m 7: JFIN %50 BB Long aÃ§Ä±lÄ±yor (AddLong Only)...")
                self.addnewpos_execute_bb_long()
            elif mode == 'addshort_only':
                # Sadece SAS Short - Short filtrelerini uygula
                self.log_message("ğŸ“‹ AdÄ±m 7: Short filtreleri uygulanÄ±yor ve JFIN %50 SAS Short aÃ§Ä±lÄ±yor (AddShort Only)...")
                self.addnewpos_apply_short_filters_and_execute_sas()
            elif mode == 'addboth':
                # Ã–nce BB Long, sonra SAS Short
                self.log_message("ğŸ“‹ AdÄ±m 7: AddBoth modu - Ã–nce BB Long, sonra SAS Short yapÄ±lacak...")
                self.addnewpos_addboth_phase = 'bb_long'  # Hangi aÅŸamada olduÄŸumuzu sakla
                self.addnewpos_execute_bb_long()
            else:
                # Bilinmeyen mod, varsayÄ±lan olarak BB Long yap
                self.log_message(f"âš ï¸ Bilinmeyen mod: {mode}, varsayÄ±lan BB Long yapÄ±lÄ±yor...")
                self.addnewpos_execute_bb_long()
                
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AdÄ±m 7 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 7 hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_execute_bb_long(self):
        """BB Long emirlerini aÃ§ (Long filtreleri zaten uygulanmÄ±ÅŸ durumda)"""
        try:
            # FinalThgLotDistributor referansÄ±nÄ± al
            final_thg = self._get_final_thg_reference()
            
            if final_thg and hasattr(final_thg, 'show_jfin_orders'):
                # JFIN %50 BB emirlerini gÃ¶ster
                final_thg.show_jfin_orders('BB', 50)
                self.addnewpos_current_jfin_tab = 'BB'
                print("[ADDNEWPOS] âœ… JFIN %50 BB Long penceresi aÃ§Ä±ldÄ±")
                self.log_message("âœ… JFIN %50 BB Long penceresi aÃ§Ä±ldÄ±")
                
                # Popup'larÄ± kapat ve excluded ticker kontrolÃ¼ yap
                def proceed_to_step_8():
                    self.addnewpos_close_messagebox()
                    self.addnewpos_step_8_exclude_check()
                    # Sonra emirleri gÃ¶nder
                    self.after(2000, lambda: self.addnewpos_step_9_auto_send_orders())
                
                self.after(2000, proceed_to_step_8)
            else:
                print("[ADDNEWPOS] âŒ FinalThgLotDistributor veya show_jfin_orders bulunamadÄ±")
                self.log_message("âŒ JFIN %50 BB butonu bulunamadÄ±")
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ BB Long hatasÄ±: {e}")
            self.log_message(f"âŒ BB Long hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_apply_short_filters_and_execute_sas(self):
        """Short filtrelerini uygula ve SAS Short emirlerini aÃ§"""
        try:
            final_thg = self._get_final_thg_reference()
            
            if not final_thg:
                print("[ADDNEWPOS] âŒ FinalThgLotDistributor referansÄ± bulunamadÄ±")
                self.log_message("âŒ Final FB & SFS penceresi bulunamadÄ±")
                return
            
            # SAS Short sekmesine geÃ§ (notebook'u kontrol et)
            if hasattr(final_thg, 'win') and final_thg.win.winfo_exists():
                try:
                    for widget in final_thg.win.winfo_children():
                        if isinstance(widget, ttk.Notebook):
                            # SAS Short sekmesine geÃ§ (index 2 - BB=0, FB=1, SAS=2, SFS=3)
                            widget.select(2)
                            print("[ADDNEWPOS] âœ… SAS Short sekmesine geÃ§ildi")
                            break
                except Exception as e:
                    print(f"[ADDNEWPOS] âš ï¸ SAS sekmesine geÃ§iÅŸ hatasÄ±: {e}")
            
            # Psfalgo'dan Short filtrelerini al
            short_sma_value = self.short_sma_filter_var.get().strip() if hasattr(self, 'short_sma_filter_var') else ""
            short_sma_type = self.short_sma_filter_type.get() if hasattr(self, 'short_sma_filter_type') else "below"
            short_sfstot_value = self.short_sfstot_filter_var.get().strip() if hasattr(self, 'short_sfstot_filter_var') else ""
            short_sfstot_type = self.short_sfstot_filter_type.get() if hasattr(self, 'short_sfstot_filter_type') else "below"
            short_gort_value = self.short_gort_filter_var.get().strip() if hasattr(self, 'short_gort_filter_var') else "1"
            short_gort_type = self.short_gort_filter_type.get() if hasattr(self, 'short_gort_filter_type') else "above"
            
            print(f"[ADDNEWPOS] ğŸ“Š Short Filtreler: SMA={short_sma_type} {short_sma_value}, SFStot={short_sfstot_type} {short_sfstot_value}, Gort={short_gort_type} {short_gort_value}")
            self.log_message(f"ğŸ“Š Short Filtreler: SMA={short_sma_type} {short_sma_value}, SFStot={short_sfstot_type} {short_sfstot_value}, Gort={short_gort_type} {short_gort_value}")
            
            # SAS Short filtrelerini uygula
            if hasattr(final_thg, 'sas_sma_filter_var'):
                try:
                    # SMA63 Chg filtresi
                    final_thg.sas_sma_filter_var.set(short_sma_value)
                    if hasattr(final_thg, 'sas_filter_type'):
                        final_thg.sas_filter_type.set(short_sma_type)
                    
                    # SFStot filtresi (Short iÃ§in FBtot yerine SFStot)
                    if hasattr(final_thg, 'sas_sfstot_filter_var'):
                        final_thg.sas_sfstot_filter_var.set(short_sfstot_value)
                    if hasattr(final_thg, 'sas_sfstot_filter_type'):
                        final_thg.sas_sfstot_filter_type.set(short_sfstot_type)
                    
                    # Gort filtresi
                    if hasattr(final_thg, 'sas_gort_filter_var'):
                        final_thg.sas_gort_filter_var.set(short_gort_value)
                    if hasattr(final_thg, 'sas_gort_filter_type'):
                        final_thg.sas_gort_filter_type.set(short_gort_type)
                    
                    # Filtreyi uygula
                    if hasattr(final_thg, 'apply_sas_filter'):
                        final_thg.apply_sas_filter()
                        print("[ADDNEWPOS] âœ… SAS Short filtreleri uygulandÄ±")
                        self.log_message("âœ… SAS Short filtreleri uygulandÄ±")
                except Exception as e:
                    print(f"[ADDNEWPOS] âŒ SAS Short filtre ayarlama hatasÄ±: {e}")
                    self.log_message(f"âŒ SAS Short filtre ayarlama hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
            
            # KÄ±sa bekleme sonrasÄ± SAS Short emirlerini aÃ§
            self.after(1500, self.addnewpos_execute_sas_short)
            
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ Short filtre uygulama hatasÄ±: {e}")
            self.log_message(f"âŒ Short filtre uygulama hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_execute_sas_short(self):
        """SAS Short emirlerini aÃ§"""
        try:
            final_thg = self._get_final_thg_reference()
            
            if final_thg and hasattr(final_thg, 'show_jfin_orders'):
                # JFIN %50 SAS emirlerini gÃ¶ster (ASK SELL)
                final_thg.show_jfin_orders('SAS', 50)
                self.addnewpos_current_jfin_tab = 'SAS'
                print("[ADDNEWPOS] âœ… JFIN %50 SAS Short penceresi aÃ§Ä±ldÄ± (ASK SELL)")
                self.log_message("âœ… JFIN %50 SAS Short penceresi aÃ§Ä±ldÄ± (ASK SELL)")
                
                # Popup'larÄ± kapat ve excluded ticker kontrolÃ¼ yap
                def proceed_to_step_8():
                    self.addnewpos_close_messagebox()
                    self.addnewpos_step_8_exclude_check()
                    # Sonra emirleri gÃ¶nder
                    self.after(2000, lambda: self.addnewpos_step_9_auto_send_orders())
                
                self.after(2000, proceed_to_step_8)
            else:
                print("[ADDNEWPOS] âŒ FinalThgLotDistributor veya show_jfin_orders bulunamadÄ±")
                self.log_message("âŒ JFIN %50 SAS butonu bulunamadÄ±")
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ SAS Short hatasÄ±: {e}")
            self.log_message(f"âŒ SAS Short hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_addboth_continue_with_sas(self):
        """AddBoth modunda BB Long tamamlandÄ±ktan sonra SAS Short'a geÃ§"""
        try:
            print("[ADDNEWPOS] ğŸ”„ AddBoth: BB Long tamamlandÄ±, ÅŸimdi SAS Short baÅŸlatÄ±lÄ±yor...")
            self.log_message("ğŸ”„ AddBoth: BB Long tamamlandÄ±, ÅŸimdi SAS Short baÅŸlatÄ±lÄ±yor...")
            
            # Mevcut JFIN penceresini kapat
            self.addnewpos_close_all_jfin_windows()
            
            # KÄ±sa bekleme sonrasÄ± SAS Short'u baÅŸlat
            self.addnewpos_addboth_phase = 'sas_short'
            self.after(2000, self.addnewpos_apply_short_filters_and_execute_sas)
            
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AddBoth SAS geÃ§iÅŸ hatasÄ±: {e}")
            self.log_message(f"âŒ AddBoth SAS geÃ§iÅŸ hatasÄ±: {e}")
    
    def addnewpos_close_all_jfin_windows(self):
        """TÃ¼m JFIN pencerelerini kapat"""
        try:
            final_thg = self._get_final_thg_reference()
            if final_thg and hasattr(final_thg, 'win'):
                for widget in final_thg.win.winfo_children():
                    if isinstance(widget, tk.Toplevel):
                        try:
                            if "JFIN" in widget.title():
                                widget.destroy()
                                print("[ADDNEWPOS] ğŸ—‘ï¸ JFIN penceresi kapatÄ±ldÄ±")
                        except:
                            pass
        except Exception as e:
            print(f"[ADDNEWPOS] âš ï¸ JFIN pencere kapatma hatasÄ±: {e}")
    
    def _get_final_thg_reference(self):
        """FinalThgLotDistributor referansÄ±nÄ± al (yardÄ±mcÄ± fonksiyon)"""
        final_thg = None
        if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
            final_thg = self.addnewpos_final_thg
        elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
            final_thg = self.addnewpos_port_adjuster.final_thg_distributor
            self.addnewpos_final_thg = final_thg
        return final_thg
    
    # Eski fonksiyon adÄ±nÄ± koruyalÄ±m (geriye uyumluluk iÃ§in)
    def addnewpos_step_7_jfin_50_bb(self):
        """AdÄ±m 7: Mode'a gÃ¶re JFIN emirlerini aÃ§ (eski isim, yeni fonksiyona yÃ¶nlendirir)"""
        self.addnewpos_step_7_jfin_mode_based()
    
    def addnewpos_step_8_exclude_check(self):
        """AdÄ±m 8: Excluded ticker kontrolÃ¼ ve onay penceresinde excluded ticker'larÄ± Ã§Ä±kar"""
        try:
            self.log_message("ğŸ“‹ AdÄ±m 8: Excluded ticker kontrolÃ¼ yapÄ±lÄ±yor...")
            
            # FinalThgLotDistributor referansÄ±nÄ± al
            final_thg = None
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                final_thg = self.addnewpos_final_thg
            elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                self.addnewpos_final_thg = final_thg
            
            # FinalThgLotDistributor'daki JFIN onay penceresini bul
            if final_thg and hasattr(final_thg, 'win'):
                # TÃ¼m aÃ§Ä±k pencereleri kontrol et
                for child in final_thg.win.winfo_children():
                    if isinstance(child, tk.Toplevel):
                        # JFIN onay penceresi bulundu
                        self.addnewpos_exclude_from_jfin_window(child)
                        return
                
                # EÄŸer doÄŸrudan win'in altÄ±nda deÄŸilse, tÃ¼m toplevel'leri kontrol et
                all_windows = []
                def find_toplevels(parent):
                    for widget in parent.winfo_children():
                        if isinstance(widget, tk.Toplevel):
                            all_windows.append(widget)
                        find_toplevels(widget)
                
                find_toplevels(final_thg.win)
                
                # JFIN onay penceresini bul (baÅŸlÄ±ÄŸÄ±nda "JFIN" geÃ§en)
                for win in all_windows:
                    try:
                        if "JFIN" in win.title():
                            self.addnewpos_exclude_from_jfin_window(win)
                            return
                    except:
                        continue
                
                # EÄŸer hala bulunamadÄ±ysa, tÃ¼m aÃ§Ä±k Toplevel pencerelerini kontrol et
                self.addnewpos_find_jfin_window_recursive(final_thg.win)
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AdÄ±m 8 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 8 hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            
            # Hata olsa bile sonraki adÄ±ma geÃ§ (RUNALL'dan Ã§aÄŸrÄ±ldÄ±ysa)
            if hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started:
                print("[ADDNEWPOS] âš ï¸ AdÄ±m 8 hatasÄ± nedeniyle AdÄ±m 9'a geÃ§iliyor...")
                self.log_message("âš ï¸ AdÄ±m 8 hatasÄ± nedeniyle AdÄ±m 9'a geÃ§iliyor...")
                # Sonraki adÄ±ma geÃ§
                self.after(2000, self.addnewpos_step_9_auto_send_orders)
    
    def addnewpos_exclude_from_jfin_window(self, jfin_window):
        """JFIN onay penceresinde excluded ticker'larÄ± iÅŸaretleme kaldÄ±r ve toplam lot bildirimi gÃ¶ster"""
        try:
            from tkinter import messagebox
            
            # Excluded ticker'larÄ± yÃ¼kle
            self.load_excluded_tickers_from_csv()
            
            excluded_tickers_exist = hasattr(self, 'excluded_tickers') and self.excluded_tickers
            if not excluded_tickers_exist:
                print("[ADDNEWPOS] â„¹ï¸ Excluded ticker yok, tÃ¼m emirler gÃ¶nderilecek")
                self.log_message("â„¹ï¸ Excluded ticker yok, tÃ¼m emirler gÃ¶nderilecek")
            
            # JFIN penceresindeki treeview'Ä± bul
            order_tree = None
            for widget in jfin_window.winfo_children():
                if isinstance(widget, ttk.Treeview):
                    order_tree = widget
                    break
                # Frame iÃ§inde de olabilir
                for child in widget.winfo_children():
                    if isinstance(child, ttk.Treeview):
                        order_tree = child
                        break
                    for grandchild in child.winfo_children():
                        if isinstance(grandchild, ttk.Treeview):
                            order_tree = grandchild
                            break
            
            if not order_tree:
                print("[ADDNEWPOS] âš ï¸ JFIN onay penceresinde treeview bulunamadÄ±")
                self.log_message("âš ï¸ JFIN onay penceresinde treeview bulunamadÄ±")
                return
            
            # Excluded ticker'larÄ± iÅŸaretleme kaldÄ±r ve toplam lot hesapla
            excluded_count = 0
            excluded_lot_total = 0
            remaining_lot_total = 0
            total_orders = 0
            remaining_orders = 0
            
            # Emir tÃ¼rÃ¼nÃ¼ belirle (Long mu Short mu?)
            order_type = "pozisyon arttÄ±rma"  # VarsayÄ±lan
            try:
                window_title = jfin_window.title()
                if "BB" in window_title or "FB" in window_title or "SoftFB" in window_title:
                    order_type = "pozisyon arttÄ±rma"  # Long
                elif "SAS" in window_title or "SFS" in window_title or "SoftFS" in window_title:
                    order_type = "pozisyon azaltma"  # Short
            except:
                pass
            
            for item in order_tree.get_children():
                values = list(order_tree.item(item)['values'])
                if len(values) >= 10:  # En az 10 kolon olmalÄ± (Hesaplanan Lot kolonu iÃ§in)
                    symbol = values[2]  # Sembol kolonu
                    # Hesaplanan Lot kolonu (index 9)
                    try:
                        calculated_lot_str = str(values[9]).replace(',', '').strip()
                        calculated_lot = int(float(calculated_lot_str)) if calculated_lot_str and calculated_lot_str != 'N/A' else 0
                    except (ValueError, TypeError, IndexError):
                        calculated_lot = 0
                    
                    total_orders += 1
                    
                    # SeÃ§ili emirlerin lot toplamÄ±nÄ± hesapla (excluded olmayanlar iÃ§in)
                    if values[0] == 'â˜‘':  # SeÃ§ili ise
                        if excluded_tickers_exist and self.is_ticker_excluded(symbol):
                            # Excluded ticker - checkbox'Ä± kaldÄ±r (â˜ yap)
                            values[0] = 'â˜'
                            order_tree.item(item, values=values, tags=('unselected',))
                            excluded_count += 1
                            excluded_lot_total += calculated_lot
                            print(f"[ADDNEWPOS] ğŸš« {symbol} excluded - iÅŸaretleme kaldÄ±rÄ±ldÄ± ({calculated_lot:,} lot)")
                        else:
                            # SeÃ§ili emir (excluded deÄŸil)
                            remaining_lot_total += calculated_lot
                            remaining_orders += 1
            
            # Bildirim mesajÄ± oluÅŸtur
            if excluded_count > 0:
                self.log_message(f"âœ… {excluded_count} excluded ticker iÅŸaretlemesi kaldÄ±rÄ±ldÄ± ({excluded_lot_total:,} lot)")
                print(f"[ADDNEWPOS] âœ… {excluded_count} excluded ticker iÅŸaretlemesi kaldÄ±rÄ±ldÄ± ({excluded_lot_total:,} lot)")
            
            # Toplam lot bildirimi gÃ¶ster
            if remaining_lot_total > 0:
                message = f"ğŸ“Š {remaining_lot_total:,} lot {order_type} emri onay penceresine aÃ§Ä±ldÄ±"
                if excluded_count > 0:
                    message += f"\nğŸš« {excluded_count} ticker excluded ({excluded_lot_total:,} lot Ã§Ä±karÄ±ldÄ±)"
                message += f"\nâœ… {remaining_orders} emir gÃ¶nderilecek"
                
                print(f"[ADDNEWPOS] {message}")
                self.log_message(message)
                
                # Bildirim penceresi gÃ¶ster (Allowed modunda gÃ¶sterme)
                if not (hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode):
                    messagebox.showinfo("ADDNEWPOS - Emir Ã–zeti", message)
                else:
                    print(f"[ADDNEWPOS] â„¹ï¸ Allowed modu aktif - Bildirim penceresi gÃ¶sterilmedi")
            else:
                warning_msg = "âš ï¸ HiÃ§ emir kalmadÄ±! TÃ¼m emirler excluded edilmiÅŸ olabilir."
                print(f"[ADDNEWPOS] {warning_msg}")
                self.log_message(warning_msg)
                messagebox.showwarning("UyarÄ±", warning_msg)
            
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ Exclude kontrol hatasÄ±: {e}")
            self.log_message(f"âŒ Exclude kontrol hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_find_jfin_window_recursive(self, parent):
        """Recursive olarak JFIN penceresini bul"""
        try:
            for widget in parent.winfo_children():
                if isinstance(widget, tk.Toplevel):
                    try:
                        if "JFIN" in widget.title():
                            self.addnewpos_exclude_from_jfin_window(widget)
                            # JFIN penceresini sakla (emir gÃ¶nderme iÃ§in)
                            self.addnewpos_jfin_window = widget
                            return
                    except:
                        pass
                # Recursive olarak devam et
                self.addnewpos_find_jfin_window_recursive(widget)
        except:
            pass
    
    def addnewpos_step_9_auto_send_orders(self):
        """AdÄ±m 9: JFIN onay penceresinde Emirleri GÃ¶nder butonuna otomatik tÄ±kla"""
        try:
            # RUNALL Allowed modunda emirler zaten otomatik gÃ¶nderiliyor, bu adÄ±mÄ± atla
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print("[ADDNEWPOS] â„¹ï¸ Allowed modu aktif - Emirler zaten otomatik gÃ¶nderildi, AdÄ±m 9 atlanÄ±yor")
                self.log_message("â„¹ï¸ AdÄ±m 9: Allowed modu aktif - Emirler zaten otomatik gÃ¶nderildi")
                return
            
            self.log_message("ğŸ“‹ AdÄ±m 9: Emirleri GÃ¶nder butonuna otomatik tÄ±klanÄ±yor...")
            
            # JFIN penceresini bul - Ã–NCE attribute'u kontrol et
            jfin_window = None
            
            # 1. Ã–nce kaydedilmiÅŸ JFIN penceresini kontrol et (hala var mÄ±?)
            if hasattr(self, 'addnewpos_jfin_window') and self.addnewpos_jfin_window:
                try:
                    if self.addnewpos_jfin_window.winfo_exists():
                        jfin_window = self.addnewpos_jfin_window
                        print("[ADDNEWPOS] âœ… JFIN penceresi attribute'dan bulundu")
                except:
                    # Pencere kapanmÄ±ÅŸ olabilir, attribute'u temizle
                    self.addnewpos_jfin_window = None
            
            # 2. EÄŸer bulunamadÄ±ysa, FinalThgLotDistributor penceresi iÃ§inde ara
            if not jfin_window:
                final_thg = None
                if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                    final_thg = self.addnewpos_final_thg
                elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                    final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                
                if final_thg and hasattr(final_thg, 'win'):
                    try:
                        # TÃ¼m aÃ§Ä±k pencereleri kontrol et
                        all_windows = []
                        def find_toplevels(parent):
                            try:
                                for widget in parent.winfo_children():
                                    if isinstance(widget, tk.Toplevel):
                                        all_windows.append(widget)
                                    find_toplevels(widget)
                            except:
                                pass
                        
                        find_toplevels(final_thg.win)
                        
                        # JFIN onay penceresini bul
                        for win in all_windows:
                            try:
                                if win.winfo_exists() and "JFIN" in win.title():
                                    jfin_window = win
                                    self.addnewpos_jfin_window = win
                                    print("[ADDNEWPOS] âœ… JFIN penceresi final_thg.win iÃ§inde bulundu")
                                    break
                            except:
                                continue
                    except Exception as e:
                        print(f"[ADDNEWPOS] âš ï¸ final_thg.win iÃ§inde arama hatasÄ±: {e}")
            
            # 3. Hala bulunamadÄ±ysa, main_window altÄ±nda tÃ¼m Toplevel pencereleri kontrol et
            if not jfin_window:
                try:
                    all_toplevels = []
                    def find_all_toplevels(parent, depth=0):
                        if depth > 10:  # Recursion limit
                            return
                        try:
                            for widget in parent.winfo_children():
                                if isinstance(widget, tk.Toplevel):
                                    try:
                                        if widget.winfo_exists() and "JFIN" in widget.title():
                                            all_toplevels.append(widget)
                                    except:
                                        pass
                                find_all_toplevels(widget, depth + 1)
                        except:
                            pass
                    
                    # Ana pencereden baÅŸla
                    find_all_toplevels(self)
                    
                    # JFIN penceresini bul
                    for win in all_toplevels:
                        try:
                            if win.winfo_exists():
                                jfin_window = win
                                self.addnewpos_jfin_window = win
                                print("[ADDNEWPOS] âœ… JFIN penceresi main_window altÄ±nda bulundu")
                                break
                        except:
                            continue
                except Exception as e:
                    print(f"[ADDNEWPOS] âš ï¸ main_window altÄ±nda arama hatasÄ±: {e}")
            
            # 4. Son Ã§are: addnewpos_find_jfin_window_recursive fonksiyonunu kullan
            if not jfin_window:
                try:
                    # Ã–nce final_thg.win'den baÅŸla
                    final_thg = None
                    if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                        final_thg = self.addnewpos_final_thg
                    elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                        final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                    
                    if final_thg and hasattr(final_thg, 'win'):
                        self.addnewpos_find_jfin_window_recursive(final_thg.win)
                        if hasattr(self, 'addnewpos_jfin_window') and self.addnewpos_jfin_window:
                            try:
                                if self.addnewpos_jfin_window.winfo_exists():
                                    jfin_window = self.addnewpos_jfin_window
                                    print("[ADDNEWPOS] âœ… JFIN penceresi recursive fonksiyon ile bulundu")
                            except:
                                pass
                    
                    # EÄŸer hala bulunamadÄ±ysa, main_window'dan baÅŸla
                    if not jfin_window:
                        self.addnewpos_find_jfin_window_recursive(self)
                        if hasattr(self, 'addnewpos_jfin_window') and self.addnewpos_jfin_window:
                            try:
                                if self.addnewpos_jfin_window.winfo_exists():
                                    jfin_window = self.addnewpos_jfin_window
                                    print("[ADDNEWPOS] âœ… JFIN penceresi main_window recursive ile bulundu")
                            except:
                                pass
                except Exception as e:
                    print(f"[ADDNEWPOS] âš ï¸ Recursive arama hatasÄ±: {e}")
            
            if jfin_window:
                # "Emirleri GÃ¶nder" butonunu bul ve tÄ±kla
                send_button = None
                
                def find_send_button(parent):
                    nonlocal send_button
                    if send_button:
                        return
                    try:
                        for widget in parent.winfo_children():
                            try:
                                # Button kontrolÃ¼
                                if isinstance(widget, (tk.Button, ttk.Button)):
                                    try:
                                        text = str(widget.cget('text')).lower()
                                        # "Emirleri GÃ¶nder" butonunu bul
                                        if 'gÃ¶nder' in text or 'send' in text or ('emir' in text and 'gÃ¶nder' in text):
                                            send_button = widget
                                            print(f"[ADDNEWPOS] âœ… Buton bulundu: '{widget.cget('text')}'")
                                            return
                                    except Exception as e:
                                        pass
                                
                                # Recursive olarak devam et
                                find_send_button(widget)
                            except Exception as e:
                                # Widget eriÅŸilemez olabilir, devam et
                                pass
                    except Exception as e:
                        pass
                
                find_send_button(jfin_window)
                
                if send_button:
                    # Retry sayaÃ§larÄ±nÄ± sÄ±fÄ±rla (baÅŸarÄ±lÄ± oldu)
                    if hasattr(self, 'addnewpos_send_retry_count'):
                        self.addnewpos_send_retry_count = 0
                    if hasattr(self, 'addnewpos_window_retry_count'):
                        self.addnewpos_window_retry_count = 0
                    
                    print("[ADDNEWPOS] âœ… Emirleri GÃ¶nder butonu bulundu, tÄ±klanÄ±yor...")
                    self.log_message("âœ… AdÄ±m 9: Emirleri GÃ¶nder butonuna tÄ±klanÄ±yor...")
                    try:
                        send_button.invoke()
                        print("[ADDNEWPOS] âœ… Emirleri GÃ¶nder butonuna tÄ±klandÄ±")
                        self.log_message("âœ… AdÄ±m 9: Emirleri GÃ¶nder butonuna tÄ±klandÄ±")
                        
                        # AddBoth modunda: BB Long tamamlandÄ±ysa SAS Short'a geÃ§
                        mode = self.get_addnewpos_mode()
                        if mode == 'addboth' and hasattr(self, 'addnewpos_addboth_phase'):
                            if self.addnewpos_addboth_phase == 'bb_long':
                                print("[ADDNEWPOS] ğŸ”„ AddBoth: BB Long emirleri gÃ¶nderildi, SAS Short'a geÃ§iliyor...")
                                self.log_message("ğŸ”„ AddBoth: BB Long emirleri gÃ¶nderildi, SAS Short'a geÃ§iliyor...")
                                # 3 saniye bekle ve SAS Short'a geÃ§
                                self.after(3000, self.addnewpos_addboth_continue_with_sas)
                            elif self.addnewpos_addboth_phase == 'sas_short':
                                print("[ADDNEWPOS] âœ… AddBoth: SAS Short emirleri de gÃ¶nderildi, tÃ¼m iÅŸlemler tamamlandÄ±!")
                                self.log_message("âœ… AddBoth: TÃ¼m iÅŸlemler tamamlandÄ± (BB Long + SAS Short)")
                                # Phase'i temizle
                                delattr(self, 'addnewpos_addboth_phase')
                        
                    except Exception as e:
                        print(f"[ADDNEWPOS] âš ï¸ Buton tÄ±klama hatasÄ±: {e}")
                        self.log_message(f"âš ï¸ AdÄ±m 9: Buton tÄ±klama hatasÄ±: {e}")
                else:
                    # Hala bulunamadÄ±ysa tekrar dene (max 5 kez)
                    if not hasattr(self, 'addnewpos_send_retry_count'):
                        self.addnewpos_send_retry_count = 0
                    
                    self.addnewpos_send_retry_count += 1
                    if self.addnewpos_send_retry_count < 5:
                        print(f"[ADDNEWPOS] âš ï¸ Emirleri GÃ¶nder butonu bulunamadÄ±, tekrar denenecek... ({self.addnewpos_send_retry_count}/5)")
                        self.log_message(f"âš ï¸ AdÄ±m 9: Emirleri GÃ¶nder butonu bulunamadÄ±, tekrar denenecek... ({self.addnewpos_send_retry_count}/5)")
                        # 2 saniye sonra tekrar dene
                        self.after(2000, lambda: self.addnewpos_step_9_auto_send_orders())
                    else:
                        print("[ADDNEWPOS] âŒ Emirleri GÃ¶nder butonu 5 denemede bulunamadÄ±, manuel gÃ¶nderilmesi gerekiyor")
                        self.log_message("âŒ AdÄ±m 9: Emirleri GÃ¶nder butonu bulunamadÄ±, lÃ¼tfen manuel gÃ¶nderin")
                        self.addnewpos_send_retry_count = 0  # Reset
            else:
                # JFIN penceresi bulunamadÄ±, retry yap
                if not hasattr(self, 'addnewpos_window_retry_count'):
                    self.addnewpos_window_retry_count = 0
                
                self.addnewpos_window_retry_count += 1
                if self.addnewpos_window_retry_count < 10:  # 10 deneme yap (pencere aÃ§Ä±lmasÄ± zaman alabilir)
                    print(f"[ADDNEWPOS] âš ï¸ JFIN onay penceresi bulunamadÄ±, tekrar denenecek... ({self.addnewpos_window_retry_count}/10)")
                    self.log_message(f"âš ï¸ AdÄ±m 9: JFIN onay penceresi bulunamadÄ±, tekrar denenecek... ({self.addnewpos_window_retry_count}/10)")
                    # 2 saniye sonra tekrar dene
                    self.after(2000, lambda: self.addnewpos_step_9_auto_send_orders())
                else:
                    print("[ADDNEWPOS] âŒ JFIN onay penceresi 10 denemede bulunamadÄ±")
                    self.log_message("âŒ AdÄ±m 9: JFIN onay penceresi bulunamadÄ±, lÃ¼tfen manuel kontrol edin")
                    self.addnewpos_window_retry_count = 0  # Reset
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ AdÄ±m 9 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 9 hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def toggle_controller(self):
        """Controller ON/OFF toggle"""
        try:
            self.controller_enabled = not self.controller_enabled
            
            if self.controller_enabled:
                self.controller_btn.config(text="ğŸ›ï¸ Controller: ON")
                self.controller_btn.config(style='Success.TButton')
                print("[CONTROLLER] âœ… Controller: ON")
                self.log_message("âœ… Controller: ON - Pozisyon kontrolÃ¼ aktif")
            else:
                self.controller_btn.config(text="ğŸ›ï¸ Controller: OFF")
                self.controller_btn.config(style='Accent.TButton')
                print("[CONTROLLER] âŒ Controller: OFF")
                self.log_message("âŒ Controller: OFF - Pozisyon kontrolÃ¼ kapalÄ±")
                
        except Exception as e:
            print(f"[CONTROLLER] âŒ Toggle hatasÄ±: {e}")
            self.log_message(f"âŒ Controller toggle hatasÄ±: {e}")
    
    def start_karbotu_automation(self):
        """KARBOTU otomasyonunu baÅŸlat (thread'de Ã§alÄ±ÅŸÄ±r - UI'Ä± bloklamaz)"""
        print(f"[KARBOTU] ğŸ¯ start_karbotu_automation FONKSÄ°YONU Ã‡AÄRILDI!")
        # Thread'de Ã§alÄ±ÅŸtÄ±r
        def karbotu_thread():
            try:
                print(f"[KARBOTU] ğŸ§µ KARBOTU thread baÅŸladÄ±: {threading.current_thread().name}")
                self._start_karbotu_automation_impl()
            except Exception as e:
                print(f"[KARBOTU] âŒ Thread hatasÄ±: {e}")
                import traceback
                traceback.print_exc()
                self.safe_ui_call(lambda: self.log_message(f"âŒ KARBOTU thread hatasÄ±: {e}"))
                self.safe_ui_call(lambda: messagebox.showerror("Hata", f"KARBOTU baÅŸlatÄ±lamadÄ±: {e}"))
        
        # Thread'i baÅŸlat
        import threading
        print(f"[KARBOTU] ğŸ”§ KARBOTU thread oluÅŸturuluyor...")
        thread = threading.Thread(target=karbotu_thread, daemon=True, name="KARBOTU_Automation")
        print(f"[KARBOTU] ğŸš€ KARBOTU thread baÅŸlatÄ±lÄ±yor...")
        thread.start()
        print(f"[KARBOTU] âœ… KARBOTU thread baÅŸlatÄ±ldÄ±: {thread.name}, is_alive={thread.is_alive()}")
        
        # Thread'i takip et
        with self.algorithm_thread_lock:
            self.algorithm_threads['karbotu'] = thread
    
    def _start_karbotu_automation_impl(self):
        """KARBOTU otomasyonunun gerÃ§ek implementasyonu (thread'de Ã§alÄ±ÅŸÄ±r)"""
        try:
            print("[KARBOTU] ğŸ¯ KARBOTU otomasyonu baÅŸlatÄ±lÄ±yor...")
            self.safe_ui_call(self.log_message, "ğŸ¯ KARBOTU otomasyonu baÅŸlatÄ±lÄ±yor...")
            
            # Psfalgo aktivite logu
            self.safe_ui_call(self.log_psfalgo_activity,
                action="KARBOTU BaÅŸlatÄ±ldÄ±",
                details="13 adÄ±mlÄ± otomasyon baÅŸlÄ±yor",
                status="INFO",
                category="KARBOTU"
            )
            
            # KARBOTU adÄ±mlarÄ±nÄ± baÅŸlat
            self.karbotu_current_step = 1
            self.karbotu_total_steps = 13
            self.karbotu_running = True
            
            # Ä°lk adÄ±m: Take Profit Longs penceresini aÃ§ (non-blocking)
            # safe_ui_call kullanarak GUI'yi bloklamadan baÅŸlat
            self.safe_ui_call(self.karbotu_step_1_open_take_profit_longs)
            
        except Exception as e:
            print(f"[KARBOTU] âŒ Otomasyon baÅŸlatma hatasÄ±: {e}")
            self.safe_ui_call(self.log_message, f"âŒ KARBOTU baÅŸlatma hatasÄ±: {e}")
            self.safe_ui_call(self.log_psfalgo_activity,
                action="KARBOTU Hata",
                details=str(e),
                status="ERROR",
                category="KARBOTU"
            )
            self.safe_ui_call(lambda: messagebox.showerror("Hata", f"KARBOTU baÅŸlatÄ±lamadÄ±: {e}"))
    
    def karbotu_step_1_open_take_profit_longs(self):
        """AdÄ±m 1: Take Profit Longs penceresini aÃ§"""
        try:
            print(f"[KARBOTU] ğŸ¯ karbotu_step_1_open_take_profit_longs FONKSÄ°YONU Ã‡AÄRILDI!")
            print("[KARBOTU] ğŸ“‹ AdÄ±m 1: Take Profit Longs penceresi aÃ§Ä±lÄ±yor...")
            self.log_message("ğŸ“‹ AdÄ±m 1: Take Profit Longs penceresi aÃ§Ä±lÄ±yor...")
            
            # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
            self.update_idletasks()
            
            # Take Profit Longs penceresini aÃ§ (non-blocking)
            from .take_profit_panel import TakeProfitPanel
            self.take_profit_longs_panel = TakeProfitPanel(self, "longs")
            
            # GUI'yi gÃ¼ncelle (pencere aÃ§Ä±ldÄ±ktan sonra)
            self.update_idletasks()
            
            # Gort kontrolÃ¼ yap (Take Profit Longs iÃ§in) - non-blocking
            self.after(200, self.karbotu_gort_check_take_profit_longs)
            
            # AdÄ±m 2'ye geÃ§ (Gort kontrolÃ¼ bitince)
            self.karbotu_current_step = 2
            # Gort kontrolÃ¼ bitince adÄ±m 2'ye geÃ§ilecek (karbotu_gort_check_take_profit_longs iÃ§inde)
            
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 1 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 1 hatasÄ±: {e}")
    
    def karbotu_step_2_fbtot_lt_110(self):
        """AdÄ±m 2: Fbtot < 1.10 ve Ask Sell pahalÄ±lÄ±k > -0.10"""
        try:
            print(f"[KARBOTU] ğŸ¯ karbotu_step_2_fbtot_lt_110 FONKSÄ°YONU Ã‡AÄRILDI!")
            print("[KARBOTU] ğŸ“‹ AdÄ±m 2: Fbtot < 1.10 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 2: Fbtot < 1.10 ve Ask Sell pahalÄ±lÄ±k > -0.10")
            
            # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
            self.update_idletasks()
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]  # Fbtot kolonu
                ask_sell_pahalilik_str = values[8]  # Ask Sell PahalÄ±lÄ±k kolonu
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            # $ iÅŸaretini kaldÄ±r ve float'a Ã§evir
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot < 1.10 ve Ask Sell pahalÄ±lÄ±k > -0.10
                    if fbtot < 1.10 and ask_sell_pahalilik > -0.10:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 2: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 2: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell PahalÄ±lÄ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Ask Sell onay penceresi aÃ§
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "AdÄ±m 2")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 2: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 2: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 3'e geÃ§
                self.karbotu_current_step = 3
                self.karbotu_step_3_fbtot_111_145_low()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 2 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 2 hatasÄ±: {e}")
    
    def karbotu_step_3_fbtot_111_145_low(self):
        """AdÄ±m 3: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k -0.05 ile +0.04 arasÄ±"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 3: Fbtot 1.11-1.45 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 3: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k -0.05 ile +0.04 arasÄ±")
            
            # Lot yÃ¼zdesi: %25
            lot_percentage = 25
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k -0.05 ile +0.04 arasÄ±
                    if 1.11 <= fbtot <= 1.45 and -0.05 <= ask_sell_pahalilik <= 0.04:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 3: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 3: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell PahalÄ±lÄ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %25 lot ile Ask Sell onay penceresi aÃ§
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 25, "AdÄ±m 3")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 3: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 3: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 4'e geÃ§
                self.karbotu_current_step = 4
                self.karbotu_step_4_fbtot_111_145_high()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 3 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 3 hatasÄ±: {e}")
    
    def karbotu_step_4_fbtot_111_145_high(self):
        """AdÄ±m 4: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k > +0.05"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 4: Fbtot 1.11-1.45 yÃ¼ksek kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 4: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k > +0.05")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k > +0.05
                    if 1.11 <= fbtot <= 1.45 and ask_sell_pahalilik > 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 4: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 4: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell PahalÄ±lÄ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Ask Sell onay penceresi aÃ§
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "AdÄ±m 4")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 4: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 4: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 5'e geÃ§
                self.karbotu_current_step = 5
                self.karbotu_step_5_fbtot_146_185_low()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 4 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 4 hatasÄ±: {e}")
    
    def karbotu_step_5_fbtot_146_185_low(self):
        """AdÄ±m 5: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k +0.05 ile +0.10 arasÄ±"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 5: Fbtot 1.46-1.85 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 5: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k +0.05 ile +0.10 arasÄ±")
            
            # Lot yÃ¼zdesi: %25
            lot_percentage = 25
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k +0.05 ile +0.10 arasÄ±
                    if 1.46 <= fbtot <= 1.85 and 0.05 <= ask_sell_pahalilik <= 0.10:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 5: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 5: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell PahalÄ±lÄ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %25 lot ile Ask Sell onay penceresi aÃ§
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 25, "AdÄ±m 5")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 5: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 5: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 6'ya geÃ§
                self.karbotu_current_step = 6
                self.karbotu_step_6_fbtot_146_185_high()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 5 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 5 hatasÄ±: {e}")
    
    def karbotu_step_6_fbtot_146_185_high(self):
        """AdÄ±m 6: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k > +0.10"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 6: Fbtot 1.46-1.85 yÃ¼ksek kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 6: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k > +0.10")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k > +0.10
                    if 1.46 <= fbtot <= 1.85 and ask_sell_pahalilik > 0.10:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 6: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 6: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell PahalÄ±lÄ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Ask Sell onay penceresi aÃ§
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "AdÄ±m 6")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 6: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 6: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 7'ye geÃ§
                self.karbotu_current_step = 7
                self.karbotu_step_7_fbtot_186_210()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 6 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 6 hatasÄ±: {e}")
    
    def karbotu_step_7_fbtot_186_210(self):
        """AdÄ±m 7: Fbtot 1.86-2.10 ve Ask Sell pahalÄ±lÄ±k > +0.20"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 7: Fbtot 1.86-2.10 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 7: Fbtot 1.86-2.10 ve Ask Sell pahalÄ±lÄ±k > +0.20")
            
            # Lot yÃ¼zdesi: %25
            lot_percentage = 25
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.86-2.10 ve Ask Sell pahalÄ±lÄ±k > +0.20
                    if 1.86 <= fbtot <= 2.10 and ask_sell_pahalilik > 0.20:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 7: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 7: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell PahalÄ±lÄ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %25 lot ile Ask Sell onay penceresi aÃ§
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 25, "AdÄ±m 7")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 7: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 7: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 8'e geÃ§ - Take Profit Shorts aÃ§
                self.karbotu_current_step = 8
                self.karbotu_step_8_open_take_profit_shorts()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 7 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 7 hatasÄ±: {e}")
    
    def karbotu_step_8_open_take_profit_shorts(self):
        """AdÄ±m 8: Take Profit Longs kapat ve Take Profit Shorts aÃ§"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 8: Take Profit Shorts penceresi aÃ§Ä±lÄ±yor...")
            self.log_message("ğŸ“‹ AdÄ±m 8: Take Profit Shorts penceresi aÃ§Ä±lÄ±yor...")
            
            # Take Profit Longs penceresini kapat
            if hasattr(self, 'take_profit_longs_panel') and self.take_profit_longs_panel:
                self.take_profit_longs_panel.win.destroy()
            
            # Take Profit Shorts penceresini aÃ§
            from .take_profit_panel import TakeProfitPanel
            self.take_profit_shorts_panel = TakeProfitPanel(self, "shorts")
            
            # Gort kontrolÃ¼ yap (Take Profit Shorts iÃ§in)
            self.karbotu_gort_check_take_profit_shorts()
            
            # AdÄ±m 9'a geÃ§
            self.karbotu_current_step = 9
            self.karbotu_step_9_sfstot_170_high()
            
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 8 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 8 hatasÄ±: {e}")
    
    def karbotu_step_9_sfstot_170_high(self):
        """AdÄ±m 9: SFStot > 1.70 ve Bid Buy ucuzluk < +0.10"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 9: SFStot > 1.70 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 9: SFStot > 1.70 ve Bid Buy ucuzluk < +0.10")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]  # SFStot kolonu
                bid_buy_ucuzluk_str = values[8]  # Bid Buy Ucuzluk kolonu
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot > 1.70 ve Bid Buy ucuzluk < +0.10
                    if sfstot > 1.70 and bid_buy_ucuzluk < 0.10:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 9: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 9: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Bid Buy onay penceresi aÃ§
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "AdÄ±m 9")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 9: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 9: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 10'a geÃ§
                self.karbotu_current_step = 10
                self.karbotu_step_10_sfstot_140_169_low()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 9 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 9 hatasÄ±: {e}")
    
    def karbotu_step_10_sfstot_140_169_low(self):
        """AdÄ±m 10: SFStot 1.40-1.69 ve Bid Buy ucuzluk +0.05 ile -0.04 arasÄ±"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 10: SFStot 1.40-1.69 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 10: SFStot 1.40-1.69 ve Bid Buy ucuzluk +0.05 ile -0.04 arasÄ±")
            
            # Lot yÃ¼zdesi: %25
            lot_percentage = 25
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot 1.40-1.69 ve Bid Buy ucuzluk +0.05 ile -0.04 arasÄ±
                    if 1.40 <= sfstot <= 1.69 and -0.04 <= bid_buy_ucuzluk <= 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 10: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 10: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %25 lot ile Bid Buy onay penceresi aÃ§
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 25, "AdÄ±m 10")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 10: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 10: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 11'e geÃ§
                self.karbotu_current_step = 11
                self.karbotu_step_11_sfstot_140_169_high()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 10 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 10 hatasÄ±: {e}")
    
    def karbotu_select_shorts_positions_and_confirm(self, positions, order_type, lot_percentage, step_name):
        """Shorts pozisyonlarÄ± seÃ§ ve onay penceresi aÃ§"""
        try:
            # PozisyonlarÄ± seÃ§
            for pos in positions:
                self.take_profit_shorts_panel.tree.set(pos['item'], "select", "âœ“")
                
                # Avg cost'u gÃ¼venli ÅŸekilde parse et
                avg_cost_str = self.take_profit_shorts_panel.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_shorts_panel.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_shorts_panel.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Lot yÃ¼zdesini ayarla
            if lot_percentage == 25:
                self.take_profit_shorts_panel.set_lot_percentage(25)
            elif lot_percentage == 50:
                self.take_profit_shorts_panel.set_lot_percentage(50)
            
            # Onay penceresini aÃ§
            self.karbotu_show_shorts_confirmation_window(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[KARBOTU] âŒ Shorts pozisyon seÃ§imi hatasÄ±: {e}")
            self.log_message(f"âŒ Shorts pozisyon seÃ§imi hatasÄ±: {e}")
    
    def karbotu_send_shorts_orders_direct(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Shorts emirlerini direkt gÃ¶nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[KARBOTU SHORTS] ğŸ”„ {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            self.log_message(f"ğŸ”„ {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            
            # Pozisyon verilerini hazÄ±rla
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Negatif gelebilir
                abs_qty = abs(qty)
                
                # KoÅŸullar listesi (detaylÄ± rapor iÃ§in)
                conditions_checked = []
                conditions_passed = []
                conditions_failed = []
                
                # Lot hesapla
                calculated_lot = abs_qty * (lot_percentage / 100)
                
                # Lot yuvarlama
                if lot_percentage == 100:
                    lot_qty = int(calculated_lot)
                elif calculated_lot > 0:
                    if calculated_lot <= 0:
                        lot_qty = 0
                    elif calculated_lot <= 100:
                        lot_qty = 100
                    elif calculated_lot <= 200:
                        lot_qty = 200
                    elif calculated_lot <= 300:
                        lot_qty = 300
                    elif calculated_lot <= 400:
                        lot_qty = 400
                    elif calculated_lot <= 500:
                        lot_qty = 500
                    else:
                        lot_qty = int((calculated_lot + 99) // 100) * 100
                else:
                    lot_qty = 0
                
                conditions_checked.append(f"Lot Hesaplama: {abs_qty} x {lot_percentage}% = {calculated_lot:.0f} â†’ YuvarlanmÄ±ÅŸ: {lot_qty}")
                conditions_passed.append(f"Lot hesaplandÄ±: {lot_qty}")
                
                # MAXALW limit kontrolÃ¼ (kural bazlÄ±)
                maxalw = self.get_maxalw_for_symbol(symbol)
                multiplier = getattr(self, 'rule_max_change_multiplier', 0.75)
                max_change_limit = maxalw * multiplier if maxalw > 0 else 0
                
                # GÃ¼n baÅŸÄ± pozisyon
                befday_qty = self.load_bef_position(symbol)
                
                # Mevcut pozisyon ve aÃ§Ä±k emirler
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                
                # GÃ¼nlÃ¼k deÄŸiÅŸim (mutlak deÄŸer)
                current_daily_change = abs(current_potential - befday_qty)
                
                # Yeni emir sonrasÄ± potansiyel deÄŸiÅŸim (Bid Buy = short pozisyonu azaltÄ±r)
                new_potential = current_potential + lot_qty  # Short pozisyonu azaltÄ±r (daha az negatif)
                potential_daily_change = abs(new_potential - befday_qty)
                
                conditions_checked.append(f"Max Change Limiti: MAXALW={maxalw} x {multiplier} = {max_change_limit:.0f}")
                conditions_checked.append(f"GÃ¼nlÃ¼k DeÄŸiÅŸim: BefDay={befday_qty}, Current={current_potential:.0f}, New={new_potential:.0f}")
                conditions_checked.append(f"Potansiyel DeÄŸiÅŸim: {potential_daily_change:.0f} vs Max Change: {max_change_limit:.0f}")
                
                # MAXALW limit kontrolÃ¼ (kural bazlÄ±)
                if potential_daily_change > max_change_limit:
                    conditions_failed.append(f"Max Change limiti aÅŸÄ±ldÄ±: {potential_daily_change:.0f} > {max_change_limit:.0f}")
                    self.add_to_loop_report(
                        symbol=symbol, action="BUY", lot=lot_qty, price=0,
                        status="BLOCKED", step_name=step_name,
                        conditions_checked=conditions_checked,
                        conditions_passed=conditions_passed,
                        conditions_failed=conditions_failed,
                        final_reason=f"Max Change limiti aÅŸÄ±ldÄ± ({potential_daily_change:.0f} > {max_change_limit:.0f})"
                    )
                    print(f"[KARBOTU SHORTS] âš ï¸ {symbol}: Max Change limiti aÅŸÄ±lacak ({potential_daily_change:.0f} > {max_change_limit:.0f}), emir atlandÄ±")
                    self.log_message(f"âš ï¸ {symbol}: Max Change limiti aÅŸÄ±lacak, emir atlandÄ±")
                    continue
                
                conditions_passed.append(f"Max Change limiti OK: {potential_daily_change:.0f} <= {max_change_limit:.0f}")
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                conditions_checked.append(f"Market Data kontrolÃ¼")
                
                if not market_data:
                    conditions_failed.append("Market data bulunamadÄ±")
                    self.add_to_loop_report(
                        symbol=symbol, action="BUY", lot=lot_qty, price=0,
                        status="BLOCKED", step_name=step_name,
                        conditions_checked=conditions_checked,
                        conditions_passed=conditions_passed,
                        conditions_failed=conditions_failed,
                        final_reason="Market data bulunamadÄ±"
                    )
                    print(f"[KARBOTU SHORTS] âŒ {symbol} market_data bulunamadÄ±, atlandÄ±")
                    continue
                
                conditions_passed.append("Market data mevcut")
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                emir_fiyat = 0
                if order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                        conditions_passed.append(f"Fiyat hesaplandÄ±: Bid={bid:.2f}, Ask={ask:.2f}, Spread={spread:.2f}, Emir=${emir_fiyat:.2f}")
                    else:
                        conditions_failed.append(f"Bid/Ask geÃ§ersiz: Bid={bid}, Ask={ask}")
                        self.add_to_loop_report(
                            symbol=symbol, action="BUY", lot=lot_qty, price=0,
                            status="BLOCKED", step_name=step_name,
                            conditions_checked=conditions_checked,
                            conditions_passed=conditions_passed,
                            conditions_failed=conditions_failed,
                            final_reason="Bid/Ask fiyatlarÄ± geÃ§ersiz"
                        )
                        continue
                elif order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                        conditions_passed.append(f"Fiyat hesaplandÄ±: Bid={bid:.2f}, Ask={ask:.2f}, Spread={spread:.2f}, Emir=${emir_fiyat:.2f}")
                    else:
                        conditions_failed.append(f"Bid/Ask geÃ§ersiz: Bid={bid}, Ask={ask}")
                        continue
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty, 'conditions_checked': conditions_checked, 'conditions_passed': conditions_passed}
            
            # Emirleri gÃ¶nder
            success_count = 0
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                conditions_checked = data['conditions_checked']
                conditions_passed = data['conditions_passed']
                conditions_failed = []
                
                conditions_checked.append(f"Minimum Lot kontrolÃ¼: {abs(lot_qty)} >= 200?")
                
                if abs(lot_qty) < 200:
                    conditions_failed.append(f"Lot Ã§ok kÃ¼Ã§Ã¼k: {abs(lot_qty)} < 200")
                    self.add_to_loop_report(
                        symbol=symbol, action="BUY", lot=lot_qty, price=emir_fiyat,
                        status="BLOCKED", step_name=step_name,
                        conditions_checked=conditions_checked,
                        conditions_passed=conditions_passed,
                        conditions_failed=conditions_failed,
                        final_reason=f"Minimum lot altÄ±nda ({abs(lot_qty)} < 200)"
                    )
                    continue
                
                conditions_passed.append(f"Minimum lot OK: {abs(lot_qty)} >= 200")
                
                # Controller kontrolÃ¼ (MAXALW limitleri dahil)
                # KARBOTU pozisyon AZALTMA yapÄ±yor - toplam pozisyon limiti kontrolÃ¼ YAPILMAZ
                if hasattr(self, 'controller_enabled') and self.controller_enabled:
                    order_side = "BUY"  # Short pozisyonu kapatmak iÃ§in BUY
                    conditions_checked.append(f"Controller kontrolÃ¼: {order_side} {abs(lot_qty)} lot")
                    allowed, adjusted_qty, reason = self.controller_check_order(symbol, order_side, abs(lot_qty), is_reduce_order=True)
                    
                    if not allowed or adjusted_qty == 0:
                        conditions_failed.append(f"Controller engelledi: {reason}")
                        self.add_to_loop_report(
                            symbol=symbol, action="BUY", lot=lot_qty, price=emir_fiyat,
                            status="BLOCKED", step_name=step_name,
                            conditions_checked=conditions_checked,
                            conditions_passed=conditions_passed,
                            conditions_failed=conditions_failed,
                            final_reason=f"Controller engelledi: {reason}"
                        )
                        print(f"[KARBOTU SHORTS] âš ï¸ {symbol}: Controller engelledi - {reason}")
                        self.log_message(f"âš ï¸ {symbol}: Controller engelledi - {reason}")
                        continue
                    
                    conditions_passed.append(f"Controller OK: {adjusted_qty} lot onaylandÄ±")
                    lot_qty = adjusted_qty
                
                # Emir gÃ¶nder
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success or "new order sent" in str(success):
                            success_count += 1
                            conditions_passed.append(f"Emir baÅŸarÄ±yla gÃ¶nderildi")
                            self.add_to_loop_report(
                                symbol=symbol, action="BUY", lot=lot_qty, price=emir_fiyat,
                                status="SENT", step_name=step_name,
                                conditions_checked=conditions_checked,
                                conditions_passed=conditions_passed,
                                conditions_failed=[],
                                final_reason=f"Emir gÃ¶nderildi: BUY {lot_qty} lot @ ${emir_fiyat:.2f}"
                            )
                            print(f"[KARBOTU SHORTS] âœ… {symbol}: Bid Buy {lot_qty} lot @ ${emir_fiyat:.2f}")
                    except Exception as e:
                        if "new order sent" in str(e).lower():
                            success_count += 1
                            self.add_to_loop_report(
                                symbol=symbol, action="BUY", lot=lot_qty, price=emir_fiyat,
                                status="SENT", step_name=step_name,
                                conditions_checked=conditions_checked,
                                conditions_passed=conditions_passed,
                                conditions_failed=[],
                                final_reason=f"Emir gÃ¶nderildi: BUY {lot_qty} lot @ ${emir_fiyat:.2f}"
                            )
                        else:
                            self.add_to_loop_report(
                                symbol=symbol, action="BUY", lot=lot_qty, price=emir_fiyat,
                                status="BLOCKED", step_name=step_name,
                                conditions_checked=conditions_checked,
                                conditions_passed=conditions_passed,
                                conditions_failed=[f"API hatasÄ±: {e}"],
                                final_reason=f"API hatasÄ±: {e}"
                            )
                            print(f"[KARBOTU SHORTS] âŒ {symbol}: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT",
                        hidden=True
                    )
                    if success:
                        success_count += 1
                        self.add_to_loop_report(
                            symbol=symbol, action="BUY", lot=lot_qty, price=emir_fiyat,
                            status="SENT", step_name=step_name,
                            conditions_checked=conditions_checked,
                            conditions_passed=conditions_passed,
                            conditions_failed=[],
                            final_reason=f"Emir gÃ¶nderildi: BUY {lot_qty} lot @ ${emir_fiyat:.2f}"
                        )
                        print(f"[KARBOTU SHORTS] âœ… {symbol}: Bid Buy {lot_qty} lot @ ${emir_fiyat:.2f}")
            
            print(f"[KARBOTU SHORTS] âœ… {step_name} tamamlandÄ±: {success_count} emir gÃ¶nderildi")
            self.log_message(f"âœ… {step_name} tamamlandÄ±: {success_count} emir gÃ¶nderildi")
            
            # Sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile - adÄ±mlar sÄ±ralÄ± ilerlesin)
            self.after(1000, self.karbotu_proceed_to_next_step)
            
        except Exception as e:
            print(f"[KARBOTU SHORTS] âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            self.log_message(f"âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile)
            # UI'Ä± gÃ¼ncelle
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        self.psfalgo_window.lift()
                        self.psfalgo_window.update_idletasks()
                except:
                    pass
            self.after(500, self.karbotu_proceed_to_next_step)  # 1000'den 500'e dÃ¼ÅŸÃ¼rÃ¼ldÃ¼
    
    def karbotu_show_shorts_confirmation_window(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Shorts onay penceresi gÃ¶ster"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrolÃ¼
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU SHORTS] âœ… Allowed modu aktif - Onay penceresi atlanÄ±yor, emirler direkt gÃ¶nderiliyor")
                self.log_message(f"âœ… Allowed modu: {step_name} (Shorts) - Emirler otomatik gÃ¶nderiliyor")
                # Emirleri direkt gÃ¶nder (onay penceresi aÃ§madan)
                self.karbotu_send_shorts_orders_direct(positions, order_type, lot_percentage, step_name)
                return
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"KARBOTU - {step_name}")
            confirm_win.geometry("600x400")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            # BaÅŸlÄ±k frame - minimize butonu ile
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            # Sol taraf - baÅŸlÄ±k bilgileri
            title_left = ttk.Frame(title_frame)
            title_left.pack(side='left', fill='x', expand=True)
            
            ttk.Label(title_left, text=f"KARBOTU - {step_name}", font=('Arial', 14, 'bold')).pack(anchor='w')
            ttk.Label(title_left, text=f"{order_type} - %{lot_percentage} Lot", font=('Arial', 12)).pack(anchor='w')
            ttk.Label(title_left, text=f"{len(positions)} pozisyon seÃ§ildi", font=('Arial', 10)).pack(anchor='w')
            
            # SaÄŸ taraf - minimize butonu
            window_controls = ttk.Frame(title_frame)
            window_controls.pack(side='right')
            
            # Alta Al (Minimize) butonu
            minimize_btn = ttk.Button(window_controls, text="ğŸ—• Alta Al", width=10,
                                      command=lambda: confirm_win.iconify())
            minimize_btn.pack(side='left', padx=2)
            
            # Pozisyon listesi
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Treeview
            columns = ('Symbol', 'Qty', 'Lot', 'SFStot', 'Bid Buy Ucuzluk', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=10)
            
            # Kolon geniÅŸlikleri
            col_widths = {'Symbol': 80, 'Qty': 60, 'Lot': 60, 'SFStot': 60, 'Bid Buy Ucuzluk': 100, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            # Scrollbar
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # âœ… FÄ°YAT VE LOT DEPOSU - pencereye Ã¶zel
            order_data = {}  # {symbol: {'price': emir_fiyat, 'lot': lot_qty}}
            
            # PozisyonlarÄ± ekle
            for pos in positions:
                # Pozisyon verilerini al
                item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                qty = float(item_values[2])  # Negatif gelebilir (-276 gibi)
                
                # Short pozisyonlar iÃ§in ABS deÄŸer ile hesapla
                abs_qty = abs(qty)  # -276 -> 276
                calculated_lot = abs_qty * (lot_percentage / 100)  # 276 * 0.75 = 207
                
                # %100 lot iÃ§in yuvarlama YAPILMAZ - tam lot miktarÄ± kullanÄ±lÄ±r
                if lot_percentage == 100:
                    lot_qty = int(calculated_lot)  # 276 (pozitif)
                # Lot yuvarlama (%50 ve %25 iÃ§in) - pozitif deÄŸer ile yuvarlama yap
                elif calculated_lot > 0:
                    # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                    if calculated_lot <= 0:
                        lot_qty = 0
                    elif calculated_lot <= 100:
                        lot_qty = 100
                    elif calculated_lot <= 200:
                        lot_qty = 200
                    elif calculated_lot <= 300:
                        lot_qty = 300
                    elif calculated_lot <= 400:
                        lot_qty = 400
                    elif calculated_lot <= 500:
                        lot_qty = 500
                    elif calculated_lot <= 600:
                        lot_qty = 600
                    elif calculated_lot <= 700:
                        lot_qty = 700
                    elif calculated_lot <= 800:
                        lot_qty = 800
                    elif calculated_lot <= 900:
                        lot_qty = 900
                    elif calculated_lot <= 1000:
                        lot_qty = 1000
                    else:
                        lot_qty = int((calculated_lot + 99) // 100) * 100
                else:
                    lot_qty = 0
                
                # Lot her zaman pozitif olmalÄ± (BUY emri iÃ§in short pozisyonu kapatmak iÃ§in)
                # qty negatif olsa bile (short pozisyon), lot pozitif hesaplanÄ±r
                
                # Emir fiyatÄ±nÄ± hesapla (emir tipine gÃ¶re)
                symbol = pos['symbol']
                emir_fiyat = 0
                
                # JFIN ile BIREBIR aynÄ± mantÄ±k - Longs ile BIREBIR AYNI
                print(f"[KARBOTU SHORTS] ğŸ” {symbol} JFIN mantÄ±ÄŸÄ± ile fiyat hesaplanÄ±yor...")
                
                # JFIN'in calculate_order_price metodunu kopyala - AYNI MANTIK
                market_data = None
                
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        emir_fiyat = 0
                        print(f"[KARBOTU SHORTS] âŒ {symbol} market_data boÅŸ - JFIN gibi N/A dÃ¶ndÃ¼rÃ¼lÃ¼yor")
                        continue
                else:
                    emir_fiyat = 0
                    print(f"[KARBOTU SHORTS] âŒ {symbol} Hammer yok - JFIN gibi N/A dÃ¶ndÃ¼rÃ¼lÃ¼yor")
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                print(f"[KARBOTU SHORTS DEBUG] ğŸ“Š {symbol} JFIN market_data: bid=${bid:.2f}, ask=${ask:.2f}, last=${last:.2f}")
                
                # JFIN'in tam mantÄ±ÄŸÄ±nÄ± kopyala
                if order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                        print(f"[KARBOTU SHORTS] âœ… {symbol} Bid Buy (JFIN): bid=${bid:.2f} + spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU SHORTS] âŒ {symbol} Bid Buy: bid/ask deÄŸerleri geÃ§ersiz")
                elif order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                        print(f"[KARBOTU SHORTS] âœ… {symbol} Ask Sell (JFIN): ask=${ask:.2f} - spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU SHORTS] âŒ {symbol} Ask Sell: bid/ask deÄŸerleri geÃ§ersiz")
                else:
                    # Bilinmeyen emir tipi iÃ§in Bid Buy formÃ¼lÃ¼ kullan (shorts iÃ§in)
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                        print(f"[KARBOTU SHORTS] âœ… {symbol} {order_type} (JFIN default): bid=${bid:.2f} + spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU SHORTS] âŒ {symbol} {order_type}: bid/ask deÄŸerleri geÃ§ersiz")
                
                pos_tree.insert('', 'end', values=(
                    pos['symbol'],
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['sfstot']:.2f}",
                    f"${pos['bid_buy_ucuzluk']:.4f}",
                    f"${emir_fiyat:.2f}"
                ))
                
                # âœ… FÄ°YAT VE LOT DEPOSAYA KAYDET
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
                    print(f"[KARBOTU SHORTS] âœ… {symbol} depoya kaydedildi: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
                else:
                    print(f"[KARBOTU SHORTS] âš ï¸ {symbol} geÃ§ersiz: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
            
            # Butonlar
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                """Onay verildi - Emirleri gÃ¶nder - DEPODAN FÄ°YATLARI KULLAN"""
                try:
                    print(f"[KARBOTU] ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    self.log_message(f"ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    
                    # âœ… DEPODAN FÄ°YATLARI KULLAN - Market data Ã§ekme YOK
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        # âœ… Minimum 200 lot kontrolÃ¼ - 200'den azsa skip et
                        if abs(lot_qty) < 200:
                            print(f"[KARBOTU] âš ï¸ {symbol}: lot={lot_qty} < 200, atlandÄ±")
                            continue
                        
                        print(f"[KARBOTU] ğŸ“¤ {symbol}: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
                        
                        # Emir gÃ¶nder
                        if self.mode_manager.is_hammer_mode():
                            # Hammer Pro - Symbol dÃ¶nÃ¼ÅŸÃ¼mÃ¼
                            hammer_symbol = symbol.replace(" PR", "-")
                            
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="BUY",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                
                                if success or "new order sent" in str(success):
                                    print(f"[KARBOTU] âœ… {symbol} â†’ {hammer_symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f}")
                                else:
                                    print(f"[KARBOTU] âŒ {symbol} â†’ {hammer_symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f}")
                            except Exception as e:
                                if "new order sent" in str(e).lower():
                                    print(f"[KARBOTU] âœ… {symbol} â†’ {hammer_symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f} (new order sent)")
                                else:
                                    print(f"[KARBOTU] âŒ {symbol} â†’ {hammer_symbol}: {e}")
                        else:
                            # IBKR
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="BUY",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT",
                                hidden=True
                            )
                            
                            if success:
                                print(f"[KARBOTU] âœ… {symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f}")
                            else:
                                print(f"[KARBOTU] âŒ {symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f}")
                    
                    print(f"[KARBOTU] âœ… {step_name} emirleri gÃ¶nderildi")
                    self.log_message(f"âœ… {step_name} emirleri gÃ¶nderildi")
                    
                    # Popup'larÄ± kapat
                    self.addnewpos_close_messagebox()
                    if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                        self.runall_auto_confirm_messagebox()
                    
                except Exception as e:
                    print(f"[KARBOTU] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    self.log_message(f"âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                
                confirm_win.destroy()
                # Sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile - adÄ±mlar sÄ±ralÄ± ilerlesin)
                self.after(1000, self.karbotu_proceed_to_next_step)
            
            def on_cancel():
                """Ä°ptal edildi"""
                print(f"[KARBOTU] âŒ {step_name} iptal edildi")
                self.log_message(f"âŒ {step_name} iptal edildi")
                confirm_win.destroy()
                # Sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile - adÄ±mlar sÄ±ralÄ± ilerlesin)
                self.after(1000, self.karbotu_proceed_to_next_step)
            
            def save_to_trades_csv():
                """SeÃ§ili emirleri trades.csv formatÄ±nda kaydet - PENCERE'DEKÄ° FÄ°YATLAR kullan"""
                try:
                    print(f"[KARBOTU CSV SHORTS] ğŸ”„ trades.csv'ye kaydediliyor...")
                    self.log_message(f"ğŸ”„ trades.csv'ye kaydediliyor...")
                    
                    # CSV satÄ±rlarÄ±
                    csv_rows = []
                    
                    # PENCERE'DEKÄ° tablodan verileri al (zaten hesaplanmÄ±ÅŸ fiyatlar var)
                    for item in pos_tree.get_children():
                        values = pos_tree.item(item)['values']
                        symbol = values[0]
                        qty = float(values[1])
                        lot_qty = float(values[2])
                        
                        # Emir fiyatÄ±nÄ± PENCERE'DEKÄ° DEÄERDEN al (zaten hesaplanmÄ±ÅŸ)
                        emir_fiyat_str = values[5]  # "Emir Fiyat" kolonu
                        try:
                            # $ iÅŸaretini ve format karakterlerini temizle
                            emir_fiyat = float(str(emir_fiyat_str).replace('$', '').replace(',', '').strip())
                            print(f"[KARBOTU CSV SHORTS] âœ… {symbol}: Emir fiyatÄ± pencereden alÄ±ndÄ±: ${emir_fiyat:.2f}")
                        except (ValueError, TypeError, IndexError):
                            print(f"[KARBOTU CSV SHORTS] âŒ {symbol}: Emir fiyatÄ± okunamadÄ±: {emir_fiyat_str}")
                            emir_fiyat = 0
                            continue
                        
                        # Lot ve fiyat ZATEN PENCREDEN ALINDI - market data Ã§ekmeye GEREK YOK!
                        # Minimum lot kontrolÃ¼
                        if abs(lot_qty) < 200:
                            continue
                        
                        # CSV'ye kaydet (fiyat ve lot zaten hazÄ±r)
                        if emir_fiyat > 0:
                            # CSV formatÄ± (orijinal format)
                            csv_row = [
                                'BUY',                     # Action
                                int(lot_qty),             # Quantity
                                symbol,                    # Symbol
                                'STK',                    # SecType
                                'SMART/AMEX',              # Exchange
                                'USD',                    # Currency
                                'DAY',                    # TimeInForce
                                'LMT',                    # OrderType
                                f"{emir_fiyat:.2f}",      # LmtPrice
                                'Basket',                 # BasketTag
                                'U21016730',              # Account
                                'Basket',                 # OrderRef
                                'TRUE',                   # Hidden
                                'TRUE'                    # OutsideRth
                            ]
                            
                            csv_rows.append(csv_row)
                            print(f"[KARBOTU CSV] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    if csv_rows:
                        # CSV dosyasÄ±na kaydet
                        import csv
                        
                        csv_filename = 'trades.csv'
                        
                        # DosyayÄ± sÄ±fÄ±rdan yaz (write mode)
                        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                            writer = csv.writer(csvfile)
                            
                            # BaÅŸlÄ±k satÄ±rÄ± (orijinal format)
                            writer.writerow(['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 'OrderRef', 'Hidden', 'OutsideRth'])
                            
                            # Emir satÄ±rlarÄ±
                            writer.writerows(csv_rows)
                        
                        print(f"[KARBOTU CSV] âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        self.log_message(f"âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                    else:
                        messagebox.showwarning("UyarÄ±", "Kaydedilecek geÃ§erli emir bulunamadÄ±!")
                        
                except Exception as e:
                    print(f"[KARBOTU CSV] âŒ Kaydetme hatasÄ±: {e}")
                    self.log_message(f"âŒ Kaydetme hatasÄ±: {e}")
                    messagebox.showerror("Hata", f"trades.csv kaydetme hatasÄ±: {e}")
            
            ttk.Button(button_frame, text="Emirleri GÃ¶nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KARBOTU] âŒ Shorts onay penceresi hatasÄ±: {e}")
            self.log_message(f"âŒ Shorts onay penceresi hatasÄ±: {e}")
    
    def karbotu_step_11_sfstot_140_169_high(self):
        """AdÄ±m 11: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 11: SFStot 1.40-1.69 yÃ¼ksek kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 11: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05
                    if 1.40 <= sfstot <= 1.69 and bid_buy_ucuzluk < -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 11: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 11: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Bid Buy onay penceresi aÃ§
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "AdÄ±m 11")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 11: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 11: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 12'ye geÃ§
                self.karbotu_current_step = 12
                self.karbotu_step_12_sfstot_110_139_low()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 11 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 11 hatasÄ±: {e}")
    
    def karbotu_step_12_sfstot_110_139_low(self):
        """AdÄ±m 12: SFStot 1.10-1.39 ve Bid Buy ucuzluk +0.05 ile -0.04 arasÄ±"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 12: SFStot 1.10-1.39 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 12: SFStot 1.10-1.39 ve Bid Buy ucuzluk +0.05 ile -0.04 arasÄ±")
            
            # Lot yÃ¼zdesi: %25
            lot_percentage = 25
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot 1.10-1.39 ve Bid Buy ucuzluk +0.05 ile -0.04 arasÄ±
                    if 1.10 <= sfstot <= 1.39 and -0.04 <= bid_buy_ucuzluk <= 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 12: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 12: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %25 lot ile Bid Buy onay penceresi aÃ§
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 25, "AdÄ±m 12")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 12: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 12: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 13'e geÃ§
                self.karbotu_current_step = 13
                self.karbotu_step_13_sfstot_110_139_high()
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 12 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 12 hatasÄ±: {e}")
    
    def karbotu_step_13_sfstot_110_139_high(self):
        """AdÄ±m 13: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05"""
        try:
            print("[KARBOTU] ğŸ“‹ AdÄ±m 13: SFStot 1.10-1.39 yÃ¼ksek kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 13: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05
                    if 1.10 <= sfstot <= 1.39 and bid_buy_ucuzluk < -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] âœ… AdÄ±m 13: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 13: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarÄ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantÄ±ÄŸÄ± (debug iÃ§in - negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] âœ… {pos['symbol']}: Qty={qty:.0f} â†’ %{lot_percentage}={calculated_lot:.1f} â†’ {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Bid Buy onay penceresi aÃ§
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "AdÄ±m 13")
            else:
                print("[KARBOTU] âš ï¸ AdÄ±m 13: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 13: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 13 tamamlandÄ±, current_step'i set et ve proceed_to_next_step Ã§aÄŸÄ±r
                # proceed_to_next_step iÃ§inde bitiÅŸ kontrolÃ¼ yapÄ±lacak
                self.karbotu_current_step = 13
                print("[KARBOTU] ğŸ”„ AdÄ±m 13 tamamlandÄ±, karbotu_proceed_to_next_step Ã§aÄŸrÄ±lÄ±yor...")
                self.after(200, self.karbotu_proceed_to_next_step)
                
        except Exception as e:
            print(f"[KARBOTU] âŒ AdÄ±m 13 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 13 hatasÄ±: {e}")
            # Hata olsa bile otomasyonu sonlandÄ±r
            self.karbotu_running = False
    
    # ==================== REDUCEMORE OTOMASYONU ====================
    
    def start_reducemore_automation(self):
        """REDUCEMORE otomasyonunu baÅŸlat"""
        try:
            print("[REDUCEMORE] ğŸ“‰ REDUCEMORE otomasyonu baÅŸlatÄ±lÄ±yor...")
            self.log_message("ğŸ“‰ REDUCEMORE otomasyonu baÅŸlatÄ±lÄ±yor...")
            
            # Psfalgo aktivite logu
            self.log_psfalgo_activity(
                action="REDUCEMORE BaÅŸlatÄ±ldÄ±",
                details="13 adÄ±mlÄ± otomasyon baÅŸlÄ±yor",
                status="INFO",
                category="REDUCEMORE"
            )
            
            # REDUCEMORE adÄ±mlarÄ±nÄ± baÅŸlat
            self.reducemore_current_step = 1
            self.reducemore_total_steps = 13
            self.reducemore_running = True
            
            # Ä°lk adÄ±m: Take Profit Longs penceresini aÃ§ (non-blocking)
            # after() kullanarak GUI'yi bloklamadan baÅŸlat
            self.after(100, self.reduce_more_step_1_open_take_profit_longs)
            
        except Exception as e:
            print(f"[REDUCEMORE] âŒ Otomasyon baÅŸlatma hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE baÅŸlatma hatasÄ±: {e}")
            self.log_psfalgo_activity(
                action="REDUCEMORE Hata",
                details=str(e),
                status="ERROR",
                category="REDUCEMORE"
            )
            messagebox.showerror("Hata", f"REDUCEMORE baÅŸlatÄ±lamadÄ±: {e}")
    
    def karbotu_gort_check_take_profit_longs(self):
        """KARBOTU: Take Profit Longs iÃ§in Gort kontrolÃ¼ - Gort > -1 ve Ask Sell pahalÄ±lÄ±k > -0.05"""
        try:
            print(f"[KARBOTU GORT] ğŸ¯ karbotu_gort_check_take_profit_longs FONKSÄ°YONU Ã‡AÄRILDI!")
            print("[KARBOTU GORT] ğŸ“‹ Take Profit Longs iÃ§in Gort kontrolÃ¼ yapÄ±lÄ±yor...")
            self.log_message("ğŸ“‹ KARBOTU Gort kontrolÃ¼ (Longs): Gort > -1 ve Ask Sell pahalÄ±lÄ±k > -0.05")
            
            if not hasattr(self, 'take_profit_longs_panel') or not self.take_profit_longs_panel:
                print("[KARBOTU GORT] âš ï¸ Take Profit Longs paneli bulunamadÄ±")
                return
            
            # Lot yÃ¼zdesi: %10 (ama min 200 lot)
            lot_percentage = 10
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                gort_str = values[6]  # Gort kolonu (indeks 6)
                ask_sell_pahalilik_str = values[9]  # Ask Sell PahalÄ±lÄ±k kolonu (indeks 9)
                
                try:
                    # Gort'u gÃ¼venli ÅŸekilde parse et
                    gort = 0
                    if gort_str != 'N/A' and gort_str:
                        try:
                            gort = float(gort_str)
                        except (ValueError, TypeError):
                            gort = 0
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Gort tam 0.0 ise exclude et (N/A deÄŸeri)
                    if gort == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # KoÅŸul: Gort > -1 ve Ask Sell pahalÄ±lÄ±k > -0.05
                    if gort > -1 and ask_sell_pahalilik > -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'gort': gort,
                            'ask_sell_pahalilik': ask_sell_pahalilik,
                            'qty': qty
                        })
                        
                except (ValueError, TypeError) as e:
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU GORT] âœ… {len(filtered_positions)} pozisyon bulundu (Gort > -1 ve Ask Sell pahalÄ±lÄ±k > -0.05)")
                self.log_message(f"âœ… KARBOTU Gort kontrolÃ¼: {len(filtered_positions)} pozisyon bulundu")
                
                # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
                self.update_idletasks()
                
                # PozisyonlarÄ± seÃ§ ve Ã¶zel lot hesaplama ile emir gÃ¶nder (non-blocking)
                self.after(100, lambda: self.karbotu_gort_select_and_send_longs(filtered_positions, "Ask Sell", lot_percentage, "KARBOTU Gort KontrolÃ¼ (Longs)"))
            else:
                print("[KARBOTU GORT] âš ï¸ KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ KARBOTU Gort kontrolÃ¼: KoÅŸula uygun pozisyon bulunamadÄ±")
                
                # Pozisyon bulunamadÄ±ysa direkt adÄ±m 2'ye geÃ§ (non-blocking)
                self.after(200, self.karbotu_step_2_fbtot_lt_110)
                
        except Exception as e:
            print(f"[KARBOTU GORT] âŒ Hata: {e}")
            self.log_message(f"âŒ KARBOTU Gort kontrolÃ¼ hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def karbotu_gort_check_take_profit_shorts(self):
        """KARBOTU: Take Profit Shorts iÃ§in Gort kontrolÃ¼ - Gort < 1 ve Bid Buy ucuzluk < +0.05"""
        try:
            print("[KARBOTU GORT] ğŸ“‹ Take Profit Shorts iÃ§in Gort kontrolÃ¼ yapÄ±lÄ±yor...")
            self.log_message("ğŸ“‹ KARBOTU Gort kontrolÃ¼ (Shorts): Gort < 1 ve Bid Buy ucuzluk < +0.05")
            
            if not hasattr(self, 'take_profit_shorts_panel') or not self.take_profit_shorts_panel:
                print("[KARBOTU GORT] âš ï¸ Take Profit Shorts paneli bulunamadÄ±")
                return
            
            # Lot yÃ¼zdesi: %10 (ama min 200 lot)
            lot_percentage = 10
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                gort_str = values[6]  # Gort kolonu (indeks 6)
                bid_buy_ucuzluk_str = values[9]  # Bid Buy Ucuzluk kolonu (indeks 9)
                
                try:
                    # Gort'u gÃ¼venli ÅŸekilde parse et
                    gort = 0
                    if gort_str != 'N/A' and gort_str:
                        try:
                            gort = float(gort_str)
                        except (ValueError, TypeError):
                            gort = 0
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Gort tam 0.0 ise exclude et (N/A deÄŸeri)
                    if gort == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu (negatif deÄŸer)
                    if abs(qty) < 100:
                        continue
                    
                    # KoÅŸul: Gort < 1 ve Bid Buy ucuzluk < +0.05
                    if gort < 1 and bid_buy_ucuzluk < 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'gort': gort,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk,
                            'qty': qty
                        })
                        
                except (ValueError, TypeError) as e:
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU GORT] âœ… {len(filtered_positions)} pozisyon bulundu (Gort < 1 ve Bid Buy ucuzluk < +0.05)")
                self.log_message(f"âœ… KARBOTU Gort kontrolÃ¼: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve Ã¶zel lot hesaplama ile emir gÃ¶nder
                self.karbotu_gort_select_and_send_shorts(filtered_positions, "Bid Buy", lot_percentage, "KARBOTU Gort KontrolÃ¼ (Shorts)")
            else:
                print("[KARBOTU GORT] âš ï¸ KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ KARBOTU Gort kontrolÃ¼: KoÅŸula uygun pozisyon bulunamadÄ±")
                # Pozisyon bulunamadÄ±ysa direkt adÄ±m 9'a geÃ§ (non-blocking)
                self.after(200, self.karbotu_step_9_sfstot_170_high)
                
        except Exception as e:
            print(f"[KARBOTU GORT] âŒ Hata: {e}")
            self.log_message(f"âŒ KARBOTU Gort kontrolÃ¼ hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile adÄ±m 9'a geÃ§
            self.after(200, self.karbotu_step_9_sfstot_170_high)
    
    def reduce_more_step_1_open_take_profit_longs(self):
        """AdÄ±m 1: Take Profit Longs penceresini aÃ§"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 1: Take Profit Longs penceresi aÃ§Ä±lÄ±yor...")
            self.log_message("ğŸ“‹ AdÄ±m 1: Take Profit Longs penceresi aÃ§Ä±lÄ±yor...")
            
            # Take Profit Longs penceresini aÃ§
            from .take_profit_panel import TakeProfitPanel
            self.take_profit_longs_panel_reducemore = TakeProfitPanel(self, "longs")
            
            # GUI'yi gÃ¼ncelle (pencere aÃ§Ä±ldÄ±ktan sonra)
            self.update_idletasks()
            
            # Gort kontrolÃ¼ yap (Take Profit Longs iÃ§in) - non-blocking
            self.after(200, self.reducemore_gort_check_take_profit_longs)
            
            # AdÄ±m 2'ye geÃ§ (Gort kontrolÃ¼ bitince)
            self.reducemore_current_step = 2
            # Gort kontrolÃ¼ bitince adÄ±m 2'ye geÃ§ilecek (reducemore_gort_check_take_profit_longs iÃ§inde)
            
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 1 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 1 hatasÄ±: {e}")
    
    def reduce_more_step_2_fbtot_lt_110(self):
        """AdÄ±m 2: Fbtot < 1.10 ve Ask Sell pahalÄ±lÄ±k > -0.20"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 2: Fbtot < 1.10 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 2: Fbtot < 1.10 ve Ask Sell pahalÄ±lÄ±k > -0.20")
            
            # Lot yÃ¼zdesi: %100
            lot_percentage = 100
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]  # Fbtot kolonu
                ask_sell_pahalilik_str = values[8]  # Ask Sell PahalÄ±lÄ±k kolonu
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            # $ iÅŸaretini kaldÄ±r ve float'a Ã§evir
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot < 1.10 ve Ask Sell pahalÄ±lÄ±k > -0.20
                    if fbtot < 1.10 and ask_sell_pahalilik > -0.20:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 2: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 2: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %100 lot ile Ask Sell onay penceresi aÃ§
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 100, "AdÄ±m 2")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 2: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 2: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 3'e geÃ§
                self.reducemore_current_step = 3
                self.reduce_more_step_3_fbtot_111_145_low()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 2 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 2 hatasÄ±: {e}")
    
    def reduce_more_step_3_fbtot_111_145_low(self):
        """AdÄ±m 3: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k -0.08 ile +0.01 arasÄ±"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 3: Fbtot 1.11-1.45 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 3: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k -0.08 ile +0.01 arasÄ±")
            
            # Lot yÃ¼zdesi: %75
            lot_percentage = 75
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k -0.08 ile +0.01 arasÄ±
                    if 1.11 <= fbtot <= 1.45 and -0.08 <= ask_sell_pahalilik <= 0.01:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 3: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 3: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %75 lot ile Ask Sell onay penceresi aÃ§
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 75, "AdÄ±m 3")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 3: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 3: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 4'e geÃ§
                self.reducemore_current_step = 4
                self.reduce_more_step_4_fbtot_111_145_high()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 3 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 3 hatasÄ±: {e}")
    
    def reduce_more_step_4_fbtot_111_145_high(self):
        """AdÄ±m 4: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k > +0.01"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 4: Fbtot 1.11-1.45 yÃ¼ksek kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 4: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k > +0.01")
            
            # Lot yÃ¼zdesi: %100
            lot_percentage = 100
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.11-1.45 ve Ask Sell pahalÄ±lÄ±k > +0.01
                    if 1.11 <= fbtot <= 1.45 and ask_sell_pahalilik > 0.01:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 4: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 4: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %100 lot ile Ask Sell onay penceresi aÃ§
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 100, "AdÄ±m 4")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 4: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 4: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 5'e geÃ§
                self.reducemore_current_step = 5
                self.reduce_more_step_5_fbtot_146_185_low()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 4 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 4 hatasÄ±: {e}")
    
    def reduce_more_step_5_fbtot_146_185_low(self):
        """AdÄ±m 5: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k +0.01 ile +0.07 arasÄ±"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 5: Fbtot 1.46-1.85 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 5: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k +0.01 ile +0.07 arasÄ±")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k +0.01 ile +0.07 arasÄ±
                    if 1.46 <= fbtot <= 1.85 and 0.01 <= ask_sell_pahalilik <= 0.07:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 5: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 5: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Ask Sell onay penceresi aÃ§
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "AdÄ±m 5")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 5: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 5: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 6'ya geÃ§
                self.reducemore_current_step = 6
                self.reduce_more_step_6_fbtot_146_185_high()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 5 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 5 hatasÄ±: {e}")
    
    def reduce_more_step_6_fbtot_146_185_high(self):
        """AdÄ±m 6: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k > +0.07"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 6: Fbtot 1.46-1.85 yÃ¼ksek kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 6: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k > +0.07")
            
            # Lot yÃ¼zdesi: %75
            lot_percentage = 75
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.46-1.85 ve Ask Sell pahalÄ±lÄ±k > +0.07
                    if 1.46 <= fbtot <= 1.85 and ask_sell_pahalilik > 0.07:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 6: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 6: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %75 lot ile Ask Sell onay penceresi aÃ§
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 75, "AdÄ±m 6")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 6: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 6: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 7'ye geÃ§
                self.reducemore_current_step = 7
                self.reduce_more_step_7_fbtot_186_210()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 6 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 6 hatasÄ±: {e}")
    
    def reduce_more_step_7_fbtot_186_210(self):
        """AdÄ±m 7: Fbtot 1.86-2.10 ve Ask Sell pahalÄ±lÄ±k > +0.18"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 7: Fbtot 1.86-2.10 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 7: Fbtot 1.86-2.10 ve Ask Sell pahalÄ±lÄ±k > +0.18")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u gÃ¼venli ÅŸekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # KoÅŸul: Fbtot 1.86-2.10 ve Ask Sell pahalÄ±lÄ±k > +0.18
                    if 1.86 <= fbtot <= 2.10 and ask_sell_pahalilik > 0.18:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 7: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 7: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Ask Sell onay penceresi aÃ§
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "AdÄ±m 7")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 7: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 7: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 8'e geÃ§ - Take Profit Shorts aÃ§
                self.reducemore_current_step = 8
                self.reduce_more_step_8_open_take_profit_shorts()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 7 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 7 hatasÄ±: {e}")
    
    def reduce_more_step_8_open_take_profit_shorts(self):
        """AdÄ±m 8: Take Profit Longs kapat ve Take Profit Shorts aÃ§"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 8: Take Profit Shorts penceresi aÃ§Ä±lÄ±yor...")
            self.log_message("ğŸ“‹ AdÄ±m 8: Take Profit Shorts penceresi aÃ§Ä±lÄ±yor...")
            
            # Take Profit Longs penceresini kapat
            if hasattr(self, 'take_profit_longs_panel_reducemore') and self.take_profit_longs_panel_reducemore:
                self.take_profit_longs_panel_reducemore.win.destroy()
            
            # Take Profit Shorts penceresini aÃ§
            from .take_profit_panel import TakeProfitPanel
            self.take_profit_shorts_panel_reducemore = TakeProfitPanel(self, "shorts")
            
            # Gort kontrolÃ¼ yap (Take Profit Shorts iÃ§in)
            self.reducemore_gort_check_take_profit_shorts()
            
            # AdÄ±m 9'a geÃ§
            self.reducemore_current_step = 9
            self.reduce_more_step_9_sfstot_170_high()
            
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 8 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 8 hatasÄ±: {e}")
    
    def reduce_more_step_9_sfstot_170_high(self):
        """AdÄ±m 9: SFStot > 1.70 ve Bid Buy ucuzluk < +0.14"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 9: SFStot > 1.70 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 9: SFStot > 1.70 ve Bid Buy ucuzluk < +0.14")
            
            # Lot yÃ¼zdesi: %100
            lot_percentage = 100
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]  # SFStot kolonu
                bid_buy_ucuzluk_str = values[8]  # Bid Buy Ucuzluk kolonu
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot > 1.70 ve Bid Buy ucuzluk < +0.14
                    if sfstot > 1.70 and bid_buy_ucuzluk < 0.14:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 9: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 9: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %100 lot ile Bid Buy onay penceresi aÃ§
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 100, "AdÄ±m 9")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 9: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 9: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 10'a geÃ§
                self.reducemore_current_step = 10
                self.reduce_more_step_10_sfstot_140_169_low()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 9 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 9 hatasÄ±: {e}")
    
    def reduce_more_step_10_sfstot_140_169_low(self):
        """AdÄ±m 10: SFStot 1.40-1.69 ve Bid Buy ucuzluk -0.04 ile +0.05 arasÄ±"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 10: SFStot 1.40-1.69 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 10: SFStot 1.40-1.69 ve Bid Buy ucuzluk -0.04 ile +0.05 arasÄ±")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot 1.40-1.69 ve Bid Buy ucuzluk -0.04 ile +0.05 arasÄ±
                    if 1.40 <= sfstot <= 1.69 and -0.04 <= bid_buy_ucuzluk <= 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 10: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 10: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Bid Buy onay penceresi aÃ§
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "AdÄ±m 10")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 10: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 10: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 11'e geÃ§
                self.reducemore_current_step = 11
                self.reduce_more_step_11_sfstot_140_169_high()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 10 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 10 hatasÄ±: {e}")
    
    def reduce_more_step_11_sfstot_140_169_high(self):
        """AdÄ±m 11: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 11: SFStot 1.40-1.69 yÃ¼ksek kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 11: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05")
            
            # Lot yÃ¼zdesi: %75
            lot_percentage = 75
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05
                    if 1.40 <= sfstot <= 1.69 and bid_buy_ucuzluk < -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 11: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 11: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %75 lot ile Bid Buy onay penceresi aÃ§
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 75, "AdÄ±m 11")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 11: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 11: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 12'ye geÃ§
                self.reducemore_current_step = 12
                self.reduce_more_step_12_sfstot_110_139_low()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 11 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 11 hatasÄ±: {e}")
    
    def reduce_more_step_12_sfstot_110_139_low(self):
        """AdÄ±m 12: SFStot 1.10-1.39 ve Bid Buy ucuzluk -0.04 ile +0.05 arasÄ±"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 12: SFStot 1.10-1.39 kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 12: SFStot 1.10-1.39 ve Bid Buy ucuzluk -0.04 ile +0.05 arasÄ±")
            
            # Lot yÃ¼zdesi: %50
            lot_percentage = 50
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot 1.10-1.39 ve Bid Buy ucuzluk -0.04 ile +0.05 arasÄ±
                    if 1.10 <= sfstot <= 1.39 and -0.04 <= bid_buy_ucuzluk <= 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 12: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 12: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %50 lot ile Bid Buy onay penceresi aÃ§
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "AdÄ±m 12")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 12: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 12: KoÅŸula uygun pozisyon bulunamadÄ±")
                # AdÄ±m 13'e geÃ§
                self.reducemore_current_step = 13
                self.reduce_more_step_13_sfstot_110_139_high()
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 12 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 12 hatasÄ±: {e}")
    
    def reduce_more_step_13_sfstot_110_139_high(self):
        """AdÄ±m 13: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05"""
        try:
            print("[REDUCEMORE] ğŸ“‹ AdÄ±m 13: SFStot 1.10-1.39 yÃ¼ksek kontrolÃ¼...")
            self.log_message("ğŸ“‹ AdÄ±m 13: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05")
            
            # Lot yÃ¼zdesi: %75
            lot_percentage = 75
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u gÃ¼venli ÅŸekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deÄŸeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # KoÅŸul: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05
                    if 1.10 <= sfstot <= 1.39 and bid_buy_ucuzluk < -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] âœ… AdÄ±m 13: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"âœ… AdÄ±m 13: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve %75 lot ile Bid Buy onay penceresi aÃ§
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 75, "AdÄ±m 13")
            else:
                print("[REDUCEMORE] âš ï¸ AdÄ±m 13: KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ AdÄ±m 13: KoÅŸula uygun pozisyon bulunamadÄ±")
                # TÃ¼m adÄ±mlar tamamlandÄ±
                print("[REDUCEMORE] ğŸ¯ TÃ¼m adÄ±mlar tamamlandÄ±!")
                self.log_message("ğŸ¯ REDUCEMORE otomasyonu tamamlandÄ±!")
                self.reducemore_running = False
                
                # RUNALL'dan Ã§aÄŸrÄ±ldÄ±ysa ADDNEWPOS kontrolÃ¼ yap (SADECE BÄ°R KEZ)
                if hasattr(self, 'runall_waiting_for_reducemore') and self.runall_waiting_for_reducemore:
                    if not hasattr(self, 'runall_addnewpos_triggered') or not self.runall_addnewpos_triggered:
                        # Flag'i runall_check_karbotu_and_addnewpos iÃ§inde set edeceÄŸiz, burada sadece tetikle
                        # Hemen kontrol et (200ms bekle - hÄ±zlÄ± geÃ§iÅŸ)
                        print("[REDUCEMORE] ğŸ”„ RUNALL'dan Ã§aÄŸrÄ±ldÄ±, ADDNEWPOS kontrolÃ¼ 200ms sonra yapÄ±lacak...")
                        self.after(200, self.runall_check_karbotu_and_addnewpos)
                    else:
                        print("[REDUCEMORE] âš ï¸ ADDNEWPOS zaten tetiklendi, tekrar tetiklenmeyecek")
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ AdÄ±m 13 hatasÄ±: {e}")
            self.log_message(f"âŒ AdÄ±m 13 hatasÄ±: {e}")
            # Hata olsa bile otomasyonu sonlandÄ±r
            self.reducemore_running = False
    
    def reducemore_gort_check_take_profit_longs(self):
        """REDUCEMORE: Take Profit Longs iÃ§in Gort kontrolÃ¼ - Gort > -1 ve Ask Sell pahalÄ±lÄ±k > -0.08"""
        try:
            print("[REDUCEMORE GORT] ğŸ“‹ Take Profit Longs iÃ§in Gort kontrolÃ¼ yapÄ±lÄ±yor...")
            self.log_message("ğŸ“‹ REDUCEMORE Gort kontrolÃ¼ (Longs): Gort > -1 ve Ask Sell pahalÄ±lÄ±k > -0.08")
            
            if not hasattr(self, 'take_profit_longs_panel_reducemore') or not self.take_profit_longs_panel_reducemore:
                print("[REDUCEMORE GORT] âš ï¸ Take Profit Longs paneli bulunamadÄ±")
                return
            
            # Lot yÃ¼zdesi: %20 (ama min 200 lot)
            lot_percentage = 20
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                gort_str = values[6]  # Gort kolonu (indeks 6)
                ask_sell_pahalilik_str = values[9]  # Ask Sell PahalÄ±lÄ±k kolonu (indeks 9)
                
                try:
                    # Gort'u gÃ¼venli ÅŸekilde parse et
                    gort = 0
                    if gort_str != 'N/A' and gort_str:
                        try:
                            gort = float(gort_str)
                        except (ValueError, TypeError):
                            gort = 0
                    
                    # Ask Sell pahalÄ±lÄ±k skorunu gÃ¼venli ÅŸekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Gort tam 0.0 ise exclude et (N/A deÄŸeri)
                    if gort == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # KoÅŸul: Gort > -1 ve Ask Sell pahalÄ±lÄ±k > -0.08
                    if gort > -1 and ask_sell_pahalilik > -0.08:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'gort': gort,
                            'ask_sell_pahalilik': ask_sell_pahalilik,
                            'qty': qty
                        })
                        
                except (ValueError, TypeError) as e:
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE GORT] âœ… {len(filtered_positions)} pozisyon bulundu (Gort > -1 ve Ask Sell pahalÄ±lÄ±k > -0.08)")
                self.log_message(f"âœ… REDUCEMORE Gort kontrolÃ¼: {len(filtered_positions)} pozisyon bulundu")
                
                # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
                self.update_idletasks()
                
                # PozisyonlarÄ± seÃ§ ve Ã¶zel lot hesaplama ile emir gÃ¶nder (non-blocking)
                self.after(100, lambda: self.reducemore_gort_select_and_send_longs(filtered_positions, "Ask Sell", lot_percentage, "REDUCEMORE Gort KontrolÃ¼ (Longs)"))
            else:
                print("[REDUCEMORE GORT] âš ï¸ KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ REDUCEMORE Gort kontrolÃ¼: KoÅŸula uygun pozisyon bulunamadÄ±")
                
                # Pozisyon bulunamadÄ±ysa direkt adÄ±m 2'ye geÃ§ (non-blocking)
                self.after(200, self.reduce_more_step_2_fbtot_lt_110)
                
        except Exception as e:
            print(f"[REDUCEMORE GORT] âŒ Hata: {e}")
            self.log_message(f"âŒ REDUCEMORE Gort kontrolÃ¼ hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reducemore_gort_check_take_profit_shorts(self):
        """REDUCEMORE: Take Profit Shorts iÃ§in Gort kontrolÃ¼ - Gort < 1 ve Bid Buy ucuzluk < +0.08"""
        try:
            print("[REDUCEMORE GORT] ğŸ“‹ Take Profit Shorts iÃ§in Gort kontrolÃ¼ yapÄ±lÄ±yor...")
            self.log_message("ğŸ“‹ REDUCEMORE Gort kontrolÃ¼ (Shorts): Gort < 1 ve Bid Buy ucuzluk < +0.08")
            
            if not hasattr(self, 'take_profit_shorts_panel_reducemore') or not self.take_profit_shorts_panel_reducemore:
                print("[REDUCEMORE GORT] âš ï¸ Take Profit Shorts paneli bulunamadÄ±")
                return
            
            # Lot yÃ¼zdesi: %20 (ama min 200 lot)
            lot_percentage = 20
            
            # PozisyonlarÄ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                gort_str = values[6]  # Gort kolonu (indeks 6)
                bid_buy_ucuzluk_str = values[9]  # Bid Buy Ucuzluk kolonu (indeks 9)
                
                try:
                    # Gort'u gÃ¼venli ÅŸekilde parse et
                    gort = 0
                    if gort_str != 'N/A' and gort_str:
                        try:
                            gort = float(gort_str)
                        except (ValueError, TypeError):
                            gort = 0
                    
                    # Bid Buy ucuzluk skorunu gÃ¼venli ÅŸekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Gort tam 0.0 ise exclude et (N/A deÄŸeri)
                    if gort == 0.0:
                        continue
                    
                    # 100 lot altÄ± pozisyonlarÄ± gÃ¶z ardÄ± et
                    qty = float(values[2])  # Quantity kolonu (negatif deÄŸer)
                    if abs(qty) < 100:
                        continue
                    
                    # KoÅŸul: Gort < 1 ve Bid Buy ucuzluk < +0.08
                    if gort < 1 and bid_buy_ucuzluk < 0.08:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'gort': gort,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk,
                            'qty': qty
                        })
                        
                except (ValueError, TypeError) as e:
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE GORT] âœ… {len(filtered_positions)} pozisyon bulundu (Gort < 1 ve Bid Buy ucuzluk < +0.08)")
                self.log_message(f"âœ… REDUCEMORE Gort kontrolÃ¼: {len(filtered_positions)} pozisyon bulundu")
                
                # PozisyonlarÄ± seÃ§ ve Ã¶zel lot hesaplama ile emir gÃ¶nder
                self.reducemore_gort_select_and_send_shorts(filtered_positions, "Bid Buy", lot_percentage, "REDUCEMORE Gort KontrolÃ¼ (Shorts)")
            else:
                print("[REDUCEMORE GORT] âš ï¸ KoÅŸula uygun pozisyon bulunamadÄ±")
                self.log_message("âš ï¸ REDUCEMORE Gort kontrolÃ¼: KoÅŸula uygun pozisyon bulunamadÄ±")
                
        except Exception as e:
            print(f"[REDUCEMORE GORT] âŒ Hata: {e}")
            self.log_message(f"âŒ REDUCEMORE Gort kontrolÃ¼ hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reduce_more_select_positions_and_confirm(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE: PozisyonlarÄ± seÃ§ ve onay penceresi aÃ§"""
        try:
            # PozisyonlarÄ± seÃ§
            for pos in positions:
                self.take_profit_longs_panel_reducemore.tree.set(pos['item'], "select", "âœ“")
                
                # Avg cost'u gÃ¼venli ÅŸekilde parse et
                avg_cost_str = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_longs_panel_reducemore.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Lot yÃ¼zdesini ayarla
            if lot_percentage == 25:
                self.take_profit_longs_panel_reducemore.set_lot_percentage(25)
            elif lot_percentage == 50:
                self.take_profit_longs_panel_reducemore.set_lot_percentage(50)
            elif lot_percentage == 75:
                self.take_profit_longs_panel_reducemore.set_lot_percentage(75)
            elif lot_percentage == 100:
                self.take_profit_longs_panel_reducemore.set_lot_percentage(100)
            
            # Onay penceresini aÃ§
            print(f"[REDUCEMORE DEBUG] ğŸ”„ Onay penceresi aÃ§Ä±lÄ±yor: {step_name}")
            self.reduce_more_show_confirmation_window(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[REDUCEMORE] âŒ Pozisyon seÃ§imi hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE pozisyon seÃ§imi hatasÄ±: {e}")
    
    def reducemore_send_orders_direct(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE emirlerini direkt gÃ¶nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[REDUCEMORE] ğŸ”„ {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            self.log_message(f"ğŸ”„ {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            
            # Pozisyon verilerini hazÄ±rla
            order_data = {}
            
            # Panel seÃ§imi (order_type'a gÃ¶re)
            if order_type in ["Ask Sell", "Front Sell"]:
                panel = self.take_profit_longs_panel_reducemore
            else:
                panel = self.take_profit_shorts_panel_reducemore
            
            for pos in positions:
                item_values = panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])
                
                # Lot hesapla
                calculated_lot = qty * (lot_percentage / 100)
                
                # 200 lot altÄ± pozisyonlar iÃ§in tamamÄ±nÄ± gÃ¶nder
                abs_qty = abs(qty)
                if abs_qty < 200:
                    # Eldeki lot < 200 ise tamamÄ±nÄ± gÃ¶nder
                    lot_qty = int(abs_qty) if qty >= 0 else -int(abs_qty)
                else:
                    # Lot yuvarlama
                    if calculated_lot >= 0:
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                
                # YENÄ° KURAL SÄ°STEMÄ°: REDUCE limitleri (BefQty/PortfÃ¶y oranÄ±na gÃ¶re)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                
                # GÃ¼nlÃ¼k reduce limitini hesapla
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                # Mevcut pozisyon ve aÃ§Ä±k emirler
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                
                # GÃ¼nlÃ¼k deÄŸiÅŸim (mutlak deÄŸer)
                current_daily_change = abs(current_potential - befday_qty)
                
                # Kalan gÃ¼nlÃ¼k hak
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                # Emir miktarÄ±nÄ± kontrol et ve gerekirse ayarla
                if lot_qty > remaining_allowance and not is_unlimited:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[REDUCEMORE] âš ï¸ {symbol}: GÃ¼nlÃ¼k limit doldu ({current_daily_change:.0f}/{daily_limit:.0f}), emir atlandÄ±")
                        self.log_message(f"âš ï¸ {symbol}: GÃ¼nlÃ¼k REDUCE limit doldu, emir atlandÄ±")
                        continue
                    else:
                        # Lot miktarÄ±nÄ± ayarla
                        lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                        print(f"[REDUCEMORE] ğŸ“Š {symbol}: Emir miktarÄ± ayarlandÄ± â†’ {lot_qty} lot ({limit_reason})")
                
                # Ters pozisyona geÃ§iÅŸ kontrolÃ¼ (sÄ±nÄ±rsÄ±z bile olsa)
                if order_type == "Ask Sell":
                    new_potential = current_potential - lot_qty
                else:
                    new_potential = current_potential + lot_qty
                
                # Long iken short'a veya short iken long'a geÃ§iÅŸi engelle
                if befday_qty > 0 and new_potential < 0:
                    lot_qty = int(current_potential)  # 0'a getir
                    print(f"[REDUCEMORE] âš ï¸ {symbol}: Ters poz. yasak, lot ayarlandÄ± â†’ {lot_qty}")
                elif befday_qty < 0 and new_potential > 0:
                    lot_qty = int(abs(current_potential))  # 0'a getir
                    print(f"[REDUCEMORE] âš ï¸ {symbol}: Ters poz. yasak, lot ayarlandÄ± â†’ {lot_qty}")
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                if not market_data:
                    print(f"[REDUCEMORE] âŒ {symbol} market_data bulunamadÄ±, atlandÄ±")
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                emir_fiyat = 0
                if order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        continue
                elif order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                elif order_type == "Front Sell":
                    if last > 0:
                        emir_fiyat = last - 0.01
                    else:
                        continue
                elif order_type == "Front Buy":
                    if last > 0:
                        emir_fiyat = last + 0.01
                    else:
                        continue
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri gÃ¶nder
            success_count = 0
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if abs(lot_qty) < 200:
                    continue
                
                # Controller kontrolÃ¼ (MAXALW limitleri dahil)
                # KARBOTU pozisyon AZALTMA yapÄ±yor - toplam pozisyon limiti kontrolÃ¼ YAPILMAZ
                if hasattr(self, 'controller_enabled') and self.controller_enabled:
                    order_side = "SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY"
                    allowed, adjusted_qty, reason = self.controller_check_order(symbol, order_side, abs(lot_qty), is_reduce_order=True)
                    
                    if not allowed or adjusted_qty == 0:
                        print(f"[REDUCEMORE] âš ï¸ {symbol}: Controller engelledi - {reason}")
                        self.log_message(f"âš ï¸ {symbol}: Controller engelledi - {reason}")
                        
                        self.log_psfalgo_activity(
                            action=f"{step_name} Engellendi",
                            details=f"{symbol}: Controller engelledi",
                            status="BLOCKED",
                            reason=reason,
                            category="REDUCEMORE"
                        )
                        continue
                    
                    lot_qty = adjusted_qty if order_side == "SELL" else adjusted_qty
                
                # Emir gÃ¶nder
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success or "new order sent" in str(success):
                            success_count += 1
                            print(f"[REDUCEMORE] âœ… {symbol}: {order_type} {lot_qty} lot @ ${emir_fiyat:.2f}")
                            # Reasoning: Neden bu emir gÃ¶nderildi?
                            reasoning = f"{step_name} | Lot: {lot_qty} ({lot_percentage}% of {abs(qty)}) | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                            self.log_psfalgo_activity("EMIR_ILETILDI", f"{symbol} {order_type} {lot_qty} @ ${emir_fiyat:.2f}", "SUCCESS", reasoning, "REDUCEMORE")
                    except Exception as e:
                        if "new order sent" in str(e).lower():
                            success_count += 1
                            reasoning = f"{step_name} | Lot: {lot_qty} ({lot_percentage}% of {abs(qty)}) | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                            self.log_psfalgo_activity("EMIR_ILETILDI", f"{symbol} {order_type} {lot_qty} @ {emir_fiyat:.2f}", "SUCCESS", reasoning, "REDUCEMORE")
                        else:
                            print(f"[REDUCEMORE] âŒ {symbol}: {e}")
                            self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "REDUCEMORE")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT",
                        hidden=True
                    )
                    if success:
                        success_count += 1
                        print(f"[REDUCEMORE] âœ… {symbol}: {order_type} {lot_qty} lot @ ${emir_fiyat:.2f}")
                        details_msg = f"{symbol} {order_type} {lot_qty} @ {emir_fiyat:.2f}"
                        # Reasoning: Neden bu emir gÃ¶nderildi?
                        reasoning = f"{step_name} | Lot: {lot_qty} ({lot_percentage}% of {abs(qty)}) | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
            
            print(f"[REDUCEMORE] âœ… {step_name} tamamlandÄ±: {success_count} emir gÃ¶nderildi")
            self.log_message(f"âœ… {step_name} tamamlandÄ±: {success_count} emir gÃ¶nderildi")
            
            # Sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile - adÄ±mlar sÄ±ralÄ± ilerlesin)
            self.after(1000, self.reduce_more_proceed_to_next_step)
            
        except Exception as e:
            print(f"[REDUCEMORE] âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            self.log_message(f"âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile)
            self.after(1000, self.reduce_more_proceed_to_next_step)
    
    def reduce_more_show_confirmation_window(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE onay penceresi gÃ¶ster - KARBOTU ile birebir aynÄ± mantÄ±k"""
        # Bu fonksiyon KARBOTU'nun karbotu_show_confirmation_window ile birebir aynÄ±
        # Sadece panel adlarÄ± (take_profit_longs_panel_reducemore) ve log mesajlarÄ± deÄŸiÅŸir
        # Kod Ã§ok uzun olduÄŸu iÃ§in karbotu_show_confirmation_window'u kullanÄ±yoruz
        # Ancak panel adÄ±nÄ± deÄŸiÅŸtirmemiz gerekiyor
        try:
            # RUNALL Allowed modunda otomatik onay kontrolÃ¼
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[REDUCEMORE] âœ… Allowed modu aktif - Onay penceresi atlanÄ±yor, emirler direkt gÃ¶nderiliyor")
                self.log_message(f"âœ… Allowed modu: {step_name} - Emirler otomatik gÃ¶nderiliyor")
                # Emirleri direkt gÃ¶nder (onay penceresi aÃ§madan)
                self.reducemore_send_orders_direct(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[REDUCEMORE DEBUG] ğŸ”„ Onay penceresi fonksiyonu baÅŸladÄ±: {step_name}")
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"REDUCEMORE - {step_name}")
            confirm_win.geometry("600x400")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            # BaÅŸlÄ±k frame - minimize butonu ile
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            # Sol taraf - baÅŸlÄ±k bilgileri
            title_left = ttk.Frame(title_frame)
            title_left.pack(side='left', fill='x', expand=True)
            
            ttk.Label(title_left, text=f"REDUCEMORE - {step_name}", font=('Arial', 14, 'bold')).pack(anchor='w')
            ttk.Label(title_left, text=f"{order_type} - %{lot_percentage} Lot", font=('Arial', 12)).pack(anchor='w')
            ttk.Label(title_left, text=f"{len(positions)} pozisyon seÃ§ildi", font=('Arial', 10)).pack(anchor='w')
            
            # SaÄŸ taraf - minimize butonu
            window_controls = ttk.Frame(title_frame)
            window_controls.pack(side='right')
            
            # Alta Al (Minimize) butonu
            minimize_btn = ttk.Button(window_controls, text="ğŸ—• Alta Al", width=10,
                                      command=lambda: confirm_win.iconify())
            minimize_btn.pack(side='left', padx=2)
            
            # Pozisyon listesi
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Treeview
            columns = ('Symbol', 'Qty', 'Lot', 'Fbtot', 'Ask Sell PahalÄ±lÄ±k', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=10)
            
            # Kolon geniÅŸlikleri
            col_widths = {'Symbol': 80, 'Qty': 60, 'Lot': 60, 'Fbtot': 60, 'Ask Sell PahalÄ±lÄ±k': 100, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            # Scrollbar
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # âœ… FÄ°YAT VE LOT DEPOSU - pencereye Ã¶zel
            order_data = {}  # {symbol: {'price': emir_fiyat, 'lot': lot_qty}}
            
            # PozisyonlarÄ± ekle
            for pos in positions:
                # Pozisyon verilerini al
                item_values = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Quantity
                
                # Lot hesapla (%50, %75 veya %100)
                calculated_lot = qty * (lot_percentage / 100)
                
                # %100 lot iÃ§in yuvarlama YAPILMAZ - tam lot miktarÄ± kullanÄ±lÄ±r
                if lot_percentage == 100:
                    lot_qty = int(calculated_lot)
                # Lot yuvarlama mantÄ±ÄŸÄ± (%50 ve %75 iÃ§in)
                elif calculated_lot >= 0:
                    if calculated_lot <= 0:
                        lot_qty = 0
                    elif calculated_lot <= 100:
                        lot_qty = 100
                    elif calculated_lot <= 200:
                        lot_qty = 200
                    elif calculated_lot <= 300:
                        lot_qty = 300
                    elif calculated_lot <= 400:
                        lot_qty = 400
                    elif calculated_lot <= 500:
                        lot_qty = 500
                    elif calculated_lot <= 600:
                        lot_qty = 600
                    elif calculated_lot <= 700:
                        lot_qty = 700
                    elif calculated_lot <= 800:
                        lot_qty = 800
                    elif calculated_lot <= 900:
                        lot_qty = 900
                    elif calculated_lot <= 1000:
                        lot_qty = 1000
                    else:
                        lot_qty = int((calculated_lot + 99) // 100) * 100
                else:
                    abs_calculated = abs(calculated_lot)
                    if abs_calculated <= 100:
                        lot_qty = 100
                    elif abs_calculated <= 200:
                        lot_qty = 200
                    elif abs_calculated <= 300:
                        lot_qty = 300
                    elif abs_calculated <= 400:
                        lot_qty = -400
                    elif abs_calculated <= 500:
                        lot_qty = -500
                    elif abs_calculated <= 600:
                        lot_qty = -600
                    elif abs_calculated <= 700:
                        lot_qty = -700
                    elif abs_calculated <= 800:
                        lot_qty = -800
                    elif abs_calculated <= 900:
                        lot_qty = -900
                    elif abs_calculated <= 1000:
                        lot_qty = 1000
                    else:
                        lot_qty = int((abs_calculated + 99) // 100) * 100
                
                # Emir fiyatÄ±nÄ± hesapla (JFIN mantÄ±ÄŸÄ± - KARBOTU ile aynÄ±)
                emir_fiyat = 0
                market_data = None
                
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        emir_fiyat = 0
                        continue
                else:
                    emir_fiyat = 0
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                
                if order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        emir_fiyat = 0
                        continue
                else:
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        emir_fiyat = 0
                        continue
                
                pos_tree.insert('', 'end', values=(
                    pos['symbol'],
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['fbtot']:.2f}",
                    f"${pos['ask_sell_pahalilik']:.4f}",
                    f"${emir_fiyat:.2f}"
                ))
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Butonlar
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[REDUCEMORE] ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    self.log_message(f"ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if abs(lot_qty) < 200:
                            continue
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="SELL",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                )
                                if success:
                                    details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                            except Exception as e:
                                if "new order sent" in str(e).lower():
                                    details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                                else:
                                    self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "REDUCEMORE")
                                pass
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="SELL",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT",
                                hidden=True
                            )
                            if success:
                                details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay"
                                reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                    
                    print(f"[REDUCEMORE] âœ… {step_name} emirleri gÃ¶nderildi")
                    self.log_message(f"âœ… {step_name} emirleri gÃ¶nderildi")
                    
                except Exception as e:
                    print(f"[REDUCEMORE] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    self.log_message(f"âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                
                confirm_win.destroy()
                self.reduce_more_proceed_to_next_step()
            
            def on_cancel():
                print(f"[REDUCEMORE] âŒ {step_name} iptal edildi")
                self.log_message(f"âŒ {step_name} iptal edildi")
                confirm_win.destroy()
                self.reduce_more_proceed_to_next_step()
            
            def save_to_trades_csv():
                """SeÃ§ili emirleri trades.csv formatÄ±nda kaydet"""
                try:
                    print(f"[REDUCEMORE CSV] ğŸ”„ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    self.log_message(f"ğŸ”„ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    
                    # CSV satÄ±rlarÄ±
                    csv_rows = []
                    
                    # PENCERE'DEKÄ° tablodan verileri al (zaten hesaplanmÄ±ÅŸ fiyatlar var)
                    for item in pos_tree.get_children():
                        values = pos_tree.item(item)['values']
                        symbol = values[0]
                        qty = float(values[1])
                        lot_qty = float(values[2])
                        
                        # Emir fiyatÄ±nÄ± PENCERE'DEKÄ° DEÄERDEN al (zaten hesaplanmÄ±ÅŸ)
                        emir_fiyat_str = values[5]  # "Emir Fiyat" kolonu
                        try:
                            # $ iÅŸaretini ve format karakterlerini temizle
                            emir_fiyat = float(str(emir_fiyat_str).replace('$', '').replace(',', '').strip())
                            print(f"[REDUCEMORE CSV] âœ… {symbol}: Emir fiyatÄ± pencereden alÄ±ndÄ±: ${emir_fiyat:.2f}")
                        except (ValueError, TypeError, IndexError):
                            print(f"[REDUCEMORE CSV] âŒ {symbol}: Emir fiyatÄ± okunamadÄ±: {emir_fiyat_str}")
                            emir_fiyat = 0
                            continue
                        
                        # Lot ve fiyat ZATEN PENCREDEN ALINDI - market data Ã§ekmeye GEREK YOK!
                        # Minimum lot kontrolÃ¼
                        if abs(lot_qty) < 200:
                            continue
                        
                        # CSV'ye kaydet (fiyat ve lot zaten hazÄ±r)
                        if emir_fiyat > 0:
                            # CSV formatÄ± (orijinal format)
                            csv_row = [
                                'SELL',                    # Action
                                int(lot_qty),             # Quantity
                                symbol,                    # Symbol
                                'STK',                    # SecType
                                'SMART/AMEX',              # Exchange
                                'USD',                    # Currency
                                'DAY',                    # TimeInForce
                                'LMT',                    # OrderType
                                f"{emir_fiyat:.2f}",      # LmtPrice
                                'Basket',                 # BasketTag
                                'U21016730',              # Account
                                'Basket',                 # OrderRef
                                'TRUE',                   # Hidden
                                'TRUE'                    # OutsideRth
                            ]
                            
                            csv_rows.append(csv_row)
                            print(f"[REDUCEMORE CSV] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    if csv_rows:
                        # CSV dosyasÄ±na kaydet
                        import csv
                        
                        csv_filename = 'trades.csv'
                        
                        # DosyayÄ± sÄ±fÄ±rdan yaz (write mode)
                        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                            writer = csv.writer(csvfile)
                            
                            # BaÅŸlÄ±k satÄ±rÄ± (orijinal format)
                            writer.writerow(['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 'OrderRef', 'Hidden', 'OutsideRth'])
                            
                            # Emir satÄ±rlarÄ±
                            writer.writerows(csv_rows)
                        
                        print(f"[REDUCEMORE CSV] âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        self.log_message(f"âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                    else:
                        messagebox.showwarning("UyarÄ±", "Kaydedilecek geÃ§erli emir bulunamadÄ±!")
                        
                except Exception as e:
                    print(f"[REDUCEMORE CSV] âŒ Kaydetme hatasÄ±: {e}")
                    self.log_message(f"âŒ Kaydetme hatasÄ±: {e}")
                    messagebox.showerror("Hata", f"trades.csv kaydetme hatasÄ±: {e}")
            
            ttk.Button(button_frame, text="Emirleri GÃ¶nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[REDUCEMORE] âŒ Onay penceresi hatasÄ±: {e}")
            self.log_message(f"âŒ Onay penceresi hatasÄ±: {e}")
    
    def reduce_more_select_shorts_positions_and_confirm(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE: Shorts pozisyonlarÄ± seÃ§ ve onay penceresi aÃ§"""
        try:
            for pos in positions:
                self.take_profit_shorts_panel_reducemore.tree.set(pos['item'], "select", "âœ“")
                
                avg_cost_str = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_shorts_panel_reducemore.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Lot yÃ¼zdesini ayarla
            if lot_percentage == 25:
                self.take_profit_shorts_panel_reducemore.set_lot_percentage(25)
            elif lot_percentage == 50:
                self.take_profit_shorts_panel_reducemore.set_lot_percentage(50)
            elif lot_percentage == 75:
                self.take_profit_shorts_panel_reducemore.set_lot_percentage(75)
            elif lot_percentage == 100:
                self.take_profit_shorts_panel_reducemore.set_lot_percentage(100)
            
            self.reduce_more_show_shorts_confirmation_window(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[REDUCEMORE] âŒ Shorts pozisyon seÃ§imi hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE Shorts pozisyon seÃ§imi hatasÄ±: {e}")
    
    def reduce_more_show_shorts_confirmation_window(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Shorts onay penceresi gÃ¶ster - KARBOTU ile birebir aynÄ± mantÄ±k"""
        try:
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"REDUCEMORE - {step_name}")
            confirm_win.geometry("600x400")
            # transient ve grab_set kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"REDUCEMORE - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - %{lot_percentage} Lot", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon seÃ§ildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Qty', 'Lot', 'SFStot', 'Bid Buy Ucuzluk', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=10)
            
            col_widths = {'Symbol': 80, 'Qty': 60, 'Lot': 60, 'SFStot': 60, 'Bid Buy Ucuzluk': 100, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values']
                qty = float(item_values[2])  # Negatif gelebilir (-276 gibi)
                
                # Short pozisyonlar iÃ§in ABS deÄŸer ile hesapla
                abs_qty = abs(qty)  # -276 -> 276
                calculated_lot = abs_qty * (lot_percentage / 100)  # 276 * 0.75 = 207
                
                # %100 lot iÃ§in yuvarlama YAPILMAZ - tam lot miktarÄ± kullanÄ±lÄ±r
                if lot_percentage == 100:
                    lot_qty = int(calculated_lot)  # 276 (pozitif)
                # Lot yuvarlama (%50 ve %75 iÃ§in) - pozitif deÄŸer ile yuvarlama yap
                elif calculated_lot > 0:
                    if calculated_lot <= 0:
                        lot_qty = 0
                    elif calculated_lot <= 100:
                        lot_qty = 100
                    elif calculated_lot <= 200:
                        lot_qty = 200
                    elif calculated_lot <= 300:
                        lot_qty = 300
                    elif calculated_lot <= 400:
                        lot_qty = 400
                    elif calculated_lot <= 500:
                        lot_qty = 500
                    elif calculated_lot <= 600:
                        lot_qty = 600
                    elif calculated_lot <= 700:
                        lot_qty = 700
                    elif calculated_lot <= 800:
                        lot_qty = 800
                    elif calculated_lot <= 900:
                        lot_qty = 900
                    elif calculated_lot <= 1000:
                        lot_qty = 1000
                    else:
                        lot_qty = int((calculated_lot + 99) // 100) * 100
                else:
                    lot_qty = 0
                
                # Lot her zaman pozitif olmalÄ± (BUY emri iÃ§in short pozisyonu kapatmak iÃ§in)
                # qty negatif olsa bile (short pozisyon), lot pozitif hesaplanÄ±r
                
                symbol = pos['symbol']
                emir_fiyat = 0
                market_data = None
                
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        continue
                else:
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                
                if order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                else:
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                
                pos_tree.insert('', 'end', values=(
                    pos['symbol'],
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['sfstot']:.2f}",
                    f"${pos['bid_buy_ucuzluk']:.4f}",
                    f"${emir_fiyat:.2f}"
                ))
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[REDUCEMORE] ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    self.log_message(f"ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if abs(lot_qty) < 200:
                            continue
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="BUY",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                )
                                if success:
                                    details_msg = f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Shorts)"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                            except Exception as e:
                                if "new order sent" in str(e).lower():
                                    details_msg = f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Shorts)"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                                else:
                                    self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "REDUCEMORE")
                                pass
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="BUY",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT",
                                hidden=True
                            )
                            if success:
                                details_msg = f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Shorts)"
                                reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                    
                    print(f"[REDUCEMORE] âœ… {step_name} emirleri gÃ¶nderildi")
                    self.log_message(f"âœ… {step_name} emirleri gÃ¶nderildi")
                    
                except Exception as e:
                    print(f"[REDUCEMORE] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    self.log_message(f"âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                
                confirm_win.destroy()
                self.reduce_more_proceed_to_next_step()
            
            def on_cancel():
                print(f"[REDUCEMORE] âŒ {step_name} iptal edildi")
                self.log_message(f"âŒ {step_name} iptal edildi")
                confirm_win.destroy()
                self.reduce_more_proceed_to_next_step()
            
            def save_to_trades_csv():
                """SeÃ§ili emirleri trades.csv formatÄ±nda kaydet - SHORTS iÃ§in BUY"""
                try:
                    print(f"[REDUCEMORE CSV SHORTS] ğŸ”„ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    self.log_message(f"ğŸ”„ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    
                    # CSV satÄ±rlarÄ±
                    csv_rows = []
                    
                    # PENCERE'DEKÄ° tablodan verileri al (zaten hesaplanmÄ±ÅŸ fiyatlar var)
                    for item in pos_tree.get_children():
                        values = pos_tree.item(item)['values']
                        symbol = values[0]
                        qty = float(values[1])
                        lot_qty = float(values[2])
                        
                        # Emir fiyatÄ±nÄ± PENCERE'DEKÄ° DEÄERDEN al (zaten hesaplanmÄ±ÅŸ)
                        emir_fiyat_str = values[5]  # "Emir Fiyat" kolonu
                        try:
                            # $ iÅŸaretini ve format karakterlerini temizle
                            emir_fiyat = float(str(emir_fiyat_str).replace('$', '').replace(',', '').strip())
                            print(f"[REDUCEMORE CSV SHORTS] âœ… {symbol}: Emir fiyatÄ± pencereden alÄ±ndÄ±: ${emir_fiyat:.2f}")
                        except (ValueError, TypeError, IndexError):
                            print(f"[REDUCEMORE CSV SHORTS] âŒ {symbol}: Emir fiyatÄ± okunamadÄ±: {emir_fiyat_str}")
                            emir_fiyat = 0
                            continue
                        
                        # Lot ve fiyat ZATEN PENCREDEN ALINDI - market data Ã§ekmeye GEREK YOK!
                        # Minimum lot kontrolÃ¼
                        if abs(lot_qty) < 200:
                            continue
                        
                        # CSV'ye kaydet (fiyat ve lot zaten hazÄ±r) - SHORTS iÃ§in BUY
                        if emir_fiyat > 0:
                            # CSV formatÄ± (orijinal format) - Short pozisyon iÃ§in BUY
                            csv_row = [
                                'BUY',                     # Action (short pozisyonu kapatmak iÃ§in BUY)
                                int(lot_qty),             # Quantity
                                symbol,                    # Symbol
                                'STK',                    # SecType
                                'SMART/AMEX',              # Exchange
                                'USD',                    # Currency
                                'DAY',                    # TimeInForce
                                'LMT',                    # OrderType
                                f"{emir_fiyat:.2f}",      # LmtPrice
                                'Basket',                 # BasketTag
                                'U21016730',              # Account
                                'Basket',                 # OrderRef
                                'TRUE',                   # Hidden
                                'TRUE'                    # OutsideRth
                            ]
                            
                            csv_rows.append(csv_row)
                            print(f"[REDUCEMORE CSV SHORTS] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    if csv_rows:
                        # CSV dosyasÄ±na kaydet
                        import csv
                        
                        csv_filename = 'trades.csv'
                        
                        # DosyayÄ± sÄ±fÄ±rdan yaz (write mode)
                        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                            writer = csv.writer(csvfile)
                            
                            # BaÅŸlÄ±k satÄ±rÄ± (orijinal format)
                            writer.writerow(['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 'OrderRef', 'Hidden', 'OutsideRth'])
                            
                            # Emir satÄ±rlarÄ±
                            writer.writerows(csv_rows)
                        
                        print(f"[REDUCEMORE CSV SHORTS] âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        self.log_message(f"âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                    else:
                        messagebox.showwarning("UyarÄ±", "Kaydedilecek geÃ§erli emir bulunamadÄ±!")
                        
                except Exception as e:
                    print(f"[REDUCEMORE CSV SHORTS] âŒ Kaydetme hatasÄ±: {e}")
                    self.log_message(f"âŒ Kaydetme hatasÄ±: {e}")
                    messagebox.showerror("Hata", f"trades.csv kaydetme hatasÄ±: {e}")
            
            ttk.Button(button_frame, text="Emirleri GÃ¶nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[REDUCEMORE] âŒ Shorts onay penceresi hatasÄ±: {e}")
            self.log_message(f"âŒ Shorts onay penceresi hatasÄ±: {e}")
    
    def reduce_more_proceed_to_next_step(self):
        """REDUCEMORE: Sonraki adÄ±ma geÃ§"""
        try:
            if self.reducemore_current_step >= self.reducemore_total_steps:
                print("[REDUCEMORE] ğŸ¯ TÃ¼m adÄ±mlar tamamlandÄ±!")
                self.log_message("ğŸ¯ REDUCEMORE otomasyonu tamamlandÄ±!")
                self.reducemore_running = False
                
                # RUNALL'dan Ã§aÄŸrÄ±ldÄ±ysa ADDNEWPOS kontrolÃ¼ yap (SADECE BÄ°R KEZ)
                if hasattr(self, 'runall_waiting_for_reducemore') and self.runall_waiting_for_reducemore:
                    if not hasattr(self, 'runall_addnewpos_triggered') or not self.runall_addnewpos_triggered:
                        self.runall_waiting_for_reducemore = False
                        self.runall_addnewpos_triggered = True  # Ä°ÅŸaretle ki tekrar tetiklenmesin
                        # Thread-safe UI Ã§aÄŸrÄ±sÄ± - bot iÅŸlemleri normal Ã¶ncelikli queue'ya gider (kullanÄ±cÄ± etkileÅŸimlerini bloklamaz)
                        print("[REDUCEMORE] â³ ADDNEWPOS kontrolÃ¼ 200ms sonra yapÄ±lacak...")
                        self.safe_ui_call(lambda: self.after(200, self.runall_check_karbotu_and_addnewpos))
                
                return
            
            next_step = self.reducemore_current_step + 1
            
            step_methods = {
                2: self.reduce_more_step_2_fbtot_lt_110,
                3: self.reduce_more_step_3_fbtot_111_145_low,
                4: self.reduce_more_step_4_fbtot_111_145_high,
                5: self.reduce_more_step_5_fbtot_146_185_low,
                6: self.reduce_more_step_6_fbtot_146_185_high,
                7: self.reduce_more_step_7_fbtot_186_210,
                8: self.reduce_more_step_8_open_take_profit_shorts,
                9: self.reduce_more_step_9_sfstot_170_high,
                10: self.reduce_more_step_10_sfstot_140_169_low,
                11: self.reduce_more_step_11_sfstot_140_169_high,
                12: self.reduce_more_step_12_sfstot_110_139_low,
                13: self.reduce_more_step_13_sfstot_110_139_high
            }
            
            if next_step in step_methods:
                self.reducemore_current_step = next_step
                step_methods[next_step]()
            else:
                print(f"[REDUCEMORE] âš ï¸ AdÄ±m {next_step} henÃ¼z implement edilmedi")
                self.log_message(f"âš ï¸ AdÄ±m {next_step} henÃ¼z implement edilmedi")
                
        except Exception as e:
            print(f"[REDUCEMORE] âŒ Sonraki adÄ±m hatasÄ±: {e}")
            self.log_message(f"âŒ Sonraki adÄ±m hatasÄ±: {e}")
    
    def karbotu_select_positions_and_confirm(self, positions, order_type, lot_percentage, step_name):
        """PozisyonlarÄ± seÃ§ ve onay penceresi aÃ§ (veya Allowed modunda direkt gÃ¶nder)"""
        try:
            # ALLOWED MODU KONTROLÃœ - EÄŸer aktifse direkt emir gÃ¶nder, onay penceresi aÃ§ma!
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU] âœ… Allowed modu aktif - Onay penceresi atlanÄ±yor, emirler direkt gÃ¶nderiliyor")
                self.log_message(f"âœ… Allowed modu: {step_name} - Emirler otomatik gÃ¶nderiliyor")
                # Emirleri direkt gÃ¶nder (onay penceresi aÃ§madan)
                self.karbotu_send_orders_direct(positions, order_type, lot_percentage, step_name)
                return
            
            # PozisyonlarÄ± seÃ§
            for pos in positions:
                self.take_profit_longs_panel.tree.set(pos['item'], "select", "âœ“")
                
                # Avg cost'u gÃ¼venli ÅŸekilde parse et
                avg_cost_str = self.take_profit_longs_panel.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_longs_panel.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_longs_panel.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Lot yÃ¼zdesini ayarla
            if lot_percentage == 25:
                self.take_profit_longs_panel.set_lot_percentage(25)
            elif lot_percentage == 50:
                self.take_profit_longs_panel.set_lot_percentage(50)
            
            # Onay penceresini aÃ§
            print(f"[KARBOTU DEBUG] ğŸ”„ Onay penceresi aÃ§Ä±lÄ±yor: {step_name}")
            self.karbotu_show_confirmation_window(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[KARBOTU] âŒ Pozisyon seÃ§imi hatasÄ±: {e}")
            self.log_message(f"âŒ Pozisyon seÃ§imi hatasÄ±: {e}")
    
    def karbotu_send_orders_direct(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU emirlerini direkt gÃ¶nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[KARBOTU] ğŸ”„ {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            self.log_message(f"ğŸ”„ {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            
            # Pozisyon verilerini hazÄ±rla
            order_data = {}
            processed_count = 0
            
            for pos in positions:
                item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])
                
                # Her 5 sembol iÅŸlendikten sonra UI'Ä± gÃ¼ncelle (bloklamadan)
                processed_count += 1
                if processed_count % 5 == 0:
                    self.psfalgo_window.update_idletasks()
                    # Pencereyi Ã¶ne getirme kontrolÃ¼
                    if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                        try:
                            if self.psfalgo_window.winfo_exists():
                                self.psfalgo_window.lift()
                        except:
                            pass
                
                # Lot hesapla
                calculated_lot = qty * (lot_percentage / 100)
                
                # 200 lot altÄ± pozisyonlar iÃ§in tamamÄ±nÄ± gÃ¶nder
                abs_qty = abs(qty)
                if abs_qty < 200:
                    # Eldeki lot < 200 ise tamamÄ±nÄ± gÃ¶nder
                    lot_qty = int(abs_qty) if qty >= 0 else -int(abs_qty)
                else:
                    # Lot yuvarlama
                    if calculated_lot >= 0:
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                
                # YENÄ° KURAL SÄ°STEMÄ°: REDUCE limitleri (BefQty/PortfÃ¶y oranÄ±na gÃ¶re)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                
                # GÃ¼nlÃ¼k reduce limitini hesapla
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                # Mevcut pozisyon ve aÃ§Ä±k emirler
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                
                # GÃ¼nlÃ¼k deÄŸiÅŸim (mutlak deÄŸer)
                current_daily_change = abs(current_potential - befday_qty)
                
                # Kalan gÃ¼nlÃ¼k hak
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                # Emir miktarÄ±nÄ± kontrol et ve gerekirse ayarla
                if lot_qty > remaining_allowance and not is_unlimited:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[KARBOTU] âš ï¸ {symbol}: GÃ¼nlÃ¼k limit doldu ({current_daily_change:.0f}/{daily_limit:.0f}), emir atlandÄ±")
                        self.log_message(f"âš ï¸ {symbol}: GÃ¼nlÃ¼k REDUCE limit doldu, emir atlandÄ±")
                        details_msg = f"{symbol} GÃ¼nlÃ¼k Limit Doldu | Limit:{daily_limit:.0f} Used:{current_daily_change:.0f} Rem:{remaining_allowance:.0f}"
                        # DetaylÄ± blok logu
                        pos_data = self.psfalgo_positions.get(symbol, {})
                        fbtot = pos_data.get('fbtot', None)
                        sfstot = pos_data.get('sfstot', None)
                        pahalilik = pos_data.get('ask_sell_pahalilik', None)
                        ucuzluk = pos_data.get('bid_buy_ucuzluk', None)
                        
                        self.log_psfalgo_activity(
                            action="EMIR_BLOKE",
                            details=details_msg,
                            status="BLOCKED",
                            reason="Daily Limit",
                            category="KARBOTU",
                            symbol=symbol,
                            step_name=step_name,
                            fbtot=fbtot,
                            sfstot=sfstot,
                            pahalilik=pahalilik,
                            ucuzluk=ucuzluk,
                            maxalw=maxalw,
                            lot_percentage=lot_percentage,
                            calculated_lot=calculated_lot if 'calculated_lot' in locals() else None,
                            daily_limit=daily_limit,
                            current_daily_change=current_daily_change,
                            remaining_allowance=remaining_allowance,
                            conditions_failed=[f"GÃ¼nlÃ¼k limit doldu: {current_daily_change:.0f} >= {daily_limit:.0f}"]
                        )
                        continue
                    else:
                        # Lot miktarÄ±nÄ± ayarla
                        lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                        print(f"[KARBOTU] ğŸ“Š {symbol}: Emir miktarÄ± ayarlandÄ± â†’ {lot_qty} lot ({limit_reason})")
                
                # Ters pozisyona geÃ§iÅŸ kontrolÃ¼ (sÄ±nÄ±rsÄ±z bile olsa)
                if order_type == "Ask Sell":
                    new_potential = current_potential - lot_qty
                else:
                    new_potential = current_potential + lot_qty
                
                # Long iken short'a veya short iken long'a geÃ§iÅŸi engelle
                if befday_qty > 0 and new_potential < 0:
                    lot_qty = int(current_potential)  # 0'a getir
                    print(f"[KARBOTU] âš ï¸ {symbol}: Ters poz. yasak, lot ayarlandÄ± â†’ {lot_qty}")
                elif befday_qty < 0 and new_potential > 0:
                    lot_qty = int(abs(current_potential))  # 0'a getir
                    print(f"[KARBOTU] âš ï¸ {symbol}: Ters poz. yasak, lot ayarlandÄ± â†’ {lot_qty}")
                
                # Emir fiyatÄ±nÄ± hesapla - timeout ile
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    try:
                        # UI thread'ini bloklamadan market data al
                        market_data = self.hammer.get_market_data(symbol)
                        # UI'Ä± gÃ¼ncelle
                        if processed_count % 3 == 0:
                            self.psfalgo_window.update_idletasks()
                    except Exception as e:
                        print(f"[KARBOTU] âš ï¸ {symbol} market_data hatasÄ±: {e}")
                        market_data = None
                
                if not market_data:
                    print(f"[KARBOTU] âŒ {symbol} market_data bulunamadÄ±, atlandÄ±")
                    # UI thread'ini bloklamadan devam et
                    self.psfalgo_window.update_idletasks()
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                emir_fiyat = 0
                if order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        continue
                elif order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                elif order_type == "Front Sell":
                    if last > 0:
                        emir_fiyat = last - 0.01
                    else:
                        continue
                elif order_type == "Front Buy":
                    if last > 0:
                        emir_fiyat = last + 0.01
                    else:
                        continue
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri gÃ¶nder
            success_count = 0
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if abs(lot_qty) < 200:
                    continue
                
                # Controller kontrolÃ¼ (MAXALW limitleri dahil)
                # KARBOTU pozisyon AZALTMA yapÄ±yor - toplam pozisyon limiti kontrolÃ¼ YAPILMAZ
                if hasattr(self, 'controller_enabled') and self.controller_enabled:
                    order_side = "SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY"
                    allowed, adjusted_qty, reason = self.controller_check_order(symbol, order_side, abs(lot_qty), is_reduce_order=True)
                    
                    if not allowed or adjusted_qty == 0:
                        print(f"[KARBOTU] âš ï¸ {symbol}: Controller engelledi - {reason}")
                        self.log_message(f"âš ï¸ {symbol}: Controller engelledi - {reason}")
                        
                        # DetaylÄ± blok logu
                        pos_data = self.psfalgo_positions.get(symbol, {})
                        fbtot = pos_data.get('fbtot', None)
                        sfstot = pos_data.get('sfstot', None)
                        pahalilik = pos_data.get('ask_sell_pahalilik', None)
                        ucuzluk = pos_data.get('bid_buy_ucuzluk', None)
                        
                        self.log_psfalgo_activity(
                            action="EMIR_BLOKE",
                            details=f"{symbol} {reason}",
                            status="BLOCKED",
                            reason=reason,
                            category="KARBOTU",
                            symbol=symbol,
                            step_name=step_name,
                            fbtot=fbtot,
                            sfstot=sfstot,
                            pahalilik=pahalilik,
                            ucuzluk=ucuzluk,
                            maxalw=maxalw,
                            lot_percentage=lot_percentage,
                            calculated_lot=calculated_lot if 'calculated_lot' in locals() else None,
                            daily_limit=daily_limit,
                            current_daily_change=current_daily_change,
                            remaining_allowance=remaining_allowance,
                            controller_result=f"Allowed: {allowed}, Adjusted: {adjusted_qty}",
                            conditions_failed=[f"Controller engelledi: {reason}"]
                        )
                        continue
                    
                    lot_qty = adjusted_qty if order_side == "SELL" else adjusted_qty
                
                # Emir gÃ¶nder
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success or "new order sent" in str(success):
                            success_count += 1
                            print(f"[KARBOTU] âœ… {symbol}: {order_type} {lot_qty} lot @ ${emir_fiyat:.2f}")
                            # DetaylÄ± log - Neden bu emir gÃ¶nderildi?
                            reasoning = f"{step_name} | Lot: {lot_qty} ({lot_percentage}% of {abs(qty)}) | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                            
                            # Pozisyon bilgilerini al
                            pos_data = self.psfalgo_positions.get(symbol, {})
                            fbtot = pos_data.get('fbtot', None)
                            sfstot = pos_data.get('sfstot', None)
                            pahalilik = pos_data.get('ask_sell_pahalilik', None)
                            ucuzluk = pos_data.get('bid_buy_ucuzluk', None)
                            
                            self.log_psfalgo_activity(
                                action="EMIR_ILETILDI",
                                details=f"{symbol} {order_type} {lot_qty} @ ${emir_fiyat:.2f}",
                                status="SUCCESS",
                                reason=reasoning,
                                category="KARBOTU",
                                symbol=symbol,
                                step_name=step_name,
                                fbtot=fbtot,
                                sfstot=sfstot,
                                pahalilik=pahalilik,
                                ucuzluk=ucuzluk,
                                maxalw=maxalw,
                                lot_percentage=lot_percentage,
                                calculated_lot=calculated_lot if 'calculated_lot' in locals() else None,
                                daily_limit=daily_limit,
                                current_daily_change=current_daily_change,
                                remaining_allowance=remaining_allowance,
                                controller_result=f"Allowed: {allowed}, Adjusted: {adjusted_qty}" if 'allowed' in locals() else None,
                                min_lot_check=f"{abs(lot_qty)} >= 200: OK" if abs(lot_qty) >= 200 else f"{abs(lot_qty)} < 200: FAILED"
                            )
                    except Exception as e:
                        if "new order sent" in str(e).lower():
                            success_count += 1
                        else:
                            print(f"[KARBOTU] âŒ {symbol}: {e}")
                            self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "KARBOTU")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT",
                        hidden=True
                    )
                    if success:
                        success_count += 1
                        print(f"[KARBOTU] âœ… {symbol}: {order_type} {lot_qty} lot @ ${emir_fiyat:.2f}")
                        # DetaylÄ± log - Neden bu emir gÃ¶nderildi?
                        reasoning = f"{step_name} | Lot: {lot_qty} ({lot_percentage}% of {abs(qty)}) | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                        
                        # Pozisyon bilgilerini al
                        pos_data = self.psfalgo_positions.get(symbol, {})
                        fbtot = pos_data.get('fbtot', None)
                        sfstot = pos_data.get('sfstot', None)
                        pahalilik = pos_data.get('ask_sell_pahalilik', None)
                        ucuzluk = pos_data.get('bid_buy_ucuzluk', None)
                        
                        self.log_psfalgo_activity(
                            action="EMIR_ILETILDI",
                            details=f"{symbol} {order_type} {lot_qty} @ ${emir_fiyat:.2f}",
                            status="SUCCESS",
                            reason=reasoning,
                            category="KARBOTU",
                            symbol=symbol,
                            step_name=step_name,
                            fbtot=fbtot,
                            sfstot=sfstot,
                            pahalilik=pahalilik,
                            ucuzluk=ucuzluk,
                            maxalw=maxalw,
                            lot_percentage=lot_percentage,
                            calculated_lot=calculated_lot if 'calculated_lot' in locals() else None,
                            daily_limit=daily_limit,
                            current_daily_change=current_daily_change,
                            remaining_allowance=remaining_allowance,
                            controller_result=f"Allowed: {allowed}, Adjusted: {adjusted_qty}" if 'allowed' in locals() else None,
                            min_lot_check=f"{abs(lot_qty)} >= 200: OK" if abs(lot_qty) >= 200 else f"{abs(lot_qty)} < 200: FAILED"
                        )
            
            print(f"[KARBOTU] âœ… {step_name} tamamlandÄ±: {success_count} emir gÃ¶nderildi")
            self.log_message(f"âœ… {step_name} tamamlandÄ±: {success_count} emir gÃ¶nderildi")
            
            # UI'Ä± gÃ¼ncelle ve pencereyi Ã¶ne getir
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        self.psfalgo_window.lift()
                        self.psfalgo_window.update_idletasks()
                except:
                    pass
            
            # Sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile - adÄ±mlar sÄ±ralÄ± ilerlesin)
            self.after(500, self.karbotu_proceed_to_next_step)  # 1000'den 500'e dÃ¼ÅŸÃ¼rÃ¼ldÃ¼
            
        except Exception as e:
            print(f"[KARBOTU] âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            self.log_message(f"âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile)
            # UI'Ä± gÃ¼ncelle
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        self.psfalgo_window.lift()
                        self.psfalgo_window.update_idletasks()
                except:
                    pass
            self.after(500, self.karbotu_proceed_to_next_step)  # 1000'den 500'e dÃ¼ÅŸÃ¼rÃ¼ldÃ¼
    
    def karbotu_gort_select_and_send_longs(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort: Longs pozisyonlarÄ± seÃ§ ve Ã¶zel lot hesaplama ile emir gÃ¶nder"""
        try:
            # PozisyonlarÄ± seÃ§
            for pos in positions:
                self.take_profit_longs_panel.tree.set(pos['item'], "select", "âœ“")
                
                # Avg cost'u gÃ¼venli ÅŸekilde parse et
                avg_cost_str = self.take_profit_longs_panel.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_longs_panel.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_longs_panel.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Ã–zel lot hesaplama ile onay penceresi aÃ§
            self.karbotu_gort_show_confirmation_window_longs(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[KARBOTU GORT] âŒ Pozisyon seÃ§imi hatasÄ±: {e}")
            self.log_message(f"âŒ KARBOTU Gort pozisyon seÃ§imi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def karbotu_gort_select_and_send_shorts(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort: Shorts pozisyonlarÄ± seÃ§ ve Ã¶zel lot hesaplama ile emir gÃ¶nder"""
        try:
            # PozisyonlarÄ± seÃ§
            for pos in positions:
                self.take_profit_shorts_panel.tree.set(pos['item'], "select", "âœ“")
                
                # Avg cost'u gÃ¼venli ÅŸekilde parse et
                avg_cost_str = self.take_profit_shorts_panel.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_shorts_panel.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_shorts_panel.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Ã–zel lot hesaplama ile onay penceresi aÃ§
            self.karbotu_gort_show_confirmation_window_shorts(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[KARBOTU GORT] âŒ Pozisyon seÃ§imi hatasÄ±: {e}")
            self.log_message(f"âŒ KARBOTU Gort pozisyon seÃ§imi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reducemore_gort_send_orders_direct_longs(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Longs iÃ§in direkt emir gÃ¶nderme (Allowed modu iÃ§in)"""
        try:
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (pozitif)
                
                # Ã–zel lot hesaplama: %20 ama min 200 lot, eÄŸer eldeki lot < 200 ise eldeki lotun tamamÄ±
                calculated_lot = qty * (lot_percentage / 100)  # %20 hesapla
                
                if qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamÄ±
                    lot_qty = int(qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %20 hesaplanan deÄŸer 200'den kÃ¼Ã§Ã¼kse â†’ 200 lot (min 200 kuralÄ±)
                        lot_qty = 200
                    else:
                        # %20 hesaplanan deÄŸer 200'den bÃ¼yÃ¼k veya eÅŸitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrolÃ¼ (yuvarlama sonrasÄ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # YENÄ° KURAL SÄ°STEMÄ°: REDUCE limitleri
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                current_daily_change = abs(current_potential - befday_qty)
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                if not is_unlimited and lot_qty > remaining_allowance:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[REDUCEMORE GORT] âš ï¸ {symbol}: GÃ¼nlÃ¼k limit doldu, emir atlandÄ±")
                        details_msg = f"{symbol} GÃ¼nlÃ¼k Limit Doldu | Limit:{daily_limit:.0f} Used:{current_daily_change:.0f} Rem:{remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_BLOKE", details_msg, "BLOCKED", "Daily Limit", "REDUCEMORE")
                        continue
                    lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                    print(f"[REDUCEMORE GORT] ğŸ“Š {symbol}: Emir miktarÄ± ayarlandÄ± â†’ {lot_qty} lot")
                
                # Ters pozisyona geÃ§iÅŸ kontrolÃ¼
                new_potential = current_potential - lot_qty
                if befday_qty > 0 and new_potential < 0:
                    lot_qty = int(current_potential)
                    print(f"[REDUCEMORE GORT] âš ï¸ {symbol}: Ters poz. yasak, lot ayarlandÄ± â†’ {lot_qty}")
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)  # Ask Sell
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri gÃ¶nder
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="SELL",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success:
                            print(f"[REDUCEMORE GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                            self.log_message(f"âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                            details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f}"
                            reasoning = f"{step_name} (Gort) | Lot: {lot_qty} | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                            self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                    except Exception as e:
                        print(f"[REDUCEMORE GORT] âŒ {symbol} emir hatasÄ±: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="SELL",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT"
                    )
                    if success:
                        print(f"[REDUCEMORE GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                        self.log_message(f"âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                        details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f}"
                        reasoning = f"{step_name} (Gort) | Lot: {lot_qty} | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
            
            print(f"[REDUCEMORE GORT] âœ… {len(order_data)} emir gÃ¶nderildi")
            self.log_message(f"âœ… REDUCEMORE Gort {step_name}: {len(order_data)} emir gÃ¶nderildi")
            
            # Sonraki adÄ±ma geÃ§ (Gort kontrolÃ¼ bitince sonraki adÄ±ma geÃ§ilecek)
            self.after(500, self.reduce_more_proceed_to_next_step)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE Gort direkt emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§
            self.after(500, self.reduce_more_proceed_to_next_step)
    
    def reducemore_gort_select_and_send_longs(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Longs pozisyonlarÄ± seÃ§ ve Ã¶zel lot hesaplama ile emir gÃ¶nder"""
        try:
            # PozisyonlarÄ± seÃ§
            for pos in positions:
                self.take_profit_longs_panel_reducemore.tree.set(pos['item'], "select", "âœ“")
                
                # Avg cost'u gÃ¼venli ÅŸekilde parse et
                avg_cost_str = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_longs_panel_reducemore.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Ã–zel lot hesaplama ile onay penceresi aÃ§
            self.reducemore_gort_show_confirmation_window_longs(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] âŒ Pozisyon seÃ§imi hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE Gort pozisyon seÃ§imi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reducemore_gort_select_and_send_shorts(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Shorts pozisyonlarÄ± seÃ§ ve Ã¶zel lot hesaplama ile emir gÃ¶nder"""
        try:
            # PozisyonlarÄ± seÃ§
            for pos in positions:
                self.take_profit_shorts_panel_reducemore.tree.set(pos['item'], "select", "âœ“")
                
                # Avg cost'u gÃ¼venli ÅŸekilde parse et
                avg_cost_str = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_shorts_panel_reducemore.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Ã–zel lot hesaplama ile onay penceresi aÃ§
            self.reducemore_gort_show_confirmation_window_shorts(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] âŒ Pozisyon seÃ§imi hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE Gort pozisyon seÃ§imi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def karbotu_show_confirmation_window(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU onay penceresi gÃ¶ster"""
        try:
            print(f"[KARBOTU DEBUG] ğŸ”„ Onay penceresi fonksiyonu baÅŸladÄ±: {step_name}")
            
            # RUNALL Allowed modunda otomatik onay kontrolÃ¼
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU] âœ… Allowed modu aktif - Onay penceresi atlanÄ±yor, emirler direkt gÃ¶nderiliyor")
                self.log_message(f"âœ… Allowed modu: {step_name} - Emirler otomatik gÃ¶nderiliyor")
                # Emirleri direkt gÃ¶nder (onay penceresi aÃ§madan)
                self.karbotu_send_orders_direct(positions, order_type, lot_percentage, step_name)
                return
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"KARBOTU - {step_name}")
            confirm_win.geometry("600x400")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            # BaÅŸlÄ±k frame - minimize butonu ile
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            # Sol taraf - baÅŸlÄ±k bilgileri
            title_left = ttk.Frame(title_frame)
            title_left.pack(side='left', fill='x', expand=True)
            
            ttk.Label(title_left, text=f"KARBOTU - {step_name}", font=('Arial', 14, 'bold')).pack(anchor='w')
            ttk.Label(title_left, text=f"{order_type} - %{lot_percentage} Lot", font=('Arial', 12)).pack(anchor='w')
            ttk.Label(title_left, text=f"{len(positions)} pozisyon seÃ§ildi", font=('Arial', 10)).pack(anchor='w')
            
            # SaÄŸ taraf - minimize butonu
            window_controls = ttk.Frame(title_frame)
            window_controls.pack(side='right')
            
            # Alta Al (Minimize) butonu
            minimize_btn = ttk.Button(window_controls, text="ğŸ—• Alta Al", width=10,
                                      command=lambda: confirm_win.iconify())
            minimize_btn.pack(side='left', padx=2)
            
            # Pozisyon listesi
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Treeview
            columns = ('Symbol', 'Qty', 'Lot', 'Fbtot', 'Ask Sell PahalÄ±lÄ±k', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=10)
            
            # Kolon geniÅŸlikleri
            col_widths = {'Symbol': 80, 'Qty': 60, 'Lot': 60, 'Fbtot': 60, 'Ask Sell PahalÄ±lÄ±k': 100, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            # Scrollbar
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # âœ… FÄ°YAT VE LOT DEPOSU - pencereye Ã¶zel
            order_data = {}  # {symbol: {'price': emir_fiyat, 'lot': lot_qty}}
            
            # PozisyonlarÄ± ekle
            for pos in positions:
                # Pozisyon verilerini al
                item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Quantity
                
                # Lot hesapla (%50 veya %25)
                calculated_lot = qty * (lot_percentage / 100)
                
                # 200 lot altÄ± pozisyonlar iÃ§in tamamÄ±nÄ± gÃ¶nder
                abs_qty = abs(qty)
                if abs_qty < 200:
                    # Eldeki lot < 200 ise tamamÄ±nÄ± gÃ¶nder
                    lot_qty = int(abs_qty) if qty >= 0 else -int(abs_qty)
                else:
                    # Lot yuvarlama mantÄ±ÄŸÄ± (negatif sayÄ±lar iÃ§in)
                    if calculated_lot >= 0:
                        # Pozitif sayÄ±lar iÃ§in normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayÄ±lar iÃ§in aÅŸaÄŸÄ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                
                # Emir fiyatÄ±nÄ± hesapla (emir tipine gÃ¶re)
                symbol = pos['symbol']
                emir_fiyat = 0
                
                # JFIN ile BIREBIR aynÄ± mantÄ±k - calculate_order_price metodunu kopyala
                print(f"[KARBOTU DEBUG] ğŸ” {symbol} JFIN mantÄ±ÄŸÄ± ile fiyat hesaplanÄ±yor...")
                
                # JFIN'in calculate_order_price metodunu kopyala - AYNI MANTIK
                # Ana sayfadan market data al (JFIN ile TAMAMEN AYNI)
                market_data = None
                
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} market_data boÅŸ - JFIN gibi N/A dÃ¶ndÃ¼rÃ¼lÃ¼yor")
                        continue
                else:
                    emir_fiyat = 0
                    print(f"[KARBOTU] âŒ {symbol} Hammer yok - JFIN gibi N/A dÃ¶ndÃ¼rÃ¼lÃ¼yor")
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                print(f"[KARBOTU DEBUG] ğŸ“Š {symbol} JFIN market_data: bid=${bid:.2f}, ask=${ask:.2f}, last=${last:.2f}")
                
                # JFIN'in tam mantÄ±ÄŸÄ±nÄ± kopyala
                if order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                        print(f"[KARBOTU] âœ… {symbol} Bid Buy (JFIN): bid=${bid:.2f} + spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} Bid Buy: bid/ask deÄŸerleri geÃ§ersiz")
                elif order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                        print(f"[KARBOTU] âœ… {symbol} Ask Sell (JFIN): ask=${ask:.2f} - spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} Ask Sell: bid/ask deÄŸerleri geÃ§ersiz")
                elif order_type == "Front Buy":
                    if last > 0:
                        emir_fiyat = last + 0.01
                        print(f"[KARBOTU] âœ… {symbol} Front Buy (JFIN): last=${last:.2f} + 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} Front Buy: last deÄŸeri geÃ§ersiz")
                elif order_type == "Front Sell":
                    if last > 0:
                        emir_fiyat = last - 0.01
                        print(f"[KARBOTU] âœ… {symbol} Front Sell (JFIN): last=${last:.2f} - 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} Front Sell: last deÄŸeri geÃ§ersiz")
                elif order_type == "SoftFront Buy":
                    if last > 0:
                        emir_fiyat = last + 0.01
                        print(f"[KARBOTU] âœ… {symbol} SoftFront Buy (JFIN): last=${last:.2f} + 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} SoftFront Buy: last deÄŸeri geÃ§ersiz")
                elif order_type == "SoftFront Sell":
                    if last > 0:
                        emir_fiyat = last - 0.01
                        print(f"[KARBOTU] âœ… {symbol} SoftFront Sell (JFIN): last=${last:.2f} - 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} SoftFront Sell: last deÄŸeri geÃ§ersiz")
                elif order_type == "Bid Sell":
                    if bid > 0:
                        emir_fiyat = bid - 0.01
                        print(f"[KARBOTU] âœ… {symbol} Bid Sell (JFIN): bid=${bid:.2f} - 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} Bid Sell: bid deÄŸeri geÃ§ersiz")
                elif order_type == "Ask Buy":
                    if ask > 0:
                        emir_fiyat = ask + 0.01
                        print(f"[KARBOTU] âœ… {symbol} Ask Buy (JFIN): ask=${ask:.2f} + 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} Ask Buy: ask deÄŸeri geÃ§ersiz")
                else:
                    # Bilinmeyen emir tipi iÃ§in Ask Sell formÃ¼lÃ¼ kullan
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                        print(f"[KARBOTU] âœ… {symbol} {order_type} (JFIN default): ask=${ask:.2f} - spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] âŒ {symbol} {order_type}: bid/ask deÄŸerleri geÃ§ersiz")
                
                pos_tree.insert('', 'end', values=(
                    pos['symbol'],
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['fbtot']:.2f}",
                    f"${pos['ask_sell_pahalilik']:.4f}",
                    f"${emir_fiyat:.2f}"
                ))
                
                # âœ… FÄ°YAT VE LOT DEPOSAYA KAYDET
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
                    print(f"[KARBOTU] âœ… {symbol} depoya kaydedildi: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
                else:
                    print(f"[KARBOTU] âš ï¸ {symbol} geÃ§ersiz: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
            
            # Butonlar
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                """Onay verildi - Emirleri gÃ¶nder - DEPODAN FÄ°YATLARI KULLAN"""
                try:
                    print(f"[KARBOTU] ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    self.log_message(f"ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    
                    # âœ… DEPODAN FÄ°YATLARI KULLAN - Market data Ã§ekme YOK
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        # âœ… Minimum 200 lot kontrolÃ¼ - 200'den azsa skip et
                        if abs(lot_qty) < 200:
                            print(f"[KARBOTU] âš ï¸ {symbol}: lot={lot_qty} < 200, atlandÄ±")
                            continue
                        
                        print(f"[KARBOTU] ğŸ“¤ {symbol}: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
                        
                        # Emir gÃ¶nder
                        if self.mode_manager.is_hammer_mode():
                            # Hammer Pro - Symbol dÃ¶nÃ¼ÅŸÃ¼mÃ¼
                            hammer_symbol = symbol.replace(" PR", "-")
                            
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="SELL",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                
                                if success or "new order sent" in str(success):
                                    print(f"[KARBOTU] âœ… {symbol} â†’ {hammer_symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                                    print(f"[KARBOTU] âœ… {symbol} â†’ {hammer_symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                                    details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of {abs(qty)}) | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "KARBOTU")
                                else:
                                    print(f"[KARBOTU] âŒ {symbol} â†’ {hammer_symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                            except Exception as e:
                                if "new order sent" in str(e).lower():
                                    print(f"[KARBOTU] âœ… {symbol} â†’ {hammer_symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f} (new order sent)")
                                else:
                                    print(f"[KARBOTU] âŒ {symbol} â†’ {hammer_symbol}: {e}")
                                    self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "KARBOTU")
                        else:
                            # IBKR
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="SELL",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT",
                                hidden=True
                            )
                            
                            if success:
                                print(f"[KARBOTU] âœ… {symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                                details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay"
                                reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "KARBOTU")
                            else:
                                print(f"[KARBOTU] âŒ {symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                    
                    print(f"[KARBOTU] âœ… {step_name} emirleri gÃ¶nderildi")
                    self.log_message(f"âœ… {step_name} emirleri gÃ¶nderildi")
                    
                    # Pencereyi hemen kapat (iÅŸi bitti)
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    
                    # Popup'larÄ± kapat
                    self.addnewpos_close_messagebox()
                    if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                        self.runall_auto_confirm_messagebox()
                    
                    # Sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile - adÄ±mlar sÄ±ralÄ± ilerlesin)
                    self.after(500, self.karbotu_proceed_to_next_step)
                    
                except Exception as e:
                    print(f"[KARBOTU] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    self.log_message(f"âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    # Hata olsa bile pencereyi kapat
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    # Sonraki adÄ±ma geÃ§
                    self.after(500, self.karbotu_proceed_to_next_step)
            
            def on_cancel():
                """Ä°ptal edildi"""
                print(f"[KARBOTU] âŒ {step_name} iptal edildi")
                self.log_message(f"âŒ {step_name} iptal edildi")
                confirm_win.destroy()
                # Sonraki adÄ±ma geÃ§ (kÄ±sa bir bekleme ile - adÄ±mlar sÄ±ralÄ± ilerlesin)
                self.after(1000, self.karbotu_proceed_to_next_step)
            
            def save_to_trades_csv():
                """SeÃ§ili emirleri trades.csv formatÄ±nda kaydet"""
                try:
                    print(f"[KARBOTU CSV] ğŸ”„ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    self.log_message(f"ğŸ”„ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    
                    # CSV satÄ±rlarÄ±
                    csv_rows = []
                    
                    # PENCERE'DEKÄ° tablodan verileri al (zaten hesaplanmÄ±ÅŸ fiyatlar var)
                    for item in pos_tree.get_children():
                        values = pos_tree.item(item)['values']
                        symbol = values[0]
                        qty = float(values[1])
                        lot_qty = float(values[2])
                        
                        # Emir fiyatÄ±nÄ± PENCERE'DEKÄ° DEÄERDEN al (zaten hesaplanmÄ±ÅŸ)
                        emir_fiyat_str = values[5]  # "Emir Fiyat" kolonu
                        try:
                            # $ iÅŸaretini ve format karakterlerini temizle
                            emir_fiyat = float(str(emir_fiyat_str).replace('$', '').replace(',', '').strip())
                            print(f"[KARBOTU CSV] âœ… {symbol}: Emir fiyatÄ± pencereden alÄ±ndÄ±: ${emir_fiyat:.2f}")
                        except (ValueError, TypeError, IndexError):
                            print(f"[KARBOTU CSV] âŒ {symbol}: Emir fiyatÄ± okunamadÄ±: {emir_fiyat_str}")
                            emir_fiyat = 0
                            continue
                        
                        # Lot ve fiyat ZATEN PENCREDEN ALINDI - market data Ã§ekmeye GEREK YOK!
                        # Minimum lot kontrolÃ¼
                        if abs(lot_qty) < 200:
                            continue
                        
                        # CSV'ye kaydet (fiyat ve lot zaten hazÄ±r)
                        if emir_fiyat > 0:
                            # CSV formatÄ± (orijinal format)
                            csv_row = [
                                'SELL',                    # Action
                                int(lot_qty),             # Quantity
                                symbol,                    # Symbol
                                'STK',                    # SecType
                                'SMART/AMEX',              # Exchange
                                'USD',                    # Currency
                                'DAY',                    # TimeInForce
                                'LMT',                    # OrderType
                                f"{emir_fiyat:.2f}",      # LmtPrice
                                'Basket',                 # BasketTag
                                'U21016730',              # Account
                                'Basket',                 # OrderRef
                                'TRUE',                   # Hidden
                                'TRUE'                    # OutsideRth
                            ]
                            
                            csv_rows.append(csv_row)
                            print(f"[KARBOTU CSV] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    if csv_rows:
                        # CSV dosyasÄ±na kaydet
                        import csv
                        
                        csv_filename = 'trades.csv'
                        
                        # DosyayÄ± sÄ±fÄ±rdan yaz (write mode)
                        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                            writer = csv.writer(csvfile)
                            
                            # BaÅŸlÄ±k satÄ±rÄ± (orijinal format)
                            writer.writerow(['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 'OrderRef', 'Hidden', 'OutsideRth'])
                            
                            # Emir satÄ±rlarÄ±
                            writer.writerows(csv_rows)
                        
                        print(f"[KARBOTU CSV] âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        self.log_message(f"âœ… {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                    else:
                        messagebox.showwarning("UyarÄ±", "Kaydedilecek geÃ§erli emir bulunamadÄ±!")
                        
                except Exception as e:
                    print(f"[KARBOTU CSV] âŒ Kaydetme hatasÄ±: {e}")
                    self.log_message(f"âŒ Kaydetme hatasÄ±: {e}")
                    messagebox.showerror("Hata", f"trades.csv kaydetme hatasÄ±: {e}")
            
            ttk.Button(button_frame, text="Emirleri GÃ¶nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KARBOTU] âŒ Onay penceresi hatasÄ±: {e}")
            self.log_message(f"âŒ Onay penceresi hatasÄ±: {e}")
    
    def karbotu_gort_send_orders_direct_longs(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort Longs: Emirleri direkt gÃ¶nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[KARBOTU GORT] ğŸ¯ karbotu_gort_send_orders_direct_longs FONKSÄ°YONU Ã‡AÄRILDI! {len(positions)} pozisyon")
            print(f"[KARBOTU GORT] ğŸ”„ {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            self.log_message(f"ğŸ”„ KARBOTU Gort {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (pozitif)
                
                # Ã–zel lot hesaplama: %10 ama min 200 lot, eÄŸer eldeki lot < 200 ise eldeki lotun tamamÄ±
                calculated_lot = qty * (lot_percentage / 100)  # %10 hesapla
                
                if qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamÄ±
                    lot_qty = int(qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %10 hesaplanan deÄŸer 200'den kÃ¼Ã§Ã¼kse â†’ 200 lot (min 200 kuralÄ±)
                        lot_qty = 200
                    else:
                        # %10 hesaplanan deÄŸer 200'den bÃ¼yÃ¼k veya eÅŸitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrolÃ¼ (yuvarlama sonrasÄ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)  # Ask Sell
                
                # YENÄ° KURAL SÄ°STEMÄ°: REDUCE limitleri (BefQty/PortfÃ¶y oranÄ±na gÃ¶re)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                
                # GÃ¼nlÃ¼k reduce limitini hesapla
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                # Mevcut pozisyon ve aÃ§Ä±k emirler
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                
                # GÃ¼nlÃ¼k deÄŸiÅŸim
                current_daily_change = abs(current_potential - befday_qty)
                
                # Kalan gÃ¼nlÃ¼k hak
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                # Emir miktarÄ±nÄ± kontrol et ve gerekirse ayarla
                if not is_unlimited and lot_qty > remaining_allowance:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[KARBOTU GORT] âš ï¸ {symbol}: GÃ¼nlÃ¼k limit doldu, emir atlandÄ±")
                        details_msg = f"{symbol} GÃ¼nlÃ¼k Limit Doldu | Limit:{daily_limit:.0f} Used:{current_daily_change:.0f} Rem:{remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_BLOKE", details_msg, "BLOCKED", "Daily Limit", "KARBOTU")
                        continue
                    lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                    print(f"[KARBOTU GORT] ğŸ“Š {symbol}: Emir miktarÄ± ayarlandÄ± â†’ {lot_qty} lot")
                
                # Ters pozisyona geÃ§iÅŸ kontrolÃ¼
                new_potential = current_potential - lot_qty
                if befday_qty > 0 and new_potential < 0:
                    lot_qty = int(current_potential)
                    print(f"[KARBOTU GORT] âš ï¸ {symbol}: Ters poz. yasak, lot ayarlandÄ± â†’ {lot_qty}")
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri gÃ¶nder
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="SELL",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success:
                            print(f"[KARBOTU GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                            self.log_message(f"âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                            reasoning = f"{step_name} (Gort) | Lot: {lot_qty} | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                            self.log_psfalgo_activity("EMIR_ILETILDI", f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f}", "SUCCESS", reasoning, "KARBOTU")
                    except Exception as e:
                        print(f"[KARBOTU GORT] âŒ {symbol} emir hatasÄ±: {e}")
                        self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "KARBOTU")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="SELL",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT"
                    )
                    if success:
                        print(f"[KARBOTU GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                        self.log_message(f"âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                        reasoning = f"{step_name} (Gort) | Lot: {lot_qty} | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_ILETILDI", f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f}", "SUCCESS", reasoning, "KARBOTU")
            
            print(f"[KARBOTU GORT] âœ… {len(order_data)} emir gÃ¶nderildi")
            self.log_message(f"âœ… KARBOTU Gort {step_name}: {len(order_data)} emir gÃ¶nderildi")
            
            # Sonraki adÄ±ma geÃ§ (Gort kontrolÃ¼ bitince adÄ±m 2'ye geÃ§ilecek)
            print(f"[KARBOTU GORT] ğŸ”„ AdÄ±m 2'ye geÃ§iliyor (500ms sonra)...")
            self.after(500, self.karbotu_step_2_fbtot_lt_110)
            
        except Exception as e:
            print(f"[KARBOTU GORT] âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            self.log_message(f"âŒ KARBOTU Gort direkt emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§
            self.after(500, self.karbotu_step_2_fbtot_lt_110)
    
    def karbotu_gort_send_orders_direct_shorts(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort Shorts: Emirleri direkt gÃ¶nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[KARBOTU GORT] ğŸ”„ {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            self.log_message(f"ğŸ”„ KARBOTU Gort {step_name} emirleri direkt gÃ¶nderiliyor (Allowed modu)...")
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (negatif, Ã¶rn: -276)
                abs_qty = abs(qty)  # Mutlak deÄŸer
                
                # Ã–zel lot hesaplama: %10 ama min 200 lot, eÄŸer eldeki lot < 200 ise eldeki lotun tamamÄ±
                calculated_lot = abs_qty * (lot_percentage / 100)  # %10 hesapla
                
                if abs_qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamÄ±
                    lot_qty = int(abs_qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %10 hesaplanan deÄŸer 200'den kÃ¼Ã§Ã¼kse â†’ 200 lot (min 200 kuralÄ±)
                        lot_qty = 200
                    else:
                        # %10 hesaplanan deÄŸer 200'den bÃ¼yÃ¼k veya eÅŸitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrolÃ¼ (yuvarlama sonrasÄ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # YENÄ° KURAL SÄ°STEMÄ°: REDUCE limitleri (Shorts iÃ§in)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                current_daily_change = abs(current_potential - befday_qty)
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                if not is_unlimited and lot_qty > remaining_allowance:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[KARBOTU GORT SHORTS] âš ï¸ {symbol}: GÃ¼nlÃ¼k limit doldu, emir atlandÄ±")
                        details_msg = f"{symbol} GÃ¼nlÃ¼k Limit Doldu | Limit:{daily_limit:.0f} Used:{current_daily_change:.0f} Rem:{remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_BLOKE", details_msg, "BLOCKED", "Daily Limit", "KARBOTU")
                        continue
                    lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs_qty)
                    print(f"[KARBOTU GORT SHORTS] ğŸ“Š {symbol}: Emir miktarÄ± ayarlandÄ± â†’ {lot_qty} lot")
                
                # Ters pozisyona geÃ§iÅŸ kontrolÃ¼ (short iken long'a geÃ§iÅŸ yasak)
                new_potential = current_potential + lot_qty  # BUY emri ekleniyor
                if befday_qty < 0 and new_potential > 0:
                    lot_qty = int(abs(current_potential))
                    print(f"[KARBOTU GORT SHORTS] âš ï¸ {symbol}: Ters poz. yasak, lot ayarlandÄ± â†’ {lot_qty}")
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)  # Bid Buy
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri gÃ¶nder
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success:
                            print(f"[KARBOTU GORT] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                            self.log_message(f"âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                            reasoning = f"{step_name} (Gort) | Lot: {lot_qty} | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                            self.log_psfalgo_activity("EMIR_ILETILDI", f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f}", "SUCCESS", reasoning, "KARBOTU")
                    except Exception as e:
                        print(f"[KARBOTU GORT] âŒ {symbol} emir hatasÄ±: {e}")
                        self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "KARBOTU")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT"
                    )
                    if success:
                        print(f"[KARBOTU GORT] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                        self.log_message(f"âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                        reasoning = f"{step_name} (Gort) | Lot: {lot_qty} | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_ILETILDI", f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f}", "SUCCESS", reasoning, "KARBOTU")
            
            print(f"[KARBOTU GORT] âœ… {len(order_data)} emir gÃ¶nderildi")
            self.log_message(f"âœ… KARBOTU Gort {step_name}: {len(order_data)} emir gÃ¶nderildi")
            
            # Sonraki adÄ±ma geÃ§ (Gort kontrolÃ¼ bitince sonraki adÄ±ma geÃ§ilecek)
            self.after(500, self.karbotu_proceed_to_next_step)
            
        except Exception as e:
            print(f"[KARBOTU GORT] âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            self.log_message(f"âŒ KARBOTU Gort direkt emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§
            self.after(500, self.karbotu_proceed_to_next_step)
    
    def karbotu_gort_show_confirmation_window_longs(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort: Longs iÃ§in Ã¶zel lot hesaplama ile onay penceresi"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrolÃ¼
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU GORT] âœ… Allowed modu aktif - Onay penceresi atlanÄ±yor, emirler direkt gÃ¶nderiliyor")
                self.log_message(f"âœ… Allowed modu: {step_name} (GORT Longs) - Emirler otomatik gÃ¶nderiliyor")
                # Emirleri direkt gÃ¶nder (onay penceresi aÃ§madan)
                self.karbotu_gort_send_orders_direct_longs(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[KARBOTU GORT] ğŸ”„ Onay penceresi aÃ§Ä±lÄ±yor: {step_name}")
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"KARBOTU GORT - {step_name}")
            confirm_win.geometry("700x500")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"KARBOTU GORT - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - Ã–zel Lot Hesaplama (Min 200 lot veya eldeki lotun tamamÄ±)", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon seÃ§ildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Eldeki Lot', 'Hesaplanan Lot', 'Gort', 'Ask Sell PahalÄ±lÄ±k', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=15)
            
            col_widths = {'Symbol': 80, 'Eldeki Lot': 80, 'Hesaplanan Lot': 100, 'Gort': 60, 'Ask Sell PahalÄ±lÄ±k': 120, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (pozitif)
                
                # Ã–zel lot hesaplama: %10 ama min 200 lot, eÄŸer eldeki lot < 200 ise eldeki lotun tamamÄ±
                calculated_lot = qty * (lot_percentage / 100)  # %10 hesapla
                
                if qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamÄ±
                    lot_qty = int(qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %10 hesaplanan deÄŸer 200'den kÃ¼Ã§Ã¼kse â†’ 200 lot (min 200 kuralÄ±)
                        lot_qty = 200
                    else:
                        # %10 hesaplanan deÄŸer 200'den bÃ¼yÃ¼k veya eÅŸitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrolÃ¼ (yuvarlama sonrasÄ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)  # Ask Sell
                
                pos_tree.insert('', 'end', values=(
                    symbol,
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['gort']:.2f}",
                    f"${pos['ask_sell_pahalilik']:.4f}",
                    f"${emir_fiyat:.2f}" if emir_fiyat > 0 else "N/A"
                ))
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[KARBOTU GORT] ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    self.log_message(f"ğŸ”„ KARBOTU Gort {step_name} emirleri gÃ¶nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="SELL",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                if success:
                                    print(f"[KARBOTU GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                    self.log_message(f"âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                    details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Gort)"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of {abs(qty)}) | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "KARBOTU")
                            except Exception as e:
                                print(f"[KARBOTU GORT] âŒ {symbol} emir hatasÄ±: {e}")
                                self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "KARBOTU")
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="SELL",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT"
                            )
                            if success:
                                print(f"[KARBOTU GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                self.log_message(f"âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Gort)"
                                reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "KARBOTU")
                    
                    print(f"[KARBOTU GORT] âœ… {len(order_data)} emir gÃ¶nderildi")
                    self.log_message(f"âœ… KARBOTU Gort {step_name}: {len(order_data)} emir gÃ¶nderildi")
                    
                    # Pencereyi hemen kapat (iÅŸi bitti)
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    
                    # Messagebox gÃ¶sterme (Allowed modunda otomatik kapanacak)
                    if not (hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode):
                        # Allowed modu kapalÄ±ysa messagebox gÃ¶ster
                        self.after(100, lambda: messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(order_data)} emir gÃ¶nderildi!"))
                    
                    # Sonraki adÄ±ma geÃ§ (Gort kontrolÃ¼ bitince adÄ±m 2'ye geÃ§ilecek)
                    self.after(500, self.karbotu_step_2_fbtot_lt_110)
                    
                except Exception as e:
                    print(f"[KARBOTU GORT] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    self.log_message(f"âŒ KARBOTU Gort emir gÃ¶nderme hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile pencereyi kapat
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    # Sonraki adÄ±ma geÃ§
                    self.after(500, self.karbotu_step_2_fbtot_lt_110)
            
            def on_cancel():
                # Pencereyi kapat
                try:
                    if confirm_win.winfo_exists():
                        confirm_win.destroy()
                except:
                    pass
                # Sonraki adÄ±ma geÃ§
                self.after(500, self.karbotu_step_2_fbtot_lt_110)
            
            ttk.Button(button_frame, text="Emirleri GÃ¶nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KARBOTU GORT] âŒ Onay penceresi hatasÄ±: {e}")
            self.log_message(f"âŒ KARBOTU Gort onay penceresi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def karbotu_gort_show_confirmation_window_shorts(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort: Shorts iÃ§in Ã¶zel lot hesaplama ile onay penceresi"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrolÃ¼
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU GORT] âœ… Allowed modu aktif - Onay penceresi atlanÄ±yor, emirler direkt gÃ¶nderiliyor")
                self.log_message(f"âœ… Allowed modu: {step_name} (GORT Shorts) - Emirler otomatik gÃ¶nderiliyor")
                # Emirleri direkt gÃ¶nder (onay penceresi aÃ§madan)
                self.karbotu_gort_send_orders_direct_shorts(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[KARBOTU GORT] ğŸ”„ Onay penceresi aÃ§Ä±lÄ±yor: {step_name}")
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"KARBOTU GORT - {step_name}")
            confirm_win.geometry("700x500")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"KARBOTU GORT - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - Ã–zel Lot Hesaplama (Min 200 lot veya eldeki lotun tamamÄ±)", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon seÃ§ildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Eldeki Lot', 'Hesaplanan Lot', 'Gort', 'Bid Buy Ucuzluk', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=15)
            
            col_widths = {'Symbol': 80, 'Eldeki Lot': 80, 'Hesaplanan Lot': 100, 'Gort': 60, 'Bid Buy Ucuzluk': 120, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (negatif, Ã¶rn: -276)
                abs_qty = abs(qty)  # Mutlak deÄŸer
                
                # Ã–zel lot hesaplama: %10 ama min 200 lot, eÄŸer eldeki lot < 200 ise eldeki lotun tamamÄ±
                calculated_lot = abs_qty * (lot_percentage / 100)  # %10 hesapla
                
                if abs_qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamÄ±
                    lot_qty = int(abs_qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %10 hesaplanan deÄŸer 200'den kÃ¼Ã§Ã¼kse â†’ 200 lot (min 200 kuralÄ±)
                        lot_qty = 200
                    else:
                        # %10 hesaplanan deÄŸer 200'den bÃ¼yÃ¼k veya eÅŸitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrolÃ¼ (yuvarlama sonrasÄ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)  # Bid Buy
                
                pos_tree.insert('', 'end', values=(
                    symbol,
                    f"{abs_qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['gort']:.2f}",
                    f"${pos['bid_buy_ucuzluk']:.4f}",
                    f"${emir_fiyat:.2f}" if emir_fiyat > 0 else "N/A"
                ))
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[KARBOTU GORT] ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    self.log_message(f"ğŸ”„ KARBOTU Gort {step_name} emirleri gÃ¶nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="BUY",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                if success:
                                    print(f"[KARBOTU GORT] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                    self.log_message(f"âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                    details_msg = f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Gort Shorts)"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of {abs(qty)}) | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "KARBOTU")
                            except Exception as e:
                                print(f"[KARBOTU GORT] âŒ {symbol} emir hatasÄ±: {e}")
                                self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "KARBOTU")
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="BUY",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT"
                            )
                            if success:
                                print(f"[KARBOTU GORT] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                self.log_message(f"âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                details_msg = f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Gort Shorts)"
                                reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "KARBOTU")
                    
                    print(f"[KARBOTU GORT] âœ… {len(order_data)} emir gÃ¶nderildi")
                    self.log_message(f"âœ… KARBOTU Gort {step_name}: {len(order_data)} emir gÃ¶nderildi")
                    
                    # Pencereyi hemen kapat (iÅŸi bitti)
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    
                    # Messagebox gÃ¶sterme (Allowed modunda otomatik kapanacak)
                    if not (hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode):
                        # Allowed modu kapalÄ±ysa messagebox gÃ¶ster
                        self.after(100, lambda: messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(order_data)} emir gÃ¶nderildi!"))
                    
                    # Sonraki adÄ±ma geÃ§ (Gort kontrolÃ¼ bitince sonraki adÄ±ma geÃ§ilecek)
                    self.after(500, self.karbotu_proceed_to_next_step)
                    
                except Exception as e:
                    print(f"[KARBOTU GORT] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    self.log_message(f"âŒ KARBOTU Gort emir gÃ¶nderme hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile pencereyi kapat
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    # Sonraki adÄ±ma geÃ§
                    self.after(500, self.karbotu_proceed_to_next_step)
            
            def on_cancel():
                # Pencereyi kapat
                try:
                    if confirm_win.winfo_exists():
                        confirm_win.destroy()
                except:
                    pass
                # Sonraki adÄ±ma geÃ§
                self.after(500, self.karbotu_proceed_to_next_step)
            
            ttk.Button(button_frame, text="Emirleri GÃ¶nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KARBOTU GORT] âŒ Onay penceresi hatasÄ±: {e}")
            self.log_message(f"âŒ KARBOTU Gort onay penceresi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reducemore_gort_show_confirmation_window_longs(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Longs iÃ§in Ã¶zel lot hesaplama ile onay penceresi"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrolÃ¼
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[REDUCEMORE GORT] âœ… Allowed modu aktif - Onay penceresi atlanÄ±yor, emirler direkt gÃ¶nderiliyor")
                self.log_message(f"âœ… Allowed modu: {step_name} (GORT Longs) - Emirler otomatik gÃ¶nderiliyor")
                # Emirleri direkt gÃ¶nder (onay penceresi aÃ§madan)
                self.reducemore_gort_send_orders_direct_longs(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[REDUCEMORE GORT] ğŸ”„ Onay penceresi aÃ§Ä±lÄ±yor: {step_name}")
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"REDUCEMORE GORT - {step_name}")
            confirm_win.geometry("700x500")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"REDUCEMORE GORT - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - Ã–zel Lot Hesaplama (Min 200 lot veya eldeki lotun tamamÄ±)", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon seÃ§ildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Eldeki Lot', 'Hesaplanan Lot', 'Gort', 'Ask Sell PahalÄ±lÄ±k', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=15)
            
            col_widths = {'Symbol': 80, 'Eldeki Lot': 80, 'Hesaplanan Lot': 100, 'Gort': 60, 'Ask Sell PahalÄ±lÄ±k': 120, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (pozitif)
                
                # Ã–zel lot hesaplama: %20 ama min 200 lot, eÄŸer eldeki lot < 200 ise eldeki lotun tamamÄ±
                calculated_lot = qty * (lot_percentage / 100)  # %20 hesapla
                
                if qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamÄ±
                    lot_qty = int(qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %20 hesaplanan deÄŸer 200'den kÃ¼Ã§Ã¼kse â†’ 200 lot (min 200 kuralÄ±)
                        lot_qty = 200
                    else:
                        # %20 hesaplanan deÄŸer 200'den bÃ¼yÃ¼k veya eÅŸitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrolÃ¼ (yuvarlama sonrasÄ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)  # Ask Sell
                
                pos_tree.insert('', 'end', values=(
                    symbol,
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['gort']:.2f}",
                    f"${pos['ask_sell_pahalilik']:.4f}",
                    f"${emir_fiyat:.2f}" if emir_fiyat > 0 else "N/A"
                ))
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[REDUCEMORE GORT] ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    self.log_message(f"ğŸ”„ REDUCEMORE Gort {step_name} emirleri gÃ¶nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="SELL",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                if success:
                                    print(f"[REDUCEMORE GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                    print(f"[REDUCEMORE GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                    self.log_message(f"âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                    details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Gort)"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                            except Exception as e:
                                print(f"[REDUCEMORE GORT] âŒ {symbol} emir hatasÄ±: {e}")
                                self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "REDUCEMORE")
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="SELL",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT"
                            )
                            if success:
                                print(f"[REDUCEMORE GORT] âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                self.log_message(f"âœ… {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                details_msg = f"{symbol} SELL {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Gort)"
                                reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                    
                    print(f"[REDUCEMORE GORT] âœ… {len(order_data)} emir gÃ¶nderildi")
                    self.log_message(f"âœ… REDUCEMORE Gort {step_name}: {len(order_data)} emir gÃ¶nderildi")
                    
                    confirm_win.destroy()
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(order_data)} emir gÃ¶nderildi!")
                    
                    # Sonraki adÄ±ma geÃ§ (Gort kontrolÃ¼ bitince sonraki adÄ±ma geÃ§ilecek)
                    self.after(500, self.reduce_more_proceed_to_next_step)
                    
                except Exception as e:
                    print(f"[REDUCEMORE GORT] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    self.log_message(f"âŒ REDUCEMORE Gort emir gÃ¶nderme hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile sonraki adÄ±ma geÃ§
                    self.after(500, self.reduce_more_proceed_to_next_step)
            
            def on_cancel():
                confirm_win.destroy()
                # Ä°ptal edildiÄŸinde de sonraki adÄ±ma geÃ§
                self.after(500, self.reduce_more_proceed_to_next_step)
            
            ttk.Button(button_frame, text="Emirleri GÃ¶nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] âŒ Onay penceresi hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE Gort onay penceresi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§
            self.after(500, self.reduce_more_proceed_to_next_step)
    
    def reducemore_gort_send_orders_direct_shorts(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Shorts iÃ§in direkt emir gÃ¶nderme (Allowed modu iÃ§in)"""
        try:
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (negatif, Ã¶rn: -276)
                abs_qty = abs(qty)  # Mutlak deÄŸer
                
                # Ã–zel lot hesaplama: %20 ama min 200 lot, eÄŸer eldeki lot < 200 ise eldeki lotun tamamÄ±
                calculated_lot = abs_qty * (lot_percentage / 100)  # %20 hesapla
                
                if abs_qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamÄ±
                    lot_qty = int(abs_qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %20 hesaplanan deÄŸer 200'den kÃ¼Ã§Ã¼kse â†’ 200 lot (min 200 kuralÄ±)
                        lot_qty = 200
                    else:
                        # %20 hesaplanan deÄŸer 200'den bÃ¼yÃ¼k veya eÅŸitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrolÃ¼ (yuvarlama sonrasÄ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # YENÄ° KURAL SÄ°STEMÄ°: REDUCE limitleri (Shorts iÃ§in)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                current_daily_change = abs(current_potential - befday_qty)
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                if not is_unlimited and lot_qty > remaining_allowance:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[REDUCEMORE GORT SHORTS] âš ï¸ {symbol}: GÃ¼nlÃ¼k limit doldu, emir atlandÄ±")
                        print(f"[REDUCEMORE GORT SHORTS] âš ï¸ {symbol}: GÃ¼nlÃ¼k limit doldu, emir atlandÄ±")
                        details_msg = f"{symbol} GÃ¼nlÃ¼k Limit Doldu | Limit:{daily_limit:.0f} Used:{current_daily_change:.0f} Rem:{remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_BLOKE", details_msg, "BLOCKED", "Daily Limit", "REDUCEMORE")
                        continue
                    lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs_qty)
                    print(f"[REDUCEMORE GORT SHORTS] ğŸ“Š {symbol}: Emir miktarÄ± ayarlandÄ± â†’ {lot_qty} lot")
                
                # Ters pozisyona geÃ§iÅŸ kontrolÃ¼ (short iken long'a geÃ§iÅŸ yasak)
                new_potential = current_potential + lot_qty  # BUY emri ekleniyor
                if befday_qty < 0 and new_potential > 0:
                    lot_qty = int(abs(current_potential))
                    print(f"[REDUCEMORE GORT SHORTS] âš ï¸ {symbol}: Ters poz. yasak, lot ayarlandÄ± â†’ {lot_qty}")
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)  # Bid Buy
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri gÃ¶nder
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success:
                            print(f"[REDUCEMORE GORT] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                            self.log_message(f"âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                            reasoning = f"{step_name} (Gort) | Lot: {lot_qty} | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                            self.log_psfalgo_activity("EMIR_ILETILDI", f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f}", "SUCCESS", reasoning, "REDUCEMORE")
                    except Exception as e:
                        print(f"[REDUCEMORE GORT] âŒ {symbol} emir hatasÄ±: {e}")
                        self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "REDUCEMORE")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT"
                    )
                    if success:
                        print(f"[REDUCEMORE GORT] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                        self.log_message(f"âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                        reasoning = f"{step_name} (Gort) | Lot: {lot_qty} | Limit: {daily_limit:.0f} | DailyChg: {current_daily_change:.0f} | Rem: {remaining_allowance:.0f}"
                        self.log_psfalgo_activity("EMIR_ILETILDI", f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f}", "SUCCESS", reasoning, "REDUCEMORE")
            
            print(f"[REDUCEMORE GORT] âœ… {len(order_data)} emir gÃ¶nderildi")
            self.log_message(f"âœ… REDUCEMORE Gort {step_name}: {len(order_data)} emir gÃ¶nderildi")
            
            # Sonraki adÄ±ma geÃ§ (Gort kontrolÃ¼ bitince sonraki adÄ±ma geÃ§ilecek)
            self.after(500, self.reduce_more_proceed_to_next_step)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] âŒ Direkt emir gÃ¶nderme hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE Gort direkt emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§
            self.after(500, self.reduce_more_proceed_to_next_step)
    
    def reducemore_gort_show_confirmation_window_shorts(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Shorts iÃ§in Ã¶zel lot hesaplama ile onay penceresi"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrolÃ¼
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[REDUCEMORE GORT] âœ… Allowed modu aktif - Onay penceresi atlanÄ±yor, emirler direkt gÃ¶nderiliyor")
                self.log_message(f"âœ… Allowed modu: {step_name} (GORT Shorts) - Emirler otomatik gÃ¶nderiliyor")
                # Emirleri direkt gÃ¶nder (onay penceresi aÃ§madan)
                self.reducemore_gort_send_orders_direct_shorts(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[REDUCEMORE GORT] ğŸ”„ Onay penceresi aÃ§Ä±lÄ±yor: {step_name}")
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"REDUCEMORE GORT - {step_name}")
            confirm_win.geometry("700x500")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"REDUCEMORE GORT - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - Ã–zel Lot Hesaplama (Min 200 lot veya eldeki lotun tamamÄ±)", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon seÃ§ildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Eldeki Lot', 'Hesaplanan Lot', 'Gort', 'Bid Buy Ucuzluk', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=15)
            
            col_widths = {'Symbol': 80, 'Eldeki Lot': 80, 'Hesaplanan Lot': 100, 'Gort': 60, 'Bid Buy Ucuzluk': 120, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (negatif, Ã¶rn: -276)
                abs_qty = abs(qty)  # Mutlak deÄŸer
                
                # Ã–zel lot hesaplama: %20 ama min 200 lot, eÄŸer eldeki lot < 200 ise eldeki lotun tamamÄ±
                calculated_lot = abs_qty * (lot_percentage / 100)  # %20 hesapla
                
                if abs_qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamÄ±
                    lot_qty = int(abs_qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %20 hesaplanan deÄŸer 200'den kÃ¼Ã§Ã¼kse â†’ 200 lot (min 200 kuralÄ±)
                        lot_qty = 200
                    else:
                        # %20 hesaplanan deÄŸer 200'den bÃ¼yÃ¼k veya eÅŸitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrolÃ¼ (yuvarlama sonrasÄ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatÄ±nÄ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)  # Bid Buy
                
                pos_tree.insert('', 'end', values=(
                    symbol,
                    f"{abs_qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['gort']:.2f}",
                    f"${pos['bid_buy_ucuzluk']:.4f}",
                    f"${emir_fiyat:.2f}" if emir_fiyat > 0 else "N/A"
                ))
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[REDUCEMORE GORT] ğŸ”„ {step_name} emirleri gÃ¶nderiliyor...")
                    self.log_message(f"ğŸ”„ REDUCEMORE Gort {step_name} emirleri gÃ¶nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="BUY",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                if success:
                                    print(f"[REDUCEMORE GORT] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                    self.log_message(f"âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                    details_msg = f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Gort Shorts)"
                                    reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                    self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                            except Exception as e:
                                print(f"[REDUCEMORE GORT] âŒ {symbol} emir hatasÄ±: {e}")
                                self.log_psfalgo_activity("EMIR_HATASI", f"{symbol} {e}", "ERROR", str(e), "REDUCEMORE")
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="BUY",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT"
                            )
                            if success:
                                print(f"[REDUCEMORE GORT] âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                self.log_message(f"âœ… {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                details_msg = f"{symbol} BUY {lot_qty} @ {emir_fiyat:.2f} | Manuel Onay (Gort Shorts)"
                                reasoning = f"{step_name} | User Approved | Lot: {lot_qty} ({lot_percentage}% of position)"
                                self.log_psfalgo_activity("EMIR_ILETILDI", details_msg, "SUCCESS", reasoning, "REDUCEMORE")
                    
                    print(f"[REDUCEMORE GORT] âœ… {len(order_data)} emir gÃ¶nderildi")
                    self.log_message(f"âœ… REDUCEMORE Gort {step_name}: {len(order_data)} emir gÃ¶nderildi")
                    
                    confirm_win.destroy()
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{len(order_data)} emir gÃ¶nderildi!")
                    
                    # Sonraki adÄ±ma geÃ§ (Gort kontrolÃ¼ bitince sonraki adÄ±ma geÃ§ilecek)
                    self.after(500, self.reduce_more_proceed_to_next_step)
                    
                except Exception as e:
                    print(f"[REDUCEMORE GORT] âŒ Emir gÃ¶nderme hatasÄ±: {e}")
                    self.log_message(f"âŒ REDUCEMORE Gort emir gÃ¶nderme hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile sonraki adÄ±ma geÃ§
                    self.after(500, self.reduce_more_proceed_to_next_step)
            
            def on_cancel():
                confirm_win.destroy()
                # Ä°ptal edildiÄŸinde de sonraki adÄ±ma geÃ§
                self.after(500, self.reduce_more_proceed_to_next_step)
            
            ttk.Button(button_frame, text="Emirleri GÃ¶nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] âŒ Onay penceresi hatasÄ±: {e}")
            self.log_message(f"âŒ REDUCEMORE Gort onay penceresi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adÄ±ma geÃ§
            self.after(500, self.reduce_more_proceed_to_next_step)
    
    def karbotu_proceed_to_next_step(self):
        """Sonraki adÄ±ma geÃ§"""
        try:
            print(f"[KARBOTU] ğŸ” karbotu_proceed_to_next_step Ã‡AÄRILDI! current_step={self.karbotu_current_step}, total_steps={self.karbotu_total_steps}")
            if self.karbotu_current_step >= self.karbotu_total_steps:
                print(f"[KARBOTU] âœ… KARBOTU TAMAMLANDI! current_step={self.karbotu_current_step}, total_steps={self.karbotu_total_steps}")
                self.log_message("ğŸ¯ KARBOTU otomasyonu tamamlandÄ±!")
                self.karbotu_running = False
                
                # TÃ¼m Take Profit pencerelerini kapat
                def close_karbotu_windows():
                    try:
                        # Take Profit Shorts penceresini kapat
                        if hasattr(self, 'take_profit_shorts_panel') and self.take_profit_shorts_panel:
                            try:
                                if hasattr(self.take_profit_shorts_panel, 'win') and self.take_profit_shorts_panel.win.winfo_exists():
                                    self.take_profit_shorts_panel.win.destroy()
                            except:
                                pass
                        
                        # Take Profit Longs penceresini kapat
                        if hasattr(self, 'take_profit_longs_panel') and self.take_profit_longs_panel:
                            try:
                                if hasattr(self.take_profit_longs_panel, 'win') and self.take_profit_longs_panel.win.winfo_exists():
                                    self.take_profit_longs_panel.win.destroy()
                            except:
                                pass
                        
                        # KARBOTU onay pencerelerini kapat
                        for widget in self.winfo_children():
                            try:
                                if isinstance(widget, tk.Toplevel):
                                    title = widget.title()
                                    if 'KARBOTU' in title or 'Emir OnayÄ±' in title:
                                        widget.destroy()
                            except:
                                pass
                    except:
                        pass
                
                # Pencereleri hemen kapat
                close_karbotu_windows()
                
                # RUNALL'dan Ã§aÄŸrÄ±ldÄ±ysa ADDNEWPOS kontrolÃ¼ yap (SADECE BÄ°R KEZ)
                print(f"[KARBOTU] ğŸ” KARBOTU tamamlandÄ±! runall_waiting_for_karbotu={hasattr(self, 'runall_waiting_for_karbotu') and self.runall_waiting_for_karbotu}")
                if hasattr(self, 'runall_waiting_for_karbotu') and self.runall_waiting_for_karbotu:
                    print(f"[KARBOTU] ğŸ” runall_addnewpos_triggered={hasattr(self, 'runall_addnewpos_triggered') and self.runall_addnewpos_triggered}")
                    if not hasattr(self, 'runall_addnewpos_triggered') or not self.runall_addnewpos_triggered:
                        # Flag'i runall_check_karbotu_and_addnewpos iÃ§inde set edeceÄŸiz, burada sadece tetikle
                        # Hemen kontrol et (500ms bekle - hÄ±zlÄ± geÃ§iÅŸ)
                        print("[KARBOTU] ğŸ”„ RUNALL'dan Ã§aÄŸrÄ±ldÄ±, ADDNEWPOS kontrolÃ¼ 500ms sonra yapÄ±lacak...")
                        self.after(500, self.runall_check_karbotu_and_addnewpos)
                    else:
                        print("[KARBOTU] âš ï¸ ADDNEWPOS zaten tetiklendi, tekrar tetiklenmeyecek")
                else:
                    print("[KARBOTU] âš ï¸ runall_waiting_for_karbotu False veya yok - ADDNEWPOS tetiklenmeyecek")
                
                return
            
            # Sonraki adÄ±mÄ± Ã§aÄŸÄ±r
            next_step = self.karbotu_current_step + 1
            
            # GUI'yi gÃ¼ncelle (donmasÄ±nÄ± Ã¶nle)
            self.update_idletasks()
            
            # AdÄ±m fonksiyonlarÄ±nÄ± mapping
            step_methods = {
                2: self.karbotu_step_2_fbtot_lt_110,
                3: self.karbotu_step_3_fbtot_111_145_low,
                4: self.karbotu_step_4_fbtot_111_145_high,
                5: self.karbotu_step_5_fbtot_146_185_low,
                6: self.karbotu_step_6_fbtot_146_185_high,
                7: self.karbotu_step_7_fbtot_186_210,
                8: self.karbotu_step_8_open_take_profit_shorts,
                9: self.karbotu_step_9_sfstot_170_high,
                10: self.karbotu_step_10_sfstot_140_169_low,
                11: self.karbotu_step_11_sfstot_140_169_high,
                12: self.karbotu_step_12_sfstot_110_139_low,
                13: self.karbotu_step_13_sfstot_110_139_high
            }
            
            if next_step in step_methods:
                self.karbotu_current_step = next_step
                # Sonraki adÄ±mÄ± non-blocking olarak Ã§aÄŸÄ±r (GUI donmasÄ±nÄ± Ã¶nle)
                self.after(200, step_methods[next_step])
            else:
                print(f"[KARBOTU] âš ï¸ AdÄ±m {next_step} henÃ¼z implement edilmedi")
                self.log_message(f"âš ï¸ AdÄ±m {next_step} henÃ¼z implement edilmedi")
                
        except Exception as e:
            print(f"[KARBOTU] âŒ Sonraki adÄ±m hatasÄ±: {e}")
            self.log_message(f"âŒ Sonraki adÄ±m hatasÄ±: {e}")
    
    def runall_check_karbotu_and_addnewpos(self):
        """KARBOTU bitince exposure kontrolÃ¼ yap ve ADDNEWPOS tetikle (SADECE BÄ°R KEZ)"""
        try:
            print("[RUNALL] ğŸ” runall_check_karbotu_and_addnewpos Ã‡AÄRILDI!")
            print(f"[RUNALL] ğŸ” DEBUG: runall_addnewpos_started={hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started}")
            
            # EÄŸer zaten baÅŸlatÄ±ldÄ±ysa tekrar Ã§alÄ±ÅŸtÄ±rma
            if hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started:
                print("[RUNALL] âš ï¸ ADDNEWPOS zaten baÅŸlatÄ±ldÄ±, tekrar tetiklenmeyecek")
                return
            
            # KARBOTU veya REDUCEMORE hala Ã§alÄ±ÅŸÄ±yorsa tekrar kontrol et
            karbotu_running = hasattr(self, 'karbotu_running') and self.karbotu_running
            reducemore_running = hasattr(self, 'reducemore_running') and self.reducemore_running
            print(f"[RUNALL] ğŸ” DEBUG: karbotu_running={karbotu_running}, reducemore_running={reducemore_running}")
            if karbotu_running or reducemore_running:
                print(f"[RUNALL] â³ KARBOTU/REDUCEMORE hala Ã§alÄ±ÅŸÄ±yor, 300ms sonra tekrar kontrol edilecek...")
                # 300ms sonra tekrar kontrol et (daha hÄ±zlÄ± - performans iÃ§in optimize)
                self.after(300, self.runall_check_karbotu_and_addnewpos)
                return
            
            # EÄŸer zaten tetiklendiyse (exposure kontrolÃ¼ yapÄ±lÄ±yor olabilir) tekrar baÅŸlatma
            if hasattr(self, 'runall_addnewpos_triggered') and self.runall_addnewpos_triggered:
                print("[RUNALL] âš ï¸ ADDNEWPOS zaten tetiklendi, exposure kontrolÃ¼ devam ediyor olabilir...")
                return
            
            # Flag'i set et (sadece bir kez exposure kontrolÃ¼ yapÄ±lmasÄ± iÃ§in)
            self.runall_addnewpos_triggered = True
            
            print("[RUNALL] âœ… runall_check_karbotu_and_addnewpos Ã‡AÄRILDI!")
            print("[RUNALL] ğŸ” KARBOTU/REDUCEMORE tamamlandÄ±, exposure kontrolÃ¼ yapÄ±lÄ±yor...")
            print(f"[RUNALL] ğŸ” DEBUG: karbotu_running={karbotu_running}, reducemore_running={reducemore_running}")
            print(f"[RUNALL] ğŸ” DEBUG: runall_addnewpos_triggered={hasattr(self, 'runall_addnewpos_triggered') and self.runall_addnewpos_triggered}")
            print(f"[RUNALL] ğŸ” DEBUG: runall_addnewpos_started={hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started}")
            print(f"[RUNALL] ğŸ” DEBUG: runall_waiting_for_karbotu={hasattr(self, 'runall_waiting_for_karbotu') and self.runall_waiting_for_karbotu}")
            self.log_message("ğŸ” KARBOTU/REDUCEMORE tamamlandÄ±, exposure kontrolÃ¼ yapÄ±lÄ±yor...")
            
            # Exposure kontrolÃ¼nÃ¼ thread'de yap (async - callback ile)
            def check_exposure_thread():
                try:
                    print("[RUNALL] ğŸ” Exposure kontrolÃ¼ baÅŸlatÄ±lÄ±yor...")
                    # Async exposure kontrolÃ¼ - callback ile sonuÃ§ al
                    exposure_result = {'ready': False}
                    def exposure_callback(exposure_info):
                        print(f"[RUNALL] âœ… Exposure callback Ã§aÄŸrÄ±ldÄ±: mode={exposure_info.get('mode')}, pot_total={exposure_info.get('pot_total')}")
                        exposure_result['info'] = exposure_info
                        exposure_result['ready'] = True
                    
                    print("[RUNALL] ğŸ” check_exposure_limits_async Ã§aÄŸrÄ±lÄ±yor...")
                    self.check_exposure_limits_async(callback=exposure_callback)
                    
                    # Sonucu bekle (ama UI'Ä± bloklamadan)
                    import time
                    timeout = 5  # 5 saniye timeout (daha hÄ±zlÄ±)
                    elapsed = 0
                    check_interval = 0.05  # 50ms bekle (daha sÄ±k kontrol - daha hÄ±zlÄ±)
                    print(f"[RUNALL] â³ Exposure kontrolÃ¼ baÅŸlatÄ±ldÄ±, timeout={timeout}s, check_interval={check_interval*1000}ms")
                    while not exposure_result['ready'] and elapsed < timeout:
                        time.sleep(check_interval)
                        elapsed += check_interval
                        if int(elapsed * 10) % 10 == 0:  # Her 0.5 saniyede bir log (daha az spam)
                            print(f"[RUNALL] â³ Exposure kontrolÃ¼ bekleniyor... ({elapsed:.1f}/{timeout}s)")
                    
                    if not exposure_result['ready']:
                        print(f"[RUNALL] âš ï¸ Exposure kontrolÃ¼ timeout! ({timeout} saniye) - Yine de devam ediliyor...")
                        # Timeout olsa bile devam et - exposure bilgisi olmadan da ADDNEWPOS baÅŸlatÄ±labilir
                        exposure_info = {'mode': 'OFANSIF', 'pot_total': 0, 'pot_max_lot': 63636, 'can_add_positions': True}
                        print("[RUNALL] âš ï¸ Timeout durumunda varsayÄ±lan deÄŸerler kullanÄ±lÄ±yor: mode=OFANSIF, can_add_positions=True")
                    else:
                        exposure_info = exposure_result['info']
                        print(f"[RUNALL] âœ… Exposure kontrolÃ¼ tamamlandÄ±: mode={exposure_info.get('mode')}, pot_total={exposure_info.get('pot_total')}")
                    pot_total = exposure_info.get('pot_total', 0)
                    pot_max_lot = exposure_info.get('pot_max_lot', 63636)
                    total_lots = exposure_info.get('total_lots', 0)
                    max_lot = exposure_info.get('max_lot', 54545)
                    mode = exposure_info.get('mode', 'UNKNOWN')
                    
                    # UI thread'ine geÃ§iÅŸ yaparak ADDNEWPOS kontrolÃ¼ yap (thread-safe)
                    def process_addnewpos_inner():
                        print(f"[RUNALL] âœ… process_addnewpos_inner Ã‡AÄRILDI!")
                        print(f"[RUNALL] ğŸ” DEBUG process_addnewpos_inner: mode={mode}, pot_total={pot_total}, pot_max_lot={pot_max_lot}")
                        print(f"[RUNALL] ğŸ” DEBUG: can_add_positions={exposure_info.get('can_add_positions', False)}")
                        # Pot Toplam kontrolÃ¼ - Limit dolduracak emirler var mÄ±?
                        if mode == "OFANSIF" and pot_total < pot_max_lot:
                            print(f"[RUNALL] âœ… ADDNEWPOS koÅŸulu saÄŸlandÄ±: mode=OFANSIF, pot_total={pot_total} < pot_max_lot={pot_max_lot}")
                            # EÄŸer zaten baÅŸlatÄ±ldÄ±ysa tekrar baÅŸlatma
                            if hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started:
                                print("[RUNALL] âš ï¸ ADDNEWPOS zaten baÅŸlatÄ±ldÄ±, tekrar tetiklenmeyecek")
                                self.log_message("âš ï¸ ADDNEWPOS zaten baÅŸlatÄ±ldÄ±, tekrar tetiklenmeyecek")
                                return
                            
                            available_lot = pot_max_lot - pot_total
                            print(f"[RUNALL] âœ… ADDNEWPOS tetikleniyor: Pot Toplam {pot_total:,} < Pot Max {pot_max_lot:,} (AÃ§Ä±labilir: {available_lot:,} lot)")
                            self.log_message(f"âœ… ADDNEWPOS tetikleniyor: Pot Toplam {pot_total:,} < Pot Max {pot_max_lot:,} (AÃ§Ä±labilir: {available_lot:,} lot)")
                            
                            # ADDNEWPOS'un baÅŸlatÄ±ldÄ±ÄŸÄ±nÄ± iÅŸaretle
                            self.runall_addnewpos_started = True
                            
                            # ADDNEWPOS'u otomatik baÅŸlat (RUNALL'dan Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nÄ± belirt)
                            # ADDNEWPOS bitince callback ekle
                            self.runall_addnewpos_callback_set = True
                            # Hemen baÅŸlat (200ms bekle - hÄ±zlÄ± geÃ§iÅŸ)
                            print("[RUNALL] â³ ADDNEWPOS 200ms sonra baÅŸlatÄ±lacak...")
                            self.after(200, lambda: self.start_addnewpos_automation(from_runall=True))
                            
                            # Timeout mekanizmasÄ±: EÄŸer ADDNEWPOS 5 dakika iÃ§inde tamamlanmazsa otomatik restart yap
                            def addnewpos_timeout():
                                # EÄŸer callback zaten tetiklendiyse (emirler gÃ¶nderildiyse) timeout'u iptal et
                                if hasattr(self, 'runall_addnewpos_callback_set') and not self.runall_addnewpos_callback_set:
                                    print("[RUNALL] â° ADDNEWPOS timeout: Callback zaten tetiklendi, timeout iptal edildi")
                                    return
                                
                                runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                                runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                                should_continue = runall_running or runall_allowed
                                
                                if should_continue:
                                    print("[RUNALL] â° ADDNEWPOS timeout (5 dakika): Emirler gÃ¶nderilmedi, 2 dakika bekleniyor, sonra restart yapÄ±lacak...")
                                    self.log_message("â° ADDNEWPOS timeout (5 dakika): Emirler gÃ¶nderilmedi, 2 dakika bekleniyor, sonra restart yapÄ±lacak...")
                                    # 2 dakika bekle, sonra emirleri iptal et
                                    self.after(120000, lambda: self.runall_cancel_orders_and_restart())
                            
                            # 5 dakika sonra timeout kontrolÃ¼ yap
                            self.after(300000, addnewpos_timeout)  # 5 dakika = 300000 ms
                        else:
                            print(f"[RUNALL] â„¹ï¸ ADDNEWPOS gerekmiyor: Mode={mode}, Pot Toplam={pot_total:,}, Pot Max={pot_max_lot:,}")
                            self.log_message(f"â„¹ï¸ ADDNEWPOS gerekmiyor: Mode={mode}, Pot Toplam={pot_total:,}, Pot Max={pot_max_lot:,}")
                            
                            # ADDNEWPOS gerekmiyorsa direkt Qpcal'i baÅŸlat
                            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                            should_continue = runall_running or runall_allowed
                            
                            if should_continue:
                                print("[RUNALL] ğŸ”„ ADDNEWPOS gerekmiyor, direkt Qpcal baÅŸlatÄ±lÄ±yor...")
                                self.log_message("ğŸ”„ ADDNEWPOS gerekmiyor, direkt Qpcal baÅŸlatÄ±lÄ±yor...")
                                # Qpcal'i baÅŸlat (2 dakika sayacÄ± Qpcal callback'inde baÅŸlatÄ±lacak)
                                self.after(2000, self.runall_execute_qpcal)
                            else:
                                print("[RUNALL] âš ï¸ RUNALL dÃ¶ngÃ¼sÃ¼ durdurulmuÅŸ, Qpcal baÅŸlatÄ±lmayacak")
                                self.log_message("âš ï¸ RUNALL dÃ¶ngÃ¼sÃ¼ durdurulmuÅŸ, Qpcal baÅŸlatÄ±lmayacak")
                        
                        print("[RUNALL] âœ… RUNALL sÄ±rasÄ± tamamlandÄ±!")
                        self.log_message("âœ… RUNALL sÄ±rasÄ± tamamlandÄ±!")
                        
                        # RevOrderMod kontrolÃ¼ (eÄŸer aktifse)
                        if hasattr(self, 'revorder_mod_var') and self.revorder_mod_var.get():
                            print("[RUNALL] ğŸ”„ RevOrderMod aktif, RevOrder kontrolÃ¼ yapÄ±lÄ±yor...")
                            self.log_message("ğŸ”„ RevOrderMod aktif, RevOrder kontrolÃ¼ yapÄ±lÄ±yor...")
                            self.after(2000, self.check_and_open_revorders)  # 2 saniye sonra kontrol et
                    
                    # UI thread'ine geÃ§iÅŸ yap (thread-safe - bot iÅŸlemleri normal Ã¶ncelikli queue'ya gider)
                    self.safe_ui_call(process_addnewpos_inner)
                    
                except Exception as e:
                    print(f"[RUNALL] âŒ Exposure kontrolÃ¼ hatasÄ±: {e}")
                    self.log_message(f"âŒ Exposure kontrolÃ¼ hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
            
            # Exposure kontrolÃ¼nÃ¼ thread'de baÅŸlat
            import threading
            exposure_thread = threading.Thread(target=check_exposure_thread, daemon=True)
            exposure_thread.start()
            
            # Not: ADDNEWPOS emirleri gÃ¶nderildikten sonra callback final_thg_lot_distributor.py'de tetiklenecek
            
        except Exception as e:
            print(f"[RUNALL] âŒ KARBOTU sonrasÄ± kontrol hatasÄ±: {e}")
            self.log_message(f"âŒ KARBOTU sonrasÄ± kontrol hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def runall_cancel_orders_and_restart(self):
        """RUNALL dÃ¶ngÃ¼sÃ¼: TÃ¼m emirleri iptal et ve tekrar baÅŸla (thread'de Ã§alÄ±ÅŸÄ±r)"""
        print("[RUNALL] ğŸ—‘ï¸ Emir iptal iÅŸlemi baÅŸlatÄ±lÄ±yor...")
        self.log_message("ğŸ—‘ï¸ Emir iptal iÅŸlemi baÅŸlatÄ±lÄ±yor...")
        
        # Restart flag'ini initialize et
        self._runall_restart_pending = False
        
        def cancel_orders_thread():
            """Emir iptal iÅŸlemini thread'de yap"""
            try:
                print("[RUNALL] ğŸ—‘ï¸ TÃ¼m emirleri iptal ediliyor...")
                self.log_message("ğŸ—‘ï¸ TÃ¼m emirleri iptal ediliyor...")
                
                # Aktif modu kontrol et
                if hasattr(self, 'mode_manager'):
                    active_account = self.mode_manager.get_active_account()
                else:
                    if self.hampro_mode:
                        active_account = "HAMPRO"
                    elif self.ibkr_gun_mode:
                        active_account = "IBKR_GUN"
                    elif self.ibkr_ped_mode:
                        active_account = "IBKR_PED"
                    else:
                        active_account = "HAMPRO"
                
                # IBKR modunda: DoÄŸrudan tÃ¼m emirleri iptal et (pencere aÃ§madan)
                if active_account in ["IBKR_GUN", "IBKR_PED"]:
                    try:
                        print("[RUNALL] ğŸ—‘ï¸ IBKR emirleri doÄŸrudan iptal ediliyor...")
                        self.log_message("ğŸ—‘ï¸ IBKR emirleri doÄŸrudan iptal ediliyor...")
                        
                        # IBKR client'Ä± al
                        ibkr_client = None
                        if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                            ibkr_client = self.mode_manager.ibkr_native_client
                        elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                            ibkr_client = self.mode_manager.ibkr_client
                        
                        if ibkr_client and ibkr_client.is_connected():
                            # AÃ§Ä±k emirleri al
                            try:
                                open_orders = []
                                if hasattr(ibkr_client, 'get_open_orders'):
                                    open_orders = ibkr_client.get_open_orders()
                                elif hasattr(ibkr_client, 'get_orders_direct'):
                                    open_orders = ibkr_client.get_orders_direct()
                            except Exception as e:
                                print(f"[RUNALL] âš ï¸ Emir alma hatasÄ±: {e}")
                                open_orders = []
                            
                            if open_orders:
                                print(f"[RUNALL] ğŸ“Š {len(open_orders)} aÃ§Ä±k emir bulundu, iptal ediliyor...")
                                cancel_count = 0
                                for order in open_orders:
                                    # DÃ¶ngÃ¼ durdurulmuÅŸsa Ã§Ä±k (ama runall_allowed_mode aktifse devam et)
                                    runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                                    runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                                    if not runall_running and not runall_allowed:
                                        print("[RUNALL] â¹ï¸ DÃ¶ngÃ¼ durduruldu, emir iptal iÅŸlemi durduruluyor")
                                        break
                                    
                                    try:
                                        order_id = order.get('order_id') or order.get('orderId')
                                        if order_id:
                                            if hasattr(ibkr_client, 'cancelOrder'):
                                                ibkr_client.cancelOrder(int(order_id))
                                            elif hasattr(ibkr_client, 'cancel_order'):
                                                ibkr_client.cancel_order(order_id)
                                            cancel_count += 1
                                            print(f"[RUNALL] ğŸ“¤ Ä°ptal isteÄŸi gÃ¶nderildi: {order_id}")
                                    except Exception as e:
                                        print(f"[RUNALL] âš ï¸ Emir iptal hatasÄ±: {e}")
                                
                                print(f"[RUNALL] âœ… {cancel_count} emir iptal isteÄŸi gÃ¶nderildi")
                            else:
                                print("[RUNALL] â„¹ï¸ Ä°ptal edilecek emir bulunamadÄ±")
                        else:
                            print("[RUNALL] âŒ IBKR baÄŸlantÄ±sÄ± yok")
                        
                    except Exception as e:
                        print(f"[RUNALL] âŒ IBKR emir iptal hatasÄ±: {e}")
                        self.log_message(f"âŒ IBKR emir iptal hatasÄ±: {e}")
                
                # HAMPRO modunda: DoÄŸrudan tÃ¼m emirleri iptal et (pencere aÃ§madan)
                else:  # HAMPRO
                    try:
                        print("[RUNALL] ğŸ—‘ï¸ HAMPRO emirleri doÄŸrudan iptal ediliyor...")
                        self.log_message("ğŸ—‘ï¸ HAMPRO emirleri doÄŸrudan iptal ediliyor...")
                        
                        if self.hammer and self.hammer.connected:
                            try:
                                open_orders = self.hammer.get_orders_direct() if hasattr(self.hammer, 'get_orders_direct') else []
                            except Exception as e:
                                print(f"[RUNALL] âš ï¸ Emir alma hatasÄ±: {e}")
                                open_orders = []
                            
                            if open_orders:
                                print(f"[RUNALL] ğŸ“Š {len(open_orders)} aÃ§Ä±k emir bulundu, iptal ediliyor...")
                                cancel_count = 0
                                for order in open_orders:
                                    # DÃ¶ngÃ¼ durdurulmuÅŸsa Ã§Ä±k (ama runall_allowed_mode aktifse devam et)
                                    runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                                    runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                                    if not runall_running and not runall_allowed:
                                        print("[RUNALL] â¹ï¸ DÃ¶ngÃ¼ durduruldu, emir iptal iÅŸlemi durduruluyor")
                                        break
                                    
                                    try:
                                        order_id = order.get('order_id') or order.get('orderId')
                                        if order_id:
                                            if hasattr(self.hammer, 'trade_command_cancel'):
                                                self.hammer.trade_command_cancel("ALARIC:TOPI002240A7", order_id)
                                            cancel_count += 1
                                            print(f"[RUNALL] ğŸ“¤ Ä°ptal isteÄŸi gÃ¶nderildi: {order_id}")
                                    except Exception as e:
                                        print(f"[RUNALL] âš ï¸ Emir iptal hatasÄ±: {e}")
                                
                                print(f"[RUNALL] âœ… {cancel_count} emir iptal isteÄŸi gÃ¶nderildi")
                            else:
                                print("[RUNALL] â„¹ï¸ Ä°ptal edilecek emir bulunamadÄ±")
                        else:
                            print("[RUNALL] âŒ HAMPRO baÄŸlantÄ±sÄ± yok")
                        
                    except Exception as e:
                        print(f"[RUNALL] âŒ HAMPRO emir iptal hatasÄ±: {e}")
                        self.log_message(f"âŒ HAMPRO emir iptal hatasÄ±: {e}")
                
                # Thread'den UI thread'ine geÃ§iÅŸ yaparak restart'Ä± baÅŸlat (non-blocking)
                print("[RUNALL] âœ… Emir iptal iÅŸlemi tamamlandÄ±, restart flag'i set edildi...")
                self.log_message("âœ… Emir iptal iÅŸlemi tamamlandÄ±, restart flag'i set edildi...")
                
                # Thread iÃ§inde widget metodlarÄ±nÄ± Ã§aÄŸÄ±rmak thread-safe deÄŸil
                # Bunun yerine flag set edelim ve ana thread'de kontrol edelim
                # Flag'i set et (restart iÃ§in)
                self._runall_restart_pending = True
                print("[RUNALL] âœ… _runall_restart_pending flag'i True yapÄ±ldÄ±")
                
            except Exception as e:
                print(f"[RUNALL] âŒ Emir iptal ve restart hatasÄ±: {e}")
                self.log_message(f"âŒ Emir iptal ve restart hatasÄ±: {e}")
                import traceback
                traceback.print_exc()
                # Hata olsa bile devam et - UI thread'ine geÃ§iÅŸ yap
                try:
                    # after_idle() kullan (thread-safe)
                    self.after_idle(lambda: self.runall_close_orders_window_and_restart(None))
                except:
                    try:
                        self.after(0, lambda: self.runall_close_orders_window_and_restart(None))
                    except:
                        # HiÃ§biri Ã§alÄ±ÅŸmazsa direkt Ã§aÄŸÄ±r
                        try:
                            self.runall_close_orders_window_and_restart(None)
                        except:
                            pass
        
        # Emir iptal iÅŸlemini thread'de baÅŸlat
        import threading
        thread = threading.Thread(target=cancel_orders_thread, daemon=True)
        thread.start()
        
        # Thread bitince restart yapmak iÃ§in kontrol dÃ¶ngÃ¼sÃ¼ baÅŸlat
        def check_thread_and_restart():
            # runall_allowed_mode aktifse veya _runall_restart_pending True ise devam et
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            restart_pending = hasattr(self, '_runall_restart_pending') and self._runall_restart_pending
            
            print(f"[RUNALL] ğŸ” check_thread_and_restart: restart_pending={restart_pending}, runall_allowed={runall_allowed}, runall_running={runall_running}, thread.is_alive()={thread.is_alive()}")
            
            # EÄŸer ne flag set edilmiÅŸ ne de runall_allowed_mode aktifse Ã§Ä±k
            if not restart_pending and not runall_allowed:
                print(f"[RUNALL] â¹ï¸ Restart flag'i set edilmemiÅŸ ve runall_allowed_mode aktif deÄŸil, restart yapÄ±lmayacak")
                return
            
            # Thread hala Ã§alÄ±ÅŸÄ±yor mu kontrol et
            if thread.is_alive():
                # Thread hala Ã§alÄ±ÅŸÄ±yor, tekrar kontrol et
                self.after(500, check_thread_and_restart)
                return
            
            # Thread bitti, restart yap
            print("[RUNALL] âœ… Thread tamamlandÄ±, restart baÅŸlatÄ±lÄ±yor...")
            self.log_message("âœ… Thread tamamlandÄ±, restart baÅŸlatÄ±lÄ±yor...")
            self._runall_restart_pending = False
            
            # runall_allowed_mode aktifse runall_loop_running'i True yap
            if runall_allowed and not runall_running:
                self.runall_loop_running = True
                print("[RUNALL] âœ… runall_loop_running True yapÄ±ldÄ± (runall_allowed_mode aktif)")
            
            self.runall_close_orders_window_and_restart(None)
        
        # Ä°lk kontrolÃ¼ baÅŸlat (500ms sonra)
        self.after(500, check_thread_and_restart)
    
    def start_runall_auto_confirm_loop(self):
        """RUNALL Allowed modunda otomatik onay dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat"""
        if not self.runall_allowed_mode or not self.runall_loop_running:
            return
        
        # TÄ±klanmÄ±ÅŸ butonlarÄ± ve kapatÄ±lmÄ±ÅŸ pencereleri takip et (tekrar tÄ±klamayÄ± Ã¶nlemek iÃ§in)
        if not hasattr(self, '_clicked_buttons'):
            self._clicked_buttons = set()
        if not hasattr(self, '_closed_windows'):
            self._closed_windows = set()
        
        # Her 1 saniyede bir onay mesajlarÄ±nÄ± kontrol et (500ms'den 1 saniyeye Ã§Ä±karÄ±ldÄ± - performans iÃ§in)
        self.runall_auto_confirm_messagebox()
        self.after(1000, self.start_runall_auto_confirm_loop)  # 500ms'den 1000ms'ye Ã§Ä±karÄ±ldÄ±
    
    def runall_auto_confirm_messagebox(self):
        """Onay mesajlarÄ±nÄ± otomatik olarak kabul et (Evet/Yes butonuna tÄ±kla)"""
        if not self.runall_allowed_mode:
            return
        
        # TÄ±klanmÄ±ÅŸ butonlarÄ± ve kapatÄ±lmÄ±ÅŸ pencereleri takip et (tekrar tÄ±klamayÄ± Ã¶nlemek iÃ§in)
        if not hasattr(self, '_clicked_buttons'):
            self._clicked_buttons = set()
        if not hasattr(self, '_closed_windows'):
            self._closed_windows = set()
        
        try:
            # TÃ¼m Toplevel pencereleri bul (daha agresif yÃ¶ntem)
            all_toplevels = []
            
            # Ana pencereden baÅŸla
            try:
                for widget in self.winfo_children():
                    if isinstance(widget, tk.Toplevel):
                        all_toplevels.append(widget)
            except:
                pass
            
            # Psfalgo penceresinden
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        for widget in self.psfalgo_window.winfo_children():
                            if isinstance(widget, tk.Toplevel):
                                all_toplevels.append(widget)
                except:
                    pass
            
            # Take Profit pencerelerinden (direkt olarak ekle - win zaten bir Toplevel)
            if hasattr(self, 'take_profit_longs_panel') and hasattr(self.take_profit_longs_panel, 'win'):
                try:
                    if self.take_profit_longs_panel.win.winfo_exists():
                        if self.take_profit_longs_panel.win not in all_toplevels:
                            all_toplevels.append(self.take_profit_longs_panel.win)
                            print(f"[RUNALL] âœ… Take Profit Longs penceresi eklendi: '{self.take_profit_longs_panel.win.title()}'")
                except Exception as e:
                    print(f"[RUNALL] âš ï¸ Take Profit Longs penceresi eklenirken hata: {e}")
            
            if hasattr(self, 'take_profit_shorts_panel') and hasattr(self.take_profit_shorts_panel, 'win'):
                try:
                    if self.take_profit_shorts_panel.win.winfo_exists():
                        if self.take_profit_shorts_panel.win not in all_toplevels:
                            all_toplevels.append(self.take_profit_shorts_panel.win)
                            print(f"[RUNALL] âœ… Take Profit Shorts penceresi eklendi: '{self.take_profit_shorts_panel.win.title()}'")
                except Exception as e:
                    print(f"[RUNALL] âš ï¸ Take Profit Shorts penceresi eklenirken hata: {e}")
            
            # TÃ¼m aÃ§Ä±k Toplevel pencereleri bul (recursive)
            def find_all_toplevels(parent, found_list, depth=0):
                if depth > 5:  # Recursion limit
                    return
                try:
                    for widget in parent.winfo_children():
                        if isinstance(widget, tk.Toplevel):
                            if widget not in found_list:
                                found_list.append(widget)
                            find_all_toplevels(widget, found_list, depth + 1)
                        else:
                            find_all_toplevels(widget, found_list, depth + 1)
                except:
                    pass
            
            find_all_toplevels(self, all_toplevels)
            
            # TÃ¼m butonlarÄ± recursive olarak bul (fonksiyon tanÄ±mÄ±)
            def find_all_buttons_recursive(widget, buttons_list, depth=0):
                if depth > 15:  # Recursion limit
                    return
                try:
                    for child in widget.winfo_children():
                        try:
                            if isinstance(child, (tk.Button, ttk.Button)):
                                buttons_list.append(child)
                            find_all_buttons_recursive(child, buttons_list, depth + 1)
                        except:
                            pass
                except:
                    pass
            
            # Her Toplevel penceresinde buton ara
            for toplevel in all_toplevels:
                try:
                    # Pencere hala var mÄ± kontrol et
                    if not toplevel.winfo_exists():
                        continue
                    
                    title = toplevel.title().lower()
                    
                    # "Emir Sonucu" ve "BaÅŸarÄ±lÄ±" (TUMCSV) pencerelerini Ã¶zel olarak kontrol et
                    if 'emir sonucu' in title or ('baÅŸarÄ±lÄ±' in title):
                        # Bu pencere zaten kapatÄ±ldÄ± mÄ± kontrol et
                        window_id = id(toplevel)
                        if window_id in self._closed_windows:
                            continue  # Zaten kapatÄ±ldÄ±, atla
                        
                        # TUMCSV popup'Ä± kontrol et
                        is_tumcsv_popup = False
                        try:
                            # Pencere iÃ§eriÄŸini kontrol et
                            for widget in toplevel.winfo_children():
                                try:
                                    widget_text = str(widget).lower()
                                    if 'tumcsv' in widget_text or 'ayarlamasÄ±' in widget_text:
                                        is_tumcsv_popup = True
                                        break
                                    # Label'larÄ± kontrol et
                                    if isinstance(widget, (tk.Label, ttk.Label)):
                                        label_text = widget.cget('text').lower() if hasattr(widget, 'cget') else ''
                                        if 'tumcsv' in label_text or 'ayarlamasÄ±' in label_text:
                                            is_tumcsv_popup = True
                                            break
                                except:
                                    pass
                        except:
                            pass
                        
                        print(f"[RUNALL] ğŸ” Popup penceresi bulundu: {toplevel.title()} (TUMCSV: {is_tumcsv_popup})")
                        buttons = []
                        find_all_buttons_recursive(toplevel, buttons)
                        # "Tamam" butonunu bul ve tÄ±kla
                        for btn in buttons:
                            try:
                                if not btn.winfo_exists():
                                    continue
                                
                                # Bu buton zaten tÄ±klandÄ± mÄ± kontrol et
                                button_id = id(btn)
                                if button_id in self._clicked_buttons:
                                    continue  # Zaten tÄ±klandÄ±, atla
                                
                                text = str(btn.cget('text')).lower().strip()
                                if 'tamam' in text or 'ok' in text:
                                    print(f"[RUNALL] âœ… Popup penceresindeki '{text}' butonu bulundu, tÄ±klanÄ±yor... ({toplevel.title()})")
                                    # Butonu iÅŸaretle (tekrar tÄ±klanmasÄ±n)
                                    self._clicked_buttons.add(button_id)
                                    btn.invoke()
                                    # Pencereyi de kapat ve iÅŸaretle
                                    try:
                                        if toplevel.winfo_exists():
                                            toplevel.destroy()
                                            self._closed_windows.add(window_id)
                                    except:
                                        pass
                                    break
                            except:
                                pass
                        continue  # Bu pencereyi iÅŸledik, diÄŸerlerine geÃ§
                    
                    buttons = []
                    find_all_buttons_recursive(toplevel, buttons)
                    
                    # Debug: Take Profit pencerelerinde buton sayÄ±sÄ±nÄ± logla (SADECE Ä°LK KEZ - gereksiz log spam'ini Ã¶nlemek iÃ§in)
                    # LoglarÄ± kaldÄ±rdÄ±k - performans iÃ§in
                    # if 'take profit' in title.lower():
                    #     print(f"[RUNALL] ğŸ” Take Profit penceresi bulundu: '{title}' - {len(buttons)} buton bulundu")
                    
                    # EÄŸer pencere zaten kapatÄ±ldÄ±ysa atla
                    window_id = id(toplevel)
                    if window_id in self._closed_windows:
                        continue
                    
                    # EÄŸer sadece 1 buton varsa, ne olduÄŸuna bakmaksÄ±zÄ±n tÄ±kla (tek seÃ§enekli mesaj kutusu)
                    if len(buttons) == 1:
                        btn = buttons[0]
                        try:
                            if not btn.winfo_exists():
                                continue
                            
                            # Bu buton zaten tÄ±klandÄ± mÄ± kontrol et
                            button_id = id(btn)
                            if button_id in self._clicked_buttons:
                                continue  # Zaten tÄ±klandÄ±, atla
                            
                            text = str(btn.cget('text')).lower().strip()
                            print(f"[RUNALL] âœ… Tek seÃ§enekli mesaj kutusu bulundu: '{text}' (Pencere: '{title}'), tÄ±klanÄ±yor...")
                            self.log_message(f"âœ… Otomatik onay (tek seÃ§enek): '{text}' ({title})")
                            
                            # Butonu iÅŸaretle (tekrar tÄ±klanmasÄ±n)
                            self._clicked_buttons.add(button_id)
                            
                            # Butonu tÄ±kla
                            try:
                                btn.invoke()
                                self.after(100, lambda: None)
                                
                                # Pencere kapatÄ±ldÄ±ysa iÅŸaretle
                                try:
                                    if not toplevel.winfo_exists():
                                        self._closed_windows.add(window_id)
                                except:
                                    pass
                            except:
                                # invoke Ã§alÄ±ÅŸmazsa event_generate dene
                                try:
                                    btn.event_generate('<Button-1>')
                                    self.after(100, lambda: None)
                                    
                                    # Pencere kapatÄ±ldÄ±ysa iÅŸaretle
                                    try:
                                        if not toplevel.winfo_exists():
                                            self._closed_windows.add(window_id)
                                    except:
                                        pass
                                except:
                                    pass
                            
                            continue  # Bu pencereyi iÅŸledik, diÄŸerlerine geÃ§
                        except Exception as e:
                            pass
                    
                    # Birden fazla buton varsa, onay butonlarÄ±nÄ± ara
                    # Her butonu kontrol et
                    for btn in buttons:
                        try:
                            if not btn.winfo_exists():
                                continue
                            
                            text = str(btn.cget('text')).lower().strip()
                            
                            # Onay butonlarÄ± iÃ§in geniÅŸletilmiÅŸ keyword listesi
                            confirm_keywords = [
                                'ok', 'tamam', 'yes', 'evet', 'kabul', 'accept', 'onayla', 'confirm',
                                'gÃ¶nder', 'send', 'emirleri gÃ¶nder', 'okay', 'devam', 'continue',
                                'ilerle', 'proceed', 'baÅŸlat', 'start', 'Ã§alÄ±ÅŸtÄ±r', 'run'
                            ]
                            
                            # Ã–NEMLÄ°: Durdur/Stop butonlarÄ±nÄ± ASLA tÄ±klama! (ama "emirleri gÃ¶nder" deÄŸil!)
                            stop_keywords = ['durdur', 'stop', 'dur', 'iptal', 'cancel', 'reddet', 'no', 'hayÄ±r', 'kapat', 'close', 'exit', 'Ã§Ä±k']
                            # "emirleri gÃ¶nder" butonunda "durdur" yok, bu yÃ¼zden tÄ±klanmalÄ±
                            if any(stop_keyword in text for stop_keyword in stop_keywords) and 'gÃ¶nder' not in text:
                                continue  # Bu butonlarÄ± ASLA tÄ±klama! (ama "gÃ¶nder" iÃ§erenler hariÃ§)
                            
                            # Debug: Buton text'ini kontrol et
                            matched_keyword = None
                            for keyword in confirm_keywords:
                                if keyword in text:
                                    matched_keyword = keyword
                                    break
                            
                            if matched_keyword:
                                print(f"[RUNALL] ğŸ” Buton eÅŸleÅŸti: '{text}' â†’ keyword: '{matched_keyword}'")
                            
                            if any(keyword in text for keyword in confirm_keywords):
                                # Ä°ptal/Reddet butonlarÄ±nÄ± atla (ekstra kontrol)
                                if any(cancel_keyword in text for cancel_keyword in ['iptal', 'cancel', 'reddet', 'no', 'hayÄ±r', 'kapat', 'close']):
                                    continue
                                
                                # Bu buton zaten tÄ±klandÄ± mÄ± kontrol et
                                button_id = id(btn)
                                if button_id in self._clicked_buttons:
                                    continue  # Zaten tÄ±klandÄ±, atla
                                
                                # Bu pencere zaten kapatÄ±ldÄ± mÄ± kontrol et
                                if window_id in self._closed_windows:
                                    continue  # Pencere zaten kapatÄ±ldÄ±, atla
                                
                                # Buton disabled mÄ± kontrol et
                                try:
                                    btn_state = str(btn.cget('state')).lower()
                                    if btn_state == 'disabled':
                                        print(f"[RUNALL] âš ï¸ Buton disabled: '{text}' (Pencere: '{title}') - TÄ±klama atlanÄ±yor")
                                        continue
                                except:
                                    pass
                                
                                print(f"[RUNALL] âœ… Onay butonu bulundu: '{text}' (Pencere: '{title}'), tÄ±klanÄ±yor...")
                                self.log_message(f"âœ… Otomatik onay: '{text}' ({title})")
                                
                                # Butonu iÅŸaretle (tekrar tÄ±klanmasÄ±n)
                                self._clicked_buttons.add(button_id)
                                
                                # Butonu tÄ±kla
                                try:
                                    print(f"[RUNALL] ğŸ”˜ Buton invoke() Ã§aÄŸrÄ±lÄ±yor: '{text}'")
                                    btn.invoke()
                                    print(f"[RUNALL] âœ… Buton invoke() baÅŸarÄ±lÄ±: '{text}'")
                                    # invoke sonrasÄ± kÄ±sa bir bekleme ekle
                                    self.after(100, lambda: None)
                                    
                                    # Pencere kapatÄ±ldÄ±ysa iÅŸaretle
                                    try:
                                        if not toplevel.winfo_exists():
                                            self._closed_windows.add(window_id)
                                    except:
                                        pass
                                except Exception as invoke_error:
                                    print(f"[RUNALL] âš ï¸ invoke() hatasÄ±: {invoke_error} - event_generate deneniyor...")
                                    # invoke Ã§alÄ±ÅŸmazsa event_generate dene
                                    try:
                                        btn.event_generate('<Button-1>')
                                        print(f"[RUNALL] âœ… event_generate baÅŸarÄ±lÄ±: '{text}'")
                                        self.after(100, lambda: None)
                                        
                                        # Pencere kapatÄ±ldÄ±ysa iÅŸaretle
                                        try:
                                            if not toplevel.winfo_exists():
                                                self._closed_windows.add(window_id)
                                        except:
                                            pass
                                    except:
                                        pass
                                
                                # Bir buton bulundu ve tÄ±klandÄ±, diÄŸerlerini kontrol etmeye devam et
                                break
                        except Exception as e:
                            continue
                            
                except Exception as e:
                    continue
            
            # Ek olarak: Tkinter'Ä±n messagebox'larÄ±nÄ± bulmak iÃ§in Ã¶zel bir yÃ¶ntem
            # Messagebox'lar genellikle boÅŸ baÅŸlÄ±klÄ± Toplevel pencereler olarak oluÅŸturulur
            try:
                # TÃ¼m widget'larÄ± tarayarak messagebox benzeri pencereleri bul
                def find_messagebox_windows(parent, found_list, depth=0):
                    if depth > 10:
                        return
                    try:
                        for widget in parent.winfo_children():
                            if isinstance(widget, tk.Toplevel):
                                try:
                                    title = widget.title()
                                    # BoÅŸ baÅŸlÄ±k veya bilgi mesajÄ± iÃ§eren pencereler
                                    if title == '' or any(keyword in title.lower() for keyword in ['bilgi', 'info', 'onay', 'confirm', 'uyarÄ±', 'warning']):
                                        if widget not in found_list:
                                            found_list.append(widget)
                                except:
                                    pass
                            find_messagebox_windows(widget, found_list, depth + 1)
                    except:
                        pass
                
                messagebox_windows = []
                find_messagebox_windows(self, messagebox_windows)
                
                # Messagebox pencerelerindeki butonlarÄ± bul
                for mb_window in messagebox_windows:
                    try:
                        if not mb_window.winfo_exists():
                            continue
                        
                        # TÃ¼m butonlarÄ± bul
                        mb_buttons = []
                        find_all_buttons_recursive(mb_window, mb_buttons)
                        
                        for btn in mb_buttons:
                            try:
                                # Bu buton zaten tÄ±klandÄ± mÄ± kontrol et
                                button_id = id(btn)
                                if button_id in self._clicked_buttons:
                                    continue  # Zaten tÄ±klandÄ±, atla
                                
                                text = str(btn.cget('text')).lower().strip()
                                if any(keyword in text for keyword in ['ok', 'tamam', 'yes', 'evet', 'kabul', 'accept']):
                                    if not any(cancel_keyword in text for cancel_keyword in ['iptal', 'cancel', 'reddet', 'no', 'hayÄ±r']):
                                        print(f"[RUNALL] âœ… Messagebox butonu bulundu: '{text}', tÄ±klanÄ±yor...")
                                        self.log_message(f"âœ… Otomatik onay (messagebox): '{text}'")
                                        
                                        # Butonu iÅŸaretle (tekrar tÄ±klanmasÄ±n)
                                        self._clicked_buttons.add(button_id)
                                        
                                        try:
                                            btn.invoke()
                                            self.after(100, lambda: None)
                                            
                                            # Pencere kapatÄ±ldÄ±ysa iÅŸaretle
                                            try:
                                                if not mb_window.winfo_exists():
                                                    self._closed_windows.add(id(mb_window))
                                            except:
                                                pass
                                        except:
                                            try:
                                                btn.event_generate('<Button-1>')
                                                self.after(100, lambda: None)
                                                
                                                # Pencere kapatÄ±ldÄ±ysa iÅŸaretle
                                                try:
                                                    if not mb_window.winfo_exists():
                                                        self._closed_windows.add(id(mb_window))
                                                except:
                                                    pass
                                            except:
                                                pass
                                        break
                            except:
                                continue
                    except:
                        continue
            except:
                pass
            
        except Exception as e:
            print(f"[RUNALL] âš ï¸ Onay mesajÄ± bulma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def on_addnewpos_mode_changed(self):
        """ADDNEWPOS mod deÄŸiÅŸikliÄŸi callback'i
        
        Modlar:
        - addlong_only: Sadece BB Long iÅŸlemleri (varsayÄ±lan, mevcut davranÄ±ÅŸ)
        - addshort_only: Sadece FB Short iÅŸlemleri (henÃ¼z aktif deÄŸil)
        - addboth: Hem BB Long hem FB Short iÅŸlemleri (henÃ¼z aktif deÄŸil)
        """
        try:
            mode = self.addnewpos_mode_var.get()
            
            mode_display = {
                'addlong_only': 'ğŸ“ˆ AddLong Only (Sadece BB Long)',
                'addshort_only': 'ğŸ“‰ AddShort Only (Sadece FB Short)',
                'addboth': 'ğŸ”„ AddBoth (Hem Long hem Short)'
            }
            
            print(f"[ADDNEWPOS] ğŸ”„ Mod deÄŸiÅŸti: {mode_display.get(mode, mode)}")
            self.log_message(f"ğŸ”„ ADDNEWPOS Mod: {mode_display.get(mode, mode)}")
            
            # Åu an sadece addlong_only aktif
            if mode != 'addlong_only':
                print(f"[ADDNEWPOS] âš ï¸ {mode} modu henÃ¼z aktif deÄŸil, sadece seÃ§im yapÄ±ldÄ±")
            
        except Exception as e:
            print(f"[ADDNEWPOS] âŒ Mod deÄŸiÅŸikliÄŸi hatasÄ±: {e}")
    
    def get_addnewpos_mode(self):
        """Mevcut ADDNEWPOS modunu dÃ¶ndÃ¼r
        
        Returns:
            str: 'addlong_only', 'addshort_only' veya 'addboth'
        """
        if hasattr(self, 'addnewpos_mode_var'):
            return self.addnewpos_mode_var.get()
        return 'addlong_only'  # VarsayÄ±lan
    
    def stop_runall_loop(self, from_automation=False):
        """RUNALL dÃ¶ngÃ¼sÃ¼nÃ¼ durdur (SADECE KULLANICI TARAFINDAN Ã‡AÄRILMALI)"""
        try:
            # Otomatik Ã§aÄŸrÄ±ldÄ±ysa (bot tarafÄ±ndan) durdurma
            if from_automation:
                print("[RUNALL] âš ï¸ RUNALL durdur butonu otomatik tÄ±klandÄ±, IGNORE ediliyor!")
                return  # Otomatik tÄ±klama, durdurma
            
            print("[RUNALL] â¹ï¸ RUNALL dÃ¶ngÃ¼sÃ¼ durduruluyor...")
            self.log_message("â¹ï¸ RUNALL dÃ¶ngÃ¼sÃ¼ durduruluyor...")
            
            # DÃ¶ngÃ¼ flag'ini hemen False yap
            self.runall_loop_running = False
            
            # TÃ¼m pending after Ã§aÄŸrÄ±larÄ±nÄ± iptal etmek iÃ§in bir mekanizma yok ama
            # en azÄ±ndan flag'i kontrol ederek yeni iÅŸlemlerin baÅŸlamasÄ±nÄ± engelleyebiliriz
            
            # Buton metnini gÃ¼ncelle
            if hasattr(self, 'runall_btn'):
                self.runall_btn.config(text="â–¶ï¸ RUNALL", state='normal')
                self.runall_btn.config(style='Accent.TButton')
            if hasattr(self, 'runall_stop_btn'):
                self.runall_stop_btn.config(state='disabled')
            
            # Flag'leri resetle
            self.runall_addnewpos_triggered = False
            self.runall_addnewpos_started = False
            self.runall_waiting_for_karbotu = False
            self.runall_addnewpos_callback_set = False
            
            print("[RUNALL] âœ… RUNALL dÃ¶ngÃ¼sÃ¼ durduruldu")
            self.log_message("âœ… RUNALL dÃ¶ngÃ¼sÃ¼ durduruldu")
            
        except Exception as e:
            print(f"[RUNALL] âŒ Durdurma hatasÄ±: {e}")
            self.log_message(f"âŒ Durdurma hatasÄ±: {e}")
    
    def runall_close_orders_window_and_restart(self, orders_window):
        """Emirlerim penceresini kapat ve RUNALL dÃ¶ngÃ¼sÃ¼nÃ¼ tekrar baÅŸlat"""
        try:
            # DÃ¶ngÃ¼ durdurulmuÅŸsa devam etme (ama runall_allowed_mode aktifse devam et)
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            if not runall_running and not runall_allowed:
                print("[RUNALL] â¹ï¸ DÃ¶ngÃ¼ durdurulmuÅŸ, tekrar baÅŸlatÄ±lmayacak")
                self.log_message("â¹ï¸ DÃ¶ngÃ¼ durdurulmuÅŸ, tekrar baÅŸlatÄ±lmayacak")
                return
            
            # runall_allowed_mode aktifse runall_loop_running'i True yap
            if runall_allowed and not runall_running:
                self.runall_loop_running = True
                print("[RUNALL] âœ… runall_loop_running True yapÄ±ldÄ± (runall_allowed_mode aktif)")
            
            # Pencereyi kapat
            if orders_window:
                try:
                    orders_window.destroy()
                except:
                    pass
            
            # Tamamlanan dÃ¶ngÃ¼ sayÄ±sÄ±nÄ± gÃ¶ster (mevcut dÃ¶ngÃ¼ sayacÄ± - 1, Ã§Ã¼nkÃ¼ yeni dÃ¶ngÃ¼ henÃ¼z baÅŸlamadÄ±)
            completed_loops = self.runall_loop_count - 1 if hasattr(self, 'runall_loop_count') else 0
            
            print(f"[RUNALL] âœ… {completed_loops}. dÃ¶ngÃ¼ tamamlandÄ±! Emirler iptal edildi, yeni dÃ¶ngÃ¼ baÅŸlatÄ±lÄ±yor...")
            self.log_message(f"âœ… {completed_loops}. dÃ¶ngÃ¼ tamamlandÄ±! Emirler iptal edildi, yeni dÃ¶ngÃ¼ baÅŸlatÄ±lÄ±yor...")
            
            # DÃ¶ngÃ¼ tamamlandÄ±ÄŸÄ±nda Alg Raporu'nu CSV'ye kaydet (algraporu.csv - overwrite)
            try:
                self._save_psfalgo_log_to_csv(filename="algraporu.csv", show_message=False)
                print(f"[RUNALL] âœ… Alg Raporu CSV'ye kaydedildi: algraporu.csv")
            except Exception as e:
                print(f"[RUNALL] âš ï¸ Alg Raporu CSV kaydetme hatasÄ±: {e}")
            
            # DÃ¶ngÃ¼ sayacÄ± label'Ä±nÄ± gÃ¼ncelle
            if hasattr(self, 'runall_loop_label'):
                self.runall_loop_label.config(text=f"DÃ¶ngÃ¼: {completed_loops} tamamlandÄ±")
            
            # Psfalgo penceresini Ã¶ne getir (kullanÄ±cÄ± botu durdurabilsin)
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        self.psfalgo_window.lift()  # Pencereyi Ã¶ne getir
                        self.psfalgo_window.focus_force()  # Odaklan
                        self.psfalgo_window.attributes('-topmost', True)  # En Ã¼ste getir
                        self.after(100, lambda: self.psfalgo_window.attributes('-topmost', False))  # 100ms sonra normal moda dÃ¶ndÃ¼r
                except Exception as e:
                    print(f"[RUNALL] âš ï¸ Psfalgo penceresi Ã¶ne getirilemedi: {e}")
            
            # Flag'leri resetle - YENÄ° DÃ–NGÃœ Ä°Ã‡Ä°N HAZIRLA
            self.runall_addnewpos_triggered = False
            self.runall_addnewpos_started = False
            self.runall_waiting_for_karbotu = False
            self.runall_waiting_for_reducemore = False
            self.runall_addnewpos_callback_set = False
            
            # KARBOTU ve REDUCEMORE flag'lerini de resetle
            if hasattr(self, 'karbotu_running'):
                self.karbotu_running = False
            if hasattr(self, 'reducemore_running'):
                self.reducemore_running = False
            
            # Controller'Ä±n aÃ§Ä±k olduÄŸundan emin ol (UI thread'inde)
            if not self.controller_enabled:
                self.controller_enabled = True
                if hasattr(self, 'controller_btn'):
                    self.controller_btn.config(text="ğŸ›ï¸ Controller: ON")
                    self.controller_btn.config(style='Success.TButton')
            
            # Ä°ptal iÅŸlemi tamamlandÄ±ktan sonra hemen yeni dÃ¶ngÃ¼ye baÅŸla (2 dakika zaten ADDNEWPOS bitince beklendi)
            # after() kullanarak UI thread'ini bloklamadan restart yap
            def restart_loop():
                print("[RUNALL] ğŸ”„ restart_loop() Ã§aÄŸrÄ±ldÄ±")
                # DÃ¶ngÃ¼ durumu kontrolÃ¼ (her seferinde kontrol et)
                runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                print(f"[RUNALL] ğŸ” restart_loop kontrolÃ¼: runall_running={runall_running}, runall_allowed={runall_allowed}")
                if not runall_running and not runall_allowed:
                    print("[RUNALL] â¹ï¸ DÃ¶ngÃ¼ durdurulmuÅŸ, tekrar baÅŸlatÄ±lmayacak")
                    self.log_message("â¹ï¸ DÃ¶ngÃ¼ durdurulmuÅŸ, tekrar baÅŸlatÄ±lmayacak")
                    return
                
                # runall_allowed_mode aktifse runall_loop_running'i True yap
                if runall_allowed and not runall_running:
                    self.runall_loop_running = True
                    print("[RUNALL] âœ… runall_loop_running True yapÄ±ldÄ± (runall_allowed_mode aktif)")
                
                # Yeni dÃ¶ngÃ¼ baÅŸlatÄ±lacak (sayacÄ± run_all_sequence iÃ§inde artÄ±racak)
                next_loop = (self.runall_loop_count + 1) if hasattr(self, 'runall_loop_count') else 1
                print(f"[RUNALL] ğŸ”„ {next_loop}. dÃ¶ngÃ¼ baÅŸlatÄ±lÄ±yor (KARBOTU ile)...")
                self.log_message(f"ğŸ”„ {next_loop}. dÃ¶ngÃ¼ baÅŸlatÄ±lÄ±yor (KARBOTU ile)...")
                
                # run_all_sequence'Ä± Ã§aÄŸÄ±r (KARBOTU ile baÅŸlayacak) - restart'tan geldiÄŸini belirt
                # Direkt Ã§aÄŸÄ±r (zaten UI thread'indeyiz)
                try:
                    print(f"[RUNALL] ğŸš€ run_all_sequence(from_restart=True) Ã§aÄŸrÄ±lÄ±yor...")
                    self.run_all_sequence(from_restart=True)
                    print(f"[RUNALL] âœ… run_all_sequence(from_restart=True) Ã§aÄŸrÄ±ldÄ±")
                except Exception as e:
                    print(f"[RUNALL] âŒ Restart hatasÄ±: {e}")
                    self.log_message(f"âŒ Restart hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile tekrar dene (dÃ¶ngÃ¼ hala Ã§alÄ±ÅŸÄ±yorsa)
                    if hasattr(self, 'runall_loop_running') and self.runall_loop_running:
                        print("[RUNALL] ğŸ”„ Hata sonrasÄ± tekrar denenecek (2 saniye sonra)...")
                        self.after(2000, restart_loop)
            
            # Ä°ptal iÅŸlemi tamamlandÄ±ktan sonra hemen yeni dÃ¶ngÃ¼ye baÅŸla (2 dakika zaten ADDNEWPOS bitince beklendi)
            # after() kullanarak UI thread'ini bloklamadan restart yap
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            should_restart = runall_running or runall_allowed
            print(f"[RUNALL] ğŸ” Restart kontrolÃ¼: runall_running={runall_running}, runall_allowed={runall_allowed}, should_restart={should_restart}")
            
            if should_restart:
                # runall_allowed_mode aktifse runall_loop_running'i True yap
                if runall_allowed and not runall_running:
                    self.runall_loop_running = True
                    print("[RUNALL] âœ… runall_loop_running True yapÄ±ldÄ± (runall_allowed_mode aktif)")
                
                # Emir iptalleri tamamlanÄ±r tamamlanmaz hemen yeni dÃ¶ngÃ¼ye baÅŸla (non-blocking)
                # KÄ±sa bir gecikme ile baÅŸlat (emir iptallerinin tamamlanmasÄ± iÃ§in)
                print("[RUNALL] â° Restart fonksiyonu Ã§aÄŸrÄ±lÄ±yor (500ms sonra)...")
                self.after(500, restart_loop)
            else:
                print("[RUNALL] â¹ï¸ DÃ¶ngÃ¼ durdurulmuÅŸ, tekrar baÅŸlatÄ±lmayacak")
                self.log_message("â¹ï¸ DÃ¶ngÃ¼ durdurulmuÅŸ, tekrar baÅŸlatÄ±lmayacak")
            
        except Exception as e:
            print(f"[RUNALL] âŒ Restart hatasÄ±: {e}")
            self.log_message(f"âŒ Restart hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile tekrar dene (dÃ¶ngÃ¼ hala Ã§alÄ±ÅŸÄ±yorsa)
            if hasattr(self, 'runall_loop_running') and self.runall_loop_running:
                self.after(2000, self.run_all_sequence)
    
    def toggle_lot_divider(self):
        """Lot bÃ¶lÃ¼cÃ¼ modunu aÃ§/kapat"""
        self.lot_divider_enabled = not self.lot_divider_enabled
        
        if self.lot_divider_enabled:
            self.btn_lot_divider.config(text="ğŸ“¦ Lot BÃ¶lÃ¼cÃ¼: ON")
            self.btn_lot_divider.config(style='Success.TButton')
            print("âœ… Lot BÃ¶lÃ¼cÃ¼: AÃ‡IK - Emirler 200er lotlar halinde bÃ¶lÃ¼necek")
        else:
            self.btn_lot_divider.config(text="ğŸ“¦ Lot BÃ¶lÃ¼cÃ¼: OFF")
            self.btn_lot_divider.config(style='Accent.TButton')
            print("âŒ Lot BÃ¶lÃ¼cÃ¼: KAPALI - Emirler normal gÃ¶nderilecek")
    
    def divide_lot_size(self, total_lot):
        """
        Lot miktarÄ±nÄ± akÄ±llÄ±ca bÃ¶l - YENÄ° MANTIK:
        - 0-399 lot: Direkt o kadar gÃ¶nder (130 lot varsa 130, 250 lot varsa 250)
        - 400+ lot: 200'Ã¼n katlarÄ± + kalan (kalan 200-399 arasÄ± olmalÄ±)
          Ã–rnek: 500 lot = 200 + 300 (200+200+100 deÄŸil!)
          Ã–rnek: 600 lot = 200 + 200 + 200
          Ã–rnek: 700 lot = 200 + 200 + 300
          Ã–rnek: 800 lot = 200 + 200 + 200 + 200
          Ã–rnek: 900 lot = 200 + 200 + 200 + 300
        """
        try:
            if total_lot <= 0:
                return []
            
            # 0-399 lot arasÄ±: Direkt gÃ¶nder
            if total_lot <= 399:
                return [total_lot]
            
            # 400+ lot: 200'Ã¼n katlarÄ± + kalan (kalan 200-399 arasÄ± olmalÄ±)
            lot_parts = []
            remaining = total_lot
            
            # 200'Ã¼n katlarÄ±nÄ± Ã§Ä±kar (kalan 200-399 arasÄ± kalacak ÅŸekilde)
            while remaining >= 400:
                lot_parts.append(200)
                remaining -= 200
            
            # Kalan miktarÄ± ekle (200-399 arasÄ± veya 0)
            if remaining > 0:
                lot_parts.append(remaining)
            
            return lot_parts
            
        except Exception as e:
            print(f"âŒ Lot bÃ¶lme hatasÄ±: {e}")
            return [total_lot]  # Hata durumunda orijinal miktarÄ± dÃ¶ndÃ¼r
    
    def determine_position_change_type(self, symbol, current_qty, new_qty):
        """Pozisyon deÄŸiÅŸim tÃ¼rÃ¼nÃ¼ belirle"""
        try:
            # Mevcut pozisyon tÃ¼rÃ¼
            if current_qty > 0:
                current_type = "LONG"
            elif current_qty < 0:
                current_type = "SHORT"
            else:
                current_type = "FLAT"
            
            # Yeni pozisyon tÃ¼rÃ¼
            if new_qty > 0:
                new_type = "LONG"
            elif new_qty < 0:
                new_type = "SHORT"
            else:
                new_type = "FLAT"
            
            # DeÄŸiÅŸim miktarÄ±
            change = new_qty - current_qty
            
            # Pozisyon deÄŸiÅŸim tÃ¼rÃ¼nÃ¼ belirle
            if current_type == "LONG" and new_qty > current_qty:
                return "LONG_ARTTIRMA", change
            elif current_type == "LONG" and new_qty < current_qty:
                return "LONG_AZALTMA", change
            elif current_type == "SHORT" and new_qty < current_qty:
                return "SHORT_ARTTIRMA", change
            elif current_type == "SHORT" and new_qty > current_qty:
                return "SHORT_AZALTMA", change
            elif current_type == "FLAT" and new_qty > 0:
                return "LONG_ARTTIRMA", change
            elif current_type == "FLAT" and new_qty < 0:
                return "SHORT_ARTTIRMA", change
            else:
                return "UNKNOWN", change
                
        except Exception as e:
            self.log_message(f"âŒ Pozisyon tÃ¼rÃ¼ belirleme hatasÄ± ({symbol}): {e}")
            return "ERROR", 0
    
    def check_maxalw_limit(self, symbol, change_type, change_amount):
        """MAXALW limitini kontrol et (1/4 kuralÄ±)"""
        try:
            # MAXALW deÄŸerini al
            maxalw = self.get_maxalw_for_symbol(symbol)
            if maxalw <= 0:
                return True, "MAXALW deÄŸeri bulunamadÄ±"
            
            # Maksimum deÄŸiÅŸim limiti (MAXALW/4)
            max_change_limit = maxalw / 4
            
            # Mutlak deÄŸiÅŸim miktarÄ±nÄ± kontrol et
            abs_change = abs(change_amount)
            
            if abs_change > max_change_limit:
                return False, f"MAXALW limiti aÅŸÄ±ldÄ±: {abs_change:.0f} > {max_change_limit:.0f}"
            else:
                return True, f"MAXALW limiti OK: {abs_change:.0f} <= {max_change_limit:.0f}"
                
        except Exception as e:
            self.log_message(f"âŒ MAXALW kontrol hatasÄ± ({symbol}): {e}")
            return False, f"Hata: {e}"
    
    def check_three_hour_limit(self, symbol, change_amount):
        """3 saatlik sÃ¼re limitini kontrol et"""
        try:
            current_time = datetime.now()
            
            # Bu hisse iÃ§in son trade zamanÄ±nÄ± kontrol et
            if symbol in self.psfalgo_positions:
                last_trade_time = self.psfalgo_positions[symbol].get('last_trade_time')
                
                if last_trade_time:
                    # 3 saat geÃ§miÅŸ mi kontrol et
                    time_diff = current_time - last_trade_time
                    if time_diff.total_seconds() < 3 * 3600:  # 3 saat = 10800 saniye
                        # 3 saat iÃ§inde, toplam deÄŸiÅŸimi kontrol et
                        three_hour_change = self.psfalgo_positions[symbol].get('three_hour_change', 0)
                        new_total_change = three_hour_change + change_amount
                        
                        # MAXALW/4 limitini kontrol et
                        maxalw = self.get_maxalw_for_symbol(symbol)
                        max_change_limit = maxalw / 4
                        
                        if abs(new_total_change) > max_change_limit:
                            return False, f"3 saatlik limit aÅŸÄ±ldÄ±: {abs(new_total_change):.0f} > {max_change_limit:.0f}"
                        else:
                            return True, f"3 saatlik limit OK: {abs(new_total_change):.0f} <= {max_change_limit:.0f}"
                    else:
                        # 3 saat geÃ§miÅŸ, sÄ±fÄ±rla
                        self.psfalgo_positions[symbol]['three_hour_change'] = 0
                        self.psfalgo_positions[symbol]['last_trade_time'] = current_time
                        return True, "3 saatlik sÃ¼re sÄ±fÄ±rlandÄ±"
                else:
                    # Ä°lk trade
                    self.psfalgo_positions[symbol]['last_trade_time'] = current_time
                    return True, "Ä°lk trade"
            else:
                return True, "Pozisyon bulunamadÄ±"
                
        except Exception as e:
            self.log_message(f"âŒ 3 saatlik limit kontrol hatasÄ± ({symbol}): {e}")
            return False, f"Hata: {e}"
    
    def setup_mode_buttons(self):
        """Mod butonlarÄ±nÄ±n baÅŸlangÄ±Ã§ gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ ayarla"""
        try:
            # HAMPRO modu varsayÄ±lan olarak aktif
            self.btn_hampro_mode.configure(style="Accent.TButton")
            self.btn_ibkr_gun_mode.configure(style="TButton")
            self.btn_ibkr_ped_mode.configure(style="TButton")
            
            # Mode manager callback'lerini ayarla
            self.mode_manager.on_mode_changed = self.on_mode_changed
            self.mode_manager.on_positions_changed = self.on_positions_changed
            self.mode_manager.on_orders_changed = self.on_orders_changed
            
            print("[MAIN] OK Mod butonlari ayarlandi")
        except Exception as e:
            print(f"[MAIN] ERROR Mod butonlari ayarlama hatasi: {e}")
    
    def on_mode_changed(self, mode):
        """Mod deÄŸiÅŸtiÄŸinde Ã§aÄŸrÄ±lÄ±r"""
        print(f"[MAIN] ğŸ”„ Mod deÄŸiÅŸti: {mode}")
    
    def on_positions_changed(self, positions):
        """Pozisyonlar deÄŸiÅŸtiÄŸinde Ã§aÄŸrÄ±lÄ±r"""
        print(f"[MAIN] ğŸ“Š Pozisyonlar gÃ¼ncellendi: {len(positions)} pozisyon")
        # Exposure bilgisini gÃ¼ncelle
        self.update_exposure_display()
    
    def on_orders_changed(self, orders):
        """Emirler deÄŸiÅŸtiÄŸinde Ã§aÄŸrÄ±lÄ±r"""
        print(f"[MAIN] ğŸ“‹ Emirler gÃ¼ncellendi: {len(orders)} emir")
    
    def open_exception_list(self):
        """Exception listesi penceresini aÃ§ar."""
        try:
            ExceptionListWindow(self, self.exception_manager)
        except Exception as e:
            messagebox.showerror("Hata", f"Exception listesi penceresi aÃ§Ä±lamadÄ±: {e}")
    
    def check_exception_tickers(self, ticker_list):
        """
        Verilen ticker listesinde exception olanlarÄ± kontrol eder.
        
        Args:
            ticker_list: Kontrol edilecek ticker listesi
            
        Returns:
            tuple: (allowed_tickers, exception_tickers, message)
        """
        allowed_tickers, exception_tickers = self.exception_manager.filter_exception_tickers(ticker_list)
        
        if exception_tickers:
            message = f"Exception listesinde bulunan hisseler: {', '.join(exception_tickers)}"
        else:
            message = "TÃ¼m hisseler trade edilebilir."
        
        return allowed_tickers, exception_tickers, message
    
    def update_exposure_display(self):
        """Aktif mod iÃ§in exposure bilgisini hesapla ve gÃ¶ster"""
        try:
            print(f"[EXPOSURE] OK Exposure guncelleniyor... Aktif mod: {self.current_mode}")
            
            if self.current_mode == "HAMPRO":
                long_exposure, short_exposure = self.calculate_hammer_exposure()
                mode_text = "HAMPRO mod aÃ§Ä±k"
            elif self.current_mode == "IBKR":
                long_exposure, short_exposure = self.calculate_ibkr_exposure()
                mode_text = "IBKR mod aÃ§Ä±k"
            else:
                long_exposure, short_exposure = 0.0, 0.0
                mode_text = "Mod belirsiz"
            
            # Total exposure hesapla
            total_exposure = long_exposure + short_exposure
            
            # Exposure bilgisini gÃ¼ncelle - KÄ±sa format
            exposure_text = f"{mode_text} - Long: {long_exposure:,.0f} | Short: {short_exposure:,.0f} | Total: {total_exposure:,.0f}"
            self.exposure_label.configure(text=exposure_text)
            
            print(f"[EXPOSURE] OK {exposure_text}")
            
        except Exception as e:
            print(f"[EXPOSURE] ERROR Exposure hesaplama hatasi: {e}")
            import traceback
            traceback.print_exc()
            self.exposure_label.configure(text="Exposure hesaplanamadÄ±")
    
    def calculate_hammer_exposure(self):
        """HAMMER PRO pozisyonlarÄ±ndan exposure hesapla"""
        try:
            if not self.hammer.connected:
                return 0.0, 0.0
            
            positions = self.hammer.get_positions_direct()  # Direct pozisyonlarÄ± al
            long_exposure = 0.0
            short_exposure = 0.0
            
            print(f"[EXPOSURE] ğŸ” HAMMER pozisyonlarÄ± kontrol ediliyor: {len(positions)} pozisyon")
            
            for position in positions:
                symbol = position.get('symbol', '')
                quantity = float(position.get('qty', 0))  # HAMMER'da 'qty' kullanÄ±lÄ±yor
                
                # Pozisyonlardan gelen price bilgisini kullan
                price_for_exposure = position.get('price_for_exposure')
                last_price = position.get('last_price')
                prev_close = position.get('prev_close')
                avg_cost = position.get('avg_cost', 0)
                
                print(f"[EXPOSURE] ğŸ“Š {symbol}: Qty={quantity}, AvgCost={avg_cost}, LastPrice={last_price}, PrevClose={prev_close}, PriceForExposure={price_for_exposure}")
                
                # Price bilgisini belirle - Ã–ncelik sÄ±rasÄ±:
                # 1. Pozisyonlardan gelen price_for_exposure
                # 2. Pozisyonlardan gelen last_price
                # 3. Pozisyonlardan gelen prev_close
                # 4. Avg cost (fallback)
                
                price = None
                
                if price_for_exposure and price_for_exposure > 0:
                    price = float(price_for_exposure)
                    print(f"[EXPOSURE] ğŸ“Š {symbol}: Pozisyon price_for_exposure={price}")
                elif last_price and last_price > 0:
                    price = float(last_price)
                    print(f"[EXPOSURE] ğŸ“Š {symbol}: Pozisyon last_price={price}")
                elif prev_close and prev_close > 0:
                    price = float(prev_close)
                    print(f"[EXPOSURE] ğŸ“Š {symbol}: Pozisyon prev_close={price}")
                else:
                    # Fallback: Avg cost kullan
                    if avg_cost and avg_cost > 0:
                        price = float(avg_cost)
                        print(f"[EXPOSURE] ğŸ“Š {symbol}: Avg cost={price}")
                    else:
                        print(f"[EXPOSURE] âš ï¸ {symbol}: Price bulunamadÄ±, exposure hesaplanamadÄ±")
                        continue
                
                if price and price > 0:
                    exposure = quantity * price
                    
                    if quantity > 0:  # Long pozisyon
                        long_exposure += exposure
                        print(f"[EXPOSURE] ğŸ“ˆ {symbol}: Long exposure += {exposure:.2f}")
                    elif quantity < 0:  # Short pozisyon
                        short_exposure += abs(exposure)  # Short exposure pozitif gÃ¶ster
                        print(f"[EXPOSURE] ğŸ“‰ {symbol}: Short exposure += {abs(exposure):.2f}")
                else:
                    print(f"[EXPOSURE] âš ï¸ {symbol}: Price bulunamadÄ±, exposure hesaplanamadÄ±")
            
            print(f"[EXPOSURE] ğŸ“Š HAMMER Toplam - Long: {long_exposure:.2f}, Short: {short_exposure:.2f}")
            return long_exposure, short_exposure
            
        except Exception as e:
            print(f"[EXPOSURE] âŒ HAMMER exposure hesaplama hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return 0.0, 0.0
    
    def calculate_ibkr_exposure(self):
        """IBKR pozisyonlarÄ±ndan exposure hesapla"""
        try:
            # Ã–nce native client'i dene (averageCost bilgisi iÃ§in)
            if self.ibkr_native.is_connected():
                positions = self.ibkr_native.get_positions()
            elif self.ibkr.is_connected():
                positions = self.ibkr.get_positions()
            else:
                print("[EXPOSURE] âŒ IBKR baÄŸlantÄ±sÄ± yok")
                return 0.0, 0.0
            
            long_exposure = 0.0
            short_exposure = 0.0
            
            print(f"[EXPOSURE] ğŸ” IBKR pozisyonlarÄ± kontrol ediliyor: {len(positions)} pozisyon")
            
            for position in positions:
                symbol = position.get('symbol', '')
                quantity = float(position.get('qty', 0))  # IBKR'da da 'qty' kullanÄ±lÄ±yor
                
                # IBKR pozisyonlarÄ±ndan price bilgisini al
                market_price = position.get('market_price', 0)
                avg_cost = position.get('avg_cost', 0)
                
                print(f"[EXPOSURE] ğŸ“Š {symbol}: Qty={quantity}, MarketPrice={market_price}, AvgCost={avg_cost}")
                
                # Price bilgisini belirle - Ã–ncelik sÄ±rasÄ±:
                # 1. Market price (gerÃ§ek zamanlÄ± fiyat)
                # 2. Avg cost (fallback)
                
                price = None
                
                if market_price and market_price > 0:
                    price = float(market_price)
                    print(f"[EXPOSURE] ğŸ“Š {symbol}: Market price={price}")
                elif avg_cost and avg_cost > 0:
                    price = float(avg_cost)
                    print(f"[EXPOSURE] ğŸ“Š {symbol}: Avg cost={price}")
                else:
                    print(f"[EXPOSURE] âš ï¸ {symbol}: Price bulunamadÄ±, exposure hesaplanamadÄ±")
                    continue
                
                if price and price > 0:
                    exposure = quantity * price
                    
                    if quantity > 0:  # Long pozisyon
                        long_exposure += exposure
                        print(f"[EXPOSURE] ğŸ“ˆ {symbol}: Long exposure += {exposure:.2f}")
                    elif quantity < 0:  # Short pozisyon
                        short_exposure += abs(exposure)  # Short exposure pozitif gÃ¶ster
                        print(f"[EXPOSURE] ğŸ“‰ {symbol}: Short exposure += {abs(exposure):.2f}")
                else:
                    print(f"[EXPOSURE] âš ï¸ {symbol}: Price bulunamadÄ±, exposure hesaplanamadÄ±")
            
            print(f"[EXPOSURE] ğŸ“Š IBKR Toplam - Long: {long_exposure:.2f}, Short: {short_exposure:.2f}")
            return long_exposure, short_exposure
            
        except Exception as e:
            print(f"[EXPOSURE] âŒ IBKR exposure hesaplama hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return 0.0, 0.0
    
    def get_group_from_symbol(self, symbol):
        """Symbol'Ã¼n hangi gruba ait olduÄŸunu bul - Take Profit Panel mantÄ±ÄŸÄ±yla"""
        try:
            # Grup dosya eÅŸleÅŸmesi
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            # Her grup dosyasÄ±nÄ± kontrol et
            for group, file_name in group_file_map.items():
                if os.path.exists(file_name):
                    try:
                        df = pd.read_csv(file_name)
                        group_symbols = df['PREF IBKR'].tolist()
                        
                        # Tam eÅŸleÅŸme kontrol et
                        if symbol in group_symbols:
                            return group
                        
                        # Esnek eÅŸleÅŸme kontrol et (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf, boÅŸluk vs.)
                        symbol_upper = symbol.upper().strip()
                        for group_symbol in group_symbols:
                            if group_symbol and isinstance(group_symbol, str):
                                group_symbol_upper = group_symbol.upper().strip()
                                if symbol_upper == group_symbol_upper:
                                    return group
                    except Exception as e:
                        continue
            
            return "N/A"
            
        except Exception as e:
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[GORT] âŒ {symbol} grup bulma hatasÄ±: {e}")
            return "N/A"
    
    def get_cgrup_from_symbol(self, symbol):
        """Symbol'Ã¼n CGRUP deÄŸerini bul (kuponlu gruplar iÃ§in)"""
        try:
            if self.df.empty:
                return None
            
            row = self.df[self.df['PREF IBKR'] == symbol]
            if not row.empty and 'CGRUP' in self.df.columns:
                cgrup = row['CGRUP'].iloc[0]
                if pd.notna(cgrup) and cgrup != '' and cgrup != 'N/A':
                    return str(cgrup).strip()
            
            return None
            
        except Exception as e:
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[GORT] âŒ {symbol} CGRUP bulma hatasÄ±: {e}")
            return None
    
    def show_majbina_window(self):
        """MAJBINA filtreleme ve analiz penceresini gÃ¶ster"""
        try:
            # Pencere zaten aÃ§Ä±ksa focus et
            if hasattr(self, 'majbina_window') and self.majbina_window:
                try:
                    self.majbina_window.lift()
                    self.majbina_window.focus()
                    return
                except:
                    pass
            
            # Yeni pencere oluÅŸtur
            win = tk.Toplevel(self)
            win.title("MAJBINA - Filtreleme ve Analiz")
            win.geometry("1400x800")
            self.majbina_window = win
            
            # Filtre paneli (Ã¼stte)
            filter_frame = ttk.LabelFrame(win, text="Filtreler", padding=10)
            filter_frame.pack(fill='x', padx=10, pady=5)
            
            # Filtre deÄŸerleri iÃ§in dictionary
            filter_vars = {}
            
            # Filtre satÄ±rlarÄ± (2 sÃ¼tun halinde)
            filter_left = ttk.Frame(filter_frame)
            filter_left.pack(side='left', fill='both', expand=True, padx=5)
            
            filter_right = ttk.Frame(filter_frame)
            filter_right.pack(side='left', fill='both', expand=True, padx=5)
            
            # Filtre listesi
            filters = [
                ('SMA63 CHG', 'SMA63 chg', filter_left),
                ('Gort', 'GORT', filter_left),
                ('Final BB', 'Final_BB_skor', filter_left),
                ('Final FB', 'Final_FB_skor', filter_left),
                ('Final AB', 'Final_AB_skor', filter_left),
                ('Final SAS', 'Final_SAS_skor', filter_left),
                ('Final SFS', 'Final_SFS_skor', filter_left),
                ('Final SBS', 'Final_SBS_skor', filter_left),
                ('Bid buy ucuzluk', 'Bid_buy_ucuzluk_skoru', filter_left),
                ('Front buy ucuzluk', 'Front_buy_ucuzluk_skoru', filter_left),
                ('Ask buy ucuzluk', 'Ask_buy_ucuzluk_skoru', filter_left),
                ('BGGG AyrÄ±ÅŸma', 'BGGG AYRISMA', filter_left),
                ('Ask sell pahalilik', 'Ask_sell_pahalilik_skoru', filter_right),
                ('Front sell pahalilik', 'Front_sell_pahalilik_skoru', filter_right),
                ('Bid sell pahalilik', 'Bid_sell_pahalilik_skoru', filter_right),
                ('Fbtot', 'Fbtot', filter_right),
                ('SFStot', 'SFStot', filter_right),
                ('Spread', 'Spread', filter_right),
                ('AVG_ADV', 'AVG_ADV', filter_right)
            ]
            
            # Her filtre iÃ§in input oluÅŸtur
            for i, (label, column, parent_frame) in enumerate(filters):
                row_frame = ttk.Frame(parent_frame)
                row_frame.pack(fill='x', pady=2)
                
                ttk.Label(row_frame, text=f"{label}:", width=20, anchor='w').pack(side='left', padx=2)
                
                # Min deÄŸer
                min_var = tk.StringVar()
                ttk.Label(row_frame, text="Min:").pack(side='left', padx=2)
                min_entry = ttk.Entry(row_frame, textvariable=min_var, width=10)
                min_entry.pack(side='left', padx=2)
                
                # Max deÄŸer
                max_var = tk.StringVar()
                ttk.Label(row_frame, text="Max:").pack(side='left', padx=2)
                max_entry = ttk.Entry(row_frame, textvariable=max_var, width=10)
                max_entry.pack(side='left', padx=2)
                
                filter_vars[column] = {'min': min_var, 'max': max_var}
            
            # Butonlar (Save Filter, Load Filter, Apply Filter)
            button_frame = ttk.Frame(filter_frame)
            button_frame.pack(fill='x', pady=10)
            
            ttk.Button(button_frame, text="Filtrele", command=lambda: self.apply_majbina_filters(win, filter_vars)).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Kaydet", command=lambda: self.save_majbina_filter(filter_vars)).pack(side='left', padx=5)
            ttk.Button(button_frame, text="YÃ¼kle", command=lambda: self.load_majbina_filter(filter_vars)).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Temizle", command=lambda: self.clear_majbina_filters(filter_vars)).pack(side='left', padx=5)
            
            # SonuÃ§ tablosu (altta, scrollable canvas)
            result_canvas_frame = ttk.Frame(win)
            result_canvas_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Canvas ve scrollbar
            canvas = tk.Canvas(result_canvas_frame)
            scrollbar = ttk.Scrollbar(result_canvas_frame, orient='vertical', command=canvas.yview)
            scrollable_frame = ttk.Frame(canvas)
            
            scrollable_frame.bind(
                "<Configure>",
                lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
            )
            
            canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
            canvas.configure(yscrollcommand=scrollbar.set)
            
            canvas.pack(side="left", fill="both", expand=True)
            scrollbar.pack(side="right", fill="y")
            
            # Ãœstte tÃ¼m gruplarÄ± seÃ§/kaldÄ±r butonu
            top_button_frame = ttk.Frame(win)
            top_button_frame.pack(fill='x', padx=10, pady=5)
            ttk.Button(top_button_frame, text="TÃ¼m GruplarÄ± SeÃ§", 
                     command=lambda: self.majbina_select_all_groups(win, True)).pack(side='left', padx=5)
            ttk.Button(top_button_frame, text="TÃ¼m GruplarÄ± KaldÄ±r", 
                     command=lambda: self.majbina_select_all_groups(win, False)).pack(side='left', padx=5)
            
            # SonuÃ§larÄ± saklamak iÃ§in
            win.majbina_scrollable_frame = scrollable_frame
            win.majbina_filter_vars = filter_vars
            win.majbina_group_trees = {}  # group -> tree widget
            win.majbina_group_checkboxes = {}  # group -> checkbox variable
            
            # Pencere kapatÄ±ldÄ±ÄŸÄ±nda referansÄ± temizle
            def on_close():
                self.majbina_window = None
                win.destroy()
            
            win.protocol("WM_DELETE_WINDOW", on_close)
            
            print("[MAJBINA] âœ… MAJBINA penceresi aÃ§Ä±ldÄ±")
            
        except Exception as e:
            print(f"[MAJBINA] âŒ Pencere aÃ§ma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"MAJBINA penceresi aÃ§Ä±lamadÄ±: {e}")
    
    def apply_majbina_filters(self, win, filter_vars):
        """Filtreleri uygula ve sonuÃ§larÄ± gÃ¶ster"""
        try:
            # Mini450'den veriyi al
            if not hasattr(self, 'df') or self.df.empty:
                messagebox.showwarning("UyarÄ±", "Mini450 verisi yok! Ã–nce mini450'yi aÃ§Ä±n.")
                return
            
            df = self.df.copy()
            
            # Filtreleri uygula
            for column, vars_dict in filter_vars.items():
                min_val = vars_dict['min'].get().strip()
                max_val = vars_dict['max'].get().strip()
                
                if column not in df.columns:
                    continue
                
                if min_val:
                    try:
                        min_num = float(min_val)
                        df = df[pd.to_numeric(df[column], errors='coerce') >= min_num]
                    except:
                        pass
                
                if max_val:
                    try:
                        max_num = float(max_val)
                        df = df[pd.to_numeric(df[column], errors='coerce') <= max_num]
                    except:
                        pass
            
            # SonuÃ§larÄ± gruplara bÃ¶l ve gÃ¶ster
            self.display_majbina_results(win, df)
            
        except Exception as e:
            print(f"[MAJBINA] âŒ Filtreleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Filtreleme hatasÄ±: {e}")
    
    def display_majbina_results(self, win, df):
        """SonuÃ§larÄ± gruplara bÃ¶lÃ¼nmÃ¼ÅŸ ÅŸekilde Treeview tablolarÄ±nda gÃ¶ster"""
        try:
            scrollable_frame = win.majbina_scrollable_frame
            
            # Ã–nceki tablolarÄ± temizle
            for widget in scrollable_frame.winfo_children():
                widget.destroy()
            win.majbina_group_trees = {}
            
            if df.empty:
                ttk.Label(scrollable_frame, text="Filtreleme sonucu: HiÃ§ hisse bulunamadÄ±.", 
                         font=('Arial', 12)).pack(pady=20)
                return
            
            # GRUP kolonu yoksa, dosyalardan grup bilgisini al
            if 'GRUP' not in df.columns:
                # Grup dosya eÅŸleÅŸmesi
                group_file_map = {
                    'heldff': 'ssfinekheldff.csv',
                    'helddeznff': 'ssfinekhelddeznff.csv', 
                    'heldkuponlu': 'ssfinekheldkuponlu.csv',
                    'heldnff': 'ssfinekheldnff.csv',
                    'heldflr': 'ssfinekheldflr.csv',
                    'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                    'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                    'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                    'heldotelremorta': 'ssfinekheldotelremorta.csv',
                    'heldsolidbig': 'ssfinekheldsolidbig.csv',
                    'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                    'highmatur': 'ssfinekhighmatur.csv',
                    'notcefilliquid': 'ssfineknotcefilliquid.csv',
                    'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                    'nottitrekhc': 'ssfineknottitrekhc.csv',
                    'salakilliquid': 'ssfineksalakilliquid.csv',
                    'shitremhc': 'ssfinekshitremhc.csv'
                }
                
                # Her grup iÃ§in sembolleri topla
                group_symbols_map = {}
                for group, file_name in group_file_map.items():
                    if os.path.exists(file_name):
                        try:
                            group_df = pd.read_csv(file_name)
                            group_symbols_map[group] = set(group_df['PREF IBKR'].tolist())
                        except:
                            pass
                
                # DataFrame'e GRUP kolonu ekle
                def get_group(symbol):
                    for group, symbols in group_symbols_map.items():
                        if symbol in symbols:
                            return group
                    return 'N/A'
                
                df['GRUP'] = df['PREF IBKR'].apply(get_group)
            
            # Gruplara gÃ¶re grupla
            groups = sorted(df['GRUP'].dropna().unique())
            
            for group in groups:
                if group == 'N/A':
                    continue
                
                group_rows = df[df['GRUP'] == group]
                if group_rows.empty:
                    continue
                
                # heldkuponlu iÃ§in CGRUP'lara ayÄ±r
                if group == 'heldkuponlu':
                    # CGRUP'larÄ± al ve sÄ±rala
                    cgrups = []
                    for cgrup in group_rows['CGRUP'].dropna().unique():
                        if pd.notna(cgrup) and str(cgrup).strip():
                            cgrups.append(str(cgrup).strip())
                    
                    def cgrup_sort_key(cgrup_str):
                        try:
                            num = int(cgrup_str.replace('C', ''))
                            return num
                        except:
                            return 9999
                    
                    cgrups = sorted(cgrups, key=cgrup_sort_key)
                    
                    for cgrup in cgrups:
                        cgrup_rows = group_rows[group_rows['CGRUP'].astype(str).str.strip() == cgrup]
                        if cgrup_rows.empty:
                            continue
                        
                        # CGRUP iÃ§in LabelFrame
                        cgrup_frame = ttk.LabelFrame(scrollable_frame, text=f"{group.upper()} - CGRUP: {cgrup} ({len(cgrup_rows)} hisse)", padding=5)
                        cgrup_frame.pack(fill='x', padx=5, pady=5)
                        
                        # Grup seÃ§im checkbox'Ä± ve butonlar
                        header_frame = ttk.Frame(cgrup_frame)
                        header_frame.pack(fill='x', pady=5)
                        
                        group_key = f"{group}_{cgrup}"
                        group_checkbox_var = tk.BooleanVar(value=False)
                        group_checkbox = ttk.Checkbutton(header_frame, text="Grup SeÃ§", variable=group_checkbox_var,
                                                        command=lambda gk=group_key, var=group_checkbox_var: 
                                                        self.majbina_toggle_group_selection(win, gk, var.get()))
                        group_checkbox.pack(side='left', padx=5)
                        
                        win.majbina_group_checkboxes[group_key] = group_checkbox_var
                        
                        btn_frame = ttk.Frame(header_frame)
                        btn_frame.pack(side='right')
                        
                        tree = self.create_majbina_table(cgrup_frame, cgrup_rows, group_key)
                        
                        ttk.Button(btn_frame, text="TÃ¼mÃ¼nÃ¼ SeÃ§", 
                                 command=lambda t=tree, gk=group_key, var=group_checkbox_var: 
                                 [self.majbina_select_all(t, True), var.set(True)]).pack(side='left', padx=5)
                        ttk.Button(btn_frame, text="TÃ¼mÃ¼nÃ¼ KaldÄ±r", 
                                 command=lambda t=tree, gk=group_key, var=group_checkbox_var: 
                                 [self.majbina_select_all(t, False), var.set(False)]).pack(side='left', padx=5)
                        
                        win.majbina_group_trees[group_key] = tree
                else:
                    # DiÄŸer gruplar iÃ§in direkt gÃ¶ster
                    group_frame = ttk.LabelFrame(scrollable_frame, text=f"{group.upper()} ({len(group_rows)} hisse)", padding=5)
                    group_frame.pack(fill='x', padx=5, pady=5)
                    
                    # Grup seÃ§im checkbox'Ä± ve butonlar
                    header_frame = ttk.Frame(group_frame)
                    header_frame.pack(fill='x', pady=5)
                    
                    group_checkbox_var = tk.BooleanVar(value=False)
                    group_checkbox = ttk.Checkbutton(header_frame, text="Grup SeÃ§", variable=group_checkbox_var,
                                                    command=lambda gk=group, var=group_checkbox_var: 
                                                    self.majbina_toggle_group_selection(win, gk, var.get()))
                    group_checkbox.pack(side='left', padx=5)
                    
                    win.majbina_group_checkboxes[group] = group_checkbox_var
                    
                    btn_frame = ttk.Frame(header_frame)
                    btn_frame.pack(side='right')
                    
                    tree = self.create_majbina_table(group_frame, group_rows, group)
                    
                    ttk.Button(btn_frame, text="TÃ¼mÃ¼nÃ¼ SeÃ§", 
                             command=lambda t=tree, gk=group, var=group_checkbox_var: 
                             [self.majbina_select_all(t, True), var.set(True)]).pack(side='left', padx=5)
                    ttk.Button(btn_frame, text="TÃ¼mÃ¼nÃ¼ KaldÄ±r", 
                             command=lambda t=tree, gk=group, var=group_checkbox_var: 
                             [self.majbina_select_all(t, False), var.set(False)]).pack(side='left', padx=5)
                    
                    win.majbina_group_trees[group] = tree
            
            # Toplam bilgisi
            total_label = ttk.Label(scrollable_frame, text=f"TOPLAM: {len(df)} hisse", 
                                   font=('Arial', 10, 'bold'))
            total_label.pack(pady=10)
            
        except Exception as e:
            print(f"[MAJBINA] âŒ SonuÃ§ gÃ¶sterim hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def create_majbina_table(self, parent, df_rows, group_key):
        """MAJBINA iÃ§in Treeview tablosu oluÅŸtur"""
        columns = ('SeÃ§', 'Symbol', 'Final_BB', 'Final_FB', 'Fbtot', 'SFStot', 'SMA63', 'GORT', 
                   'Final_SAS', 'Final_SFS', 'Spread', 'AVG_ADV')
        headers = ('âœ“', 'Symbol', 'Final BB', 'Final FB', 'Fbtot', 'SFStot', 'SMA63', 'GORT',
                   'Final SAS', 'Final SFS', 'Spread', 'AVG_ADV')
        
        tree = ttk.Treeview(parent, columns=columns, show='headings', height=min(len(df_rows), 15))
        
        # Kolon baÅŸlÄ±klarÄ±
        for col, header in zip(columns, headers):
            tree.heading(col, text=header)
            if col == 'SeÃ§':
                tree.column(col, width=40, anchor='center')
            elif col == 'Symbol':
                tree.column(col, width=100, anchor='center')
            else:
                tree.column(col, width=90, anchor='center')
        
        # SatÄ±rlarÄ± ekle
        for _, row in df_rows.iterrows():
            symbol = row.get('PREF IBKR', 'N/A')
            final_bb = row.get('Final_BB_skor', 'N/A')
            final_fb = row.get('Final_FB_skor', 'N/A')
            fbtot = row.get('Fbtot', 'N/A')
            sfstot = row.get('SFStot', 'N/A')
            sma63 = row.get('SMA63 chg', 'N/A')
            gort = row.get('GORT', 'N/A')
            final_sas = row.get('Final_SAS_skor', 'N/A')
            final_sfs = row.get('Final_SFS_skor', 'N/A')
            spread = row.get('Spread', 'N/A')
            avg_adv = row.get('AVG_ADV', 'N/A')
            
            # DeÄŸerleri formatla
            final_bb_str = f"{final_bb:.4f}" if isinstance(final_bb, (int, float)) and not pd.isna(final_bb) else str(final_bb)
            final_fb_str = f"{final_fb:.4f}" if isinstance(final_fb, (int, float)) and not pd.isna(final_fb) else str(final_fb)
            fbtot_str = str(fbtot) if fbtot != 'N/A' and pd.notna(fbtot) else 'N/A'
            sfstot_str = str(sfstot) if sfstot != 'N/A' and pd.notna(sfstot) else 'N/A'
            sma63_str = f"{sma63:.2f}" if isinstance(sma63, (int, float)) and not pd.isna(sma63) else str(sma63)
            gort_str = f"{gort:.2f}" if isinstance(gort, (int, float)) and not pd.isna(gort) else str(gort)
            final_sas_str = f"{final_sas:.4f}" if isinstance(final_sas, (int, float)) and not pd.isna(final_sas) else str(final_sas)
            final_sfs_str = f"{final_sfs:.4f}" if isinstance(final_sfs, (int, float)) and not pd.isna(final_sfs) else str(final_sfs)
            spread_str = f"${spread:.2f}" if isinstance(spread, (int, float)) and not pd.isna(spread) else str(spread)
            avg_adv_str = f"{avg_adv:.0f}" if isinstance(avg_adv, (int, float)) and not pd.isna(avg_adv) else str(avg_adv)
            
            tree.insert('', 'end', values=(
                'â˜',  # SeÃ§im kutusu
                symbol,
                final_bb_str,
                final_fb_str,
                fbtot_str,
                sfstot_str,
                sma63_str,
                gort_str,
                final_sas_str,
                final_sfs_str,
                spread_str,
                avg_adv_str
            ), tags=(symbol,))
        
        # SeÃ§im tÄ±klama
        def on_click(event):
            region = tree.identify_region(event.x, event.y)
            if region == "cell":
                column = tree.identify_column(event.x)
                if column == "#1":  # SeÃ§ kolonu
                    item = tree.identify_row(event.y)
                    if item:
                        values = list(tree.item(item)['values'])
                        if values[0] == "âœ“":
                            values[0] = "â˜"
                        else:
                            values[0] = "âœ“"
                        tree.item(item, values=values)
        
        tree.bind('<Button-1>', on_click)
        tree.pack(fill='both', expand=True)
        
        return tree
    
    def majbina_select_all(self, tree, select=True):
        """TÃ¼mÃ¼nÃ¼ seÃ§/kaldÄ±r"""
        for item in tree.get_children():
            values = list(tree.item(item)['values'])
            values[0] = "âœ“" if select else "â˜"
            tree.item(item, values=values)
    
    def majbina_toggle_group_selection(self, win, group_key, selected):
        """Grup seÃ§im checkbox'Ä±na tÄ±klandÄ±ÄŸÄ±nda"""
        if group_key in win.majbina_group_trees:
            tree = win.majbina_group_trees[group_key]
            self.majbina_select_all(tree, selected)
    
    def majbina_select_all_groups(self, win, select=True):
        """TÃ¼m gruplarÄ± seÃ§/kaldÄ±r"""
        for group_key, tree in win.majbina_group_trees.items():
            self.majbina_select_all(tree, select)
            # Checkbox'larÄ± da gÃ¼ncelle
            if group_key in win.majbina_group_checkboxes:
                win.majbina_group_checkboxes[group_key].set(select)
    
    def save_majbina_filter(self, filter_vars):
        """Filtreleri kaydet"""
        try:
            # Ä°sim al
            filter_name = simpledialog.askstring("Filtre Kaydet", "Filtre ismi girin:")
            if not filter_name:
                return
            
            # Filtre deÄŸerlerini topla
            filter_data = {}
            for column, vars_dict in filter_vars.items():
                min_val = vars_dict['min'].get().strip()
                max_val = vars_dict['max'].get().strip()
                if min_val or max_val:
                    filter_data[column] = {'min': min_val, 'max': max_val}
            
            # JSON formatÄ±nda kaydet (daha kolay yÃ¼kleme iÃ§in)
            import json
            filename = f"majbina_{filter_name}.json"
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(filter_data, f, indent=2, ensure_ascii=False)
            
            messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Filtre '{filter_name}' kaydedildi: {filename}")
            print(f"[MAJBINA] âœ… Filtre kaydedildi: {filename}")
            
        except Exception as e:
            print(f"[MAJBINA] âŒ Filtre kaydetme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Filtre kaydedilemedi: {e}")
    
    def load_majbina_filter(self, filter_vars):
        """Filtreleri yÃ¼kle - KayÄ±tlÄ± filtreleri listele"""
        try:
            # TÃ¼m majbina_*.json dosyalarÄ±nÄ± bul
            import glob
            filter_files = glob.glob("majbina_*.json")
            
            if not filter_files:
                messagebox.showinfo("Bilgi", "KayÄ±tlÄ± filtre bulunamadÄ±.")
                return
            
            # Dosya isimlerinden filtre isimlerini Ã§Ä±kar
            filter_names = []
            for filename in sorted(filter_files):
                # majbina_abc.json -> abc
                name = filename.replace("majbina_", "").replace(".json", "")
                filter_names.append(name)
            
            # SeÃ§im penceresi
            load_win = tk.Toplevel(self)
            load_win.title("Filtre YÃ¼kle")
            load_win.geometry("400x300")
            load_win.transient(self)
            load_win.grab_set()
            
            ttk.Label(load_win, text="KayÄ±tlÄ± Filtreler:", font=('Arial', 10, 'bold')).pack(pady=10)
            
            # Liste kutusu
            list_frame = ttk.Frame(load_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            scrollbar = ttk.Scrollbar(list_frame)
            scrollbar.pack(side='right', fill='y')
            
            filter_listbox = tk.Listbox(list_frame, yscrollcommand=scrollbar.set)
            filter_listbox.pack(side='left', fill='both', expand=True)
            scrollbar.config(command=filter_listbox.yview)
            
            for name in filter_names:
                filter_listbox.insert(tk.END, name)
            
            # Butonlar
            button_frame = ttk.Frame(load_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def load_selected():
                selection = filter_listbox.curselection()
                if not selection:
                    messagebox.showwarning("UyarÄ±", "LÃ¼tfen bir filtre seÃ§in!")
                    return
                
                filter_name = filter_listbox.get(selection[0])
                filename = f"majbina_{filter_name}.json"
                
                try:
                    import json
                    with open(filename, 'r', encoding='utf-8') as f:
                        filter_data = json.load(f)
                    
                    # Filtre deÄŸerlerini yÃ¼kle
                    for column, vars_dict in filter_vars.items():
                        if column in filter_data:
                            data = filter_data[column]
                            vars_dict['min'].set(data.get('min', ''))
                            vars_dict['max'].set(data.get('max', ''))
                    
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Filtre '{filter_name}' yÃ¼klendi")
                    print(f"[MAJBINA] âœ… Filtre yÃ¼klendi: {filename}")
                    load_win.destroy()
                    
                except Exception as e:
                    print(f"[MAJBINA] âŒ Filtre yÃ¼kleme hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    messagebox.showerror("Hata", f"Filtre yÃ¼klenemedi: {e}")
            
            ttk.Button(button_frame, text="YÃ¼kle", command=load_selected).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Ä°ptal", command=load_win.destroy).pack(side='left', padx=5)
            
            # Ã‡ift tÄ±klama ile yÃ¼kle
            filter_listbox.bind('<Double-Button-1>', lambda e: load_selected())
            
        except Exception as e:
            print(f"[MAJBINA] âŒ Filtre yÃ¼kleme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Filtre yÃ¼klenemedi: {e}")
    
    def clear_majbina_filters(self, filter_vars):
        """Filtreleri temizle"""
        try:
            for column, vars_dict in filter_vars.items():
                vars_dict['min'].set('')
                vars_dict['max'].set('')
            
            # SonuÃ§larÄ± da temizle
            if hasattr(self, 'majbina_window') and self.majbina_window:
                if hasattr(self.majbina_window, 'majbina_scrollable_frame'):
                    for widget in self.majbina_window.majbina_scrollable_frame.winfo_children():
                        widget.destroy()
                    self.majbina_window.majbina_group_trees = {}
                    self.majbina_window.majbina_group_checkboxes = {}
            
            print("[MAJBINA] âœ… Filtreler temizlendi")
            
        except Exception as e:
            print(f"[MAJBINA] âŒ Filtre temizleme hatasÄ±: {e}")
    
    def calculate_fbtot_sfstot_for_mini450(self, df):
        """Mini450 iÃ§in Fbtot ve SFStot kolonlarÄ±nÄ± hesapla ve ekle - Her hisse kendi grubuna gÃ¶re"""
        try:
            print("ğŸ”„ Mini450 iÃ§in Fbtot ve SFStot hesaplanÄ±yor...")
            
            # Fbtot ve SFStot kolonlarÄ±nÄ± baÅŸlat
            df['Fbtot'] = 'N/A'
            df['SFStot'] = 'N/A'
            
            # Grup dosya eÅŸleÅŸmesi
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            # Her grup iÃ§in ayrÄ± ayrÄ± hesapla
            for group, file_name in group_file_map.items():
                if not os.path.exists(file_name):
                    continue
                
                try:
                    group_df = pd.read_csv(file_name)
                    group_symbols = set(group_df['PREF IBKR'].tolist())
                    
                    # Bu gruba ait hisseleri filtrele
                    group_rows = df[df['PREF IBKR'].isin(group_symbols)]
                    
                    if group_rows.empty:
                        continue
                    
                    # Grup iÃ§indeki Final_FB ve Final_SFS skorlarÄ±nÄ± al (N/A deÄŸerleri tamamen ignore et)
                    if 'Final_FB_skor' in df.columns:
                        # N/A, NaN, string "N/A", 0 ve negatif deÄŸerleri tamamen filtrele
                        final_fb_values = group_rows['Final_FB_skor'].copy()
                        # String "N/A" deÄŸerlerini NaN'a Ã§evir
                        final_fb_values = final_fb_values.replace('N/A', np.nan)
                        # NaN'larÄ± drop et
                        final_fb_values = final_fb_values.dropna()
                        # SayÄ±sal deÄŸerlere Ã§evir
                        final_fb_values = pd.to_numeric(final_fb_values, errors='coerce')
                        # Tekrar NaN'larÄ± drop et (sayÄ±sal olmayan deÄŸerler iÃ§in)
                        final_fb_values = final_fb_values.dropna()
                        # 0 ve negatif deÄŸerleri filtrele
                        final_fb_values = final_fb_values[final_fb_values > 0]
                        # Ortalama hesapla (sadece geÃ§erli deÄŸerlerle)
                        avg_final_fb = final_fb_values.mean() if not final_fb_values.empty else 0
                    else:
                        avg_final_fb = 0
                    
                    if 'Final_SFS_skor' in df.columns:
                        # N/A, NaN, string "N/A", 0 ve negatif deÄŸerleri tamamen filtrele
                        final_sfs_values = group_rows['Final_SFS_skor'].copy()
                        # String "N/A" deÄŸerlerini NaN'a Ã§evir
                        final_sfs_values = final_sfs_values.replace('N/A', np.nan)
                        # NaN'larÄ± drop et
                        final_sfs_values = final_sfs_values.dropna()
                        # SayÄ±sal deÄŸerlere Ã§evir
                        final_sfs_values = pd.to_numeric(final_sfs_values, errors='coerce')
                        # Tekrar NaN'larÄ± drop et (sayÄ±sal olmayan deÄŸerler iÃ§in)
                        final_sfs_values = final_sfs_values.dropna()
                        # 0 ve negatif deÄŸerleri filtrele
                        final_sfs_values = final_sfs_values[final_sfs_values > 0]
                        # Ortalama hesapla (sadece geÃ§erli deÄŸerlerle)
                        avg_final_sfs = final_sfs_values.mean() if not final_sfs_values.empty else 0
                    else:
                        avg_final_sfs = 0
                    
                    # Her hisse iÃ§in Fbtot ve SFStot hesapla
                    calculated_fbtot = 0
                    calculated_sfstot = 0
                    for idx, row in group_rows.iterrows():
                        symbol = row['PREF IBKR']
                        
                        # FBPlagr hesapla (sadece geÃ§erli skor varsa)
                        if 'Final_FB_skor' in df.columns and avg_final_fb > 0 and len(final_fb_values) > 0:
                            symbol_fb_raw = row.get('Final_FB_skor', 0)
                            
                            # N/A kontrolÃ¼: String "N/A" veya NaN ise ignore et
                            if pd.isna(symbol_fb_raw) or symbol_fb_raw == 'N/A' or symbol_fb_raw == '':
                                df.at[idx, 'Fbtot'] = 'N/A'
                            else:
                                symbol_fb = pd.to_numeric(symbol_fb_raw, errors='coerce')
                                
                                # SayÄ±sal deÄŸilse veya 0'dan kÃ¼Ã§Ã¼kse ignore et
                                if pd.isna(symbol_fb) or symbol_fb <= 0:
                                    df.at[idx, 'Fbtot'] = 'N/A'
                                else:
                                    # Bu hisse'nin grup iÃ§indeki sÄ±ralamasÄ±nÄ± hesapla (sadece geÃ§erli deÄŸerlerle)
                                    rank = (final_fb_values >= symbol_fb).sum()
                                    total_count = len(final_fb_values)
                                    fbplagr = rank / total_count if total_count > 0 else 0
                                    
                                    # FBRatgr hesapla
                                    fbratgr = symbol_fb / avg_final_fb if avg_final_fb > 0 else 0
                                    
                                    # Fbtot hesapla: FBPlagr * 0.5 + FBRatgr * 1.5
                                    fbtot = (fbplagr * 0.5) + (fbratgr * 1.5)
                                    df.at[idx, 'Fbtot'] = f"{fbtot:.4f}"
                                    calculated_fbtot += 1
                        else:
                            df.at[idx, 'Fbtot'] = 'N/A'
                        
                        # SFSPlagr hesapla (sadece geÃ§erli skor varsa)
                        if 'Final_SFS_skor' in df.columns and avg_final_sfs > 0 and len(final_sfs_values) > 0:
                            symbol_sfs_raw = row.get('Final_SFS_skor', 0)
                            
                            # N/A kontrolÃ¼: String "N/A" veya NaN ise ignore et
                            if pd.isna(symbol_sfs_raw) or symbol_sfs_raw == 'N/A' or symbol_sfs_raw == '':
                                df.at[idx, 'SFStot'] = 'N/A'
                            else:
                                symbol_sfs = pd.to_numeric(symbol_sfs_raw, errors='coerce')
                                
                                # SayÄ±sal deÄŸilse veya 0'dan kÃ¼Ã§Ã¼kse ignore et
                                if pd.isna(symbol_sfs) or symbol_sfs <= 0:
                                    df.at[idx, 'SFStot'] = 'N/A'
                                else:
                                    # Bu hisse'nin grup iÃ§indeki sÄ±ralamasÄ±nÄ± hesapla (sadece geÃ§erli deÄŸerlerle)
                                    rank = (final_sfs_values >= symbol_sfs).sum()
                                    total_count = len(final_sfs_values)
                                    sfsplagr = rank / total_count if total_count > 0 else 0
                                    
                                    # SFSRatgr hesapla
                                    sfsratgr = symbol_sfs / avg_final_sfs if avg_final_sfs > 0 else 0
                                    
                                    # SFStot hesapla: SFSPlagr * 0.5 + SFSRatgr * 1.5
                                    sfstot = (sfsplagr * 0.5) + (sfsratgr * 1.5)
                                    df.at[idx, 'SFStot'] = f"{sfstot:.4f}"
                                    calculated_sfstot += 1
                        else:
                            df.at[idx, 'SFStot'] = 'N/A'
                    
                    print(f"âœ… {group} grubu: {len(group_rows)} hisse, Fbtot hesaplanan: {calculated_fbtot}, SFStot hesaplanan: {calculated_sfstot}")
                    
                    print(f"âœ… {group} grubu: {len(group_rows)} hisse iÃ§in Fbtot ve SFStot hesaplandÄ±")
                    
                except Exception as e:
                    print(f"âŒ {group} grubu Fbtot/SFStot hesaplama hatasÄ±: {e}")
                    continue
            
            print(f"âœ… Mini450 iÃ§in Fbtot ve SFStot hesaplama tamamlandÄ±")
            return df
            
        except Exception as e:
            print(f"âŒ Mini450 Fbtot/SFStot hesaplama hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return df
    
    def calculate_group_avg_sma63chg(self, symbol, group, cgrup=None):
        """Grup ortalama SMA 63 CHG hesapla"""
        try:
            # Kuponlu gruplar iÃ§in CGRUP'a gÃ¶re gruplama
            kuponlu_groups = ['heldkuponlu', 'heldkuponlukreciliz', 'heldkuponlukreorta']
            
            if group.lower() in kuponlu_groups and cgrup:
                # CGRUP'a gÃ¶re gruplama
                if self.df.empty:
                    return 0.01
                
                # AynÄ± CGRUP'a sahip hisseleri bul
                cgrup_rows = self.df[(self.df['CGRUP'] == cgrup) & (self.df['PREF IBKR'] != symbol)]
                
                # SMA 63 CHG iÃ§in farklÄ± kolon isimlerini dene
                sma63_col_names = ['SMA63 chg', 'SMA63CHG', 'SMA63_CHG', 'SMA 63 CHG']
                for col_name in sma63_col_names:
                    if col_name in self.df.columns:
                        sma63_values = cgrup_rows[col_name].dropna()
                        sma63_values = pd.to_numeric(sma63_values, errors='coerce').dropna()
                        if not sma63_values.empty:
                            avg = sma63_values.mean()
                            # Sadece ilk birkaÃ§ iÃ§in log
                            if not hasattr(self, '_gort_group_avg_log_count'):
                                self._gort_group_avg_log_count = 0
                            if self._gort_group_avg_log_count < 3:
                                # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
                                # print(f"[GORT] ğŸ“Š {symbol} ({group}, CGRUP={cgrup}): SMA63 grup ortalamasÄ± = {avg:.2f} ({len(sma63_values)} hisse)")
                                self._gort_group_avg_log_count += 1
                            return avg if avg != 0 else 0.01
                
                return 0.01
            
            # Normal gruplar iÃ§in grup dosyasÄ±ndan
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            file_name = group_file_map.get(group.lower())
            if not file_name or not os.path.exists(file_name):
                return 0.01
            
            # Grup dosyasÄ±ndan hisseleri al
            df = pd.read_csv(file_name)
            group_symbols = set(df['PREF IBKR'].tolist())
            
            # Parent DataFrame'den bu gruba ait hisselerin SMA 63 CHG deÄŸerlerini al
            if not self.df.empty:
                group_rows = self.df[self.df['PREF IBKR'].isin(group_symbols)]
                
                # SMA 63 CHG iÃ§in farklÄ± kolon isimlerini dene
                sma63_col_names = ['SMA63 chg', 'SMA63CHG', 'SMA63_CHG', 'SMA 63 CHG']
                for col_name in sma63_col_names:
                    if col_name in self.df.columns:
                        sma63_values = group_rows[col_name].dropna()
                        sma63_values = pd.to_numeric(sma63_values, errors='coerce').dropna()
                        if not sma63_values.empty:
                            avg = sma63_values.mean()
                            # Sadece ilk birkaÃ§ iÃ§in log
                            if not hasattr(self, '_gort_group_avg_log_count'):
                                self._gort_group_avg_log_count = 0
                            if self._gort_group_avg_log_count < 3:
                                # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
                                # print(f"[GORT] ğŸ“Š {symbol} ({group}): SMA63 grup ortalamasÄ± = {avg:.2f} ({len(sma63_values)} hisse)")
                                self._gort_group_avg_log_count += 1
                            return avg if avg != 0 else 0.01
            
            return 0.01
            
        except Exception as e:
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[GORT] âŒ {symbol} grup ortalama SMA 63 CHG hesaplama hatasÄ±: {e}")
            return 0.01
    
    def calculate_group_avg_sma246chg(self, symbol, group, cgrup=None):
        """Grup ortalama SMA 246 CHG hesapla"""
        try:
            # Kuponlu gruplar iÃ§in CGRUP'a gÃ¶re gruplama
            kuponlu_groups = ['heldkuponlu', 'heldkuponlukreciliz', 'heldkuponlukreorta']
            
            if group.lower() in kuponlu_groups and cgrup:
                # CGRUP'a gÃ¶re gruplama
                if self.df.empty:
                    return 0.01
                
                # AynÄ± CGRUP'a sahip hisseleri bul
                cgrup_rows = self.df[(self.df['CGRUP'] == cgrup) & (self.df['PREF IBKR'] != symbol)]
                
                # SMA 246 CHG iÃ§in farklÄ± kolon isimlerini dene - "SMA246 chg" formatÄ±nÄ± Ã¶ncelikli yap
                sma246_col_names = ['SMA246 chg', 'SMA 246 CHG', 'SMA246CHG', 'SMA246_CHG', 'SMA 246 chg']
                for col_name in sma246_col_names:
                    if col_name in self.df.columns:
                        sma246_values = cgrup_rows[col_name].dropna()
                        sma246_values = pd.to_numeric(sma246_values, errors='coerce').dropna()
                        if not sma246_values.empty:
                            avg = sma246_values.mean()
                            # Sadece ilk birkaÃ§ iÃ§in log
                            if not hasattr(self, '_gort_group_avg_log_count'):
                                self._gort_group_avg_log_count = 0
                            if self._gort_group_avg_log_count < 3:
                                # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
                                # print(f"[GORT] ğŸ“Š {symbol} ({group}, CGRUP={cgrup}): SMA246 grup ortalamasÄ± = {avg:.2f} ({len(sma246_values)} hisse)")
                                self._gort_group_avg_log_count += 1
                            return avg if avg != 0 else 0.01
                
                return 0.01
            
            # Normal gruplar iÃ§in grup dosyasÄ±ndan
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            file_name = group_file_map.get(group.lower())
            if not file_name or not os.path.exists(file_name):
                return 0.01
            
            # Grup dosyasÄ±ndan hisseleri al
            df = pd.read_csv(file_name)
            group_symbols = set(df['PREF IBKR'].tolist())
            
            # Parent DataFrame'den bu gruba ait hisselerin SMA 246 CHG deÄŸerlerini al
            if not self.df.empty:
                group_rows = self.df[self.df['PREF IBKR'].isin(group_symbols)]
                
                # SMA 246 CHG iÃ§in farklÄ± kolon isimlerini dene - "SMA246 chg" formatÄ±nÄ± Ã¶ncelikli yap
                sma246_col_names = ['SMA246 chg', 'SMA 246 CHG', 'SMA246CHG', 'SMA246_CHG', 'SMA 246 chg']
                for col_name in sma246_col_names:
                    if col_name in self.df.columns:
                        sma246_values = group_rows[col_name].dropna()
                        sma246_values = pd.to_numeric(sma246_values, errors='coerce').dropna()
                        if not sma246_values.empty:
                            avg = sma246_values.mean()
                            # Sadece ilk birkaÃ§ iÃ§in log
                            if not hasattr(self, '_gort_group_avg_log_count'):
                                self._gort_group_avg_log_count = 0
                            if self._gort_group_avg_log_count < 3:
                                # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
                                # print(f"[GORT] ğŸ“Š {symbol} ({group}): SMA246 grup ortalamasÄ± = {avg:.2f} ({len(sma246_values)} hisse)")
                                self._gort_group_avg_log_count += 1
                            return avg if avg != 0 else 0.01
            
            return 0.01
            
        except Exception as e:
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[GORT] âŒ {symbol} grup ortalama SMA 246 CHG hesaplama hatasÄ±: {e}")
            return 0.01
    
    def calculate_gort_from_group_file(self, symbol):
        """GORT deÄŸerini grup dosyasÄ±ndan direkt Ã§ek - Grup pencerelerindeki mantÄ±kla aynÄ± (CACHE'LENMÄ°Å)"""
        try:
            import time
            current_time = time.time()
            
            # Cache kontrolÃ¼ - GORT deÄŸeri cache'de var mÄ±?
            if hasattr(self, 'gort_cache') and symbol in self.gort_cache:
                # Cache sÃ¼resi dolmuÅŸ mu kontrol et
                if hasattr(self, 'gort_cache_time') and (current_time - self.gort_cache_time) < self.gort_cache_interval:
                    return self.gort_cache[symbol]
            
            # Grup bilgisini al
            group = self.get_group_from_symbol(symbol)
            if group == "N/A":
                return 0.0
            
            # Grup dosya eÅŸleÅŸmesi
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            file_name = group_file_map.get(group.lower())
            if not file_name or not os.path.exists(file_name):
                return 0.0
            
            # Grup dosyasÄ±nÄ± cache'den al veya oku
            if hasattr(self, 'group_file_cache') and group.lower() in self.group_file_cache:
                group_df = self.group_file_cache[group.lower()]
            else:
                # Cache'de yok, oku ve cache'le
                group_df = pd.read_csv(file_name)
                if not hasattr(self, 'group_file_cache'):
                    self.group_file_cache = {}
                self.group_file_cache[group.lower()] = group_df
            
            # Symbol'Ã¼ bul
            symbol_row = group_df[group_df['PREF IBKR'] == symbol]
            if symbol_row.empty:
                return 0.0
            
            # SMA 63 CHG ve SMA 246 CHG deÄŸerlerini al
            sma63chg = None
            sma246chg = None
            
            # SMA 63 CHG iÃ§in farklÄ± isimleri dene
            sma63_col_names = ['SMA63 chg', 'SMA63CHG', 'SMA63_chg', 'SMA 63 CHG']
            for col_name in sma63_col_names:
                if col_name in group_df.columns:
                    sma63chg_val = symbol_row[col_name].iloc[0]
                    if pd.notna(sma63chg_val):
                        sma63chg = pd.to_numeric(sma63chg_val, errors='coerce')
                        if not pd.isna(sma63chg):
                            break
            
            # SMA 246 CHG iÃ§in farklÄ± isimleri dene - "SMA246 chg" formatÄ±nÄ± Ã¶ncelikli yap
            sma246_col_names = ['SMA246 chg', 'SMA 246 CHG', 'SMA246CHG', 'SMA246_CHG', 'SMA 246 chg']
            for col_name in sma246_col_names:
                if col_name in group_df.columns:
                    sma246chg_val = symbol_row[col_name].iloc[0]
                    if pd.notna(sma246chg_val):
                        sma246chg = pd.to_numeric(sma246chg_val, errors='coerce')
                        if not pd.isna(sma246chg):
                            break
            
            if sma63chg is None or sma246chg is None:
                return 0.0
            
            # CGRUP bilgisini al (kuponlu gruplar iÃ§in)
            cgrup = None
            if 'CGRUP' in group_df.columns:
                cgrup_val = symbol_row['CGRUP'].iloc[0]
                if pd.notna(cgrup_val) and cgrup_val != '' and cgrup_val != 'N/A':
                    cgrup = str(cgrup_val).strip()
            
            # Grup ortalamalarÄ±nÄ± hesapla - Cache'den al veya hesapla
            kuponlu_groups = ['heldkuponlu', 'heldkuponlukreciliz', 'heldkuponlukreorta']
            
            # Cache key oluÅŸtur
            cache_key_sma63 = (group.lower(), cgrup if (group.lower() in kuponlu_groups and cgrup) else None, 'sma63')
            cache_key_sma246 = (group.lower(), cgrup if (group.lower() in kuponlu_groups and cgrup) else None, 'sma246')
            
            # SMA 63 CHG ortalama - Cache'den al
            if hasattr(self, 'group_avg_cache') and cache_key_sma63 in self.group_avg_cache:
                group_avg_sma63 = self.group_avg_cache[cache_key_sma63]
            else:
                # Cache'de yok, hesapla
                if group.lower() in kuponlu_groups and cgrup:
                    # CGRUP'a gÃ¶re gruplama
                    cgrup_rows = group_df[(group_df['CGRUP'] == cgrup) & (group_df['PREF IBKR'] != symbol)]
                    
                    # SMA 63 CHG ortalama
                    for col_name in sma63_col_names:
                        if col_name in group_df.columns:
                            sma63_values = cgrup_rows[col_name].dropna()
                            sma63_values = pd.to_numeric(sma63_values, errors='coerce').dropna()
                            if not sma63_values.empty:
                                group_avg_sma63 = sma63_values.mean()
                                if group_avg_sma63 == 0:
                                    group_avg_sma63 = 0.01
                                break
                    else:
                        group_avg_sma63 = 0.01
                else:
                    # Normal gruplar iÃ§in - Grup dosyasÄ±ndaki tÃ¼m hisselerin ortalamasÄ±
                    for col_name in sma63_col_names:
                        if col_name in group_df.columns:
                            sma63_values = group_df[col_name].dropna()
                            sma63_values = pd.to_numeric(sma63_values, errors='coerce').dropna()
                            if not sma63_values.empty:
                                group_avg_sma63 = sma63_values.mean()
                                if group_avg_sma63 == 0:
                                    group_avg_sma63 = 0.01
                                break
                    else:
                        group_avg_sma63 = 0.01
                
                # Cache'le
                if not hasattr(self, 'group_avg_cache'):
                    self.group_avg_cache = {}
                self.group_avg_cache[cache_key_sma63] = group_avg_sma63
            
            # SMA 246 CHG ortalama - Cache'den al
            if hasattr(self, 'group_avg_cache') and cache_key_sma246 in self.group_avg_cache:
                group_avg_sma246 = self.group_avg_cache[cache_key_sma246]
            else:
                # Cache'de yok, hesapla
                if group.lower() in kuponlu_groups and cgrup:
                    # CGRUP'a gÃ¶re gruplama
                    cgrup_rows = group_df[(group_df['CGRUP'] == cgrup) & (group_df['PREF IBKR'] != symbol)]
                    
                    # SMA 246 CHG ortalama
                    for col_name in sma246_col_names:
                        if col_name in group_df.columns:
                            sma246_values = cgrup_rows[col_name].dropna()
                            sma246_values = pd.to_numeric(sma246_values, errors='coerce').dropna()
                            if not sma246_values.empty:
                                group_avg_sma246 = sma246_values.mean()
                                if group_avg_sma246 == 0:
                                    group_avg_sma246 = 0.01
                                break
                    else:
                        group_avg_sma246 = 0.01
                else:
                    # Normal gruplar iÃ§in - Grup dosyasÄ±ndaki tÃ¼m hisselerin ortalamasÄ±
                    for col_name in sma246_col_names:
                        if col_name in group_df.columns:
                            sma246_values = group_df[col_name].dropna()
                            sma246_values = pd.to_numeric(sma246_values, errors='coerce').dropna()
                            if not sma246_values.empty:
                                group_avg_sma246 = sma246_values.mean()
                                if group_avg_sma246 == 0:
                                    group_avg_sma246 = 0.01
                                break
                    else:
                        group_avg_sma246 = 0.01
                
                # Cache'le
                if not hasattr(self, 'group_avg_cache'):
                    self.group_avg_cache = {}
                self.group_avg_cache[cache_key_sma246] = group_avg_sma246
            
            # GORT hesapla (SMA63: %25, SMA246: %75 aÄŸÄ±rlÄ±k)
            gort = (0.25 * (sma63chg - group_avg_sma63)) + (0.75 * (sma246chg - group_avg_sma246))
            
            # GORT'u cache'le
            if not hasattr(self, 'gort_cache'):
                self.gort_cache = {}
            if not hasattr(self, 'gort_cache_time'):
                self.gort_cache_time = current_time
            self.gort_cache[symbol] = gort
            self.gort_cache_time = current_time  # Cache zamanÄ±nÄ± gÃ¼ncelle
            
            return gort
            
        except Exception as e:
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[GORT] âŒ {symbol} grup dosyasÄ±ndan GORT hesaplama hatasÄ±: {e}")
            return 0.0
    
    def calculate_gort(self, symbol):
        """GORT deÄŸerini hesapla - Ã–nce grup dosyasÄ±ndan Ã§ek, yoksa normal hesapla"""
        try:
            # Ã–nce grup dosyasÄ±ndan Ã§ek (grup pencerelerindeki mantÄ±kla aynÄ±)
            gort = self.calculate_gort_from_group_file(symbol)
            if gort != 0.0:
                return gort
            
            # Fallback: Normal hesaplama (eski mantÄ±k)
            if self.df.empty:
                return 0.0
            
            # Symbol'Ã¼n satÄ±rÄ±nÄ± bul
            row = self.df[self.df['PREF IBKR'] == symbol]
            if row.empty:
                return 0.0
            
            # SMA 63 CHG ve SMA 246 CHG deÄŸerlerini al
            sma63chg = None
            sma246chg = None
            
            # SMA 63 CHG iÃ§in farklÄ± isimleri dene
            sma63_col_names = ['SMA63 chg', 'SMA63CHG', 'SMA63_chg', 'SMA 63 CHG']
            for col_name in sma63_col_names:
                if col_name in self.df.columns:
                    sma63chg_val = row[col_name].iloc[0]
                    if pd.notna(sma63chg_val):
                        sma63chg = pd.to_numeric(sma63chg_val, errors='coerce')
                        if not pd.isna(sma63chg):
                            break
            
            # SMA 246 CHG iÃ§in farklÄ± isimleri dene
            sma246_col_names = ['SMA246 chg', 'SMA 246 CHG', 'SMA246CHG', 'SMA246_CHG', 'SMA 246 chg']
            for col_name in sma246_col_names:
                if col_name in self.df.columns:
                    sma246chg_val = row[col_name].iloc[0]
                    if pd.notna(sma246chg_val):
                        sma246chg = pd.to_numeric(sma246chg_val, errors='coerce')
                        if not pd.isna(sma246chg):
                            break
            
            if sma63chg is None or sma246chg is None:
                return 0.0
            
            # Grup bilgisini al
            group = self.get_group_from_symbol(symbol)
            cgrup = self.get_cgrup_from_symbol(symbol)
            
            if group == "N/A":
                return 0.0
            
            # Grup ortalamalarÄ±nÄ± hesapla
            group_avg_sma63 = self.calculate_group_avg_sma63chg(symbol, group, cgrup)
            group_avg_sma246 = self.calculate_group_avg_sma246chg(symbol, group, cgrup)
            
            # GORT hesapla (SMA63: %25, SMA246: %75 aÄŸÄ±rlÄ±k)
            gort = (0.25 * (sma63chg - group_avg_sma63)) + (0.75 * (sma246chg - group_avg_sma246))
            
            return gort
            
        except Exception as e:
            # Debug mesajÄ± kapatÄ±ldÄ± - performans iÃ§in
            # print(f"[GORT] âŒ {symbol} GORT hesaplama hatasÄ±: {e}")
            return 0.0
    
    def get_srpan_values(self, symbol):
        """
        SRPAN (Spread Real Print Analyzer) - Ã‡ift taraflÄ± fiyat yoÄŸunluÄŸu analizi
        
        Son 30 tick'te (9 lot altÄ± Ã§Ä±karÄ±ldÄ±ktan sonra) iki ayrÄ± fiyat yoÄŸunluÄŸu arar:
        1. Ana GRPAN deÄŸeri (birincil yoÄŸunlaÅŸma)
        2. Ä°kincil GRPAN deÄŸeri (farklÄ± bir bÃ¶lgedeki yoÄŸunlaÅŸma, en az 0.08Â¢ uzakta)
        
        SRPAN Skoru (0-100):
        - %60: G1-G2 yoÄŸunluk farkÄ±nÄ±n minimal olmasÄ± (50-50'ye yakÄ±nlÄ±k)
        - %15: G1+G2 toplamÄ±nÄ±n 100'e yakÄ±nlÄ±ÄŸÄ±
        - %25: Spread geniÅŸliÄŸi
        
        Returns:
            dict: {..., 'srpan_score': Kompozit skor}
        """
        try:
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                return None
            
            # Son 30 tick'i al (9 lot altÄ± filtrelenecek)
            tick_data = self.hammer.get_ticks(symbol, lastFew=60, tradesOnly=False, regHoursOnly=True)
            
            if not tick_data or 'data' not in tick_data or not tick_data['data']:
                return None
            
            all_ticks = tick_data['data']
            
            # 9 lot ve altÄ±ndaki print'leri IGNORE et
            filtered_ticks = [tick for tick in all_ticks if tick.get('s', 0) > 9]
            
            # Son 30 tick'i al
            last_30_ticks = filtered_ticks[-30:] if len(filtered_ticks) >= 30 else filtered_ticks
            
            if len(last_30_ticks) < 8:
                print(f"[SRPAN] âš ï¸ {symbol}: Yetersiz tick verisi ({len(last_30_ticks)} tick)")
                return None
            
            # FiyatlarÄ± ve aÄŸÄ±rlÄ±klarÄ± topla
            from collections import defaultdict
            price_weights = defaultdict(float)
            
            for tick in last_30_ticks:
                price = tick.get('p', 0)
                size = tick.get('s', 0)
                
                if price > 0:
                    price = round(price, 2)
                    
                    # AÄŸÄ±rlÄ±k: 100/200/300 lot = 1.00, diÄŸer = 0.25
                    if size in [100, 200, 300]:
                        weight = 1.00
                    else:
                        weight = 0.25
                    
                    price_weights[price] += weight
            
            if len(price_weights) < 2:
                return None
            
            # Toplam aÄŸÄ±rlÄ±k
            total_weight = sum(price_weights.values())
            
            # 1. En yÃ¼ksek aÄŸÄ±rlÄ±klÄ± fiyatÄ± bul (GRPAN1)
            grpan1 = max(price_weights.keys(), key=lambda p: price_weights[p])
            
            # GRPAN1 Â±0.04 aralÄ±ÄŸÄ±ndaki toplam aÄŸÄ±rlÄ±ÄŸÄ± hesapla
            grpan1_range_min = grpan1 - 0.04
            grpan1_range_max = grpan1 + 0.04
            grpan1_range_weight = sum(w for p, w in price_weights.items() if grpan1_range_min <= p <= grpan1_range_max)
            grpan1_conf = (grpan1_range_weight / total_weight) * 100 if total_weight > 0 else 0
            
            # 2. GRPAN1 aralÄ±ÄŸÄ± dÄ±ÅŸÄ±ndaki fiyatlardan ikincil yoÄŸunluÄŸu bul (GRPAN2)
            # En az 0.08Â¢ uzakta olmalÄ±
            excluded_prices = {p: w for p, w in price_weights.items() 
                             if abs(p - grpan1) >= 0.08}
            
            if not excluded_prices:
                # Ä°kincil yoÄŸunluk bulunamadÄ±
                return {
                    'grpan1': grpan1,
                    'grpan1_conf': grpan1_conf,
                    'grpan2': None,
                    'grpan2_conf': 0,
                    'spread': 0,
                    'direction': 'N/A',
                    'srpan_score': 0
                }
            
            # GRPAN2'yi bul
            grpan2 = max(excluded_prices.keys(), key=lambda p: excluded_prices[p])
            
            # GRPAN2 Â±0.04 aralÄ±ÄŸÄ±ndaki toplam aÄŸÄ±rlÄ±ÄŸÄ± hesapla
            grpan2_range_min = grpan2 - 0.04
            grpan2_range_max = grpan2 + 0.04
            grpan2_range_weight = sum(w for p, w in price_weights.items() 
                                     if grpan2_range_min <= p <= grpan2_range_max 
                                     and abs(p - grpan1) >= 0.08)
            grpan2_conf = (grpan2_range_weight / total_weight) * 100 if total_weight > 0 else 0
            
            # Spread hesapla
            spread = abs(grpan2 - grpan1)
            direction = 'UP' if grpan2 > grpan1 else 'DOWN'
            
            # ============ SRPAN SKOR HESAPLAMA ============
            # 1. G1-G2 yoÄŸunluk farkÄ±nÄ±n minimal olmasÄ± (%60 aÄŸÄ±rlÄ±k)
            # En iyi durum: fark = 0 (50-50)
            # En kÃ¶tÃ¼ durum: fark = 100 (tek taraf)
            conf_diff = abs(grpan1_conf - grpan2_conf)
            # Fark 0 ise 100 puan, fark 100 ise 0 puan
            balance_score = max(0, 100 - conf_diff)
            
            # 2. G1+G2 toplamÄ±nÄ±n 100'e yakÄ±nlÄ±ÄŸÄ± (%15 aÄŸÄ±rlÄ±k)
            # En iyi durum: toplam = 100
            # Toplam ne kadar yÃ¼ksekse o kadar iyi
            total_conf = grpan1_conf + grpan2_conf
            # Toplam 100 ise 100 puan, toplam 0 ise 0 puan
            total_score = min(100, total_conf)
            
            # 3. Spread geniÅŸliÄŸi (%25 aÄŸÄ±rlÄ±k)
            # Spread $0.30+ mÃ¼kemmel, $0.08 minimum
            # 0.08 = 0 puan, 0.30+ = 100 puan
            if spread >= 0.30:
                spread_score = 100
            elif spread <= 0.08:
                spread_score = 0
            else:
                # Linear interpolation between 0.08 and 0.30
                spread_score = ((spread - 0.08) / (0.30 - 0.08)) * 100
            
            # Kompozit SRPAN skoru
            srpan_score = (0.60 * balance_score) + (0.15 * total_score) + (0.25 * spread_score)
            
            print(f"[SRPAN] âœ… {symbol}: G1=${grpan1:.2f} ({grpan1_conf:.0f}%), G2=${grpan2:.2f} ({grpan2_conf:.0f}%), Spread=${spread:.2f}")
            print(f"[SRPAN] ğŸ“Š {symbol}: BalanceScore={balance_score:.0f}, TotalScore={total_score:.0f}, SpreadScore={spread_score:.0f} â†’ SRPAN={srpan_score:.1f}")
            
            return {
                'grpan1': grpan1,
                'grpan1_conf': grpan1_conf,
                'grpan2': grpan2,
                'grpan2_conf': grpan2_conf,
                'spread': spread,
                'direction': direction,
                'balance_score': balance_score,
                'total_score': total_score,
                'spread_score': spread_score,
                'srpan_score': srpan_score
            }
            
        except Exception as e:
            print(f"[SRPAN] âŒ {symbol} SRPAN hesaplama hatasÄ±: {e}")
            return None
    
    def show_srpan_analysis(self):
        """SRPAN analiz penceresi - SeÃ§ili gruptaki hisseler iÃ§in Ã§ift taraflÄ± spread analizi"""
        try:
            print(f"[SRPAN] ğŸ” Spread Real Print analizi baÅŸlatÄ±lÄ±yor...")
            
            # Mevcut grup verisi var mÄ± kontrol et
            if self.srpan_current_data is None or self.srpan_current_data.empty:
                messagebox.showwarning("UyarÄ±", "Ã–nce bir grup seÃ§in (heldkuponlu, heldff vb.)")
                return
            
            # Hammer Pro baÄŸlÄ± mÄ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("UyarÄ±", "Hammer Pro baÄŸlantÄ±sÄ± gerekli!")
                return
            
            group_name = self.srpan_current_group
            df = self.srpan_current_data
            
            # SRPAN sonuÃ§larÄ± penceresi
            import tkinter as tk
            from tkinter import ttk
            
            srpan_win = tk.Toplevel(self)
            srpan_win.title(f"SRPAN - Spread Real Print Analyzer [{group_name}]")
            srpan_win.geometry("1200x600")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            # BaÅŸlÄ±k
            title_label = ttk.Label(srpan_win, 
                text=f"SRPAN - Ã‡ift TaraflÄ± Fiyat YoÄŸunluÄŸu Analizi [{group_name}]", 
                font=("Arial", 12, "bold"))
            title_label.pack(pady=5)
            
            # AÃ§Ä±klama
            info_label = ttk.Label(srpan_win, 
                text="SRPAN Skoru: %60 G1-G2 denge + %15 Toplam yoÄŸunluk + %25 Spread geniÅŸliÄŸi",
                font=("Arial", 9, 'italic'))
            info_label.pack(pady=3)
            
            # Progress label
            progress_label = ttk.Label(srpan_win, text="Analiz baÅŸlÄ±yor...")
            progress_label.pack(pady=5)
            
            # Tree frame
            tree_frame = ttk.Frame(srpan_win)
            tree_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # SRPAN sonuÃ§larÄ± tablosu - SRPAN Score eklendi
            columns = ('Symbol', 'SRPAN', 'G1', 'G1%', 'G2', 'G2%', 'Spread', 'Bal', 'Tot', 'Spr', 'Dir')
            srpan_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=20)
            
            col_widths = {
                'Symbol': 100, 'SRPAN': 70, 'G1': 80, 'G1%': 50, 'G2': 80, 
                'G2%': 50, 'Spread': 70, 'Bal': 50, 'Tot': 50, 'Spr': 50, 'Dir': 50
            }
            
            headers = {
                'Symbol': 'Symbol', 'SRPAN': 'SRPAN', 'G1': 'GRPAN1', 'G1%': 'G1%',
                'G2': 'GRPAN2', 'G2%': 'G2%', 'Spread': 'Spread', 
                'Bal': 'Bal', 'Tot': 'Tot', 'Spr': 'Spr', 'Dir': 'Dir'
            }
            
            for col in columns:
                srpan_tree.heading(col, text=headers[col])
                srpan_tree.column(col, width=col_widths.get(col, 60), anchor='center')
            
            scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=srpan_tree.yview)
            srpan_tree.configure(yscrollcommand=scrollbar.set)
            srpan_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # SonuÃ§larÄ± hesapla
            srpan_results = []
            symbols = df['PREF IBKR'].tolist() if 'PREF IBKR' in df.columns else []
            
            total = len(symbols)
            for i, symbol in enumerate(symbols):
                progress_label.config(text=f"Analiz ediliyor: {symbol} ({i+1}/{total})")
                srpan_win.update()
                
                srpan_data = self.get_srpan_values(symbol)
                
                if srpan_data:
                    srpan_results.append({
                        'symbol': symbol,
                        'grpan1': srpan_data['grpan1'],
                        'grpan1_conf': srpan_data['grpan1_conf'],
                        'grpan2': srpan_data['grpan2'],
                        'grpan2_conf': srpan_data['grpan2_conf'],
                        'spread': srpan_data['spread'],
                        'direction': srpan_data['direction'],
                        'balance_score': srpan_data.get('balance_score', 0),
                        'total_score': srpan_data.get('total_score', 0),
                        'spread_score': srpan_data.get('spread_score', 0),
                        'srpan_score': srpan_data.get('srpan_score', 0)
                    })
                else:
                    srpan_results.append({
                        'symbol': symbol,
                        'grpan1': None,
                        'grpan1_conf': 0,
                        'grpan2': None,
                        'grpan2_conf': 0,
                        'spread': 0,
                        'direction': 'N/A',
                        'balance_score': 0,
                        'total_score': 0,
                        'spread_score': 0,
                        'srpan_score': 0
                    })
            
            # SRPAN skoruna gÃ¶re bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±rala
            srpan_results.sort(key=lambda x: x['srpan_score'], reverse=True)
            
            # Tabloya ekle
            for result in srpan_results:
                srpan_score = result['srpan_score']
                
                if result['grpan1'] is not None:
                    grpan1_str = f"${result['grpan1']:.2f}"
                    g1_conf_str = f"{result['grpan1_conf']:.0f}%"
                else:
                    grpan1_str = "N/A"
                    g1_conf_str = "N/A"
                
                if result['grpan2'] is not None:
                    grpan2_str = f"${result['grpan2']:.2f}"
                    g2_conf_str = f"{result['grpan2_conf']:.0f}%"
                    spread_str = f"${result['spread']:.2f}"
                    direction_str = result['direction']
                    bal_str = f"{result['balance_score']:.0f}"
                    tot_str = f"{result['total_score']:.0f}"
                    spr_str = f"{result['spread_score']:.0f}"
                    
                    # Tag belirleme - SRPAN skoruna gÃ¶re
                    if srpan_score >= 70:
                        tag = 'excellent'
                    elif srpan_score >= 50:
                        tag = 'good'
                    elif srpan_score >= 30:
                        tag = 'fair'
                    else:
                        tag = 'low'
                else:
                    grpan2_str = "N/A"
                    g2_conf_str = "N/A"
                    spread_str = "N/A"
                    direction_str = "N/A"
                    bal_str = "0"
                    tot_str = "0"
                    spr_str = "0"
                    tag = 'no_second'
                
                srpan_str = f"{srpan_score:.1f}"
                
                values = [
                    result['symbol'],
                    srpan_str,
                    grpan1_str,
                    g1_conf_str,
                    grpan2_str,
                    g2_conf_str,
                    spread_str,
                    bal_str,
                    tot_str,
                    spr_str,
                    direction_str
                ]
                
                srpan_tree.insert('', 'end', values=values, tags=(tag,))
            
            # Tag renkleri
            srpan_tree.tag_configure('excellent', background='#32CD32')  # Lime yeÅŸil (SRPAN â‰¥70)
            srpan_tree.tag_configure('good', background='#90EE90')  # AÃ§Ä±k yeÅŸil (SRPAN â‰¥50)
            srpan_tree.tag_configure('fair', background='#FFFFE0')  # AÃ§Ä±k sarÄ± (SRPAN â‰¥30)
            srpan_tree.tag_configure('low', background='#FFD700')  # AltÄ±n sarÄ± (SRPAN <30)
            srpan_tree.tag_configure('no_second', background='#D3D3D3')  # Gri
            
            # SonuÃ§ Ã¶zeti
            excellent_count = sum(1 for r in srpan_results if r['srpan_score'] >= 70)
            good_count = sum(1 for r in srpan_results if 50 <= r['srpan_score'] < 70)
            
            progress_label.config(
                text=f"âœ… TamamlandÄ±! ğŸ¯ MÃ¼kemmel (â‰¥70): {excellent_count} | âœ… Ä°yi (â‰¥50): {good_count} | Toplam: {len(srpan_results)}"
            )
            
            print(f"[SRPAN] âœ… Analiz tamamlandÄ±: {len(srpan_results)} hisse")
            
        except Exception as e:
            print(f"[SRPAN] âŒ Analiz hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"SRPAN analiz hatasÄ±: {e}")
    
    def show_ticker_alerts(self):
        """Ticker Alerts penceresi - SeÃ§ili gruptaki hisseler iÃ§in Daily High/Low takibi"""
        try:
            print(f"[TICKER ALERTS] ğŸ”” Ticker Alerts baÅŸlatÄ±lÄ±yor...")
            
            # Mevcut grup verisi var mÄ± kontrol et
            if self.srpan_current_data is None or self.srpan_current_data.empty:
                messagebox.showwarning("UyarÄ±", "Ã–nce bir grup seÃ§in (heldkuponlu, heldff vb.)")
                return
            
            # Hammer Pro baÄŸlÄ± mÄ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("UyarÄ±", "Hammer Pro baÄŸlantÄ±sÄ± gerekli!")
                return
            
            group_name = self.srpan_current_group
            df = self.srpan_current_data
            
            # Ticker Alerts penceresi
            import tkinter as tk
            from tkinter import ttk
            
            alerts_win = tk.Toplevel(self)
            alerts_win.title(f"ğŸ“Š Ticker Alerts - Daily High/Low [{group_name}]")
            alerts_win.geometry("1300x700")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            # BaÅŸlÄ±k frame
            header_frame = ttk.Frame(alerts_win)
            header_frame.pack(fill='x', padx=10, pady=5)
            
            title_label = ttk.Label(header_frame, 
                text=f"ğŸ“Š Ticker Alerts - Daily High/Low Monitor [{group_name}]", 
                font=("Arial", 12, "bold"))
            title_label.pack(side='left', pady=5)
            
            # Kontrol butonlarÄ±
            control_frame = ttk.Frame(alerts_win)
            control_frame.pack(fill='x', padx=10, pady=5)
            
            # Progress label
            progress_label = ttk.Label(control_frame, text="Veri yÃ¼kleniyor...")
            progress_label.pack(side='left', padx=5)
            
            # Refresh butonu
            def refresh_data():
                load_ticker_data()
            
            btn_refresh = ttk.Button(control_frame, text="ğŸ”„ Yenile", command=refresh_data)
            btn_refresh.pack(side='right', padx=5)
            
            # =============== SOL PANEL - HIGH/LOW TABLOSU ===============
            left_frame = ttk.LabelFrame(alerts_win, text="ğŸ“ˆ Hisse DurumlarÄ±")
            left_frame.pack(side='left', fill='both', expand=True, padx=5, pady=5)
            
            # Ana tablo
            columns = ('Symbol', 'Last', 'High', 'Low', 'H-Dist', 'L-Dist', 'Range', 'Vol')
            main_tree = ttk.Treeview(left_frame, columns=columns, show='headings', height=25)
            
            col_widths = {
                'Symbol': 100, 'Last': 70, 'High': 70, 'Low': 70, 
                'H-Dist': 70, 'L-Dist': 70, 'Range': 70, 'Vol': 90
            }
            
            for col in columns:
                main_tree.heading(col, text=col)
                main_tree.column(col, width=col_widths.get(col, 70), anchor='center')
            
            scrollbar_main = ttk.Scrollbar(left_frame, orient='vertical', command=main_tree.yview)
            main_tree.configure(yscrollcommand=scrollbar_main.set)
            main_tree.pack(side='left', fill='both', expand=True)
            scrollbar_main.pack(side='right', fill='y')
            
            # =============== SAÄ PANEL - ALERT GEÃ‡MÄ°ÅÄ° ===============
            right_frame = ttk.LabelFrame(alerts_win, text="ğŸ”” Alert GeÃ§miÅŸi (New High/Low)")
            right_frame.pack(side='right', fill='both', expand=False, padx=5, pady=5, ipadx=5)
            
            # Alert tablosu
            alert_columns = ('Time', 'Symbol', 'Type', 'Price', 'Chg%')
            alert_tree = ttk.Treeview(right_frame, columns=alert_columns, show='headings', height=25)
            
            alert_col_widths = {'Time': 80, 'Symbol': 80, 'Type': 60, 'Price': 70, 'Chg%': 60}
            
            for col in alert_columns:
                alert_tree.heading(col, text=col)
                alert_tree.column(col, width=alert_col_widths.get(col, 60), anchor='center')
            
            scrollbar_alert = ttk.Scrollbar(right_frame, orient='vertical', command=alert_tree.yview)
            alert_tree.configure(yscrollcommand=scrollbar_alert.set)
            alert_tree.pack(side='left', fill='both', expand=True)
            scrollbar_alert.pack(side='right', fill='y')
            
            # Tag renkleri
            main_tree.tag_configure('near_high', background='#90EE90')  # AÃ§Ä±k yeÅŸil - High'a yakÄ±n
            main_tree.tag_configure('near_low', background='#FFB6C1')   # AÃ§Ä±k kÄ±rmÄ±zÄ± - Low'a yakÄ±n
            main_tree.tag_configure('neutral', background='#FFFACD')    # AÃ§Ä±k sarÄ± - Ortada
            main_tree.tag_configure('new_high', background='#32CD32')   # Koyu yeÅŸil - NEW HIGH!
            main_tree.tag_configure('new_low', background='#FF6347')    # KÄ±rmÄ±zÄ± - NEW LOW!
            
            alert_tree.tag_configure('high', background='#32CD32')
            alert_tree.tag_configure('low', background='#FF6347')
            
            # Veri yapÄ±larÄ±
            # baseline_data: Ä°lk yÃ¼klemede kaydedilen daily high/low deÄŸerleri (deÄŸiÅŸmez referans)
            # ticker_data: Åu anki fiyatlar ve hesaplanan high/low
            baseline_data = {}  # {symbol: {'baseline_high': x, 'baseline_low': y, 'prev_close': p}}
            ticker_data = {}    # {symbol: {'last': z, 'volume': v}}
            alert_history = []
            is_first_load = [True]  # Mutable container for nonlocal access
            
            def load_ticker_data():
                """TÃ¼m tickerlar iÃ§in veri yÃ¼kle ve karÅŸÄ±laÅŸtÄ±r
                
                MANTIK:
                - Ä°lk yÃ¼klemede: market_data'dan gelen HIGH ve LOW deÄŸerlerini baseline olarak kaydet
                - Sonraki kontrollerde: Mevcut HIGH/LOW'u baseline ile karÅŸÄ±laÅŸtÄ±r
                - Sadece baseline_high AÅILIRSA veya baseline_low'un ALTINA dÃ¼ÅŸÃ¼lÃ¼rse alert
                """
                nonlocal baseline_data, ticker_data, alert_history
                
                symbols = df['PREF IBKR'].tolist() if 'PREF IBKR' in df.columns else []
                total = len(symbols)
                
                print(f"[TICKER ALERTS] ğŸ“Š {'Ä°lk yÃ¼kleme - getSymbolSnapshot ile Daily High/Low kaydediliyor' if is_first_load[0] else '30sn kontrol - getSymbolSnapshot ile karÅŸÄ±laÅŸtÄ±rma'} - {total} sembol")
                
                main_tree.delete(*main_tree.get_children())
                new_high_count = 0
                new_low_count = 0
                
                for i, symbol in enumerate(symbols):
                    if i % 50 == 0:
                        progress_label.config(text=f"Kontrol: {symbol} ({i+1}/{total})")
                        alerts_win.update()
                    
                    try:
                        # getSymbolSnapshot kullanarak GERÃ‡EK daily high/low al
                        snapshot = self.hammer.get_symbol_snapshot(symbol)
                        
                        if snapshot:
                            # Documentation'a gÃ¶re: high = Session high, low = Session low
                            last = float(snapshot.get('last', 0) or 0)
                            current_daily_high = float(snapshot.get('high', 0) or 0)
                            current_daily_low = float(snapshot.get('low', 0) or 0)
                            volume = snapshot.get('volume', 0)
                            prev_close = float(snapshot.get('prevClose', 0) or 0)
                            
                            if last <= 0:
                                continue
                            
                            # EÄŸer high/low yoksa last kullan (nadiren olur)
                            if current_daily_high <= 0:
                                current_daily_high = last
                            if current_daily_low <= 0 or current_daily_low > last:
                                current_daily_low = last
                            
                            # Ä°lk yÃ¼klemede: Daily High/Low'u baseline olarak kaydet
                            if is_first_load[0]:
                                baseline_data[symbol] = {
                                    'baseline_high': current_daily_high,  # DAILY HIGH
                                    'baseline_low': current_daily_low,    # DAILY LOW
                                    'prev_close': prev_close
                                }
                                ticker_data[symbol] = {'last': last, 'volume': volume}
                                tag = 'neutral'
                                # Debug: Ä°lk yÃ¼klemede sadece ilk 5 hisseyi logla
                                if len(baseline_data) <= 5:
                                    print(f"[BASELINE] {symbol}: Last=${last:.2f}, DailyHigh=${current_daily_high:.2f}, DailyLow=${current_daily_low:.2f}, PrevClose=${prev_close:.2f}")
                            else:
                                # Sonraki kontrollerde: Mevcut daily high/low'u baseline ile karÅŸÄ±laÅŸtÄ±r
                                if symbol not in baseline_data:
                                    # Yeni sembol, baseline kaydet
                                    baseline_data[symbol] = {
                                        'baseline_high': current_daily_high,
                                        'baseline_low': current_daily_low,
                                        'prev_close': prev_close
                                    }
                                    tag = 'neutral'
                                else:
                                    baseline_high = baseline_data[symbol]['baseline_high']
                                    baseline_low = baseline_data[symbol]['baseline_low']
                                    stored_prev_close = baseline_data[symbol]['prev_close']
                                    
                                    tag = 'neutral'
                                    
                                    # NEW HIGH: Mevcut daily high, baseline high'Ä± AÅTI mÄ±?
                                    if current_daily_high > baseline_high + 0.001:  # 0.001 tolerans
                                        tag = 'new_high'
                                        new_high_count += 1
                                        # Baseline'Ä± gÃ¼ncelle
                                        baseline_data[symbol]['baseline_high'] = current_daily_high
                                        # Alert ekle
                                        chg = ((last - stored_prev_close) / stored_prev_close * 100) if stored_prev_close > 0 else 0
                                        alert_entry = {
                                            'time': datetime.now().strftime('%H:%M:%S'),
                                            'symbol': symbol,
                                            'type': 'ğŸ”º HIGH',
                                            'price': last,
                                            'chg': chg
                                        }
                                        alert_history.insert(0, alert_entry)
                                        print(f"[TICKER ALERTS] ğŸ”º NEW DAILY HIGH: {symbol} ${current_daily_high:.2f} (Ã¶nceki: ${baseline_high:.2f})")
                                    
                                    # NEW LOW: Mevcut daily low, baseline low'un ALTINA dÃ¼ÅŸtÃ¼ mÃ¼?
                                    elif current_daily_low < baseline_low - 0.001:  # 0.001 tolerans
                                        tag = 'new_low'
                                        new_low_count += 1
                                        # Baseline'Ä± gÃ¼ncelle
                                        baseline_data[symbol]['baseline_low'] = current_daily_low
                                        # Alert ekle
                                        chg = ((last - stored_prev_close) / stored_prev_close * 100) if stored_prev_close > 0 else 0
                                        alert_entry = {
                                            'time': datetime.now().strftime('%H:%M:%S'),
                                            'symbol': symbol,
                                            'type': 'ğŸ”» LOW',
                                            'price': last,
                                            'chg': chg
                                        }
                                        alert_history.insert(0, alert_entry)
                                        print(f"[TICKER ALERTS] ğŸ”» NEW DAILY LOW: {symbol} ${current_daily_low:.2f} (Ã¶nceki: ${baseline_low:.2f})")
                                    else:
                                        # High/Low'a yakÄ±nlÄ±k
                                        range_val = baseline_high - baseline_low
                                        if range_val > 0:
                                            position = ((last - baseline_low) / range_val) * 100
                                            if position >= 80:
                                                tag = 'near_high'
                                            elif position <= 20:
                                                tag = 'near_low'
                                
                                ticker_data[symbol] = {'last': last, 'volume': volume}
                            
                            # Tabloda gÃ¶sterilecek deÄŸerler (baseline veya gÃ¼ncel)
                            if symbol in baseline_data:
                                high = baseline_data[symbol]['baseline_high']
                                low = baseline_data[symbol]['baseline_low']
                            else:
                                high = current_daily_high
                                low = current_daily_low
                            
                            # Hesaplamalar
                            range_val = high - low
                            h_dist = high - last
                            l_dist = last - low
                            
                            # Volume formatla
                            if volume:
                                vol_int = int(float(volume))
                                if vol_int >= 1000000:
                                    vol_str = f"{vol_int/1000000:.1f}M"
                                elif vol_int >= 1000:
                                    vol_str = f"{vol_int/1000:.0f}K"
                                else:
                                    vol_str = str(vol_int)
                            else:
                                vol_str = "N/A"
                            
                            values = [
                                symbol,
                                f"${last:.2f}",
                                f"${high:.2f}",
                                f"${low:.2f}",
                                f"${h_dist:.2f}",
                                f"${l_dist:.2f}",
                                f"${range_val:.2f}",
                                vol_str
                            ]
                            
                            main_tree.insert('', 'end', values=values, tags=(tag,))
                                
                    except Exception as e:
                        print(f"[TICKER ALERTS] âš ï¸ {symbol} veri hatasÄ±: {e}")
                
                # Alert geÃ§miÅŸini gÃ¼ncelle
                alert_tree.delete(*alert_tree.get_children())
                for alert in alert_history[:50]:  # Son 50 alert
                    alert_tag = 'high' if 'HIGH' in alert['type'] else 'low'
                    alert_tree.insert('', 'end', values=[
                        alert['time'],
                        alert['symbol'],
                        alert['type'],
                        f"${alert['price']:.2f}",
                        f"{alert['chg']:+.2f}%"
                    ], tags=(alert_tag,))
                
                # Ä°lk yÃ¼kleme tamamlandÄ±
                is_first_load[0] = False
                
                # SonuÃ§ Ã¶zeti
                progress_label.config(
                    text=f"âœ… {len(baseline_data)} hisse | ğŸ”º {new_high_count} New High | ğŸ”» {new_low_count} New Low | Son: {datetime.now().strftime('%H:%M:%S')}"
                )
                
                print(f"[TICKER ALERTS] âœ… {len(baseline_data)} hisse | New High: {new_high_count} | New Low: {new_low_count}")
            
            # Ä°lk yÃ¼kleme
            from datetime import datetime
            load_ticker_data()
            
            # Otomatik yenileme (her 30 saniye)
            def auto_refresh():
                if alerts_win.winfo_exists():
                    load_ticker_data()
                    alerts_win.after(30000, auto_refresh)
            
            # Ä°lk otomatik yenileme zamanlamasÄ±
            alerts_win.after(30000, auto_refresh)
            
            print(f"[TICKER ALERTS] âœ… Pencere aÃ§Ä±ldÄ±: {group_name}")
            
        except Exception as e:
            print(f"[TICKER ALERTS] âŒ Hata: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Ticker Alerts hatasÄ±: {e}")
    
    def show_etf_cardinal(self):
        """ETF Cardinal penceresi - ETF bazlÄ± emir iptal sistemi"""
        try:
            print(f"[ETF CARDINAL] ğŸ¯ ETF Cardinal baÅŸlatÄ±lÄ±yor...")
            
            # Hammer Pro baÄŸlÄ± mÄ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("UyarÄ±", "Hammer Pro baÄŸlantÄ±sÄ± gerekli!")
                return
            
            # ETF Cardinal penceresi
            import tkinter as tk
            from tkinter import ttk
            from datetime import datetime
            import os
            
            # EÄŸer pencere zaten aÃ§Ä±ksa, Ã¶ne getir
            if self.cardinal_window and self.cardinal_window.winfo_exists():
                self.cardinal_window.lift()
                return
            
            cardinal_win = tk.Toplevel(self)
            cardinal_win.title("ğŸ¯ ETF Cardinal - Otomatik Emir Ä°ptal Sistemi")
            cardinal_win.geometry("900x700")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            self.cardinal_window = cardinal_win
            
            # Pencere kapatÄ±ldÄ±ÄŸÄ±nda tracker'Ä± durdur
            def on_closing():
                self.stop_cardinal_tracker()
                cardinal_win.destroy()
                self.cardinal_window = None
            
            cardinal_win.protocol("WM_DELETE_WINDOW", on_closing)
            
            # =============== BAÅLIK ===============
            header_frame = ttk.Frame(cardinal_win)
            header_frame.pack(fill='x', padx=10, pady=5)
            
            title_label = ttk.Label(header_frame, 
                text="ğŸ¯ ETF Cardinal - Otomatik Emir Ä°ptal Sistemi", 
                font=("Arial", 14, "bold"))
            title_label.pack(side='left', pady=5)
            
            # Durum gÃ¶stergesi
            self.cardinal_status_label = ttk.Label(header_frame, text="âšª Durduruldu", 
                                                   font=("Arial", 10, "bold"))
            self.cardinal_status_label.pack(side='right', padx=10)
            
            # =============== AYARLAR FRAME ===============
            settings_frame = ttk.LabelFrame(cardinal_win, text="âš™ï¸ EÅŸik AyarlarÄ± (DÃ¼ÅŸÃ¼ÅŸ/YÃ¼kseliÅŸ Tetikleyicileri)")
            settings_frame.pack(fill='x', padx=10, pady=5)
            
            # Tablo baÅŸlÄ±klarÄ±
            header_row = ttk.Frame(settings_frame)
            header_row.pack(fill='x', padx=5, pady=2)
            
            ttk.Label(header_row, text="ETF", width=8, font=("Arial", 9, "bold")).pack(side='left', padx=5)
            ttk.Label(header_row, text="2dk EÅŸik", width=12, font=("Arial", 9, "bold")).pack(side='left', padx=5)
            ttk.Label(header_row, text="5dk EÅŸik", width=12, font=("Arial", 9, "bold")).pack(side='left', padx=5)
            ttk.Label(header_row, text="Tip", width=10, font=("Arial", 9, "bold")).pack(side='left', padx=5)
            
            # Entry'ler iÃ§in dictionary
            self.cardinal_entries = {}
            
            etf_configs = [
                ('PFF', 'absolute', '$'),
                ('SPY', 'percent', '%'),
                ('KRE', 'percent', '%'),
                ('IWM', 'percent', '%'),
                ('TLT', 'absolute', '$')
            ]
            
            for etf, typ, symbol in etf_configs:
                row = ttk.Frame(settings_frame)
                row.pack(fill='x', padx=5, pady=2)
                
                ttk.Label(row, text=etf, width=8, font=("Arial", 10, "bold")).pack(side='left', padx=5)
                
                # 2dk entry
                entry_2min = ttk.Entry(row, width=10)
                entry_2min.insert(0, str(self.cardinal_settings[etf]['threshold_2min']))
                entry_2min.pack(side='left', padx=5)
                
                # 5dk entry
                entry_5min = ttk.Entry(row, width=10)
                entry_5min.insert(0, str(self.cardinal_settings[etf]['threshold_5min']))
                entry_5min.pack(side='left', padx=5)
                
                # Tip label
                ttk.Label(row, text=f"{symbol} ({typ})", width=12).pack(side='left', padx=5)
                
                self.cardinal_entries[etf] = {
                    'entry_2min': entry_2min,
                    'entry_5min': entry_5min,
                    'type': typ
                }
            
            # =============== KONTROL BUTONLARI ===============
            control_frame = ttk.Frame(cardinal_win)
            control_frame.pack(fill='x', padx=10, pady=10)
            
            def save_settings():
                """AyarlarÄ± kaydet"""
                try:
                    for etf, entries in self.cardinal_entries.items():
                        val_2min = float(entries['entry_2min'].get())
                        val_5min = float(entries['entry_5min'].get())
                        self.cardinal_settings[etf]['threshold_2min'] = val_2min
                        self.cardinal_settings[etf]['threshold_5min'] = val_5min
                    
                    # CSV'ye kaydet
                    settings_path = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 
                                                'etf_cardinal_settings.csv')
                    with open(settings_path, 'w') as f:
                        f.write("etf,threshold_2min,threshold_5min,type\n")
                        for etf, settings in self.cardinal_settings.items():
                            f.write(f"{etf},{settings['threshold_2min']},{settings['threshold_5min']},{settings['type']}\n")
                    
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", "Ayarlar kaydedildi!")
                    print(f"[ETF CARDINAL] âœ… Ayarlar kaydedildi: {settings_path}")
                except Exception as e:
                    messagebox.showerror("Hata", f"Ayar kaydetme hatasÄ±: {e}")
            
            def load_settings():
                """AyarlarÄ± yÃ¼kle"""
                try:
                    settings_path = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 
                                                'etf_cardinal_settings.csv')
                    if os.path.exists(settings_path):
                        import pandas as pd
                        df = pd.read_csv(settings_path)
                        for _, row in df.iterrows():
                            etf = row['etf']
                            if etf in self.cardinal_settings:
                                self.cardinal_settings[etf]['threshold_2min'] = float(row['threshold_2min'])
                                self.cardinal_settings[etf]['threshold_5min'] = float(row['threshold_5min'])
                                # Entry'leri gÃ¼ncelle
                                if etf in self.cardinal_entries:
                                    self.cardinal_entries[etf]['entry_2min'].delete(0, 'end')
                                    self.cardinal_entries[etf]['entry_2min'].insert(0, str(row['threshold_2min']))
                                    self.cardinal_entries[etf]['entry_5min'].delete(0, 'end')
                                    self.cardinal_entries[etf]['entry_5min'].insert(0, str(row['threshold_5min']))
                        print(f"[ETF CARDINAL] âœ… Ayarlar yÃ¼klendi")
                except Exception as e:
                    print(f"[ETF CARDINAL] âš ï¸ Ayar yÃ¼kleme hatasÄ±: {e}")
            
            # AyarlarÄ± yÃ¼kle (baÅŸlangÄ±Ã§ta)
            load_settings()
            
            btn_save = ttk.Button(control_frame, text="ğŸ’¾ Kaydet", command=save_settings)
            btn_save.pack(side='left', padx=5)
            
            self.btn_start_cardinal = ttk.Button(control_frame, text="â–¶ï¸ Cardinal Tracker BaÅŸlat", 
                                                command=lambda: self.start_cardinal_tracker(cardinal_win))
            self.btn_start_cardinal.pack(side='left', padx=5)
            
            self.btn_stop_cardinal = ttk.Button(control_frame, text="â¹ï¸ Durdur", 
                                               command=self.stop_cardinal_tracker, state='disabled')
            self.btn_stop_cardinal.pack(side='left', padx=5)
            
            # =============== CANLI DURUM FRAME ===============
            live_frame = ttk.LabelFrame(cardinal_win, text="ğŸ“Š CanlÄ± ETF Durumu")
            live_frame.pack(fill='x', padx=10, pady=5)
            
            # CanlÄ± durum tablosu
            live_columns = ('ETF', 'Last', '2dk Ã–nce', '2dk Chg', '5dk Ã–nce', '5dk Chg', 'Durum')
            self.cardinal_live_tree = ttk.Treeview(live_frame, columns=live_columns, show='headings', height=5)
            
            col_widths = {'ETF': 60, 'Last': 80, '2dk Ã–nce': 80, '2dk Chg': 80, '5dk Ã–nce': 80, '5dk Chg': 80, 'Durum': 100}
            for col in live_columns:
                self.cardinal_live_tree.heading(col, text=col)
                self.cardinal_live_tree.column(col, width=col_widths.get(col, 80), anchor='center')
            
            self.cardinal_live_tree.pack(fill='x', padx=5, pady=5)
            
            # Tag renkleri
            self.cardinal_live_tree.tag_configure('bearish', background='#FF6347')  # KÄ±rmÄ±zÄ±
            self.cardinal_live_tree.tag_configure('bullish', background='#32CD32')  # YeÅŸil
            self.cardinal_live_tree.tag_configure('neutral', background='#FFFACD')  # SarÄ±
            
            # =============== LOG FRAME ===============
            log_frame = ttk.LabelFrame(cardinal_win, text="ğŸ“œ Ä°ÅŸlem Logu")
            log_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Log text widget
            self.cardinal_log_text = tk.Text(log_frame, height=15, width=80, font=("Consolas", 9))
            log_scrollbar = ttk.Scrollbar(log_frame, orient='vertical', command=self.cardinal_log_text.yview)
            self.cardinal_log_text.configure(yscrollcommand=log_scrollbar.set)
            self.cardinal_log_text.pack(side='left', fill='both', expand=True, padx=5, pady=5)
            log_scrollbar.pack(side='right', fill='y')
            
            # Tag renkleri log iÃ§in
            self.cardinal_log_text.tag_configure('cancel_buys', foreground='red', font=("Consolas", 9, "bold"))
            self.cardinal_log_text.tag_configure('cancel_sells', foreground='green', font=("Consolas", 9, "bold"))
            self.cardinal_log_text.tag_configure('info', foreground='blue')
            self.cardinal_log_text.tag_configure('normal', foreground='black')
            
            # BaÅŸlangÄ±Ã§ mesajÄ±
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] ETF Cardinal baÅŸlatÄ±ldÄ±. Tracker'Ä± baÅŸlatmak iÃ§in 'â–¶ï¸ Cardinal Tracker BaÅŸlat' butonuna tÄ±klayÄ±n.", 'info')
            
            print(f"[ETF CARDINAL] âœ… Pencere aÃ§Ä±ldÄ±")
            
        except Exception as e:
            print(f"[ETF CARDINAL] âŒ Hata: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"ETF Cardinal hatasÄ±: {e}")
    
    def log_cardinal(self, message, tag='normal'):
        """Cardinal log'a mesaj ekle"""
        try:
            if hasattr(self, 'cardinal_log_text') and self.cardinal_log_text.winfo_exists():
                self.cardinal_log_text.insert('end', message + '\n', tag)
                self.cardinal_log_text.see('end')
        except:
            pass
    
    def start_cardinal_tracker(self, window):
        """Cardinal Tracker'Ä± baÅŸlat"""
        try:
            from datetime import datetime
            
            self.cardinal_running = True
            self.cardinal_price_history = []
            
            # UI gÃ¼ncelle
            self.btn_start_cardinal.config(state='disabled')
            self.btn_stop_cardinal.config(state='normal')
            self.cardinal_status_label.config(text="ğŸŸ¢ Ã‡alÄ±ÅŸÄ±yor", foreground='green')
            
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] â–¶ï¸ Cardinal Tracker baÅŸlatÄ±ldÄ±!", 'info')
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] Her 1 dakikada veri Ã§ekilecek, 2dk ve 5dk deÄŸiÅŸimler kontrol edilecek.", 'info')
            
            # Ä°lk veri Ã§ekimi
            self.cardinal_check_etfs()
            
            print(f"[ETF CARDINAL] â–¶ï¸ Tracker baÅŸlatÄ±ldÄ±")
            
        except Exception as e:
            print(f"[ETF CARDINAL] âŒ BaÅŸlatma hatasÄ±: {e}")
            self.cardinal_running = False
    
    def stop_cardinal_tracker(self):
        """Cardinal Tracker'Ä± durdur"""
        try:
            from datetime import datetime
            
            self.cardinal_running = False
            
            # ZamanlayÄ±cÄ±yÄ± iptal et
            if self.cardinal_after_id:
                try:
                    if self.cardinal_window and self.cardinal_window.winfo_exists():
                        self.cardinal_window.after_cancel(self.cardinal_after_id)
                except:
                    pass
                self.cardinal_after_id = None
            
            # UI gÃ¼ncelle
            if hasattr(self, 'btn_start_cardinal'):
                try:
                    self.btn_start_cardinal.config(state='normal')
                    self.btn_stop_cardinal.config(state='disabled')
                    self.cardinal_status_label.config(text="âšª Durduruldu", foreground='gray')
                except:
                    pass
            
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] â¹ï¸ Cardinal Tracker durduruldu.", 'info')
            
            print(f"[ETF CARDINAL] â¹ï¸ Tracker durduruldu")
            
        except Exception as e:
            print(f"[ETF CARDINAL] âŒ Durdurma hatasÄ±: {e}")
    
    def cardinal_check_etfs(self):
        """ETF'leri kontrol et ve gerekirse cancel at"""
        if not self.cardinal_running:
            return
        
        try:
            from datetime import datetime
            import time
            
            current_time = datetime.now()
            timestamp = current_time.strftime('%H:%M:%S')
            
            # ETF fiyatlarÄ±nÄ± Ã§ek
            etf_list = ['PFF', 'SPY', 'KRE', 'IWM', 'TLT']
            current_prices = {'timestamp': current_time}
            
            for etf in etf_list:
                try:
                    market_data = self.hammer.get_market_data(etf)
                    if market_data:
                        last_price = float(market_data.get('last', 0) or 0)
                        current_prices[etf] = last_price
                    else:
                        current_prices[etf] = 0
                except Exception as e:
                    current_prices[etf] = 0
                    print(f"[ETF CARDINAL] âš ï¸ {etf} veri hatasÄ±: {e}")
            
            # GeÃ§miÅŸe ekle
            self.cardinal_price_history.append(current_prices)
            
            # Son 6 dakikalÄ±k veriyi tut (5dk + 1 buffer)
            if len(self.cardinal_price_history) > 6:
                self.cardinal_price_history = self.cardinal_price_history[-6:]
            
            # CanlÄ± tabloyu gÃ¼ncelle
            self.update_cardinal_live_table(current_prices)
            
            # Yeterli veri var mÄ± kontrol et (en az 2 dakika iÃ§in 2 veri gerekli)
            if len(self.cardinal_price_history) >= 2:
                self.check_cardinal_thresholds(current_prices, timestamp)
            else:
                self.log_cardinal(f"[{timestamp}] â³ Veri toplama: {len(self.cardinal_price_history)}/2 (2dk iÃ§in bekleniyor...)", 'info')
            
            # 1 dakika sonra tekrar Ã§aÄŸÄ±r
            if self.cardinal_running and self.cardinal_window and self.cardinal_window.winfo_exists():
                self.cardinal_after_id = self.cardinal_window.after(60000, self.cardinal_check_etfs)
            
        except Exception as e:
            print(f"[ETF CARDINAL] âŒ Check hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile devam et
            if self.cardinal_running and self.cardinal_window and self.cardinal_window.winfo_exists():
                self.cardinal_after_id = self.cardinal_window.after(60000, self.cardinal_check_etfs)
    
    def update_cardinal_live_table(self, current_prices):
        """CanlÄ± tabloyu gÃ¼ncelle"""
        try:
            # Tabloyu temizle
            for item in self.cardinal_live_tree.get_children():
                self.cardinal_live_tree.delete(item)
            
            etf_list = ['PFF', 'SPY', 'KRE', 'IWM', 'TLT']
            
            for etf in etf_list:
                current = current_prices.get(etf, 0)
                
                # 2dk Ã¶nceki fiyat
                price_2min_ago = 0
                if len(self.cardinal_price_history) >= 2:
                    price_2min_ago = self.cardinal_price_history[-2].get(etf, 0)
                
                # 5dk Ã¶nceki fiyat
                price_5min_ago = 0
                if len(self.cardinal_price_history) >= 5:
                    price_5min_ago = self.cardinal_price_history[-5].get(etf, 0)
                
                # DeÄŸiÅŸim hesapla
                settings = self.cardinal_settings[etf]
                
                if settings['type'] == 'absolute':
                    chg_2min = current - price_2min_ago if price_2min_ago > 0 else 0
                    chg_5min = current - price_5min_ago if price_5min_ago > 0 else 0
                    chg_2min_str = f"${chg_2min:+.2f}"
                    chg_5min_str = f"${chg_5min:+.2f}"
                else:
                    chg_2min = ((current - price_2min_ago) / price_2min_ago * 100) if price_2min_ago > 0 else 0
                    chg_5min = ((current - price_5min_ago) / price_5min_ago * 100) if price_5min_ago > 0 else 0
                    chg_2min_str = f"{chg_2min:+.2f}%"
                    chg_5min_str = f"{chg_5min:+.2f}%"
                
                # Durum belirleme
                threshold_2min = settings['threshold_2min']
                threshold_5min = settings['threshold_5min']
                
                if settings['type'] == 'absolute':
                    is_bearish = chg_2min <= -threshold_2min or chg_5min <= -threshold_5min
                    is_bullish = chg_2min >= threshold_2min or chg_5min >= threshold_5min
                else:
                    is_bearish = chg_2min <= -threshold_2min or chg_5min <= -threshold_5min
                    is_bullish = chg_2min >= threshold_2min or chg_5min >= threshold_5min
                
                if is_bearish:
                    status = "ğŸ”´ BEARISH"
                    tag = 'bearish'
                elif is_bullish:
                    status = "ğŸŸ¢ BULLISH"
                    tag = 'bullish'
                else:
                    status = "âšª NÃ¶tr"
                    tag = 'neutral'
                
                values = [
                    etf,
                    f"${current:.2f}" if current > 0 else "N/A",
                    f"${price_2min_ago:.2f}" if price_2min_ago > 0 else "N/A",
                    chg_2min_str if price_2min_ago > 0 else "N/A",
                    f"${price_5min_ago:.2f}" if price_5min_ago > 0 else "N/A",
                    chg_5min_str if price_5min_ago > 0 else "N/A",
                    status
                ]
                
                self.cardinal_live_tree.insert('', 'end', values=values, tags=(tag,))
                
        except Exception as e:
            print(f"[ETF CARDINAL] âŒ Tablo gÃ¼ncelleme hatasÄ±: {e}")
    
    def check_cardinal_thresholds(self, current_prices, timestamp):
        """EÅŸikleri kontrol et ve gerekirse cancel at"""
        try:
            etf_list = ['PFF', 'SPY', 'KRE', 'IWM', 'TLT']
            
            bearish_triggers = []
            bullish_triggers = []
            
            for etf in etf_list:
                current = current_prices.get(etf, 0)
                settings = self.cardinal_settings[etf]
                
                # 2dk Ã¶nceki fiyat
                price_2min_ago = 0
                if len(self.cardinal_price_history) >= 2:
                    price_2min_ago = self.cardinal_price_history[-2].get(etf, 0)
                
                # 5dk Ã¶nceki fiyat
                price_5min_ago = 0
                if len(self.cardinal_price_history) >= 5:
                    price_5min_ago = self.cardinal_price_history[-5].get(etf, 0)
                
                threshold_2min = settings['threshold_2min']
                threshold_5min = settings['threshold_5min']
                
                if settings['type'] == 'absolute':
                    # Mutlak deÄŸiÅŸim (cent)
                    chg_2min = current - price_2min_ago if price_2min_ago > 0 else 0
                    chg_5min = current - price_5min_ago if price_5min_ago > 0 else 0
                    
                    # 2dk kontrol
                    if price_2min_ago > 0:
                        if chg_2min <= -threshold_2min:
                            bearish_triggers.append(f"{etf} 2dk: ${chg_2min:.2f} (eÅŸik: -${threshold_2min})")
                        elif chg_2min >= threshold_2min:
                            bullish_triggers.append(f"{etf} 2dk: +${chg_2min:.2f} (eÅŸik: +${threshold_2min})")
                    
                    # 5dk kontrol
                    if price_5min_ago > 0 and len(self.cardinal_price_history) >= 5:
                        if chg_5min <= -threshold_5min:
                            bearish_triggers.append(f"{etf} 5dk: ${chg_5min:.2f} (eÅŸik: -${threshold_5min})")
                        elif chg_5min >= threshold_5min:
                            bullish_triggers.append(f"{etf} 5dk: +${chg_5min:.2f} (eÅŸik: +${threshold_5min})")
                else:
                    # YÃ¼zde deÄŸiÅŸim
                    chg_2min = ((current - price_2min_ago) / price_2min_ago * 100) if price_2min_ago > 0 else 0
                    chg_5min = ((current - price_5min_ago) / price_5min_ago * 100) if price_5min_ago > 0 else 0
                    
                    # 2dk kontrol
                    if price_2min_ago > 0:
                        if chg_2min <= -threshold_2min:
                            bearish_triggers.append(f"{etf} 2dk: {chg_2min:.2f}% (eÅŸik: -{threshold_2min}%)")
                        elif chg_2min >= threshold_2min:
                            bullish_triggers.append(f"{etf} 2dk: +{chg_2min:.2f}% (eÅŸik: +{threshold_2min}%)")
                    
                    # 5dk kontrol
                    if price_5min_ago > 0 and len(self.cardinal_price_history) >= 5:
                        if chg_5min <= -threshold_5min:
                            bearish_triggers.append(f"{etf} 5dk: {chg_5min:.2f}% (eÅŸik: -{threshold_5min}%)")
                        elif chg_5min >= threshold_5min:
                            bullish_triggers.append(f"{etf} 5dk: +{chg_5min:.2f}% (eÅŸik: +{threshold_5min}%)")
            
            # Tetikleyici varsa iÅŸlem yap
            if bearish_triggers:
                self.log_cardinal(f"[{timestamp}] ğŸ”´ BEARISH TETÄ°KLEYÄ°CÄ°: {', '.join(bearish_triggers)}", 'cancel_buys')
                self.log_cardinal(f"[{timestamp}] ğŸ”´ CANCEL ALL BUYS tetikleniyor!", 'cancel_buys')
                self.cardinal_cancel_all_buys()
                
            elif bullish_triggers:
                self.log_cardinal(f"[{timestamp}] ğŸŸ¢ BULLISH TETÄ°KLEYÄ°CÄ°: {', '.join(bullish_triggers)}", 'cancel_sells')
                self.log_cardinal(f"[{timestamp}] ğŸŸ¢ CANCEL ALL SELLS tetikleniyor!", 'cancel_sells')
                self.cardinal_cancel_all_sells()
                
            else:
                self.log_cardinal(f"[{timestamp}] âœ… TÃ¼m ETF'ler normal aralÄ±kta.", 'normal')
            
        except Exception as e:
            print(f"[ETF CARDINAL] âŒ Threshold kontrol hatasÄ±: {e}")
    
    def cardinal_cancel_all_buys(self):
        """TÃ¼m BUY emirlerini iptal et"""
        try:
            from datetime import datetime
            timestamp = datetime.now().strftime('%H:%M:%S')
            
            # AÃ§Ä±k emirleri al
            orders = self.hammer.get_orders(self.hammer.account_key)
            
            buy_orders = [o for o in orders if o.get('Action', '').lower() in ['buy'] and o.get('IsOpen', False)]
            
            if not buy_orders:
                self.log_cardinal(f"[{timestamp}] â„¹ï¸ Ä°ptal edilecek BUY emri bulunamadÄ±.", 'info')
                return
            
            cancelled_count = 0
            for order in buy_orders:
                order_id = order.get('OrderID')
                symbol = order.get('Symbol', 'N/A')
                
                if order_id:
                    success = self.hammer.trade_command_cancel(self.hammer.account_key, order_id)
                    if success:
                        self.log_cardinal(f"[{timestamp}] ğŸ”´ BUY iptal edildi: {symbol} (Order: {order_id})", 'cancel_buys')
                        cancelled_count += 1
                    else:
                        self.log_cardinal(f"[{timestamp}] âš ï¸ BUY iptal BAÅARISIZ: {symbol} (Order: {order_id})", 'info')
            
            self.log_cardinal(f"[{timestamp}] ğŸ”´ Toplam {cancelled_count} BUY emri iptal edildi.", 'cancel_buys')
            
        except Exception as e:
            print(f"[ETF CARDINAL] âŒ Cancel all buys hatasÄ±: {e}")
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] âŒ Cancel hatasÄ±: {e}", 'info')
    
    def cardinal_cancel_all_sells(self):
        """TÃ¼m SELL emirlerini iptal et"""
        try:
            from datetime import datetime
            timestamp = datetime.now().strftime('%H:%M:%S')
            
            # AÃ§Ä±k emirleri al
            orders = self.hammer.get_orders(self.hammer.account_key)
            
            sell_orders = [o for o in orders if o.get('Action', '').lower() in ['sell', 'short'] and o.get('IsOpen', False)]
            
            if not sell_orders:
                self.log_cardinal(f"[{timestamp}] â„¹ï¸ Ä°ptal edilecek SELL emri bulunamadÄ±.", 'info')
                return
            
            cancelled_count = 0
            for order in sell_orders:
                order_id = order.get('OrderID')
                symbol = order.get('Symbol', 'N/A')
                
                if order_id:
                    success = self.hammer.trade_command_cancel(self.hammer.account_key, order_id)
                    if success:
                        self.log_cardinal(f"[{timestamp}] ğŸŸ¢ SELL iptal edildi: {symbol} (Order: {order_id})", 'cancel_sells')
                        cancelled_count += 1
                    else:
                        self.log_cardinal(f"[{timestamp}] âš ï¸ SELL iptal BAÅARISIZ: {symbol} (Order: {order_id})", 'info')
            
            self.log_cardinal(f"[{timestamp}] ğŸŸ¢ Toplam {cancelled_count} SELL emri iptal edildi.", 'cancel_sells')
            
        except Exception as e:
            print(f"[ETF CARDINAL] âŒ Cancel all sells hatasÄ±: {e}")
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] âŒ Cancel hatasÄ±: {e}", 'info')
    
    def show_tgfilterer(self):
        """TGFilterer penceresi - Grup bazlÄ± Top/Bottom 3 analizi ve filtreleme"""
        try:
            import tkinter as tk
            from tkinter import ttk
            import pandas as pd
            import os
            
            print(f"[TGFilterer] ğŸ” TGFilterer baÅŸlatÄ±lÄ±yor...")
            
            # Hammer Pro baÄŸlÄ± mÄ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("UyarÄ±", "Hammer Pro baÄŸlantÄ±sÄ± gerekli!")
                return
            
            # TGFilterer penceresi
            tg_win = tk.Toplevel(self)
            tg_win.title("ğŸ” TGFilterer - Grup BazlÄ± Top/Bottom Analizi")
            tg_win.geometry("1400x800")
            # transient kaldÄ±rÄ±ldÄ± - baÄŸÄ±msÄ±z pencere, minimize edilebilir
            
            # =============== ÃœST PANEL - FÄ°LTRELER ===============
            filter_frame = ttk.LabelFrame(tg_win, text="ğŸ”§ Filtreler")
            filter_frame.pack(fill='x', padx=10, pady=5)
            
            # Filtre satÄ±r 1 - SayÄ±sal filtreler
            filter_row1 = ttk.Frame(filter_frame)
            filter_row1.pack(fill='x', padx=5, pady=3)
            
            # Spread filtresi
            ttk.Label(filter_row1, text="Spread:").pack(side='left', padx=2)
            spread_op_var = tk.StringVar(value="<")
            spread_op = ttk.Combobox(filter_row1, textvariable=spread_op_var, values=["<", ">", "=", "<=", ">="], width=3)
            spread_op.pack(side='left', padx=2)
            spread_val_var = tk.StringVar(value="0.10")
            spread_entry = ttk.Entry(filter_row1, textvariable=spread_val_var, width=8)
            spread_entry.pack(side='left', padx=2)
            
            ttk.Label(filter_row1, text="  |  ").pack(side='left')
            
            # FINAL_THG filtresi
            ttk.Label(filter_row1, text="FINAL_THG:").pack(side='left', padx=2)
            thg_op_var = tk.StringVar(value=">")
            thg_op = ttk.Combobox(filter_row1, textvariable=thg_op_var, values=["<", ">", "=", "<=", ">="], width=3)
            thg_op.pack(side='left', padx=2)
            thg_val_var = tk.StringVar(value="0")
            thg_entry = ttk.Entry(filter_row1, textvariable=thg_val_var, width=8)
            thg_entry.pack(side='left', padx=2)
            
            ttk.Label(filter_row1, text="  |  ").pack(side='left')
            
            # SHORT_FINAL filtresi
            ttk.Label(filter_row1, text="SHORT_FINAL:").pack(side='left', padx=2)
            short_op_var = tk.StringVar(value=">")
            short_op = ttk.Combobox(filter_row1, textvariable=short_op_var, values=["<", ">", "=", "<=", ">="], width=3)
            short_op.pack(side='left', padx=2)
            short_val_var = tk.StringVar(value="0")
            short_entry = ttk.Entry(filter_row1, textvariable=short_val_var, width=8)
            short_entry.pack(side='left', padx=2)
            
            # Filtre satÄ±r 2 - Grup seÃ§imi
            filter_row2 = ttk.Frame(filter_frame)
            filter_row2.pack(fill='x', padx=5, pady=3)
            
            ttk.Label(filter_row2, text="Gruplar:").pack(side='left', padx=2)
            
            # Grup checkboxlarÄ±
            group_vars = {}
            all_groups = ['FF', 'NFF', 'DEZNFF', 'KUPONLU', 'OTELREM', 'HIGHMATUR', 'C400', 'C425', 'C450', 'C475', 'C500', 'C525', 'C550', 'C575', 'C600']
            
            for grp in all_groups:
                var = tk.BooleanVar(value=True)
                group_vars[grp] = var
                cb = ttk.Checkbutton(filter_row2, text=grp, variable=var)
                cb.pack(side='left', padx=3)
            
            # TÃ¼mÃ¼nÃ¼ seÃ§ / kaldÄ±r butonlarÄ±
            def select_all_groups():
                for var in group_vars.values():
                    var.set(True)
            
            def deselect_all_groups():
                for var in group_vars.values():
                    var.set(False)
            
            ttk.Button(filter_row2, text="TÃ¼mÃ¼nÃ¼ SeÃ§", command=select_all_groups).pack(side='left', padx=5)
            ttk.Button(filter_row2, text="TÃ¼mÃ¼nÃ¼ KaldÄ±r", command=deselect_all_groups).pack(side='left', padx=2)
            
            # Filtre satÄ±r 3 - Metrik seÃ§imi ve kontroller
            filter_row3 = ttk.Frame(filter_frame)
            filter_row3.pack(fill='x', padx=5, pady=3)
            
            ttk.Label(filter_row3, text="Metrik:").pack(side='left', padx=2)
            metric_var = tk.StringVar(value="TÃ¼mÃ¼")
            metric_combo = ttk.Combobox(filter_row3, textvariable=metric_var, width=25, values=[
                "TÃ¼mÃ¼",
                "Prev_Close vs Last",
                "Bid Buy Pahalilik",
                "Ask Sell Pahalilik",
                "Bid Sell Pahalilik",
                "Ask Buy Pahalilik",
                "Front Buy Pahalilik",
                "Front Sell Pahalilik"
            ])
            metric_combo.pack(side='left', padx=5)
            
            ttk.Label(filter_row3, text="Top/Bottom:").pack(side='left', padx=5)
            topbottom_var = tk.StringVar(value="TÃ¼mÃ¼")
            topbottom_combo = ttk.Combobox(filter_row3, textvariable=topbottom_var, width=12, values=["TÃ¼mÃ¼", "Top 3", "Bottom 3"])
            topbottom_combo.pack(side='left', padx=2)
            
            # Progress label
            progress_label = ttk.Label(filter_row3, text="")
            progress_label.pack(side='left', padx=20)
            
            # Butonlar
            btn_analyze = ttk.Button(filter_row3, text="ğŸ” Analiz Et", command=lambda: run_analysis())
            btn_analyze.pack(side='right', padx=5)
            
            btn_filter = ttk.Button(filter_row3, text="ğŸ”§ Filtre Uygula", command=lambda: apply_filters())
            btn_filter.pack(side='right', padx=5)
            
            # =============== SONUÃ‡ TABLOSU ===============
            result_frame = ttk.LabelFrame(tg_win, text="ğŸ“Š SonuÃ§lar")
            result_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Tablo kolonlarÄ±
            columns = ('Symbol', 'Grup', 'Metrik', 'Rank', 'DeÄŸer', 'Prev_Close', 'Last', 'Bid', 'Ask', 
                      'Spread', 'FINAL_THG', 'SHORT_FINAL', 'CGRUP')
            result_tree = ttk.Treeview(result_frame, columns=columns, show='headings', height=25)
            
            col_widths = {
                'Symbol': 90, 'Grup': 80, 'Metrik': 140, 'Rank': 70, 'DeÄŸer': 80,
                'Prev_Close': 80, 'Last': 70, 'Bid': 70, 'Ask': 70,
                'Spread': 60, 'FINAL_THG': 80, 'SHORT_FINAL': 85, 'CGRUP': 60
            }
            
            for col in columns:
                result_tree.heading(col, text=col)
                result_tree.column(col, width=col_widths.get(col, 70), anchor='center')
            
            # Scrollbar
            scrollbar_y = ttk.Scrollbar(result_frame, orient='vertical', command=result_tree.yview)
            scrollbar_x = ttk.Scrollbar(result_frame, orient='horizontal', command=result_tree.xview)
            result_tree.configure(yscrollcommand=scrollbar_y.set, xscrollcommand=scrollbar_x.set)
            
            result_tree.pack(side='left', fill='both', expand=True)
            scrollbar_y.pack(side='right', fill='y')
            
            # Tag renkleri
            result_tree.tag_configure('top', background='#90EE90')  # YeÅŸil - Top
            result_tree.tag_configure('bottom', background='#FFB6C1')  # KÄ±rmÄ±zÄ± - Bottom
            
            # Veri saklama
            all_results = []
            
            def get_group_for_symbol(symbol, cgrup, file_source):
                """Sembol iÃ§in grup belirle"""
                # Dosya kaynaÄŸÄ±na gÃ¶re ana grup
                if 'heldff' in file_source.lower():
                    return 'FF'
                elif 'heldnff' in file_source.lower():
                    return 'NFF'
                elif 'helddeznff' in file_source.lower():
                    return 'DEZNFF'
                elif 'heldotelrem' in file_source.lower():
                    return 'OTELREM'
                elif 'highmatur' in file_source.lower():
                    return 'HIGHMATUR'
                elif 'heldkuponlu' in file_source.lower():
                    # Kuponlu iÃ§in CGRUP'a gÃ¶re grupla
                    if pd.notna(cgrup):
                        cgrup_str = str(cgrup).upper().strip()
                        # SayÄ±sal deÄŸeri Ã§Ä±kar
                        cgrup_num = ''.join(filter(str.isdigit, cgrup_str))
                        if cgrup_num:
                            if cgrup_num == '400':
                                return 'C400'
                            elif cgrup_num == '425':
                                return 'C425'
                            elif cgrup_num == '450':
                                return 'C450'
                            elif cgrup_num == '475':
                                return 'C475'
                            elif cgrup_num == '500':
                                return 'C500'
                            elif cgrup_num == '525':
                                return 'C525'
                            elif cgrup_num == '550':
                                return 'C550'
                            elif cgrup_num == '575':
                                return 'C575'
                            elif cgrup_num == '600':
                                return 'C600'
                    return 'KUPONLU'
                return 'OTHER'
            
            def run_analysis():
                """TÃ¼m mini450 iÃ§in analiz Ã§alÄ±ÅŸtÄ±r"""
                nonlocal all_results
                all_results = []
                
                try:
                    progress_label.config(text="Analiz baÅŸlÄ±yor...")
                    tg_win.update()
                    
                    # TÃ¼m janek dosyalarÄ±nÄ± oku
                    janall_dir = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))
                    janek_files = [
                        ('janek_ssfinekheldff.csv', 'heldff'),
                        ('janek_ssfinekheldnff.csv', 'heldnff'),
                        ('janek_ssfinekhelddeznff.csv', 'helddeznff'),
                        ('janek_ssfinekheldkuponlu.csv', 'heldkuponlu'),
                        ('janek_ssfinekheldotelrem.csv', 'heldotelrem'),
                        ('janek_ssfinekhighmatur.csv', 'highmatur')
                    ]
                    
                    all_stocks = []
                    
                    for filename, source in janek_files:
                        filepath = os.path.join(janall_dir, filename)
                        if os.path.exists(filepath):
                            try:
                                df = pd.read_csv(filepath)
                                df['_source'] = source
                                all_stocks.append(df)
                                print(f"[TGFilterer] âœ… {filename}: {len(df)} hisse")
                            except Exception as e:
                                print(f"[TGFilterer] âš ï¸ {filename} okuma hatasÄ±: {e}")
                    
                    if not all_stocks:
                        messagebox.showwarning("UyarÄ±", "HiÃ§bir veri dosyasÄ± bulunamadÄ±!")
                        return
                    
                    # TÃ¼m verileri birleÅŸtir
                    combined_df = pd.concat(all_stocks, ignore_index=True)
                    total_stocks = len(combined_df)
                    
                    print(f"[TGFilterer] ğŸ“Š Toplam {total_stocks} hisse analiz edilecek")
                    
                    # Her hisse iÃ§in canlÄ± veri Ã§ek ve skorlarÄ± hesapla
                    stock_data = []
                    
                    for idx, row in combined_df.iterrows():
                        symbol = row.get('PREF IBKR', '')
                        if not symbol:
                            continue
                        
                        if idx % 50 == 0:
                            progress_label.config(text=f"Analiz: {idx+1}/{total_stocks}")
                            tg_win.update()
                        
                        try:
                            # CSV'den veriler
                            prev_close = float(row.get('prev_close', 0) or 0)
                            final_thg = float(row.get('FINAL_THG', 0) or 0)
                            short_final = float(row.get('SHORT_FINAL', 0) or 0)
                            cgrup = row.get('CGRUP', '')
                            source = row.get('_source', '')
                            
                            # CanlÄ± veri Ã§ek
                            market_data = self.hammer.get_market_data(symbol)
                            
                            if market_data and prev_close > 0:
                                last = float(market_data.get('last', 0) or 0)
                                bid = float(market_data.get('bid', 0) or 0)
                                ask = float(market_data.get('ask', 0) or 0)
                                
                                if last > 0 and bid > 0 and ask > 0:
                                    spread = ask - bid
                                    front = (bid + ask) / 2
                                    
                                    # Grup belirle
                                    group = get_group_for_symbol(symbol, cgrup, source)
                                    
                                    # SkorlarÄ± hesapla
                                    prev_last_diff = last - prev_close  # Prev vs Last farkÄ±
                                    bid_buy_score = bid - prev_close    # Bid Buy Pahalilik
                                    ask_sell_score = ask - prev_close   # Ask Sell Pahalilik
                                    bid_sell_score = bid - prev_close   # Bid Sell Pahalilik
                                    ask_buy_score = ask - prev_close    # Ask Buy Pahalilik
                                    front_buy_score = front - prev_close  # Front Buy Pahalilik
                                    front_sell_score = front - prev_close  # Front Sell Pahalilik
                                    
                                    stock_data.append({
                                        'symbol': symbol,
                                        'group': group,
                                        'cgrup': cgrup,
                                        'prev_close': prev_close,
                                        'last': last,
                                        'bid': bid,
                                        'ask': ask,
                                        'spread': spread,
                                        'final_thg': final_thg,
                                        'short_final': short_final,
                                        'prev_last_diff': prev_last_diff,
                                        'bid_buy_score': bid_buy_score,
                                        'ask_sell_score': ask_sell_score,
                                        'bid_sell_score': bid_sell_score,
                                        'ask_buy_score': ask_buy_score,
                                        'front_buy_score': front_buy_score,
                                        'front_sell_score': front_sell_score
                                    })
                        except Exception as e:
                            pass  # Sessizce geÃ§
                    
                    print(f"[TGFilterer] ğŸ“Š {len(stock_data)} hisse iÃ§in veri toplandÄ±")
                    
                    # Gruplara ayÄ±r ve Top/Bottom 3 bul
                    metrics = [
                        ('prev_last_diff', 'Prev_Close vs Last'),
                        ('bid_buy_score', 'Bid Buy Pahalilik'),
                        ('ask_sell_score', 'Ask Sell Pahalilik'),
                        ('bid_sell_score', 'Bid Sell Pahalilik'),
                        ('ask_buy_score', 'Ask Buy Pahalilik'),
                        ('front_buy_score', 'Front Buy Pahalilik'),
                        ('front_sell_score', 'Front Sell Pahalilik')
                    ]
                    
                    groups_found = set(s['group'] for s in stock_data)
                    
                    for group in groups_found:
                        group_stocks = [s for s in stock_data if s['group'] == group]
                        
                        if len(group_stocks) < 2:
                            continue
                        
                        for metric_key, metric_name in metrics:
                            # SÄ±rala
                            sorted_stocks = sorted(group_stocks, key=lambda x: x[metric_key], reverse=True)
                            
                            # Top 3
                            for i, stock in enumerate(sorted_stocks[:3]):
                                all_results.append({
                                    'symbol': stock['symbol'],
                                    'group': group,
                                    'metric': metric_name,
                                    'rank': f"Top {i+1}",
                                    'rank_type': 'top',
                                    'value': stock[metric_key],
                                    'prev_close': stock['prev_close'],
                                    'last': stock['last'],
                                    'bid': stock['bid'],
                                    'ask': stock['ask'],
                                    'spread': stock['spread'],
                                    'final_thg': stock['final_thg'],
                                    'short_final': stock['short_final'],
                                    'cgrup': stock['cgrup']
                                })
                            
                            # Bottom 3
                            for i, stock in enumerate(sorted_stocks[-3:]):
                                all_results.append({
                                    'symbol': stock['symbol'],
                                    'group': group,
                                    'metric': metric_name,
                                    'rank': f"Bottom {3-i}",
                                    'rank_type': 'bottom',
                                    'value': stock[metric_key],
                                    'prev_close': stock['prev_close'],
                                    'last': stock['last'],
                                    'bid': stock['bid'],
                                    'ask': stock['ask'],
                                    'spread': stock['spread'],
                                    'final_thg': stock['final_thg'],
                                    'short_final': stock['short_final'],
                                    'cgrup': stock['cgrup']
                                })
                    
                    progress_label.config(text=f"âœ… Analiz tamamlandÄ±: {len(all_results)} sonuÃ§")
                    
                    # Filtreleri uygula
                    apply_filters()
                    
                except Exception as e:
                    print(f"[TGFilterer] âŒ Analiz hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    progress_label.config(text=f"âŒ Hata: {e}")
            
            def apply_filters():
                """Filtreleri uygula ve tabloyu gÃ¼ncelle"""
                nonlocal all_results
                
                # Tabloyu temizle
                for item in result_tree.get_children():
                    result_tree.delete(item)
                
                if not all_results:
                    return
                
                try:
                    # Filtre deÄŸerlerini al
                    spread_operator = spread_op_var.get()
                    spread_value = float(spread_val_var.get()) if spread_val_var.get() else None
                    
                    thg_operator = thg_op_var.get()
                    thg_value = float(thg_val_var.get()) if thg_val_var.get() else None
                    
                    short_operator = short_op_var.get()
                    short_value = float(short_val_var.get()) if short_val_var.get() else None
                    
                    selected_groups = [grp for grp, var in group_vars.items() if var.get()]
                    selected_metric = metric_var.get()
                    selected_topbottom = topbottom_var.get()
                    
                    filtered = []
                    
                    for result in all_results:
                        # Grup filtresi
                        if result['group'] not in selected_groups:
                            continue
                        
                        # Metrik filtresi
                        if selected_metric != "TÃ¼mÃ¼" and result['metric'] != selected_metric:
                            continue
                        
                        # Top/Bottom filtresi
                        if selected_topbottom == "Top 3" and result['rank_type'] != 'top':
                            continue
                        if selected_topbottom == "Bottom 3" and result['rank_type'] != 'bottom':
                            continue
                        
                        # Spread filtresi
                        if spread_value is not None:
                            if not compare_value(result['spread'], spread_operator, spread_value):
                                continue
                        
                        # FINAL_THG filtresi
                        if thg_value is not None:
                            if not compare_value(result['final_thg'], thg_operator, thg_value):
                                continue
                        
                        # SHORT_FINAL filtresi
                        if short_value is not None:
                            if not compare_value(result['short_final'], short_operator, short_value):
                                continue
                        
                        filtered.append(result)
                    
                    # Tabloya ekle
                    for result in filtered:
                        tag = result['rank_type']
                        values = (
                            result['symbol'],
                            result['group'],
                            result['metric'],
                            result['rank'],
                            f"{result['value']:.4f}",
                            f"${result['prev_close']:.2f}",
                            f"${result['last']:.2f}",
                            f"${result['bid']:.2f}",
                            f"${result['ask']:.2f}",
                            f"${result['spread']:.2f}",
                            f"{result['final_thg']:.2f}",
                            f"{result['short_final']:.2f}",
                            result['cgrup']
                        )
                        result_tree.insert('', 'end', values=values, tags=(tag,))
                    
                    progress_label.config(text=f"GÃ¶sterilen: {len(filtered)} / {len(all_results)} sonuÃ§")
                    
                except Exception as e:
                    print(f"[TGFilterer] âŒ Filtre hatasÄ±: {e}")
            
            def compare_value(val, operator, threshold):
                """DeÄŸer karÅŸÄ±laÅŸtÄ±rmasÄ±"""
                if operator == "<":
                    return val < threshold
                elif operator == ">":
                    return val > threshold
                elif operator == "=":
                    return abs(val - threshold) < 0.001
                elif operator == "<=":
                    return val <= threshold
                elif operator == ">=":
                    return val >= threshold
                return True
            
            print(f"[TGFilterer] âœ… Pencere aÃ§Ä±ldÄ±")
            
        except Exception as e:
            print(f"[TGFilterer] âŒ Hata: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"TGFilterer hatasÄ±: {e}")
    
    def show_pressure_analysis(self):
        """Pressure Analiz penceresi - SeÃ§ili gruptaki hisseler iÃ§in alÄ±ÅŸ/satÄ±ÅŸ baskÄ±sÄ± analizi"""
        try:
            from .pressure_analyzer import PressureAnalyzer
            from .spreadkusu_panel import SpreadkusuPanel
            import tkinter as tk
            from tkinter import ttk, messagebox
            
            print(f"[PRESSURE] ğŸ” AlÄ±ÅŸ/SatÄ±ÅŸ BaskÄ±sÄ± analizi baÅŸlatÄ±lÄ±yor...")
            
            # Mevcut grup verisi var mÄ± kontrol et
            if self.pressure_current_data is None or self.pressure_current_data.empty:
                messagebox.showwarning("UyarÄ±", "Ã–nce bir grup seÃ§in (heldkuponlu, heldff vb.)")
                return
            
            # Hammer Pro baÄŸlÄ± mÄ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("UyarÄ±", "Hammer Pro baÄŸlantÄ±sÄ± gerekli!")
                return
            
            group_name = self.pressure_current_group
            df = self.pressure_current_data
            
            # Pressure Analyzer oluÅŸtur
            analyzer = PressureAnalyzer(self.hammer, self)
            
            # GRPAN iÃ§in SpreadkusuPanel kullan
            spreadkusu_panel = SpreadkusuPanel(self)
            
            # Pressure Analiz sonuÃ§larÄ± penceresi
            pressure_win = tk.Toplevel(self)
            pressure_win.title(f"Pressure Analiz - AlÄ±ÅŸ/SatÄ±ÅŸ BaskÄ±sÄ± [{group_name}]")
            pressure_win.geometry("1400x700")
            
            # BaÅŸlÄ±k
            title_label = ttk.Label(pressure_win, 
                text=f"Pressure Analiz - AlÄ±ÅŸ/SatÄ±ÅŸ BaskÄ±sÄ± SkorlarÄ± [{group_name}]", 
                font=("Arial", 12, "bold"))
            title_label.pack(pady=5)
            
            # AÃ§Ä±klama
            info_label = ttk.Label(pressure_win, 
                text="Buy Pressure: AlÄ±ÅŸ baskÄ±sÄ± skoru | Sell Pressure: SatÄ±ÅŸ baskÄ±sÄ± skoru | Net Pressure: Buy - Sell",
                font=("Arial", 9, 'italic'))
            info_label.pack(pady=3)
            
            # Progress label
            progress_label = ttk.Label(pressure_win, text="Analiz baÅŸlÄ±yor...")
            progress_label.pack(pady=5)
            
            # Tree frame
            tree_frame = ttk.Frame(pressure_win)
            tree_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Pressure sonuÃ§larÄ± tablosu
            columns = ('Symbol', 'Buy Pressure', 'Sell Pressure', 'Net Pressure', 'Class', 'GRPAN', 'Bid', 'Ask', 'Spread', 'Last Print')
            pressure_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=25)
            
            col_widths = {
                'Symbol': 120, 'Buy Pressure': 100, 'Sell Pressure': 100, 'Net Pressure': 100,
                'Class': 150, 'GRPAN': 80, 'Bid': 80, 'Ask': 80, 'Spread': 70, 'Last Print': 80
            }
            
            headers = {
                'Symbol': 'Symbol', 
                'Buy Pressure': 'Buy Pressure', 
                'Sell Pressure': 'Sell Pressure',
                'Net Pressure': 'Net Pressure',
                'Class': 'SÄ±nÄ±flandÄ±rma',
                'GRPAN': 'GRPAN',
                'Bid': 'Bid',
                'Ask': 'Ask',
                'Spread': 'Spread',
                'Last Print': 'Last Print'
            }
            
            for col in columns:
                pressure_tree.heading(col, text=headers[col])
                pressure_tree.column(col, width=col_widths.get(col, 80), anchor='center')
            
            scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=pressure_tree.yview)
            pressure_tree.configure(yscrollcommand=scrollbar.set)
            pressure_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # SonuÃ§larÄ± hesapla
            pressure_results = []
            symbols = df['PREF IBKR'].tolist() if 'PREF IBKR' in df.columns else []
            
            total = len(symbols)
            print(f"[PRESSURE] ğŸ“Š {total} hisse analiz edilecek...")
            
            for i, symbol in enumerate(symbols):
                progress_label.config(text=f"Analiz ediliyor: {symbol} ({i+1}/{total})")
                pressure_win.update()
                
                try:
                    # GRPAN fiyatÄ±nÄ± al
                    grpan_data = spreadkusu_panel.get_grpan_price(symbol)
                    grpan_price = grpan_data.get('price') if grpan_data else None
                    
                    # Pressure analizi yap
                    result = analyzer.calculate_pressure_scores(symbol, grpan_price=grpan_price)
                    
                    if result:
                        # Snapshot verilerini al
                        snapshot = result.get('snapshot', {})
                        bid = snapshot.get('bid', 0)
                        ask = snapshot.get('ask', 0)
                        last = snapshot.get('last', 0)
                        spread = snapshot.get('spread', 0)
                        
                        pressure_results.append({
                            'symbol': symbol,
                            'buy_pressure': result.get('buy_pressure_score', 0),
                            'sell_pressure': result.get('sell_pressure_score', 0),
                            'net_pressure': result.get('net_pressure', 0),
                            'pressure_class': result.get('pressure_class', 'N/A'),
                            'grpan': grpan_price if grpan_price else 'N/A',
                            'bid': bid,
                            'ask': ask,
                            'spread': spread,
                            'last': last
                        })
                    else:
                        pressure_results.append({
                            'symbol': symbol,
                            'buy_pressure': 0,
                            'sell_pressure': 0,
                            'net_pressure': 0,
                            'pressure_class': 'Veri Yok',
                            'grpan': 'N/A',
                            'bid': 0,
                            'ask': 0,
                            'spread': 0,
                            'last': 0
                        })
                        
                except Exception as e:
                    print(f"[PRESSURE] âŒ {symbol} analiz hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    pressure_results.append({
                        'symbol': symbol,
                        'buy_pressure': 0,
                        'sell_pressure': 0,
                        'net_pressure': 0,
                        'pressure_class': 'Hata',
                        'grpan': 'N/A',
                        'bid': 0,
                        'ask': 0,
                        'spread': 0,
                        'last': 0
                    })
            
            # SonuÃ§larÄ± Net Pressure'a gÃ¶re sÄ±rala
            pressure_results.sort(key=lambda x: x['net_pressure'], reverse=True)
            
            # Tabloya ekle
            for result in pressure_results:
                # Net Pressure'a gÃ¶re renk belirle
                net_pressure = result['net_pressure']
                if net_pressure > 0.6:
                    tag = 'strong_buy'
                elif net_pressure > 0.3:
                    tag = 'moderate_buy'
                elif net_pressure > -0.3:
                    tag = 'balanced'
                elif net_pressure > -0.6:
                    tag = 'moderate_sell'
                else:
                    tag = 'strong_sell'
                
                values = (
                    result['symbol'],
                    f"{result['buy_pressure']:.3f}",
                    f"{result['sell_pressure']:.3f}",
                    f"{result['net_pressure']:.3f}",
                    result['pressure_class'],
                    f"${result['grpan']:.2f}" if isinstance(result['grpan'], (int, float)) else result['grpan'],
                    f"${result['bid']:.2f}" if result.get('bid') is not None and result['bid'] > 0 else 'N/A',
                    f"${result['ask']:.2f}" if result.get('ask') is not None and result['ask'] > 0 else 'N/A',
                    f"${result['spread']:.2f}" if result.get('spread') is not None and result['spread'] > 0 else 'N/A',
                    f"${result['last']:.2f}" if result.get('last') is not None and result['last'] > 0 else 'N/A'
                )
                
                item = pressure_tree.insert('', 'end', values=values, tags=(tag,))
            
            # Renkleri ayarla
            pressure_tree.tag_configure('strong_buy', background='#90EE90')  # AÃ§Ä±k yeÅŸil
            pressure_tree.tag_configure('moderate_buy', background='#E6FFE6')  # Ã‡ok aÃ§Ä±k yeÅŸil
            pressure_tree.tag_configure('balanced', background='white')
            pressure_tree.tag_configure('moderate_sell', background='#FFE6E6')  # Ã‡ok aÃ§Ä±k kÄ±rmÄ±zÄ±
            pressure_tree.tag_configure('strong_sell', background='#FFB6C1')  # AÃ§Ä±k kÄ±rmÄ±zÄ±
            
            progress_label.config(text=f"âœ… Analiz tamamlandÄ±: {len(pressure_results)} hisse")
            
            print(f"[PRESSURE] âœ… Analiz tamamlandÄ±: {len(pressure_results)} hisse")
            
        except Exception as e:
            print(f"[PRESSURE] âŒ Pressure analiz hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Pressure analiz hatasÄ±: {e}")
    
    def show_bggg_analysis(self):
        """BGGG Analiz penceresi - BugÃ¼nÃ¼n GRPAN Grup Analizi"""
        try:
            from .bggg_analyzer import BGGGAnalyzer
            import tkinter as tk
            from tkinter import ttk, messagebox
            
            print(f"[BGGG] ğŸ” BGGG analizi baÅŸlatÄ±lÄ±yor...")
            
            # Hammer Pro baÄŸlÄ± mÄ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("UyarÄ±", "Hammer Pro baÄŸlantÄ±sÄ± gerekli!")
                return
            
            # Mini450 sekmesi aÃ§Ä±k mÄ± kontrol et
            is_mini450_mode = False
            if hasattr(self, 'df') and self.df is not None and not self.df.empty:
                # Mini450 sekmesi aÃ§Ä±k
                is_mini450_mode = True
                group_name = "mini450"
                df = self.df.copy()
                print(f"[BGGG] ğŸ“Š Mini450 modu aktif: {len(df)} hisse")
            elif self.pressure_current_data is not None and not self.pressure_current_data.empty:
                # Normal grup modu
                group_name = self.pressure_current_group
                df = self.pressure_current_data.copy()
                print(f"[BGGG] ğŸ“Š Normal grup modu: {group_name}, {len(df)} hisse")
            else:
                messagebox.showwarning("UyarÄ±", "Ã–nce bir grup seÃ§in (heldkuponlu, heldff vb.) veya mini450 sekmesini aÃ§Ä±n")
                return
            
            # BGGG Analyzer oluÅŸtur
            analyzer = BGGGAnalyzer(self.hammer, self)
            
            # BGGG Analiz sonuÃ§larÄ± penceresi
            bggg_win = tk.Toplevel(self)
            bggg_win.title(f"BGGG Analiz - BugÃ¼nÃ¼n GRPAN Grup Analizi [{group_name}]")
            bggg_win.geometry("1400x700")
            
            # BaÅŸlÄ±k
            title_label = ttk.Label(bggg_win, 
                text=f"BGGG Analiz - BugÃ¼nÃ¼n GRPAN Grup Analizi [{group_name}]", 
                font=("Arial", 12, "bold"))
            title_label.pack(pady=5)
            
            # AÃ§Ä±klama
            info_label = ttk.Label(bggg_win, 
                text="BGRPAN: BugÃ¼nÃ¼n printlerinden hesaplanan GRPAN | BGRPAN SapmasÄ±: BGRPAN - Previous Close | BGGG AYRISMA: BGRPAN SapmasÄ± - GRUP ORT BGRPAN SapmasÄ±",
                font=("Arial", 9, 'italic'))
            info_label.pack(pady=3)
            
            # Progress label
            progress_label = ttk.Label(bggg_win, text="Analiz baÅŸlÄ±yor...")
            progress_label.pack(pady=5)
            
            # Tree frame
            tree_frame = ttk.Frame(bggg_win)
            tree_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # BGGG sonuÃ§larÄ± tablosu
            columns = ('Symbol', 'Dos Grup', 'Last Print', 'BGRPAN', 'BGRPAN SapmasÄ±', 'BGRPAN - Bid', 'BGRPAN - Ask', 
                      'GRUP ORT BGRPAN SapmasÄ±', 'BGGG AYRISMA')
            bggg_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=25)
            
            col_widths = {
                'Symbol': 120, 'Dos Grup': 150, 'Last Print': 100, 'BGRPAN': 100, 'BGRPAN SapmasÄ±': 120,
                'BGRPAN - Bid': 110, 'BGRPAN - Ask': 110, 'GRUP ORT BGRPAN SapmasÄ±': 180, 'BGGG AYRISMA': 130
            }
            
            headers = {
                'Symbol': 'Symbol',
                'Dos Grup': 'Dos Grup',
                'Last Print': 'Last Print',
                'BGRPAN': 'BGRPAN',
                'BGRPAN SapmasÄ±': 'BGRPAN SapmasÄ±',
                'BGRPAN - Bid': 'BGRPAN - Bid',
                'BGRPAN - Ask': 'BGRPAN - Ask',
                'GRUP ORT BGRPAN SapmasÄ±': 'GRUP ORT BGRPAN SapmasÄ±',
                'BGGG AYRISMA': 'BGGG AYRISMA'
            }
            
            for col in columns:
                bggg_tree.heading(col, text=headers[col])
                bggg_tree.column(col, width=col_widths.get(col, 100), anchor='center')
            
            scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=bggg_tree.yview)
            bggg_tree.configure(yscrollcommand=scrollbar.set)
            
            bggg_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # Analiz yap
            symbols = df['PREF IBKR'].tolist() if 'PREF IBKR' in df.columns else []
            
            if not symbols:
                messagebox.showwarning("UyarÄ±", "DataFrame'de 'PREF IBKR' kolonu bulunamadÄ±!")
                bggg_win.destroy()
                return
            
            progress_label.config(text=f"Analiz yapÄ±lÄ±yor: 0/{len(symbols)} hisse...")
            bggg_win.update()
            
            # BGGG analizi
            bggg_results = analyzer.analyze_bggg(symbols, group_name, is_mini450=is_mini450_mode)
            
            if not bggg_results:
                messagebox.showwarning("UyarÄ±", "BGGG analizi sonuÃ§ vermedi!")
                bggg_win.destroy()
                return
            
            # BGGG AYRISMA'ya gÃ¶re sÄ±rala
            bggg_results.sort(key=lambda x: x.get('bggg_ayrisma') if x.get('bggg_ayrisma') is not None else -999, reverse=True)
            
            # Tabloya ekle
            for result in bggg_results:
                # BGGG AYRISMA'ya gÃ¶re renk belirle
                bggg_ayrisma = result.get('bggg_ayrisma')
                if bggg_ayrisma is not None:
                    if bggg_ayrisma > 0.1:
                        tag = 'strong_overperform'  # GÃ¼Ã§lÃ¼ overperform
                    elif bggg_ayrisma > 0.05:
                        tag = 'moderate_overperform'  # Orta overperform
                    elif bggg_ayrisma > -0.05:
                        tag = 'balanced'  # Dengeli
                    elif bggg_ayrisma > -0.1:
                        tag = 'moderate_underperform'  # Orta underperform
                    else:
                        tag = 'strong_underperform'  # GÃ¼Ã§lÃ¼ underperform
                else:
                    tag = 'no_data'
                
                values = (
                    result['symbol'],
                    result.get('dos_grup', 'N/A'),
                    f"${result['last_print']:.2f}" if result.get('last_print') is not None else 'N/A',
                    f"${result['bgrpan']:.2f}" if result.get('bgrpan') is not None else 'N/A',
                    f"${result['bgrpan_sapma']:.4f}" if result.get('bgrpan_sapma') is not None else 'N/A',
                    f"${result['bgrpan_bid_diff']:.4f}" if result.get('bgrpan_bid_diff') is not None else 'N/A',
                    f"${result['bgrpan_ask_diff']:.4f}" if result.get('bgrpan_ask_diff') is not None else 'N/A',
                    f"${result['grup_ort_bgrpan_sapma']:.4f}" if result.get('grup_ort_bgrpan_sapma') is not None else 'N/A',
                    f"${result['bggg_ayrisma']:.4f}" if result.get('bggg_ayrisma') is not None else 'N/A'
                )
                
                item = bggg_tree.insert('', 'end', values=values, tags=(tag,))
            
            # Renkleri ayarla
            bggg_tree.tag_configure('strong_overperform', background='#90EE90')  # AÃ§Ä±k yeÅŸil
            bggg_tree.tag_configure('moderate_overperform', background='#E6FFE6')  # Ã‡ok aÃ§Ä±k yeÅŸil
            bggg_tree.tag_configure('balanced', background='white')
            bggg_tree.tag_configure('moderate_underperform', background='#FFE6E6')  # Ã‡ok aÃ§Ä±k kÄ±rmÄ±zÄ±
            bggg_tree.tag_configure('strong_underperform', background='#FFB6C1')  # AÃ§Ä±k kÄ±rmÄ±zÄ±
            bggg_tree.tag_configure('no_data', background='#F0F0F0')  # Gri
            
            progress_label.config(text=f"âœ… Analiz tamamlandÄ±: {len(bggg_results)} hisse")
            
            # Mini450 modunda ise sonuÃ§larÄ± DataFrame'e ekle
            if is_mini450_mode and hasattr(self, 'df') and self.df is not None:
                try:
                    print(f"[BGGG] ğŸ“Š Mini450 DataFrame'ine BGGG sonuÃ§larÄ± ekleniyor...")
                    
                    # BGGG sonuÃ§larÄ±nÄ± dictionary'ye Ã§evir (symbol -> result)
                    bggg_dict = {}
                    for result in bggg_results:
                        symbol = result.get('symbol')
                        if symbol:
                            bggg_dict[symbol] = result
                    
                    # DataFrame'e BGGG AYRISMA kolonunu ekle
                    if 'PREF IBKR' in self.df.columns:
                        self.df['BGGG AYRISMA'] = self.df['PREF IBKR'].apply(
                            lambda x: bggg_dict.get(x, {}).get('bggg_ayrisma') if x in bggg_dict else None
                        )
                        print(f"[BGGG] âœ… BGGG AYRISMA kolonu mini450 DataFrame'ine eklendi")
                    else:
                        print(f"[BGGG] âš ï¸ 'PREF IBKR' kolonu bulunamadÄ±, BGGG sonuÃ§larÄ± eklenemedi")
                        
                except Exception as e:
                    print(f"[BGGG] âš ï¸ Mini450 DataFrame'ine ekleme hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
            
        except Exception as e:
            print(f"[BGGG] âŒ BGGG analiz hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"BGGG analiz hatasÄ±: {e}")
    
    # ============ REVORDER MOD FONKSÄ°YONLARI ============
    
    def check_and_open_revorders(self):
        """RevOrderMod: BugÃ¼nkÃ¼ pozisyon artÄ±rÄ±mlarÄ±nÄ± kontrol et ve RevOrder aÃ§"""
        try:
            if not (hasattr(self, 'revorder_mod_var') and self.revorder_mod_var.get()):
                print("[REVORDER] â¸ï¸ RevOrderMod pasif")
                return
            
            print("[REVORDER] ğŸ” BugÃ¼nkÃ¼ pozisyon artÄ±rÄ±mlarÄ± kontrol ediliyor...")
            self.log_message("ğŸ” RevOrderMod: BugÃ¼nkÃ¼ pozisyon artÄ±rÄ±mlarÄ± kontrol ediliyor...")
            
            # TÃ¼m pozisyonlarÄ± al (psfalgo_positions dictionary'sinden)
            revorder_count = 0
            for symbol, position_data in self.psfalgo_positions.items():
                current_qty = position_data.get('current_qty', 0)
                befday_qty = position_data.get('befday_qty', 0)
                todays_qty_chg = current_qty - befday_qty
                
                # Todays chg != 0 kontrolÃ¼ (pozisyon artÄ±rÄ±mÄ± var mÄ±?)
                if abs(todays_qty_chg) < 200:
                    continue  # 200 lot'tan kÃ¼Ã§Ã¼k artÄ±rÄ±mlar iÃ§in RevOrder aÃ§ma
                
                # Pozisyon artÄ±rÄ±mÄ± yÃ¶nÃ¼nÃ¼ belirle
                if befday_qty >= 0 and current_qty > befday_qty:
                    # Long artÄ±rÄ±m
                    side = 'LONG'
                    fill_qty = todays_qty_chg
                elif befday_qty <= 0 and current_qty < befday_qty:
                    # Short artÄ±rÄ±m
                    side = 'SHORT'
                    fill_qty = abs(todays_qty_chg)
                else:
                    continue  # Pozisyon artÄ±rÄ±mÄ± deÄŸil
                
                # Todays Cost'u al (ortalama fill fiyatÄ±)
                fill_price = self.get_todays_cost_for_psfalgo(symbol, current_qty, befday_qty)
                if fill_price <= 0:
                    print(f"[REVORDER] âš ï¸ {symbol} iÃ§in Todays Cost bulunamadÄ±, atlanÄ±yor")
                    continue
                
                # Mevcut RevOrder'larÄ± kontrol et
                existing_revorder_qty = self.get_existing_revorder_qty(symbol, side)
                
                # Eksik RevOrder miktarÄ±nÄ± hesapla
                needed_revorder_qty = fill_qty - existing_revorder_qty
                
                if needed_revorder_qty > 0:
                    # RevOrder lot limitlerini uygula
                    max_revorder_qty = self.calculate_max_revorder_qty(fill_qty)
                    actual_revorder_qty = min(needed_revorder_qty, max_revorder_qty)
                    
                    if actual_revorder_qty >= 200:
                        print(f"[REVORDER] âœ… {symbol} {side} artÄ±rÄ±mÄ± iÃ§in {actual_revorder_qty} lot RevOrder aÃ§Ä±lÄ±yor (Fill: {fill_qty}, Mevcut: {existing_revorder_qty}, Eksik: {needed_revorder_qty})")
                        self.log_message(f"âœ… {symbol} {side} artÄ±rÄ±mÄ± iÃ§in {actual_revorder_qty} lot RevOrder aÃ§Ä±lÄ±yor")
                        
                        # Reasoning: Neden RevOrder aÃ§Ä±lÄ±yor?
                        reasoning = f"RevOrderMod kontrolÃ¼ | {side} artÄ±rÄ±m: {fill_qty} lot | Mevcut RevOrder: {existing_revorder_qty} | Eksik: {needed_revorder_qty} | AÃ§Ä±lacak: {actual_revorder_qty} lot"
                        self.log_psfalgo_activity("REVORDER_KONTROL", f"{symbol} {side} artÄ±rÄ±m tespit edildi", "INFO", reasoning, "REVORDER")
                        
                        success = self.open_revorder(symbol, side, actual_revorder_qty, fill_price)
                        if success:
                            revorder_count += 1
                else:
                    print(f"[REVORDER] â„¹ï¸ {symbol} iÃ§in yeterli RevOrder mevcut (Fill: {fill_qty}, Mevcut: {existing_revorder_qty})")
                    reasoning = f"RevOrderMod kontrolÃ¼ | {side} artÄ±rÄ±m: {fill_qty} lot | Mevcut RevOrder: {existing_revorder_qty} | Eksik: {needed_revorder_qty} | Yeterli RevOrder mevcut, yeni aÃ§Ä±lmadÄ±"
                    self.log_psfalgo_activity("REVORDER_KONTROL", f"{symbol} yeterli RevOrder mevcut", "INFO", reasoning, "REVORDER")
            
            if revorder_count > 0:
                print(f"[REVORDER] âœ… {revorder_count} adet RevOrder aÃ§Ä±ldÄ±")
                self.log_message(f"âœ… {revorder_count} adet RevOrder aÃ§Ä±ldÄ±")
                self.log_psfalgo_activity("REVORDER_TOPLAM", f"{revorder_count} adet RevOrder aÃ§Ä±ldÄ±", "SUCCESS", f"RevOrderMod dÃ¶ngÃ¼sÃ¼ tamamlandÄ±", "REVORDER")
            else:
                print("[REVORDER] â„¹ï¸ AÃ§Ä±lacak yeni RevOrder bulunamadÄ±")
                self.log_psfalgo_activity("REVORDER_TOPLAM", "AÃ§Ä±lacak yeni RevOrder bulunamadÄ±", "INFO", "RevOrderMod dÃ¶ngÃ¼sÃ¼: Pozisyon artÄ±rÄ±mÄ± yok veya yeterli RevOrder mevcut", "REVORDER")
                
        except Exception as e:
            print(f"[REVORDER] âŒ RevOrder kontrol hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            self.log_message(f"âŒ RevOrder kontrol hatasÄ±: {e}")
    
    def get_existing_revorder_qty(self, symbol, side):
        """Mevcut RevOrder miktarÄ±nÄ± hesapla"""
        try:
            # AÃ§Ä±k emirlerden RevOrder'larÄ± bul
            orders = []
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
                if active_account in ["IBKR_GUN", "IBKR_PED"]:
                    if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                        orders = self.mode_manager.ibkr_native_client.get_open_orders()
                    elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                        orders = self.mode_manager.ibkr_client.get_orders_direct()
                else:  # HAMPRO
                    if hasattr(self, 'hammer') and self.hammer and self.hammer.connected:
                        orders = self.hammer.get_open_orders()
            
            # Symbol ve side'a gÃ¶re RevOrder'larÄ± filtrele
            total_qty = 0
            for order in orders:
                order_symbol = order.get('symbol', '') or order.get('Symbol', '')
                order_action = order.get('action', '') or order.get('Action', '')
                order_emir_tipi = order.get('emir_tipi', '')
                
                # Symbol eÅŸleÅŸtirmesi
                if order_symbol != symbol:
                    # Preferred stock formatÄ± kontrolÃ¼
                    if '-' in order_symbol:
                        base, suffix = order_symbol.split('-', 1)
                        if base != symbol.replace(' PR', '').split()[0]:
                            continue
                    elif ' PR' in symbol and order_symbol == symbol.replace(' PR', ''):
                        pass  # EÅŸleÅŸiyor
                    else:
                        continue
                
                # RevOrder kontrolÃ¼ (emir_tipi veya order tag'inden)
                if order_emir_tipi == 'RevOrder' or order.get('revorder', False):
                    # Side kontrolÃ¼
                    if side == 'LONG' and order_action == 'SELL':
                        total_qty += abs(float(order.get('quantity', 0) or order.get('qty', 0)))
                    elif side == 'SHORT' and order_action == 'BUY':
                        total_qty += abs(float(order.get('quantity', 0) or order.get('qty', 0)))
            
            return total_qty
            
        except Exception as e:
            print(f"[REVORDER] âŒ Mevcut RevOrder kontrol hatasÄ± ({symbol}): {e}")
            return 0
    
    def calculate_max_revorder_qty(self, fill_qty):
        """RevOrder lot limitlerini hesapla"""
        if fill_qty < 1000:
            return fill_qty
        elif fill_qty < 3000:
            return 1000
        elif fill_qty < 5000:
            return 1500
        else:
            return 2000
    
    def open_revorder(self, symbol, side, qty, fill_price):
        """RevOrder aÃ§ - minimum 0.06 cent kar hedefi ile"""
        try:
            print(f"[REVORDER] ğŸ”„ {symbol} {side} {qty} lot RevOrder aÃ§Ä±lÄ±yor (Fill: ${fill_price:.2f})")
            
            # Market data al
            bid = 0
            ask = 0
            l2_bids = []
            l2_asks = []
            
            if hasattr(self, 'hammer') and self.hammer and self.hammer.connected:
                # Hammer client'tan market data al
                market_data = self.hammer.get_market_data(symbol)
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                
                # L2 data al
                l2_data = self.hammer.l2_data.get(symbol, {})
                l2_bids = l2_data.get('bids', [])
                l2_asks = l2_data.get('asks', [])
            
            # Minimum kar hedefi: 0.06 cent
            min_profit = 0.06
            
            # RevOrder fiyatÄ±nÄ± hesapla
            if side == 'SHORT':  # Short artÄ±rma â†’ Hidden BUY RevOrder
                # Kar hedefi: fill_price - 0.06
                target_profit_price = fill_price - min_profit
                
                if bid > 0 and bid < target_profit_price:
                    # Ä°lk bid kar hedefinden dÃ¼ÅŸÃ¼k â†’ (bid + 0.01) hidden BUY
                    revorder_price = bid + 0.01
                    print(f"[REVORDER] âœ… {symbol} Short artÄ±rma: Ä°lk bid ({bid:.2f}) < Kar hedefi ({target_profit_price:.2f}) â†’ Hidden BUY @ {revorder_price:.2f}")
                else:
                    # Ä°lk bid kar hedefinden yÃ¼ksek veya eÅŸit â†’ L2'de uygun bid bul
                    revorder_price = self.find_revorder_buy_price_from_l2(l2_bids, target_profit_price, fill_price)
                    if revorder_price <= 0:
                        print(f"[REVORDER] âŒ {symbol} Short artÄ±rma: L2'de uygun bid bulunamadÄ±")
                        return False
                    print(f"[REVORDER] âœ… {symbol} Short artÄ±rma: L2'den bulunan bid â†’ Hidden BUY @ {revorder_price:.2f}")
                
                action = 'BUY'
                
            else:  # side == 'LONG' - Long artÄ±rma â†’ Hidden SELL RevOrder
                # Kar hedefi: fill_price + 0.06
                target_profit_price = fill_price + min_profit
                
                if ask > 0 and ask > target_profit_price:
                    # Ä°lk ask kar hedefinden yÃ¼ksek â†’ (ask - 0.01) hidden SELL
                    revorder_price = ask - 0.01
                    print(f"[REVORDER] âœ… {symbol} Long artÄ±rma: Ä°lk ask ({ask:.2f}) > Kar hedefi ({target_profit_price:.2f}) â†’ Hidden SELL @ {revorder_price:.2f}")
                else:
                    # Ä°lk ask kar hedefinden dÃ¼ÅŸÃ¼k veya eÅŸit â†’ L2'de uygun ask bul
                    revorder_price = self.find_revorder_sell_price_from_l2(l2_asks, target_profit_price, fill_price)
                    if revorder_price <= 0:
                        print(f"[REVORDER] âŒ {symbol} Long artÄ±rma: L2'de uygun ask bulunamadÄ±")
                        return False
                    print(f"[REVORDER] âœ… {symbol} Long artÄ±rma: L2'den bulunan ask â†’ Hidden SELL @ {revorder_price:.2f}")
                
                action = 'SELL'
            
            # Emri gÃ¶nder (hidden order olarak)
            success = self.place_revorder(symbol, action, qty, revorder_price)
            
            if success:
                print(f"[REVORDER] âœ… {symbol} {action} {qty} lot @ ${revorder_price:.2f} RevOrder baÅŸarÄ±yla aÃ§Ä±ldÄ±")
                self.log_message(f"âœ… {symbol} {action} {qty} lot @ ${revorder_price:.2f} RevOrder aÃ§Ä±ldÄ±")
                # Reasoning: Neden bu RevOrder aÃ§Ä±ldÄ±?
                reasoning = f"RevOrderMod | {side} artÄ±rma fill: {fill_qty} lot @ ${fill_price:.2f} | Kar hedefi: ${abs(revorder_price - fill_price):.2f} (min 0.06) | RevOrder: {qty} lot @ ${revorder_price:.2f}"
                self.log_psfalgo_activity(
                    action="REVORDER_ACILDI",
                    details=f"{symbol} {action} {qty} lot @ ${revorder_price:.2f}",
                    status="SUCCESS",
                    reason=reasoning,
                    category="REVORDER",
                    symbol=symbol,
                    step_name="RevOrderMod",
                    maxalw=None,
                    revorder_info=f"Side: {side}, Fill Qty: {fill_qty}, Fill Price: ${fill_price:.2f}, RevOrder Price: ${revorder_price:.2f}, Profit Target: ${abs(revorder_price - fill_price):.2f}"
                )
                return True
            else:
                print(f"[REVORDER] âŒ {symbol} RevOrder aÃ§Ä±lamadÄ±")
                return False
                
        except Exception as e:
            print(f"[REVORDER] âŒ {symbol} RevOrder aÃ§ma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def find_revorder_buy_price_from_l2(self, l2_bids, target_profit_price, fill_price):
        """L2 bid'lerinden uygun RevOrder BUY fiyatÄ± bul (ilk 5 bid'e bak)"""
        try:
            if not l2_bids or len(l2_bids) == 0:
                return 0
            
            # Ä°lk 5 bid'e bak
            for i, bid_entry in enumerate(l2_bids[:5]):
                bid_price = float(bid_entry.get('price', 0))
                if bid_price <= 0:
                    continue
                
                # Bu bid kar hedefini saÄŸlÄ±yor mu? (bid < target_profit_price)
                if bid_price < target_profit_price:
                    # (bid + 0.01) hidden BUY
                    return bid_price + 0.01
            
            # Uygun bid bulunamadÄ±
            return 0
            
        except Exception as e:
            print(f"[REVORDER] âŒ L2 bid fiyat bulma hatasÄ±: {e}")
            return 0
    
    def find_revorder_sell_price_from_l2(self, l2_asks, target_profit_price, fill_price):
        """L2 ask'lerinden uygun RevOrder SELL fiyatÄ± bul (ilk 5 ask'e bak)"""
        try:
            if not l2_asks or len(l2_asks) == 0:
                return 0
            
            # Ä°lk 5 ask'e bak
            for i, ask_entry in enumerate(l2_asks[:5]):
                ask_price = float(ask_entry.get('price', 0))
                if ask_price <= 0:
                    continue
                
                # Bu ask kar hedefini saÄŸlÄ±yor mu? (ask > target_profit_price)
                if ask_price > target_profit_price:
                    # (ask - 0.01) hidden SELL
                    return ask_price - 0.01
            
            # Uygun ask bulunamadÄ±
            return 0
            
        except Exception as e:
            print(f"[REVORDER] âŒ L2 ask fiyat bulma hatasÄ±: {e}")
            return 0
    
    def place_revorder(self, symbol, action, qty, price):
        """RevOrder emrini gÃ¶nder (hidden order olarak)"""
        try:
            # Aktif moda gÃ¶re emir gÃ¶nder
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
                if active_account in ["IBKR_GUN", "IBKR_PED"]:
                    # IBKR iÃ§in emir gÃ¶nder
                    if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                        # IBKR Native Client ile emir gÃ¶nder
                        # TODO: IBKR Native Client place_order implementasyonu
                        print(f"[REVORDER] âš ï¸ IBKR Native Client place_order henÃ¼z implement edilmedi")
                        return False
                    elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                        # IBKR Client ile emir gÃ¶nder
                        success = self.mode_manager.ibkr_client.place_order(
                            symbol=symbol,
                            action=action,
                            quantity=qty,
                            price=price,
                            order_type='LMT',
                            hidden=True  # Hidden order
                        )
                        
                        # Emir gÃ¶nderildikten sonra order'a revorder tag'i ekle
                        if success:
                            self.mark_order_as_revorder(symbol, action, qty, price)
                        
                        return success
                else:  # HAMPRO
                    if hasattr(self, 'hammer') and self.hammer and self.hammer.connected:
                        # Hammer client ile emir gÃ¶nder
                        success = self.hammer.place_order(
                            symbol=symbol,
                            action=action,
                            quantity=qty,
                            price=price,
                            order_type='LIMIT',
                            hidden=True  # Hidden order
                        )
                        
                        # Emir gÃ¶nderildikten sonra order'a revorder tag'i ekle
                        if success:
                            self.mark_order_as_revorder(symbol, action, qty, price)
                        
                        return success
            
            return False
            
        except Exception as e:
            print(f"[REVORDER] âŒ {symbol} emir gÃ¶nderme hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def mark_order_as_revorder(self, symbol, action, qty, price):
        """GÃ¶nderilen emri RevOrder olarak iÅŸaretle"""
        try:
            import time
            time.sleep(0.5)  # Emrin sisteme kaydedilmesi iÃ§in bekle
            
            # AÃ§Ä±k emirleri al ve eÅŸleÅŸen emri bul
            orders = []
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
                if active_account in ["IBKR_GUN", "IBKR_PED"]:
                    if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                        orders = self.mode_manager.ibkr_native_client.get_open_orders()
                    elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                        orders = self.mode_manager.ibkr_client.get_orders_direct()
                else:  # HAMPRO
                    if hasattr(self, 'hammer') and self.hammer and self.hammer.connected:
                        orders = self.hammer.get_open_orders()
            
            # EÅŸleÅŸen emri bul ve revorder tag'i ekle
            for order in orders:
                order_symbol = order.get('symbol', '') or order.get('Symbol', '')
                order_action = order.get('action', '') or order.get('Action', '')
                order_qty = float(order.get('quantity', 0) or order.get('qty', 0))
                order_price = float(order.get('limit_price', 0) or order.get('price', 0))
                
                # Symbol eÅŸleÅŸtirmesi
                symbol_match = False
                if order_symbol == symbol:
                    symbol_match = True
                elif '-' in order_symbol:
                    base, suffix = order_symbol.split('-', 1)
                    if base == symbol.replace(' PR', '').split()[0]:
                        symbol_match = True
                elif ' PR' in symbol and order_symbol == symbol.replace(' PR', ''):
                    symbol_match = True
                
                # EÅŸleÅŸme kontrolÃ¼ (symbol, action, qty, price toleransÄ±)
                if (symbol_match and 
                    order_action.upper() == action.upper() and
                    abs(order_qty - qty) < 1 and
                    abs(order_price - price) < 0.02):
                    
                    # RevOrder tag'i ekle
                    order['revorder'] = True
                    order['emir_tipi'] = 'RevOrder'
                    print(f"[REVORDER] âœ… {symbol} {action} {qty} @ ${price:.2f} emri RevOrder olarak iÅŸaretlendi")
                    break
                    
        except Exception as e:
            print(f"[REVORDER] âš ï¸ Emir iÅŸaretleme hatasÄ±: {e}")
    