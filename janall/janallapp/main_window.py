"""
Ana pencere mod√ºl√º.

!!! √ñNEMLƒ∞ DOSYA YOLU UYARISI !!!
=================================
B√úT√úN CSV OKUMA VE CSV KAYDETME ƒ∞≈ûLEMLERƒ∞ StockTracker Dƒ∞Zƒ∞Nƒ∞NE YAPILMALI!!
StockTracker/janall/ dizinine YAPILMAMALI!!!
KARI≈ûASAYI √ñNLEMEK ƒ∞√áƒ∞N BU KURALA MUTLAKA UYULACAK!

√ñrnek:
‚úÖ DOƒûRU: "janalldata.csv" (StockTracker dizininde)
‚ùå YANLI≈û: "janall/janalldata.csv"
=================================
"""

import tkinter as tk
from tkinter import ttk, messagebox, simpledialog
import pandas as pd
import numpy as np
import time
import os
import threading
from datetime import datetime, date
from .etf_panel import ETFPanel
from .order_management import OrderManager, OrderBookWindow
from .bdata_storage import BDataStorage
from .stock_data_manager import StockDataManager
from .exception_manager import ExceptionListManager
from .exception_window import ExceptionListWindow

class MainWindow(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("JanAll")
        
        # Performans optimizasyonu flag'leri
        self.is_mini450_active = False
        self.background_data_cache = {}
        self.background_update_thread = None
        self.background_update_running = False
        
        # Hammer Pro client
        from .hammer_client import HammerClient
        self.hammer = HammerClient(
            host='127.0.0.1',  # localhost
            port=16400,        # varsayƒ±lan port
            password='Nl201090.',  # API ≈üifresi
            main_window=self  # Main window referansƒ±
        )
        
        # IBKR TWS/Gateway client (ib_insync)
        from .ibkr_client import IBKRClient
        self.ibkr = IBKRClient(
            host='127.0.0.1',  # localhost
            port=4001,         # IBKR Gateway port (4001=live, 4002=paper)
            client_id=1,       # Client ID
            main_window=self   # Main window referansƒ±
        )
        
        # IBKR Native client (TWS API)
        from .ibkr_native_client import IBKRNativeClient
        self.ibkr_native = IBKRNativeClient(
            host='127.0.0.1',  # localhost
            port=4001,         # IBKR Gateway port (4001=live, 4002=paper)
            client_id=2,       # Farklƒ± Client ID (native i√ßin)
            main_window=self   # Main window referansƒ±
        )
        
        # Mode Manager
        from .mode_manager import ModeManager
        self.mode_manager = ModeManager(
            hammer_client=self.hammer,
            ibkr_client=self.ibkr,
            ibkr_native_client=self.ibkr_native,
            main_window=self  # Controller kontrol√º i√ßin
        )
        
        # Mod sistemi
        self.current_mode = "HAMPRO"  # HAMPRO veya IBKR
        self.hampro_mode = True
        self.ibkr_gun_mode = False
        self.ibkr_ped_mode = False
        
        # Order Manager
        self.order_manager = OrderManager(self)
        
        # G√ºnl√ºk befham.csv kontrol√º
        self.befham_checked_today = False
        self.check_daily_befham()
        # G√ºnl√ºk befibgun.csv ve befibped.csv kontrol√º (IBKR i√ßin)
        self.befibgun_checked_today = False
        self.befibped_checked_today = False
        
        # BDATA Storage
        self.bdata_storage = BDataStorage()
        
        # Stock Data Manager - Ana sayfa verilerini y√∂netmek i√ßin
        self.stock_data_manager = StockDataManager()
        
        # Exception List Manager - Trade edilmemesi gereken hisseleri y√∂netir
        self.exception_manager = ExceptionListManager("exception_list.csv")
        
        # ETF verilerini takip etmek i√ßin
        self.etf_data = {}
        
        # Benchmark hesaplama i√ßin gerekli veriler
        self.pff_last = None
        self.tlt_last = None
        self.spy_last = None
        self.ief_last = None
        self.iei_last = None
        
        # Benchmark form√ºlleri (kupon oranlarƒ±na g√∂re) - %20 AZALTILMI≈û KATSAYILAR
        self.benchmark_formulas = {
            'DEFAULT': {'PFF': 1.1, 'TLT': -0.08, 'IEF': 0.0, 'IEI': 0.0},  # PFF*1.1 - TLT*0.08
            'C400': {'PFF': 0.36, 'TLT': 0.36, 'IEF': 0.08, 'IEI': 0.0},
            'C425': {'PFF': 0.368, 'TLT': 0.34, 'IEF': 0.092, 'IEI': 0.0},
            'C450': {'PFF': 0.38, 'TLT': 0.32, 'IEF': 0.10, 'IEI': 0.0},
            'C475': {'PFF': 0.40, 'TLT': 0.30, 'IEF': 0.12, 'IEI': 0.0},
            'C500': {'PFF': 0.32, 'TLT': 0.40, 'IEF': 0.08, 'IEI': 0.0},
            'C525': {'PFF': 0.42, 'TLT': 0.28, 'IEF': 0.14, 'IEI': 0.0},
            'C550': {'PFF': 0.408, 'TLT': 0.2, 'IEF': 0.152, 'IEI': 0.04},
            'C575': {'PFF': 0.44, 'TLT': 0.24, 'IEF': 0.16, 'IEI': 0.0},
            'C600': {'PFF': 0.432, 'TLT': 0.12, 'IEF': 0.168, 'IEI': 0.08},
            'C625': {'PFF': 0.448, 'TLT': 0.08, 'IEF': 0.172, 'IEI': 0.1}
        }
        
        # √ñnceki ETF fiyatlarƒ± (deƒüi≈üim hesaplama i√ßin)
        self.prev_etf_prices = {}
        
        # Stabil benchmark hesaplama i√ßin
        self.stable_etf_changes = {}  # Son g√ºncellenmi≈ü sabit deƒüerler
        self.etf_changes = {}  # ETF deƒüi≈üimleri (stable'dan kopyalanƒ±r)
        self.last_benchmark_update = 0  # Son g√ºncelleme zamanƒ±
        self.benchmark_update_interval = 5.0  # 5 saniyede bir g√ºncelle
        
        # Cache sistemi - hesaplama bo≈üluklarƒ±nƒ± √∂nle
        self.last_valid_scores = {}  # Her ticker i√ßin son ge√ßerli skorlar
        
        # Ba≈ülangƒ±√ßta bo≈ü DataFrame
        self.df = pd.DataFrame()
        
        # Ana CSV dosyasƒ±nƒ± otomatik y√ºkle
        self.load_main_csv_on_startup()
        self.tickers = []
        
        # Sayfalama ayarlarƒ±
        self.items_per_page = 15
        self.current_page = 0
        self.total_pages = (len(self.tickers) + self.items_per_page - 1) // self.items_per_page
        
        # Sƒ±ralama ayarlarƒ±
        self.sort_column = None
        self.sort_ascending = True
        
        self.setup_ui()
        
        # Ba≈ülangƒ±√ßta exposure bilgisini g√ºncelle
        self.after(1000, self.update_exposure_display)  # 1 saniye sonra g√ºncelle
    
    def load_main_csv_on_startup(self):
        """Uygulama ba≈ülarken ana CSV dosyasƒ±nƒ± otomatik y√ºkle"""
        try:
            csv_file = 'janalldata.csv'
            if os.path.exists(csv_file):
                print(f"[STARTUP] INFO Ana CSV dosyasi yukleniyor: {csv_file}")
                self.show_file_data(csv_file, is_main=True)
                print(f"[STARTUP] ‚úÖ Ana CSV dosyasƒ± y√ºklendi: {len(self.df)} hisse")
            else:
                print(f"[STARTUP] ‚ö†Ô∏è Ana CSV dosyasƒ± bulunamadƒ±: {csv_file}")
                print(f"[STARTUP] üí° Benchmark hesaplamalarƒ± i√ßin CSV dosyasƒ± gerekli!")
        except Exception as e:
            print(f"[STARTUP] ERROR Ana CSV yukleme hatasi: {e}")
        
    def setup_ui(self):
        # √úst panel - Baƒülantƒ± butonlarƒ±
        top_frame = ttk.Frame(self)
        top_frame.pack(fill='x', padx=5, pady=5)
        
        self.btn_connect = ttk.Button(top_frame, text="Hammer Pro'ya Baƒülan", command=self.connect_hammer)
        self.btn_connect.pack(side='left', padx=2)
        
        self.btn_live = ttk.Button(top_frame, text="Live Data Ba≈ülat", command=self.toggle_live_data)
        self.btn_live.pack(side='left', padx=2)
        
        self.btn_prev_close = ttk.Button(top_frame, text="Prev Close √áek", command=self.fetch_all_prev_close)
        self.btn_prev_close.pack(side='left', padx=2)
        
        # BDATA butonlarƒ±
        bdata_frame = ttk.Frame(top_frame)
        bdata_frame.pack(side='right', padx=2)
        
        self.btn_bdata_export = ttk.Button(bdata_frame, text="BDATA Export", command=self.export_bdata, width=12)
        self.btn_bdata_export.pack(side='left', padx=1)
        
        self.btn_befday_export = ttk.Button(bdata_frame, text="BEFDAY Export", command=self.export_befday, width=12)
        self.btn_befday_export.pack(side='left', padx=1)
        
        self.btn_bdata_clear = ttk.Button(bdata_frame, text="BDATA Clear", command=self.clear_bdata, width=12)
        self.btn_bdata_clear.pack(side='left', padx=1)
        
        # Exception List butonu
        self.btn_exception_list = ttk.Button(bdata_frame, text="Exception List", command=self.open_exception_list, width=12)
        self.btn_exception_list.pack(side='left', padx=1)
        
        # Stock Data Manager Durum butonu
        self.btn_stock_data_status = ttk.Button(bdata_frame, text="Stock Data Status", 
                                              command=self.show_stock_data_status, width=15)
        self.btn_stock_data_status.pack(side='left', padx=1)
        
        # Exposure bilgisi g√∂sterimi - Lot B√∂l√ºc√º yanƒ±na ta≈üƒ±nacak
        
        # Port Adjuster butonu
        self.btn_port_adjuster = ttk.Button(top_frame, text="Port Adjuster", width=14,
                                           command=self.show_port_adjuster)
        self.btn_port_adjuster.pack(side='left', padx=4)
        
        # Pozisyonlarƒ±m butonu
        from .mypositions import show_positions_window
        self.btn_mypos = ttk.Button(top_frame, text="Pozisyonlarƒ±m", width=14,
                                    command=lambda: self.show_positions())
        self.btn_mypos.pack(side='left', padx=4)
        
        # Take Profit Longs butonu
        self.btn_take_profit_longs = ttk.Button(top_frame, text="Take Profit Longs", width=16,
                                               command=self.show_take_profit_longs)
        self.btn_take_profit_longs.pack(side='left', padx=4)
        
        # Take Profit Shorts butonu
        self.btn_take_profit_shorts = ttk.Button(top_frame, text="Take Profit Shorts", width=16,
                                                command=self.show_take_profit_shorts)
        self.btn_take_profit_shorts.pack(side='left', padx=4)
        
        # Spreadkusu butonu
        self.btn_spreadkusu = ttk.Button(top_frame, text="Spreadkusu", width=12,
                                        command=self.show_spreadkusu)
        self.btn_spreadkusu.pack(side='left', padx=4)
        
        # Emirlerim butonu
        self.btn_my_orders = ttk.Button(top_frame, text="Emirlerim", width=12,
                                       command=self.show_my_orders)
        self.btn_my_orders.pack(side='left', padx=4)
        
        # BEFHAM butonu (befham.csv)
        from .befpos_exporter import show_befpos_exporter
        self.btn_befpos = ttk.Button(top_frame, text="BEFHAM", width=10,
                                    command=lambda: show_befpos_exporter(self.hammer))
        self.btn_befpos.pack(side='left', padx=4)
        
        # jdata Analiz butonu
        from .myjdata import show_jdata_window
        self.btn_jdata = ttk.Button(top_frame, text="jdata Analiz", width=14,
                                    command=lambda: show_jdata_window(self, self.get_last_price_for_symbol))
        self.btn_jdata.pack(side='left', padx=4)
        
        # Top Ten Bid Buy butonu
        self.btn_top_ten_bid_buy = ttk.Button(top_frame, text="Top Ten Bid Buy", width=16,
                                              command=self.top_ten_bid_buy)
        self.btn_top_ten_bid_buy.pack(side='left', padx=4)
        
        # Bottom Ten Ask Sell butonu
        self.btn_bottom_ten_ask_sell = ttk.Button(top_frame, text="Bottom Ten Ask Sell", width=18,
                                                  command=self.bottom_ten_ask_sell)
        self.btn_bottom_ten_ask_sell.pack(side='left', padx=4)
        
        # Port Adjuster butonu
        self.btn_port_adjuster = ttk.Button(top_frame, text="Port Adjuster", width=14,
                                           command=self.show_port_adjuster)
        self.btn_port_adjuster.pack(side='left', padx=4)
        
        # Order Management Butonlarƒ±
        order_frame = ttk.Frame(self)
        order_frame.pack(fill='x', padx=5, pady=2)
        
        # Order butonlarƒ±
        self.btn_bid_buy = ttk.Button(order_frame, text="Bid Buy", 
                                     command=lambda: self.order_manager.place_order_for_selected('bid_buy'), width=10)
        self.btn_bid_buy.pack(side='left', padx=1)
        
        self.btn_front_buy = ttk.Button(order_frame, text="Front Buy", 
                                       command=lambda: self.order_manager.place_order_for_selected('front_buy'), width=10)
        self.btn_front_buy.pack(side='left', padx=1)
        
        self.btn_ask_buy = ttk.Button(order_frame, text="Ask Buy", 
                                     command=lambda: self.order_manager.place_order_for_selected('ask_buy'), width=10)
        self.btn_ask_buy.pack(side='left', padx=1)
        
        self.btn_ask_sell = ttk.Button(order_frame, text="Ask Sell", 
                                      command=lambda: self.order_manager.place_order_for_selected('ask_sell'), width=10)
        self.btn_ask_sell.pack(side='left', padx=1)
        
        self.btn_front_sell = ttk.Button(order_frame, text="Front Sell", 
                                        command=lambda: self.order_manager.place_order_for_selected('front_sell'), width=10)
        self.btn_front_sell.pack(side='left', padx=1)
        
        # Soft Front butonlarƒ±
        self.btn_soft_front_buy = ttk.Button(order_frame, text="SoftFront Buy", 
                                           command=lambda: self.order_manager.place_order_for_selected('soft_front_buy'), width=12)
        self.btn_soft_front_buy.pack(side='left', padx=1)
        
        self.btn_soft_front_sell = ttk.Button(order_frame, text="SoftFront Sell", 
                                            command=lambda: self.order_manager.place_order_for_selected('soft_front_sell'), width=12)
        self.btn_soft_front_sell.pack(side='left', padx=1)
        
        self.btn_bid_sell = ttk.Button(order_frame, text="Bid Sell", 
                                      command=lambda: self.order_manager.place_order_for_selected('bid_sell'), width=10)
        self.btn_bid_sell.pack(side='left', padx=1)
        
        # Lot se√ßim frame
        lot_frame = ttk.Frame(self)
        lot_frame.pack(fill='x', padx=5, pady=2)
        
        # Manuel lot giri≈üi
        ttk.Label(lot_frame, text="Lot:").pack(side='left', padx=2)
        self.lot_entry = ttk.Entry(lot_frame, width=8)
        self.lot_entry.pack(side='left', padx=2)
        self.lot_entry.insert(0, "200")  # Default 200 lot
        
        # Lot butonlarƒ±
        self.btn_lot_25 = ttk.Button(lot_frame, text="%25", 
                                    command=lambda: self.order_manager.set_lot_percentage(25), width=6)
        self.btn_lot_25.pack(side='left', padx=1)
        
        self.btn_lot_50 = ttk.Button(lot_frame, text="%50", 
                                    command=lambda: self.order_manager.set_lot_percentage(50), width=6)
        self.btn_lot_50.pack(side='left', padx=1)
        
        self.btn_lot_75 = ttk.Button(lot_frame, text="%75", 
                                    command=lambda: self.order_manager.set_lot_percentage(75), width=6)
        self.btn_lot_75.pack(side='left', padx=1)
        
        self.btn_lot_100 = ttk.Button(lot_frame, text="%100", 
                                     command=lambda: self.order_manager.set_lot_percentage(100), width=6)
        self.btn_lot_100.pack(side='left', padx=1)
        
        self.btn_lot_avg_adv = ttk.Button(lot_frame, text="Avg Adv", 
                                         command=self.order_manager.set_lot_avg_adv, width=8)
        self.btn_lot_avg_adv.pack(side='left', padx=1)
        
        # Se√ßim butonlarƒ±
        selection_frame = ttk.Frame(self)
        selection_frame.pack(fill='x', padx=5, pady=2)
        
        self.btn_select_all = ttk.Button(selection_frame, text="T√ºm√ºn√º Se√ß", 
                                       command=self.order_manager.select_all_tickers, width=12)
        self.btn_select_all.pack(side='left', padx=1)
        
        self.btn_deselect_all = ttk.Button(selection_frame, text="T√ºm√ºn√º Kaldƒ±r", 
                                         command=self.order_manager.deselect_all_tickers, width=12)
        self.btn_deselect_all.pack(side='left', padx=1)
        
        # Mod butonlarƒ± - T√ºm√ºn√º Se√ß ve T√ºm√ºn√º Kaldƒ±r butonlarƒ±nƒ±n yanƒ±na ta≈üƒ±ndƒ±
        self.btn_hampro_mode = ttk.Button(selection_frame, text="HAMPRO MOD", width=12,
                                         command=lambda: self.set_mode("HAMPRO"))
        self.btn_hampro_mode.pack(side='left', padx=2)
        
        self.btn_ibkr_gun_mode = ttk.Button(selection_frame, text="IBKR GUN MOD", width=14,
                                           command=lambda: self.set_mode("IBKR_GUN"))
        self.btn_ibkr_gun_mode.pack(side='left', padx=2)
        
        self.btn_ibkr_ped_mode = ttk.Button(selection_frame, text="IBKR PED MOD", width=14,
                                           command=lambda: self.set_mode("IBKR_PED"))
        self.btn_ibkr_ped_mode.pack(side='left', padx=2)
        
        # Tablo - CSV'den gelen t√ºm kolonlarƒ± kullan
        # Ba≈ülangƒ±√ßta bo≈ü, CSV y√ºklendiƒüinde g√ºncellenecek
        self.columns = ['Se√ß']  # Se√ß kolonu her zaman ilk
        
        # Style ayarla - k√º√ß√ºk font
        style = ttk.Style()
        style.configure("Treeview", font=('Arial', 6))
        style.configure("Treeview.Heading", font=('Arial', 6, 'bold'))
        
        self.table = ttk.Treeview(self, columns=self.columns, show='headings', height=15)
        
        # √áift tƒ±klama olayƒ±nƒ± baƒüla
        self.table.bind('<Double-1>', self.on_double_click)
        
        # Checkbox tƒ±klama olayƒ±nƒ± baƒüla - sadece Se√ß kolonu i√ßin
        self.table.bind('<ButtonRelease-1>', self.on_table_click)
        
        # Kolon ba≈ülƒ±klarƒ± ve geni≈ülikleri  
        score_columns = [
            'Bid_buy_ucuzluk_skoru', 'Front_buy_ucuzluk_skoru', 'Ask_buy_ucuzluk_skoru',
            'Ask_sell_pahalilik_skoru', 'Front_sell_pahalilik_skoru', 'Bid_sell_pahalilik_skoru',
            'Final_BB_skor', 'Final_FB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor', 'Final_SAS_skor', 'Final_SFS_skor', 'Final_SBS_skor',
            'Spread'
        ]
        benchmark_columns = ['Benchmark_Type', 'Benchmark_Chg']
        
        for col in self.columns:
            # Sƒ±ralama fonksiyonunu baƒüla
            self.table.heading(col, 
                text=col,
                command=lambda c=col: self.sort_by_column(c))
                
            if col in ['PREF IBKR']:
                self.table.column(col, width=35, anchor='w')  # Sol hizalƒ± - √ßok dar
            elif col in ['CMON', 'CGRUP']:
                self.table.column(col, width=15, anchor='center')  # En dar
            elif col in ['SMI', 'SHORT_FINAL']:
                self.table.column(col, width=20, anchor='center')  # Dar
            elif col in ['FINAL_THG', 'AVG_ADV']:
                self.table.column(col, width=25, anchor='center')  # Orta
            elif col in score_columns:
                self.table.column(col, width=30, anchor='center')  # Skor kolonlarƒ± - √ßok dar
            elif col in benchmark_columns:
                self.table.column(col, width=20, anchor='center') # Benchmark kolonlarƒ± - orta
            else:
                self.table.column(col, width=20, anchor='center')  # Normal - √ßok dar
                
        self.table.pack(fill='both', expand=True, padx=5, pady=5)
        
        # Mod butonlarƒ±nƒ± ayarla
        self.setup_mode_buttons()
        
        # CSV dosya butonlarƒ±
        files_frame = ttk.Frame(self)
        files_frame.pack(fill='x', padx=5, pady=5)
        
        # Ana veri butonu
        main_frame = ttk.Frame(files_frame)
        main_frame.pack(fill='x', pady=2)
        
        btn_main = ttk.Button(main_frame, text="JANALLDATA", 
                            command=lambda: self.show_file_data('janalldata.csv', is_main=True))
        btn_main.pack(side='left', padx=2)
        
        # Mini450 butonu - T√ºm hisseleri mini g√∂r√ºn√ºmde g√∂ster
        btn_mini450 = ttk.Button(main_frame, text="üîç mini450", 
                                command=self.show_mini450_view, 
                                style='Accent.TButton')
        btn_mini450.pack(side='left', padx=5)
        
        # MAJBINA butonu - Filtreleme ve analiz penceresi
        btn_majbina = ttk.Button(main_frame, text="üîé MAJBINA", 
                                command=self.show_majbina_window, 
                                style='Accent.TButton')
        btn_majbina.pack(side='left', padx=5)
        
        # Psfalgo butonu - Pozisyon y√∂netimi robotu
        btn_psfalgo = ttk.Button(main_frame, text="ü§ñ Psfalgo", 
                                command=self.start_psfalgo_robot, 
                                style='Accent.TButton')
        btn_psfalgo.pack(side='left', padx=5)
        
        # Compare It butonu - Portf√∂y kar≈üƒ±la≈ütƒ±rmasƒ±
        self.btn_compare_it = ttk.Button(main_frame, text="üìä Compare It", 
                                        command=self.show_portfolio_comparison,
                                        style='Accent.TButton')
        self.btn_compare_it.pack(side='left', padx=5)
        
        # Lot B√∂l√ºc√º butonu - Emirleri 200er lotlar halinde b√∂l
        self.lot_divider_enabled = False
        self.btn_lot_divider = ttk.Button(main_frame, text="üì¶ Lot B√∂l√ºc√º: OFF", 
                                        command=self.toggle_lot_divider, 
                                        style='Accent.TButton')
        self.btn_lot_divider.pack(side='left', padx=5)
        
        # Exposure bilgisi g√∂sterimi - Lot B√∂l√ºc√º yanƒ±nda
        self.exposure_label = ttk.Label(main_frame, text="HAMPRO mod a√ßƒ±k - Long: 0.00 | Short: 0.00 | Total: 0.00", 
                                       font=('Arial', 9, 'bold'), foreground='blue')
        self.exposure_label.pack(side='left', padx=10)
        
        # Ayƒ±rƒ±cƒ± √ßizgi
        separator = ttk.Separator(files_frame, orient='horizontal')
        separator.pack(fill='x', pady=5)
        
        # CSV dosya isimleri - janek_ssfinek dosyalarƒ±nƒ± kullan (prev_close kolonu var)
        csv_files = [
            'janek_ssfinekheldcilizyeniyedi.csv',
            'janek_ssfinekheldcommonsuz.csv',
            'janek_ssfinekhelddeznff.csv',
            'janek_ssfinekheldff.csv',
            'janek_ssfinekheldflr.csv',
            'janek_ssfinekheldgarabetaltiyedi.csv',
            'janek_ssfinekheldkuponlu.csv',
            'janek_ssfinekheldkuponlukreciliz.csv',
            'janek_ssfinekheldkuponlukreorta.csv',
            'janek_ssfinekheldnff.csv',
            'janek_ssfinekheldotelremorta.csv',
            'janek_ssfinekheldsolidbig.csv',
            'janek_ssfinekheldtitrekhc.csv',
            'janek_ssfinekhighmatur.csv',
            'janek_ssfineknotbesmaturlu.csv',
            'janek_ssfineknotcefilliquid.csv',
            'janek_ssfineknottitrekhc.csv',
            'janek_ssfinekrumoreddanger.csv',
            'janek_ssfineksalakilliquid.csv',
            'janek_ssfinekshitremhc.csv'
        ]
        
        # Her satƒ±rda 10 buton olacak ≈üekilde d√ºzenle
        buttons_per_row = 10
        current_frame = ttk.Frame(files_frame)
        current_frame.pack(fill='x', pady=2)
        
        for i, file in enumerate(csv_files):
            # Her 10 butonda bir yeni satƒ±r ba≈ülat
            if i > 0 and i % buttons_per_row == 0:
                current_frame = ttk.Frame(files_frame)
                current_frame.pack(fill='x', pady=2)
            
            # Dosya adƒ±nƒ± kƒ±salt
            short_name = file.replace('janek_ssfinek', '').replace('.csv', '')
            btn = ttk.Button(current_frame, text=short_name, command=lambda f=file: self.show_file_data(f))
            btn.pack(side='left', padx=2)
        
        # SRPAN butonu - Grup butonlarƒ±nƒ±n saƒüƒ±na ekle
        self.btn_srpan = ttk.Button(current_frame, text="SRPAN", 
                                   command=self.show_srpan_analysis,
                                   style='Accent.TButton')
        self.btn_srpan.pack(side='left', padx=10)
        
        # Pressure Analiz butonu - SRPAN'ƒ±n yanƒ±na
        self.btn_pressure = ttk.Button(current_frame, text="üìä Pressure Analiz", 
                                       command=self.show_pressure_analysis,
                                       style='Accent.TButton')
        self.btn_pressure.pack(side='left', padx=5)
        
        # BGGG Analiz butonu - Pressure Analiz'in yanƒ±na
        self.btn_bggg = ttk.Button(current_frame, text="üìà BGGG", 
                                   command=self.show_bggg_analysis,
                                   style='Accent.TButton')
        self.btn_bggg.pack(side='left', padx=5)
        
        # Ticker Alerts butonu - SRPAN'ƒ±n yanƒ±na
        self.btn_ticker_alerts = ttk.Button(current_frame, text="üìä Ticker Alerts", 
                                           command=self.show_ticker_alerts,
                                           style='Accent.TButton')
        self.btn_ticker_alerts.pack(side='left', padx=5)
        
        # ETF Cardinal butonu - Ticker Alerts'in yanƒ±na
        self.btn_etf_cardinal = ttk.Button(current_frame, text="üéØ ETF Cardinal", 
                                          command=self.show_etf_cardinal,
                                          style='Accent.TButton')
        self.btn_etf_cardinal.pack(side='left', padx=5)
        
        # TGFilterer butonu - ETF Cardinal'ƒ±n yanƒ±na
        self.btn_tgfilterer = ttk.Button(current_frame, text="üîç TGFilterer", 
                                        command=self.show_tgfilterer,
                                        style='Accent.TButton')
        self.btn_tgfilterer.pack(side='left', padx=5)
        
        # SRPAN i√ßin son se√ßilen grup
        self.srpan_current_group = None
        self.srpan_current_data = None
        
        # Ticker Alerts i√ßin veri yapƒ±larƒ±
        self.ticker_alerts_data = {}  # {symbol: {'high': x, 'low': y, 'last': z}}
        self.ticker_alert_history = []  # Alert ge√ßmi≈üi
        
        # ETF Cardinal i√ßin veri yapƒ±larƒ±
        self.cardinal_running = False
        self.cardinal_price_history = []  # [{timestamp, PFF, SPY, KRE, IWM, TLT}, ...]
        self.cardinal_settings = {
            'PFF': {'threshold_2min': 0.04, 'threshold_5min': 0.06, 'type': 'absolute'},
            'SPY': {'threshold_2min': 0.4, 'threshold_5min': 0.6, 'type': 'percent'},
            'KRE': {'threshold_2min': 0.4, 'threshold_5min': 0.6, 'type': 'percent'},
            'IWM': {'threshold_2min': 0.5, 'threshold_5min': 0.75, 'type': 'percent'},
            'TLT': {'threshold_2min': 0.40, 'threshold_5min': 0.60, 'type': 'absolute'}
        }
        self.cardinal_window = None
        self.cardinal_after_id = None
        
        # ETF Paneli
        self.etf_panel = ETFPanel(self, self.hammer)
        self.etf_panel.pack(fill='x', padx=5, pady=5)
        
        # Ayƒ±rƒ±cƒ± √ßizgi
        separator = ttk.Separator(self, orient='horizontal')
        separator.pack(fill='x', pady=5)
        
        # Sayfalama kontrolleri
        nav_frame = ttk.Frame(self)
        nav_frame.pack(fill='x', padx=5, pady=5)
        
        self.btn_prev = ttk.Button(nav_frame, text="<", command=self.prev_page)
        self.btn_prev.pack(side='left', padx=2)
        
        self.lbl_page = ttk.Label(nav_frame, text=f"Sayfa {self.current_page + 1} / {self.total_pages}")
        self.lbl_page.pack(side='left', padx=10)
        
        self.btn_next = ttk.Button(nav_frame, text=">", command=self.next_page)
        self.btn_next.pack(side='left', padx=2)
        
        # ƒ∞lk sayfayƒ± g√∂ster
        self.update_table()
        
    def export_bdata(self):
        """BDATA ve BEFDAY CSV'lerini olu≈ütur"""
        try:
            self.bdata_storage.export_to_csv()
            messagebox.showinfo("Ba≈üarƒ±lƒ±", "BDATA ve BEFDAY CSV'leri olu≈üturuldu!")
        except Exception as e:
            messagebox.showerror("Hata", f"BDATA export hatasƒ±: {e}")
    
    def export_befday(self):
        """Sadece BEFDAY CSV'sini olu≈ütur"""
        try:
            summary = self.bdata_storage.get_position_summary_with_snapshot()
            self.bdata_storage.create_befday_csv(summary)
            messagebox.showinfo("Ba≈üarƒ±lƒ±", "BEFDAY CSV'si olu≈üturuldu!")
        except Exception as e:
            messagebox.showerror("Hata", f"BEFDAY export hatasƒ±: {e}")
    
    def clear_bdata(self):
        """BDATA verilerini temizle"""
        if messagebox.askyesno("Onay", "T√ºm BDATA verilerini temizlemek istediƒüinizden emin misiniz?"):
            try:
                self.bdata_storage.clear_all_data()
                messagebox.showinfo("Ba≈üarƒ±lƒ±", "BDATA verileri temizlendi!")
            except Exception as e:
                messagebox.showerror("Hata", f"BDATA temizleme hatasƒ±: {e}")
    
    def add_manual_fill(self, ticker, direction, price, size):
        """Manuel fill ekle"""
        try:
            self.bdata_storage.add_manual_fill(ticker, direction, price, size)
            print(f"[MANUAL FILL] {ticker} {direction} {size}@{price} eklendi")
        except Exception as e:
            print(f"[MANUAL FILL] Hata: {e}")
    
    def update_etf_data_for_benchmark(self):
        """STABƒ∞L ETF benchmark hesaplama - 5 saniyede bir g√ºncelle"""
        try:
            import time
            current_time = time.time()
            
            # 5 saniyede bir g√ºncelle (s√ºrekli deƒüil!)
            if current_time - self.last_benchmark_update < self.benchmark_update_interval:
                return  # Hen√ºz zamanƒ± gelmedi
            
            # Benchmark ETF'ler
            benchmark_etfs = ['SPY', 'TLT', 'IEF', 'IEI', 'PFF', 'KRE', 'IWM']
            
            # ETF Panel'deki cache'lenmi≈ü verileri kullan (daha stabil)
            if hasattr(self, 'etf_panel') and self.etf_panel:
                for etf in benchmark_etfs:
                    # ETF Panel'deki aynƒ± veri kaynaƒüƒ±nƒ± kullan!
                    if etf in self.etf_panel.etf_data:
                        etf_data = self.etf_panel.etf_data[etf]
                        last_price = etf_data.get('last', 0)
                        
                        # ETF Panel'deki CSV'den prev_close al (aynƒ± kaynak!)
                        csv_prev_close = self.etf_panel.get_etf_prev_close(etf)
                        
                        if last_price > 0 and csv_prev_close > 0:
                            # ETF Panel'deki aynƒ± hesaplama y√∂ntemi!
                            change_dollars = round(last_price - csv_prev_close, 4)
                            self.stable_etf_changes[etf] = change_dollars
                        else:
                            self.stable_etf_changes[etf] = 0
                    else:
                        # ETF Panel'de yoksa CSV'den al
                        csv_prev_close = self.etf_panel.get_etf_prev_close(etf)
                        if csv_prev_close > 0:
                            # Market data'dan last price al
                            market_data = self.hammer.get_market_data(etf)
                            if market_data:
                                last_price = market_data.get('last', 0)
                                if last_price > 0:
                                    change_dollars = round(last_price - csv_prev_close, 4)
                                    self.stable_etf_changes[etf] = change_dollars
                                else:
                                    self.stable_etf_changes[etf] = 0
                            else:
                                self.stable_etf_changes[etf] = 0
                        else:
                            self.stable_etf_changes[etf] = 0
            
            # Son g√ºncelleme zamanƒ±nƒ± kaydet
            self.last_benchmark_update = current_time
            
            # self.etf_changes'i stable deƒüerlerle g√ºncelle
            self.etf_changes = self.stable_etf_changes.copy()
                
        except Exception as e:
            pass
    
    def get_benchmark_type_for_ticker(self, ticker):
        """Ticker i√ßin benchmark tipini belirle (CGRUP'a g√∂re)"""
        try:
            # DataFrame'i kontrol et
            if self.df.empty:
                return 'DEFAULT'
            
            # Ticker'ƒ± DataFrame'de ara
            ticker_row = self.df[self.df['PREF IBKR'] == ticker]
            
            if ticker_row.empty:
                return 'DEFAULT'
            
            # CGRUP kolonundan deƒüeri al
            cgrup_str = ticker_row.iloc[0]['CGRUP']
            
            if pd.isna(cgrup_str) or cgrup_str == '':
                return 'DEFAULT'
            
            # CGRUP deƒüerini benchmark key'e √ßevir
            # CGRUP deƒüerleri zaten 'c525' formatƒ±nda geliyor, direkt kullan
            if str(cgrup_str).lower().startswith('c'):
                benchmark_key = str(cgrup_str).upper()  # 'c525' -> 'C525'
            else:
                # Eski format: sayƒ±sal deƒüer (5.25 -> C525)
                benchmark_key = f"C{int(float(cgrup_str) * 100)}"
            
            if benchmark_key in self.benchmark_formulas:
                return benchmark_key
            else:
                return 'DEFAULT'
                
        except Exception as e:
            return 'DEFAULT'
    
    def get_benchmark_change_for_ticker(self, ticker):
        """STABƒ∞L Ticker benchmark deƒüi≈üimini hesapla - 2 decimal yuvarlamalƒ±"""
        try:
            # √ñnce stable ETF verilerini g√ºncelle (5s interval ile)
            self.update_etf_data_for_benchmark()
            
            if not hasattr(self, 'etf_changes') or not self.etf_changes:
                return 0.0
            
            # Ticker'ƒ±n benchmark tipini al
            benchmark_type = self.get_benchmark_type_for_ticker(ticker)
            formula = self.benchmark_formulas.get(benchmark_type, self.benchmark_formulas['DEFAULT'])
            
            # STABƒ∞L benchmark deƒüi≈üimini hesapla (2 decimal yuvarlama)
            benchmark_change = 0.0
            for etf, coefficient in formula.items():
                if etf in self.etf_changes and coefficient != 0:
                    etf_change = round(self.etf_changes[etf], 4)  # ETF change'i yuvarla
                    coefficient_rounded = round(coefficient, 2)    # Katsayƒ±yƒ± yuvarla
                    contribution = etf_change * coefficient_rounded
                    benchmark_change += contribution
            
            # 4 decimal'e yuvarla (stabil sonu√ß i√ßin)
            benchmark_change = round(benchmark_change, 4)
            
            # Benchmark shift deƒüerini uygula (General BM Shifter)
            if hasattr(self, 'benchmark_shift') and self.benchmark_shift != 0.0:
                benchmark_change = benchmark_change + self.benchmark_shift
                benchmark_change = round(benchmark_change, 4)
            
            return benchmark_change
            
        except Exception as e:
            return 0.0
    
    def connect_hammer(self):
        """Hammer Pro'ya baƒülan/baƒülantƒ±yƒ± kes"""
        if not self.hammer.connected:
            print("\n[HAMMER] OK Hammer Pro'ya baglaniliyor...")
            print(f"[HAMMER] OK Host: {self.hammer.host}")
            print(f"[HAMMER] OK Port: {self.hammer.port}")
            
            if self.hammer.connect():
                self.btn_connect.config(text="Baƒülantƒ±yƒ± Kes")
                print("[HAMMER] OK Baglanti basarili!")
                
                # NFILLED callback'lerini ayarla (fill logging i√ßin)
                self.setup_nfilled_callbacks()
                
                # Baƒülantƒ± kurulduktan sonra befham.csv g√ºnl√ºk kontrol (00:00-16:30)
                if not self.befham_checked_today:
                    self.check_daily_befham()
            else:
                print("[HAMMER] ERROR Baglanti basarisiz!")
                print("[HAMMER] INFO Kontrol edilecekler:")
                print("   1. Hammer Pro √ßalƒ±≈üƒ±yor mu?")
                print("   2. Port numarasƒ± doƒüru mu?")
                print("   3. API ≈üifresi doƒüru mu?")
        else:
            print("\n[HAMMER] OK Baglanti kesiliyor...")
            self.hammer.disconnect()
            self.btn_connect.config(text="Hammer Pro'ya Baƒülan")
            print("[HAMMER] OK Baglanti kesildi.")
            
    def toggle_live_data(self):
        """Live data akƒ±≈üƒ±nƒ± ba≈ülat/durdur"""
        if not hasattr(self, 'live_data_running'):
            self.live_data_running = False
            
        if not self.live_data_running:
            # √ñnce janalldata.csv'yi y√ºkle ve t√ºm sembollere subscribe ol
            self.show_file_data('janalldata.csv', is_main=True)
            
            # ETF'ler i√ßin sadece snapshot (L1 subscription yok)
            print("\n[ETF] OK ETF'ler icin snapshot sistemi baslatiliyor...")
            self.etf_panel.subscribe_etfs()  # Sadece snapshot √ßeker artƒ±k
            
            self.live_data_running = True
            self.btn_live.config(text="Live Data Durdur")
            
            # ETF verilerini g√ºncelleme d√∂ng√ºs√ºn√º ba≈ülat
            self.update_etf_data()
            
            # Ana tabloyu g√ºncelleme d√∂ng√ºs√ºn√º ba≈ülat
            self.update_live_data()
        else:
            self.live_data_running = False
            self.btn_live.config(text="Live Data Ba≈ülat")
            
            # Artƒ±k snapshot sistemi yok, L1 streaming kullanƒ±yoruz
            
    def fetch_all_prev_close(self):
        """T√ºm hisseler i√ßin previous close deƒüerlerini √ßek - KALDIRILDI!"""
        print("[PREV CLOSE] üö´ PREV CLOSE √áEKME ƒ∞≈ûLEMƒ∞ TAMAMEN KALDIRILDI!")
        print("[PREV CLOSE] üö´ Streaming veri kullanƒ±lacak, prev close √ßekilmeyecek!")
        return
            
    def fetch_prev_close_for_ticker(self, ticker):
        """Bir hisse i√ßin previous close deƒüerini √ßek - KALDIRILDI!"""
        print(f"[PREV CLOSE] üö´ PREV CLOSE √áEKME ƒ∞≈ûLEMƒ∞ TAMAMEN KALDIRILDI: {ticker}")
        return
    
    def load_prev_close_from_csv(self):
        """CSV dosyalarƒ±ndan prev_close deƒüerlerini y√ºkle"""
        try:
            # CSV dosyalarƒ±ndan prev_close deƒüerleri y√ºkleniyor...
            
            # janek_ss*.csv dosyalarƒ±nƒ± bul
            csv_files = []
            for file in os.listdir('.'):
                if file.startswith('janek_ss') and file.endswith('.csv'):
                    csv_files.append(file)
            
            # Bulunan dosyalar: {csv_files}
            
            # Cache'i temizle
            if hasattr(self, 'prev_close_cache'):
                delattr(self, 'prev_close_cache')
            self.prev_close_cache = {}
            
            # Her dosyayƒ± oku ve prev_close deƒüerlerini al
            for csv_file in csv_files:
                try:
                    df_csv = pd.read_csv(csv_file, encoding='utf-8-sig')
                    
                    # PREF IBKR ve prev_close kolonlarƒ±nƒ± kontrol et
                    if 'PREF IBKR' in df_csv.columns and 'prev_close' in df_csv.columns:
                        # {csv_file} okundu: {len(df_csv)} satƒ±r
                        
                        # prev_close deƒüerlerini cache'le
                        for idx, row in df_csv.iterrows():
                            ticker = row['PREF IBKR']
                            prev_close = row['prev_close']
                            
                            # NaN kontrol√º
                            if pd.notna(prev_close) and prev_close > 0:
                                self.prev_close_cache[ticker] = float(prev_close)
                                # {ticker}: prev_close={prev_close}
                            else:
                                # {ticker}: prev_close={prev_close} (ge√ßersiz)
                                pass
                    
                    else:
                        # {csv_file}: PREF IBKR veya prev_close kolonu bulunamadƒ±
                        pass
                
                except Exception as e:
                    continue
            
        except Exception as e:
            pass
            
    def update_scores_with_market_data(self):
        """Market data ile skorlarƒ± g√ºncelle - CSV'den prev_close oku"""
        try:
            # ETF verileri otomatik g√ºncelleniyor (5s interval)
            
            # CSV'lerden prev_close deƒüerlerini y√ºkle
            self.load_prev_close_from_csv()
            
            # Sadece g√∂r√ºn√ºr ticker'lar i√ßin i≈üle (performans i√ßin)
            visible_tickers = self.get_visible_tickers()
            
            # PREFERRED STOCK'LAR ƒ∞√áƒ∞N SADECE L1 STREAMING KULLANILACAK!
            # SNAPSHOT ƒ∞STEKLERƒ∞ TAMAMEN KALDIRILDI!
            
            for idx, row in self.df.iterrows():
                ticker = row['PREF IBKR']
                
                # Sadece g√∂r√ºn√ºr ticker'lar i√ßin skorlarƒ± hesapla
                if ticker not in visible_tickers:
                    continue
                    
                # T√ºm hisseler i√ßin i≈üle (ETF'ler ayrƒ± panelde)
                # Sadece ETF'leri hari√ß tut
                etf_list = ["SPY", "TLT", "IEF", "IEI", "PFF", "KRE", "IWM", "SHY", "PGF"]
                if ticker in etf_list:
                    continue
                    
                market_data = self.hammer.get_market_data(ticker)
                
                # Market data'dan deƒüerleri al (sadece streaming'den)
                bid = market_data.get('bid', 0)
                ask = market_data.get('ask', 0)
                last_price = market_data.get('last', 0)
                
                # DataFrame'den prev_close deƒüerini al
                df_prev_close = row.get('prev_close', 0)
                # print(f"[DEBUG] {ticker}: DataFrame'den df_prev_close={df_prev_close}")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
                
                if df_prev_close != 'N/A' and df_prev_close > 0:
                    prev_close = float(df_prev_close)
                    # print(f"[DEBUG] {ticker}: DataFrame'den prev_close kullanƒ±lƒ±yor: {prev_close}")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
                else:
                    # Cache'den al (fallback)
                    prev_close = self.get_prev_close_for_symbol(ticker)
                    # print(f"[DEBUG] {ticker}: Cache'den prev_close alƒ±ndƒ±: {prev_close}")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
                
                # DataFrame'e prev_close kolonunu ekle (zaten var ama g√ºncelle)
                self.df.at[idx, 'prev_close'] = prev_close
                
                # Debug: Streaming veri durumunu kontrol et
                if bid == 0 and ask == 0:
                    # print(f"[SKOR] ‚ö†Ô∏è {ticker} i√ßin streaming veri yok (bid={bid}, ask={ask})")
                    continue
                    
                # Benchmark deƒüi≈üimini hesapla
                benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                benchmark_type = self.get_benchmark_type_for_ticker(ticker)
                
                # Skorlarƒ± hesapla
                scores = self.calculate_scores(ticker, row, bid, ask, last_price, prev_close, benchmark_chg)
                
                # DataFrame'i g√ºncelle
                for col, value in scores.items():
                    try:
                        # Kolonu ekle (yoksa)
                        if col not in self.df.columns:
                            self.df[col] = 'N/A'
                        self.df.at[idx, col] = value
                        # Debug: ƒ∞lk 3 ticker i√ßin DataFrame'e yazƒ±lan deƒüerleri g√∂ster
                        # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
                        # if idx < 3 and col in ['Final_BB_skor', 'Final_SAS_skor']:
                        #     print(f"[DATAFRAME] {ticker}: {col} = {value}")
                    except Exception as e:
                        print(f"[DATAFRAME ERROR] {ticker} - {col}: {e}")
                
                # Benchmark deƒüerlerini g√ºncelle
                self.df.at[idx, 'Benchmark_Type'] = benchmark_type
                self.df.at[idx, 'Benchmark_Chg'] = benchmark_chg
                    
        except Exception as e:
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            pass
            # print(f"[HATA] Skor g√ºncelleme hatasƒ±: {e}")
    
    def calculate_scores_for_all_stocks(self):
        """T√ºm hisseler i√ßin skorlarƒ± hesapla"""
        try:
            if not hasattr(self, 'df') or self.df is None:
                # print("[SKOR] ‚ö†Ô∏è DataFrame bulunamadƒ±")
                return
            
            # print("[SKOR] üîÑ T√ºm hisseler i√ßin skorlar hesaplanƒ±yor...")
            
            for index, row in self.df.iterrows():
                ticker = row['PREF IBKR']
                
                # Market data al (cache'den √∂ncelik ver)
                if self.is_mini450_active:
                    market_data = self.get_cached_market_data(ticker)
                else:
                    market_data = self.hammer.get_market_data(ticker) if hasattr(self, 'hammer') and self.hammer else None
                
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    last_price = float(market_data.get('last', 0))
                else:
                    bid = ask = last_price = 0
                
                # Prev close al
                prev_close = self.get_prev_close_for_symbol(ticker)
                
                # Benchmark change al
                benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                
                # Skorlarƒ± hesapla
                self.calculate_scores(ticker, row, bid, ask, last_price, prev_close, benchmark_chg)
            
            # print("[SKOR] ‚úÖ T√ºm skorlar hesaplandƒ±")
            
        except Exception as e:
            # print(f"[SKOR] ‚ùå Skor hesaplama hatasƒ±: {e}")
            pass
    
    # calculate_scores_for_stock FONKSƒ∞YONU KALDIRILDI - YANLI≈û FORM√úLLER VARDI!
    # Artƒ±k calculate_scores FONKSƒ∞YONU KULLANILIYOR - DOƒûRU FORM√úLLER!
    
    def calculate_scores(self, ticker, row, bid, ask, last_price, prev_close, benchmark_chg=0):
        """Ntahaf form√ºllerine g√∂re skorlarƒ± hesapla - 800 katsayƒ±sƒ± ile final skorlama - Parametre olarak gelen prev_close kullan"""
        try:
            # Parametre olarak gelen prev_close deƒüerini kullan (daha g√ºvenilir!)
            if prev_close <= 0:
                # Fallback: DataFrame'den al
                df_prev_close = row.get('prev_close', 0)
                if df_prev_close != 'N/A' and df_prev_close > 0:
                    prev_close = float(df_prev_close)
                    # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
                    # print(f"[SKOR] ‚ö†Ô∏è {ticker}: DataFrame'den fallback prev_close={prev_close}")
                else:
                    # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
                    # print(f"[SKOR] ‚ùå {ticker}: prev_close bulunamadƒ±! DataFrame={df_prev_close}, Parametre={prev_close}")
                    return None
            
            # Spread hesapla
            spread = float(ask) - float(bid) if ask != 'N/A' and bid != 'N/A' and ask > 0 and bid > 0 else 0
            
            # Passive fiyatlar hesapla (Ntahaf form√ºlleri)
            pf_bid_buy = float(bid) + (spread * 0.15) if bid > 0 else 0
            pf_front_buy = float(last_price) + 0.01 if last_price > 0 else 0
            pf_ask_buy = float(ask) + 0.01 if ask > 0 else 0
            pf_ask_sell = float(ask) - (spread * 0.15) if ask > 0 else 0
            pf_front_sell = float(last_price) - 0.01 if last_price > 0 else 0
            pf_bid_sell = float(bid) - 0.01 if bid > 0 else 0
            
            # Deƒüi≈üimler hesapla (Ntahaf form√ºlleri) - DataFrame'den prev_close kullan
            pf_bid_buy_chg = pf_bid_buy - prev_close if prev_close > 0 else 0
            pf_front_buy_chg = pf_front_buy - prev_close if prev_close > 0 else 0
            pf_ask_buy_chg = pf_ask_buy - prev_close if prev_close > 0 else 0
            pf_ask_sell_chg = pf_ask_sell - prev_close if prev_close > 0 else 0
            pf_front_sell_chg = pf_front_sell - prev_close if prev_close > 0 else 0
            pf_bid_sell_chg = pf_bid_sell - prev_close if prev_close > 0 else 0
            
            # Ucuzluk/Pahalilik skorlarƒ± (Ntahaf form√ºlleri)
            bid_buy_ucuzluk = pf_bid_buy_chg - benchmark_chg
            front_buy_ucuzluk = pf_front_buy_chg - benchmark_chg
            ask_buy_ucuzluk = pf_ask_buy_chg - benchmark_chg
            ask_sell_pahali = pf_ask_sell_chg - benchmark_chg
            front_sell_pahali = pf_front_sell_chg - benchmark_chg
            bid_sell_pahali = pf_bid_sell_chg - benchmark_chg
            
            # Final skorlar (FINAL_THG varsa kullan, yoksa 0)
            final_thg_raw = row.get('FINAL_THG', 0)
            final_thg = float(final_thg_raw) if final_thg_raw != 'N/A' else 0
            
            # Debug: ƒ∞lk 3 ticker i√ßin detaylƒ± bilgi
            if ticker in ['AHL PRE', 'AHL PRD', 'ATH PRD']:
                # print(f"[SKOR DEBUG] {ticker}:")
                # print(f"  prev_close={prev_close}, benchmark_chg={benchmark_chg}")
                # print(f"  pf_bid_buy={pf_bid_buy:.4f}, pf_bid_buy_chg={pf_bid_buy_chg:.4f}")
                # print(f"  bid_buy_ucuzluk={bid_buy_ucuzluk:.4f}")
                # print(f"  FINAL_THG raw={final_thg_raw}, final_thg={final_thg:.2f}")
                # print(f"  final_bb hesaplama: {final_thg:.2f} - 800 * {bid_buy_ucuzluk:.4f} = {final_thg - 800 * bid_buy_ucuzluk:.2f} (800 katsayƒ±sƒ±)")
                # print(f"  [800 KATSAYISI] Final skorlama sistemi g√ºncellendi!")
                pass
            
            def final_skor(final_thg, skor):
                """Final skor hesaplama - 800 katsayƒ±sƒ± ile"""
                return final_thg - 800 * skor
            
            final_bb = final_skor(final_thg, bid_buy_ucuzluk)
            final_fb = final_skor(final_thg, front_buy_ucuzluk)
            final_ab = final_skor(final_thg, ask_buy_ucuzluk)
            final_as = final_skor(final_thg, ask_sell_pahali)
            final_fs = final_skor(final_thg, front_sell_pahali)
            final_bs = final_skor(final_thg, bid_sell_pahali)
            
            # Yeni Final SAS, Final SFS, Final SBS skorlarƒ± (SHORT_FINAL kullanarak - √ßƒ±karma form√ºl√º)
            short_final = float(row.get('SHORT_FINAL', 0)) if row.get('SHORT_FINAL') != 'N/A' else 0
            final_sas = short_final - 800 * ask_sell_pahali if short_final > 0 else 0
            final_sfs = short_final - 800 * front_sell_pahali if short_final > 0 else 0
            final_sbs = short_final - 800 * bid_sell_pahali if short_final > 0 else 0
            
            # Ba≈üarƒ±lƒ± hesaplanan skorlarƒ± cache'e kaydet
            calculated_scores = {
                'Bid_buy_ucuzluk_skoru': round(bid_buy_ucuzluk, 2),
                'Front_buy_ucuzluk_skoru': round(front_buy_ucuzluk, 2),
                'Ask_buy_ucuzluk_skoru': round(ask_buy_ucuzluk, 2),
                'Ask_sell_pahalilik_skoru': round(ask_sell_pahali, 2),
                'Front_sell_pahalilik_skoru': round(front_sell_pahali, 2),
                'Bid_sell_pahalilik_skoru': round(bid_sell_pahali, 2),
                'Final_BB_skor': round(final_bb, 2),
                'Final_FB_skor': round(final_fb, 2),
                'Final_AB_skor': round(final_ab, 2),
                'Final_AS_skor': round(final_as, 2),
                'Final_FS_skor': round(final_fs, 2),
                'Final_BS_skor': round(final_bs, 2),
                'Final_SAS_skor': round(final_sas, 2),
                'Final_SFS_skor': round(final_sfs, 2),
                'Final_SBS_skor': round(final_sbs, 2),
                'Spread': round(spread, 4)
            }
            
            # Cache'e kaydet
            if not hasattr(self, 'last_valid_scores'):
                self.last_valid_scores = {}
            self.last_valid_scores[ticker] = calculated_scores
            
            return calculated_scores
        except Exception as e:
            # Cache'den son ge√ßerli deƒüerleri al (varsa)
            if hasattr(self, 'last_valid_scores') and ticker in self.last_valid_scores:
                cached_scores = self.last_valid_scores[ticker]
                print(f"[CACHE] {ticker} i√ßin cached skorlar kullanƒ±lƒ±yor")
                return cached_scores
            else:
                print(f"[HATA] Skor hesaplama hatasƒ±: {e}")
                return {
                    'Bid_buy_ucuzluk_skoru': 0,
                    'Front_buy_ucuzluk_skoru': 0,
                    'Ask_buy_ucuzluk_skoru': 0,
                    'Ask_sell_pahalilik_skoru': 0,
                    'Front_sell_pahalilik_skoru': 0,
                    'Bid_sell_pahalilik_skoru': 0,
                    'Final_BB_skor': 0,
                    'Final_FB_skor': 0,
                    'Final_AB_skor': 0,
                    'Final_AS_skor': 0,
                    'Final_FS_skor': 0,
                    'Final_BS_skor': 0,
                    'Final_SAS_skor': 0,
                    'Final_SFS_skor': 0,
                    'Final_SBS_skor': 0,
                    'Spread': 0
                }

    def update_live_data(self):
        if not self.live_data_running:
            return
            
        # GUI g√ºncellemesini daha az sƒ±klƒ±kta yap (mini450'de)
        if hasattr(self, 'is_mini450_active') and self.is_mini450_active:
            # Mini450 modunda GUI g√ºncellemesini yava≈ülat
            self.update_table()
            self.update_scores_with_market_data() # Skorlarƒ± g√ºncelle
            self.after(3000, self.update_live_data)  # Mini450'de 3 saniyede bir
        else:
            # Normal modda hƒ±zlƒ± g√ºncelleme
            self.update_table()
            self.update_scores_with_market_data() # Skorlarƒ± g√ºncelle
            self.after(1000, self.update_live_data)  # Normal modda 1 saniyede bir
        
    def update_etf_data(self):
        """ETF verilerini g√ºncelle"""
        if not self.live_data_running:
            return
            
        try:
            # Her ETF i√ßin market verilerini al ve paneli g√ºncelle
            for symbol in self.etf_panel.etf_list:
                market_data = self.hammer.get_market_data(symbol)
                self.etf_panel.update_etf_data(symbol, market_data)
                
            # ETF display'ini g√ºncelle (ana tabloyu etkilemeden)
            self.etf_panel.update_etf_display()
                
        except Exception as e:
            print(f"[HATA] ETF g√ºncelleme hatasƒ±: {e}")
            
        # Her 2 saniyede bir g√ºncelle (ana tablodan baƒüƒ±msƒ±z)
        self.after(2000, self.update_etf_data)
        
    def get_visible_tickers(self):
        start_idx = self.current_page * self.items_per_page
        end_idx = min(start_idx + self.items_per_page, len(self.tickers))
        return self.tickers[start_idx:end_idx]
        
    def sort_by_column(self, column):
        """Se√ßilen kolona g√∂re sƒ±rala"""
        if self.sort_column == column:
            # Aynƒ± kolona tekrar tƒ±klandƒ±, sƒ±ralama y√∂n√ºn√º deƒüi≈ütir
            self.sort_ascending = not self.sort_ascending
        else:
            # Yeni kolon se√ßildi, artan sƒ±ralama ile ba≈üla
            self.sort_column = column
            self.sort_ascending = True
            
        # DataFrame'i sƒ±rala
        try:
            # Sayƒ±sal kolonlar i√ßin nan'larƒ± sona at
            if column in ['FINAL_THG', 'AVG_ADV', 'SMI', 'SHORT_FINAL', 'SMA63 chg', 'SMA246 chg', 'SMA 246 CHG', 'GORT', 'Bid', 'Ask', 'Last', 'Volume']:
                # √ñnce string 'N/A' deƒüerlerini NaN'a √ßevir
                self.df[column] = pd.to_numeric(self.df[column], errors='coerce')
                
            # Sƒ±rala
            self.df = self.df.sort_values(
                by=column,
                ascending=self.sort_ascending,
                na_position='last'
            )
            
            # Sƒ±ralanmƒ±≈ü ticker listesini g√ºncelle
            self.tickers = self.df['PREF IBKR'].tolist()
            
            # Ba≈ülƒ±ƒüƒ± g√ºncelle
            direction = "‚Üë" if self.sort_ascending else "‚Üì"
            for col in self.table["columns"]:
                if col == column:
                    self.table.heading(col, text=f"{col} {direction}")
                else:
                    self.table.heading(col, text=col)
                    
            # Tabloyu g√ºncelle
            self.current_page = 0  # ƒ∞lk sayfaya d√∂n
            self.update_table()
            
        except Exception as e:
            print(f"[HATA] Sƒ±ralama hatasƒ± ({column}): {e}")
        
    def update_table(self):
        # Mevcut se√ßimleri kaydet
        selected_items = {}
        for item in self.table.get_children():
            ticker = self.table.set(item, 'PREF IBKR')
            is_selected = self.table.set(item, 'Se√ß') == '‚úì'
            if is_selected:
                selected_items[ticker] = True
        
        # G√∂r√ºn√ºr ticker'larƒ± al
        visible_tickers = self.get_visible_tickers()
        
        # Tabloyu temizle ve yeniden olu≈ütur (sadece ilk kez veya sayfa deƒüi≈ütiƒüinde)
        if not hasattr(self, '_last_visible_tickers') or self._last_visible_tickers != visible_tickers:
            # Tabloyu temizle
            for item in self.table.get_children():
                self.table.delete(item)
            
            # Yeni g√∂r√ºn√ºr preferred stock'lara REAL-TIME L1 subscribe ol (sadece preferred stock'lar)
            if hasattr(self, 'live_data_running') and self.live_data_running:
                print(f"\n[PREF] üîÑ {len(visible_tickers)} preferred stock i√ßin REAL-TIME L1 streaming...")
                
                # Preferred stock'larƒ± kaydet
                self.preferred_tickers = [ticker for ticker in visible_tickers 
                                        if " PR" in ticker or " PRA" in ticker or " PRC" in ticker]
                
                for ticker in self.preferred_tickers:
                    self.hammer.subscribe_symbol(ticker)  # Artƒ±k bu L1 streaming yapacak (real-time)
                    print(f"[PREF] ‚úÖ {ticker} L1 streaming ba≈ülatƒ±ldƒ±")
                
                # 2s snapshot sistemi IPTAL - artƒ±k real-time L1 streaming kullanƒ±yoruz!
            
            # Her ticker i√ßin satƒ±r ekle
            for ticker in visible_tickers:
                try:
                    # CSV'den statik verileri al
                    row_data = self.df[self.df['PREF IBKR'] == ticker].iloc[0]
                    
                    # Statik deƒüerleri formatla
                    final_thg = row_data.get('FINAL_THG', 'N/A')
                    if isinstance(final_thg, (int, float)) and not np.isnan(final_thg):
                        final_thg = f"{final_thg:.2f}"
                        
                    avg_adv = row_data.get('AVG_ADV', 'N/A')
                    if isinstance(avg_adv, (int, float)) and not np.isnan(avg_adv):
                        avg_adv = f"{avg_adv:.2f}"
                        
                    smi = row_data.get('SMI', 'N/A')
                    if isinstance(smi, (int, float)) and not np.isnan(smi):
                        smi = f"{smi:.4f}"
                        
                    short_final = row_data.get('SHORT_FINAL', 'N/A')
                    if isinstance(short_final, (int, float)) and not np.isnan(short_final):
                        short_final = f"{short_final:.2f}"
                    
                    # Skor deƒüerlerini al
                    bid_buy_ucuzluk = row_data.get('Bid_buy_ucuzluk_skoru', 'N/A')
                    front_buy_ucuzluk = row_data.get('Front_buy_ucuzluk_skoru', 'N/A')
                    ask_buy_ucuzluk = row_data.get('Ask_buy_ucuzluk_skoru', 'N/A')
                    ask_sell_pahali = row_data.get('Ask_sell_pahalilik_skoru', 'N/A')
                    front_sell_pahali = row_data.get('Front_sell_pahalilik_skoru', 'N/A')
                    bid_sell_pahali = row_data.get('Bid_sell_pahalilik_skoru', 'N/A')
                    final_bb = row_data.get('Final_BB_skor', 'N/A')
                    final_fb = row_data.get('Final_FB_skor', 'N/A')
                    final_ab = row_data.get('Final_AB_skor', 'N/A')
                    final_as = row_data.get('Final_AS_skor', 'N/A')
                    final_fs = row_data.get('Final_FS_skor', 'N/A')
                    final_bs = row_data.get('Final_BS_skor', 'N/A')
                    spread = row_data.get('Spread', 'N/A')
                    
                    # Benchmark deƒüerlerini al
                    benchmark_type = row_data.get('Benchmark_Type', 'N/A')
                    benchmark_chg = row_data.get('Benchmark_Chg', 'N/A')
                    
                    # Skor deƒüerlerini formatla
                    def format_score(value):
                        if isinstance(value, (int, float)) and not np.isnan(value):
                            return f"{value:.2f}"
                        return 'N/A'
                    
                    # Se√ßim durumunu kontrol et
                    selection_status = "‚úì" if ticker in selected_items else ""
                    
                    # CSV'den mevcut kolonlarƒ± al (show_file_data'dan available_columns kullan)
                    # Bu satƒ±rlarƒ± kaldƒ±rdƒ±k √ß√ºnk√º available_columns zaten show_file_data'da tanƒ±mlanmƒ±≈ü
                    
                    # Se√ß kolonu ile ba≈üla
                    row_values = [selection_status]
                    
                    # CSV'den belirli kolonlarƒ± ekle (SMA63 chg ve SMA246 chg kolonlarƒ± eklendi)
                    available_columns = [col for col in ['PREF IBKR', 'prev_close', 'CMON', 'CGRUP', 'FINAL_THG', 'AVG_ADV', 'SMI', 'SMA63 chg', 'SMA246 chg', 'SMA 246 CHG', 'SHORT_FINAL'] if col in self.df.columns]
                    
                    # prev_close kolonu kontrol√º (janek_ssfinek dosyalarƒ±nda mevcut olmalƒ±)
                    # Debug mesajlarƒ± kapatƒ±ldƒ± - performans i√ßin
                    # if 'prev_close' not in self.df.columns:
                    #     print(f"[UPDATE_TABLE] ‚ö†Ô∏è prev_close kolonu bulunamadƒ±")
                    # else:
                    #     print(f"[UPDATE_TABLE] ‚úÖ prev_close kolonu bulundu")
                    for col in available_columns:
                        value = row_data.get(col, 'N/A')
                        if isinstance(value, (int, float)) and not np.isnan(value):
                            if col in ['SMI']:
                                value = f"{value:.4f}"
                            elif col in ['prev_close']:
                                value = f"{value:.2f}"
                            else:
                                value = f"{value:.2f}"
                        row_values.append(value)
                    
                    # Skor kolonlarƒ±nƒ± ekle (kendi hesapladƒ±ƒüƒ±mƒ±z)
                    score_columns = [
                        'Bid_buy_ucuzluk_skoru', 'Front_buy_ucuzluk_skoru', 'Ask_buy_ucuzluk_skoru',
                        'Ask_sell_pahalilik_skoru', 'Front_sell_pahalilik_skoru', 'Bid_sell_pahalilik_skoru',
                        'Final_BB_skor', 'Final_FB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor', 'Final_SAS_skor', 'Final_SFS_skor', 'Final_SBS_skor',
                        'Spread', 'Fbtot', 'SFStot'
                    ]
                    
                    for col in score_columns:
                        value = row_data.get(col, 'N/A')
                        if col in ['Fbtot', 'SFStot']:
                            # Fbtot ve SFStot string olarak saklanƒ±yor (√∂rn: "1.2345")
                            if value != 'N/A' and value is not None:
                                try:
                                    # String deƒüeri float'a √ßevir ve formatla
                                    float_value = float(value)
                                    value = f"{float_value:.4f}"
                                except (ValueError, TypeError):
                                    value = 'N/A'
                        elif isinstance(value, (int, float)) and not np.isnan(value):
                            value = f"{value:.2f}"
                        row_values.append(value)
                    
                    # Benchmark kolonlarƒ±nƒ± ekle (kendi hesapladƒ±ƒüƒ±mƒ±z)
                    benchmark_type = row_data.get('Benchmark_Type', 'N/A')
                    benchmark_chg = row_data.get('Benchmark_Chg', 'N/A')
                    if isinstance(benchmark_chg, (int, float)) and not np.isnan(benchmark_chg):
                        benchmark_chg = f"{benchmark_chg:.2f}"
                    row_values.extend([benchmark_type, benchmark_chg])
                    
                    # GORT kolonunu ekle (cache'lenmi≈ü hesaplama)
                    # √ñnce DataFrame'den kontrol et (daha √∂nce hesaplanmƒ±≈ü olabilir)
                    gort_value = None
                    if ticker in self.df['PREF IBKR'].values:
                        ticker_idx = self.df[self.df['PREF IBKR'] == ticker].index[0]
                        if 'GORT' in self.df.columns:
                            existing_gort = self.df.at[ticker_idx, 'GORT']
                            if pd.notna(existing_gort) and existing_gort != 0:
                                gort_value = existing_gort
                    
                    # DataFrame'de yoksa hesapla (cache mekanizmasƒ± i√ßinde)
                    if gort_value is None:
                        gort_value = self.calculate_gort(ticker)
                        # DataFrame'e de kaydet (sƒ±ralama i√ßin)
                        if ticker in self.df['PREF IBKR'].values:
                            ticker_idx = self.df[self.df['PREF IBKR'] == ticker].index[0]
                            self.df.at[ticker_idx, 'GORT'] = gort_value if isinstance(gort_value, (int, float)) and not np.isnan(gort_value) else np.nan
                    
                    if isinstance(gort_value, (int, float)) and not np.isnan(gort_value):
                        gort_value = f"{gort_value:.2f}"
                    else:
                        gort_value = 'N/A'
                    row_values.append(gort_value)
                    
                    # Live kolonlarƒ± ekle (ba≈ülangƒ±√ßta N/A)
                    row_values.extend(['N/A', 'N/A', 'N/A', 'N/A'])  # Bid, Ask, Last, Volume
                except Exception as e:
                    print(f"[HATA] {ticker} i√ßin veri hatasƒ±: {e}")
                    selection_status = "‚úì" if ticker in selected_items else ""
                    # Dinamik olarak kolon sayƒ±sƒ±nƒ± hesapla
                    total_columns = len(self.columns) - 1  # 'Se√ß' kolonunu √ßƒ±kar
                    row_values = [selection_status] + [ticker] + ['N/A'] * (total_columns - 1)
                
                # Satƒ±rƒ± ekle
                self.table.insert('', 'end', values=row_values)
            
            # G√∂r√ºn√ºr ticker'larƒ± kaydet
            self._last_visible_tickers = visible_tickers
            
            # Stock Data Manager'ƒ± g√ºncelle - Ana tablo verilerini kaydet
            if not self.df.empty:
                self.stock_data_manager.update_stock_data_from_main_table(self.df, self.columns)
        
        # Sadece live data kolonlarƒ±nƒ± g√ºncelle (se√ßimleri koruyarak)
        for item in self.table.get_children():
            ticker = self.table.set(item, 'PREF IBKR')
            if ticker in visible_tickers:
                try:
                    # Hammer Pro'dan live verileri al
                    market_data = self.hammer.get_market_data(ticker)
                    if not market_data:
                        continue
                        
                    bid_raw = market_data.get('bid', 0)
                    ask_raw = market_data.get('ask', 0)
                    last_raw = market_data.get('last', 0)
                    volume_raw = market_data.get('volume', 0)
                    is_live = market_data.get('is_live', False)
                    

                    
                    # Format deƒüerleri (0 ise N/A)
                    bid = f"{bid_raw:.2f}" if bid_raw > 0 else "N/A"
                    ask = f"{ask_raw:.2f}" if ask_raw > 0 else "N/A"
                    last = f"{last_raw:.2f}" if last_raw > 0 else "N/A"
                    volume = f"{int(volume_raw):,}" if volume_raw > 0 else "N/A"
                    
                    # Live kolonlarƒ± g√ºncelle
                    self.table.set(item, 'Bid', bid)
                    self.table.set(item, 'Ask', ask)
                    self.table.set(item, 'Last', last)
                    self.table.set(item, 'Volume', volume)
                    
                    # SKORLARI GER√áEK VERƒ∞LERLE HESAPLA!
                    if bid_raw > 0 and ask_raw > 0 and last_raw > 0:
                        # CSV'den row verisini al
                        csv_row = self.df[self.df['PREF IBKR'] == ticker]
                        if not csv_row.empty:
                            row_data = csv_row.iloc[0]
                            prev_close = market_data.get('prevClose', 0)
                            
                            # PREFERRED STOCK'LAR ƒ∞√áƒ∞N SNAPSHOT TAMAMEN KALDIRILDI!
                            # Sadece streaming veri kullanƒ±lacak
                            if " PR" in ticker:
                                # print(f"[SKOR] üö´ SNAPSHOT KALDIRILDI: {ticker} - Sadece streaming kullanƒ±lacak!")
                                pass
                            
                            # Benchmark tipini ve deƒüi≈üimini hesapla
                            benchmark_type = self.get_benchmark_type_for_ticker(ticker)
                            benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                            
                            # Benchmark bilgilerini tabloya yaz
                            if 'Benchmark_Type' in self.columns:
                                self.table.set(item, 'Benchmark_Type', benchmark_type)
                            if 'Benchmark_Chg' in self.columns:
                                self.table.set(item, 'Benchmark_Chg', f"{benchmark_chg:.4f}")
                            
                            # SKORLARI TEKRAR HESAPLAMA KALDIRILDI! DataFrame'de zaten doƒüru deƒüerler var
                            # from .update_janalldata_with_scores import calculate_scores
                            # scores = calculate_scores(row_data, bid_raw, ask_raw, last_raw, prev_close, benchmark_chg)
                            
                            # T√úM SKORLARI DataFrame'den al (zaten doƒüru hesaplanmƒ±≈ü)
                            all_scores = {
                                'Bid_buy_ucuzluk_skoru': row_data.get('Bid_buy_ucuzluk_skoru', 'N/A'),
                                'Front_buy_ucuzluk_skoru': row_data.get('Front_buy_ucuzluk_skoru', 'N/A'),
                                'Ask_buy_ucuzluk_skoru': row_data.get('Ask_buy_ucuzluk_skoru', 'N/A'),
                                'Ask_sell_pahalilik_skoru': row_data.get('Ask_sell_pahalilik_skoru', 'N/A'),
                                'Front_sell_pahalilik_skoru': row_data.get('Front_sell_pahalilik_skoru', 'N/A'),
                                'Bid_sell_pahalilik_skoru': row_data.get('Bid_sell_pahalilik_skoru', 'N/A'),
                                'Final_BB_skor': row_data.get('Final_BB_skor', 'N/A'),
                                'Final_FB_skor': row_data.get('Final_FB_skor', 'N/A'),
                                'Final_AB_skor': row_data.get('Final_AB_skor', 'N/A'),
                                'Final_AS_skor': row_data.get('Final_AS_skor', 'N/A'),
                                'Final_FS_skor': row_data.get('Final_FS_skor', 'N/A'),
                                'Final_BS_skor': row_data.get('Final_BS_skor', 'N/A'),
                                'Final_SAS_skor': row_data.get('Final_SAS_skor', 'N/A'),
                                'Final_SFS_skor': row_data.get('Final_SFS_skor', 'N/A'),
                                'Final_SBS_skor': row_data.get('Final_SBS_skor', 'N/A'),
                                'Spread': row_data.get('Spread', 'N/A')
                            }
                            
                            # Debug: DataFrame'den alƒ±nan deƒüerleri g√∂ster
                            if ticker in ['AHL PRE', 'AHL PRD', 'ATH PRD']:
                                # print(f"[DATAFRAME_READ] {ticker}: Final_BB_skor={all_scores['Final_BB_skor']}, Final_SAS_skor={all_scores['Final_SAS_skor']}")
                                pass
                            
                            # T√úM SKORLARI tabloya yaz (DataFrame'den alƒ±nan deƒüerler)
                            for score_name, score_value in all_scores.items():
                                if score_name in self.columns:
                                    if isinstance(score_value, (int, float)) and not np.isnan(score_value):
                                        self.table.set(item, score_name, f"{score_value:.2f}")
                                    else:
                                        self.table.set(item, score_name, 'N/A')
                            

                    
                    # Live data satƒ±rlarƒ±nƒ± ye≈üil yap
                    if is_live:
                        self.table.item(item, tags=('live_data',))
                    else:
                        self.table.item(item, tags=())
                        
                except Exception as e:
                    print(f"[HATA] {ticker} i√ßin live data g√ºncelleme hatasƒ±: {e}")
        
        # Live data satƒ±rlarƒ±nƒ± ye≈üil yap
        self.table.tag_configure('live_data', background='lightgreen')
        
        # Sayfa bilgisini g√ºncelle
        self.lbl_page.config(text=f"Sayfa {self.current_page + 1} / {self.total_pages}")
        
    def prev_page(self):
        if self.current_page > 0:
            self.current_page -= 1
            self.update_table()
            
    def next_page(self):
        if self.current_page < self.total_pages - 1:
            self.current_page += 1
            self.update_table()
            
    def on_double_click(self, event):
        """Tabloda √ßift tƒ±klanan satƒ±r i√ßin OrderBook penceresini a√ß"""
        try:
            # Tƒ±klanan konumu kontrol et
            item_id = self.table.identify('item', event.x, event.y)
            if not item_id:  # Tablo dƒ±≈üƒ±na tƒ±klandƒ±
                return
                
            # Tƒ±klanan satƒ±rƒ± se√ß
            self.table.selection_set(item_id)
            
            # Se√ßili satƒ±rƒ± al
            selection = self.table.selection()
            if not selection:  # Se√ßili satƒ±r yoksa
                return
                
            item = selection[0]
            # Se√ßilen satƒ±rƒ±n verilerini al
            values = self.table.item(item)['values']
            if not values:
                return
                
            # ƒ∞lk kolon PREF IBKR
            symbol = values[1]  # Se√ß kolonu sonrasƒ± PREF IBKR
            
            # OrderBook penceresini a√ß (order butonlarƒ± ile)
            OrderBookWindow(self, symbol, self.hammer)
            
        except Exception as e:
            print(f"[HATA] OrderBook a√ßƒ±lƒ±rken hata: {e}")
        
    def on_table_click(self, event):
        """Tabloya tƒ±klanan satƒ±rƒ±n se√ßim durumunu deƒüi≈ütir"""
        try:
            # Tƒ±klanan konumu kontrol et
            region = self.table.identify_region(event.x, event.y)
            if region != "cell":
                return
                
            # Tƒ±klanan kolonu kontrol et
            column = self.table.identify_column(event.x)
            if column != "#1":  # Sadece Se√ß kolonuna tƒ±klandƒ±ƒüƒ±nda i≈ülem yap
                return
                
            # Tƒ±klanan satƒ±rƒ± bul
            item_id = self.table.identify('item', event.x, event.y)
            if not item_id:  # Tablo dƒ±≈üƒ±na tƒ±klandƒ±
                return
                
            # Se√ßim durumunu deƒüi≈ütir
            current = self.table.set(item_id, "Se√ß")
            new_value = "‚úì" if current != "‚úì" else ""
            self.table.set(item_id, "Se√ß", new_value)
            
            # Debug i√ßin yazdƒ±r
            ticker = self.table.set(item_id, "PREF IBKR")
            print(f"‚úÖ {ticker} {'se√ßildi' if new_value == '‚úì' else 'se√ßimi kaldƒ±rƒ±ldƒ±'}")
            
        except Exception as e:
            print(f"[HATA] Tabloya tƒ±klanan satƒ±r se√ßimi hatasƒ±: {e}")
        
    def show_file_data(self, filename, is_main=False):
        """Se√ßilen CSV dosyasƒ±ndaki verileri g√∂ster"""
        try:
            # CSV'yi oku
            df = pd.read_csv(filename)
            
            # SRPAN i√ßin mevcut grubu kaydet
            self.srpan_current_group = filename.replace('janek_ssfinek', '').replace('.csv', '')
            self.srpan_current_data = df.copy()
            
            # Pressure Analiz i√ßin de aynƒ± veriyi kaydet
            if 'janek_ssfinek' in filename:
                self.pressure_current_group = filename.replace('janek_ssfinek', '').replace('.csv', '')
                self.pressure_current_data = df.copy()
            
            # CSV'den sadece belirli kolonlarƒ± al - SMA63 chg ve SMA246 chg kolonlarƒ± eklendi
            csv_columns_to_show = ['PREF IBKR', 'prev_close', 'CMON', 'CGRUP', 'FINAL_THG', 'AVG_ADV', 'SMI', 'SMA63 chg', 'SMA246 chg', 'SMA 246 CHG', 'SHORT_FINAL']
            
            # Sadece mevcut kolonlarƒ± al (yoksa hata vermesin)
            available_columns = [col for col in csv_columns_to_show if col in df.columns]
            
            # prev_close kolonu kontrol√º (janek_ssfinek dosyalarƒ±nda mevcut olmalƒ±)
            # Debug mesajlarƒ± kapatƒ±ldƒ± - performans i√ßin
            # if 'prev_close' not in df.columns:
            #     print(f"[CSV] ‚ö†Ô∏è prev_close kolonu bulunamadƒ±: {filename}")
            # else:
            #     print(f"[CSV] OK prev_close kolonu bulundu: {filename}")
            
            # Skor kolonlarƒ± (kendi hesapladƒ±ƒüƒ±mƒ±z)
            score_columns = [
                'Bid_buy_ucuzluk_skoru', 'Front_buy_ucuzluk_skoru', 'Ask_buy_ucuzluk_skoru',
                'Ask_sell_pahalilik_skoru', 'Front_sell_pahalilik_skoru', 'Bid_sell_pahalilik_skoru',
                'Final_BB_skor', 'Final_FB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor', 'Final_SAS_skor', 'Final_SFS_skor', 'Final_SBS_skor',
                'Spread', 'Fbtot', 'SFStot'
            ]
            
            # Benchmark kolonlarƒ± (kendi hesapladƒ±ƒüƒ±mƒ±z)
            benchmark_columns = ['Benchmark_Type', 'Benchmark_Chg']
            
            # GORT kolonu (hesaplanacak)
            gort_columns = ['GORT']
            
            # Live kolonlarƒ± (Hammer Pro'dan)
            live_columns = ['Bid', 'Ask', 'Last', 'Volume']
            
            # Toplam kolon sƒ±rasƒ±
            self.columns = ['Se√ß'] + available_columns + score_columns + benchmark_columns + gort_columns + live_columns
            
            # Tabloyu yeniden olu≈ütur
            self.table.destroy()
            self.table = ttk.Treeview(self, columns=self.columns, show='headings', height=15)
            
            # √áift tƒ±klama olayƒ±nƒ± baƒüla
            self.table.bind('<Double-1>', self.on_double_click)
            
            # Checkbox tƒ±klama olayƒ±nƒ± baƒüla - sadece Se√ß kolonu i√ßin
            self.table.bind('<ButtonRelease-1>', self.on_table_click)
            
            # Kolon ba≈ülƒ±klarƒ± ve geni≈ülikleri
            for col in self.columns:
                # Sƒ±ralama fonksiyonunu baƒüla
                self.table.heading(col, 
                    text=col,
                    command=lambda c=col: self.sort_by_column(c))
                    
                if col in ['PREF IBKR']:
                    self.table.column(col, width=35, anchor='w')  # Sol hizalƒ± - √ßok dar
                elif col in ['prev_close']:
                    self.table.column(col, width=25, anchor='center')  # prev_close i√ßin orta geni≈ülik
                elif col in ['CMON', 'CGRUP']:
                    self.table.column(col, width=15, anchor='center')  # En dar
                elif col in ['SMI', 'SMA63 chg', 'SMA246 chg', 'SMA 246 CHG', 'SHORT_FINAL', 'GORT']:
                    self.table.column(col, width=20, anchor='center')  # Dar
                elif col in ['FINAL_THG', 'AVG_ADV']:
                    self.table.column(col, width=25, anchor='center')  # Orta
                elif 'skor' in col.lower() or 'final' in col.lower():
                    self.table.column(col, width=30, anchor='center')  # Skor kolonlarƒ± - √ßok dar
                elif 'benchmark' in col.lower():
                    self.table.column(col, width=20, anchor='center') # Benchmark kolonlarƒ± - orta
                else:
                    self.table.column(col, width=20, anchor='center')  # Normal - √ßok dar
                    
            self.table.pack(fill='both', expand=True, padx=5, pady=5)
            
            # Tabloyu temizle
            for item in self.table.get_children():
                self.table.delete(item)
                
            # Ticker'larƒ± al
            self.tickers = df['PREF IBKR'].tolist()
            
            # Sayfalama ayarlarƒ±nƒ± g√ºncelle
            self.current_page = 0
            self.total_pages = (len(self.tickers) + self.items_per_page - 1) // self.items_per_page
            
            # Yeni verileri g√∂ster
            self.df = df
            
            # BGGG kolonunu temizle (normal mini450'de BGGG kolonu olmamalƒ±)
            if 'BGGG AYRISMA' in self.df.columns:
                self.df = self.df.drop(columns=['BGGG AYRISMA'])
                print(f"[MINI450] üßπ BGGG AYRISMA kolonu temizlendi (normal mini450 modu)")
            
            # Live data i√ßin t√ºm sembollere subscribe ol
            if is_main:
                print("\n[HAMMER] üîÑ T√ºm sembollere subscribe olunuyor...")
                for ticker in self.tickers:
                    self.hammer.subscribe_symbol(ticker)
            
            # T√úM PENCERELERDE SKORLARI HESAPLA! (Ana pencere ve grup pencereleri)
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[CSV] üîÑ {filename}: Skorlar hesaplanƒ±yor...")
            
            # √ñnce skorlarƒ± hesapla
            self.calculate_scores_for_all_stocks()
            
            # ≈ûimdi DataFrame'e skor kolonlarƒ±nƒ± ekle
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[CSV] üîÑ {filename}: DataFrame'e skor kolonlarƒ± ekleniyor...")
            
            # Skor kolonlarƒ±
            score_columns = [
                'Bid_buy_ucuzluk_skoru', 'Front_buy_ucuzluk_skoru', 'Ask_buy_ucuzluk_skoru',
                'Ask_sell_pahalilik_skoru', 'Front_sell_pahalilik_skoru', 'Bid_sell_pahalilik_skoru',
                'Final_BB_skor', 'Final_FB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor', 'Final_SAS_skor', 'Final_SFS_skor', 'Final_SBS_skor',
                'Spread'
            ]
            
            # Her hisse i√ßin skorlarƒ± hesapla ve DataFrame'e ekle
            for index, row in self.df.iterrows():
                ticker = row['PREF IBKR']
                
                # Hammer'dan live verileri al
                market_data = self.hammer.get_market_data(ticker) if hasattr(self, 'hammer') and self.hammer else None
                if market_data:
                    bid_raw = float(market_data.get('bid', 0))
                    ask_raw = float(market_data.get('ask', 0))
                    last_raw = float(market_data.get('last', 0))
                    prev_close = float(market_data.get('prevClose', 0))
                    
                    # Benchmark deƒüi≈üimini hesapla
                    benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                    
                    # Skorlarƒ± hesapla - DOƒûRU FONKSƒ∞YONU KULLAN!
                    scores = self.calculate_scores(ticker, row, bid_raw, ask_raw, last_raw, prev_close, benchmark_chg)
                    
                    # DataFrame'e skorlarƒ± yaz
                    if scores:
                        for score_name, score_value in scores.items():
                            if score_name in score_columns:
                                self.df.at[index, score_name] = score_value
                
                # GORT deƒüerini hesapla ve DataFrame'e ekle
                gort_value = self.calculate_gort(ticker)
                self.df.at[index, 'GORT'] = gort_value if isinstance(gort_value, (int, float)) and not np.isnan(gort_value) else np.nan
            
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[CSV] ‚úÖ {filename}: Skorlar hesaplandƒ± ve DataFrame'e eklendi")
            
            # Mini450 i√ßin Fbtot ve SFStot hesapla (skorlar DataFrame'e yazƒ±ldƒ±ktan SONRA)
            if self.is_mini450_active:
                # Fbtot ve SFStot kolonlarƒ±nƒ± ba≈ülat (yoksa)
                if 'Fbtot' not in self.df.columns:
                    self.df['Fbtot'] = 'N/A'
                if 'SFStot' not in self.df.columns:
                    self.df['SFStot'] = 'N/A'
                
                # Debug: Skor kolonlarƒ±nƒ± kontrol et
                if 'Final_FB_skor' in self.df.columns:
                    fb_count = self.df['Final_FB_skor'].notna().sum()
                    fb_positive = (pd.to_numeric(self.df['Final_FB_skor'], errors='coerce') > 0).sum()
                    print(f"üîç Debug: Final_FB_skor - Toplam: {len(self.df)}, Not NA: {fb_count}, > 0: {fb_positive}")
                else:
                    print("‚ö†Ô∏è Debug: Final_FB_skor kolonu yok!")
                
                if 'Final_SFS_skor' in self.df.columns:
                    sfs_count = self.df['Final_SFS_skor'].notna().sum()
                    sfs_positive = (pd.to_numeric(self.df['Final_SFS_skor'], errors='coerce') > 0).sum()
                    print(f"üîç Debug: Final_SFS_skor - Toplam: {len(self.df)}, Not NA: {sfs_count}, > 0: {sfs_positive}")
                else:
                    print("‚ö†Ô∏è Debug: Final_SFS_skor kolonu yok!")
                
                print("üîÑ Mini450: Skorlar DataFrame'e yazƒ±ldƒ±, ≈üimdi Fbtot ve SFStot hesaplanƒ±yor...")
                self.df = self.calculate_fbtot_sfstot_for_mini450(self.df)
                df = self.df  # G√ºncellenmi≈ü df'yi kullan
                
                # Debug: Hesaplanan deƒüerleri kontrol et
                fbtot_count = (self.df['Fbtot'] != 'N/A').sum()
                sfstot_count = (self.df['SFStot'] != 'N/A').sum()
                print(f"üîç Debug: Hesaplama sonrasƒ± - Fbtot != N/A: {fbtot_count}/{len(self.df)}, SFStot != N/A: {sfstot_count}/{len(self.df)}")
                    
            # Sƒ±ralama sƒ±fƒ±rla
            self.sort_column = None
            self.sort_ascending = True
            
            # _last_visible_tickers'ƒ± sƒ±fƒ±rla (yeni dosya y√ºklendiƒüinde tablo yeniden √ßizilsin)
            if hasattr(self, '_last_visible_tickers'):
                delattr(self, '_last_visible_tickers')
                
            self.update_table()
            
            # Ba≈ülƒ±ƒüƒ± g√ºncelle
            if is_main:
                self.title("JanAll - T√ºm Veriler")
            else:
                short_name = filename.replace('ssfinek', '').replace('.csv', '')
                self.title(f"JanAll - {short_name}")
                
            # Debug mesajlarƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[CSV] ‚úÖ {filename} y√ºklendi")
            # print(f"[CSV] ‚ÑπÔ∏è {len(df)} satƒ±r")
            # print(f"[CSV] üìã Mevcut Kolonlar: {', '.join(available_columns)}")
            # print(f"[CSV] üìã Toplam Kolon Sayƒ±sƒ±: {len(self.columns)}")
            
            # Stock Data Manager'ƒ± CSV verileri ile g√ºncelle
            self.stock_data_manager.update_stock_data_from_csv(filename, df)
            
        except Exception as e:
                print(f"[CSV] ERROR Dosya okuma hatasi ({filename}): {e}")
    
    def get_prev_close_for_symbol(self, symbol: str) -> float:
        """Symbol i√ßin prev close deƒüerini d√∂nd√ºr - cache'den oku"""
        try:
            # Cache'den kontrol et
            if hasattr(self, 'prev_close_cache') and symbol in self.prev_close_cache:
                value = float(self.prev_close_cache[symbol])
                # print(f"[PREV CLOSE] ‚úì {symbol}: cache'den prev_close={value}")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
                return value
            
            # ETF Panel'den al
            if hasattr(self, 'etf_panel') and self.etf_panel:
                if symbol in self.etf_panel.etf_prev_close_data:
                    value = float(self.etf_panel.etf_prev_close_data[symbol])
                    # print(f"[PREV CLOSE] ‚úì {symbol}: ETF panel'den prev_close={value}")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
                    return value
            
            # print(f"[PREV CLOSE] ‚ùå {symbol}: prev_close cache'de bulunamadƒ±")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
            # if hasattr(self, 'prev_close_cache'):
            #     print(f"[PREV CLOSE] üìã Cache'deki ticker'lar: {list(self.prev_close_cache.keys())[:10]}...")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
            # else:
            #     print(f"[PREV CLOSE] üìã Cache bo≈ü!")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
            return 0.0
            
        except Exception as e:
            # print(f"[PREV CLOSE] ‚ùå {symbol} genel hata: {e}")  # Debug mesajƒ± kaldƒ±rƒ±ldƒ±
            return 0.0
    
    def get_last_price_for_symbol(self, symbol: str) -> float:
        """Symbol i√ßin son fiyatƒ± d√∂nd√ºr - PREF IBKR formatƒ±nƒ± Hammer Pro formatƒ±na √ßevirerek"""
        try:
            # PREF IBKR formatƒ±nƒ± Hammer Pro formatƒ±na √ßevir
            from .myjdata import get_hammer_symbol_from_pref_ibkr
            hammer_symbol = get_hammer_symbol_from_pref_ibkr(symbol)
            
            # Hammer Pro'dan market data al
            if hasattr(self, 'hammer') and self.hammer:
                market_data = self.hammer.get_market_data(hammer_symbol)
                if market_data and 'last' in market_data:
                    last_price = float(market_data['last'])
                    return last_price
        
            # ETF Panel'den al
            if hasattr(self, 'etf_panel') and self.etf_panel:
                if symbol in self.etf_panel.etf_data:
                    last_price = float(self.etf_panel.etf_data[symbol].get('last', 0))
                    return last_price
        
            return 0.0
        except Exception as e:
            print(f"[MAIN] ‚ùå {symbol} fiyat alma hatasƒ±: {e}")
            return 0.0
    
    def get_final_thg_for_symbol(self, symbol: str) -> float:
        """Symbol i√ßin FINAL_THG deƒüerini d√∂nd√ºr - janek_ss dosyalarƒ±ndan oku"""
        try:
            # √ñnce cache'den kontrol et
            if hasattr(self, 'final_thg_data') and symbol in self.final_thg_data:
                return float(self.final_thg_data[symbol])
            
            # janek_ss dosyalarƒ±ndan oku
            import glob
            import pandas as pd
            
            # T√ºm janek_ss dosyalarƒ±nƒ± bul (ana dizinde)
            janek_files = glob.glob('janek_ss*.csv')
            
            for janek_file in janek_files:
                try:
                    # Dosyayƒ± oku
                    df = pd.read_csv(janek_file, encoding='utf-8-sig')
                    
                    # PREF IBKR ve FINAL_THG kolonlarƒ± var mƒ± kontrol et
                    if 'PREF IBKR' in df.columns and 'FINAL_THG' in df.columns:
                        # Symbol'√º bul
                        row = df[df['PREF IBKR'] == symbol]
                        if not row.empty:
                            final_thg = row['FINAL_THG'].iloc[0]
                            if pd.notna(final_thg):
                                # Cache'e kaydet
                                if not hasattr(self, 'final_thg_data'):
                                    self.final_thg_data = {}
                                self.final_thg_data[symbol] = float(final_thg)
                                print(f"[FINAL_THG] ‚úì {symbol}: {final_thg} ({janek_file})")
                                return float(final_thg)
                except Exception as e:
                    print(f"[FINAL_THG] ‚ö†Ô∏è {janek_file} okuma hatasƒ±: {e}")
                    continue
            
            print(f"[FINAL_THG] ‚ùå {symbol}: FINAL_THG bulunamadƒ±")
            return 0.0
            
        except Exception as e:
            print(f"[FINAL_THG] ‚ùå {symbol} genel hata: {e}")
            return 0.0
    
    def top_ten_bid_buy(self):
        """Top Ten Bid Buy - En y√ºksek Final_BB_skorlu %10 hisse i√ßin bid buy emirleri"""
        try:
            print("[TOP TEN] üîÑ Top Ten Bid Buy ba≈ülatƒ±lƒ±yor...")
            
            # CSV dosyasƒ±nƒ± sƒ±fƒ±rla (yeni i≈ülem ba≈ülƒ±yor)
            self.reset_pref_csv()
            
            # T√ºm skorlarƒ± hesapla
            self.calculate_scores_for_all_stocks()
            
            # Grup dosyalarƒ± (belirtilen sƒ±rayla)
            groups = ['helddeznff', 'heldff', 'heldflr', 'heldgarabetaltiyedi', 'heldkuponlu', 
                     'heldkuponlukreciliz', 'heldkuponlukreorta', 'heldnff', 'heldotelremorta', 
                     'heldsolidbig', 'heldtitrekhc', 'highmatur', 'notcefilliquid', 'nottitrekhc', 'shitremhc']
            
            for group in groups:
                try:
                    print(f"[TOP TEN] üîÑ {group} grubu i≈üleniyor...")
                    
                    # GRUP BUTONUNA BASTIƒûINDA A√áILAN PENCEREDEKƒ∞ DATAFRAME'ƒ∞ BUL
                    group_window = self.find_group_window(group)
                    if group_window and hasattr(group_window, 'df'):
                        group_df = group_window.df  # A√ßƒ±lan penceredeki DataFrame
                        print(f"[TOP TEN] üìã {group}: A√ßƒ±lan penceredeki DataFrame'de {len(group_df)} hisse var")
                        
                        # Debug: A√ßƒ±lan penceredeki DataFrame'in ilk birka√ß hissesini g√∂ster
                        if len(group_df) > 0:
                            first_tickers = group_df['PREF IBKR'].head(5).tolist()
                            print(f"[DEBUG] A√ßƒ±lan penceredeki DataFrame'de ilk 5 hisse: {first_tickers}")
                            
                            # Debug: A√ßƒ±lan penceredeki DataFrame'de skor kolonlarƒ± var mƒ± kontrol et
                            if 'Final_BB_skor' in group_df.columns:
                                print(f"[DEBUG] ‚úÖ A√ßƒ±lan penceredeki DataFrame'de Final_BB_skor kolonu var")
                                # ƒ∞lk birka√ß hissenin skorlarƒ±nƒ± g√∂ster
                                for ticker in first_tickers[:3]:
                                    if ticker in group_df['PREF IBKR'].values:
                                        row = group_df[group_df['PREF IBKR'] == ticker].iloc[0]
                                        score = row.get('Final_BB_skor', 'N/A')
                                        print(f"[DEBUG] {ticker}: Final_BB_skor = {score}")
                            else:
                                print(f"[DEBUG] ‚ùå A√ßƒ±lan penceredeki DataFrame'de Final_BB_skor kolonu yok!")
                                print(f"[DEBUG] Mevcut kolonlar: {list(group_df.columns)}")
                                
                                # Skorlar yoksa hesapla!
                                print(f"[DEBUG] üîÑ {group} penceresinde skorlar hesaplanƒ±yor...")
                                group_window.calculate_scores_for_all_stocks()
                                print(f"[DEBUG] ‚úÖ {group} penceresinde skorlar hesaplandƒ±")
                                
                                # ≈ûimdi tekrar kontrol et
                                if 'Final_BB_skor' in group_df.columns:
                                    print(f"[DEBUG] ‚úÖ Artƒ±k Final_BB_skor kolonu var!")
                                else:
                                    print(f"[DEBUG] ‚ùå Hala Final_BB_skor kolonu yok!")
                    else:
                        print(f"[TOP TEN] ‚ö†Ô∏è {group}: A√ßƒ±lan pencere bulunamadƒ±, butona tƒ±klanƒ±yor...")
                        
                        # GRUP BUTONUNU BUL VE TIKLA!
                        group_button = self.find_group_button(group)
                        if group_button:
                            print(f"[TOP TEN] üîò {group} butonu bulundu, tƒ±klanƒ±yor...")
                            group_button.invoke()  # Butona tƒ±kla
                            
                            # Pencere a√ßƒ±lsƒ±n
                            import time
                            time.sleep(1)
                            
                            # ≈ûimdi tekrar pencereyi bul
                            print(f"[TOP TEN] üîç {group} penceresi tekrar aranƒ±yor...")
                            group_window = self.find_group_window(group)
                            if group_window and hasattr(group_window, 'df'):
                                group_df = group_window.df
                                print(f"[TOP TEN] ‚úÖ {group}: Pencere a√ßƒ±ldƒ± ve bulundu! {len(group_df)} hisse")
                            else:
                                print(f"[TOP TEN] ‚ùå {group}: Pencere hala bulunamadƒ±, ana DataFrame kullanƒ±lƒ±yor")
                                group_df = self.df
                        else:
                            print(f"[TOP TEN] ‚ùå {group} butonu bulunamadƒ±, ana DataFrame kullanƒ±lƒ±yor")
                            group_df = self.df
                        
                        # Debug: Ana DataFrame'deki ilk birka√ß hisseyi g√∂ster
                        if len(group_df) > 0:
                            first_tickers = group_df['PREF IBKR'].head(5).tolist()
                            print(f"[DEBUG] Ana DataFrame'de ilk 5 hisse: {first_tickers}")
                            
                            # Debug: Ana DataFrame'de skor kolonlarƒ± var mƒ± kontrol et
                            if 'Final_BB_skor' in group_df.columns:
                                print(f"[DEBUG] ‚úÖ Ana DataFrame'de Final_BB_skor kolonu var")
                            else:
                                print(f"[DEBUG] ‚ùå Ana DataFrame'de Final_BB_skor kolonu yok!")
                        
                        # Debug: Ana DataFrame'de hangi kolonlar var kontrol et
                        print(f"[DEBUG] Ana DataFrame'deki kolonlar: {list(group_df.columns)}")
                    
                    # T√úM SAYFALARI TARA - SADECE ƒ∞LK SAYFA DEƒûƒ∞L!
                    print(f"[TOP TEN] üîç {group}: T√ºm sayfalar taranƒ±yor...")
                    
                    # Toplam sayfa sayƒ±sƒ±nƒ± al
                    total_pages = getattr(group_window, 'total_pages', 1)
                    print(f"[TOP TEN] üìÑ {group}: Toplam {total_pages} sayfa bulundu")
                    
                    # T√ºm sayfalardaki hisseleri topla
                    all_group_stocks = []
                    
                    for page in range(total_pages):
                        print(f"[TOP TEN] üìÑ {group}: Sayfa {page + 1}/{total_pages} taranƒ±yor...")
                        
                        # Sayfayƒ± deƒüi≈ütir
                        if hasattr(group_window, 'go_to_page'):
                            group_window.go_to_page(page)
                            # Sayfa deƒüi≈üince biraz bekle
                            import time
                            time.sleep(1)
                        
                        # Bu sayfadaki hisseleri al
                        current_page_df = group_window.df if hasattr(group_window, 'df') else group_df
                        
                        for index, row in current_page_df.iterrows():
                            ticker = row['PREF IBKR']
                            
                            # SKORU KENDƒ∞Mƒ∞Z HESAPLAYALIM - DATAFRAME'DEN OKUMAYALIM!
                            print(f"[DEBUG] {ticker}: Skor hesaplanƒ±yor...")
                            
                            # Market data al
                            market_data = self.hammer.get_market_data(ticker) if hasattr(self, 'hammer') and self.hammer else None
                            if market_data:
                                bid_raw = float(market_data.get('bid', 0))
                                ask_raw = float(market_data.get('ask', 0))
                                last_raw = float(market_data.get('last', 0))
                                prev_close = float(market_data.get('prevClose', 0))
                                
                                # Benchmark deƒüi≈üimini hesapla
                                benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                                
                                # Skorlarƒ± hesapla - DOƒûRU FONKSƒ∞YONU KULLAN!
                                scores = self.calculate_scores(ticker, row, bid_raw, ask_raw, last_raw, prev_close, benchmark_chg)
                                
                                if scores and 'Final_BB_skor' in scores:
                                    final_bb_skor = scores['Final_BB_skor']
                                    print(f"[DEBUG] {ticker}: Hesaplanan Final_BB_skor={final_bb_skor}")
                                else:
                                    print(f"[DEBUG] {ticker}: Skor hesaplanamadƒ±")
                                    final_bb_skor = 0
                            else:
                                print(f"[DEBUG] {ticker}: Market data alƒ±namadƒ±")
                                final_bb_skor = 0
                            
                            all_group_stocks.append({
                                'symbol': ticker,
                                'Final_BB_skor': final_bb_skor
                            })
                            print(f"[DEBUG] {ticker}: Sayfa {page + 1}'den Final_BB_skor={final_bb_skor}")
                    
                    print(f"[TOP TEN] üìä {group}: T√ºm sayfalardan toplam {len(all_group_stocks)} hisse bulundu")
                    
                    # Duplicate hisseleri kaldƒ±r
                    group_stocks = []
                    seen_symbols = set()
                    for stock in all_group_stocks:
                        if stock['symbol'] not in seen_symbols:
                            group_stocks.append(stock)
                            seen_symbols.add(stock['symbol'])
                    
                    print(f"[TOP TEN] üìä {group}: Unique {len(group_stocks)} hisse (duplicate'ler kaldƒ±rƒ±ldƒ±)")
                    
                    if len(group_stocks) == 0:
                        print(f"[TOP TEN] ‚ö†Ô∏è {group}: Uygun hisse bulunamadƒ±")
                        continue
                    
                    if len(group_stocks) == 0:
                        print(f"[TOP TEN] ‚ö†Ô∏è {group}: Uygun hisse bulunamadƒ±")
                        continue
                    
                    # En y√ºksek %10'u se√ß (min 1, max 8)
                    total_stocks = len(group_stocks)
                    select_count = max(1, min(8, round(total_stocks * 0.1)))
                    
                    # Final_BB_skor'a g√∂re sƒ±rala (y√ºksekten d√º≈ü√ºƒüe)
                    group_stocks.sort(key=lambda x: x['Final_BB_skor'], reverse=True)
                    top_stocks = group_stocks[:select_count]
                    
                    if len(top_stocks) == 0:
                        print(f"[TOP TEN] ‚ö†Ô∏è {group}: Uygun hisse bulunamadƒ±")
                        continue
                    
                    print(f"[TOP TEN] ‚úÖ {group}: {len(top_stocks)} hisse se√ßildi (top %10)")
                    
                    # Onay penceresi a√ß
                    symbols = [stock['symbol'] for stock in top_stocks]
                    scores = [stock['Final_BB_skor'] for stock in top_stocks]
                    
                    # Onay penceresi a√ß ve kullanƒ±cƒ±nƒ±n yanƒ±tƒ±nƒ± bekle
                    confirmation_win = self.show_order_confirmation(
                        title=f"Top Ten Bid Buy - {group}",
                        symbols=symbols,
                        scores=scores,
                        order_type="bid_buy",
                        group=group
                    )
                    
                    # Pencere kapanana kadar bekle
                    if confirmation_win:
                        confirmation_win.wait_window()
                        print(f"[TOP TEN] ‚úÖ {group}: Onay penceresi kapandƒ±")
                    else:
                        print(f"[TOP TEN] ‚ùå {group}: Onay penceresi a√ßƒ±lamadƒ±!")
                    
                except Exception as e:
                    print(f"[TOP TEN] ‚ùå {group} hatasƒ±: {e}")
                    continue
                    
        except Exception as e:
            print(f"[TOP TEN] ‚ùå Genel hata: {e}")
    
    def find_group_button(self, group):
        """Grup butonunu bul"""
        try:
            # files_frame'i bul
            files_frame = None
            for widget in self.winfo_children():
                if hasattr(widget, 'winfo_children'):
                    for child in widget.winfo_children():
                        if hasattr(child, 'winfo_children'):
                            for grandchild in child.winfo_children():
                                if hasattr(grandchild, 'cget'):
                                    try:
                                        text = grandchild.cget('text')
                                        if text and group.lower() in text.lower():
                                            return grandchild
                                    except:
                                        continue
            return None
        except Exception as e:
            print(f"[TOP TEN] ‚ùå Buton arama hatasƒ±: {e}")
            return None
    
    def find_group_window(self, group):
        """Grup penceresini bul - T√ºm a√ßƒ±k pencereleri tara"""
        try:
            print(f"[DEBUG] {group} grubu i√ßin pencere aranƒ±yor...")
            
            # T√úM A√áIK PENCERELERƒ∞ BUL - FARKLI Y√ñNTEMLER DENE
            import tkinter as tk
            
            # 1. Y√ñNTEM: Ana penceredeki t√ºm child widget'larƒ± tara
            all_windows = []
            
            # Ana pencereyi ekle
            all_windows.append(self)
            
            # Ana penceredeki t√ºm child widget'larƒ± recursive olarak tara
            def scan_widgets(widget):
                try:
                    for child in widget.winfo_children():
                        # Her child'ƒ± ekle
                        all_windows.append(child)
                        # Recursive olarak devam et
                        scan_widgets(child)
                except:
                    pass
            
            scan_widgets(self)
            
            print(f"[DEBUG] Bulunan toplam widget sayƒ±sƒ±: {len(all_windows)}")
            print(f"[DEBUG] Widget t√ºrleri: {[w.__class__.__name__ for w in all_windows[:10]]}...")
            
            # 2. Y√ñNTEM: Her widget'ƒ± kontrol et
            for window in all_windows:
                try:
                    # Title var mƒ± kontrol et
                    if hasattr(window, 'title'):
                        title = window.title()
                        print(f"[DEBUG] Widget title: {title}")
                        
                        # DataFrame var mƒ± kontrol et
                        if hasattr(window, 'df'):
                            print(f"[DEBUG] Widget'da df var, uzunluk: {len(window.df)}")
                            
                            # Grup adƒ±nƒ± title'da ara
                            if group.lower() in title.lower():
                                print(f"[DEBUG] ‚úÖ {group} grubu i√ßin pencere bulundu: {title}")
                                return window
                            else:
                                print(f"[DEBUG] ‚ùå {group} grubu i√ßin uygun deƒüil: {title}")
                        else:
                            print(f"[DEBUG] Widget'da df yok")
                    else:
                        print(f"[DEBUG] Widget'da title yok")
                        
                except Exception as e:
                    print(f"[DEBUG] Widget kontrol hatasƒ±: {e}")
                    continue
            
            # 3. Y√ñNTEM: Toplevel pencereleri de tara
            print(f"[DEBUG] Toplevel pencereler aranƒ±yor...")
            for widget in all_windows:
                try:
                    if isinstance(widget, tk.Toplevel):
                        print(f"[DEBUG] Toplevel bulundu: {widget}")
                        if hasattr(widget, 'title'):
                            title = widget.title()
                            print(f"[DEBUG] Toplevel title: {title}")
                            if hasattr(widget, 'df') and group.lower() in title.lower():
                                print(f"[DEBUG] ‚úÖ {group} grubu i√ßin Toplevel pencere bulundu: {title}")
                                return widget
                except:
                    continue
            
            print(f"[DEBUG] ‚ùå {group} grubu i√ßin hi√ß pencere bulunamadƒ±!")
            return None
            
        except Exception as e:
            print(f"[TOP TEN] ‚ùå Pencere arama hatasƒ±: {e}")
            return None
    
    def bottom_ten_ask_sell(self):
        """Bottom Ten Ask Sell - En d√º≈ü√ºk Final_SAS_skorlu %10 hisse i√ßin ask sell emirleri"""
        try:
            print("[BOTTOM TEN] üîÑ Bottom Ten Ask Sell ba≈ülatƒ±lƒ±yor...")
            
            # CSV dosyasƒ±nƒ± sƒ±fƒ±rla (yeni i≈ülem ba≈ülƒ±yor)
            self.reset_pref_csv()
            
            # T√ºm skorlarƒ± hesapla
            self.calculate_scores_for_all_stocks()
            
            # Sadece belirtilen gruplar
            groups = ['heldkuponlu', 'helddeznff', 'heldkuponlukreciliz', 'heldkuponlukreorta', 
                     'heldgarabetaltiyedi', 'heldnff', 'heldotelremorta']
            
            for group in groups:
                try:
                    print(f"[BOTTOM TEN] üîÑ {group} grubu i≈üleniyor...")
                    
                    # CSV dosyasƒ±nƒ± y√ºkle
                    csv_file = f"janek_ssfinek{group}.csv"
                    
                    # Dosya var mƒ± kontrol et
                    if not os.path.exists(csv_file):
                        print(f"[BOTTOM TEN] ‚ö†Ô∏è {csv_file} dosyasƒ± bulunamadƒ±")
                        continue
                    
                    # Dosyayƒ± y√ºkle ve DataFrame'e aktar
                    self.show_file_data(csv_file)
                    
                    # T√ºm sayfalarƒ± tara
                    group_stocks = []
                    current_page = 0
                    max_pages = 50  # G√ºvenlik i√ßin maksimum sayfa sayƒ±sƒ±
                    
                    while current_page < max_pages:
                        # Mevcut sayfadaki hisseleri i≈üle
                        for index, row in self.df.iterrows():
                            ticker = row['PREF IBKR']
                            
                            # Final_SAS_skor'u kontrol et
                            if 'Final_SAS_skor' in self.df.columns:
                                final_sas_skor = row.get('Final_SAS_skor', 0)
                                group_stocks.append({
                                    'symbol': ticker,
                                    'Final_SAS_skor': final_sas_skor
                                })
                            else:
                                # Skor yoksa hesapla
                                market_data = self.hammer.get_market_data(ticker) if hasattr(self, 'hammer') and self.hammer else None
                                
                                if market_data:
                                    bid = float(market_data.get('bid', 0))
                                    ask = float(market_data.get('ask', 0))
                                    last_price = float(market_data.get('last', 0))
                                else:
                                    bid = ask = last_price = 0
                                
                                # Prev close al
                                prev_close = self.get_prev_close_for_symbol(ticker)
                                
                                # Benchmark change al
                                benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                                
                                # Skorlarƒ± hesapla - DOƒûRU FONKSƒ∞YONU KULLAN!
                                scores = self.calculate_scores(ticker, row, bid, ask, last_price, prev_close, benchmark_chg)
                                
                                if scores and 'Final_SAS_skor' in scores:
                                    final_sas_skor = scores['Final_SAS_skor']
                                    group_stocks.append({
                                        'symbol': ticker,
                                        'Final_SAS_skor': final_sas_skor
                                    })
                                else:
                                    final_sas_skor = 0
                        
                        # Sonraki sayfaya ge√ß
                        self.next_page()
                        current_page += 1
                        
                        # Eƒüer sayfa deƒüi≈ümediyse (son sayfa) d√∂ng√ºy√º kƒ±r
                        if len(self.df) == 0:
                            break
                    
                    print(f"[BOTTOM TEN] üìä {group}: Toplam {len(group_stocks)} hisse bulundu")
                    
                    if len(group_stocks) == 0:
                        print(f"[BOTTOM TEN] ‚ö†Ô∏è {group}: Grupta hisse bulunamadƒ±")
                        continue
                    
                    # Duplicate hisseleri kaldƒ±r (aynƒ± symbol'den sadece birini al)
                    unique_stocks = []
                    seen_symbols = set()
                    for stock in group_stocks:
                        if stock['symbol'] not in seen_symbols:
                            unique_stocks.append(stock)
                            seen_symbols.add(stock['symbol'])
                    
                    print(f"[BOTTOM TEN] üìä {group}: Unique {len(unique_stocks)} hisse (duplicate'ler kaldƒ±rƒ±ldƒ±)")
                    
                    if len(unique_stocks) == 0:
                        print(f"[BOTTOM TEN] ‚ö†Ô∏è {group}: Unique hisse bulunamadƒ±")
                        continue
                    
                    # En d√º≈ü√ºk %10'u se√ß (min 1, max 8) - unique_stocks √ºzerinden
                    total_unique_stocks = len(unique_stocks)
                    select_count = max(1, min(8, round(total_unique_stocks * 0.1)))
                    
                    # Final_SAS_skor'a g√∂re sƒ±rala (d√º≈ü√ºkten y√ºkseƒüe - en d√º≈ü√ºk skorlular)
                    unique_stocks.sort(key=lambda x: x['Final_SAS_skor'])
                    bottom_stocks = unique_stocks[:select_count]
                    
                    print(f"[BOTTOM TEN] ‚úÖ {group}: {len(bottom_stocks)} hisse se√ßildi (bottom %10)")
                    
                    # Onay penceresi a√ß
                    symbols = [stock['symbol'] for stock in bottom_stocks]
                    scores = [stock['Final_SAS_skor'] for stock in bottom_stocks]
                    
                    # Onay penceresi a√ß ve kullanƒ±cƒ±nƒ±n yanƒ±tƒ±nƒ± bekle
                    confirmation_win = self.show_order_confirmation(
                        title=f"Bottom Ten Ask Sell - {group}",
                        symbols=symbols,
                        scores=scores,
                        order_type="ask_sell",
                        group=group
                    )
                    
                    # Pencere kapanana kadar bekle
                    if confirmation_win:
                        confirmation_win.wait_window()
                    
                except Exception as e:
                    print(f"[BOTTOM TEN] ‚ùå {group} hatasƒ±: {e}")
                    continue
                    
        except Exception as e:
            print(f"[BOTTOM TEN] ‚ùå Genel hata: {e}")
    
    def show_order_confirmation(self, title, symbols, scores, order_type, group):
        """Emir onay penceresi - Detaylƒ± bilgilerle"""
        import tkinter as tk
        from tkinter import ttk
        
        win = tk.Toplevel(self)
        win.title(title)
        win.geometry("1200x600")
        # transient ve grab_set kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
        
        # Ba≈ülƒ±k
        ttk.Label(win, text=f"{title}\n{len(symbols)} hisse se√ßildi", 
                 font=('Arial', 12, 'bold')).pack(pady=10)
        
        # Tablo - Detaylƒ± bilgiler (checkbox'lƒ±)
        cols = ['select', 'symbol', 'order_info', 'bid', 'ask', 'spread', 'last', 'score', 'avg_adv', 'maxalw']
        if order_type == "ask_sell":
            headers = ['Se√ß', 'Symbol', 'Emir Bilgisi', 'Bid', 'Ask', 'Spread', 'Last', 'Final SAS Skor', 'AVG_ADV', 'MAXALW']
        else:
            headers = ['Se√ß', 'Symbol', 'Emir Bilgisi', 'Bid', 'Ask', 'Spread', 'Last', 'Final BB Skor', 'AVG_ADV', 'MAXALW']
        tree = ttk.Treeview(win, columns=cols, show='headings', height=15)
        
        for c, h in zip(cols, headers):
            tree.heading(c, text=h)
            if c == 'select':
                tree.column(c, width=50, anchor='center')
            elif c == 'symbol':
                tree.column(c, width=100, anchor='center')
            elif c == 'order_info':
                tree.column(c, width=200, anchor='center')
            elif c in ['avg_adv', 'maxalw']:
                tree.column(c, width=80, anchor='center')
            else:
                tree.column(c, width=120, anchor='center')
        
        tree.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Verileri ekle - Detaylƒ± bilgilerle (checkbox'lƒ±)
        # Lot hesaplamasƒ±: MAXALW/4 bazƒ±nda, 200-800 arasƒ±nda sƒ±nƒ±rlƒ±
        def calculate_lot_size(maxalw):
            """MAXALW/4 bazƒ±nda lot hesapla, 200-800 arasƒ±nda sƒ±nƒ±rla"""
            if maxalw <= 0:
                return 200  # Default minimum
            
            # MAXALW/4 hesapla
            calculated_lot = maxalw / 4
            
            # 100'l√ºƒüe yuvarla
            rounded_lot = round(calculated_lot / 100) * 100
            
            # 200-800 arasƒ±nda sƒ±nƒ±rla
            if rounded_lot < 200:
                return 200
            elif rounded_lot > 800:
                return 800
            else:
                return rounded_lot
        
        # Se√ßili hisseleri takip etmek i√ßin
        selected_symbols = []
        symbol_lots = {}  # Her hisse i√ßin lot bilgisini sakla
        
        for symbol, score in zip(symbols, scores):
            # Market data al
            market_data = self.hammer.get_market_data(symbol) if hasattr(self, 'hammer') and self.hammer else None
            
            if market_data:
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                spread = ask - bid if ask > 0 and bid > 0 else 0
            else:
                bid = ask = last = spread = 0
            
            # Emir fiyatƒ±nƒ± hesapla
            if order_type == "bid_buy":
                order_price = bid + spread * 0.15
                order_direction = "BUY"
            else:  # ask_sell
                order_price = ask - spread * 0.15
                order_direction = "SELL"
            
            # AVG_ADV ve MAXALW deƒüerlerini al (kural bazlƒ±)
            avg_adv = self.get_avg_adv_from_csv(symbol)
            divisor = getattr(self, 'rule_avg_adv_divisor', 10)
            maxalw = avg_adv / divisor if avg_adv > 0 else 0
            
            # Her hisse i√ßin MAXALW/4 bazƒ±nda lot hesapla
            individual_lot = calculate_lot_size(maxalw)
            
            # Debug: Lot hesaplama detaylarƒ±
            print(f"[LOT CALC] {symbol}: MAXALW={maxalw:.0f}, MAXALW/4={maxalw/4:.0f}, Rounded={individual_lot}")
            
            # Lot bilgisini sakla
            symbol_lots[symbol] = individual_lot
            
            # Emir bilgisi
            order_info = f"{individual_lot} lot {order_direction} @ ${order_price:.2f} (HIDDEN)"
            
            # Varsayƒ±lan olarak se√ßili (‚úì)
            item = tree.insert('', 'end', values=[
                "‚úì",  # Se√ßili
                symbol,
                order_info,
                f"${bid:.2f}" if bid > 0 else "N/A",
                f"${ask:.2f}" if ask > 0 else "N/A",
                f"${spread:.2f}" if spread > 0 else "N/A",
                f"${last:.2f}" if last > 0 else "N/A",
                f"{score:.2f}",
                f"{avg_adv:.0f}",
                f"{maxalw:.0f}"
            ])
            
            # Varsayƒ±lan olarak se√ßili
            selected_symbols.append(symbol)
        
        # Checkbox tƒ±klama fonksiyonu
        def toggle_selection(event):
            region = tree.identify_region(event.x, event.y)
            if region == "cell":
                column = tree.identify_column(event.x)
                if column == "#1":  # Se√ß kolonu
                    item = tree.identify_row(event.y)
                    if item:
                        values = list(tree.item(item)['values'])
                        if values[0] == "‚úì":  # Se√ßili ise
                            values[0] = "‚òê"  # Se√ßimi kaldƒ±r
                            if values[1] in selected_symbols:
                                selected_symbols.remove(values[1])
                        else:  # Se√ßili deƒüilse
                            values[0] = "‚úì"  # Se√ß
                            if values[1] not in selected_symbols:
                                selected_symbols.append(values[1])
                        tree.item(item, values=values)
        
        # Tablo tƒ±klama olayƒ±nƒ± baƒüla
        tree.bind('<Button-1>', toggle_selection)
        
        # Butonlar
        button_frame = ttk.Frame(win)
        button_frame.pack(pady=10)
        
        def save_to_trades_csv():
            """Se√ßili emirleri trades.csv formatƒ±nda kaydet"""
            try:
                if not selected_symbols:
                    messagebox.showwarning("Uyarƒ±", "Hi√ß hisse se√ßilmedi!")
                    return
                
                print(f"[CSV SAVE] üîÑ {len(selected_symbols)} se√ßili emir trades.csv'ye kaydediliyor...")
                
                # CSV satƒ±rlarƒ±
                csv_rows = []
                
                for symbol in selected_symbols:
                    # Market data al
                    market_data = self.hammer.get_market_data(symbol) if hasattr(self, 'hammer') and self.hammer else None
                    
                    if market_data:
                        bid = float(market_data.get('bid', 0))
                        ask = float(market_data.get('ask', 0))
                        spread = ask - bid if ask > 0 and bid > 0 else 0
                    else:
                        bid = ask = spread = 0
                    
                    # Emir fiyatƒ±nƒ± hesapla
                    if order_type == "bid_buy":
                        order_price = bid + spread * 0.15
                        action = "BUY"
                    else:  # ask_sell
                        order_price = ask - spread * 0.15
                        action = "SELL"
                    
                    # Lot miktarƒ±nƒ± al
                    individual_lot = symbol_lots.get(symbol, 200)
                    
                    # Lot B√∂l√ºc√º aktifse lotlarƒ± b√∂l
                    if self.lot_divider_enabled:
                        lot_parts = self.divide_lot_size(individual_lot)
                        print(f"[CSV SAVE] üîÑ {symbol}: {individual_lot} lot -> {lot_parts} par√ßalara b√∂l√ºnd√º")
                        
                        # Her par√ßa i√ßin ayrƒ± CSV satƒ±rƒ± olu≈ütur
                        for i, lot_part in enumerate(lot_parts):
                            csv_row = [
                                action,                           # Action: BUY/SELL
                                lot_part,                         # Quantity: Lot miktarƒ±
                                symbol,                           # Symbol: Ticker
                                'STK',                           # SecType: STK
                                'SMART/AMEX',                    # Exchange: SMART/AMEX
                                'USD',                           # Currency: USD
                                'DAY',                           # TimeInForce: DAY
                                'LMT',                           # OrderType: LMT
                                round(order_price, 2),           # LmtPrice: Fiyat
                                'Basket',                        # BasketTag: Basket
                                'U21016730',                     # Account: U21016730
                                'Basket',                        # OrderRef: Basket
                                'TRUE',                          # Hidden: TRUE
                                'TRUE'                           # OutsideRth: TRUE
                            ]
                            csv_rows.append(csv_row)
                    else:
                        # Lot B√∂l√ºc√º kapalƒ±ysa normal ≈üekilde tek satƒ±r
                        csv_row = [
                            action,                           # Action: BUY/SELL
                            individual_lot,                   # Quantity: Lot miktarƒ±
                            symbol,                           # Symbol: Ticker
                            'STK',                           # SecType: STK
                            'SMART/AMEX',                    # Exchange: SMART/AMEX
                            'USD',                           # Currency: USD
                            'DAY',                           # TimeInForce: DAY
                            'LMT',                           # OrderType: LMT
                            round(order_price, 2),           # LmtPrice: Fiyat
                            'Basket',                        # BasketTag: Basket
                            'U21016730',                     # Account: U21016730
                            'Basket',                        # OrderRef: Basket
                            'TRUE',                          # Hidden: TRUE
                            'TRUE'                           # OutsideRth: TRUE
                        ]
                        csv_rows.append(csv_row)
                    
                    print(f"[CSV SAVE] üìù {symbol}: {action} {individual_lot} lot @ ${order_price:.2f}")
                
                # CSV dosyasƒ±na kaydet (her seferinde yeni dosya)
                import csv
                import os
                
                csv_filename = 'trades.csv'
                
                # Her seferinde yeni dosya olu≈ütur (0'dan yaz)
                with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                    writer = csv.writer(csvfile)
                    
                    # Header yaz
                    csv_headers = ['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 
                                  'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 
                                  'OrderRef', 'Hidden', 'OutsideRth']
                    writer.writerow(csv_headers)
                    
                    # Emirleri yaz
                    writer.writerows(csv_rows)
                
                print(f"[CSV SAVE] ‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                
            except Exception as e:
                print(f"[CSV SAVE] ‚ùå CSV kaydetme hatasƒ±: {e}")
                messagebox.showerror("Hata", f"CSV kaydetme hatasƒ±: {e}")
        
        def confirm_order():
            """Se√ßili emirleri g√∂nder"""
            try:
                if not selected_symbols:
                    print(f"[ORDER] ‚ö†Ô∏è {group}: Hi√ß hisse se√ßilmedi!")
                    win.destroy()
                    return
                
                print(f"[ORDER] üîÑ {group}: {len(selected_symbols)} se√ßili hisse i√ßin emirler g√∂nderiliyor...")
                
                for symbol in selected_symbols:
                    # Symbol mapping (PR -> -)
                    hammer_symbol = symbol.replace(" PR", "-")
                    
                    # Market data al
                    market_data = self.hammer.get_market_data(symbol)
                    
                    if order_type == "bid_buy":
                        # Bid buy: bid + spread*0.15
                        if market_data and 'bid' in market_data and 'ask' in market_data:
                            bid = float(market_data['bid'])
                            ask = float(market_data['ask'])
                            spread = ask - bid
                            price = bid + spread * 0.15
                        else:
                            print(f"[ORDER] ‚ö†Ô∏è {symbol}: Bid/Ask fiyatƒ± bulunamadƒ±")
                            continue
                    else:  # ask_sell
                        # Ask sell: ask - spread*0.15
                        if market_data and 'ask' in market_data and 'bid' in market_data:
                            ask = float(market_data['ask'])
                            bid = float(market_data['bid'])
                            spread = ask - bid
                            price = ask - spread * 0.15
                        else:
                            print(f"[ORDER] ‚ö†Ô∏è {symbol}: Ask/Bid fiyatƒ± bulunamadƒ±")
                            continue
                    
                    # Her hisse i√ßin hesaplanan lot'u kullan
                    individual_lot = symbol_lots.get(symbol, 200)  # Default 200
                    
                    # Emir g√∂nder (mevcut moda g√∂re)
                    if hasattr(self, 'mode_manager'):
                        success = self.mode_manager.place_order(
                            symbol=hammer_symbol,
                            side="BUY" if order_type == "bid_buy" else "SELL",
                            quantity=individual_lot,
                            price=price,
                            order_type="LIMIT",
                            hidden=True
                        )
                        
                        if success:
                            print(f"[ORDER] ‚úÖ {symbol}: {order_type} emri g√∂nderildi - {individual_lot} lot @ ${price:.2f}")
                        else:
                            print(f"[ORDER] ‚ùå {symbol}: {order_type} emri g√∂nderilemedi")
                    else:
                        # Fallback to direct hammer
                        self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="BUY" if order_type == "bid_buy" else "SELL",
                            quantity=individual_lot,
                            price=price,
                            order_type="LIMIT"
                        )
                    
                    print(f"[ORDER] ‚úÖ {symbol}: {order_type} emri g√∂nderildi - {individual_lot} lot @ ${price:.2f} (MAXALW/4: {individual_lot})")
                
                print(f"[ORDER] ‚úÖ {group} grubu i√ßin {len(selected_symbols)} emir g√∂nderildi")
                win.destroy()
                
            except Exception as e:
                print(f"[ORDER] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                win.destroy()
        
        def cancel_order():
            """ƒ∞ptal et"""
            print(f"[ORDER] ‚ùå {group} grubu i√ßin emirler iptal edildi")
            win.destroy()
        
        ttk.Button(button_frame, text="Se√ßili Emirleri G√∂nder", command=confirm_order, 
                  style='Accent.TButton').pack(side='left', padx=5)
        ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv, 
                  style='Accent.TButton').pack(side='left', padx=5)
        ttk.Button(button_frame, text="ƒ∞ptal Et", command=cancel_order).pack(side='left', padx=5)
        
        # Pencere referansƒ±nƒ± d√∂nd√ºr
        return win
    
    def show_positions(self):
        """Mevcut moda g√∂re pozisyonlarƒ±m penceresini a√ß"""
        if self.mode_manager.is_hampro_mode():
            from .mypositions import show_positions_window
            show_positions_window(self, self.get_last_price_for_symbol)
        elif self.mode_manager.is_ibkr_mode():
            from .ibkr_positions import show_ibkr_positions_window
            show_ibkr_positions_window(self, self.get_last_price_for_symbol)
    
    def set_mode(self, mode):
        """Modu deƒüi≈ütir ve GUI'yi g√ºncelle"""
        if self.mode_manager.set_mode(mode):
            self.current_mode = mode
            self.hampro_mode = (mode == "HAMPRO")
            self.ibkr_gun_mode = (mode == "IBKR_GUN")
            self.ibkr_ped_mode = (mode == "IBKR_PED")
            
            # Buton g√∂r√ºn√ºmlerini g√ºncelle
            if mode == "HAMPRO":
                self.btn_hampro_mode.configure(style="Accent.TButton")
                self.btn_ibkr_gun_mode.configure(style="TButton")
                self.btn_ibkr_ped_mode.configure(style="TButton")
            elif mode == "IBKR_GUN":
                self.btn_hampro_mode.configure(style="TButton")
                self.btn_ibkr_gun_mode.configure(style="Accent.TButton")
                self.btn_ibkr_ped_mode.configure(style="TButton")
            elif mode == "IBKR_PED":
                self.btn_hampro_mode.configure(style="TButton")
                self.btn_ibkr_gun_mode.configure(style="TButton")
                self.btn_ibkr_ped_mode.configure(style="Accent.TButton")
            
            print(f"[MAIN] üîÑ Mod deƒüi≈ütirildi: {mode}")
            
            # Exposure bilgisini g√ºncelle
            self.update_exposure_display()
            
            # Baƒülantƒ± durumlarƒ±nƒ± kontrol et
            status = self.mode_manager.get_connection_status()
            print(f"[MAIN] üìä Baƒülantƒ± durumlarƒ±: {status}")
            
            # IBKR moduna ge√ßildiyse baƒülantƒ±yƒ± kontrol et
            if mode in ["IBKR_GUN", "IBKR_PED"]:
                # Native IBKR client'i √∂ncelikle baƒüla
                if not self.ibkr_native.is_connected():
                    print("[MAIN] ‚ö†Ô∏è IBKR Native Gateway'e baƒülanƒ±lƒ±yor...")
                    if self.ibkr_native.connect_to_ibkr():
                        print("[MAIN] ‚úÖ IBKR Native Gateway baƒülantƒ±sƒ± ba≈üarƒ±lƒ±")
                    else:
                        print("[MAIN] ‚ùå IBKR Native Gateway baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z")
                else:
                    print("[MAIN] ‚úÖ IBKR Native Gateway zaten baƒülƒ±")
                
                # ib_insync client'i de baƒüla (yedek olarak)
                if not self.ibkr.is_connected():
                    print("[MAIN] ‚ö†Ô∏è IBKR ib_insync Gateway'e baƒülanƒ±lƒ±yor...")
                    if self.ibkr.connect_to_ibkr():
                        print("[MAIN] ‚úÖ IBKR ib_insync Gateway baƒülantƒ±sƒ± ba≈üarƒ±lƒ±")
                    else:
                        print("[MAIN] ‚ùå IBKR ib_insync Gateway baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z")
                else:
                    print("[MAIN] ‚úÖ IBKR ib_insync Gateway zaten baƒülƒ±")
                
                # NFILLED callback'lerini ayarla (IBKR fill logging i√ßin)
                self.setup_nfilled_callbacks()

                # IBKR moduna ge√ßi≈üte befibgun.csv veya befibped.csv g√ºnl√ºk kontrol (00:00-16:30)
                if mode == "IBKR_GUN":
                    if not self.befibgun_checked_today:
                        self.check_daily_befib()
                elif mode == "IBKR_PED":
                    if not self.befibped_checked_today:
                        self.check_daily_befib()
    
    def show_take_profit_longs(self):
        """Take Profit Longs penceresini a√ß - Sadece long pozisyonlar (quantity > 0)"""
        from .take_profit_panel import TakeProfitPanel
        TakeProfitPanel(self, "longs")
    
    def show_take_profit_shorts(self):
        """Take Profit Shorts penceresini a√ß - Sadece short pozisyonlar (quantity < 0)"""
        from .take_profit_panel import TakeProfitPanel
        TakeProfitPanel(self, "shorts")
    
    def execute_croplit6(self):
        """Croplit6: Spread > 0.06, Longs i√ßin Ask Sell Pahalƒ±lƒ±k > -0.06, Shorts i√ßin Bid Buy Ucuzluk < 0.06"""
        self.execute_croplit(spread_threshold=0.06)
    
    def execute_croplit9(self):
        """Croplit9: Spread > 0.09, Longs i√ßin Ask Sell Pahalƒ±lƒ±k > -0.06, Shorts i√ßin Bid Buy Ucuzluk < 0.06"""
        self.execute_croplit(spread_threshold=0.09)
    
    def execute_croplit(self, spread_threshold=0.06):
        """
        Croplit i≈ülemini y√ºr√ºt: Take Profit Longs ve Shorts panellerini a√ß, ko≈üullarƒ± kontrol et, emir g√∂nder
        
        Args:
            spread_threshold: Spread e≈üiƒüi (0.06 veya 0.09)
        """
        try:
            print(f"[CROPLIT] üî™ Croplit ba≈ülatƒ±lƒ±yor (Spread > {spread_threshold})...")
            
            # Take Profit Longs panelini a√ß ve pozisyonlarƒ± y√ºkle
            from .take_profit_panel import TakeProfitPanel
            longs_panel = TakeProfitPanel(self, "longs")
            self.after(500, lambda: self.process_croplit_long_positions(longs_panel, spread_threshold))
            
            # Take Profit Shorts panelini a√ß ve pozisyonlarƒ± y√ºkle
            shorts_panel = TakeProfitPanel(self, "shorts")
            self.after(1000, lambda: self.process_croplit_short_positions(shorts_panel, spread_threshold))
            
        except Exception as e:
            print(f"[CROPLIT] ‚ùå Hata: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Croplit hatasƒ±: {e}")
    
    def process_croplit_long_positions(self, panel, spread_threshold):
        """Long pozisyonlar i√ßin Croplit i≈ülemini y√ºr√ºt"""
        try:
            print(f"[CROPLIT] üîç Long pozisyonlar kontrol ediliyor...")
            
            # Pozisyonlarƒ± bekle (y√ºklenene kadar)
            import time
            time.sleep(1)  # Pozisyonlarƒ±n y√ºklenmesi i√ßin bekle
            
            orders_to_send = []
            
            for pos in panel.positions:
                symbol = pos['symbol']
                qty = abs(pos['qty'])  # Long pozisyon miktarƒ± (pozitif)
                ask_sell_pahalilik = pos.get('ask_sell_pahalilik_skoru', 0.0)
                
                # Spread deƒüerini mini450'den al
                spread = 0.0
                if hasattr(self, 'df') and not self.df.empty:
                    symbol_row = self.df[self.df['PREF IBKR'] == symbol]
                    if not symbol_row.empty and 'Spread' in self.df.columns:
                        spread_val = symbol_row['Spread'].iloc[0]
                        if pd.notna(spread_val) and spread_val != 'N/A':
                            try:
                                spread = float(spread_val)
                            except:
                                spread = 0.0
                
                # Eƒüer mini450'de yoksa market data'dan al
                if spread == 0.0:
                    market_data = self.hammer.get_market_data(symbol)
                    if market_data:
                        bid = float(market_data.get('bid', 0))
                        ask = float(market_data.get('ask', 0))
                        spread = ask - bid
                
                if spread == 0.0:
                    continue
                
                # Ko≈üullarƒ± kontrol et
                if spread <= spread_threshold:
                    print(f"[CROPLIT] ‚ö†Ô∏è {symbol}: Spread {spread:.4f} <= {spread_threshold}, atlandƒ±")
                    continue
                
                if ask_sell_pahalilik <= -0.06:
                    print(f"[CROPLIT] ‚ö†Ô∏è {symbol}: Ask Sell Pahalƒ±lƒ±k {ask_sell_pahalilik:.4f} <= -0.06, atlandƒ±")
                    continue
                
                if qty < 200:
                    # 200'den k√º√ß√ºkse ne kadar varsa o kadar
                    order_qty = int(qty)
                else:
                    # %10 hesapla ve 100'l√ºk birime yuvarla
                    order_qty = int(qty * 0.1)
                    # 100'l√ºk birime yuvarla (a≈üaƒüƒ±)
                    order_qty = (order_qty // 100) * 100
                    if order_qty < 200:
                        order_qty = 200  # Minimum 200
                
                if order_qty > 0:
                    # Market data al (fiyat hesaplama i√ßin)
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        continue
                    ask = float(market_data.get('ask', 0))
                    bid = float(market_data.get('bid', 0))
                    if ask == 0 or bid == 0:
                        continue
                    
                    # Ask Sell fiyatƒ± hesapla
                    ask_sell_price = ask - (spread * 0.15)
                    
                    orders_to_send.append({
                        'symbol': symbol,
                        'side': 'SELL',
                        'quantity': order_qty,
                        'price': ask_sell_price,
                        'original_qty': qty
                    })
                    
                    print(f"[CROPLIT] ‚úÖ {symbol}: {order_qty} lot Ask Sell @ ${ask_sell_price:.2f} (Orijinal: {qty}, Spread: {spread:.4f}, Pahalƒ±lƒ±k: {ask_sell_pahalilik:.4f})")
            
            # Emirleri g√∂nder
            if orders_to_send:
                self.send_croplit_orders(orders_to_send, "Longs")
            else:
                print(f"[CROPLIT] ‚ö†Ô∏è Long pozisyonlar i√ßin uygun emir bulunamadƒ±")
                
        except Exception as e:
            print(f"[CROPLIT] ‚ùå Long pozisyon i≈üleme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def process_croplit_short_positions(self, panel, spread_threshold):
        """Short pozisyonlar i√ßin Croplit i≈ülemini y√ºr√ºt"""
        try:
            print(f"[CROPLIT] üîç Short pozisyonlar kontrol ediliyor...")
            
            # Pozisyonlarƒ± bekle (y√ºklenene kadar)
            import time
            time.sleep(1)  # Pozisyonlarƒ±n y√ºklenmesi i√ßin bekle
            
            orders_to_send = []
            
            for pos in panel.positions:
                symbol = pos['symbol']
                qty = abs(pos['qty'])  # Short pozisyon miktarƒ± (pozitif)
                bid_buy_ucuzluk = pos.get('bid_buy_ucuzluk_skoru', 0.0)
                
                # Spread deƒüerini mini450'den al
                spread = 0.0
                if hasattr(self, 'df') and not self.df.empty:
                    symbol_row = self.df[self.df['PREF IBKR'] == symbol]
                    if not symbol_row.empty and 'Spread' in self.df.columns:
                        spread_val = symbol_row['Spread'].iloc[0]
                        if pd.notna(spread_val) and spread_val != 'N/A':
                            try:
                                spread = float(spread_val)
                            except:
                                spread = 0.0
                
                # Eƒüer mini450'de yoksa market data'dan al
                if spread == 0.0:
                    market_data = self.hammer.get_market_data(symbol)
                    if market_data:
                        bid = float(market_data.get('bid', 0))
                        ask = float(market_data.get('ask', 0))
                        spread = ask - bid
                
                if spread == 0.0:
                    continue
                
                # Ko≈üullarƒ± kontrol et
                if spread <= spread_threshold:
                    print(f"[CROPLIT] ‚ö†Ô∏è {symbol}: Spread {spread:.4f} <= {spread_threshold}, atlandƒ±")
                    continue
                
                if bid_buy_ucuzluk >= 0.06:
                    print(f"[CROPLIT] ‚ö†Ô∏è {symbol}: Bid Buy Ucuzluk {bid_buy_ucuzluk:.4f} >= 0.06, atlandƒ±")
                    continue
                
                if qty < 200:
                    # 200'den k√º√ß√ºkse ne kadar varsa o kadar
                    order_qty = int(qty)
                else:
                    # %10 hesapla ve 100'l√ºk birime yuvarla
                    order_qty = int(qty * 0.1)
                    # 100'l√ºk birime yuvarla (a≈üaƒüƒ±)
                    order_qty = (order_qty // 100) * 100
                    if order_qty < 200:
                        order_qty = 200  # Minimum 200
                
                if order_qty > 0:
                    # Market data al (fiyat hesaplama i√ßin)
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        continue
                    ask = float(market_data.get('ask', 0))
                    bid = float(market_data.get('bid', 0))
                    if ask == 0 or bid == 0:
                        continue
                    
                    # Bid Buy fiyatƒ± hesapla
                    bid_buy_price = bid + (spread * 0.15)
                    
                    orders_to_send.append({
                        'symbol': symbol,
                        'side': 'BUY',
                        'quantity': order_qty,
                        'price': bid_buy_price,
                        'original_qty': qty
                    })
                    
                    print(f"[CROPLIT] ‚úÖ {symbol}: {order_qty} lot Bid Buy @ ${bid_buy_price:.2f} (Orijinal: {qty}, Spread: {spread:.4f}, Ucuzluk: {bid_buy_ucuzluk:.4f})")
            
            # Emirleri g√∂nder
            if orders_to_send:
                self.send_croplit_orders(orders_to_send, "Shorts")
            else:
                print(f"[CROPLIT] ‚ö†Ô∏è Short pozisyonlar i√ßin uygun emir bulunamadƒ±")
                
        except Exception as e:
            print(f"[CROPLIT] ‚ùå Short pozisyon i≈üleme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def send_croplit_orders(self, orders, position_type):
        """Croplit emirlerini g√∂nder"""
        try:
            print(f"[CROPLIT] üì§ {len(orders)} {position_type} emri g√∂nderiliyor...")
            
            success_count = 0
            error_count = 0
            
            for order in orders:
                symbol = order['symbol']
                side = order['side']
                quantity = order['quantity']
                price = order['price']
                
                # Symbol mapping (PR -> -)
                hammer_symbol = symbol.replace(" PR", "-")
                
                # Mevcut moda g√∂re emir g√∂nder
                if hasattr(self, 'mode_manager'):
                    success = self.mode_manager.place_order(
                        symbol=hammer_symbol,
                        side=side,
                        quantity=quantity,
                        price=price,
                        order_type="LIMIT",
                        hidden=True
                    )
                    
                    if success:
                        print(f"[CROPLIT] ‚úÖ {symbol}: {side} {quantity} lot @ ${price:.2f}")
                        success_count += 1
                    else:
                        print(f"[CROPLIT] ‚ùå {symbol}: Emir g√∂nderilemedi")
                        error_count += 1
                else:
                    print(f"[CROPLIT] ‚ùå Mode manager bulunamadƒ±")
                    error_count += 1
            
            # Sonu√ß mesajƒ±
            result_msg = f"Croplit {position_type} Emirleri:\n\n"
            result_msg += f"‚úÖ Ba≈üarƒ±lƒ±: {success_count}\n"
            result_msg += f"‚ùå Hatalƒ±: {error_count}\n"
            result_msg += f"üìä Toplam: {len(orders)}"
            
            messagebox.showinfo("Croplit Sonu√ß", result_msg)
            print(f"[CROPLIT] ‚úÖ {position_type} i≈ülemi tamamlandƒ±: {success_count} ba≈üarƒ±lƒ±, {error_count} hatalƒ±")
            
        except Exception as e:
            print(f"[CROPLIT] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Emir g√∂nderme hatasƒ±: {e}")
    
    def show_spreadkusu(self):
        """Spreadkusu penceresini a√ß - Spread >= 0.20 olan hisseler"""
        from .spreadkusu_panel import SpreadkusuPanel
        SpreadkusuPanel(self)
    
    def runall_execute_qpcal(self):
        """RUNALL i√ßin Qpcal i≈ülemini y√ºr√ºt: Spreadkusu panel a√ß, Qpcal butonuna tƒ±kla, Runqp'a bas, emirleri g√∂nder"""
        try:
            print("[RUNALL] üîÑ Qpcal i≈ülemi ba≈ülatƒ±lƒ±yor...")
            self.log_message("üîÑ Qpcal i≈ülemi ba≈ülatƒ±lƒ±yor...")
            
            # Spreadkusu panel'i a√ß veya mevcut panel'i kullan
            if not hasattr(self, 'spreadkusu_panel') or not self.spreadkusu_panel:
                print("[RUNALL] üìä Spreadkusu panel a√ßƒ±lƒ±yor...")
                from .spreadkusu_panel import SpreadkusuPanel
                self.spreadkusu_panel = SpreadkusuPanel(self)
                # Veri y√ºklenmesini bekle (2 saniye - daha g√ºvenli)
                self.after(2000, lambda: self._runall_qpcal_after_panel_ready())
            else:
                # Mevcut panel'i √∂ne getir
                try:
                    if self.spreadkusu_panel.win.winfo_exists():
                        print("[RUNALL] üìä Mevcut Spreadkusu panel kullanƒ±lƒ±yor...")
                        self.spreadkusu_panel.win.lift()
                        self.spreadkusu_panel.win.focus()
                        # Veri y√ºklenmesini bekle (2 saniye - daha g√ºvenli)
                        self.after(2000, lambda: self._runall_qpcal_after_panel_ready())
                    else:
                        # Pencere kapanmƒ±≈üsa yeniden a√ß
                        print("[RUNALL] üìä Spreadkusu panel yeniden a√ßƒ±lƒ±yor...")
                        from .spreadkusu_panel import SpreadkusuPanel
                        self.spreadkusu_panel = SpreadkusuPanel(self)
                        # Veri y√ºklenmesini bekle (2 saniye - daha g√ºvenli)
                        self.after(2000, lambda: self._runall_qpcal_after_panel_ready())
                except Exception as e:
                    print(f"[RUNALL] ‚ö†Ô∏è Spreadkusu panel kontrol√º hatasƒ±: {e}, yeniden a√ßƒ±lƒ±yor...")
                    # Pencere kapanmƒ±≈üsa yeniden a√ß
                    from .spreadkusu_panel import SpreadkusuPanel
                    self.spreadkusu_panel = SpreadkusuPanel(self)
                    # Veri y√ºklenmesini bekle (2 saniye - daha g√ºvenli)
                    self.after(2000, lambda: self._runall_qpcal_after_panel_ready())
        
        except Exception as e:
            print(f"[RUNALL] ‚ùå Qpcal i≈ülemi hatasƒ±: {e}")
            self.log_message(f"‚ùå Qpcal i≈ülemi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            
            # Hata olsa bile 2 dakika sonra restart yap
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            should_continue = runall_running or runall_allowed
            
            if should_continue:
                print("[RUNALL] ‚ö†Ô∏è Qpcal hatasƒ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                self.log_message("‚ö†Ô∏è Qpcal hatasƒ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                # 2 dakika bekle, sonra emirleri iptal et
                self.after(120000, lambda: self.runall_cancel_orders_and_restart())
    
    def _runall_qpcal_after_panel_ready(self):
        """Spreadkusu panel hazƒ±r olduktan sonra Qpcal'i ba≈ülat"""
        try:
            # Qpcal callback'i: Emirler g√∂nderildikten sonra 2 dakika sayacƒ±nƒ± ba≈ülat
            def qpcal_complete_callback():
                try:
                    print("[RUNALL] ‚úÖ Qpcal emirleri g√∂nderildi, 2 dakika sayacƒ± ba≈ülatƒ±lƒ±yor...")
                    self.log_message("‚úÖ Qpcal emirleri g√∂nderildi, 2 dakika sayacƒ± ba≈ülatƒ±lƒ±yor...")
                    
                    # Qpcal penceresini kapat
                    if hasattr(self, 'spreadkusu_panel') and self.spreadkusu_panel:
                        try:
                            if hasattr(self.spreadkusu_panel, 'qpcal_window') and self.spreadkusu_panel.qpcal_window:
                                if self.spreadkusu_panel.qpcal_window.winfo_exists():
                                    self.spreadkusu_panel.qpcal_window.destroy()
                        except:
                            pass
                    
                    # 2 dakika sonra emirleri iptal et ve tekrar ba≈üla
                    def schedule_cancel_and_restart():
                        print(f"[RUNALL] ‚è∞ schedule_cancel_and_restart() √ßaƒürƒ±ldƒ± (Qpcal sonrasƒ±)")
                        runall_still_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                        runall_still_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                        should_proceed = runall_still_running or runall_still_allowed
                        print(f"[RUNALL] üîç schedule_cancel_and_restart i√ßinde: runall_loop_running={runall_still_running}, runall_allowed_mode={runall_still_allowed}, should_proceed={should_proceed}")
                        if should_proceed:
                            # runall_loop_running'i True yap (eƒüer runall_allowed_mode aktifse)
                            if runall_still_allowed and not runall_still_running:
                                self.runall_loop_running = True
                                print(f"[RUNALL] ‚úÖ runall_loop_running True yapƒ±ldƒ± (runall_allowed_mode aktif)")
                            
                            # Tamamlanan d√∂ng√º sayƒ±sƒ±nƒ± g√∂ster
                            completed_loops = self.runall_loop_count if hasattr(self, 'runall_loop_count') else 0
                            self.log_message(f"‚è∞ 2 dakika ge√ßti, {completed_loops}. d√∂ng√º i√ßin emirler iptal ediliyor...")
                            print(f"[RUNALL] ‚è∞ 2 dakika ge√ßti, {completed_loops}. d√∂ng√º i√ßin emirler iptal ediliyor...")
                            self.runall_cancel_orders_and_restart()
                        else:
                            print(f"[RUNALL] ‚ö†Ô∏è RUNALL d√∂ng√ºs√º durdurulmu≈ü, callback iptal edildi")
                    
                    print(f"[RUNALL] ‚è∞ 120 saniye (2 dakika) sonra schedule_cancel_and_restart() √ßaƒürƒ±lacak (Qpcal sonrasƒ±)")
                    self.after(120000, schedule_cancel_and_restart)  # 2 dakika bekleme
                    self.runall_addnewpos_callback_set = False
                except Exception as e:
                    print(f"[RUNALL] ‚ùå Qpcal callback hatasƒ±: {e}")
                    self.log_message(f"‚ùå Qpcal callback hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
            
            # Qpcal penceresini a√ß ve callback'i ge√ßir
            if hasattr(self, 'spreadkusu_panel') and self.spreadkusu_panel:
                print("[RUNALL] üîÑ Qpcal penceresi a√ßƒ±lƒ±yor...")
                self.spreadkusu_panel.show_qpcal_window(on_complete_callback=qpcal_complete_callback)
            else:
                print("[RUNALL] ‚ùå Spreadkusu panel bulunamadƒ±!")
                self.log_message("‚ùå Spreadkusu panel bulunamadƒ±!")
                # Hata durumunda 2 dakika sonra restart yap
                runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                should_continue = runall_running or runall_allowed
                
                if should_continue:
                    print("[RUNALL] ‚ö†Ô∏è Qpcal hatasƒ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                    self.log_message("‚ö†Ô∏è Qpcal hatasƒ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                    # 2 dakika bekle, sonra emirleri iptal et
                    self.after(120000, lambda: self.runall_cancel_orders_and_restart())
        except Exception as e:
            print(f"[RUNALL] ‚ùå Qpcal ba≈ülatma hatasƒ±: {e}")
            self.log_message(f"‚ùå Qpcal ba≈ülatma hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            
            # Hata olsa bile 2 dakika sonra restart yap
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            should_continue = runall_running or runall_allowed
            
            if should_continue:
                print("[RUNALL] ‚ö†Ô∏è Qpcal hatasƒ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                self.log_message("‚ö†Ô∏è Qpcal hatasƒ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                # 2 dakika bekle, sonra emirleri iptal et
                self.after(120000, lambda: self.runall_cancel_orders_and_restart())
    
    def show_port_adjuster(self):
        """Port Adjuster penceresini a√ß"""
        from .port_adjuster import PortAdjusterWindow
        port_window = PortAdjusterWindow(self)
        
        # Stock Data Manager referansƒ±nƒ± ge√ß
        port_window.set_stock_data_manager(self.stock_data_manager)
        
        # Port Adjuster window referansƒ±nƒ± d√∂nd√ºr (ADDNEWPOS i√ßin)
        return port_window
    
    def show_portfolio_comparison(self):
        """Portfolio Comparison penceresini a√ß"""
        from .portfolio_comparison import PortfolioComparisonWindow
        PortfolioComparisonWindow(self)
    
    def show_my_orders(self):
        """Emirlerim penceresini a√ß - Mod-aware"""
        # Mevcut moda g√∂re emirleri g√∂ster
        if hasattr(self, 'mode_manager'):
            if self.mode_manager.is_hampro_mode():
                print("[MAIN] üîÑ HAMPRO modunda emirler g√∂steriliyor...")
                # Hammer Pro'dan emirleri g√∂ster
                from .myorders import show_orders_window
                show_orders_window(self)
            elif self.mode_manager.is_ibkr_mode():
                print("[MAIN] üîÑ IBKR modunda emirler g√∂steriliyor...")
                # IBKR'den emirleri g√∂ster
                from .ibkr_orders import show_ibkr_orders_window
                show_ibkr_orders_window(self)
            else:
                print("[MAIN] ‚ö†Ô∏è Mod belirlenemedi, HAMPRO kullanƒ±lƒ±yor...")
                from .myorders import show_orders_window
                show_orders_window(self)
        else:
            print("[MAIN] ‚ö†Ô∏è Mode manager bulunamadƒ±, HAMPRO kullanƒ±lƒ±yor...")
            from .myorders import show_orders_window
            show_orders_window(self)
    
    def reset_trades_csv(self):
        """trades.csv dosyasƒ±nƒ± sƒ±fƒ±rla - yeni i≈ülem ba≈ülƒ±yor"""
        try:
            import os
            
            csv_filename = 'trades.csv'
            
            # Dosya varsa sƒ±fƒ±rla
            if os.path.exists(csv_filename):
                # Mevcut dosyayƒ± yedekle
                import time
                backup_filename = f'trades_backup_{int(time.time())}.csv'
                os.rename(csv_filename, backup_filename)
                print(f"[CSV RESET] üíæ Mevcut trades.csv yedeklendi: {backup_filename}")
            
            # Yeni bo≈ü dosya olu≈ütur (sadece ba≈ülƒ±klarla)
            import csv
            csv_headers = ['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 
                          'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 
                          'OrderRef', 'Hidden', 'OutsideRth']
            
            with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.writer(csvfile)
                writer.writerow(csv_headers)
            
            print(f"[CSV RESET] ‚úÖ trades.csv sƒ±fƒ±rlandƒ±, yeni i≈ülem ba≈ülƒ±yor")
            
        except Exception as e:
            print(f"[CSV RESET] ‚ùå CSV sƒ±fƒ±rlama hatasƒ±: {e}")
    
    def show_mini450_view(self):
        """
        JANALLDATA'daki t√ºm 450 hisseyi tek sayfada mini g√∂r√ºn√ºmde g√∂ster.
        Bu sayede t√ºm hisseler i√ßin aynƒ± anda live data request atƒ±labilir.
        """
        try:
            print("üîç Mƒ∞Nƒ∞450 G√ñR√úN√úM√ú A√áILIYOR...")
            print("=" * 60)
            
            # Mini450 aktif flag'ini set et (performans optimizasyonu i√ßin)
            self.is_mini450_active = True
            
            # Arka plan data g√ºncelleme thread'ini ba≈ülat
            self.start_background_data_update()
            
            # Hammer Pro baƒülantƒ±sƒ±nƒ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer.connected:
                messagebox.showwarning("Uyarƒ±", "√ñnce Hammer Pro'ya baƒülanƒ±n!")
                return
                
            # Live data'nƒ±n √ßalƒ±≈ütƒ±ƒüƒ±ndan emin ol
            if not hasattr(self, 'live_data_running') or not self.live_data_running:
                messagebox.showwarning("Uyarƒ±", "√ñnce Live Data'yƒ± ba≈ülatƒ±n!")
                return
            
            # JANALLDATA dosyasƒ±nƒ± y√ºkle
            if not os.path.exists('janalldata.csv'):
                messagebox.showerror("Hata", "janalldata.csv dosyasƒ± bulunamadƒ±!")
                return
            
            # Mevcut durumu kaydet
            self.original_items_per_page = self.items_per_page
            self.original_current_page = self.current_page
            
            # CSV'yi y√ºkle (Fbtot/SFStot hesaplamasƒ± show_file_data i√ßinde skorlar hesaplandƒ±ktan sonra yapƒ±lacak)
            df = pd.read_csv('janalldata.csv')
            print(f"üìä JANALLDATA y√ºklendi: {len(df)} hisse")
            
            # T√ºm hisseleri tek sayfada g√∂stermek i√ßin items_per_page'i artƒ±r
            self.items_per_page = len(df)  # T√ºm hisseleri tek sayfada g√∂ster
            self.current_page = 0
            
            # Normal show_file_data mantƒ±ƒüƒ±nƒ± kullan ama mini g√∂r√ºn√ºm i√ßin optimize et
            # Fbtot/SFStot hesaplamasƒ± show_file_data i√ßinde skorlar hesaplandƒ±ktan sonra yapƒ±lacak
            self.show_file_data('janalldata.csv', is_main=True)
            
            # Tablo satƒ±r y√ºksekliƒüini k√º√ß√ºlt (mini g√∂r√ºn√ºm)
            self.table.configure(height=25)  # Daha fazla satƒ±r g√∂ster
            
            # Font boyutunu k√º√ß√ºlt
            style = ttk.Style()
            style.configure("Mini.Treeview", font=('Arial', 8))  # K√º√ß√ºk font
            style.configure("Mini.Treeview.Heading", font=('Arial', 8, 'bold'))
            self.table.configure(style="Mini.Treeview")
            
            # Kolon geni≈üliklerini k√º√ß√ºlt
            for col in self.columns:
                if col == 'PREF IBKR':
                    self.table.column(col, width=80)  # Sembol kolonu
                elif col in ['Bid', 'Ask', 'Last']:
                    self.table.column(col, width=50)  # Fiyat kolonlarƒ±
                elif col == 'SMA63 chg':
                    self.table.column(col, width=45)  # SMA63 chg kolonu
                elif col in ['SMA246 chg', 'SMA 246 CHG']:
                    self.table.column(col, width=50)  # SMA246 chg kolonu
                elif col == 'GORT':
                    self.table.column(col, width=50)  # GORT kolonu
                elif col in ['Final_FB_skor', 'Final_SFS_skor', 'Final_BB_skor']:
                    self.table.column(col, width=60)  # Skor kolonlarƒ±  
                else:
                    self.table.column(col, width=40)  # Diƒüer kolonlar
            
            print(f"üîç Mini450 g√∂r√ºn√ºm√º aktif: {len(df)} hisse tek sayfada")
            print(f"üì° T√ºm hisseler i√ßin live data request'leri atƒ±lƒ±yor...")
            
            # Ba≈ülƒ±ƒüƒ± g√ºncelle
            self.title("JanAll - Mini450 G√∂r√ºn√ºm√º (T√ºm Hisseler)")
            
            # Normal buton ekle (√ßƒ±kƒ±≈ü i√ßin)
            self.add_normal_view_button()
            
            messagebox.showinfo("Mini450 Aktif", 
                              f"‚úÖ Mini450 g√∂r√ºn√ºm√º aktif!\n\n"
                              f"üìä {len(df)} hisse tek sayfada g√∂steriliyor\n"
                              f"üì° T√ºm hisseler i√ßin live data alƒ±nƒ±yor\n"
                              f"üîç Artƒ±k t√ºm skorlar hesaplanacak!\n\n"
                              f"Normal g√∂r√ºn√ºme d√∂nmek i√ßin 'Normal G√∂r√ºn√ºm' butonuna basƒ±n.")
            
        except Exception as e:
            print(f"‚ùå Mini450 g√∂r√ºn√ºm√º hatasƒ±: {e}")
            messagebox.showerror("Hata", f"Mini450 g√∂r√ºn√ºm√º hatasƒ±: {e}")
            
            # Hata durumunda orijinal duruma d√∂n
            self.restore_normal_view()
    
    def add_normal_view_button(self):
        """Normal g√∂r√ºn√ºme d√∂nmek i√ßin buton ekle"""
        if not hasattr(self, 'normal_view_button'):
            # Buton frame'i bul veya olu≈ütur
            if hasattr(self, 'files_frame'):
                files_frame = self.children[list(self.children.keys())[2]]  # files_frame'i bul
                for child in files_frame.winfo_children():
                    if isinstance(child, ttk.Frame):
                        main_frame = child
                        break
                
                # Normal g√∂r√ºn√ºm butonu ekle
                self.normal_view_button = ttk.Button(main_frame, text="üîô Normal G√∂r√ºn√ºm", 
                                                   command=self.restore_normal_view)
                self.normal_view_button.pack(side='left', padx=5)
    
    def restore_normal_view(self):
        """Normal g√∂r√ºn√ºme geri d√∂n"""
        try:
            # Mini450 flag'ini sƒ±fƒ±rla (performans optimizasyonu)
            self.is_mini450_active = False
            
            # Arka plan thread'ini durdur
            self.stop_background_data_update()
            
            # Orijinal deƒüerleri geri y√ºkle
            if hasattr(self, 'original_items_per_page'):
                self.items_per_page = self.original_items_per_page
                self.current_page = self.original_current_page
                
                # Sayfa sayƒ±sƒ±nƒ± yeniden hesapla
                if hasattr(self, 'tickers'):
                    self.total_pages = max(1, (len(self.tickers) + self.items_per_page - 1) // self.items_per_page)
                
                # Tabloyu normale d√∂nd√ºr
                self.table.configure(height=15)  # Normal y√ºkseklik
                
                # Font'u normale d√∂nd√ºr
                style = ttk.Style()
                style.configure("Treeview", font=('Arial', 9))
                style.configure("Treeview.Heading", font=('Arial', 9, 'bold'))
                self.table.configure(style="Treeview")
                
                # Kolon geni≈üliklerini normale d√∂nd√ºr
                for col in self.columns:
                    if col == 'Se√ß':
                        self.table.column(col, width=30, anchor='center')
                    elif col == 'PREF IBKR':
                        self.table.column(col, width=100, anchor='center')
                    elif col in ['Bid', 'Ask', 'Last', 'Volume']:
                        self.table.column(col, width=70, anchor='center')
                    elif col in ['Final_FB_skor', 'Final_SFS_skor', 'Final_BB_skor', 'Final_AB_skor', 'Final_AS_skor', 'Final_FS_skor', 'Final_BS_skor']:
                        self.table.column(col, width=80, anchor='center')
                    elif col == 'SMA63 chg':
                        self.table.column(col, width=60, anchor='center')  # SMA63 chg kolonu
                    elif col in ['SMA246 chg', 'SMA 246 CHG']:
                        self.table.column(col, width=60, anchor='center')  # SMA246 chg kolonu
                    elif col == 'GORT':
                        self.table.column(col, width=60, anchor='center')  # GORT kolonu
                    else:
                        self.table.column(col, width=60, anchor='center')
                
                # Tabloyu g√ºncelle
                self.update_table()
                
                # Normal g√∂r√ºn√ºm butonunu kaldƒ±r
                if hasattr(self, 'normal_view_button'):
                    self.normal_view_button.destroy()
                    delattr(self, 'normal_view_button')
                
                # Ba≈ülƒ±ƒüƒ± g√ºncelle
                self.title("JanAll - Normal G√∂r√ºn√ºm")
                
                print("üîô Normal g√∂r√ºn√ºme d√∂n√ºld√º")
                
        except Exception as e:
            print(f"‚ùå Normal g√∂r√ºn√ºme d√∂n√º≈ü hatasƒ±: {e}")
    
    def start_background_data_update(self):
        """Arka plan data g√ºncelleme thread'ini ba≈ülat"""
        if not self.background_update_running:
            self.background_update_running = True
            self.background_update_thread = threading.Thread(
                target=self.background_data_worker, 
                daemon=True
            )
            self.background_update_thread.start()
            print("üîß Arka plan data g√ºncelleme thread'i ba≈ülatƒ±ldƒ±")
    
    def stop_background_data_update(self):
        """Arka plan data g√ºncelleme thread'ini durdur"""
        self.background_update_running = False
        if self.background_update_thread:
            print("üîß Arka plan data g√ºncelleme thread'i durduruluyor...")
    
    def background_data_worker(self):
        """Arka plan thread - data cache g√ºncelleme"""
        while self.background_update_running:
            try:
                if self.is_mini450_active and hasattr(self, 'df') and not self.df.empty:
                    # Mini450 aktifken arka planda data cache'i g√ºncelle
                    for _, row in self.df.iterrows():
                        if not self.background_update_running:
                            break
                            
                        ticker = row.get('PREF IBKR', '')
                        if ticker and hasattr(self, 'hammer') and self.hammer.connected:
                            try:
                                # Market data al ve cache'e koy
                                market_data = self.hammer.get_market_data(ticker)
                                if market_data:
                                    self.background_data_cache[ticker] = {
                                        'market_data': market_data,
                                        'timestamp': time.time()
                                    }
                                
                                # CPU y√ºk√ºn√º azaltmak i√ßin kƒ±sa bekle
                                time.sleep(0.1)
                                
                            except Exception as e:
                                # Sessizce devam et
                                pass
                
                # Arka plan g√ºncellemesi: 5 saniyede bir
                time.sleep(5)
                
            except Exception as e:
                print(f"[BACKGROUND] ‚ùå Arka plan hatasƒ±: {e}")
                time.sleep(5)
        
        print("üîß Arka plan data g√ºncelleme thread'i durdu")
    
    def get_cached_market_data(self, ticker):
        """Cache'den market data al (3 saniyeden eski deƒüilse)"""
        if ticker in self.background_data_cache:
            cache_entry = self.background_data_cache[ticker]
            age = time.time() - cache_entry['timestamp']
            if age < 3:  # 3 saniyeden yeni ise
                return cache_entry['market_data']
        
        # Cache'de yoksa veya eskiyse normal yoldan al
        if hasattr(self, 'hammer') and self.hammer.connected:
            return self.hammer.get_market_data(ticker)
        return None

    def scan_all_pages_for_scores(self):
        """
        T√ºm grup dosyalarƒ±nƒ±n t√ºm sayfalarƒ±nƒ± tarayarak skorlarƒ± hesapla.
        Bu sayede TUMCSV ayarlamasƒ± yapƒ±lƒ±rken ger√ßek skorlar kullanƒ±labilir.
        Thread kullanarak UI'ƒ± donmadan √ßalƒ±≈üƒ±r.
        """
        try:
            # Thread'de √ßalƒ±≈ütƒ±r
            import threading
            def scan_thread():
                try:
                    print("üöÄ T√úM SAYFALAR TARANACAK - SKORLAR HESAPLANACAK!")
                    print("=" * 80)
                    
                    # Hammer Pro baƒülantƒ±sƒ±nƒ± kontrol et
                    if not hasattr(self, 'hammer') or not self.hammer.connected:
                        self.after(0, lambda: messagebox.showwarning("Uyarƒ±", "√ñnce Hammer Pro'ya baƒülanƒ±n!"))
                        return
                        
                    # Live data'nƒ±n √ßalƒ±≈ütƒ±ƒüƒ±ndan emin ol
                    if not hasattr(self, 'live_data_running') or not self.live_data_running:
                        self.after(0, lambda: messagebox.showwarning("Uyarƒ±", "√ñnce Live Data'yƒ± ba≈ülatƒ±n!"))
                        return
                    
                    # CSV dosya listesi (grup butonlarƒ±ndaki dosyalar)
                    csv_files = [
                        'janek_ssfinekheldcilizyeniyedi.csv',
                        'janek_ssfinekheldcommonsuz.csv', 
                        'janek_ssfinekhelddeznff.csv',
                        'janek_ssfinekheldff.csv',
                        'janek_ssfinekheldflr.csv',
                        'janek_ssfinekheldgarabetaltiyedi.csv',
                        'janek_ssfinekheldkuponlu.csv',
                        'janek_ssfinekheldkuponlukreciliz.csv',
                        'janek_ssfinekheldkuponlukreorta.csv',
                        'janek_ssfinekheldnff.csv',
                        'janek_ssfinekheldotelremorta.csv',
                        'janek_ssfinekheldsolidbig.csv',
                        'janek_ssfinekheldtitrekhc.csv',
                        'janek_ssfinekhighmatur.csv',
                        'janek_ssfineknotbesmaturlu.csv',
                        'janek_ssfineknotcefilliquid.csv',
                        'janek_ssfineknottitrekhc.csv',
                        'janek_ssfinekrumoreddanger.csv',
                        'janek_ssfineksalakilliquid.csv',
                        'janek_ssfinekshitremhc.csv'
                    ]
                    
                    progress_msg = f"Toplam {len(csv_files)} grup dosyasƒ± taranacak..."
                    print(f"üìã {progress_msg}")
                    
                    # Mevcut durumu kaydet
                    original_df = self.df.copy() if hasattr(self, 'df') else None
                    original_page = self.current_page
                    original_tickers = self.tickers.copy() if hasattr(self, 'tickers') else []
                    
                    total_stocks_scanned = 0
                    total_scores_calculated = 0
                    
                    # Her grup dosyasƒ±nƒ± tara
                    for file_idx, file_name in enumerate(csv_files):
                        if not os.path.exists(file_name):
                            print(f"‚ö†Ô∏è {file_name} bulunamadƒ±, atlanƒ±yor")
                            continue
                            
                        print(f"\nüìä [{file_idx+1}/{len(csv_files)}] ƒ∞≈üleniyor: {file_name}")
                        
                        try:
                            # Dosyayƒ± ge√ßici olarak y√ºkle (g√∂r√ºn√ºr hale getirmeden)
                            temp_df = pd.read_csv(file_name)
                            print(f"   ‚úÖ Dosya okundu: {len(temp_df)} hisse")
                            
                            if len(temp_df) == 0:
                                print(f"   ‚ö†Ô∏è Dosya bo≈ü, atlanƒ±yor")
                                continue
                            
                            # Ge√ßici olarak bu dosyayƒ± ana dosya yap (skorlarƒ± hesaplayabilmek i√ßin)
                            self.df = temp_df
                            self.tickers = temp_df['PREF IBKR'].tolist()
                            
                            # Sayfa sayƒ±sƒ±nƒ± hesapla 
                            self.total_pages = max(1, (len(self.tickers) + self.items_per_page - 1) // self.items_per_page)
                            
                            print(f"   üìÑ Toplam {self.total_pages} sayfa taranacak")
                            
                            # T√ºm sayfalarƒ± tara
                            for page in range(self.total_pages):
                                self.current_page = page
                                visible_tickers = self.get_visible_tickers()
                                
                                print(f"   üìÑ Sayfa {page+1}/{self.total_pages}: {len(visible_tickers)} hisse")
                                
                                # Bu sayfadaki her hisse i√ßin skorlarƒ± hesapla
                                for ticker in visible_tickers:
                                    total_stocks_scanned += 1
                                    
                                    try:
                                        # CSV'den bu hissenin verilerini al
                                        row_data = temp_df[temp_df['PREF IBKR'] == ticker]
                                        if row_data.empty:
                                            continue
                                            
                                        row = row_data.iloc[0]
                                        
                                        # Market data al (live)
                                        market_data = self.hammer.get_market_data(ticker)
                                        if market_data:
                                            bid_raw = float(market_data.get('bid', 0))
                                            ask_raw = float(market_data.get('ask', 0))
                                            last_raw = float(market_data.get('last', 0))
                                            prev_close = float(market_data.get('prevClose', 0))
                                            
                                            # Benchmark deƒüi≈üimini hesapla
                                            benchmark_chg = self.get_benchmark_change_for_ticker(ticker)
                                            
                                            # Skorlarƒ± hesapla
                                            scores = self.calculate_scores(ticker, row, bid_raw, ask_raw, last_raw, prev_close, benchmark_chg)
                                            
                                            if scores:
                                                total_scores_calculated += 1
                                                
                                                # DataFrame'e skorlarƒ± kaydet
                                                idx = temp_df[temp_df['PREF IBKR'] == ticker].index[0]
                                                for score_name, score_value in scores.items():
                                                    temp_df.at[idx, score_name] = score_value
                                                
                                                # ƒ∞lk 3 hisse i√ßin debug bilgisi
                                                if total_scores_calculated <= 3:
                                                    final_fb = scores.get('Final_FB_skor', 'N/A')
                                                    final_sfs = scores.get('Final_SFS_skor', 'N/A')
                                                    print(f"      ‚úÖ {ticker}: Final_FB_skor={final_fb:.2f}, Final_SFS_skor={final_sfs:.2f}")
                                            
                                        else:
                                            print(f"      ‚ö†Ô∏è {ticker}: Market data alƒ±namadƒ±")
                                            
                                    except Exception as e:
                                        print(f"      ‚ùå {ticker} i√ßin skor hesaplama hatasƒ±: {e}")
                                        continue
                                
                                # Her 5 sayfada bir ilerleme bilgisi
                                if (page + 1) % 5 == 0:
                                    print(f"   üîÑ ƒ∞lerleme: {page+1}/{self.total_pages} sayfa tamamlandƒ±")
                            
                            # Bu dosyanƒ±n g√ºncellenmi≈ü halini kaydet (skorlarla birlikte)
                            temp_df.to_csv(file_name, index=False)
                            print(f"   üíæ {file_name} skorlarla g√ºncellendi")
                            
                        except Exception as e:
                            print(f"   ‚ùå {file_name} i≈ülenirken hata: {e}")
                            continue
                    
                    # Orijinal durumu geri y√ºkle
                    if original_df is not None:
                        self.df = original_df
                        self.tickers = original_tickers
                        self.current_page = original_page
                        self.total_pages = max(1, (len(self.tickers) + self.items_per_page - 1) // self.items_per_page)
                        self.after(0, self.update_table)
                    
                    # Sonu√ß mesajƒ±
                    result_msg = f"‚úÖ Tarama tamamlandƒ±!\n\nToplam {total_stocks_scanned} hisse taranƒ±\n{total_scores_calculated} skor hesaplandƒ±"
                    print(f"\n{result_msg}")
                    self.after(0, lambda: messagebox.showinfo("Ba≈üarƒ±lƒ±", result_msg))
                    
                except Exception as e:
                    error_msg = f"Tarama sƒ±rasƒ±nda hata: {e}"
                    print(f"‚ùå {error_msg}")
                    self.after(0, lambda: messagebox.showerror("Hata", error_msg))
            
            # Thread'i ba≈ülat
            thread = threading.Thread(target=scan_thread, daemon=True)
            thread.start()
            
        except Exception as e:
            print(f"‚ùå Tarama ba≈ülatma hatasƒ±: {e}")
            messagebox.showerror("Hata", f"Tarama ba≈ülatƒ±lamadƒ±: {e}")

    def get_avg_adv_from_csv(self, symbol):
        """CSV'den AVG_ADV deƒüerini al"""
        try:
            # CSV dosyalarƒ±ndan AVG_ADV deƒüerini bul
            import glob
            import pandas as pd
            
            # T√ºm ssfinek CSV dosyalarƒ±nƒ± bul
            csv_files = glob.glob('ssfinek*.csv')
            
            for csv_file in csv_files:
                try:
                    # Dosyayƒ± oku
                    df = pd.read_csv(csv_file, encoding='utf-8-sig')
                    
                    # PREF IBKR ve AVG_ADV kolonlarƒ± var mƒ± kontrol et
                    if 'PREF IBKR' in df.columns and 'AVG_ADV' in df.columns:
                        # Symbol'√º bul
                        row = df[df['PREF IBKR'] == symbol]
                        if not row.empty:
                            avg_adv = row['AVG_ADV'].iloc[0]
                            if pd.notna(avg_adv) and avg_adv != 'N/A':
                                return float(avg_adv)
                except Exception as e:
                    continue
            
            return 0.0
        except:
            return 0.0
    
    def show_stock_data_status(self):
        """Stock Data Manager durumunu g√∂ster"""
        try:
            if not hasattr(self, 'stock_data_manager') or not self.stock_data_manager:
                messagebox.showinfo("Durum", "Stock Data Manager hen√ºz ba≈ülatƒ±lmamƒ±≈ü!")
                return
            
            # Durum √∂zetini al
            summary = self.stock_data_manager.get_data_summary()
            
            if summary:
                status_text = f"""Stock Data Manager Durumu:

üìä Toplam Hisse: {summary.get('total_stocks', 0)}
‚úÖ Ge√ßerli Veri: {summary.get('valid_stocks', 0)}
‚è∞ S√ºresi Dolmu≈ü: {summary.get('expired_stocks', 0)}
üìÅ CSV Dosyalarƒ±: {', '.join(summary.get('csv_files', []))}
üïê Son G√ºncelleme: {time.strftime('%H:%M:%S', time.localtime(summary.get('last_update', 0)))}

üí° √ñrnek Kullanƒ±m:
‚Ä¢ Port Adjuster'da "Hisse Veri √áek" butonuna tƒ±klayƒ±n
‚Ä¢ Hisse sembol√º girin (√∂rn: CFG PRE) ve "Ara" butonuna tƒ±klayƒ±n
‚Ä¢ Final_FB_skor, Final_SFS_skor gibi verileri g√∂rebilirsiniz"""
                
                messagebox.showinfo("Stock Data Manager Durumu", status_text)
            else:
                messagebox.showinfo("Durum", "Durum bilgisi alƒ±namadƒ±!")
                
        except Exception as e:
            messagebox.showerror("Hata", f"Durum g√∂sterilirken hata: {e}")
            print(f"[STOCK_DATA_STATUS] ‚ùå Hata: {e}")
    
    # SNAPSHOT FONKSƒ∞YONLARI KALDIRILDI - Artƒ±k sadece L1 streaming kullanƒ±yoruz!
    
    def check_daily_befham(self):
        """G√ºnl√ºk befham.csv kontrol√º - Sadece 00:00-16:30 arasƒ±, g√ºnde 1 kez"""
        try:
            # Zaman penceresi: 00:00 - 16:30 (Yerel saat)
            now = datetime.now()
            window_end = now.replace(hour=16, minute=30, second=0, microsecond=0)

            # 16:30 - 23:59 arasƒ±nda asla √ßalƒ±≈ütƒ±rma
            if now >= window_end:
                return

            # Mevcut befham.csv dosyasƒ±nƒ± kontrol et
            befpos_file = "befham.csv"
            
            # Eƒüer bug√ºn i√ßin befpos dosyasƒ± varsa, tekrar √ßalƒ±≈ütƒ±rma
            if os.path.exists(befpos_file):
                try:
                    mtime = datetime.fromtimestamp(os.path.getmtime(befpos_file))
                    if mtime.date() == now.date():
                        print(f"[BEFHAM] OK bugun icin mevcut: {befpos_file}")
                        self.befham_checked_today = True
                        return
                except Exception:
                    pass
            
            # Hammer Pro baƒülantƒ±sƒ± kontrol√º
            if not self.hammer or not getattr(self.hammer, 'connected', False):
                print(f"[BEFHAM] WARN Hammer Pro baglantisi yok, befham.csv calistirilamadi")
                return
            
            print(f"[BEFHAM] OK befham.csv calistiriliyor...")
            
            # befham.csv √ßalƒ±≈ütƒ±r
            self.run_befpos_csv()
            self.befham_checked_today = True
            
        except Exception as e:
            print(f"[BEFHAM] ERROR Gunluk kontrol hatasi: {e}")
    
    def run_befpos_csv(self):
        """befham.csv dosyasƒ±nƒ± √ßalƒ±≈ütƒ±r ve pozisyonlarƒ± kaydet"""
        try:
            # Hammer Pro'dan pozisyonlarƒ± al
            positions = self.hammer.get_positions_direct()
            if not positions:
                print("[BEFHAM] WARN Pozisyon verisi alinmadi")
                return
            
            # Pozisyon verilerini DataFrame'e √ßevir
            position_data = []
            for pos in positions:
                symbol = pos.get('symbol', '')
                qty = pos.get('qty', None)
                if qty is None:
                    qty = pos.get('quantity', 0)
                avg_price = pos.get('avg_cost', None)
                if avg_price is None:
                    avg_price = pos.get('average_price', 0.0)
                market_value = pos.get('market_value', None)
                if market_value is None:
                    try:
                        market_value = float(qty) * float(avg_price)
                    except Exception:
                        market_value = 0.0
                unreal = pos.get('unrealized_pnl', 0.0)
                realized = pos.get('realized_pnl', 0.0)
                position_data.append({
                    'Symbol': symbol,
                    'Quantity': qty,
                    'AveragePrice': avg_price,
                    'MarketValue': market_value,
                    'UnrealizedPnL': unreal,
                    'RealizedPnL': realized,
                    'Timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                })
            
            # DataFrame olu≈ütur
            df = pd.DataFrame(position_data)
            
            # Dosya adƒ±
            filename = "befham.csv"
            
            # CSV'ye kaydet
            df.to_csv(filename, index=False)
            print(f"[BEFHAM] OK Pozisyonlar kaydedildi: {filename} ({len(position_data)} pozisyon)")
            
        except Exception as e:
            print(f"[BEFHAM] ERROR befham.csv calistirma hatasi: {e}")

    def check_daily_befib(self):
        """G√ºnl√ºk befibgun.csv veya befibped.csv kontrol√º - Sadece 00:00-16:30 arasƒ±, g√ºnde 1 kez"""
        try:
            now = datetime.now()
            window_end = now.replace(hour=16, minute=30, second=0, microsecond=0)
            if now >= window_end:
                return
            
            # Aktif modu kontrol et
            active_account = self.mode_manager.get_active_account()
            if active_account == "IBKR_GUN":
                befib_file = "befibgun.csv"
            elif active_account == "IBKR_PED":
                befib_file = "befibped.csv"
            else:
                return  # IBKR modu deƒüilse √ßalƒ±≈ütƒ±rma
            
            if os.path.exists(befib_file):
                try:
                    mtime = datetime.fromtimestamp(os.path.getmtime(befib_file))
                    if mtime.date() == now.date():
                        print(f"[BEFIB] OK bugun icin mevcut: {befib_file}")
                        # Mod bazlƒ± flag'i g√ºncelle
                        if active_account == "IBKR_GUN":
                            self.befibgun_checked_today = True
                        elif active_account == "IBKR_PED":
                            self.befibped_checked_today = True
                        return
                except Exception:
                    pass
            # IBKR baƒülantƒ±sƒ± kontrol√º (native veya ib_insync)
            ib_connected = False
            try:
                ib_connected = self.ibkr_native.is_connected() or self.ibkr.is_connected()
            except Exception:
                ib_connected = False
            if not ib_connected:
                print(f"[BEFIB] WARN IBKR baglantisi yok, {befib_file} calistirilamadi")
                return
            print(f"[BEFIB] OK {befib_file} calistiriliyor...")
            self.run_befib_csv()
            # Mod bazlƒ± flag'i g√ºncelle
            if active_account == "IBKR_GUN":
                self.befibgun_checked_today = True
            elif active_account == "IBKR_PED":
                self.befibped_checked_today = True
        except Exception as e:
            print(f"[BEFIB] ERROR Gunluk kontrol hatasi: {e}")

    def run_befib_csv(self):
        """befibgun.csv veya befibped.csv dosyasƒ±nƒ± √ßalƒ±≈ütƒ±r ve IBKR pozisyonlarƒ±nƒ± kaydet"""
        try:
            # Aktif modu kontrol et
            active_account = self.mode_manager.get_active_account()
            if active_account == "IBKR_GUN":
                filename = "befibgun.csv"
            elif active_account == "IBKR_PED":
                filename = "befibped.csv"
            else:
                print(f"[BEFIB] WARN Aktif mod IBKR deƒüil: {active_account}")
                return
            
            # IBKR'den pozisyonlarƒ± al (√∂ncelik: native)
            positions = []
            try:
                if self.ibkr_native.is_connected():
                    positions = self.ibkr_native.get_positions()
            except Exception:
                positions = []
            if not positions:
                try:
                    if self.ibkr.is_connected():
                        positions = self.ibkr.get_positions()
                except Exception:
                    positions = []
            if not positions:
                print(f"[BEFIB] WARN Pozisyon verisi alinmadi")
                return
            position_data = []
            for pos in positions:
                symbol = pos.get('symbol', '')
                qty = pos.get('qty', None)
                if qty is None:
                    qty = pos.get('quantity', 0)
                avg_cost = pos.get('avg_cost', None)
                if avg_cost is None:
                    avg_cost = pos.get('average_price', 0.0)
                market_price = pos.get('market_price', None)
                market_value = pos.get('market_value', None)
                if market_value is None:
                    try:
                        price = market_price if market_price not in (None, 0) else avg_cost
                        market_value = float(qty) * float(price)
                    except Exception:
                        market_value = 0.0
                unreal = pos.get('unrealized_pnl', pos.get('unrealizedPnL', 0.0))
                realized = pos.get('realized_pnl', pos.get('realizedPnL', 0.0))
                position_data.append({
                    'Symbol': symbol,
                    'Quantity': qty,
                    'AveragePrice': avg_cost,
                    'MarketValue': market_value,
                    'UnrealizedPnL': unreal,
                    'RealizedPnL': realized,
                    'Timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                })
            df = pd.DataFrame(position_data)
            df.to_csv(filename, index=False)
            print(f"[BEFIB] OK Pozisyonlar kaydedildi: {filename} ({len(position_data)} pozisyon)")
        except Exception as e:
            print(f"[BEFIB] ERROR befib csv calistirma hatasi: {e}")
    
    def start_psfalgo_robot(self):
        """Psfalgo robotunu ba≈ülat"""
        try:
            print("[PSFALGO] ü§ñ Robot ba≈ülatƒ±lƒ±yor...")
            
            # Eƒüer pencere zaten a√ßƒ±ksa, √∂nce kapat
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        self.psfalgo_window.destroy()
                except:
                    pass
            
            # Robot penceresi olu≈ütur
            self.psfalgo_window = tk.Toplevel(self)
            self.psfalgo_window.title("Psfalgo Robot - Pozisyon Y√∂netimi")
            self.psfalgo_window.geometry("1000x700")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            # Minimize butonu ekle (ba≈ülƒ±k √ßubuƒüuna)
            self.psfalgo_window.attributes('-toolwindow', False)  # Minimize butonunu g√∂ster
            
            # Pencere kapatƒ±ldƒ±ƒüƒ±nda temizlik yap
            def on_closing():
                self.psfalgo_running = False
                self.psfalgo_window.destroy()
                self.psfalgo_window = None
            
            self.psfalgo_window.protocol("WM_DELETE_WINDOW", on_closing)
            
            # Robot durumu
            self.psfalgo_running = False
            self.psfalgo_positions = {}  # Pozisyon takibi
            self.psfalgo_trades = {}     # Trade takibi (3 saatlik kontrol i√ßin)
            self.controller_enabled = False  # Controller modu (ON/OFF)
            self.excluded_tickers = set()  # Excluded ticker'lar (RUNALL ve diƒüer fonksiyonlar i√ßin)
            self.runall_allowed_mode = False  # RUNALL Allowed modu (otomatik onay)
            self.runall_loop_running = False  # RUNALL d√∂ng√ºs√º √ßalƒ±≈üƒ±yor mu
            self.runall_loop_count = 0  # RUNALL d√∂ng√º sayacƒ±
            
            # Benchmark shift deƒüeri (General BM Shifter i√ßin)
            # CSV'den y√ºkle, yoksa 0.0 default
            self.load_benchmark_shift_from_csv()
            
            # Excluded ticker'larƒ± CSV'den y√ºkle
            self.load_excluded_tickers_from_csv()
            
            # Kurallarƒ± CSV'den y√ºkle (varsayƒ±lan deƒüerler)
            self.rule_max_change_multiplier = 0.75  # MAXALW * bu deƒüer = Max Change
            self.rule_single_max_position_multiplier = 1.0  # MAXALW * bu deƒüer = Tek pozisyon limiti
            self.rule_avg_adv_divisor = 10  # AVG_ADV / bu deƒüer = MAXALW
            self.rule_min_lot = 400  # Minimum lot deƒüeri
            
            # ADDNEWPOS Kurallarƒ± (Pozisyon Artƒ±rma)
            # Format: {e≈üik_y√ºzdesi: (maxalw_carpani, portfoy_yuzde_limiti)}
            self.addnewpos_rules = {
                1: (0.50, 5.0),    # < %1: MAXALW√ó0.50, Portf√∂y√ó%5
                3: (0.40, 4.0),    # %1-2.99: MAXALW√ó0.40, Portf√∂y√ó%4
                5: (0.30, 3.0),    # %3-4.99: MAXALW√ó0.30, Portf√∂y√ó%3
                7: (0.20, 2.0),    # %5-6.99: MAXALW√ó0.20, Portf√∂y√ó%2
                10: (0.10, 1.5),   # %7-9.99: MAXALW√ó0.10, Portf√∂y√ó%1.5
                100: (0.05, 1.0)   # >= %10: MAXALW√ó0.05, Portf√∂y√ó%1
            }
            
            # KARBOTU/REDUCEMORE Kurallarƒ± (Pozisyon Azaltma)
            # Format: {e≈üik_y√ºzdesi: (maxalw_carpani, befday_carpani)}
            # None = sƒ±nƒ±rsƒ±z
            self.reduce_rules = {
                3: (None, None),    # < %3: Sƒ±nƒ±rsƒ±z (ama ters poz. yasak)
                5: (0.75, 0.75),    # %3-4.99: MAXALW√ó0.75, BefQty√ó0.75
                7: (0.60, 0.60),    # %5-6.99: MAXALW√ó0.60, BefQty√ó0.60
                10: (0.50, 0.50),   # %7-9.99: MAXALW√ó0.50, BefQty√ó0.50
                100: (0.40, 0.40)   # >= %10: MAXALW√ó0.40, BefQty√ó0.40
            }
            
            self.load_rules_from_csv()
            
            # Emir cache'i (60 saniyede bir g√ºncellenecek)
            import time
            self.orders_cache = []
            self.orders_cache_time = time.time() - 61  # ƒ∞lk √ßaƒürƒ±da hemen g√ºncellensin
            self.orders_cache_interval = 60  # 60 saniye
            
            # Pozisyonlar i√ßin cache
            self.positions_cache = {}  # {account: positions_list}
            self.positions_cache_time = {}  # {account: timestamp}
            
            # GORT hesaplamalarƒ± i√ßin cache (grup dosyalarƒ± ve ortalamalar)
            self.gort_cache = {}  # {symbol: gort_value}
            self.group_avg_cache = {}  # {(group, cgrup, 'sma63' or 'sma246'): avg_value}
            self.group_file_cache = {}  # {group: DataFrame} - Grup dosyalarƒ±nƒ± cache'le
            self.gort_cache_time = time.time() - 61  # ƒ∞lk √ßaƒürƒ±da hemen g√ºncellensin
            self.gort_cache_interval = 300  # 5 dakika (300 saniye) - Grup dosyalarƒ± nadiren deƒüi≈üir
            
            self.setup_psfalgo_ui()
            
            # JFIN filtrelerini CSV'den y√ºkle (UI olu≈üturulduktan sonra)
            self.load_psfalgo_filters_from_csv()
            
            # ƒ∞lk cache g√ºncellemesini yap (asenkron olarak)
            self.psfalgo_window.after(1000, self.get_cached_orders)  # 1 saniye sonra ilk g√ºncelleme
            
        except Exception as e:
            print(f"[PSFALGO] ‚ùå Robot ba≈ülatma hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Psfalgo robot ba≈ülatƒ±lamadƒ±: {e}")
    
    def setup_psfalgo_ui(self):
        """Psfalgo robot UI'ƒ±nƒ± olu≈ütur"""
        # Ba≈ülƒ±k ve kontrol butonlarƒ± frame
        title_frame = ttk.Frame(self.psfalgo_window)
        title_frame.pack(fill='x', padx=10, pady=5)
        
        # Ba≈ülƒ±k
        title_label = ttk.Label(title_frame, text="Psfalgo Robot - Pozisyon Y√∂netimi", 
                               font=("Arial", 14, "bold"))
        title_label.pack(side='left')
        
        # Saƒü √ºst frame (filtreler ve kontroller i√ßin)
        right_top_frame = ttk.Frame(title_frame)
        right_top_frame.pack(side='right')
        
        # JFIN Filtreleri √ßer√ßevesi (saƒü √ºste, kompakt)
        filters_frame = ttk.LabelFrame(right_top_frame, text="üîç JFIN Filtreleri", padding=5)
        filters_frame.pack(side='left', padx=5)
        
        # Long Filters (BB ve FB i√ßin) - kompakt tek satƒ±r
        long_filters_frame = ttk.Frame(filters_frame)
        long_filters_frame.pack(fill='x', padx=2, pady=2)
        
        ttk.Label(long_filters_frame, text="Long:", font=("Arial", 8, "bold")).pack(side='left', padx=2)
        # Long SMA63 Chg
        ttk.Label(long_filters_frame, text="SMA:", font=("Arial", 7)).pack(side='left', padx=1)
        self.long_sma_filter_var = tk.StringVar(value="-1.6")
        self.long_sma_filter_entry = ttk.Entry(long_filters_frame, textvariable=self.long_sma_filter_var, width=6)
        self.long_sma_filter_entry.pack(side='left', padx=1)
        self.long_sma_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(long_filters_frame, text="<", variable=self.long_sma_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(long_filters_frame, text=">", variable=self.long_sma_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Long FBtot
        ttk.Label(long_filters_frame, text="FBtot:", font=("Arial", 7)).pack(side='left', padx=1)
        self.long_fbtot_filter_var = tk.StringVar(value="")
        self.long_fbtot_filter_entry = ttk.Entry(long_filters_frame, textvariable=self.long_fbtot_filter_var, width=6)
        self.long_fbtot_filter_entry.pack(side='left', padx=1)
        self.long_fbtot_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(long_filters_frame, text="<", variable=self.long_fbtot_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(long_filters_frame, text=">", variable=self.long_fbtot_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Long Gort
        ttk.Label(long_filters_frame, text="Gort:", font=("Arial", 7)).pack(side='left', padx=1)
        self.long_gort_filter_var = tk.StringVar(value="")
        self.long_gort_filter_entry = ttk.Entry(long_filters_frame, textvariable=self.long_gort_filter_var, width=6)
        self.long_gort_filter_entry.pack(side='left', padx=1)
        self.long_gort_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(long_filters_frame, text="<", variable=self.long_gort_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(long_filters_frame, text=">", variable=self.long_gort_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Short Filters (SAS ve SFS i√ßin) - kompakt tek satƒ±r
        short_filters_frame = ttk.Frame(filters_frame)
        short_filters_frame.pack(fill='x', padx=2, pady=2)
        
        ttk.Label(short_filters_frame, text="Short:", font=("Arial", 8, "bold")).pack(side='left', padx=2)
        # Short SMA63 Chg
        ttk.Label(short_filters_frame, text="SMA:", font=("Arial", 7)).pack(side='left', padx=1)
        self.short_sma_filter_var = tk.StringVar(value="")
        self.short_sma_filter_entry = ttk.Entry(short_filters_frame, textvariable=self.short_sma_filter_var, width=6)
        self.short_sma_filter_entry.pack(side='left', padx=1)
        self.short_sma_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(short_filters_frame, text="<", variable=self.short_sma_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(short_filters_frame, text=">", variable=self.short_sma_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Short SFStot
        ttk.Label(short_filters_frame, text="SFStot:", font=("Arial", 7)).pack(side='left', padx=1)
        self.short_sfstot_filter_var = tk.StringVar(value="")
        self.short_sfstot_filter_entry = ttk.Entry(short_filters_frame, textvariable=self.short_sfstot_filter_var, width=6)
        self.short_sfstot_filter_entry.pack(side='left', padx=1)
        self.short_sfstot_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(short_filters_frame, text="<", variable=self.short_sfstot_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(short_filters_frame, text=">", variable=self.short_sfstot_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Short Gort
        ttk.Label(short_filters_frame, text="Gort:", font=("Arial", 7)).pack(side='left', padx=1)
        self.short_gort_filter_var = tk.StringVar(value="")
        self.short_gort_filter_entry = ttk.Entry(short_filters_frame, textvariable=self.short_gort_filter_var, width=6)
        self.short_gort_filter_entry.pack(side='left', padx=1)
        self.short_gort_filter_type = tk.StringVar(value="below")
        ttk.Radiobutton(short_filters_frame, text="<", variable=self.short_gort_filter_type, value="below", width=2).pack(side='left', padx=0)
        ttk.Radiobutton(short_filters_frame, text=">", variable=self.short_gort_filter_type, value="above", width=2).pack(side='left', padx=0)
        
        # Filtreleri Kaydet butonu
        save_filters_btn = ttk.Button(filters_frame, text="üíæ Kaydet", width=8,
                                     command=self.show_save_filters_dialog)
        save_filters_btn.pack(side='left', padx=5, pady=2)
        
        # Pencere kontrol butonlarƒ± (saƒü √ºst)
        window_controls = ttk.Frame(right_top_frame)
        window_controls.pack(side='left', padx=5)
        
        # Alta Al (Minimize) butonu
        minimize_btn = ttk.Button(window_controls, text="üóï Alta Al", width=10,
                                  command=lambda: self.psfalgo_window.iconify())
        minimize_btn.pack(side='left', padx=2)
        
        # Exposure ayarlarƒ± √ßer√ßevesi
        exposure_frame = ttk.LabelFrame(self.psfalgo_window, text="üí∞ Exposure Ayarlarƒ±", padding=10)
        exposure_frame.pack(fill='x', padx=10, pady=5)
        
        # Exposure limit input
        ttk.Label(exposure_frame, text="Exposure Limit ($):").grid(row=0, column=0, padx=5, pady=5, sticky='w')
        self.exposure_limit_var = tk.StringVar(value="1200000")  # Default 1.2M
        ttk.Entry(exposure_frame, textvariable=self.exposure_limit_var, width=15).grid(row=0, column=1, padx=5, pady=5, sticky='w')
        
        # Ortalama hisse fiyatƒ±
        ttk.Label(exposure_frame, text="Ortalama Hisse Fiyatƒ± ($):").grid(row=0, column=2, padx=5, pady=5, sticky='w')
        self.avg_price_var = tk.StringVar(value="22")  # Default 22
        ttk.Entry(exposure_frame, textvariable=self.avg_price_var, width=10).grid(row=0, column=3, padx=5, pady=5, sticky='w')
        
        # Butonlar i√ßin yeni frame (Ortalama Hisse Fiyatƒ±'nƒ±n yanƒ±nda)
        buttons_frame = ttk.Frame(exposure_frame)
        buttons_frame.grid(row=0, column=4, rowspan=2, padx=10, pady=5, sticky='nw')
        
        # Butonlarƒ± grid olarak d√ºzenle (2 satƒ±r x 3 kolon)
        # ƒ∞lk satƒ±r
        self.controller_btn = ttk.Button(buttons_frame, text="üéõÔ∏è Controller: OFF", 
                                         command=self.toggle_controller, 
                                         style='Accent.TButton', width=15)
        self.controller_btn.grid(row=0, column=0, padx=2, pady=2, sticky='ew')
        
        self.karbotu_btn = ttk.Button(buttons_frame, text="üéØ KARBOTU", 
                                     command=self.start_karbotu_automation, 
                                     style='Accent.TButton', width=15)
        self.karbotu_btn.grid(row=0, column=1, padx=2, pady=2, sticky='ew')
        
        self.reducemore_btn = ttk.Button(buttons_frame, text="üìâ REDUCEMORE", 
                                         command=self.start_reducemore_automation, 
                                         style='Accent.TButton', width=15)
        self.reducemore_btn.grid(row=0, column=2, padx=2, pady=2, sticky='ew')
        
        # ƒ∞kinci satƒ±r
        self.excluder_btn = ttk.Button(buttons_frame, text="üö´ Excluder", 
                                       command=self.show_excluder_dialog, 
                                       style='Accent.TButton', width=15)
        self.excluder_btn.grid(row=1, column=0, padx=2, pady=2, sticky='ew')
        
        self.addnewpos_btn = ttk.Button(buttons_frame, text="‚ûï ADDNEWPOS", 
                                       command=self.start_addnewpos_automation, 
                                       style='Accent.TButton', width=15)
        self.addnewpos_btn.grid(row=1, column=1, padx=2, pady=2, sticky='ew')
        
        self.bm_shifter_btn = ttk.Button(buttons_frame, text="üìä BM Shifter", 
                                        command=self.show_bm_shifter_dialog, 
                                        style='Accent.TButton', width=15)
        self.bm_shifter_btn.grid(row=1, column=2, padx=2, pady=2, sticky='ew')
        
        # √ú√ß√ºnc√º satƒ±r - Kurallar butonu
        self.kurallar_btn = ttk.Button(buttons_frame, text="üìã Kurallar", 
                                       command=self.show_rules_dialog, 
                                       style='Accent.TButton', width=15)
        self.kurallar_btn.grid(row=2, column=0, padx=2, pady=2, sticky='ew')
        
        # D√∂rd√ºnc√º satƒ±r - Croplit butonlarƒ±
        self.croplit6_btn = ttk.Button(buttons_frame, text="üî™ Croplit6", 
                                      command=self.execute_croplit6, 
                                      style='Accent.TButton', width=15)
        self.croplit6_btn.grid(row=3, column=0, padx=2, pady=2, sticky='ew')
        
        self.croplit9_btn = ttk.Button(buttons_frame, text="üî™ Croplit9", 
                                      command=self.execute_croplit9, 
                                      style='Accent.TButton', width=15)
        self.croplit9_btn.grid(row=3, column=1, padx=2, pady=2, sticky='ew')
        
        # Be≈üinci satƒ±r - ADDNEWPOS Mod radio butonlarƒ±
        self.addnewpos_mode_var = tk.StringVar(value="addlong_only")  # Varsayƒ±lan: addlong only
        
        addmode_frame = ttk.Frame(buttons_frame)
        addmode_frame.grid(row=4, column=0, columnspan=3, padx=2, pady=5, sticky='w')
        
        ttk.Label(addmode_frame, text="ADDNEWPOS Mod:", font=("Arial", 9, "bold")).pack(side='left', padx=(0, 5))
        
        # addlong only butonu (varsayƒ±lan se√ßili)
        self.btn_addlong_only = ttk.Radiobutton(addmode_frame, text="üìà AddLong Only", 
                                                variable=self.addnewpos_mode_var, 
                                                value="addlong_only",
                                                command=self.on_addnewpos_mode_changed)
        self.btn_addlong_only.pack(side='left', padx=3)
        
        # addshort only butonu
        self.btn_addshort_only = ttk.Radiobutton(addmode_frame, text="üìâ AddShort Only", 
                                                 variable=self.addnewpos_mode_var, 
                                                 value="addshort_only",
                                                 command=self.on_addnewpos_mode_changed)
        self.btn_addshort_only.pack(side='left', padx=3)
        
        # addboth butonu
        self.btn_addboth = ttk.Radiobutton(addmode_frame, text="üîÑ AddBoth", 
                                           variable=self.addnewpos_mode_var, 
                                           value="addboth",
                                           command=self.on_addnewpos_mode_changed)
        self.btn_addboth.pack(side='left', padx=3)
        
        # Grid kolonlarƒ±nƒ± e≈üit geni≈ülikte yap
        buttons_frame.columnconfigure(0, weight=1)
        buttons_frame.columnconfigure(1, weight=1)
        buttons_frame.columnconfigure(2, weight=1)
        
        # Pot Expo Limit input (yeni)
        ttk.Label(exposure_frame, text="Pot Expo Limit ($):").grid(row=1, column=0, padx=5, pady=5, sticky='w')
        self.pot_expo_limit_var = tk.StringVar(value="1400000")  # Default 1.4M
        ttk.Entry(exposure_frame, textvariable=self.pot_expo_limit_var, width=15).grid(row=1, column=1, padx=5, pady=5, sticky='w')
        
        # Hesaplanan max lot
        self.max_lot_label = ttk.Label(exposure_frame, text="Max Lot: 54,545", font=("Arial", 10, "bold"), foreground='green')
        self.max_lot_label.grid(row=2, column=0, columnspan=4, padx=5, pady=5, sticky='w')
        
        # Pot Max Lot (yeni)
        self.pot_max_lot_label = ttk.Label(exposure_frame, text="Pot Max Lot: 63,636", font=("Arial", 10, "bold"), foreground='purple')
        self.pot_max_lot_label.grid(row=3, column=0, columnspan=4, padx=5, pady=5, sticky='w')
        
        # Defansif/Ofansif e≈üik bilgisi
        self.threshold_label = ttk.Label(exposure_frame, text="Defansif E≈üik: 52,545 lot | Ofansif D√∂n√º≈ü: 50,909 lot", 
                                        font=("Arial", 9), foreground='blue')
        self.threshold_label.grid(row=4, column=0, columnspan=4, padx=5, pady=5, sticky='w')
        
        # Mevcut lot bilgisi
        self.current_lot_label = ttk.Label(exposure_frame, text="Mevcut Lot: 0 | Mode: -", 
                                          font=("Arial", 10, "bold"), foreground='red')
        self.current_lot_label.grid(row=5, column=0, columnspan=4, padx=5, pady=5, sticky='w')
        
        # Deƒüi≈üiklikleri hesapla
        def calculate_exposure():
            try:
                exposure_limit = float(self.exposure_limit_var.get())
                pot_expo_limit = float(self.pot_expo_limit_var.get())
                avg_price = float(self.avg_price_var.get())
                
                max_lot = int(exposure_limit / avg_price)
                pot_max_lot = int(pot_expo_limit / avg_price)
                defensive_threshold = int(max_lot * 0.955)  # %95.5
                offensive_threshold = int(max_lot * 0.927)  # %92.7
                
                self.max_lot_label.config(text=f"Max Lot: {max_lot:,}")
                self.pot_max_lot_label.config(text=f"Pot Max Lot: {pot_max_lot:,}")
                self.threshold_label.config(text=f"Defansif E≈üik: {defensive_threshold:,} lot | Ofansif D√∂n√º≈ü: {offensive_threshold:,} lot")
            except ValueError:
                pass
        
        self.exposure_limit_var.trace('w', lambda *args: calculate_exposure())
        self.pot_expo_limit_var.trace('w', lambda *args: calculate_exposure())
        self.avg_price_var.trace('w', lambda *args: calculate_exposure())
        calculate_exposure()
        
        # Kontrol butonlarƒ±
        control_frame = ttk.Frame(self.psfalgo_window)
        control_frame.pack(fill='x', padx=10, pady=5)
        
        self.start_btn = ttk.Button(control_frame, text="Robot Ba≈ülat", 
                                   command=self.start_psfalgo_monitoring)
        self.start_btn.pack(side='left', padx=5)
        
        self.stop_btn = ttk.Button(control_frame, text="Robot Durdur", 
                                  command=self.stop_psfalgo_monitoring, state='disabled')
        self.stop_btn.pack(side='left', padx=5)
        
        # RUNALL butonu
        self.runall_btn = ttk.Button(control_frame, text="‚ñ∂Ô∏è RUNALL", 
                                     command=self.run_all_sequence, 
                                     style='Accent.TButton')
        self.runall_btn.pack(side='left', padx=5)
        
        # RUNALL DURDUR butonu (ba≈ülangƒ±√ßta gizli)
        self.runall_stop_btn = ttk.Button(control_frame, text="‚èπÔ∏è RUNALL DURDUR", 
                                          command=self.stop_runall_loop, 
                                          style='Danger.TButton',
                                          state='disabled')
        self.runall_stop_btn.pack(side='left', padx=5)
        
        # RUNALL d√∂ng√º sayacƒ± label'ƒ±
        self.runall_loop_label = ttk.Label(control_frame, 
                                          text="D√∂ng√º: 0", 
                                          font=("Arial", 11, "bold"), 
                                          foreground='blue')
        self.runall_loop_label.pack(side='left', padx=10)
        
        # Allowed checkbox - RUNALL modunda otomatik onay i√ßin
        self.runall_allowed_var = tk.BooleanVar(value=False)
        self.runall_allowed_checkbox = ttk.Checkbutton(control_frame, 
                                                       text="‚úÖ Allowed (Otomatik Onay)", 
                                                       variable=self.runall_allowed_var)
        self.runall_allowed_checkbox.pack(side='left', padx=5)
        
        # Lot B√∂l√ºc√º checkbox - RUNALL modunda otomatik Lot B√∂l√ºc√º a√ßma i√ßin
        self.runall_lot_divider_var = tk.BooleanVar(value=False)
        self.runall_lot_divider_checkbox = ttk.Checkbutton(control_frame, 
                                                           text="üì¶ Lot B√∂l√ºc√º (Otomatik A√ß)", 
                                                           variable=self.runall_lot_divider_var)
        self.runall_lot_divider_checkbox.pack(side='left', padx=5)
        
        # BM Shift deƒüeri g√∂sterimi
        current_shift = getattr(self, 'benchmark_shift', 0.0)
        self.bm_shift_label = ttk.Label(control_frame, text=f"BM Shift: {current_shift:.4f}", 
                                       font=("Arial", 9), foreground='blue')
        self.bm_shift_label.pack(side='left', padx=5)
        
        # Excluded ticker'larƒ± sakla
        self.excluded_tickers = set()  # Set olarak sakla (hƒ±zlƒ± arama i√ßin)
        
        # Durum etiketi
        self.status_label = ttk.Label(control_frame, text="Durum: Durduruldu", 
                                     font=("Arial", 10))
        self.status_label.pack(side='right', padx=5)
        
        # Pozisyon tablosu
        table_frame = ttk.Frame(self.psfalgo_window)
        table_frame.pack(fill='both', expand=True, padx=10, pady=5)
        
        # Tablo kolonlarƒ± - Befday Cost, Todays Cost, Last Price eklendi
        columns = ('Symbol', 'Current Qty', 'Potential Qty', 'Befday Cost', 'Todays Cost', 'Last Price', 'Befday Qty', 'Todays Qty Chg', 'Pozisyon Deƒüi≈üikliƒüi', 'Max Change', 'MAXALW', '3H Change', 'Open Orders', 'Max Add Long', 'Max Add Short', 'Status')
        self.psfalgo_tree = ttk.Treeview(table_frame, columns=columns, show='headings', height=15)
        
        # Kolon geni≈ülikleri - her kolon i√ßin √∂zel geni≈ülik
        column_widths = {
            'Symbol': 90,
            'Current Qty': 85,
            'Potential Qty': 85,
            'Befday Cost': 85,
            'Todays Cost': 85,
            'Last Price': 80,
            'Befday Qty': 80,
            'Todays Qty Chg': 90,
            'Pozisyon Deƒüi≈üikliƒüi': 120,
            'Max Change': 85,
            'MAXALW': 70,
            '3H Change': 75,
            'Open Orders': 80,
            'Max Add Long': 90,
            'Max Add Short': 90,
            'Status': 130
        }
        
        for col in columns:
            self.psfalgo_tree.heading(col, text=col)
            self.psfalgo_tree.column(col, width=column_widths.get(col, 80))
        
        # Scrollbar
        scrollbar = ttk.Scrollbar(table_frame, orient='vertical', command=self.psfalgo_tree.yview)
        self.psfalgo_tree.configure(yscrollcommand=scrollbar.set)
        
        self.psfalgo_tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        # Log alanƒ±
        log_frame = ttk.LabelFrame(self.psfalgo_window, text="Robot Loglarƒ±")
        log_frame.pack(fill='x', padx=10, pady=5)
        
        self.log_text = tk.Text(log_frame, height=8, width=100)
        log_scrollbar = ttk.Scrollbar(log_frame, orient='vertical', command=self.log_text.yview)
        self.log_text.configure(yscrollcommand=log_scrollbar.set)
        
        self.log_text.pack(side='left', fill='both', expand=True)
        log_scrollbar.pack(side='right', fill='y')
        
        # ƒ∞lk pozisyon verilerini y√ºkle
        self.load_psfalgo_positions()
        
        # ƒ∞lk exposure kontrol√ºn√º yap (robot ba≈ülamadan √∂nce bile g√∂ster)
        try:
            exposure_info = self.check_exposure_limits()
            if exposure_info.get('mode') == 'ERROR':
                self.current_lot_label.config(text="Baƒülantƒ± bekleniyor...", foreground='orange')
        except Exception as e:
            self.log_message(f"‚ö†Ô∏è ƒ∞lk exposure kontrol√º yapƒ±lamadƒ±: {e}")
    
    def load_psfalgo_positions(self):
        """Psfalgo i√ßin pozisyon verilerini y√ºkle - Aktif moda g√∂re"""
        try:
            # Aktif modu kontrol et
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            self.log_message(f"üîÑ Aktif mod: {active_account} - Pozisyonlar √ßekiliyor...")
            
            # Aktif hesaptan pozisyonlarƒ± al
            positions = []
            if active_account in ["IBKR_GUN", "IBKR_PED"]:
                # IBKR mod - IBKR pozisyonlarƒ±nƒ± al (GUN veya PED)
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                    positions = self.mode_manager.ibkr_native_client.get_positions()
                    self.log_message(f"‚úÖ IBKR Native'dan {len(positions)} pozisyon alƒ±ndƒ± ({active_account})")
                elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                    positions = self.mode_manager.ibkr_client.get_positions()
                    self.log_message(f"‚úÖ IBKR Client'dan {len(positions)} pozisyon alƒ±ndƒ± ({active_account})")
                else:
                    self.log_message(f"‚ùå IBKR baƒülantƒ±sƒ± yok! ({active_account}) L√ºtfen √∂nce baƒülanƒ±n.")
                    return
            else:  # HAMPRO
                # HAMPRO mod - Hammer Pro pozisyonlarƒ±nƒ± al
                if self.hammer and self.hammer.connected:
                    positions = self.hammer.get_positions_direct()
                    self.log_message(f"‚úÖ HAMPRO'dan {len(positions)} pozisyon alƒ±ndƒ±")
                    # Debug: Pozisyon yapƒ±sƒ±nƒ± logla
                    if positions:
                        self.log_message(f"üîç ƒ∞lk pozisyon √∂rneƒüi: {positions[0]}")
                    else:
                        self.log_message("‚ö†Ô∏è HAMPRO'dan pozisyon d√∂nd√º ama liste bo≈ü!")
                else:
                    self.log_message("‚ùå HAMPRO baƒülantƒ±sƒ± yok! L√ºtfen √∂nce baƒülanƒ±n.")
                    return
            
            if not positions:
                self.log_message("‚ö†Ô∏è Pozisyon bulunamadƒ±!")
                return
            
            # Pozisyonlarƒ± DataFrame'e √ßevir
            position_data = []
            for pos in positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '') or pos.get('ticker', '') or pos.get('Ticker', '')
                qty = pos.get('qty', None) or pos.get('quantity', None) or pos.get('Quantity', None) or pos.get('qty', None)
                
                # Debug log
                if not symbol:
                    self.log_message(f"‚ö†Ô∏è Pozisyon'da symbol bulunamadƒ±: {pos}")
                    continue
                
                if qty is None:
                    self.log_message(f"‚ö†Ô∏è {symbol}: qty None, 0 olarak ayarlandƒ±")
                    qty = 0
                
                try:
                    qty_float = float(qty)
                    if qty_float != 0:  # Sadece 0 olmayan pozisyonlarƒ± ekle
                        position_data.append({
                            'Symbol': symbol,
                            'Quantity': qty_float
                        })
                        self.log_message(f"‚úÖ {symbol}: {qty_float:.0f} lot eklendi")
                except (ValueError, TypeError) as e:
                    self.log_message(f"‚ö†Ô∏è {symbol}: qty parse edilemedi: {qty} - {e}")
                    continue
            
            if not position_data:
                self.log_message("‚ö†Ô∏è Pozisyon verisi parse edilemedi veya t√ºm pozisyonlar 0!")
                self.log_message(f"üîç Toplam {len(positions)} pozisyon geldi ama parse edilemedi")
                return
            
            df = pd.DataFrame(position_data)
            
            # Tabloyu temizle
            for item in self.psfalgo_tree.get_children():
                self.psfalgo_tree.delete(item)
            
            # Pozisyonlarƒ± tabloya ekle
            for _, row in df.iterrows():
                symbol = row['Symbol']
                quantity = row['Quantity']
                
                # G√ºn ba≈üƒ± pozisyonu al (befib/befham'dan)
                befday_qty = self.load_bef_position(symbol)
                
                # Bug√ºnk√º deƒüi≈üim hesapla
                todays_qty_chg = quantity - befday_qty
                
                # MAXALW deƒüerini al (AVG_ADV / rule_avg_adv_divisor)
                maxalw = self.get_maxalw_for_symbol(symbol)
                # Max Change = MAXALW * rule_max_change_multiplier (varsayƒ±lan 0.75)
                multiplier = getattr(self, 'rule_max_change_multiplier', 0.75)
                max_change = int(maxalw * multiplier) if maxalw > 0 else 0
                
                # Short pozisyonlarƒ± eksi ile g√∂ster
                display_quantity = f"{quantity:.0f}" if quantity >= 0 else f"{quantity:.0f}"
                
                # A√ßƒ±k emirleri kontrol et
                open_orders_count = self.get_open_orders_count(symbol)
                
                # Emir analizi yap
                order_analysis = self.analyze_order_impact(symbol, quantity)
                
                # Yeni kolonlar: Befday Cost, Todays Cost, Last Price
                befday_cost = self.get_prev_close_for_psfalgo(symbol)
                todays_cost = self.get_todays_cost_for_psfalgo(symbol, quantity, befday_qty)
                last_price = self.get_last_price_for_psfalgo(symbol)
                
                # Pozisyon deƒüi≈üikliƒüi hesapla
                position_change = self.calculate_position_change(befday_qty, todays_qty_chg)
                
                self.psfalgo_tree.insert('', 'end', values=[
                    symbol,
                    display_quantity,
                    f"{order_analysis['potential_position']:.0f}",  # Potansiyel pozisyon
                    f"${befday_cost:.2f}" if befday_cost > 0 else "N/A",  # Befday Cost (prev_close)
                    f"${todays_cost:.2f}" if todays_cost > 0 else "",  # Todays Cost (bug√ºnk√º ortalama maliyet)
                    f"${last_price:.2f}" if last_price > 0 else "N/A",  # Last Price
                    f"{befday_qty:.0f}",  # Befday Qty
                    f"{todays_qty_chg:+.0f}",  # Todays Qty Chg (artƒ±/eksi ile)
                    position_change,  # Pozisyon Deƒüi≈üikliƒüi
                    f"{max_change}",  # Max Change (MAXALW √ó multiplier)
                    f"{maxalw:.0f}",  # MAXALW
                    "0",  # 3 saatlik deƒüi≈üim
                    f"{open_orders_count}",  # A√ßƒ±k emir sayƒ±sƒ±
                    f"{order_analysis['max_additional_long']:.0f}",  # Max ek long
                    f"{order_analysis['max_additional_short']:.0f}",  # Max ek short
                    "Hazƒ±r"
                ])
                
                # Pozisyon verilerini sakla
                self.psfalgo_positions[symbol] = {
                    'quantity': quantity,
                    'befday_qty': befday_qty,
                    'todays_qty_chg': todays_qty_chg,
                    'maxalw': maxalw,
                    'max_change': max_change,
                    'three_hour_change': 0,
                    'last_trade_time': None,
                    'befday_cost': befday_cost,
                    'todays_cost': todays_cost,
                    'last_price': last_price
                }
            
            self.log_message(f"‚úÖ {len(df)} pozisyon y√ºklendi")
            
        except Exception as e:
            self.log_message(f"‚ùå Pozisyon y√ºkleme hatasƒ±: {e}")
    
    def calculate_position_change(self, befday_qty, todays_qty_chg):
        """
        Pozisyon deƒüi≈üikliƒüi tipini hesapla
        
        Args:
            befday_qty: G√ºn ba≈üƒ± pozisyon miktarƒ±
            todays_qty_chg: Bug√ºnk√º pozisyon deƒüi≈üikliƒüi
            
        Returns:
            str: "Long Arttƒ±rma", "Long Azaltma", "Short Arttƒ±rma", "Short Azaltma"
        """
        try:
            befday_qty = float(befday_qty) if befday_qty else 0.0
            todays_qty_chg = float(todays_qty_chg) if todays_qty_chg else 0.0
            
            # √ñzel durum: Befday Qty = 0
            if befday_qty == 0:
                if todays_qty_chg > 0:
                    return "Long Arttƒ±rma"
                elif todays_qty_chg < 0:
                    return "Short Arttƒ±rma"
                else:
                    return "-"
            
            # Befday Qty pozitif (Long pozisyon)
            if befday_qty > 0:
                if todays_qty_chg > 0:
                    return "Long Arttƒ±rma"
                elif todays_qty_chg < 0:
                    return "Long Azaltma"
                else:
                    return "-"
            
            # Befday Qty negatif (Short pozisyon)
            elif befday_qty < 0:
                if todays_qty_chg < 0:  # Negatif deƒüi≈üiklik = daha negatif = short arttƒ±rma
                    return "Short Arttƒ±rma"
                elif todays_qty_chg > 0:  # Pozitif deƒüi≈üiklik = daha az negatif = short azaltma
                    return "Short Azaltma"
                else:
                    return "-"
            
            return "-"
            
        except Exception as e:
            print(f"[PSFALGO] ‚ùå Pozisyon deƒüi≈üikliƒüi hesaplama hatasƒ±: {e}")
            return "-"
    
    def get_maxalw_for_symbol(self, symbol):
        """Hisse i√ßin MAXALW deƒüerini al (AVG_ADV / rule_avg_adv_divisor)"""
        try:
            # AVG_ADV deƒüerini al
            avg_adv = self.get_avg_adv_from_csv(symbol)
            
            # Kural deƒüerini al (varsayƒ±lan 10)
            divisor = getattr(self, 'rule_avg_adv_divisor', 10)
            
            # MAXALW = AVG_ADV / divisor
            maxalw = avg_adv / divisor if avg_adv > 0 else 0
            
            return maxalw
        except Exception as e:
            print(f"[PSFALGO] ‚ùå {symbol} MAXALW hesaplama hatasƒ±: {e}")
            return 0
    
    def get_prev_close_for_psfalgo(self, symbol):
        """Psfalgo i√ßin previous close deƒüerini al (Befday Cost)"""
        try:
            # √ñnce prev_close_cache'den al
            if hasattr(self, 'prev_close_cache') and symbol in self.prev_close_cache:
                return self.prev_close_cache[symbol]
            
            # Cache yoksa CSV'lerden y√ºkle
            self.load_prev_close_from_csv()
            
            if hasattr(self, 'prev_close_cache') and symbol in self.prev_close_cache:
                return self.prev_close_cache[symbol]
            
            # Hala bulunamadƒ±ysa mini450'den al
            if hasattr(self, 'stock_data_manager') and self.stock_data_manager:
                stock_data = self.stock_data_manager.get_stock_data(symbol)
                if stock_data and 'prev_close' in stock_data:
                    prev_close = stock_data.get('prev_close', 0)
                    if prev_close > 0:
                        return prev_close
            
            return 0
        except Exception as e:
            print(f"[PSFALGO] ‚ùå {symbol} prev_close alma hatasƒ±: {e}")
            return 0
    
    def get_last_price_for_psfalgo(self, symbol):
        """Psfalgo i√ßin last price deƒüerini al"""
        try:
            # Hammer'dan market data al
            if hasattr(self, 'hammer') and self.hammer and self.hammer.connected:
                market_data = self.hammer.get_market_data(symbol)
                if market_data:
                    last_price = market_data.get('last', 0)
                    if last_price > 0:
                        return last_price
            
            # mini450'den al (fallback)
            if hasattr(self, 'stock_data_manager') and self.stock_data_manager:
                stock_data = self.stock_data_manager.get_stock_data(symbol)
                if stock_data:
                    last_price = stock_data.get('last', stock_data.get('Last', 0))
                    if last_price > 0:
                        return last_price
            
            return 0
        except Exception as e:
            print(f"[PSFALGO] ‚ùå {symbol} last price alma hatasƒ±: {e}")
            return 0
    
    def get_todays_cost_for_psfalgo(self, symbol, current_qty, befday_qty):
        """
        Psfalgo i√ßin bug√ºn yapƒ±lan pozisyon artƒ±rƒ±mlarƒ±nƒ±n ortalama maliyetini hesapla (Todays Cost)
        
        nfilled dosyalarƒ±ndan okur (nfilledped.csv, nfilledgun.csv, nfilledham.csv)
        
        Pozisyon artƒ±rƒ±mƒ± kontrol√º:
        - Long i√ßin: befday_qty >= 0 ve current_qty > befday_qty ise artƒ±rƒ±m var
        - Short i√ßin: befday_qty <= 0 ve current_qty < befday_qty ise short artƒ±rƒ±m var
        
        Returns:
            Todays Cost (ortalama alƒ±m/satƒ±m fiyatƒ±) veya 0 (artƒ±rƒ±m yoksa)
        """
        try:
            # Pozisyon deƒüi≈üimi
            qty_change = current_qty - befday_qty
            
            # Pozisyon artƒ±rƒ±mƒ± var mƒ± kontrol et
            # Long artƒ±rƒ±m: qty_change > 0 ve befday_qty >= 0 (veya short'tan long'a ge√ßi≈ü)
            # Short artƒ±rƒ±m: qty_change < 0 ve befday_qty <= 0 (veya long'dan short'a ge√ßi≈ü)
            
            is_long_increase = False
            is_short_increase = False
            
            if befday_qty >= 0 and current_qty > befday_qty:
                # Long pozisyon artƒ±≈üƒ±
                is_long_increase = True
            elif befday_qty <= 0 and current_qty < befday_qty:
                # Short pozisyon artƒ±≈üƒ±
                is_short_increase = True
            
            if not is_long_increase and not is_short_increase:
                # Pozisyon artƒ±rƒ±mƒ± yok (azalma veya deƒüi≈üim yok)
                return 0
            
            # nfilled dosyasƒ±ndan bug√ºnk√º i≈ülemleri al
            import pandas as pd
            import os
            from datetime import datetime
            
            filename = self.get_nfilled_filename()
            janall_dir = os.path.dirname(os.path.abspath(__file__))
            janall_dir = os.path.dirname(janall_dir)  # janallapp -> janall
            nfilled_file = os.path.join(janall_dir, filename)
            
            if not os.path.exists(nfilled_file):
                return 0
            
            df = pd.read_csv(nfilled_file, encoding='utf-8-sig')
            
            if df.empty:
                return 0
            
            # Symbol e≈üle≈ütirmesi i√ßin normalize et
            symbol_variants = [symbol]
            if '-' in symbol:
                symbol_variants.append(symbol.replace('-', ' PR'))
            elif ' PR' in symbol:
                # "F PRC" -> "F-C" formatƒ± i√ßin de kontrol et
                parts = symbol.split(' PR')
                if len(parts) == 2:
                    symbol_variants.append(f"{parts[0]}-{parts[1]}")
            
            # Symbol'e g√∂re filtrele (nfilled zaten sadece bug√ºn√ºn verilerini i√ßeriyor)
            symbol_df = df[df['symbol'].isin(symbol_variants)]
            
            if symbol_df.empty:
                return 0
            
            # Pozisyon artƒ±rƒ±mƒ± y√∂n√ºne g√∂re i≈ülemleri filtrele
            total_qty = 0
            total_value = 0
            
            for _, row in symbol_df.iterrows():
                fill_qty = abs(float(row.get('fill_qty', 0)))
                fill_price = float(row.get('fill_price', 0))
                
                if fill_qty <= 0 or fill_price <= 0:
                    continue
                
                # Action kolonundan y√∂n belirle
                action = str(row.get('action', '')).lower()
                is_buy = 'buy' in action
                is_sell = 'sell' in action
                
                if is_long_increase and is_buy:
                    # Long artƒ±rƒ±m - sadece buy i≈ülemlerini say
                    total_qty += fill_qty
                    total_value += fill_qty * fill_price
                elif is_short_increase and is_sell:
                    # Short artƒ±rƒ±m - sadece sell i≈ülemlerini say
                    total_qty += fill_qty
                    total_value += fill_qty * fill_price
            
            if total_qty > 0:
                avg_cost = total_value / total_qty
                return round(avg_cost, 2)
            
            return 0
            
        except Exception as e:
            print(f"[PSFALGO] ‚ùå {symbol} todays cost hesaplama hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return 0
    
    def load_bef_position(self, symbol):
        """befib veya befham dosyasƒ±ndan g√ºn ba≈üƒ± pozisyonu oku"""
        try:
            import pandas as pd
            import os
            
            # Aktif moda g√∂re dosya se√ß
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            if active_account == "IBKR_GUN":
                bef_file = "befibgun.csv"
            elif active_account == "IBKR_PED":
                bef_file = "befibped.csv"
            else:  # HAMPRO
                bef_file = "befham.csv"
            
            # Dosya var mƒ± kontrol et
            if not os.path.exists(bef_file):
                print(f"[CONTROLLER] ‚ö†Ô∏è {bef_file} dosyasƒ± bulunamadƒ±")
                return 0
            
            # CSV'yi oku
            df = pd.read_csv(bef_file)
            
            # Symbol kolonunu bul (Symbol veya PREF IBKR olabilir)
            symbol_col = None
            if 'Symbol' in df.columns:
                symbol_col = 'Symbol'
            elif 'PREF IBKR' in df.columns:
                symbol_col = 'PREF IBKR'
            
            if symbol_col is None:
                print(f"[CONTROLLER] ‚ö†Ô∏è {bef_file} dosyasƒ±nda Symbol kolonu bulunamadƒ±")
                return 0
            
            # Quantity kolonunu bul
            qty_col = None
            if 'Quantity' in df.columns:
                qty_col = 'Quantity'
            elif 'qty' in df.columns:
                qty_col = 'qty'
            
            if qty_col is None:
                print(f"[CONTROLLER] ‚ö†Ô∏è {bef_file} dosyasƒ±nda Quantity kolonu bulunamadƒ±")
                return 0
            
            # Symbol'√º bul
            row = df[df[symbol_col] == symbol]
            if row.empty:
                # Pozisyon yok (0 olarak d√∂nd√ºr)
                return 0
            
            # Quantity deƒüerini al
            qty = row[qty_col].iloc[0]
            return float(qty) if pd.notna(qty) else 0
            
        except Exception as e:
            print(f"[CONTROLLER] ‚ùå {symbol} BEF pozisyon okuma hatasƒ±: {e}")
            return 0
    
    # ============================================
    # NFILLED - Filled Orders Logging Sistemi
    # ============================================
    
    def get_nfilled_filename(self):
        """Aktif moda g√∂re nfilled dosya adƒ±nƒ± d√∂nd√ºr
        
        Returns:
            str: nfilledped.csv, nfilledgun.csv veya nfilledham.csv
        """
        try:
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if getattr(self, 'ibkr_ped_mode', False):
                    active_account = "IBKR_PED"
                elif getattr(self, 'ibkr_gun_mode', False):
                    active_account = "IBKR_GUN"
                elif getattr(self, 'hampro_mode', False):
                    active_account = "HAMPRO"
                else:
                    active_account = "HAMPRO"  # Varsayƒ±lan
            
            if active_account == "IBKR_PED":
                return "nfilledped.csv"
            elif active_account == "IBKR_GUN":
                return "nfilledgun.csv"
            else:  # HAMPRO
                return "nfilledham.csv"
        except Exception as e:
            print(f"[NFILLED] ‚ùå Dosya adƒ± belirleme hatasƒ±: {e}")
            return "nfilledham.csv"  # Varsayƒ±lan
    
    def check_and_reset_nfilled_for_new_day(self):
        """G√ºn deƒüi≈üikliƒüini kontrol et, yeni g√ºnse dosyayƒ± sƒ±fƒ±rla
        
        Returns:
            bool: True ise dosya sƒ±fƒ±rlandƒ± veya yeni olu≈üturuldu
        """
        try:
            import pandas as pd
            import os
            from datetime import datetime
            
            filename = self.get_nfilled_filename()
            today_str = datetime.now().strftime("%Y-%m-%d")
            
            # Dosya yolunu janall dizinine y√∂nlendir
            janall_dir = os.path.dirname(os.path.abspath(__file__))
            janall_dir = os.path.dirname(janall_dir)  # janallapp -> janall
            filepath = os.path.join(janall_dir, filename)
            
            # Dosya yoksa bo≈ü olu≈ütur
            if not os.path.exists(filepath):
                self._create_empty_nfilled_file(filepath)
                print(f"[NFILLED] ‚úÖ {filename} olu≈üturuldu")
                return True
            
            # Dosya varsa ilk kaydƒ±n tarihini kontrol et
            df = pd.read_csv(filepath, encoding='utf-8-sig')
            
            if df.empty:
                return False  # Bo≈ü dosya, sƒ±fƒ±rlamaya gerek yok
            
            # fill_time kolonunun ilk deƒüerinden tarihi al
            if 'fill_time' in df.columns:
                first_fill_time = str(df['fill_time'].iloc[0])
                first_date = first_fill_time[:10]  # YYYY-MM-DD formatƒ±
                
                # Tarih bug√ºnden farklƒ±ysa dosyayƒ± sƒ±fƒ±rla
                if first_date != today_str:
                    print(f"[NFILLED] üîÑ Yeni g√ºn algƒ±landƒ±! Eski: {first_date}, Bug√ºn: {today_str}")
                    print(f"[NFILLED] üóëÔ∏è {filename} sƒ±fƒ±rlanƒ±yor...")
                    self._create_empty_nfilled_file(filepath)
                    return True
            
            return False
            
        except Exception as e:
            print(f"[NFILLED] ‚ùå G√ºn kontrol√º hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def _create_empty_nfilled_file(self, filepath):
        """Bo≈ü nfilled dosyasƒ± olu≈ütur (sadece ba≈ülƒ±klarla)"""
        try:
            import pandas as pd
            
            # Kolon ba≈ülƒ±klarƒ± (jdatalog ile uyumlu ama daha basit)
            columns = ['order_id', 'symbol', 'action', 'fill_qty', 'fill_price', 'fill_time']
            df = pd.DataFrame(columns=columns)
            df.to_csv(filepath, index=False, encoding='utf-8-sig')
            print(f"[NFILLED] üìù Bo≈ü dosya olu≈üturuldu: {filepath}")
        except Exception as e:
            print(f"[NFILLED] ‚ùå Bo≈ü dosya olu≈üturma hatasƒ±: {e}")
    
    def save_fill_to_nfilled(self, fill_data):
        """Fill verisini nfilled dosyasƒ±na kaydet
        
        Args:
            fill_data: dict with keys: order_id, symbol, action, qty, price, time
        """
        try:
            import pandas as pd
            import os
            from datetime import datetime
            
            # √ñnce g√ºn kontrol√º yap
            self.check_and_reset_nfilled_for_new_day()
            
            filename = self.get_nfilled_filename()
            
            # Dosya yolunu janall dizinine y√∂nlendir
            janall_dir = os.path.dirname(os.path.abspath(__file__))
            janall_dir = os.path.dirname(janall_dir)  # janallapp -> janall
            filepath = os.path.join(janall_dir, filename)
            
            # Symbol d√∂n√º≈ü√ºm√º (Hammer formatƒ±ndan PREF IBKR formatƒ±na)
            symbol = fill_data.get('symbol', '')
            if '-' in symbol:
                # F-C -> F PRC formatƒ±na d√∂n√º≈üt√ºr
                parts = symbol.split('-')
                if len(parts) == 2:
                    symbol = f"{parts[0]} PR{parts[1]}"
            
            # Yeni kayƒ±t
            new_row = {
                'order_id': fill_data.get('order_id', f"fill_{int(datetime.now().timestamp())}"),
                'symbol': symbol,
                'action': fill_data.get('action', fill_data.get('side', 'Unknown')),
                'fill_qty': fill_data.get('qty', fill_data.get('fill_qty', 0)),
                'fill_price': fill_data.get('price', fill_data.get('fill_price', 0)),
                'fill_time': fill_data.get('time', fill_data.get('fill_time', datetime.now().isoformat()))
            }
            
            # Mevcut dosyayƒ± oku veya bo≈ü olu≈ütur
            if os.path.exists(filepath):
                df = pd.read_csv(filepath, encoding='utf-8-sig')
            else:
                df = pd.DataFrame(columns=['order_id', 'symbol', 'action', 'fill_qty', 'fill_price', 'fill_time'])
            
            # Duplicate kontrol√º (aynƒ± order_id varsa ekleme)
            if 'order_id' in df.columns and new_row['order_id'] in df['order_id'].values:
                print(f"[NFILLED] ‚ö†Ô∏è Duplicate order_id atlandƒ±: {new_row['order_id']}")
                return False
            
            # Yeni kaydƒ± ekle
            df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
            
            # Kaydet
            df.to_csv(filepath, index=False, encoding='utf-8-sig')
            
            # Action'a g√∂re qty'yi i≈üaretle (Buy pozitif, Sell negatif)
            action = new_row['action'].lower() if new_row['action'] else ''
            qty_display = new_row['fill_qty']
            if 'sell' in action:
                qty_display = -abs(qty_display)
            
            print(f"[NFILLED] ‚úÖ Fill kaydedildi: {new_row['symbol']} {qty_display} @ ${new_row['fill_price']:.2f}")
            
            return True
            
        except Exception as e:
            print(f"[NFILLED] ‚ùå Fill kaydetme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def setup_nfilled_callbacks(self):
        """Fill callback'lerini ayarla - Hammer ve IBKR i√ßin"""
        try:
            # Hammer Pro fill callback
            if hasattr(self, 'hammer') and self.hammer:
                def on_hammer_fill(fill_data):
                    """Hammer fill callback"""
                    try:
                        print(f"[NFILLED] üîî Hammer fill algƒ±landƒ±: {fill_data}")
                        self.save_fill_to_nfilled(fill_data)
                    except Exception as e:
                        print(f"[NFILLED] ‚ùå Hammer fill callback hatasƒ±: {e}")
                
                self.hammer.on_fill = on_hammer_fill
                print("[NFILLED] ‚úÖ Hammer fill callback ayarlandƒ±")
            
            # IBKR fill callback (eƒüer varsa)
            if hasattr(self, 'mode_manager'):
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client:
                    # IBKR Native client i√ßin execution callback
                    def on_ibkr_execution(exec_data):
                        """IBKR execution callback"""
                        try:
                            print(f"[NFILLED] üîî IBKR execution algƒ±landƒ±: {exec_data}")
                            fill_data = {
                                'order_id': exec_data.get('execId', exec_data.get('orderId', '')),
                                'symbol': exec_data.get('symbol', ''),
                                'action': exec_data.get('side', exec_data.get('action', '')),
                                'qty': exec_data.get('shares', exec_data.get('qty', 0)),
                                'price': exec_data.get('price', exec_data.get('avgPrice', 0)),
                                'time': exec_data.get('time', '')
                            }
                            self.save_fill_to_nfilled(fill_data)
                        except Exception as e:
                            print(f"[NFILLED] ‚ùå IBKR execution callback hatasƒ±: {e}")
                    
                    # IBKR client'a callback ekle (eƒüer destekliyorsa)
                    if hasattr(self.mode_manager.ibkr_native_client, 'on_execution'):
                        self.mode_manager.ibkr_native_client.on_execution = on_ibkr_execution
                        print("[NFILLED] ‚úÖ IBKR execution callback ayarlandƒ±")
            
            print("[NFILLED] ‚úÖ Fill callback'leri hazƒ±r")
            
        except Exception as e:
            print(f"[NFILLED] ‚ùå Callback ayarlama hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def get_todays_fills_from_nfilled(self, symbol):
        """nfilled dosyasƒ±ndan bug√ºnk√º fill'leri al
        
        Args:
            symbol: Hisse sembol√º (PREF IBKR formatƒ±nda)
        
        Returns:
            list: Fill kayƒ±tlarƒ± listesi
        """
        try:
            import pandas as pd
            import os
            from datetime import datetime
            
            filename = self.get_nfilled_filename()
            
            # Dosya yolunu janall dizinine y√∂nlendir
            janall_dir = os.path.dirname(os.path.abspath(__file__))
            janall_dir = os.path.dirname(janall_dir)  # janallapp -> janall
            filepath = os.path.join(janall_dir, filename)
            
            if not os.path.exists(filepath):
                return []
            
            df = pd.read_csv(filepath, encoding='utf-8-sig')
            
            if df.empty:
                return []
            
            # Symbol e≈üle≈ütirmesi i√ßin normalize et
            symbol_variants = [symbol]
            if '-' in symbol:
                symbol_variants.append(symbol.replace('-', ' PR'))
            elif ' PR' in symbol:
                # "F PRC" -> "F-C" formatƒ± i√ßin de kontrol et
                parts = symbol.split(' PR')
                if len(parts) == 2:
                    symbol_variants.append(f"{parts[0]}-{parts[1]}")
            
            # Symbol'e g√∂re filtrele
            symbol_df = df[df['symbol'].isin(symbol_variants)]
            
            if symbol_df.empty:
                return []
            
            # Dict listesi olarak d√∂nd√ºr
            fills = []
            for _, row in symbol_df.iterrows():
                fills.append({
                    'order_id': row.get('order_id', ''),
                    'symbol': row.get('symbol', ''),
                    'action': row.get('action', ''),
                    'fill_qty': float(row.get('fill_qty', 0)),
                    'fill_price': float(row.get('fill_price', 0)),
                    'fill_time': row.get('fill_time', '')
                })
            
            return fills
            
        except Exception as e:
            print(f"[NFILLED] ‚ùå {symbol} fill'leri okuma hatasƒ±: {e}")
            return []
    
    def get_open_orders_sum(self, symbol, use_cache=False):
        """A√ßƒ±k emirlerin toplam miktarƒ±nƒ± hesapla (potansiyel fill)"""
        try:
            # Cache kullanƒ±lƒ±yorsa cache'den al, deƒüilse direkt √ßek
            if use_cache and hasattr(self, 'orders_cache'):
                orders = self.get_cached_orders()
            else:
                # Aktif hesaptan a√ßƒ±k emirleri al
                if hasattr(self, 'mode_manager'):
                    active_account = self.mode_manager.get_active_account()
                else:
                    active_account = "HAMPRO" if self.hampro_mode else "IBKR"
                
                orders = []
                if active_account == "IBKR":
                    if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                        orders = self.mode_manager.ibkr_native_client.get_open_orders()
                    elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                        orders = self.mode_manager.ibkr_client.get_orders_direct()
                else:  # HAMPRO
                    if self.hammer and self.hammer.connected:
                        orders = self.hammer.get_open_orders()
            
            # Symbol'e g√∂re filtrele ve topla
            total_qty = 0
            for order in orders:
                order_symbol = order.get('symbol', '') or order.get('Symbol', '')
                
                # Symbol e≈üle≈ütirmesi (tam e≈üle≈üme veya preferred stock formatƒ±)
                is_match = False
                if order_symbol == symbol:
                    is_match = True
                elif '-' in order_symbol:
                    # Preferred stock formatƒ±: "SYMBOL-A" -> "SYMBOL PRA"
                    base, suffix = order_symbol.split('-', 1)
                    if base == symbol.replace(' PR', '').split()[0]:
                        is_match = True
                elif ' PR' in symbol and order_symbol == symbol.replace(' PR', ''):
                    # Symbol "ABC PRC" ama order "ABC" formatƒ±nda
                    is_match = True
                
                if is_match:
                    # Remaining quantity kullan (filled deƒüil, kalan miktar)
                    remaining = order.get('remaining', None) or order.get('Remaining', None)
                    qty = order.get('quantity', 0) or order.get('qty', 0) or order.get('Quantity', 0) or 0
                    
                    # Eƒüer remaining varsa onu kullan (daha doƒüru)
                    if remaining is not None and remaining > 0:
                        qty = float(remaining)
                    else:
                        qty = float(qty)
                    
                    side = order.get('side', '').upper() or order.get('Side', '').upper() or order.get('action', '').upper() or order.get('Action', '').upper()
                    
                    # Status kontrol√º - sadece a√ßƒ±k emirleri say
                    status = order.get('status', '').upper() or order.get('Status', '').upper()
                    if status in ['CANCELLED', 'FILLED', 'REJECTED', 'API CANCELLED']:
                        continue  # Bu emirler artƒ±k a√ßƒ±k deƒüil
                    
                    if side == 'BUY':
                        total_qty += qty
                    elif side == 'SELL':
                        total_qty -= qty
            
            return total_qty
            
        except Exception as e:
            print(f"[CONTROLLER] ‚ùå {symbol} a√ßƒ±k emir toplama hatasƒ±: {e}")
            return 0
    
    def check_position_direction_change(self, current_qty, order_side, order_qty, g√ºn_ba≈üƒ±_pozisyon=None, open_orders_qty=0):
        """
        Pozisyon t√ºr√º deƒüi≈üimini kontrol et - G√ºn ba≈üƒ± pozisyon bazƒ±nda (a√ßƒ±k emirler dahil)
        
        Args:
            current_qty: Mevcut pozisyon
            order_side: BUY/SELL
            order_qty: ƒ∞stenen emir miktarƒ±
            g√ºn_ba≈üƒ±_pozisyon: G√ºn ba≈üƒ± pozisyon (befib/befham'dan)
            open_orders_qty: A√ßƒ±k emirler toplamƒ± (potansiyel fill)
        
        Returns: (allowed, adjusted_qty, needs_rounding, reason)
        """
        try:
            # G√ºn ba≈üƒ± pozisyon t√ºr√º (eƒüer verilmi≈üse)
            if g√ºn_ba≈üƒ±_pozisyon is not None:
                if g√ºn_ba≈üƒ±_pozisyon > 0:
                    g√ºn_ba≈üƒ±_type = 'LONG'
                elif g√ºn_ba≈üƒ±_pozisyon < 0:
                    g√ºn_ba≈üƒ±_type = 'SHORT'
                else:
                    g√ºn_ba≈üƒ±_type = 'ZERO'
            else:
                g√ºn_ba≈üƒ±_type = None
            
            # Mevcut potansiyel pozisyon (a√ßƒ±k emirler dahil)
            current_potential = current_qty + open_orders_qty
            
            # Mevcut pozisyon t√ºr√º
            if current_potential > 0:
                current_type = 'LONG'
            elif current_potential < 0:
                current_type = 'SHORT'
            else:
                current_type = 'ZERO'
            
            # Yeni emir eklendikten sonra potansiyel pozisyon
            if order_side.upper() == 'BUY':
                potential_qty = current_potential + order_qty
            else:  # SELL
                potential_qty = current_potential - order_qty
            
            # Potansiyel pozisyon t√ºr√º
            if potential_qty > 0:
                potential_type = 'LONG'
            elif potential_qty < 0:
                potential_type = 'SHORT'
            else:
                potential_type = 'ZERO'
            
            # G√úN BA≈ûI POZƒ∞SYON BAZINDA KONTROL (√ñncelikli)
            if g√ºn_ba≈üƒ±_type is not None:
                if g√ºn_ba≈üƒ±_type == 'LONG' and potential_type == 'SHORT':
                    # G√ºn ba≈üƒ± long pozisyon ‚Üí potansiyel short olmamalƒ±
                    # Emir miktarƒ±nƒ± mevcut potansiyel pozisyona indir (tam 0'a getir)
                    # current_potential pozitif olmalƒ± ki 0'a getirebilsin
                    if current_potential > 0:
                        adjusted_qty = current_potential  # Tam lot (√∂rn: 247)
                        return False, adjusted_qty, False, f"G√ºn ba≈üƒ± long pozisyon ({g√ºn_ba≈üƒ±_pozisyon:.0f}) short'a ge√ßemez - emir {current_potential:.0f} lot'a indirildi (0'a getirmek i√ßin)"
                    else:
                        # Zaten short'a ge√ßmi≈ü, emir g√∂nderilemez
                        return False, 0, False, f"G√ºn ba≈üƒ± long pozisyon ({g√ºn_ba≈üƒ±_pozisyon:.0f}) zaten short'a ge√ßmi≈ü - emir engellendi"
                
                elif g√ºn_ba≈üƒ±_type == 'SHORT' and potential_type == 'LONG':
                    # G√ºn ba≈üƒ± short pozisyon ‚Üí potansiyel long olmamalƒ±
                    # Emir miktarƒ±nƒ± mevcut potansiyel pozisyona indir (tam 0'a getir)
                    if current_potential < 0:
                        adjusted_qty = abs(current_potential)  # Tam lot
                        return False, adjusted_qty, False, f"G√ºn ba≈üƒ± short pozisyon ({g√ºn_ba≈üƒ±_pozisyon:.0f}) long'a ge√ßemez - emir {abs(current_potential):.0f} lot'a indirildi (0'a getirmek i√ßin)"
                    else:
                        # Zaten long'a ge√ßmi≈ü, emir g√∂nderilemez
                        return False, 0, False, f"G√ºn ba≈üƒ± short pozisyon ({g√ºn_ba≈üƒ±_pozisyon:.0f}) zaten long'a ge√ßmi≈ü - emir engellendi"
            
            # Mevcut pozisyon bazƒ±nda kontrol (backup - g√ºn ba≈üƒ± bilgisi yoksa)
            if current_type == 'LONG' and potential_type == 'SHORT':
                # Long'dan short'a ge√ßi≈ü engellenmeli
                if current_potential > 0:
                    adjusted_qty = current_potential  # Tam lot (0'a getirmek i√ßin)
                    return False, adjusted_qty, False, "Long pozisyon short'a ge√ßemez - emir 0'a getirmek i√ßin ayarlandƒ±"
                else:
                    return False, 0, False, "Long pozisyon zaten short'a ge√ßmi≈ü - emir engellendi"
            
            elif current_type == 'SHORT' and potential_type == 'LONG':
                # Short'dan long'a ge√ßi≈ü engellenmeli
                if current_potential < 0:
                    adjusted_qty = abs(current_potential)  # Tam lot (0'a getirmek i√ßin)
                    return False, adjusted_qty, False, "Short pozisyon long'a ge√ßemez - emir 0'a getirmek i√ßin ayarlandƒ±"
                else:
                    return False, 0, False, "Short pozisyon zaten long'a ge√ßmi≈ü - emir engellendi"
            
            else:
                # Ge√ßi≈ü yok veya 0'dan ge√ßi≈ü (izinli)
                return True, order_qty, True, "Pozisyon t√ºr√º korunuyor - normal yuvarlama yapƒ±labilir"
                
        except Exception as e:
            print(f"[CONTROLLER] ‚ùå Pozisyon t√ºr√º kontrol hatasƒ±: {e}")
            return True, order_qty, True, f"Hata: {e}"
    
    def check_maxalw_limits(self, symbol, current_qty, open_orders_qty, new_order_qty, order_side, g√ºn_ba≈üƒ±_pozisyon, maxalw):
        """
        MAXALW limitleri kontrol√º
        
        Returns: (allowed_qty, reason)
        """
        try:
            # Mevcut potansiyel pozisyon (a√ßƒ±k emirler dahil)
            current_potential = current_qty + open_orders_qty
            
            # Yeni emir eklendikten sonra potansiyel pozisyon (BUY/SELL y√∂n√ºne g√∂re)
            if order_side.upper() == 'BUY':
                potential_position = current_potential + new_order_qty
            else:  # SELL
                potential_position = current_potential - new_order_qty
            
            # Limit 1: Toplam pozisyon MAXALW'yi ge√ßmemeli (abs ile) - emir miktarƒ± ayarlanƒ±r
            abs_potential = abs(potential_position)
            current_abs = abs(current_potential)
            
            if abs_potential > maxalw:
                # Limit a≈üƒ±lƒ±yor, ne kadar eklenebilir?
                if current_abs >= maxalw:
                    limit_1_allowed = 0
                    limit_1_reason = f"Toplam pozisyon limiti: Zaten MAXALW'ye ula≈ütƒ± ({current_abs:.0f} >= {maxalw:.0f}), emir engellendi"
                else:
                    # Kalan kapasite (y√∂n√º dikkate alarak)
                    limit_1_allowed = maxalw - current_abs
                    if limit_1_allowed < new_order_qty:
                        limit_1_reason = f"Toplam pozisyon limiti: Emir {new_order_qty} ‚Üí {limit_1_allowed:.0f} lot'a d√º≈ü√ºr√ºld√º (MAXALW: {maxalw:.0f}, mevcut: {current_abs:.0f})"
                    else:
                        limit_1_reason = f"Toplam pozisyon limiti OK"
            else:
                # Limit i√ßinde, tam emir miktarƒ± kabul edilebilir (ama diƒüer limitlere de bakƒ±lacak)
                limit_1_allowed = maxalw - current_abs
                if limit_1_allowed > new_order_qty:
                    limit_1_allowed = new_order_qty
                limit_1_reason = f"Toplam pozisyon limiti OK"
            
            # Limit 2: G√ºnl√ºk deƒüi≈üim MAXALW*multiplier'ƒ± ge√ßmemeli (abs ile) - emir miktarƒ± ayarlanƒ±r
            multiplier = getattr(self, 'rule_max_change_multiplier', 0.75)
            maxalw_daily_limit = maxalw * multiplier
            
            # Mevcut g√ºnl√ºk deƒüi≈üim (a√ßƒ±k emirler dahil)
            current_daily_change = abs(current_potential - g√ºn_ba≈üƒ±_pozisyon)
            
            # Yeni emir eklendikten sonra g√ºnl√ºk deƒüi≈üim
            potential_daily_change = abs(potential_position - g√ºn_ba≈üƒ±_pozisyon)
            
            if potential_daily_change > maxalw_daily_limit:
                # Limit a≈üƒ±lƒ±yor, ne kadar eklenebilir?
                if current_daily_change >= maxalw_daily_limit:
                    limit_2_allowed = 0
                    limit_2_reason = f"G√ºnl√ºk deƒüi≈üim limiti: Zaten limit dolu ({current_daily_change:.0f} >= {maxalw_daily_limit:.0f}), emir engellendi"
                else:
                    # Kalan g√ºnl√ºk deƒüi≈üim hakkƒ±
                    # Emir miktarƒ± √∂yle ayarlanmalƒ± ki potansiyel deƒüi≈üim limiti a≈ümasƒ±n
                    limit_2_allowed = maxalw_daily_limit - current_daily_change
                    if limit_2_allowed < new_order_qty:
                        limit_2_reason = f"G√ºnl√ºk deƒüi≈üim limiti: Emir {new_order_qty} ‚Üí {limit_2_allowed:.0f} lot'a d√º≈ü√ºr√ºld√º (Limit: {maxalw_daily_limit:.0f}, mevcut deƒüi≈üim: {current_daily_change:.0f})"
                    else:
                        limit_2_reason = f"G√ºnl√ºk deƒüi≈üim limiti OK"
            else:
                # Limit i√ßinde, kalan kapasite hesapla
                limit_2_allowed = maxalw_daily_limit - current_daily_change
                if limit_2_allowed > new_order_qty:
                    limit_2_allowed = new_order_qty
                limit_2_reason = f"G√ºnl√ºk deƒüi≈üim limiti OK"
            
            # Limit 3: Ters y√∂nde g√ºn ba≈üƒ± pozisyonunu a≈ümamalƒ± (emir miktarƒ± ayarlanƒ±r)
            # G√ºn ba≈üƒ± pozisyonun mutlak deƒüeri
            abs_befday = abs(g√ºn_ba≈üƒ±_pozisyon)
            
            # G√ºnl√ºk deƒüi≈üim (i≈üaretli)
            current_daily_change_signed = current_potential - g√ºn_ba≈üƒ±_pozisyon
            potential_daily_change_signed = potential_position - g√ºn_ba≈üƒ±_pozisyon
            
            # Ters y√∂nde ge√ßi≈ü var mƒ± kontrol et
            if g√ºn_ba≈üƒ±_pozisyon > 0 and potential_position < 0:
                # G√ºn ba≈üƒ± long ‚Üí potansiyel short (ters y√∂n)
                # Emir miktarƒ±nƒ± ayarla: pozisyonu 0'a getir ama ters y√∂ne ge√ßirme
                # current_potential pozitif olmalƒ± (hala long)
                # Emir miktarƒ±: pozisyonu 0'a getirmek i√ßin gereken miktar
                if current_potential > 0:
                    # Pozisyonu 0'a getirmek i√ßin gereken miktar
                    limit_3_allowed = current_potential
                    limit_3_reason = f"Ters y√∂n limiti: Emir {new_order_qty} ‚Üí {limit_3_allowed:.0f} lot'a d√º≈ü√ºr√ºld√º (pozisyon 0'a getirmek i√ßin, g√ºn ba≈üƒ±: {abs_befday:.0f})"
                else:
                    # Zaten short'a ge√ßmi≈ü, emir g√∂nderilemez
                    limit_3_allowed = 0
                    limit_3_reason = f"Ters y√∂n limiti: Zaten short'a ge√ßilmi≈ü, emir engellendi (g√ºn ba≈üƒ±: {abs_befday:.0f})"
            elif g√ºn_ba≈üƒ±_pozisyon < 0 and potential_position > 0:
                # G√ºn ba≈üƒ± short ‚Üí potansiyel long (ters y√∂n)
                # Emir miktarƒ±nƒ± ayarla: pozisyonu 0'a getir ama ters y√∂ne ge√ßirme
                # current_potential negatif olmalƒ± (hala short)
                # Emir miktarƒ±: pozisyonu 0'a getirmek i√ßin gereken miktar
                if current_potential < 0:
                    # Pozisyonu 0'a getirmek i√ßin gereken miktar (abs ile)
                    limit_3_allowed = abs(current_potential)
                    limit_3_reason = f"Ters y√∂n limiti: Emir {new_order_qty} ‚Üí {limit_3_allowed:.0f} lot'a d√º≈ü√ºr√ºld√º (pozisyon 0'a getirmek i√ßin, g√ºn ba≈üƒ±: {abs_befday:.0f})"
                else:
                    # Zaten long'a ge√ßmi≈ü, emir g√∂nderilemez
                    limit_3_allowed = 0
                    limit_3_reason = f"Ters y√∂n limiti: Zaten long'a ge√ßilmi≈ü, emir engellendi (g√ºn ba≈üƒ±: {abs_befday:.0f})"
            else:
                # Ters y√∂nde ge√ßi≈ü yok, bu limit ge√ßerli deƒüil
                limit_3_allowed = new_order_qty  # Sƒ±nƒ±rsƒ±z (diƒüer limitler kontrol edilecek)
                limit_3_reason = f"Ters y√∂n kontrol√º gerekmiyor"
            
            # √ú√ß limitten k√º√ß√ºk olanƒ± se√ß
            allowed_qty = min(limit_1_allowed, limit_2_allowed, limit_3_allowed, new_order_qty)
            allowed_qty = max(0, allowed_qty)  # Negatif olamaz
            
            if allowed_qty == 0:
                reason = f"MAXALW limiti: {limit_1_reason} | {limit_2_reason} | {limit_3_reason}"
            elif allowed_qty != new_order_qty:
                reason = f"MAXALW limiti: {limit_1_reason} | {limit_2_reason} | {limit_3_reason} ‚Üí Emir {new_order_qty} ‚Üí {allowed_qty} lot'a d√º≈ü√ºr√ºld√º"
            else:
                reason = f"MAXALW limiti OK: Limit1={limit_1_allowed:.0f}, Limit2={limit_2_allowed:.0f}, Limit3={limit_3_allowed:.0f}"
            
            return allowed_qty, reason
            
        except Exception as e:
            print(f"[CONTROLLER] ‚ùå MAXALW limit kontrol hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return 0, f"Hata: {e}"
    
    def check_pot_total_limit(self, symbol, order_side, order_qty):
        """
        Pot Toplam limit kontrol√º - Sadece pozisyon arttƒ±rma emirleri i√ßin
        
        Returns: (adjusted_qty, reason)
        """
        try:
            # Pot Toplam hesapla
            pot_info = self.calculate_potential_total()
            current_pot_total = pot_info.get('pot_total', 0)
            
            # Pot Max Lot hesapla
            pot_expo_limit = float(self.pot_expo_limit_var.get())
            avg_price = float(self.avg_price_var.get())
            pot_max_lot = int(pot_expo_limit / avg_price)
            
            # Bu emir pozisyon arttƒ±rma mƒ±? (Emir pozisyon arttƒ±rma ise kontrol et)
            # Eƒüer Pot Toplam + Emir > Pot Max Lot ise, emri d√º≈ü√ºr
            new_pot_total = current_pot_total + order_qty
            if new_pot_total > pot_max_lot:
                adjusted_qty = max(0, pot_max_lot - current_pot_total)
                reason = f"Pot Toplam limiti: {current_pot_total:,} + {order_qty:,} = {new_pot_total:,} > {pot_max_lot:,} ‚Üí Emir {order_qty:,} ‚Üí {adjusted_qty:,} lot'a d√º≈ü√ºr√ºld√º"
                return adjusted_qty, reason
            
            return order_qty, "Pot Toplam limiti OK"
            
        except Exception as e:
            print(f"[CONTROLLER] ‚ùå Pot Toplam limit kontrol hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return order_qty, f"Hata: {e}"
    
    def check_jfin_daily_change_limit(self, symbol, current_qty, open_orders_qty, order_qty, order_side, g√ºn_ba≈üƒ±_pozisyon):
        """
        JFIN Hesaplanan Lot √ó 2 kontrol√º - ADDNEWPOS i√ßin g√ºnl√ºk deƒüi≈üim limiti
        
        Kural: Hesaplanan Lot √ó 2 > Bug√ºnk√º Deƒüi≈üim olmalƒ±
        
        Args:
            symbol: Hisse sembol√º
            current_qty: Mevcut pozisyon
            open_orders_qty: A√ßƒ±k emirler toplamƒ±
            order_qty: ƒ∞stenen emir miktarƒ±
            order_side: BUY/SELL
            g√ºn_ba≈üƒ±_pozisyon: G√ºn ba≈üƒ± pozisyon
        
        Returns: (allowed_qty, reason)
        """
        try:
            # FinalThgLotDistributor'dan JFIN hesaplanan lot bilgisini al
            jfin_calculated_lot = 0
            # ADDNEWPOS ≈üu an sadece BB ile √ßalƒ±≈üƒ±yor, bu y√ºzden 'BB' sekmesini kullan
            jfin_tab = 'BB'  # Varsayƒ±lan olarak BB (ADDNEWPOS ≈üu an sadece BB kullanƒ±yor)
            
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                if hasattr(self.addnewpos_final_thg, 'get_jfin_calculated_lot'):
                    jfin_calculated_lot = self.addnewpos_final_thg.get_jfin_calculated_lot(symbol, order_side, jfin_tab)
            
            # Eƒüer JFIN bilgisi bulunamadƒ±ysa kontrol atla
            if jfin_calculated_lot <= 0:
                return order_qty, "JFIN hesaplanan lot bilgisi bulunamadƒ± - kontrol atlandƒ±"
            
            # Limit = Hesaplanan Lot √ó 2
            daily_change_limit = jfin_calculated_lot * 2
            
            # Mevcut potansiyel pozisyon (a√ßƒ±k emirler dahil)
            current_potential = current_qty + open_orders_qty
            
            # Bug√ºnk√º deƒüi≈üim hesapla (mutlak deƒüerle)
            if g√ºn_ba≈üƒ±_pozisyon is not None:
                bug√ºnk√º_deƒüi≈üim = abs(current_potential - g√ºn_ba≈üƒ±_pozisyon)
            else:
                # G√ºn ba≈üƒ± pozisyon bilgisi yoksa, mevcut pozisyonu kullan
                bug√ºnk√º_deƒüi≈üim = abs(current_potential)
            
            # Yeni emir eklendikten sonra bug√ºnk√º deƒüi≈üim
            if order_side.upper() == 'BUY':
                potential_position = current_potential + order_qty
            else:  # SELL
                potential_position = current_potential - order_qty
            
            if g√ºn_ba≈üƒ±_pozisyon is not None:
                potential_daily_change = abs(potential_position - g√ºn_ba≈üƒ±_pozisyon)
            else:
                potential_daily_change = abs(potential_position)
            
            # Kontrol: Potential Daily Change <= Limit olmalƒ±
            if potential_daily_change > daily_change_limit:
                # Limit a≈üƒ±lƒ±yor, ne kadar eklenebilir?
                if bug√ºnk√º_deƒüi≈üim >= daily_change_limit:
                    # Zaten limit dolu
                    allowed_qty = 0
                    reason = f"JFIN g√ºnl√ºk deƒüi≈üim limiti: Zaten limit dolu (Bug√ºnk√º deƒüi≈üim: {bug√ºnk√º_deƒüi≈üim:.0f} >= Limit: {daily_change_limit:.0f}, Hesaplanan Lot: {jfin_calculated_lot:.0f})"
                else:
                    # Kalan kapasite
                    remaining_capacity = daily_change_limit - bug√ºnk√º_deƒüi≈üim
                    
                    # Eƒüer kalan kapasite 200'den azsa, emir g√∂nderilmemeli
                    if remaining_capacity < 200:
                        allowed_qty = 0
                        reason = f"JFIN g√ºnl√ºk deƒüi≈üim limiti: Kalan kapasite {remaining_capacity:.0f} < 200 lot - emir engellendi (Bug√ºnk√º deƒüi≈üim: {bug√ºnk√º_deƒüi≈üim:.0f}, Limit: {daily_change_limit:.0f}, Hesaplanan Lot: {jfin_calculated_lot:.0f})"
                    else:
                        # Emir miktarƒ±nƒ± kalan kapasiteye g√∂re ayarla
                        allowed_qty = min(order_qty, remaining_capacity)
                        if allowed_qty < order_qty:
                            reason = f"JFIN g√ºnl√ºk deƒüi≈üim limiti: Emir {order_qty} ‚Üí {allowed_qty:.0f} lot'a d√º≈ü√ºr√ºld√º (Bug√ºnk√º deƒüi≈üim: {bug√ºnk√º_deƒüi≈üim:.0f}, Limit: {daily_change_limit:.0f}, Hesaplanan Lot: {jfin_calculated_lot:.0f})"
                        else:
                            reason = f"JFIN g√ºnl√ºk deƒüi≈üim limiti OK"
            else:
                # Limit i√ßinde
                allowed_qty = order_qty
                reason = f"JFIN g√ºnl√ºk deƒüi≈üim limiti OK (Bug√ºnk√º deƒüi≈üim: {bug√ºnk√º_deƒüi≈üim:.0f}, Limit: {daily_change_limit:.0f}, Hesaplanan Lot: {jfin_calculated_lot:.0f})"
            
            allowed_qty = max(0, allowed_qty)  # Negatif olamaz
            return allowed_qty, reason
            
        except Exception as e:
            print(f"[CONTROLLER] ‚ùå JFIN g√ºnl√ºk deƒüi≈üim limit kontrol hatasƒ± ({symbol}): {e}")
            import traceback
            traceback.print_exc()
            return order_qty, f"Hata: {e}"
    
    def controller_check_order(self, symbol, order_side, requested_qty):
        """
        Controller ON iken emir kontrol√º
        
        Returns: (allowed, adjusted_qty, reason)
        """
        try:
            # Controller kapalƒ±ysa kontrol yapma
            if not hasattr(self, 'controller_enabled') or not self.controller_enabled:
                return True, requested_qty, "Controller kapalƒ±"
            
            # Aktif hesaptan mevcut pozisyonu al
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            # Mevcut pozisyonu bul (cache'lenmi≈ü pozisyonlardan)
            current_qty = 0
            positions = self.get_cached_positions(active_account)
            
            # Symbol'e g√∂re pozisyonu bul
            for pos in positions:
                pos_symbol = pos.get('symbol') or pos.get('Symbol', '')
                if pos_symbol == symbol:
                    current_qty = pos.get('quantity', 0) or pos.get('qty', 0) or 0
                    break
            
            # A√ßƒ±k emirler toplamƒ± (cache'lenmi≈ü emirlerden)
            open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
            
            # G√ºn ba≈üƒ± pozisyon
            g√ºn_ba≈üƒ±_pozisyon = self.load_bef_position(symbol)
            
            # MAXALW deƒüeri
            maxalw = self.get_maxalw_for_symbol(symbol)
            if maxalw <= 0:
                print(f"[CONTROLLER] ‚ö†Ô∏è {symbol} i√ßin MAXALW deƒüeri bulunamadƒ±")
                return True, requested_qty, "MAXALW deƒüeri bulunamadƒ± - kontrol atlandƒ±"
            
            # 1. POZISYON T√úR√ú KONTROL√ú (G√ºn ba≈üƒ± pozisyon bazƒ±nda, a√ßƒ±k emirler dahil)
            pos_allowed, pos_adjusted_qty, needs_rounding, pos_reason = self.check_position_direction_change(
                current_qty, order_side, requested_qty, g√ºn_ba≈üƒ±_pozisyon, open_orders_qty
            )
            
            # 2. MAXALW Lƒ∞Mƒ∞TLERƒ∞ KONTROL√ú
            maxalw_allowed_qty, maxalw_reason = self.check_maxalw_limits(
                symbol, current_qty, open_orders_qty, pos_adjusted_qty, order_side, g√ºn_ba≈üƒ±_pozisyon, maxalw
            )
            
            # 3. POT TOPLAM Lƒ∞Mƒ∞T KONTROL√ú (sadece pozisyon arttƒ±rma emirleri i√ßin)
            # Emir pozisyon arttƒ±rma mƒ± kontrol et
            is_position_increase = False
            if order_side == 'BUY' and current_qty >= 0:
                # Long pozisyon var veya 0, BUY emri arttƒ±rma
                is_position_increase = True
            elif order_side == 'SELL' and current_qty < 0:
                # Short pozisyon var, SELL emri arttƒ±rma (short artar)
                is_position_increase = True
            
            pot_allowed_qty = maxalw_allowed_qty
            pot_reason = ""
            if is_position_increase:
                pot_allowed_qty, pot_reason = self.check_pot_total_limit(symbol, order_side, maxalw_allowed_qty)
            
            # 3.5. JFIN HESAPLANAN LOT √ó 2 KONTROL√ú (ADDNEWPOS i√ßin - sadece pozisyon arttƒ±rma emirleri i√ßin)
            jfin_allowed_qty = pot_allowed_qty
            jfin_reason = ""
            if is_position_increase:
                # ADDNEWPOS durumunda mƒ± kontrol et (RUNALL √ßalƒ±≈üƒ±yorsa ve ADDNEWPOS ba≈ülatƒ±ldƒ±ysa)
                is_addnewpos = (hasattr(self, 'runall_loop_running') and self.runall_loop_running) or \
                              (hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started)
                
                if is_addnewpos:
                    jfin_allowed_qty, jfin_reason = self.check_jfin_daily_change_limit(
                        symbol, current_qty, open_orders_qty, pot_allowed_qty, order_side, g√ºn_ba≈üƒ±_pozisyon
                    )
            
            # 4. Fƒ∞NAL EMƒ∞R Mƒ∞KTARI
            final_qty = min(pos_adjusted_qty, maxalw_allowed_qty, pot_allowed_qty, jfin_allowed_qty)
            final_qty = max(0, final_qty)  # Negatif olamaz
            
            # 4. YUVARLAMA KARARI
            if needs_rounding and final_qty == requested_qty:
                # Normal durum: Yuvarlama yapƒ±labilir (KARBOTU/REDUCEMORE kurallarƒ±)
                # Burada yuvarlama fonksiyonu √ßaƒürƒ±labilir (opsiyonel)
                final_qty = int(final_qty)  # ≈ûimdilik tam sayƒ±
            else:
                # Ge√ßi≈ü durumu: Yuvarlama YOK, tam lot
                final_qty = int(final_qty)  # Tam lot (√∂rn: 330)
            
            # Sonu√ß
            if final_qty == 0:
                reason_parts = [pos_reason, maxalw_reason]
                if pot_reason:
                    reason_parts.append(pot_reason)
                if jfin_reason:
                    reason_parts.append(jfin_reason)
                return False, 0, f"Emir engellendi: {' | '.join(reason_parts)}"
            elif final_qty != requested_qty:
                reason_parts = [pos_reason, maxalw_reason]
                if pot_reason:
                    reason_parts.append(pot_reason)
                if jfin_reason:
                    reason_parts.append(jfin_reason)
                return True, final_qty, f"Emir ayarlandƒ±: {requested_qty} ‚Üí {final_qty} | {' | '.join(reason_parts)}"
            else:
                reason_parts = [pos_reason, maxalw_reason]
                if pot_reason:
                    reason_parts.append(pot_reason)
                if jfin_reason:
                    reason_parts.append(jfin_reason)
                return True, final_qty, f"Emir onaylandƒ±: {' | '.join(reason_parts)}"
                
        except Exception as e:
            print(f"[CONTROLLER] ‚ùå Emir kontrol hatasƒ± ({symbol}): {e}")
            import traceback
            traceback.print_exc()
            return True, requested_qty, f"Hata: {e}"
    
    def start_psfalgo_monitoring(self):
        """Psfalgo robotunu ba≈ülat"""
        self.psfalgo_running = True
        self.start_btn.config(state='disabled')
        self.stop_btn.config(state='normal')
        self.status_label.config(text="Durum: √áalƒ±≈üƒ±yor")
        
        self.log_message("OK Psfalgo robot baslatildi")
        
        # Otomatik: Take Profit Longs akƒ±≈üƒ±nƒ± ba≈ülat
        try:
            self.auto_take_profit_longs_selection()
        except Exception as e:
            self.log_message(f"ERROR TP Longs otomasyonu: {e}")
        
        # Robot d√∂ng√ºs√ºn√º ba≈ülat
        self.psfalgo_monitoring_loop()
    
    def stop_psfalgo_monitoring(self):
        """Psfalgo robotunu durdur"""
        self.psfalgo_running = False
        self.start_btn.config(state='normal')
        self.stop_btn.config(state='disabled')
        self.status_label.config(text="Durum: Durduruldu")
        
        self.log_message("‚èπÔ∏è Psfalgo robot durduruldu")
    
    def psfalgo_monitoring_loop(self):
        """Psfalgo robot ana d√∂ng√ºs√º - Exposure kontrol√º ile"""
        if not self.psfalgo_running:
            return
        
        # Pencere hala var mƒ± kontrol et
        if not hasattr(self, 'psfalgo_window') or not self.psfalgo_window:
            return
        
        try:
            # Exposure kontrol√º yap
            exposure_info = self.check_exposure_limits()
            current_mode = exposure_info.get('mode', 'UNKNOWN')
            can_add_positions = exposure_info.get('can_add_positions', False)
            
            # Pozisyonlarƒ± g√ºncelle (emirler cache'den alƒ±nacak)
            self.update_psfalgo_positions()
            
            # Pot Toplam kontrol√º (Controller ON ise ve 60 saniyede bir)
            if hasattr(self, 'controller_enabled') and self.controller_enabled:
                pot_info = self.calculate_potential_total()
                pot_total = pot_info.get('pot_total', 0)
                pot_max_lot = int(float(self.pot_expo_limit_var.get()) / float(self.avg_price_var.get()))
                
                # ADDNEWPOS butonu durumu
                if current_mode == "OFANSIF" and pot_total < pot_max_lot:
                    if hasattr(self, 'addnewpos_btn'):
                        self.addnewpos_btn.config(state='normal')
                else:
                    if hasattr(self, 'addnewpos_btn'):
                        self.addnewpos_btn.config(state='disabled')
            
            # Mod kontrol√º
            if current_mode == "DEFANSIVE":
                self.log_message(f"üõ°Ô∏è DEFANSIVE MOD: Sadece KARBOTU i≈ülemleri yapƒ±labilir (pozisyon artƒ±rma yasak)")
            elif current_mode == "OFANSIF":
                self.log_message(f"‚ö° OFANSIF MOD: Hem KARBOTU hem ADDPOS i≈ülemleri yapƒ±labilir")
            else:
                self.log_message(f"üî∂ GE√áI≈û MOD: Dikkatli ilerle")
            
            # 60 saniye sonra tekrar √ßalƒ±≈ütƒ±r (Controller ON ise daha sƒ±k kontrol)
            # Ama pozisyon g√ºncellemesi cache'den alƒ±nacak, bu y√ºzden daha sƒ±k √ßalƒ±≈üabilir
            interval = 60000 if (hasattr(self, 'controller_enabled') and self.controller_enabled) else 300000
            self.psfalgo_window.after(interval, self.psfalgo_monitoring_loop)
            
        except Exception as e:
            self.log_message(f"‚ùå Robot d√∂ng√º hatasƒ±: {e}")
            # Hata olsa bile devam et
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                self.psfalgo_window.after(300000, self.psfalgo_monitoring_loop)

    def auto_take_profit_longs_selection(self):
        """Take Profit Longs penceresini a√ß, filtrele ve Ask Sell onay penceresini hazƒ±rla"""
        try:
            from .take_profit_panel import TakeProfitPanel
            panel = TakeProfitPanel(self, "longs")

            def do_select_and_open():
                try:
                    # Table hazƒ±r mƒ±? deƒüilse tekrar dene
                    if len(panel.tree.get_children()) == 0 or not hasattr(panel, 'positions') or not panel.positions:
                        panel.win.after(400, do_select_and_open)
                        return
                    # Se√ßimleri temizle
                    try:
                        panel.deselect_all_positions()
                    except Exception:
                        pass

                    selected_any = False
                    for item in panel.tree.get_children():
                        try:
                            symbol = panel.tree.set(item, 'symbol')
                            qty_str = panel.tree.set(item, 'qty')
                            fbtot_str = panel.tree.set(item, 'fbtot')

                            # Miktar
                            try:
                                qty = float(qty_str)
                            except Exception:
                                qty = 0.0

                            # FBtot (N/A veya bo≈ü ise atla)
                            # Fbtot: N/A/bo≈ü/0.00 olanlarƒ± atla
                            try:
                                fbtot_val = float(fbtot_str)
                                if fbtot_val == 0.0:
                                    continue
                            except Exception:
                                continue

                            if qty >= 100 and fbtot_val < 1.60:
                                panel.tree.set(item, 'select', '‚úì')
                                # Satƒ±r deƒüerlerinden avg_cost ve qty'yi alƒ±p s√∂zl√ºƒüe yaz
                                values = panel.tree.item(item)['values']
                                try:
                                    avg_cost_str = values[3]
                                    if isinstance(avg_cost_str, str):
                                        avg_cost_clean = avg_cost_str.replace('$', '').replace(',', '').strip()
                                        avg_cost = float(avg_cost_clean) if avg_cost_clean else 0.0
                                    else:
                                        avg_cost = float(avg_cost_str)
                                except Exception:
                                    avg_cost = 0.0
                                panel.selected_positions[symbol] = { 'avg_cost': avg_cost, 'qty': qty }
                                selected_any = True
                        except Exception:
                            continue

                    panel.update_selection_count()

                    if not selected_any:
                        self.log_message("INFO TP Longs: Kriterlere uyan pozisyon bulunamadƒ± (qty>=100, fbtot<1.60)")
                        return

                    # %50 lot ayarla ve Ask Sell onay penceresini a√ß
                    panel.set_lot_percentage(50)
                    panel.place_orders("Ask Sell")
                except Exception as e:
                    self.log_message(f"ERROR TP Longs secim/ackis: {e}")

            # Panel olu≈ütuktan sonra kƒ±sa gecikmeyle √ßalƒ±≈ütƒ±r (UI hazƒ±r olsun)
            panel.win.after(600, do_select_and_open)
        except Exception as e:
            self.log_message(f"ERROR TP Longs otomasyon init: {e}")
    
    def check_exposure_limits(self):
        """Exposure limitlerini kontrol et ve modu belirle - AKTƒ∞F HESAP bazlƒ±"""
        try:
            # Exposure parametrelerini al
            exposure_limit = float(self.exposure_limit_var.get())
            avg_price = float(self.avg_price_var.get())
            
            # Max lot hesapla
            max_lot = int(exposure_limit / avg_price)
            defensive_threshold = int(max_lot * 0.955)  # %95.5
            offensive_threshold = int(max_lot * 0.927)  # %92.7
            
            # Aktif mod bilgisi
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            self.log_message(f"üìä Exposure kontrol√º ba≈ülatƒ±ldƒ± - Aktif hesap: {active_account}")
            
            # Aktif hesaptan pozisyonlarƒ± al
            positions = []
            if active_account == "HAMPRO":
                # HAMPRO mod kontrol√º
                if not self.hammer or not self.hammer.connected:
                    self.log_message("‚ö†Ô∏è HAMPRO baƒülantƒ±sƒ± yok!")
                    self.current_lot_label.config(text="HAMPRO baƒülantƒ±sƒ± yok!", foreground='red')
                    return {'mode': 'ERROR', 'can_add_positions': False}
                
                positions = self.hammer.get_positions_direct()
                self.log_message(f"‚úÖ HAMPRO'dan {len(positions)} pozisyon alƒ±ndƒ±")
                
            elif active_account in ["IBKR_GUN", "IBKR_PED"]:
                # IBKR mod kontrol√º (GUN veya PED)
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                    positions = self.mode_manager.ibkr_native_client.get_positions()
                    self.log_message(f"‚úÖ IBKR Native'dan {len(positions)} pozisyon alƒ±ndƒ± ({active_account})")
                elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                    positions = self.mode_manager.ibkr_client.get_positions()
                    self.log_message(f"‚úÖ IBKR Client'dan {len(positions)} pozisyon alƒ±ndƒ± ({active_account})")
                else:
                    self.log_message(f"‚ö†Ô∏è IBKR baƒülantƒ±sƒ± yok! ({active_account})")
                    self.current_lot_label.config(text=f"IBKR baƒülantƒ±sƒ± yok! ({active_account})", foreground='red')
                    return {'mode': 'ERROR', 'can_add_positions': False}
            else:
                self.log_message(f"‚ö†Ô∏è Bilinmeyen mod: {active_account}")
                return {'mode': 'ERROR', 'can_add_positions': False}
            
            # Toplam lot hesapla (long pozisyonlar + abs(short pozisyonlar))
            total_lots = 0
            long_lots = 0
            short_lots = 0
            
            # Debug: ƒ∞lk 3 pozisyonun yapƒ±sƒ±nƒ± g√∂ster
            if len(positions) > 0:
                self.log_message(f"üîç ƒ∞lk pozisyon √∂rneƒüi: {positions[0]}")
            
            for pos in positions:
                # √ñnce quantity dene, yoksa qty kullan
                qty_value = pos.get('quantity') or pos.get('qty') or pos.get('Quantity')
                if qty_value is None:
                    self.log_message(f"‚ö†Ô∏è Pozisyon'da qty bulunamadƒ±: {pos}")
                    continue
                
                try:
                    qty = int(float(qty_value))
                except (ValueError, TypeError):
                    self.log_message(f"‚ö†Ô∏è qty parse edilemedi: {qty_value} - {pos}")
                    continue
                
                if qty > 0:
                    long_lots += qty
                elif qty < 0:
                    short_lots += abs(qty)
                
                total_lots += abs(qty)
            
            # Modu belirle
            if total_lots > defensive_threshold:
                mode = "DEFANSIVE"  # Sadece KARBOTU
                mode_color = 'red'
            elif total_lots < offensive_threshold:
                mode = "OFANSIF"  # Hem KARBOTU hem ADDPOS
                mode_color = 'green'
            else:
                mode = "GE√áI≈û"  # Ge√ßi≈ü modu
                mode_color = 'orange'
            
            # Pot Toplam hesapla (Controller ON ise)
            pot_total = 0
            if hasattr(self, 'controller_enabled') and self.controller_enabled:
                pot_info = self.calculate_potential_total()
                pot_total = pot_info.get('pot_total', total_lots)
                self.log_message(f"üìä Pot Toplam: {pot_total:,} lot (Mevcut: {total_lots:,}, Arttƒ±rma: {pot_info.get('pot_increase', 0):,}, Azaltma: {pot_info.get('pot_decrease', 0):,})")
            
            # UI g√ºncelle
            if pot_total > 0:
                self.current_lot_label.config(
                    text=f"Hesap: {active_account} | Long: {long_lots:,} | Short: {short_lots:,} | Toplam: {total_lots:,} | Pot Toplam: {pot_total:,} | Mode: {mode}", 
                    foreground=mode_color
                )
            else:
                self.current_lot_label.config(
                    text=f"Hesap: {active_account} | Long: {long_lots:,} | Short: {short_lots:,} | Toplam: {total_lots:,} | Mode: {mode}", 
                    foreground=mode_color
                )
            
            # Detaylƒ± log
            self.log_message(f"üí∞ Exposure: {total_lots:,} / {max_lot:,} lot ({total_lots/max_lot*100:.1f}%) | Mode: {mode}")
            self.log_message(f"üìà Long: {long_lots:,} lot | Short: {short_lots:,} lot | Toplam: {total_lots:,} lot")
            self.log_message(f"üéØ E≈üikler: Defansif={defensive_threshold:,} lot (%95.5) | Ofansif d√∂n√º≈ü={offensive_threshold:,} lot (%92.7)")
            
            # Pot Max Lot hesapla
            pot_expo_limit = float(self.pot_expo_limit_var.get())
            pot_max_lot = int(pot_expo_limit / avg_price)
            
            return {
                'mode': mode,
                'total_lots': total_lots,
                'long_lots': long_lots,
                'short_lots': short_lots,
                'max_lot': max_lot,
                'pot_max_lot': pot_max_lot,
                'pot_total': pot_total,
                'defensive_threshold': defensive_threshold,
                'offensive_threshold': offensive_threshold,
                'can_add_positions': (mode == "OFANSIF" or mode == "GE√áI≈û"),
                'active_account': active_account
            }
            
        except Exception as e:
            self.log_message(f"‚ùå Exposure kontrol hatasƒ±: {e}")
            import traceback
            self.log_message(f"‚ùå Traceback: {traceback.format_exc()}")
            return {'mode': 'ERROR', 'can_add_positions': False}
    
    def update_psfalgo_positions(self):
        """Psfalgo pozisyonlarƒ±nƒ± g√ºncelle - Aktif mod i√ßin"""
        try:
            # Aktif modu kontrol et
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            # Aktif moda g√∂re pozisyonlarƒ± al
            if active_account in ["IBKR_GUN", "IBKR_PED"]:
                # IBKR pozisyonlarƒ±nƒ± al (GUN veya PED)
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                    current_positions = self.mode_manager.ibkr_native_client.get_positions()
                elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                    current_positions = self.mode_manager.ibkr_client.get_positions()
                else:
                    current_positions = []
            else:  # HAMPRO
                # HAMPRO pozisyonlarƒ±nƒ± al
                if self.hammer and self.hammer.connected:
                    current_positions = self.hammer.get_positions_direct()
                    self.log_message(f"üîÑ update_psfalgo_positions: {len(current_positions)} pozisyon alƒ±ndƒ±")
                    if current_positions:
                        self.log_message(f"üîç update_psfalgo_positions: ƒ∞lk pozisyon √∂rneƒüi: {current_positions[0]}")
                else:
                    current_positions = []
                    self.log_message("‚ùå update_psfalgo_positions: HAMPRO baƒülantƒ±sƒ± yok!")
            
            if not current_positions:
                self.log_message("‚ö†Ô∏è update_psfalgo_positions: Pozisyon bulunamadƒ±!")
                return
            
            # Pozisyonlarƒ± g√ºncelle
            for pos in current_positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '')
                current_qty = pos.get('quantity', None) or pos.get('qty', None) or pos.get('Quantity', 0)
                if current_qty is None:
                    current_qty = 0
                
                if symbol in self.psfalgo_positions:
                    old_qty = self.psfalgo_positions[symbol]['quantity']
                    change = current_qty - old_qty
                    
                    # Eƒüer deƒüi≈üim varsa, kontrolleri yap
                    if change != 0:
                        # Pozisyon deƒüi≈üim t√ºr√ºn√º belirle
                        change_type, change_amount = self.determine_position_change_type(symbol, old_qty, current_qty)
                        
                        # MAXALW limitini kontrol et
                        maxalw_ok, maxalw_msg = self.check_maxalw_limit(symbol, change_type, change_amount)
                        
                        # 3 saatlik limiti kontrol et
                        three_hour_ok, three_hour_msg = self.check_three_hour_limit(symbol, change_amount)
                        
                        # Log mesajlarƒ±
                        self.log_message(f"üìä {symbol}: {change_type} ({change_amount:+.0f})")
                        self.log_message(f"   MAXALW: {maxalw_msg}")
                        self.log_message(f"   3H: {three_hour_msg}")
                        
                        # Eƒüer limitler a≈üƒ±ldƒ±ysa uyarƒ± ver
                        if not maxalw_ok or not three_hour_ok:
                            self.log_message(f"‚ö†Ô∏è {symbol} Lƒ∞Mƒ∞T A≈ûILDI!")
                    
                    # Pozisyon deƒüi≈üimini kaydet
                    self.psfalgo_positions[symbol]['quantity'] = current_qty
                    self.psfalgo_positions[symbol]['three_hour_change'] += change
                    
                    # Tabloyu g√ºncelle
                    self.update_psfalgo_table_row(symbol, current_qty, change)
                    
                    # A√ßƒ±k emirleri kontrol et ve logla
                    open_orders_count = self.get_open_orders_count(symbol)
                    if open_orders_count > 0:
                        self.log_message(f"üìã {symbol}: {open_orders_count} a√ßƒ±k emir mevcut")
                    
                    # Emir analizi yap ve logla
                    order_analysis = self.analyze_order_impact(symbol, current_qty)
                    if order_analysis['long_increase_orders'] > 0 or order_analysis['long_decrease_orders'] > 0 or order_analysis['short_increase_orders'] > 0 or order_analysis['short_decrease_orders'] > 0:
                        self.log_message(f"üìä {symbol} Emir Analizi:")
                        self.log_message(f"   Long Artƒ±rma: {order_analysis['long_increase_orders']}")
                        self.log_message(f"   Long Azaltma: {order_analysis['long_decrease_orders']}")
                        self.log_message(f"   Short Artƒ±rma: {order_analysis['short_increase_orders']}")
                        self.log_message(f"   Short Azaltma: {order_analysis['short_decrease_orders']}")
                        self.log_message(f"   Potansiyel Pozisyon: {order_analysis['potential_position']}")
                        self.log_message(f"   Max Ek Long: {order_analysis['max_additional_long']}")
                        self.log_message(f"   Max Ek Short: {order_analysis['max_additional_short']}")
                        
                        # MAXALW kontrol√º
                        maxalw = self.get_maxalw_for_symbol(symbol)
                        if abs(order_analysis['potential_position']) > maxalw:
                            self.log_message(f"‚ö†Ô∏è {symbol} MAXALW A≈ûILDI! Potansiyel: {abs(order_analysis['potential_position'])} > {maxalw}")
                    
        except Exception as e:
            self.log_message(f"‚ùå Pozisyon g√ºncelleme hatasƒ±: {e}")
    
    def update_psfalgo_table_row(self, symbol, quantity, change):
        """Psfalgo tablosundaki satƒ±rƒ± g√ºncelle
        
        Kolon sƒ±rasƒ±:
        0: Symbol, 1: Current Qty, 2: Potential Qty, 3: Befday Cost, 4: Todays Cost, 
        5: Last Price, 6: Befday Qty, 7: Todays Qty Chg, 8: Max Change, 9: MAXALW, 
        10: 3H Change, 11: Open Orders, 12: Max Add Long, 13: Max Add Short, 14: Status
        """
        try:
            for item in self.psfalgo_tree.get_children():
                values = self.psfalgo_tree.item(item)['values']
                if values[0] == symbol:
                    # Satƒ±rƒ± g√ºncelle
                    new_values = list(values)
                    
                    # G√ºn ba≈üƒ± pozisyonu al
                    befday_qty = self.psfalgo_positions[symbol].get('befday_qty', 0)
                    if befday_qty == 0:
                        befday_qty = self.load_bef_position(symbol)
                        self.psfalgo_positions[symbol]['befday_qty'] = befday_qty
                    
                    # Bug√ºnk√º deƒüi≈üim hesapla
                    todays_qty_chg = quantity - befday_qty
                    self.psfalgo_positions[symbol]['todays_qty_chg'] = todays_qty_chg
                    
                    # Short pozisyonlarƒ± eksi ile g√∂ster
                    new_values[1] = f"{quantity:.0f}"  # Current Qty
                    
                    # Emir analizi yap
                    order_analysis = self.analyze_order_impact(symbol, quantity)
                    new_values[2] = f"{order_analysis['potential_position']:.0f}"  # Potansiyel pozisyon
                    
                    # Befday Cost (prev_close) g√ºncelle
                    befday_cost = self.get_prev_close_for_psfalgo(symbol)
                    new_values[3] = f"${befday_cost:.2f}" if befday_cost > 0 else "N/A"  # Befday Cost
                    self.psfalgo_positions[symbol]['befday_cost'] = befday_cost
                    
                    # Todays Cost g√ºncelle (bug√ºnk√º ortalama maliyet)
                    todays_cost = self.get_todays_cost_for_psfalgo(symbol, quantity, befday_qty)
                    new_values[4] = f"${todays_cost:.2f}" if todays_cost > 0 else ""  # Todays Cost
                    self.psfalgo_positions[symbol]['todays_cost'] = todays_cost
                    
                    # Last Price g√ºncelle
                    last_price = self.get_last_price_for_psfalgo(symbol)
                    new_values[5] = f"${last_price:.2f}" if last_price > 0 else "N/A"  # Last Price
                    self.psfalgo_positions[symbol]['last_price'] = last_price
                    
                    new_values[6] = f"{befday_qty:.0f}"  # Befday Qty
                    new_values[7] = f"{todays_qty_chg:+.0f}"  # Todays Qty Chg
                    
                    # Max Change g√ºncelle (MAXALW * rule_max_change_multiplier)
                    maxalw = self.psfalgo_positions[symbol]['maxalw']
                    multiplier = getattr(self, 'rule_max_change_multiplier', 0.75)
                    max_change = int(maxalw * multiplier) if maxalw > 0 else 0
                    new_values[8] = f"{max_change}"  # Max Change
                    new_values[9] = f"{maxalw:.0f}"  # MAXALW
                    
                    new_values[10] = f"{self.psfalgo_positions[symbol]['three_hour_change']:.0f}"  # 3H Change
                    
                    # A√ßƒ±k emirleri g√ºncelle
                    open_orders_count = self.get_open_orders_count(symbol)
                    new_values[11] = f"{open_orders_count}"  # Open Orders
                    
                    new_values[12] = f"{order_analysis['max_additional_long']:.0f}"  # Max ek long
                    new_values[13] = f"{order_analysis['max_additional_short']:.0f}"  # Max ek short
                    
                    # Durum kontrol√º
                    max_change = self.psfalgo_positions[symbol]['max_change']
                    three_hour_change = abs(self.psfalgo_positions[symbol]['three_hour_change'])
                    
                    # Potansiyel pozisyon MAXALW kontrol√º
                    maxalw = self.psfalgo_positions[symbol]['maxalw']
                    potential_position = order_analysis['potential_position']
                    
                    # G√ºn ba≈üƒ± pozisyon t√ºr√º kontrol√º
                    befday_qty = self.psfalgo_positions[symbol].get('befday_qty', 0)
                    position_type_violation = False
                    if befday_qty > 0 and potential_position < 0:
                        position_type_violation = True
                    elif befday_qty < 0 and potential_position > 0:
                        position_type_violation = True
                    
                    if position_type_violation:
                        new_values[14] = "‚ö†Ô∏è Pozisyon T√ºr√º ƒ∞hlali"
                    elif abs(potential_position) > maxalw:
                        new_values[14] = "‚ö†Ô∏è MAXALW A≈üƒ±ldƒ±"
                    elif three_hour_change > max_change:
                        new_values[14] = "‚ö†Ô∏è 3H Limit A≈üƒ±ldƒ±"
                    else:
                        new_values[14] = "‚úÖ Normal"
                    
                    self.psfalgo_tree.item(item, values=new_values)
                    break
                    
        except Exception as e:
            self.log_message(f"‚ùå Tablo g√ºncelleme hatasƒ±: {e}")
    
    def get_cached_orders(self):
        """Cache'lenmi≈ü emirleri al veya g√ºncelle (60 saniyede bir)"""
        try:
            import time
            current_time = time.time()
            
            # Cache s√ºresi dolmu≈ü mu kontrol et (60 saniye)
            if current_time - self.orders_cache_time > self.orders_cache_interval:
                # Cache'i g√ºncelle
                if hasattr(self, 'mode_manager'):
                    self.orders_cache = self.mode_manager.get_orders()
                    self.orders_cache_time = current_time
                    print(f"[PSFALGO] üîÑ Emir cache g√ºncellendi ({len(self.orders_cache)} emir)")
                else:
                    self.orders_cache = []
            
            return self.orders_cache
        except Exception as e:
            print(f"[PSFALGO] ‚ùå Emir cache hatasƒ±: {e}")
            return []
    
    def get_cached_positions(self, active_account=None):
        """Cache'lenmi≈ü pozisyonlarƒ± d√∂nd√ºr (60 saniye cache)"""
        try:
            import time
            current_time = time.time()
            
            # Aktif hesabƒ± belirle
            if active_account is None:
                if hasattr(self, 'mode_manager'):
                    active_account = self.mode_manager.get_active_account()
                else:
                    if self.hampro_mode:
                        active_account = "HAMPRO"
                    elif self.ibkr_gun_mode:
                        active_account = "IBKR_GUN"
                    elif self.ibkr_ped_mode:
                        active_account = "IBKR_PED"
                    else:
                        active_account = "HAMPRO"
            
            # Cache key'i aktif hesaba g√∂re
            cache_key = active_account
            
            # Cache yoksa veya s√ºresi dolmu≈üsa yenile
            if cache_key not in getattr(self, 'positions_cache', {}) or \
               cache_key not in getattr(self, 'positions_cache_time', {}) or \
               (current_time - self.positions_cache_time.get(cache_key, 0)) > self.orders_cache_interval:  # Aynƒ± interval (60 saniye)
                
                # Cache dict'leri olu≈ütur
                if not hasattr(self, 'positions_cache'):
                    self.positions_cache = {}
                if not hasattr(self, 'positions_cache_time'):
                    self.positions_cache_time = {}
                
                # Cache'i g√ºncelle
                self.positions_cache[cache_key] = []
                self.positions_cache_time[cache_key] = current_time
                
                # Aktif moda g√∂re pozisyonlarƒ± √ßek
                if active_account in ["IBKR_GUN", "IBKR_PED"]:
                    if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                        self.positions_cache[cache_key] = self.mode_manager.ibkr_native_client.get_positions()
                    elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                        self.positions_cache[cache_key] = self.mode_manager.ibkr_client.get_positions()
                else:  # HAMPRO
                    if self.hammer and self.hammer.connected:
                        self.positions_cache[cache_key] = self.hammer.get_positions_direct()
            
            return self.positions_cache.get(cache_key, [])
        except Exception as e:
            print(f"[PSFALGO] ‚ùå Pozisyon cache hatasƒ±: {e}")
            return []
    
    def get_open_orders_count(self, symbol):
        """Belirli bir sembol i√ßin a√ßƒ±k emir sayƒ±sƒ±nƒ± d√∂nd√ºr"""
        try:
            # Cache'lenmi≈ü emirleri al
            orders = self.get_cached_orders()
            if not orders:
                return 0
            
            # Symbol i√ßin a√ßƒ±k emirleri say
            count = 0
            for order in orders:
                order_symbol = order.get('symbol', '')
                # Symbol e≈üle≈ütirmesi (display symbol ile)
                if order_symbol == symbol:
                    count += 1
                # Alternatif e≈üle≈ütirme (base symbol ile)
                elif '-' in order_symbol:
                    base_symbol = order_symbol.split('-')[0]
                    if base_symbol == symbol.replace(' PR', ''):
                        count += 1
            
            return count
            
        except Exception as e:
            self.log_message(f"‚ùå A√ßƒ±k emir kontrol hatasƒ± ({symbol}): {e}")
            return 0
    
    def calculate_potential_total(self):
        """
        Pot Toplam hesapla: Mevcut pozisyon + A√ßƒ±k emirler (arttƒ±rma - azaltma)
        
        Returns:
            dict: {
                'current_total': int,      # Mevcut toplam lot (ABS)
                'pot_total': int,          # Potansiyel toplam lot (ABS)
                'pot_increase': int,       # Potansiyel arttƒ±rma emirleri toplamƒ±
                'pot_decrease': int,       # Potansiyel azaltma emirleri toplamƒ±
                'by_symbol': dict          # Her hisse i√ßin detay
            }
        """
        try:
            # Aktif modu kontrol et
            if hasattr(self, 'mode_manager'):
                active_account = self.mode_manager.get_active_account()
            else:
                if self.hampro_mode:
                    active_account = "HAMPRO"
                elif self.ibkr_gun_mode:
                    active_account = "IBKR_GUN"
                elif self.ibkr_ped_mode:
                    active_account = "IBKR_PED"
                else:
                    active_account = "HAMPRO"
            
            # Mevcut pozisyonlarƒ± al
            positions = []
            if active_account == "HAMPRO":
                if self.hammer and self.hammer.connected:
                    positions = self.hammer.get_positions_direct()
            elif active_account in ["IBKR_GUN", "IBKR_PED"]:
                if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                    positions = self.mode_manager.ibkr_native_client.get_positions()
                elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                    positions = self.mode_manager.ibkr_client.get_positions()
            
            # A√ßƒ±k emirleri al (cache'den)
            orders = self.get_cached_orders()
            
            # G√ºn ba≈üƒ± pozisyonlarƒ± y√ºkle (t√ºm semboller i√ßin)
            bef_positions = {}
            for pos in positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '')
                if symbol:
                    bef_positions[symbol] = self.load_bef_position(symbol)
            
            # Her hisse i√ßin analiz
            current_total = 0
            pot_total = 0
            pot_increase_total = 0
            pot_decrease_total = 0
            by_symbol = {}
            
            # T√ºm sembolleri topla (pozisyonlar + emirler)
            all_symbols = set()
            for pos in positions:
                symbol = pos.get('symbol', '') or pos.get('Symbol', '')
                if symbol:
                    all_symbols.add(symbol)
            for order in orders:
                symbol = order.get('symbol', '') or order.get('Symbol', '')
                if symbol:
                    all_symbols.add(symbol)
            
            for symbol in all_symbols:
                # Mevcut pozisyon
                current_pos = 0
                for pos in positions:
                    pos_symbol = pos.get('symbol', '') or pos.get('Symbol', '')
                    if pos_symbol == symbol:
                        qty = pos.get('quantity') or pos.get('qty') or pos.get('Quantity', 0)
                        current_pos = float(qty) if qty else 0
                        break
                
                # G√ºn ba≈üƒ± pozisyon
                bef_pos = bef_positions.get(symbol, 0)
                
                # A√ßƒ±k emirleri analiz et
                pot_increase = 0  # Pozisyon arttƒ±rma emirleri
                pot_decrease = 0  # Pozisyon azaltma emirleri
                
                for order in orders:
                    order_symbol = order.get('symbol', '') or order.get('Symbol', '')
                    if order_symbol != symbol:
                        continue
                    
                    # Status kontrol√º
                    status = order.get('status', '').upper() or order.get('Status', '').upper()
                    if status in ['CANCELLED', 'FILLED', 'REJECTED', 'API CANCELLED']:
                        continue
                    
                    # Remaining quantity
                    remaining = order.get('remaining', None) or order.get('Remaining', None)
                    if remaining is not None and remaining > 0:
                        order_qty = abs(float(remaining))
                    else:
                        order_qty = abs(float(order.get('qty', 0) or order.get('quantity', 0) or 0))
                    
                    if order_qty == 0:
                        continue
                    
                    # Emir t√ºr√º
                    order_action = order.get('action', '').upper() or order.get('Action', '').upper() or order.get('side', '').upper() or order.get('Side', '').upper()
                    
                    # Pozisyon arttƒ±rma/azaltma analizi
                    if current_pos >= 0:  # Long pozisyon var veya 0
                        if order_action in ['BUY', 'LONG']:
                            # Long artƒ±rma
                            pot_increase += order_qty
                        elif order_action in ['SELL', 'SHORT']:
                            # Long azaltma
                            pot_decrease += order_qty
                    else:  # Short pozisyon var
                        if order_action in ['SELL', 'SHORT']:
                            # Short artƒ±rma
                            pot_increase += order_qty
                        elif order_action in ['BUY', 'LONG']:
                            # Short azaltma
                            pot_decrease += order_qty
                
                # Potansiyel pozisyon hesapla
                if current_pos >= 0:
                    pot_pos = current_pos + pot_increase - pot_decrease
                else:
                    pot_pos = current_pos - pot_increase + pot_decrease
                
                # Toplamlara ekle (ABS)
                current_total += abs(current_pos)
                pot_total += abs(pot_pos)
                pot_increase_total += pot_increase
                pot_decrease_total += pot_decrease
                
                # Detay kaydet
                by_symbol[symbol] = {
                    'current': current_pos,
                    'bef': bef_pos,
                    'pot_increase': pot_increase,
                    'pot_decrease': pot_decrease,
                    'pot': pot_pos
                }
            
            return {
                'current_total': int(current_total),
                'pot_total': int(pot_total),
                'pot_increase': int(pot_increase_total),
                'pot_decrease': int(pot_decrease_total),
                'by_symbol': by_symbol
            }
            
        except Exception as e:
            print(f"[POT TOTAL] ‚ùå Hesaplama hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return {
                'current_total': 0,
                'pot_total': 0,
                'pot_increase': 0,
                'pot_decrease': 0,
                'by_symbol': {}
            }
    
    def analyze_order_impact(self, symbol, current_position):
        """
        Belirli bir sembol i√ßin emirlerin pozisyon √ºzerindeki etkisini analiz eder
        
        Args:
            symbol: Hisse sembol√º
            current_position: Mevcut pozisyon (pozitif=long, negatif=short)
            
        Returns:
            dict: {
                'long_increase_orders': int,  # Long artƒ±rma emirleri toplamƒ±
                'long_decrease_orders': int,  # Long azaltma emirleri toplamƒ±
                'short_increase_orders': int, # Short artƒ±rma emirleri toplamƒ±
                'short_decrease_orders': int, # Short azaltma emirleri toplamƒ±
                'potential_position': int,    # Potansiyel pozisyon
                'max_additional_long': int,   # Maksimum ek long emir
                'max_additional_short': int   # Maksimum ek short emir
            }
        """
        try:
            # Cache'lenmi≈ü emirleri al (60 saniyede bir g√ºncellenir)
            orders = self.get_cached_orders()
            if not orders:
                return {
                    'long_increase_orders': 0,
                    'long_decrease_orders': 0,
                    'short_increase_orders': 0,
                    'short_decrease_orders': 0,
                    'potential_position': current_position,
                    'max_additional_long': 0,
                    'max_additional_short': 0
                }
            
            # Emir analizi
            long_increase = 0  # Long artƒ±rma emirleri
            long_decrease = 0  # Long azaltma emirleri
            short_increase = 0 # Short artƒ±rma emirleri
            short_decrease = 0 # Short azaltma emirleri
            
            for order in orders:
                order_symbol = order.get('symbol', '') or order.get('Symbol', '')
                order_action = order.get('action', '').upper() or order.get('Action', '').upper() or order.get('side', '').upper() or order.get('Side', '').upper()
                
                # Remaining quantity kullan (daha doƒüru)
                remaining = order.get('remaining', None) or order.get('Remaining', None)
                if remaining is not None and remaining > 0:
                    order_qty = abs(float(remaining))
                else:
                    order_qty = abs(float(order.get('qty', 0) or order.get('quantity', 0) or order.get('Quantity', 0) or 0))
                
                # Status kontrol√º - sadece a√ßƒ±k emirleri say
                status = order.get('status', '').upper() or order.get('Status', '').upper()
                if status in ['CANCELLED', 'FILLED', 'REJECTED', 'API CANCELLED']:
                    continue  # Bu emirler artƒ±k a√ßƒ±k deƒüil
                
                # Symbol e≈üle≈ütirmesi
                is_match = False
                if order_symbol == symbol:
                    is_match = True
                elif '-' in order_symbol:
                    base_symbol = order_symbol.split('-')[0]
                    if base_symbol == symbol.replace(' PR', ''):
                        is_match = True
                
                if is_match and order_qty > 0:
                    if order_action in ['BUY', 'LONG']:
                        if current_position >= 0:
                            # Long pozisyon var veya yok, BUY emri long artƒ±rƒ±r
                            long_increase += order_qty
                        else:
                            # Short pozisyon var, BUY emri short azaltƒ±r
                            short_decrease += order_qty
                    elif order_action in ['SELL', 'SHORT']:
                        if current_position > 0:
                            # Long pozisyon var, SELL emri long azaltƒ±r
                            long_decrease += order_qty
                        else:
                            # Long pozisyon yok, SELL emri short artƒ±rƒ±r
                            short_increase += order_qty
            
            # Potansiyel pozisyon hesapla
            potential_position = current_position + long_increase - long_decrease - short_increase + short_decrease
            
            # MAXALW deƒüerini al
            maxalw = self.get_maxalw_for_symbol(symbol)
            
            # Maksimum ek emir hesapla
            max_additional_long = 0
            max_additional_short = 0
            
            if current_position >= 0:
                # Long pozisyon var veya yok
                current_long = max(0, current_position)
                max_additional_long = max(0, maxalw - current_long - long_increase + long_decrease)
                max_additional_short = max(0, maxalw - short_increase + short_decrease)
            else:
                # Short pozisyon var
                current_short = abs(current_position)
                max_additional_short = max(0, maxalw - current_short - short_increase + short_decrease)
                max_additional_long = max(0, maxalw - long_increase + long_decrease)
            
            return {
                'long_increase_orders': long_increase,
                'long_decrease_orders': long_decrease,
                'short_increase_orders': short_increase,
                'short_decrease_orders': short_decrease,
                'potential_position': potential_position,
                'max_additional_long': max_additional_long,
                'max_additional_short': max_additional_short
            }
            
        except Exception as e:
            self.log_message(f"‚ùå Emir analiz hatasƒ± ({symbol}): {e}")
            return {
                'long_increase_orders': 0,
                'long_decrease_orders': 0,
                'short_increase_orders': 0,
                'short_decrease_orders': 0,
                'potential_position': current_position,
                'max_additional_long': 0,
                'max_additional_short': 0
            }
    
    def log_message(self, message):
        """Psfalgo log mesajƒ± ekle"""
        try:
            timestamp = datetime.now().strftime("%H:%M:%S")
            log_entry = f"[{timestamp}] {message}\n"
            self.log_text.insert(tk.END, log_entry)
            self.log_text.see(tk.END)
        except Exception:
            pass
    
    def run_all_sequence(self, from_restart=False):
        """RUNALL butonu: Lot b√∂l√ºc√º a√ß ‚Üí Controller ON ‚Üí KARBOTU ba≈ülat ‚Üí ADDNEWPOS ‚Üí 1 dk bekle ‚Üí Emirleri iptal et ‚Üí Tekrar ba≈üla (s√ºrekli d√∂ng√º)
        
        Args:
            from_restart: True ise restart'tan geliyor demektir, d√∂ng√º kontrol√ºn√º atla
        """
        try:
            # RUNALL Allowed modunu kontrol et
            if hasattr(self, 'runall_allowed_var'):
                self.runall_allowed_mode = self.runall_allowed_var.get()
            else:
                self.runall_allowed_mode = False
            
            # RUNALL d√∂ng√ºs√º durumu kontrol√º (toggle)
            if not hasattr(self, 'runall_loop_running'):
                self.runall_loop_running = False
                self.runall_loop_count = 0
            
            # Eƒüer d√∂ng√º √ßalƒ±≈üƒ±yorsa durdur (ama restart'tan geliyorsa atla)
            if self.runall_loop_running and not from_restart:
                self.stop_runall_loop()
                return
            
            # D√∂ng√ºy√º ba≈ülat
            self.runall_loop_running = True
            
            # Tƒ±klanmƒ±≈ü butonlarƒ± ve kapatƒ±lmƒ±≈ü pencereleri temizle (yeni d√∂ng√º ba≈üladƒ±ƒüƒ±nda)
            if hasattr(self, '_clicked_buttons'):
                self._clicked_buttons.clear()
            if hasattr(self, '_closed_windows'):
                self._closed_windows.clear()
            
            print("[RUNALL] ‚ñ∂Ô∏è RUNALL sƒ±rasƒ± ba≈ülatƒ±lƒ±yor...")
            self.log_message("‚ñ∂Ô∏è RUNALL sƒ±rasƒ± ba≈ülatƒ±lƒ±yor...")
            
            # Buton metnini g√ºncelle
            if hasattr(self, 'runall_btn'):
                self.runall_btn.config(text="‚ñ∂Ô∏è RUNALL", state='disabled')
            if hasattr(self, 'runall_stop_btn'):
                self.runall_stop_btn.config(state='normal')
            
            # D√∂ng√º sayacƒ±nƒ± artƒ±r (her zaman artƒ±r, restart'tan geliyorsa da)
            self.runall_loop_count += 1
            
            print(f"[RUNALL] üîÑ {self.runall_loop_count}. d√∂ng√º ba≈ülatƒ±lƒ±yor...")
            self.log_message(f"üîÑ {self.runall_loop_count}. d√∂ng√º ba≈ülatƒ±lƒ±yor...")
            
            # D√∂ng√º sayacƒ± label'ƒ±nƒ± g√ºncelle
            if hasattr(self, 'runall_loop_label'):
                self.runall_loop_label.config(text=f"D√∂ng√º: {self.runall_loop_count}")
            
            # Psfalgo penceresini √∂ne getir (kullanƒ±cƒ± botu durdurabilsin)
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        self.psfalgo_window.lift()  # Pencereyi √∂ne getir
                        self.psfalgo_window.focus_force()  # Odaklan
                        self.psfalgo_window.attributes('-topmost', True)  # En √ºste getir
                        self.after(100, lambda: self.psfalgo_window.attributes('-topmost', False))  # 100ms sonra normal moda d√∂nd√ºr
                except Exception as e:
                    print(f"[RUNALL] ‚ö†Ô∏è Psfalgo penceresi √∂ne getirilemedi: {e}")
            
            # Adƒ±m 1: Lot b√∂l√ºc√º kontrol√º (checkbox'tan kontrol edilecek)
            if hasattr(self, 'runall_lot_divider_var'):
                lot_divider_enabled = self.runall_lot_divider_var.get()
                if lot_divider_enabled and not self.lot_divider_enabled:
                    self.lot_divider_enabled = True
                    self.btn_lot_divider.config(text="üì¶ Lot B√∂l√ºc√º: ON")
                    self.btn_lot_divider.config(style='Success.TButton')
                    print("[RUNALL] ‚úÖ Adƒ±m 1: Lot B√∂l√ºc√º a√ßƒ±ldƒ± (checkbox aktif)")
                    self.log_message("‚úÖ Adƒ±m 1: Lot B√∂l√ºc√º a√ßƒ±ldƒ± (checkbox aktif)")
                elif not lot_divider_enabled:
                    print("[RUNALL] ‚ÑπÔ∏è Adƒ±m 1: Lot B√∂l√ºc√º checkbox i≈üaretli deƒüil, a√ßƒ±lmayacak")
                    self.log_message("‚ÑπÔ∏è Adƒ±m 1: Lot B√∂l√ºc√º checkbox i≈üaretli deƒüil")
                else:
                    print("[RUNALL] ‚ÑπÔ∏è Adƒ±m 1: Lot B√∂l√ºc√º zaten a√ßƒ±k")
                    self.log_message("‚ÑπÔ∏è Adƒ±m 1: Lot B√∂l√ºc√º zaten a√ßƒ±k")
            else:
                print("[RUNALL] ‚ÑπÔ∏è Adƒ±m 1: Lot B√∂l√ºc√º checkbox bulunamadƒ±, a√ßƒ±lmayacak")
                self.log_message("‚ÑπÔ∏è Adƒ±m 1: Lot B√∂l√ºc√º checkbox bulunamadƒ±")
            
            # Adƒ±m 2: Controller'ƒ± ON yap (aktif moda g√∂re doƒüru CSV kullanƒ±lacak)
            if not self.controller_enabled:
                self.controller_enabled = True
                self.controller_btn.config(text="üéõÔ∏è Controller: ON")
                self.controller_btn.config(style='Success.TButton')
                
                # Aktif modu logla
                active_account = self.mode_manager.get_active_account()
                if active_account == "IBKR_GUN":
                    csv_file = "befibgun.csv"
                elif active_account == "IBKR_PED":
                    csv_file = "befibped.csv"
                elif active_account == "HAMPRO":
                    csv_file = "befham.csv"
                else:
                    csv_file = "bilinmeyen"
                
                print(f"[RUNALL] ‚úÖ Adƒ±m 2: Controller ON yapƒ±ldƒ± (CSV: {csv_file})")
                self.log_message(f"‚úÖ Adƒ±m 2: Controller ON yapƒ±ldƒ± (CSV: {csv_file})")
            else:
                print("[RUNALL] ‚ÑπÔ∏è Adƒ±m 2: Controller zaten ON")
                self.log_message("‚ÑπÔ∏è Adƒ±m 2: Controller zaten ON")
            
            # Adƒ±m 3: Pot Toplam kontrol√º ve ADDNEWPOS butonu durumu (thread'de yapƒ±lacak)
            def check_exposure_and_start_karbotu():
                """Exposure kontrol√ºn√º thread'de yap ve KARBOTU'yu ba≈ülat"""
                try:
                    # Exposure kontrol√º (bloklayƒ±cƒ± i≈ülem)
                    exposure_info = self.check_exposure_limits()
                    pot_total = exposure_info.get('pot_total', 0)
                    pot_max_lot = exposure_info.get('pot_max_lot', 63636)
                    total_lots = exposure_info.get('total_lots', 0)
                    max_lot = exposure_info.get('max_lot', 54545)
                    mode = exposure_info.get('mode', 'UNKNOWN')
                    
                    # UI thread'ine ge√ßi≈ü yaparak buton durumlarƒ±nƒ± g√ºncelle
                    def update_ui():
                        # Pot Toplam kontrol√º
                        if pot_total > 0 and pot_total >= pot_max_lot:
                            print(f"[RUNALL] ‚ö†Ô∏è Pot Toplam limiti a≈üƒ±ldƒ±: {pot_total:,} / {pot_max_lot:,}")
                            self.log_message(f"‚ö†Ô∏è Pot Toplam limiti a≈üƒ±ldƒ±: {pot_total:,} / {pot_max_lot:,}")
                            # ADDNEWPOS butonunu pasif yap
                            if hasattr(self, 'addnewpos_btn'):
                                self.addnewpos_btn.config(state='disabled')
                        else:
                            # ADDNEWPOS butonu durumu
                            if mode == "OFANSIF" and pot_total < pot_max_lot:
                                if hasattr(self, 'addnewpos_btn'):
                                    self.addnewpos_btn.config(state='normal')
                                    print(f"[RUNALL] ‚úÖ ADDNEWPOS aktif: Pot Toplam {pot_total:,} < Pot Max {pot_max_lot:,}")
                                    self.log_message(f"‚úÖ ADDNEWPOS aktif: Pot Toplam {pot_total:,} < Pot Max {pot_max_lot:,}")
                            else:
                                if hasattr(self, 'addnewpos_btn'):
                                    self.addnewpos_btn.config(state='disabled')
                        
                        # Adƒ±m 4: Mode'a g√∂re KARBOTU veya REDUCEMORE ba≈ülat
                        if mode == "OFANSIF":
                            print("[RUNALL] ‚úÖ Adƒ±m 4: Mode=OFANSIF ‚Üí KARBOTU ba≈ülatƒ±lƒ±yor...")
                            self.log_message("‚úÖ Adƒ±m 4: Mode=OFANSIF ‚Üí KARBOTU ba≈ülatƒ±lƒ±yor...")
                            
                            # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
                            self.update_idletasks()
                            
                            # KARBOTU bitince otomatik ADDNEWPOS tetikleme i√ßin callback ekle
                            self.runall_waiting_for_karbotu = True
                            self.runall_addnewpos_triggered = False  # ADDNEWPOS'un sadece bir kez tetiklenmesini saƒüla
                            
                            # KARBOTU'yu non-blocking ba≈ülat
                            self.after(100, self.start_karbotu_automation)
                        else:
                            # DEFANSIF veya GECIS modunda REDUCEMORE kullan
                            print(f"[RUNALL] ‚úÖ Adƒ±m 4: Mode={mode} ‚Üí REDUCEMORE ba≈ülatƒ±lƒ±yor...")
                            self.log_message(f"‚úÖ Adƒ±m 4: Mode={mode} ‚Üí REDUCEMORE ba≈ülatƒ±lƒ±yor...")
                            
                            # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
                            self.update_idletasks()
                            
                            # REDUCEMORE bitince otomatik ADDNEWPOS tetikleme i√ßin callback ekle
                            self.runall_waiting_for_reducemore = True
                            self.runall_addnewpos_triggered = False  # ADDNEWPOS'un sadece bir kez tetiklenmesini saƒüla
                            
                            # REDUCEMORE'u non-blocking ba≈ülat
                            self.after(100, self.start_reducemore_automation)
                    
                    # UI thread'ine ge√ßi≈ü yap
                    self.after(0, update_ui)
                    
                except Exception as e:
                    print(f"[RUNALL] ‚ùå Exposure kontrol√º hatasƒ±: {e}")
                    self.log_message(f"‚ùå Exposure kontrol√º hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile KARBOTU'yu ba≈ülat
                    self.after(0, lambda: self.start_karbotu_automation())
            
            # Exposure kontrol√ºn√º thread'de yap
            import threading
            exposure_thread = threading.Thread(target=check_exposure_and_start_karbotu, daemon=True)
            exposure_thread.start()
            
            # KARBOTU bitince kontrol et (her 5 saniyede bir kontrol) - SADECE BACKUP olarak
            # Asƒ±l tetikleme karbotu_proceed_to_next_step ve karbotu_step_13'ten gelecek
            # self.after(5000, self.runall_check_karbotu_and_addnewpos)  # YORUM SATIRI - √áift tetiklemeyi √∂nlemek i√ßin
            
            print("[RUNALL] ‚úÖ RUNALL sƒ±rasƒ± ba≈ülatƒ±ldƒ± (Mode'a g√∂re KARBOTU veya REDUCEMORE √ßalƒ±≈üƒ±yor, bitince ADDNEWPOS kontrol edilecek)")
            self.log_message("‚úÖ RUNALL sƒ±rasƒ± ba≈ülatƒ±ldƒ± (Mode'a g√∂re KARBOTU veya REDUCEMORE √ßalƒ±≈üƒ±yor, bitince ADDNEWPOS kontrol edilecek)")
            
            # Allowed modunda otomatik onay ba≈ülat
            if self.runall_allowed_mode:
                print("[RUNALL] ‚úÖ Allowed modu aktif - Otomatik onay sistemi √ßalƒ±≈üƒ±yor")
                self.log_message("‚úÖ Allowed modu aktif - Otomatik onay sistemi √ßalƒ±≈üƒ±yor")
                self.start_runall_auto_confirm_loop()
            
        except Exception as e:
            print(f"[RUNALL] ‚ùå RUNALL hatasƒ±: {e}")
            self.log_message(f"‚ùå RUNALL hatasƒ±: {e}")
            if not self.runall_allowed_mode:
                messagebox.showerror("Hata", f"RUNALL ba≈ülatƒ±lamadƒ±: {e}")
    
    def load_excluded_tickers_from_csv(self):
        """excluder_psfalgo.csv dosyasƒ±ndan excluded ticker'larƒ± y√ºkle"""
        try:
            import pandas as pd
            import os
            
            csv_file = "excluder_psfalgo.csv"
            
            if not hasattr(self, 'excluded_tickers'):
                self.excluded_tickers = set()
            
            if os.path.exists(csv_file):
                df = pd.read_csv(csv_file)
                
                # Symbol veya Ticker kolonunu bul
                symbol_col = None
                if 'Symbol' in df.columns:
                    symbol_col = 'Symbol'
                elif 'Ticker' in df.columns:
                    symbol_col = 'Ticker'
                elif len(df.columns) > 0:
                    symbol_col = df.columns[0]  # ƒ∞lk kolonu kullan
                
                if symbol_col:
                    tickers = df[symbol_col].dropna().astype(str).str.strip().str.upper()
                    self.excluded_tickers = set(tickers.tolist())
                    print(f"[EXCLUDER] ‚úÖ {len(self.excluded_tickers)} ticker CSV'den y√ºklendi")
                else:
                    print(f"[EXCLUDER] ‚ö†Ô∏è CSV dosyasƒ±nda uygun kolon bulunamadƒ±")
            else:
                print(f"[EXCLUDER] ‚ÑπÔ∏è CSV dosyasƒ± bulunamadƒ±, bo≈ü liste ba≈ülatƒ±lƒ±yor")
                self.excluded_tickers = set()
                
        except Exception as e:
            print(f"[EXCLUDER] ‚ùå CSV y√ºkleme hatasƒ±: {e}")
            if not hasattr(self, 'excluded_tickers'):
                self.excluded_tickers = set()
    
    def save_excluded_tickers_to_csv(self):
        """Excluded ticker'larƒ± excluder_psfalgo.csv dosyasƒ±na kaydet"""
        try:
            import pandas as pd
            
            csv_file = "excluder_psfalgo.csv"
            
            if not hasattr(self, 'excluded_tickers') or not self.excluded_tickers:
                # Bo≈ü liste ise CSV'yi sil veya bo≈ü DataFrame kaydet
                df = pd.DataFrame(columns=['Symbol'])
                df.to_csv(csv_file, index=False)
                print(f"[EXCLUDER] ‚úÖ CSV dosyasƒ± temizlendi")
            else:
                # Ticker'larƒ± DataFrame'e √ßevir
                tickers_list = sorted(list(self.excluded_tickers))
                df = pd.DataFrame({'Symbol': tickers_list})
                df.to_csv(csv_file, index=False)
                print(f"[EXCLUDER] ‚úÖ {len(tickers_list)} ticker CSV'ye kaydedildi: {csv_file}")
                
        except Exception as e:
            print(f"[EXCLUDER] ‚ùå CSV kaydetme hatasƒ±: {e}")
            raise
    
    def load_rules_from_csv(self):
        """kurallar.csv dosyasƒ±ndan kurallarƒ± y√ºkle"""
        try:
            import pandas as pd
            import os
            
            csv_file = "kurallar.csv"
            
            if os.path.exists(csv_file):
                df = pd.read_csv(csv_file)
                
                # Her kural i√ßin deƒüeri oku
                for _, row in df.iterrows():
                    rule_name = row.get('Kural', '')
                    rule_value = row.get('Deger', 0)
                    
                    try:
                        # Temel kurallar
                        if rule_name == 'max_change_multiplier':
                            self.rule_max_change_multiplier = float(rule_value)
                        elif rule_name == 'single_max_position_multiplier':
                            self.rule_single_max_position_multiplier = float(rule_value)
                        elif rule_name == 'avg_adv_divisor':
                            self.rule_avg_adv_divisor = float(rule_value)
                        elif rule_name == 'min_lot':
                            self.rule_min_lot = int(float(rule_value))
                        
                        # ADDNEWPOS Kurallarƒ±
                        elif rule_name.startswith('addnewpos_'):
                            parts = rule_name.split('_')
                            if len(parts) >= 3:
                                threshold = int(parts[1])
                                field = parts[2]
                                if threshold in self.addnewpos_rules:
                                    current = self.addnewpos_rules[threshold]
                                    if field == 'maxalw':
                                        self.addnewpos_rules[threshold] = (float(rule_value), current[1])
                                    elif field == 'port':
                                        self.addnewpos_rules[threshold] = (current[0], float(rule_value))
                        
                        # REDUCE Kurallarƒ±
                        elif rule_name.startswith('reduce_'):
                            parts = rule_name.split('_')
                            if len(parts) >= 3:
                                threshold = int(parts[1])
                                field = parts[2]
                                if threshold in self.reduce_rules:
                                    current = self.reduce_rules[threshold]
                                    val = None if rule_value == 'None' or rule_value == '' else float(rule_value)
                                    if field == 'maxalw':
                                        self.reduce_rules[threshold] = (val, current[1])
                                    elif field == 'befday':
                                        self.reduce_rules[threshold] = (current[0], val)
                                        
                    except (ValueError, TypeError) as e:
                        print(f"[KURALLAR] ‚ö†Ô∏è Kural parse hatasƒ±: {rule_name} = {rule_value} - {e}")
                
                print(f"[KURALLAR] ‚úÖ Kurallar CSV'den y√ºklendi:")
                print(f"   Temel: Max Change={self.rule_max_change_multiplier}, SingleMax={self.rule_single_max_position_multiplier}, AVG_ADV√∑={self.rule_avg_adv_divisor}, MinLot={self.rule_min_lot}")
                print(f"   ADDNEWPOS: {self.addnewpos_rules}")
                print(f"   REDUCE: {self.reduce_rules}")
            else:
                print(f"[KURALLAR] ‚ÑπÔ∏è CSV dosyasƒ± bulunamadƒ±, varsayƒ±lan deƒüerler kullanƒ±lƒ±yor")
                
        except Exception as e:
            print(f"[KURALLAR] ‚ùå CSV y√ºkleme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def save_rules_to_csv(self):
        """Kurallarƒ± kurallar.csv dosyasƒ±na kaydet"""
        try:
            import pandas as pd
            
            csv_file = "kurallar.csv"
            
            # DataFrame olu≈ütur - Temel kurallar
            data = [
                {'Kural': 'max_change_multiplier', 'Deger': self.rule_max_change_multiplier, 'Aciklama': 'Max Change = MAXALW * bu deƒüer'},
                {'Kural': 'single_max_position_multiplier', 'Deger': self.rule_single_max_position_multiplier, 'Aciklama': 'Tek Pozisyon Limiti = MAXALW * bu deƒüer'},
                {'Kural': 'avg_adv_divisor', 'Deger': self.rule_avg_adv_divisor, 'Aciklama': 'MAXALW = AVG_ADV / bu deƒüer'},
                {'Kural': 'min_lot', 'Deger': self.rule_min_lot, 'Aciklama': 'Minimum lot deƒüeri'}
            ]
            
            # ADDNEWPOS Kurallarƒ±
            for threshold, (maxalw_mult, port_pct) in self.addnewpos_rules.items():
                data.append({'Kural': f'addnewpos_{threshold}_maxalw', 'Deger': maxalw_mult, 'Aciklama': f'ADDNEWPOS <%{threshold}: MAXALW √ßarpanƒ±'})
                data.append({'Kural': f'addnewpos_{threshold}_port', 'Deger': port_pct, 'Aciklama': f'ADDNEWPOS <%{threshold}: Portf√∂y % limiti'})
            
            # REDUCE Kurallarƒ±
            for threshold, (maxalw_mult, befday_mult) in self.reduce_rules.items():
                maxalw_val = 'None' if maxalw_mult is None else maxalw_mult
                befday_val = 'None' if befday_mult is None else befday_mult
                data.append({'Kural': f'reduce_{threshold}_maxalw', 'Deger': maxalw_val, 'Aciklama': f'REDUCE <%{threshold}: MAXALW √ßarpanƒ±'})
                data.append({'Kural': f'reduce_{threshold}_befday', 'Deger': befday_val, 'Aciklama': f'REDUCE <%{threshold}: BefQty √ßarpanƒ±'})
            
            df = pd.DataFrame(data)
            df.to_csv(csv_file, index=False)
            
            print(f"[KURALLAR] ‚úÖ Kurallar CSV'ye kaydedildi: {csv_file}")
            print(f"   Temel: Max Change={self.rule_max_change_multiplier}, SingleMax={self.rule_single_max_position_multiplier}, AVG_ADV√∑={self.rule_avg_adv_divisor}, MinLot={self.rule_min_lot}")
                
        except Exception as e:
            print(f"[KURALLAR] ‚ùå CSV kaydetme hatasƒ±: {e}")
            raise
    
    def show_rules_dialog(self):
        """Kurallar dialog penceresini g√∂ster - Geli≈ümi≈ü versiyon"""
        try:
            dialog = tk.Toplevel(self.psfalgo_window)
            dialog.title("üìã PSFAlgo Kurallarƒ±")
            dialog.geometry("800x650")
            dialog.transient(self.psfalgo_window)
            dialog.grab_set()
            
            # Ba≈ülƒ±k
            title_label = ttk.Label(dialog, text="PSFAlgo Kural Ayarlarƒ±", 
                                   font=("Arial", 14, "bold"))
            title_label.pack(pady=5)
            
            # Notebook (Tab sistemi)
            notebook = ttk.Notebook(dialog)
            notebook.pack(fill='both', expand=True, padx=10, pady=5)
            
            # ============ TAB 1: TEMEL KURALLAR ============
            basic_tab = ttk.Frame(notebook)
            notebook.add(basic_tab, text="‚öôÔ∏è Temel Kurallar")
            
            basic_frame = ttk.LabelFrame(basic_tab, text="Temel Hesaplama Kurallarƒ±", padding=15)
            basic_frame.pack(fill='both', expand=True, padx=10, pady=10)
            
            # Kural 1: Max Change
            rule1_frame = ttk.Frame(basic_frame)
            rule1_frame.pack(fill='x', pady=8)
            ttk.Label(rule1_frame, text="Max Change (Todays Chg limiti):", font=("Arial", 10, "bold"), width=30).pack(side='left')
            ttk.Label(rule1_frame, text="MAXALW √ó", font=("Arial", 10)).pack(side='left', padx=5)
            self.rule1_var = tk.StringVar(value=str(self.rule_max_change_multiplier))
            ttk.Entry(rule1_frame, textvariable=self.rule1_var, width=8).pack(side='left', padx=2)
            
            # Kural 2: Single Max Position
            rule2_frame = ttk.Frame(basic_frame)
            rule2_frame.pack(fill='x', pady=8)
            ttk.Label(rule2_frame, text="Tek Pozisyon Limiti:", font=("Arial", 10, "bold"), width=30).pack(side='left')
            ttk.Label(rule2_frame, text="MAXALW √ó", font=("Arial", 10)).pack(side='left', padx=5)
            self.rule2_var = tk.StringVar(value=str(self.rule_single_max_position_multiplier))
            ttk.Entry(rule2_frame, textvariable=self.rule2_var, width=8).pack(side='left', padx=2)
            
            # Kural 3: AVG_ADV Divisor
            rule3_frame = ttk.Frame(basic_frame)
            rule3_frame.pack(fill='x', pady=8)
            ttk.Label(rule3_frame, text="MAXALW Hesabƒ±:", font=("Arial", 10, "bold"), width=30).pack(side='left')
            ttk.Label(rule3_frame, text="AVG_ADV √∑", font=("Arial", 10)).pack(side='left', padx=5)
            self.rule3_var = tk.StringVar(value=str(self.rule_avg_adv_divisor))
            ttk.Entry(rule3_frame, textvariable=self.rule3_var, width=8).pack(side='left', padx=2)
            
            # Kural 4: Minimum Lot
            rule4_frame = ttk.Frame(basic_frame)
            rule4_frame.pack(fill='x', pady=8)
            ttk.Label(rule4_frame, text="Minimum Lot Deƒüeri:", font=("Arial", 10, "bold"), width=30).pack(side='left')
            self.rule_min_lot_var = tk.StringVar(value=str(self.rule_min_lot))
            ttk.Entry(rule4_frame, textvariable=self.rule_min_lot_var, width=8).pack(side='left', padx=5)
            ttk.Label(rule4_frame, text="(MAXALW√ó√ßarpan < bu deƒüer ise, bu deƒüer kullanƒ±lƒ±r)", font=("Arial", 8), foreground="gray").pack(side='left', padx=5)
            
            # ============ TAB 2: ADDNEWPOS KURALLARI ============
            addnewpos_tab = ttk.Frame(notebook)
            notebook.add(addnewpos_tab, text="‚ûï ADDNEWPOS (Poz. Artƒ±rma)")
            
            addnewpos_frame = ttk.LabelFrame(addnewpos_tab, text="Pozisyon Artƒ±rma Kurallarƒ± (BefQty / Portf√∂y Oranƒ±na G√∂re)", padding=10)
            addnewpos_frame.pack(fill='both', expand=True, padx=10, pady=10)
            
            # Ba≈ülƒ±k satƒ±rƒ±
            header_frame = ttk.Frame(addnewpos_frame)
            header_frame.pack(fill='x', pady=5)
            ttk.Label(header_frame, text="E≈üik (<%)", font=("Arial", 9, "bold"), width=12).pack(side='left', padx=5)
            ttk.Label(header_frame, text="MAXALW √áarpanƒ±", font=("Arial", 9, "bold"), width=15).pack(side='left', padx=5)
            ttk.Label(header_frame, text="Portf√∂y % Limiti", font=("Arial", 9, "bold"), width=15).pack(side='left', padx=5)
            ttk.Label(header_frame, text="A√ßƒ±klama", font=("Arial", 9, "bold")).pack(side='left', padx=5)
            
            ttk.Separator(addnewpos_frame, orient='horizontal').pack(fill='x', pady=5)
            
            # ADDNEWPOS deƒüi≈ükenleri
            self.addnewpos_vars = {}
            addnewpos_descriptions = {
                1: "BefQty < %1 (K√º√ß√ºk/Yeni poz.)",
                3: "BefQty %1 - %2.99",
                5: "BefQty %3 - %4.99",
                7: "BefQty %5 - %6.99",
                10: "BefQty %7 - %9.99",
                100: "BefQty >= %10 (B√ºy√ºk poz.)"
            }
            
            for threshold in [1, 3, 5, 7, 10, 100]:
                row_frame = ttk.Frame(addnewpos_frame)
                row_frame.pack(fill='x', pady=3)
                
                maxalw_mult, port_pct = self.addnewpos_rules.get(threshold, (0.5, 5.0))
                
                ttk.Label(row_frame, text=f"< {threshold}%" if threshold < 100 else "‚â• 10%", width=12).pack(side='left', padx=5)
                
                maxalw_var = tk.StringVar(value=str(maxalw_mult))
                ttk.Entry(row_frame, textvariable=maxalw_var, width=10).pack(side='left', padx=5)
                
                port_var = tk.StringVar(value=str(port_pct))
                ttk.Entry(row_frame, textvariable=port_var, width=10).pack(side='left', padx=5)
                
                ttk.Label(row_frame, text=addnewpos_descriptions.get(threshold, ""), font=("Arial", 8), foreground="gray").pack(side='left', padx=5)
                
                self.addnewpos_vars[threshold] = (maxalw_var, port_var)
            
            # A√ßƒ±klama
            info_frame = ttk.Frame(addnewpos_tab)
            info_frame.pack(fill='x', padx=10, pady=5)
            ttk.Label(info_frame, text="üìå Limit = min(MAXALW √ó √áarpan, Portf√∂y √ó % Limit)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            ttk.Label(info_frame, text="üìå MAXALW √ó √áarpan < Min Lot ise, Min Lot kullanƒ±lƒ±r", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            
            # ============ TAB 3: REDUCE KURALLARI ============
            reduce_tab = ttk.Frame(notebook)
            notebook.add(reduce_tab, text="üìâ KARBOTU/REDUCEMORE (Poz. Azaltma)")
            
            reduce_frame = ttk.LabelFrame(reduce_tab, text="Pozisyon Azaltma Kurallarƒ± (BefQty / Portf√∂y Oranƒ±na G√∂re)", padding=10)
            reduce_frame.pack(fill='both', expand=True, padx=10, pady=10)
            
            # Ba≈ülƒ±k satƒ±rƒ±
            header_frame2 = ttk.Frame(reduce_frame)
            header_frame2.pack(fill='x', pady=5)
            ttk.Label(header_frame2, text="E≈üik (<%)", font=("Arial", 9, "bold"), width=12).pack(side='left', padx=5)
            ttk.Label(header_frame2, text="MAXALW √áarpanƒ±", font=("Arial", 9, "bold"), width=15).pack(side='left', padx=5)
            ttk.Label(header_frame2, text="BefQty √áarpanƒ±", font=("Arial", 9, "bold"), width=15).pack(side='left', padx=5)
            ttk.Label(header_frame2, text="A√ßƒ±klama", font=("Arial", 9, "bold")).pack(side='left', padx=5)
            
            ttk.Separator(reduce_frame, orient='horizontal').pack(fill='x', pady=5)
            
            # REDUCE deƒüi≈ükenleri
            self.reduce_vars = {}
            reduce_descriptions = {
                3: "BefQty < %3 (Sƒ±nƒ±rsƒ±z, ters poz. yasak)",
                5: "BefQty %3 - %4.99",
                7: "BefQty %5 - %6.99",
                10: "BefQty %7 - %9.99",
                100: "BefQty >= %10 (B√ºy√ºk poz.)"
            }
            
            for threshold in [3, 5, 7, 10, 100]:
                row_frame = ttk.Frame(reduce_frame)
                row_frame.pack(fill='x', pady=3)
                
                maxalw_mult, befday_mult = self.reduce_rules.get(threshold, (0.5, 0.5))
                
                ttk.Label(row_frame, text=f"< {threshold}%" if threshold < 100 else "‚â• 10%", width=12).pack(side='left', padx=5)
                
                maxalw_val = "" if maxalw_mult is None else str(maxalw_mult)
                maxalw_var = tk.StringVar(value=maxalw_val)
                ttk.Entry(row_frame, textvariable=maxalw_var, width=10).pack(side='left', padx=5)
                
                befday_val = "" if befday_mult is None else str(befday_mult)
                befday_var = tk.StringVar(value=befday_val)
                ttk.Entry(row_frame, textvariable=befday_var, width=10).pack(side='left', padx=5)
                
                ttk.Label(row_frame, text=reduce_descriptions.get(threshold, ""), font=("Arial", 8), foreground="gray").pack(side='left', padx=5)
                
                self.reduce_vars[threshold] = (maxalw_var, befday_var)
            
            # A√ßƒ±klama
            info_frame2 = ttk.Frame(reduce_tab)
            info_frame2.pack(fill='x', padx=10, pady=5)
            ttk.Label(info_frame2, text="üìå Limit = min(MAXALW √ó √áarpan, BefQty √ó √áarpan)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            ttk.Label(info_frame2, text="üìå Bo≈ü bƒ±rakƒ±lan deƒüerler = Sƒ±nƒ±rsƒ±z (ama ters pozisyona ge√ßi≈ü yasak)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            ttk.Label(info_frame2, text="üìå BefQty < Min Lot ise, tamamƒ± satƒ±labilir (≈üart aranmaz)", font=("Arial", 9, "italic"), foreground="blue").pack(anchor='w')
            
            # ============ BUTONLAR ============
            button_frame = ttk.Frame(dialog)
            button_frame.pack(fill='x', padx=20, pady=10)
            
            def save_and_close():
                try:
                    # Temel kurallarƒ± g√ºncelle
                    self.rule_max_change_multiplier = float(self.rule1_var.get())
                    self.rule_single_max_position_multiplier = float(self.rule2_var.get())
                    self.rule_avg_adv_divisor = float(self.rule3_var.get())
                    self.rule_min_lot = int(float(self.rule_min_lot_var.get()))
                    
                    # ADDNEWPOS kurallarƒ±nƒ± g√ºncelle
                    for threshold, (maxalw_var, port_var) in self.addnewpos_vars.items():
                        try:
                            maxalw_val = float(maxalw_var.get())
                            port_val = float(port_var.get())
                            self.addnewpos_rules[threshold] = (maxalw_val, port_val)
                        except ValueError:
                            pass
                    
                    # REDUCE kurallarƒ±nƒ± g√ºncelle
                    for threshold, (maxalw_var, befday_var) in self.reduce_vars.items():
                        try:
                            maxalw_val = None if maxalw_var.get().strip() == '' else float(maxalw_var.get())
                            befday_val = None if befday_var.get().strip() == '' else float(befday_var.get())
                            self.reduce_rules[threshold] = (maxalw_val, befday_val)
                        except ValueError:
                            pass
                    
                    # CSV'ye kaydet
                    self.save_rules_to_csv()
                    
                    # Pozisyon tablosunu yenile
                    self.load_psfalgo_positions()
                    
                    self.log_message("‚úÖ T√ºm kurallar g√ºncellendi ve kaydedildi")
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", "Kurallar kaydedildi ve uygulandƒ±!")
                    dialog.destroy()
                    
                except ValueError as e:
                    messagebox.showerror("Hata", f"Ge√ßersiz deƒüer: {e}")
                except Exception as e:
                    messagebox.showerror("Hata", f"Kaydetme hatasƒ±: {e}")
            
            def reset_to_defaults():
                # Temel kurallar
                self.rule1_var.set("0.75")
                self.rule2_var.set("1.0")
                self.rule3_var.set("10")
                self.rule_min_lot_var.set("400")
                
                # ADDNEWPOS varsayƒ±lanlarƒ±
                defaults_addnewpos = {1: (0.50, 5.0), 3: (0.40, 4.0), 5: (0.30, 3.0), 7: (0.20, 2.0), 10: (0.10, 1.5), 100: (0.05, 1.0)}
                for threshold, (maxalw_var, port_var) in self.addnewpos_vars.items():
                    m, p = defaults_addnewpos.get(threshold, (0.5, 5.0))
                    maxalw_var.set(str(m))
                    port_var.set(str(p))
                
                # REDUCE varsayƒ±lanlarƒ±
                defaults_reduce = {3: (None, None), 5: (0.75, 0.75), 7: (0.60, 0.60), 10: (0.50, 0.50), 100: (0.40, 0.40)}
                for threshold, (maxalw_var, befday_var) in self.reduce_vars.items():
                    m, b = defaults_reduce.get(threshold, (0.5, 0.5))
                    maxalw_var.set("" if m is None else str(m))
                    befday_var.set("" if b is None else str(b))
            
            ttk.Button(button_frame, text="üíæ Kaydet ve Kapat", command=save_and_close, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal", command=dialog.destroy).pack(side='left', padx=5)
            ttk.Button(button_frame, text="üîÑ Varsayƒ±lana D√∂n", command=reset_to_defaults).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KURALLAR] ‚ùå Dialog hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Kurallar penceresi a√ßƒ±lamadƒ±: {e}")
    
    def round_lot(self, lot, is_reduce=False, remaining_position=0):
        """
        Lot yuvarlamasƒ± yap
        - 100'l√ºk tam sayƒ±ya yuvarla
        - 200'den k√º√ß√ºkse 200'e yuvarla
        - Pozisyon azaltmada kalan < 200 ise 0'a getir
        """
        if lot <= 0:
            return 0
        
        # 100'e yuvarla
        rounded = round(lot / 100) * 100
        
        # 200'den k√º√ß√ºkse 200 yap
        if rounded < 200:
            rounded = 200
        
        # Pozisyon azaltmada, kalan pozisyon 200'den az olacaksa tamamƒ±nƒ± sat
        if is_reduce and remaining_position > 0:
            if remaining_position - rounded < 200 and remaining_position - rounded > 0:
                rounded = remaining_position  # Tamamƒ±nƒ± sat (0'a getir)
        
        return int(rounded)
    
    def get_portfolio_size(self):
        """Potansiyel portf√∂y b√ºy√ºkl√ºƒü√ºn√º hesapla (lot cinsinden)"""
        try:
            pot_expo_limit = float(self.pot_expo_limit_var.get())
            avg_price = float(self.avg_price_var.get())
            return int(pot_expo_limit / avg_price)
        except:
            return 63636  # Varsayƒ±lan: 1.4M / 22
    
    def get_befday_portfolio_ratio(self, befday_qty):
        """BefDay Qty'nin portf√∂y i√ßindeki y√ºzdesini hesapla"""
        portfolio_size = self.get_portfolio_size()
        if portfolio_size <= 0:
            return 0
        return (abs(befday_qty) / portfolio_size) * 100
    
    def get_addnewpos_limit(self, symbol, maxalw, befday_qty):
        """
        ADDNEWPOS i√ßin g√ºnl√ºk limit hesapla
        
        Returns: (limit_lot, reason)
        """
        try:
            portfolio_size = self.get_portfolio_size()
            ratio = self.get_befday_portfolio_ratio(befday_qty)
            
            # Hangi e≈üiƒüe d√º≈ü√ºyor?
            thresholds = sorted(self.addnewpos_rules.keys())
            selected_threshold = thresholds[-1]  # Varsayƒ±lan en b√ºy√ºk
            
            for threshold in thresholds:
                if ratio < threshold:
                    selected_threshold = threshold
                    break
            
            maxalw_mult, port_pct = self.addnewpos_rules.get(selected_threshold, (0.5, 5.0))
            
            # Limit 1: MAXALW √ó √ßarpan (minimum rule_min_lot)
            limit1 = maxalw * maxalw_mult
            if limit1 < self.rule_min_lot:
                limit1 = self.rule_min_lot
            
            # Limit 2: Portf√∂y √ó y√ºzde
            limit2 = portfolio_size * (port_pct / 100)
            
            # ƒ∞kisinin minimumu
            final_limit = min(limit1, limit2)
            final_limit = self.round_lot(final_limit)
            
            reason = f"BefQty={befday_qty:.0f} (Port %{ratio:.1f}), E≈üik=<%{selected_threshold}, " \
                    f"Limit1=MAXALW√ó{maxalw_mult}={limit1:.0f}, Limit2=Port√ó%{port_pct}={limit2:.0f}, " \
                    f"Final={final_limit}"
            
            return final_limit, reason
            
        except Exception as e:
            print(f"[ADDNEWPOS LIMIT] ‚ùå Hesaplama hatasƒ±: {e}")
            return self.rule_min_lot, f"Hata: {e}"
    
    def get_reduce_limit(self, symbol, maxalw, befday_qty):
        """
        KARBOTU/REDUCEMORE i√ßin g√ºnl√ºk azaltma limiti hesapla
        
        Returns: (limit_lot, reason, is_unlimited)
        """
        try:
            abs_befday = abs(befday_qty)
            
            # Eƒüer BefQty < min_lot ise, tamamƒ± satƒ±labilir (≈üart aranmaz)
            if abs_befday < self.rule_min_lot:
                return abs_befday, f"BefQty={befday_qty:.0f} < MinLot={self.rule_min_lot}, tamamƒ± satƒ±labilir", True
            
            portfolio_size = self.get_portfolio_size()
            ratio = self.get_befday_portfolio_ratio(befday_qty)
            
            # Hangi e≈üiƒüe d√º≈ü√ºyor?
            thresholds = sorted(self.reduce_rules.keys())
            selected_threshold = thresholds[-1]  # Varsayƒ±lan en b√ºy√ºk
            
            for threshold in thresholds:
                if ratio < threshold:
                    selected_threshold = threshold
                    break
            
            maxalw_mult, befday_mult = self.reduce_rules.get(selected_threshold, (0.5, 0.5))
            
            # None = sƒ±nƒ±rsƒ±z (ama ters pozisyona ge√ßi≈ü yasak)
            if maxalw_mult is None and befday_mult is None:
                return abs_befday, f"BefQty={befday_qty:.0f} (Port %{ratio:.1f}), E≈üik=<%{selected_threshold}, Sƒ±nƒ±rsƒ±z (ters poz. yasak)", True
            
            # Limit 1: MAXALW √ó √ßarpan (minimum rule_min_lot)
            limit1 = float('inf')
            if maxalw_mult is not None:
                limit1 = maxalw * maxalw_mult
                if limit1 < self.rule_min_lot:
                    limit1 = self.rule_min_lot
            
            # Limit 2: BefQty √ó √ßarpan
            limit2 = float('inf')
            if befday_mult is not None:
                limit2 = abs_befday * befday_mult
            
            # ƒ∞kisinin minimumu
            final_limit = min(limit1, limit2)
            if final_limit == float('inf'):
                final_limit = abs_befday
            
            final_limit = self.round_lot(final_limit, is_reduce=True, remaining_position=abs_befday)
            
            reason = f"BefQty={befday_qty:.0f} (Port %{ratio:.1f}), E≈üik=<%{selected_threshold}, " \
                    f"Limit1=MAXALW√ó{maxalw_mult}={limit1:.0f}, Limit2=BefQty√ó{befday_mult}={limit2:.0f}, " \
                    f"Final={final_limit}"
            
            return final_limit, reason, False
            
        except Exception as e:
            print(f"[REDUCE LIMIT] ‚ùå Hesaplama hatasƒ±: {e}")
            return self.rule_min_lot, f"Hata: {e}", False
    
    def check_addnewpos_limits(self, symbol, current_qty, befday_qty, order_qty, order_side, maxalw):
        """
        ADDNEWPOS emirleri i√ßin limit kontrol√º
        
        Returns: (allowed, adjusted_qty, reason)
        """
        try:
            # G√ºnl√ºk limit hesapla
            daily_limit, limit_reason = self.get_addnewpos_limit(symbol, maxalw, befday_qty)
            
            # Mevcut g√ºnl√ºk deƒüi≈üim
            current_change = abs(current_qty - befday_qty)
            
            # Kalan hak
            remaining_allowance = daily_limit - current_change
            if remaining_allowance < 0:
                remaining_allowance = 0
            
            # Emir miktarƒ± kalan haktan fazla mƒ±?
            if order_qty > remaining_allowance:
                if remaining_allowance <= 0:
                    return False, 0, f"ADDNEWPOS Limit: G√ºnl√ºk limit doldu ({current_change:.0f}/{daily_limit:.0f})"
                else:
                    adjusted = self.round_lot(remaining_allowance)
                    return True, adjusted, f"ADDNEWPOS Limit: Emir {order_qty} ‚Üí {adjusted} lot'a d√º≈ü√ºr√ºld√º ({limit_reason})"
            
            return True, order_qty, f"ADDNEWPOS Limit OK: {current_change:.0f}+{order_qty} <= {daily_limit:.0f}"
            
        except Exception as e:
            print(f"[ADDNEWPOS CHECK] ‚ùå Hata: {e}")
            return True, order_qty, f"Hata: {e}"
    
    def check_reduce_limits(self, symbol, current_qty, befday_qty, order_qty, order_side, maxalw):
        """
        KARBOTU/REDUCEMORE emirleri i√ßin limit kontrol√º
        
        Returns: (allowed, adjusted_qty, reason)
        """
        try:
            abs_befday = abs(befday_qty)
            
            # G√ºnl√ºk limit hesapla
            daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
            
            # Mevcut g√ºnl√ºk deƒüi≈üim (azaltma y√∂n√ºnde)
            current_change = abs(current_qty - befday_qty)
            
            # Sƒ±nƒ±rsƒ±z ise, sadece ters pozisyona ge√ßmemeye dikkat et
            if is_unlimited:
                # Ters pozisyona ge√ßi≈ü kontrol√º
                if befday_qty > 0 and current_qty - order_qty < 0:
                    # Long ‚Üí Short ge√ßi≈üi engellenecek
                    adjusted = current_qty  # Mevcut pozisyonu 0'a getir
                    return True, adjusted, f"REDUCE: Ters poz. yasak, emir {order_qty} ‚Üí {adjusted} (0'a getir)"
                elif befday_qty < 0 and current_qty + order_qty > 0:
                    # Short ‚Üí Long ge√ßi≈üi engellenecek
                    adjusted = abs(current_qty)
                    return True, adjusted, f"REDUCE: Ters poz. yasak, emir {order_qty} ‚Üí {adjusted} (0'a getir)"
                
                return True, order_qty, f"REDUCE Limit OK (Sƒ±nƒ±rsƒ±z): {limit_reason}"
            
            # Kalan hak
            remaining_allowance = daily_limit - current_change
            if remaining_allowance < 0:
                remaining_allowance = 0
            
            # Emir miktarƒ± kalan haktan fazla mƒ±?
            if order_qty > remaining_allowance:
                if remaining_allowance <= 0:
                    return False, 0, f"REDUCE Limit: G√ºnl√ºk limit doldu ({current_change:.0f}/{daily_limit:.0f})"
                else:
                    adjusted = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                    return True, adjusted, f"REDUCE Limit: Emir {order_qty} ‚Üí {adjusted} lot'a d√º≈ü√ºr√ºld√º ({limit_reason})"
            
            return True, order_qty, f"REDUCE Limit OK: {current_change:.0f}+{order_qty} <= {daily_limit:.0f}"
            
        except Exception as e:
            print(f"[REDUCE CHECK] ‚ùå Hata: {e}")
            return True, order_qty, f"Hata: {e}"
    
    def load_benchmark_shift_from_csv(self):
        """benchmark_shift.csv dosyasƒ±ndan benchmark shift deƒüerini y√ºkle"""
        try:
            import pandas as pd
            import os
            
            csv_file = "benchmark_shift.csv"
            
            if os.path.exists(csv_file):
                df = pd.read_csv(csv_file)
                
                # Shift deƒüerini bul
                if 'shift_value' in df.columns:
                    shift_value = df['shift_value'].iloc[0]
                elif 'benchmark_shift' in df.columns:
                    shift_value = df['benchmark_shift'].iloc[0]
                elif len(df.columns) > 0:
                    shift_value = df.iloc[0, 0]  # ƒ∞lk kolonun ilk deƒüeri
                else:
                    shift_value = 0.0
                
                # Float'a √ßevir
                try:
                    self.benchmark_shift = float(shift_value)
                    print(f"[BM SHIFTER] ‚úÖ Benchmark shift deƒüeri CSV'den y√ºklendi: {self.benchmark_shift:.4f}")
                except (ValueError, TypeError):
                    self.benchmark_shift = 0.0
                    print(f"[BM SHIFTER] ‚ö†Ô∏è CSV'deki deƒüer ge√ßersiz, default 0.0 kullanƒ±lƒ±yor")
            else:
                # CSV yoksa default 0.0
                self.benchmark_shift = 0.0
                print(f"[BM SHIFTER] ‚ÑπÔ∏è CSV dosyasƒ± bulunamadƒ±, default 0.0 kullanƒ±lƒ±yor")
                
        except Exception as e:
            print(f"[BM SHIFTER] ‚ùå CSV y√ºkleme hatasƒ±: {e}")
            self.benchmark_shift = 0.0  # Hata durumunda default
    
    def save_benchmark_shift_to_csv(self, shift_value):
        """Benchmark shift deƒüerini benchmark_shift.csv dosyasƒ±na kaydet"""
        try:
            import pandas as pd
            
            csv_file = "benchmark_shift.csv"
            
            # DataFrame olu≈ütur
            df = pd.DataFrame({'shift_value': [shift_value]})
            df.to_csv(csv_file, index=False)
            
            print(f"[BM SHIFTER] ‚úÖ Benchmark shift deƒüeri CSV'ye kaydedildi: {shift_value:.4f}")
                
        except Exception as e:
            print(f"[BM SHIFTER] ‚ùå CSV kaydetme hatasƒ±: {e}")
            raise
    
    def load_psfalgo_filters_from_csv(self):
        """psfalgofilters.csv dosyasƒ±ndan JFIN filtrelerini y√ºkle"""
        try:
            import pandas as pd
            import os
            
            csv_file = "psfalgofilters.csv"
            
            if os.path.exists(csv_file):
                df = pd.read_csv(csv_file)
                
                # Long filtreleri y√ºkle
                if 'long_sma_value' in df.columns:
                    long_sma_val = str(df['long_sma_value'].iloc[0]) if pd.notna(df['long_sma_value'].iloc[0]) else "-1.6"
                    if hasattr(self, 'long_sma_filter_var'):
                        self.long_sma_filter_var.set(long_sma_val)
                if 'long_sma_type' in df.columns:
                    long_sma_typ = str(df['long_sma_type'].iloc[0]) if pd.notna(df['long_sma_type'].iloc[0]) else "below"
                    if hasattr(self, 'long_sma_filter_type'):
                        self.long_sma_filter_type.set(long_sma_typ)
                
                if 'long_fbtot_value' in df.columns:
                    long_fbtot_val = str(df['long_fbtot_value'].iloc[0]) if pd.notna(df['long_fbtot_value'].iloc[0]) else ""
                    if hasattr(self, 'long_fbtot_filter_var'):
                        self.long_fbtot_filter_var.set(long_fbtot_val)
                if 'long_fbtot_type' in df.columns:
                    long_fbtot_typ = str(df['long_fbtot_type'].iloc[0]) if pd.notna(df['long_fbtot_type'].iloc[0]) else "below"
                    if hasattr(self, 'long_fbtot_filter_type'):
                        self.long_fbtot_filter_type.set(long_fbtot_typ)
                
                if 'long_gort_value' in df.columns:
                    long_gort_val = str(df['long_gort_value'].iloc[0]) if pd.notna(df['long_gort_value'].iloc[0]) else ""
                    if hasattr(self, 'long_gort_filter_var'):
                        self.long_gort_filter_var.set(long_gort_val)
                if 'long_gort_type' in df.columns:
                    long_gort_typ = str(df['long_gort_type'].iloc[0]) if pd.notna(df['long_gort_type'].iloc[0]) else "below"
                    if hasattr(self, 'long_gort_filter_type'):
                        self.long_gort_filter_type.set(long_gort_typ)
                
                # Short filtreleri y√ºkle
                if 'short_sma_value' in df.columns:
                    short_sma_val = str(df['short_sma_value'].iloc[0]) if pd.notna(df['short_sma_value'].iloc[0]) else ""
                    if hasattr(self, 'short_sma_filter_var'):
                        self.short_sma_filter_var.set(short_sma_val)
                if 'short_sma_type' in df.columns:
                    short_sma_typ = str(df['short_sma_type'].iloc[0]) if pd.notna(df['short_sma_type'].iloc[0]) else "below"
                    if hasattr(self, 'short_sma_filter_type'):
                        self.short_sma_filter_type.set(short_sma_typ)
                
                if 'short_sfstot_value' in df.columns:
                    short_sfstot_val = str(df['short_sfstot_value'].iloc[0]) if pd.notna(df['short_sfstot_value'].iloc[0]) else ""
                    if hasattr(self, 'short_sfstot_filter_var'):
                        self.short_sfstot_filter_var.set(short_sfstot_val)
                if 'short_sfstot_type' in df.columns:
                    short_sfstot_typ = str(df['short_sfstot_type'].iloc[0]) if pd.notna(df['short_sfstot_type'].iloc[0]) else "below"
                    if hasattr(self, 'short_sfstot_filter_type'):
                        self.short_sfstot_filter_type.set(short_sfstot_typ)
                
                if 'short_gort_value' in df.columns:
                    short_gort_val = str(df['short_gort_value'].iloc[0]) if pd.notna(df['short_gort_value'].iloc[0]) else ""
                    if hasattr(self, 'short_gort_filter_var'):
                        self.short_gort_filter_var.set(short_gort_val)
                if 'short_gort_type' in df.columns:
                    short_gort_typ = str(df['short_gort_type'].iloc[0]) if pd.notna(df['short_gort_type'].iloc[0]) else "below"
                    if hasattr(self, 'short_gort_filter_type'):
                        self.short_gort_filter_type.set(short_gort_typ)
                
                print(f"[PSFALGO FILTERS] ‚úÖ Filtreler CSV'den y√ºklendi: {csv_file}")
            else:
                print(f"[PSFALGO FILTERS] ‚ÑπÔ∏è CSV dosyasƒ± bulunamadƒ±, varsayƒ±lan deƒüerler kullanƒ±lƒ±yor")
                
        except Exception as e:
            print(f"[PSFALGO FILTERS] ‚ùå CSV y√ºkleme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def save_psfalgo_filters_to_csv(self):
        """JFIN filtrelerini psfalgofilters.csv dosyasƒ±na kaydet"""
        try:
            import pandas as pd
            
            csv_file = "psfalgofilters.csv"
            
            # Mevcut filtre deƒüerlerini al
            long_sma_value = self.long_sma_filter_var.get() if hasattr(self, 'long_sma_filter_var') else "-1.6"
            long_sma_type = self.long_sma_filter_type.get() if hasattr(self, 'long_sma_filter_type') else "below"
            long_fbtot_value = self.long_fbtot_filter_var.get() if hasattr(self, 'long_fbtot_filter_var') else ""
            long_fbtot_type = self.long_fbtot_filter_type.get() if hasattr(self, 'long_fbtot_filter_type') else "below"
            long_gort_value = self.long_gort_filter_var.get() if hasattr(self, 'long_gort_filter_var') else ""
            long_gort_type = self.long_gort_filter_type.get() if hasattr(self, 'long_gort_filter_type') else "below"
            
            short_sma_value = self.short_sma_filter_var.get() if hasattr(self, 'short_sma_filter_var') else ""
            short_sma_type = self.short_sma_filter_type.get() if hasattr(self, 'short_sma_filter_type') else "below"
            short_sfstot_value = self.short_sfstot_filter_var.get() if hasattr(self, 'short_sfstot_filter_var') else ""
            short_sfstot_type = self.short_sfstot_filter_type.get() if hasattr(self, 'short_sfstot_filter_type') else "below"
            short_gort_value = self.short_gort_filter_var.get() if hasattr(self, 'short_gort_filter_var') else ""
            short_gort_type = self.short_gort_filter_type.get() if hasattr(self, 'short_gort_filter_type') else "below"
            
            # DataFrame olu≈ütur
            df = pd.DataFrame({
                'long_sma_value': [long_sma_value],
                'long_sma_type': [long_sma_type],
                'long_fbtot_value': [long_fbtot_value],
                'long_fbtot_type': [long_fbtot_type],
                'long_gort_value': [long_gort_value],
                'long_gort_type': [long_gort_type],
                'short_sma_value': [short_sma_value],
                'short_sma_type': [short_sma_type],
                'short_sfstot_value': [short_sfstot_value],
                'short_sfstot_type': [short_sfstot_type],
                'short_gort_value': [short_gort_value],
                'short_gort_type': [short_gort_type]
            })
            
            df.to_csv(csv_file, index=False)
            print(f"[PSFALGO FILTERS] ‚úÖ Filtreler CSV'ye kaydedildi: {csv_file}")
            
        except Exception as e:
            print(f"[PSFALGO FILTERS] ‚ùå CSV kaydetme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            raise
    
    def show_save_filters_dialog(self):
        """Filtreleri kaydetme dialog penceresi g√∂ster"""
        try:
            dialog = tk.Toplevel(self.psfalgo_window)
            dialog.title("Filtreleri Kaydet")
            dialog.geometry("300x150")
            dialog.transient(self.psfalgo_window)
            dialog.grab_set()  # Modal dialog
            
            # Pencereyi ortala
            dialog.update_idletasks()
            x = (dialog.winfo_screenwidth() // 2) - (300 // 2)
            y = (dialog.winfo_screenheight() // 2) - (150 // 2)
            dialog.geometry(f"300x150+{x}+{y}")
            
            # Mesaj
            msg_label = ttk.Label(dialog, text="Filtreleri kaydetmek istiyor musunuz?", 
                                 font=("Arial", 10))
            msg_label.pack(pady=20)
            
            # Butonlar
            button_frame = ttk.Frame(dialog)
            button_frame.pack(pady=10)
            
            def save_and_close():
                try:
                    self.save_psfalgo_filters_to_csv()
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", "Filtreler ba≈üarƒ±yla kaydedildi!", parent=dialog)
                    dialog.destroy()
                except Exception as e:
                    messagebox.showerror("Hata", f"Kaydetme hatasƒ±: {e}", parent=dialog)
            
            save_btn = ttk.Button(button_frame, text="üíæ Kaydet ve Kapat", 
                                  command=save_and_close, width=15)
            save_btn.pack(side='left', padx=5)
            
            cancel_btn = ttk.Button(button_frame, text="‚ùå ƒ∞ptal", 
                                    command=dialog.destroy, width=15)
            cancel_btn.pack(side='left', padx=5)
            
        except Exception as e:
            print(f"[PSFALGO FILTERS] ‚ùå Dialog hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            
            print(f"[BM SHIFTER] ‚úÖ Benchmark shift deƒüeri CSV'ye kaydedildi: {shift_value:.4f}")
                
        except Exception as e:
            print(f"[BM SHIFTER] ‚ùå CSV kaydetme hatasƒ±: {e}")
            raise
    
    def show_excluder_dialog(self):
        """Excluder dialog'unu g√∂ster - Ticker'larƒ± exclude etmek i√ßin"""
        try:
            from tkinter import messagebox
            
            # CSV'den y√ºkle
            self.load_excluded_tickers_from_csv()
            
            # Dialog penceresi olu≈ütur
            dialog = tk.Toplevel(self.psfalgo_window)
            dialog.title("üö´ Excluder - Ticker Exclude Listesi")
            dialog.geometry("600x500")
            dialog.transient(self.psfalgo_window)
            dialog.grab_set()
            
            # Ana frame
            main_frame = ttk.Frame(dialog)
            main_frame.pack(fill='both', expand=True, padx=10, pady=10)
            
            # A√ßƒ±klama
            info_label = ttk.Label(main_frame, 
                                  text="Exclude edilecek ticker'larƒ± y√∂netin",
                                  font=("Arial", 10, "bold"))
            info_label.pack(pady=5)
            
            # Liste kutusu ve scrollbar
            list_frame = ttk.Frame(main_frame)
            list_frame.pack(fill='both', expand=True, pady=10)
            
            scrollbar = ttk.Scrollbar(list_frame)
            scrollbar.pack(side='right', fill='y')
            
            listbox = tk.Listbox(list_frame, height=12, yscrollcommand=scrollbar.set, selectmode=tk.EXTENDED)
            listbox.pack(side='left', fill='both', expand=True)
            scrollbar.config(command=listbox.yview)
            
            # Mevcut ticker'larƒ± listbox'a y√ºkle
            if hasattr(self, 'excluded_tickers') and self.excluded_tickers:
                for ticker in sorted(self.excluded_tickers):
                    listbox.insert(tk.END, ticker)
            
            # Ekleme alanƒ±
            add_frame = ttk.Frame(main_frame)
            add_frame.pack(fill='x', pady=5)
            
            ttk.Label(add_frame, text="Yeni Ticker Ekle (virg√ºlle ayƒ±rƒ±n):", font=("Arial", 9)).pack(anchor='w')
            
            entry_frame = ttk.Frame(add_frame)
            entry_frame.pack(fill='x', pady=5)
            
            entry_widget = ttk.Entry(entry_frame, width=50)
            entry_widget.pack(side='left', fill='x', expand=True, padx=(0, 5))
            
            def add_tickers():
                """Yeni ticker'lar ekle"""
                try:
                    text_content = entry_widget.get().strip()
                    if not text_content:
                        return
                    
                    # Virg√ºlle ayƒ±r ve temizle
                    new_tickers = [t.strip().upper() for t in text_content.split(',') if t.strip()]
                    
                    if not hasattr(self, 'excluded_tickers'):
                        self.excluded_tickers = set()
                    
                    added_count = 0
                    for ticker in new_tickers:
                        if ticker and ticker not in self.excluded_tickers:
                            self.excluded_tickers.add(ticker)
                            listbox.insert(tk.END, ticker)
                            added_count += 1
                    
                    if added_count > 0:
                        # Listbox'ƒ± sƒ±rala
                        items = list(listbox.get(0, tk.END))
                        listbox.delete(0, tk.END)
                        for item in sorted(items):
                            listbox.insert(tk.END, item)
                        
                        entry_widget.delete(0, tk.END)
                        self.log_message(f"‚úÖ {added_count} ticker eklendi")
                    else:
                        messagebox.showinfo("Bilgi", "Ticker'lar zaten listede veya ge√ßersiz")
                        
                except Exception as e:
                    messagebox.showerror("Hata", f"Ticker eklenemedi: {e}")
            
            add_btn = ttk.Button(entry_frame, text="‚ûï Ekle", command=add_tickers)
            add_btn.pack(side='left')
            
            # Butonlar
            button_frame = ttk.Frame(main_frame)
            button_frame.pack(fill='x', pady=10)
            
            def delete_selected():
                """Se√ßili ticker'larƒ± sil"""
                try:
                    selected_indices = listbox.curselection()
                    if not selected_indices:
                        messagebox.showinfo("Bilgi", "L√ºtfen silmek i√ßin ticker se√ßin")
                        return
                    
                    # Se√ßili ticker'larƒ± al
                    selected_tickers = [listbox.get(i) for i in selected_indices]
                    
                    # Set'ten sil
                    for ticker in selected_tickers:
                        if ticker in self.excluded_tickers:
                            self.excluded_tickers.remove(ticker)
                    
                    # Listbox'tan sil (ters sƒ±rada sil ki index kaymasƒ±n)
                    for i in reversed(selected_indices):
                        listbox.delete(i)
                    
                    self.log_message(f"‚úÖ {len(selected_tickers)} ticker silindi")
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(selected_tickers)} ticker silindi")
                    
                except Exception as e:
                    messagebox.showerror("Hata", f"Ticker silinemedi: {e}")
            
            def select_all():
                """T√ºm ticker'larƒ± se√ß"""
                listbox.selection_set(0, tk.END)
            
            def clear_all():
                """T√ºm ticker'larƒ± sil"""
                if not hasattr(self, 'excluded_tickers') or not self.excluded_tickers:
                    messagebox.showinfo("Bilgi", "Liste zaten bo≈ü")
                    return
                
                if messagebox.askyesno("Onay", "T√ºm ticker'larƒ± silmek istediƒüinize emin misiniz?"):
                    self.excluded_tickers = set()
                    listbox.delete(0, tk.END)
                    self.log_message("‚úÖ T√ºm ticker'lar silindi")
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", "T√ºm ticker'lar silindi")
            
            def save_and_close():
                """Kaydet ve kapat"""
                try:
                    self.save_excluded_tickers_to_csv()
                    self.log_message(f"‚úÖ {len(self.excluded_tickers)} ticker CSV'ye kaydedildi")
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(self.excluded_tickers)} ticker kaydedildi")
                    dialog.destroy()
                except Exception as e:
                    messagebox.showerror("Hata", f"Kaydetme hatasƒ±: {e}")
            
            def cancel_dialog():
                """Dialog'u iptal et"""
                dialog.destroy()
            
            # Butonlarƒ± olu≈ütur
            ttk.Button(button_frame, text="‚úÖ Kaydet ve Kapat", command=save_and_close).pack(side='left', padx=5)
            ttk.Button(button_frame, text="‚ùå ƒ∞ptal", command=cancel_dialog).pack(side='left', padx=5)
            ttk.Button(button_frame, text="üóëÔ∏è Se√ßileni Sil", command=delete_selected).pack(side='left', padx=5)
            ttk.Button(button_frame, text="üìã T√ºm√ºn√º Se√ß", command=select_all).pack(side='left', padx=5)
            ttk.Button(button_frame, text="üóëÔ∏è T√ºm√ºn√º Sil", command=clear_all).pack(side='left', padx=5)
            
        except Exception as e:
            messagebox.showerror("Hata", f"Dialog olu≈üturulamadƒ±: {e}")
            self.log_message(f"‚ùå Excluder dialog hatasƒ±: {e}")
    
    def show_bm_shifter_dialog(self):
        """General BM Shifter dialog'unu g√∂ster - Benchmark shift deƒüeri girmek i√ßin"""
        try:
            from tkinter import messagebox
            
            # Dialog penceresi olu≈ütur
            dialog = tk.Toplevel(self.psfalgo_window)
            dialog.title("üìä General BM Shifter")
            dialog.geometry("450x280")
            dialog.transient(self.psfalgo_window)
            dialog.grab_set()
            
            # Ana frame
            main_frame = ttk.Frame(dialog)
            main_frame.pack(fill='both', expand=True, padx=20, pady=20)
            
            # A√ßƒ±klama
            info_label = ttk.Label(main_frame, 
                                  text="Benchmark shift deƒüerini girin\n(Negatif deƒüer benchmark'ƒ± d√º≈ü√ºr√ºr, pozitif deƒüer y√ºkseltir)",
                                  font=("Arial", 10),
                                  justify='center')
            info_label.pack(pady=10)
            
            # Mevcut deƒüeri g√∂ster
            current_shift = getattr(self, 'benchmark_shift', 0.0)
            current_label = ttk.Label(main_frame, 
                                     text=f"Mevcut Shift: {current_shift:.4f}",
                                     font=("Arial", 9),
                                     foreground='blue')
            current_label.pack(pady=5)
            
            # Giri≈ü alanƒ±
            input_frame = ttk.Frame(main_frame)
            input_frame.pack(pady=10)
            
            ttk.Label(input_frame, text="Shift Deƒüeri:", font=("Arial", 9)).pack(side='left', padx=5)
            
            shift_var = tk.StringVar(value=str(current_shift))
            shift_entry = ttk.Entry(input_frame, textvariable=shift_var, width=15)
            shift_entry.pack(side='left', padx=5)
            shift_entry.select_range(0, tk.END)  # T√ºm metni se√ß
            shift_entry.focus()  # Odaklan
            
            # Butonlar
            button_frame = ttk.Frame(main_frame)
            button_frame.pack(pady=15)
            
            def apply_shift():
                """Shift deƒüerini uygula"""
                try:
                    shift_value = float(shift_var.get().strip())
                    
                    # Shift deƒüerini kaydet
                    self.benchmark_shift = shift_value
                    
                    # CSV'ye kaydet
                    self.save_benchmark_shift_to_csv(shift_value)
                    
                    # Label'ƒ± g√ºncelle
                    if hasattr(self, 'bm_shift_label'):
                        self.bm_shift_label.config(text=f"BM Shift: {shift_value:.4f}")
                    
                    # Log mesajƒ±
                    self.log_message(f"üìä Benchmark shift deƒüeri g√ºncellendi: {shift_value:.4f}")
                    print(f"[BM SHIFTER] ‚úÖ Benchmark shift deƒüeri g√ºncellendi: {shift_value:.4f}")
                    
                    # Bilgi mesajƒ±
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", 
                                      f"Benchmark shift deƒüeri g√ºncellendi: {shift_value:.4f}\n\n"
                                      f"T√ºm benchmark hesaplamalarƒ± bu deƒüerle shift edilecek.")
                    
                    dialog.destroy()
                    
                    # T√ºm skorlarƒ± yeniden hesapla (shift deƒüeri deƒüi≈ütiƒüi i√ßin)
                    self.calculate_scores_for_all_stocks()
                    
                except ValueError:
                    messagebox.showerror("Hata", "L√ºtfen ge√ßerli bir sayƒ± girin (√∂rn: -0.10 veya 0.05)")
                except Exception as e:
                    messagebox.showerror("Hata", f"Shift deƒüeri uygulanamadƒ±: {e}")
                    print(f"[BM SHIFTER] ‚ùå Hata: {e}")
                    import traceback
                    traceback.print_exc()
            
            def reset_shift():
                """Shift deƒüerini sƒ±fƒ±rla"""
                try:
                    self.benchmark_shift = 0.0
                    
                    # CSV'ye kaydet
                    self.save_benchmark_shift_to_csv(0.0)
                    
                    # Label'ƒ± g√ºncelle
                    if hasattr(self, 'bm_shift_label'):
                        self.bm_shift_label.config(text="BM Shift: 0.00")
                    
                    # Entry'yi g√ºncelle
                    shift_var.set("0.0")
                    
                    # Log mesajƒ±
                    self.log_message("üìä Benchmark shift deƒüeri sƒ±fƒ±rlandƒ±")
                    print("[BM SHIFTER] ‚úÖ Benchmark shift deƒüeri sƒ±fƒ±rlandƒ±")
                    
                    # Bilgi mesajƒ±
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", "Benchmark shift deƒüeri sƒ±fƒ±rlandƒ±.\nBenchmark deƒüerleri orijinal haline d√∂nd√º.")
                    
                    dialog.destroy()
                    
                    # T√ºm skorlarƒ± yeniden hesapla
                    self.calculate_scores_for_all_stocks()
                    
                except Exception as e:
                    messagebox.showerror("Hata", f"Shift deƒüeri sƒ±fƒ±rlanamadƒ±: {e}")
                    print(f"[BM SHIFTER] ‚ùå Hata: {e}")
            
            def cancel_dialog():
                """Dialog'u iptal et"""
                dialog.destroy()
            
            # Enter tu≈üu ile uygula
            shift_entry.bind('<Return>', lambda e: apply_shift())
            
            ttk.Button(button_frame, text="Uygula", command=apply_shift, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="Sƒ±fƒ±rla", command=reset_shift).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal", command=cancel_dialog).pack(side='left', padx=5)
            
        except Exception as e:
            messagebox.showerror("Hata", f"Dialog a√ßƒ±lamadƒ±: {e}")
            print(f"[BM SHIFTER] ‚ùå Dialog hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def is_ticker_excluded(self, symbol):
        """Ticker exclude edilmi≈ü mi kontrol et"""
        if not hasattr(self, 'excluded_tickers'):
            return False
        return symbol.upper() in self.excluded_tickers
    
    def start_addnewpos_automation(self, from_runall=False):
        """
        ADDNEWPOS otomasyonu: Port Adjuster ‚Üí CSV Y√ºkle ‚Üí Final FB&SFS ‚Üí Grup Aƒüƒ±rlƒ±klarƒ± ‚Üí TUMCSV ‚Üí BB Long Filtre ‚Üí JFIN %50 BB ‚Üí Exclude Kontrol ‚Üí Emir G√∂nder
        
        Args:
            from_runall: True ise RUNALL'dan √ßaƒürƒ±ldƒ± (exposure kontrol√º yapƒ±lacak), False ise manuel √ßaƒürƒ±ldƒ± (direkt ba≈ülatƒ±lacak)
        """
        try:
            print("[ADDNEWPOS] ‚ñ∂Ô∏è ADDNEWPOS otomasyonu ba≈ülatƒ±lƒ±yor...")
            self.log_message("‚ñ∂Ô∏è ADDNEWPOS otomasyonu ba≈ülatƒ±lƒ±yor...")
            
            # RUNALL'dan √ßaƒürƒ±lmadƒ±ysa (manuel √ßaƒürƒ±ldƒ±ysa) exposure kontrol√º yapma, direkt ba≈ülat
            if not from_runall:
                print("[ADDNEWPOS] ‚ÑπÔ∏è Manuel olarak ba≈ülatƒ±ldƒ±, exposure kontrol√º yapƒ±lmƒ±yor")
                self.log_message("‚ÑπÔ∏è Manuel olarak ba≈ülatƒ±ldƒ±, exposure kontrol√º yapƒ±lmƒ±yor")
            
            # Excluded ticker'larƒ± y√ºkle
            self.load_excluded_tickers_from_csv()
            
            # Adƒ±m 1: Port Adjuster penceresini a√ß (non-blocking)
            self.log_message("üìã Adƒ±m 1: Port Adjuster penceresi a√ßƒ±lƒ±yor...")
            
            # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
            self.update_idletasks()
            
            # Port Adjuster penceresini a√ß
            port_adjuster_window = self.show_port_adjuster()
            
            # Port Adjuster referansƒ±nƒ± sakla
            self.addnewpos_port_adjuster = port_adjuster_window
            
            # GUI'yi tekrar g√ºncelle (pencere a√ßƒ±ldƒ±ktan sonra)
            self.update_idletasks()
            
            # Port Adjuster penceresinin a√ßƒ±lmasƒ±nƒ± bekle (non-blocking)
            self.after(1000, lambda: self.addnewpos_step_2_csv_yukle(port_adjuster_window))
            
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Otomasyon ba≈ülatma hatasƒ±: {e}")
            self.log_message(f"‚ùå ADDNEWPOS ba≈ülatma hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            from tkinter import messagebox
            messagebox.showerror("Hata", f"ADDNEWPOS ba≈ülatƒ±lamadƒ±: {e}")
            
            # RUNALL'dan √ßaƒürƒ±ldƒ±ysa ve hata olduysa bile 2 dakika sonra restart yap
            if from_runall:
                runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                should_continue = runall_running or runall_allowed
                
                if should_continue:
                    print("[RUNALL] ‚ö†Ô∏è ADDNEWPOS ba≈ülatƒ±lamadƒ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                    self.log_message("‚ö†Ô∏è ADDNEWPOS ba≈ülatƒ±lamadƒ±, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                    # 2 dakika bekle, sonra emirleri iptal et
                    self.after(120000, lambda: self.runall_cancel_orders_and_restart())
    
    def addnewpos_step_2_csv_yukle(self, port_adjuster_window):
        """Adƒ±m 2: CSV'den Y√ºkle butonuna tƒ±kla"""
        try:
            self.log_message("üìã Adƒ±m 2: CSV'den Y√ºkle butonuna tƒ±klanƒ±yor...")
            
            # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
            self.update_idletasks()
            
            # Port Adjuster window kontrol√º
            if port_adjuster_window is None:
                print("[ADDNEWPOS] ‚ùå Port Adjuster window None")
                self.log_message("‚ùå Adƒ±m 2: Port Adjuster penceresi bulunamadƒ±")
                return
            
            # Port Adjuster penceresindeki CSV'den Y√ºkle butonunu bul ve tƒ±kla (non-blocking)
            if hasattr(port_adjuster_window, 'load_settings_from_csv'):
                # CSV y√ºkleme i≈ülemini thread'de yap (bloklayƒ±cƒ± olabilir)
                def load_csv_thread():
                    try:
                        port_adjuster_window.load_settings_from_csv()
                        # UI thread'ine ge√ßi≈ü yap
                        self.after(0, lambda: self._addnewpos_csv_loaded(port_adjuster_window))
                    except Exception as e:
                        print(f"[ADDNEWPOS] ‚ùå CSV y√ºkleme hatasƒ±: {e}")
                        self.after(0, lambda: self.log_message(f"‚ùå CSV y√ºkleme hatasƒ±: {e}"))
                
                import threading
                thread = threading.Thread(target=load_csv_thread, daemon=True)
                thread.start()
            else:
                print(f"[ADDNEWPOS] ‚ùå Port Adjuster'da load_settings_from_csv bulunamadƒ±")
                self.log_message("‚ùå Adƒ±m 2: CSV'den Y√ºkle butonu bulunamadƒ±")
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Adƒ±m 2 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 2 hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def _addnewpos_csv_loaded(self, port_adjuster_window):
        """CSV y√ºklendikten sonra √ßaƒürƒ±lƒ±r"""
        try:
            print("[ADDNEWPOS] ‚úÖ CSV'den Y√ºkle tamamlandƒ±")
            self.log_message("‚úÖ Adƒ±m 2: CSV'den Y√ºkle tamamlandƒ±")
            
            # GUI'yi g√ºncelle
            self.update_idletasks()
            
            # Messagebox'ƒ± otomatik kapat (eƒüer a√ßƒ±ldƒ±ysa) ve sonraki adƒ±ma ge√ß
            self.after(500, lambda: self.addnewpos_close_messagebox())
            
            # Popup'larƒ± kapat ve pencere kapanmasƒ±nƒ± bekle
            def proceed_to_step_3():
                # GUI'yi g√ºncelle
                self.update_idletasks()
                # Popup'larƒ± tekrar kontrol et
                self.addnewpos_close_messagebox()
                # Sonraki adƒ±ma ge√ß (non-blocking)
                self.after(100, lambda: self.addnewpos_step_3_final_fb_sfs(port_adjuster_window))
            
            # Kƒ±sa bir bekleme sonrasƒ± devam et
            self.after(1500, proceed_to_step_3)
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå CSV y√ºkleme sonrasƒ± hatasƒ±: {e}")
            self.log_message(f"‚ùå CSV y√ºkleme sonrasƒ± hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def wait_for_window_close(self, window, callback, max_wait=5000, check_interval=200):
        """
        Pencere kapanana kadar bekle, sonra callback'i √ßaƒüƒ±r
        
        Args:
            window: Kontrol edilecek pencere (Toplevel veya widget)
            callback: Pencere kapandƒ±ktan sonra √ßaƒürƒ±lacak fonksiyon
            max_wait: Maksimum bekleme s√ºresi (ms)
            check_interval: Kontrol aralƒ±ƒüƒ± (ms)
        """
        if window is None:
            # Pencere yoksa direkt callback'i √ßaƒüƒ±r
            callback()
            return
        
        start_time = time.time() * 1000  # ms cinsinden
        
        def check_window():
            current_time = time.time() * 1000
            elapsed = current_time - start_time
            
            # Maksimum bekleme s√ºresi a≈üƒ±ldƒ±ysa devam et
            if elapsed >= max_wait:
                print(f"[WAIT] ‚è±Ô∏è Maksimum bekleme s√ºresi a≈üƒ±ldƒ± ({max_wait}ms), devam ediliyor...")
                callback()
                return
            
            # Pencere hala a√ßƒ±k mƒ± kontrol et
            try:
                if hasattr(window, 'winfo_exists'):
                    if not window.winfo_exists():
                        print(f"[WAIT] ‚úÖ Pencere kapatƒ±ldƒ±, devam ediliyor...")
                        callback()
                        return
                elif hasattr(window, 'win'):
                    if not window.win.winfo_exists():
                        print(f"[WAIT] ‚úÖ Pencere kapatƒ±ldƒ±, devam ediliyor...")
                        callback()
                        return
            except:
                # Pencere zaten kapanmƒ±≈ü olabilir
                print(f"[WAIT] ‚úÖ Pencere kapatƒ±ldƒ± (exception), devam ediliyor...")
                callback()
                return
            
            # Popup'larƒ± kontrol et ve kapat
            self.runall_auto_confirm_messagebox()
            
            # Tekrar kontrol et
            self.after(check_interval, check_window)
        
        # ƒ∞lk kontrol√º ba≈ülat
        self.after(check_interval, check_window)
    
    def addnewpos_close_messagebox(self):
        """A√ßƒ±k messagebox'larƒ± otomatik kapat - Daha agresif versiyon"""
        try:
            # √ñnce runall_auto_confirm_messagebox'ƒ± √ßaƒüƒ±r (daha g√º√ßl√º)
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                self.runall_auto_confirm_messagebox()
            
            # T√ºm a√ßƒ±k Toplevel pencerelerini kontrol et (recursive)
            def find_and_close_all_messageboxes(parent):
                try:
                    for widget in parent.winfo_children():
                        if isinstance(widget, tk.Toplevel):
                            try:
                                title = widget.title().lower()
                                # Messagebox pencerelerini tespit et (daha geni≈ü keyword listesi)
                                if any(keyword in title for keyword in [
                                    'ba≈üarƒ±lƒ±', 'success', 'tamamlandƒ±', 'completed', 'tamam', 'ok', 
                                    'uyarƒ±', 'warning', 'hata', 'error', 'info', 'information',
                                    'bilgi', 'mesaj', 'message', 'onay', 'confirm', 'lot hesaplama',
                                    'cercop', 'otomatik se√ßim', 'emir sonucu', 'emir √∂zeti'
                                ]) or title == '':
                                    # "OK" veya "Tamam" butonunu bul ve tƒ±kla (daha agresif)
                                    def find_ok_button(parent_widget, depth=0):
                                        if depth > 15:
                                            return False
                                        try:
                                            for child in parent_widget.winfo_children():
                                                if isinstance(child, (tk.Button, ttk.Button)):
                                                    try:
                                                        text = str(child.cget('text')).lower().strip()
                                                        if any(keyword in text for keyword in [
                                                            'ok', 'tamam', 'okay', 'kabul', 'accept', 
                                                            'onayla', 'confirm', 'evet', 'yes'
                                                        ]):
                                                            # ƒ∞ptal butonlarƒ±nƒ± atla
                                                            if any(cancel in text for cancel in ['iptal', 'cancel', 'reddet', 'no', 'hayƒ±r']):
                                                                continue
                                                            child.invoke()
                                                            print(f"[ADDNEWPOS] ‚úÖ Messagebox kapatƒ±ldƒ±: '{text}' ({widget.title()})")
                                                            # Kƒ±sa bir bekleme ekle
                                                            self.after(100, lambda: None)
                                                            return True
                                                    except:
                                                        pass
                                                # Recursive olarak devam et
                                                if find_ok_button(child, depth + 1):
                                                    return True
                                        except:
                                            pass
                                        return False
                                    
                                    if find_ok_button(widget):
                                        # Pencereyi de kapat (eƒüer hala a√ßƒ±ksa)
                                        try:
                                            if widget.winfo_exists():
                                                widget.destroy()
                                        except:
                                            pass
                            except:
                                pass
                        # Recursive olarak devam et
                        find_and_close_all_messageboxes(widget)
                except:
                    pass
            
            # Ana pencereden ba≈üla
            find_and_close_all_messageboxes(self)
            
            # Port Adjuster ve FinalThgLotDistributor pencerelerini de kontrol et
            if hasattr(self, 'addnewpos_port_adjuster') and self.addnewpos_port_adjuster:
                if hasattr(self.addnewpos_port_adjuster, 'win'):
                    find_and_close_all_messageboxes(self.addnewpos_port_adjuster.win)
            
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                if hasattr(self.addnewpos_final_thg, 'win'):
                    find_and_close_all_messageboxes(self.addnewpos_final_thg.win)
            
            # Psfalgo penceresini de kontrol et
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    find_and_close_all_messageboxes(self.psfalgo_window)
                except:
                    pass
                    
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ö†Ô∏è Messagebox kapatma hatasƒ±: {e}")
    
    def addnewpos_step_3_final_fb_sfs(self, port_adjuster_window):
        """Adƒ±m 3: 3. Step - Final FB & SFS butonuna tƒ±kla"""
        try:
            self.log_message("üìã Adƒ±m 3: Final FB & SFS penceresi a√ßƒ±lƒ±yor...")
            
            # Port Adjuster penceresinin hala a√ßƒ±k olduƒüunu kontrol et
            if not port_adjuster_window or not hasattr(port_adjuster_window, 'win'):
                print("[ADDNEWPOS] ‚ùå Port Adjuster penceresi ge√ßersiz")
                self.log_message("‚ùå Adƒ±m 3: Port Adjuster penceresi ge√ßersiz")
                return
            
            try:
                port_adjuster_window.win.winfo_exists()
            except tk.TclError:
                print("[ADDNEWPOS] ‚ùå Port Adjuster penceresi kapatƒ±lmƒ±≈ü")
                self.log_message("‚ùå Adƒ±m 3: Port Adjuster penceresi kapatƒ±lmƒ±≈ü")
                return
            
            # Port Adjuster'daki Final FB & SFS butonuna tƒ±kla
            if hasattr(port_adjuster_window, 'show_final_thg_distributor'):
                try:
                    final_thg_distributor = port_adjuster_window.show_final_thg_distributor()
                    print("[ADDNEWPOS] ‚úÖ Final FB & SFS penceresi a√ßƒ±ldƒ±")
                    self.log_message("‚úÖ Adƒ±m 3: Final FB & SFS penceresi a√ßƒ±ldƒ±")
                    
                    # FinalThgLotDistributor referansƒ±nƒ± sakla
                    if final_thg_distributor:
                        self.addnewpos_final_thg = final_thg_distributor
                        # Final THG penceresinin ba≈üarƒ±yla a√ßƒ±ldƒ±ƒüƒ±nƒ± kontrol et
                        if hasattr(final_thg_distributor, 'win'):
                            try:
                                final_thg_distributor.win.winfo_exists()
                                print("[ADDNEWPOS] ‚úÖ Final THG penceresi doƒürulandƒ±")
                            except tk.TclError:
                                print("[ADDNEWPOS] ‚ö†Ô∏è Final THG penceresi ge√ßersiz")
                                return
                    elif hasattr(port_adjuster_window, 'final_thg_distributor'):
                        self.addnewpos_final_thg = port_adjuster_window.final_thg_distributor
                    else:
                        print("[ADDNEWPOS] ‚ö†Ô∏è FinalThgLotDistributor referansƒ± alƒ±namadƒ±")
                        self.addnewpos_port_adjuster = port_adjuster_window
                    
                    # Popup'larƒ± kapat ve sonraki adƒ±ma ge√ß
                    def proceed_to_step_4():
                        # Popup'larƒ± kontrol et ve kapat
                        self.addnewpos_close_messagebox()
                        
                        # Port Adjuster penceresini minimize et (kapatma, √ß√ºnk√º Final THG'nin parent'ƒ±)
                        # Final THG penceresi Port Adjuster'ƒ±n child'ƒ± olduƒüu i√ßin kapatmƒ±yoruz
                        if port_adjuster_window and hasattr(port_adjuster_window, 'win'):
                            try:
                                if port_adjuster_window.win.winfo_exists():
                                    print("[ADDNEWPOS] üì¶ Port Adjuster penceresi minimize ediliyor (Final THG a√ßƒ±k)...")
                                    self.log_message("üì¶ Port Adjuster penceresi minimize ediliyor...")
                                    port_adjuster_window.win.iconify()  # Minimize et, kapatma
                            except:
                                pass
                        
                        # Sonraki adƒ±ma ge√ß
                        self.addnewpos_step_4_grup_agirliklari()
                    
                    self.after(1000, proceed_to_step_4)
                except tk.TclError as e:
                    print(f"[ADDNEWPOS] ‚ùå Final THG penceresi a√ßƒ±lƒ±rken hata: {e}")
                    self.log_message(f"‚ùå Adƒ±m 3: Final THG penceresi a√ßƒ±lamadƒ±: {e}")
                    # Hata mesajƒ±nƒ± Allowed modunda otomatik kapat
                    if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                        self.after(500, lambda: self.addnewpos_close_messagebox())
            else:
                print("[ADDNEWPOS] ‚ùå Port Adjuster'da show_final_thg_distributor bulunamadƒ±")
                self.log_message("‚ùå Adƒ±m 3: Final FB & SFS butonu bulunamadƒ±")
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Adƒ±m 3 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 3 hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_step_4_grup_agirliklari(self):
        """Adƒ±m 4: Grup Aƒüƒ±rlƒ±klarƒ±nƒ± Y√ºkle butonuna tƒ±kla"""
        try:
            self.log_message("üìã Adƒ±m 4: Grup Aƒüƒ±rlƒ±klarƒ±nƒ± Y√ºkle...")
            
            # FinalThgLotDistributor referansƒ±nƒ± al
            final_thg = None
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                final_thg = self.addnewpos_final_thg
            elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                self.addnewpos_final_thg = final_thg
            
            if final_thg and hasattr(final_thg, 'load_group_weights'):
                final_thg.load_group_weights()
                print("[ADDNEWPOS] ‚úÖ Grup Aƒüƒ±rlƒ±klarƒ±nƒ± Y√ºkle tamamlandƒ±")
                self.log_message("‚úÖ Adƒ±m 4: Grup Aƒüƒ±rlƒ±klarƒ±nƒ± Y√ºkle tamamlandƒ±")
                
                # Messagebox'ƒ± otomatik kapat ve popup'larƒ± kontrol et
                def proceed_to_step_5():
                    # Popup'larƒ± tekrar kontrol et ve kapat
                    self.addnewpos_close_messagebox()
                    # Sonraki adƒ±ma ge√ß
                    self.addnewpos_step_5_tumcsv()
                
                self.after(500, lambda: self.addnewpos_close_messagebox())
                self.after(1500, proceed_to_step_5)
            else:
                print("[ADDNEWPOS] ‚ùå FinalThgLotDistributor veya load_group_weights bulunamadƒ±")
                self.log_message("‚ùå Adƒ±m 4: Grup Aƒüƒ±rlƒ±klarƒ±nƒ± Y√ºkle butonu bulunamadƒ±")
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Adƒ±m 4 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 4 hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_step_5_tumcsv(self):
        """Adƒ±m 5: TUMCSV Ayarlamasƒ± Yap butonuna tƒ±kla"""
        try:
            self.log_message("üìã Adƒ±m 5: TUMCSV Ayarlamasƒ± Yap...")
            
            # FinalThgLotDistributor referansƒ±nƒ± al
            final_thg = None
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                final_thg = self.addnewpos_final_thg
            elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                self.addnewpos_final_thg = final_thg
            
            if final_thg and hasattr(final_thg, 'apply_tumcsv_rules'):
                final_thg.apply_tumcsv_rules()
                print("[ADDNEWPOS] ‚úÖ TUMCSV Ayarlamasƒ± tamamlandƒ±")
                self.log_message("‚úÖ Adƒ±m 5: TUMCSV Ayarlamasƒ± tamamlandƒ±")
                
                # Messagebox'ƒ± otomatik kapat (TUMCSV i≈ülemi uzun s√ºrebilir)
                def proceed_to_step_6():
                    # Popup'larƒ± tekrar kontrol et ve kapat
                    self.addnewpos_close_messagebox()
                    # Sonraki adƒ±ma ge√ß
                    self.addnewpos_step_6_bb_filter()
                
                self.after(2000, lambda: self.addnewpos_close_messagebox())
                self.after(3500, proceed_to_step_6)
            else:
                print("[ADDNEWPOS] ‚ùå FinalThgLotDistributor veya apply_tumcsv_rules bulunamadƒ±")
                self.log_message("‚ùå Adƒ±m 5: TUMCSV Ayarlamasƒ± butonu bulunamadƒ±")
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Adƒ±m 5 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 5 hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_step_6_bb_filter(self):
        """Adƒ±m 6: BBlong sekmesinde SMA63CHG filtresini -1.6'dan k√º√ß√ºk olacak ≈üekilde ayarla ve Uygula"""
        try:
            self.log_message("üìã Adƒ±m 6: BB Long sekmesinde SMA63CHG filtresi uygulanƒ±yor...")
            
            # FinalThgLotDistributor referansƒ±nƒ± al
            final_thg = None
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                final_thg = self.addnewpos_final_thg
            elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                self.addnewpos_final_thg = final_thg
            
            if final_thg:
                # Pencere referansƒ±nƒ±n ge√ßerli olup olmadƒ±ƒüƒ±nƒ± kontrol et
                win_valid = False
                if hasattr(final_thg, 'win'):
                    try:
                        # Pencere hala var mƒ± kontrol et
                        if final_thg.win.winfo_exists():
                            win_valid = True
                    except:
                        win_valid = False
                
                if not win_valid:
                    print("[ADDNEWPOS] ‚ö†Ô∏è Final FB & SFS penceresi ge√ßersiz, yeniden a√ßƒ±lƒ±yor...")
                    self.log_message("‚ö†Ô∏è Final FB & SFS penceresi ge√ßersiz, yeniden a√ßƒ±lƒ±yor...")
                    # Port Adjuster'dan yeniden a√ß
                    if hasattr(self, 'addnewpos_port_adjuster') and self.addnewpos_port_adjuster:
                        if hasattr(self.addnewpos_port_adjuster, 'show_final_thg_distributor'):
                            final_thg = self.addnewpos_port_adjuster.show_final_thg_distributor()
                            self.addnewpos_final_thg = final_thg
                            # Pencere a√ßƒ±lmasƒ±nƒ± bekle
                            self.after(2000, lambda: self.addnewpos_step_6_bb_filter())
                            return
                    else:
                        print("[ADDNEWPOS] ‚ùå Port Adjuster referansƒ± bulunamadƒ±")
                        self.log_message("‚ùå Adƒ±m 6: Port Adjuster referansƒ± bulunamadƒ±")
                        return
                
                # BB Long sekmesine ge√ß (notebook'u kontrol et)
                notebook_found = False
                if hasattr(final_thg, 'win') and final_thg.win.winfo_exists():
                    try:
                        # Notebook'u bul ve BB Long sekmesine ge√ß
                        for widget in final_thg.win.winfo_children():
                            if isinstance(widget, ttk.Notebook):
                                # BB Long sekmesine ge√ß (index 0)
                                widget.select(0)
                                print("[ADDNEWPOS] ‚úÖ BB Long sekmesine ge√ßildi")
                                notebook_found = True
                                break
                    except Exception as e:
                        print(f"[ADDNEWPOS] ‚ö†Ô∏è Notebook bulma hatasƒ±: {e}")
                
                # Psfalgo'dan Long filtrelerini al
                long_sma_value = self.long_sma_filter_var.get().strip() if hasattr(self, 'long_sma_filter_var') else "-1.6"
                long_sma_type = self.long_sma_filter_type.get() if hasattr(self, 'long_sma_filter_type') else "below"
                long_fbtot_value = self.long_fbtot_filter_var.get().strip() if hasattr(self, 'long_fbtot_filter_var') else ""
                long_fbtot_type = self.long_fbtot_filter_type.get() if hasattr(self, 'long_fbtot_filter_type') else "below"
                long_gort_value = self.long_gort_filter_var.get().strip() if hasattr(self, 'long_gort_filter_var') else ""
                long_gort_type = self.long_gort_filter_type.get() if hasattr(self, 'long_gort_filter_type') else "below"
                
                print(f"[ADDNEWPOS] üìä Long Filtreler: SMA={long_sma_type} {long_sma_value}, FBtot={long_fbtot_type} {long_fbtot_value}, Gort={long_gort_type} {long_gort_value}")
                self.log_message(f"üìä Long Filtreler: SMA={long_sma_type} {long_sma_value}, FBtot={long_fbtot_type} {long_fbtot_value}, Gort={long_gort_type} {long_gort_value}")
                
                # BB Long filtrelerini uygula
                if hasattr(final_thg, 'bb_sma_filter_var'):
                    try:
                        # SMA63 Chg filtresi
                        final_thg.bb_sma_filter_var.set(long_sma_value)
                        if hasattr(final_thg, 'bb_filter_type'):
                            final_thg.bb_filter_type.set(long_sma_type)
                        
                        # FBtot filtresi
                        if hasattr(final_thg, 'bb_fbtot_filter_var'):
                            final_thg.bb_fbtot_filter_var.set(long_fbtot_value)
                        if hasattr(final_thg, 'bb_fbtot_filter_type'):
                            final_thg.bb_fbtot_filter_type.set(long_fbtot_type)
                        
                        # Gort filtresi
                        if hasattr(final_thg, 'bb_gort_filter_var'):
                            final_thg.bb_gort_filter_var.set(long_gort_value)
                        if hasattr(final_thg, 'bb_gort_filter_type'):
                            final_thg.bb_gort_filter_type.set(long_gort_type)
                        
                        # Filtreyi uygula
                        if hasattr(final_thg, 'apply_bb_filter'):
                            final_thg.apply_bb_filter()
                            print("[ADDNEWPOS] ‚úÖ BB Long filtreleri uygulandƒ±")
                            self.log_message("‚úÖ Adƒ±m 6: BB Long filtreleri uygulandƒ±")
                    except Exception as e:
                        print(f"[ADDNEWPOS] ‚ùå BB Long filtre ayarlama hatasƒ±: {e}")
                        self.log_message(f"‚ùå BB Long filtre ayarlama hatasƒ±: {e}")
                        import traceback
                        traceback.print_exc()
                
                # FB Long filtrelerini uygula
                if hasattr(final_thg, 'fb_sma_filter_var'):
                    try:
                        # SMA63 Chg filtresi
                        final_thg.fb_sma_filter_var.set(long_sma_value)
                        if hasattr(final_thg, 'fb_filter_type'):
                            final_thg.fb_filter_type.set(long_sma_type)
                        
                        # FBtot filtresi
                        if hasattr(final_thg, 'fb_fbtot_filter_var'):
                            final_thg.fb_fbtot_filter_var.set(long_fbtot_value)
                        if hasattr(final_thg, 'fb_fbtot_filter_type'):
                            final_thg.fb_fbtot_filter_type.set(long_fbtot_type)
                        
                        # Gort filtresi
                        if hasattr(final_thg, 'fb_gort_filter_var'):
                            final_thg.fb_gort_filter_var.set(long_gort_value)
                        if hasattr(final_thg, 'fb_gort_filter_type'):
                            final_thg.fb_gort_filter_type.set(long_gort_type)
                        
                        # Filtreyi uygula
                        if hasattr(final_thg, 'apply_fb_filter'):
                            final_thg.apply_fb_filter()
                            print("[ADDNEWPOS] ‚úÖ FB Long filtreleri uygulandƒ±")
                            self.log_message("‚úÖ Adƒ±m 6: FB Long filtreleri uygulandƒ±")
                    except Exception as e:
                        print(f"[ADDNEWPOS] ‚ùå FB Long filtre ayarlama hatasƒ±: {e}")
                        self.log_message(f"‚ùå FB Long filtre ayarlama hatasƒ±: {e}")
                        import traceback
                        traceback.print_exc()
                
                # Popup'larƒ± kapat ve sonraki adƒ±ma ge√ß
                def proceed_to_step_7():
                    # Popup'larƒ± kontrol et ve kapat
                    self.addnewpos_close_messagebox()
                    # Sonraki adƒ±ma ge√ß
                    self.addnewpos_step_7_jfin_50_bb()
                
                self.after(500, lambda: self.addnewpos_close_messagebox())
                self.after(1500, proceed_to_step_7)
            else:
                print("[ADDNEWPOS] ‚ùå FinalThgLotDistributor referansƒ± bulunamadƒ±")
                self.log_message("‚ùå Adƒ±m 6: Final FB & SFS penceresi bulunamadƒ±")
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Adƒ±m 6 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 6 hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_step_7_jfin_mode_based(self):
        """Adƒ±m 7: Mode'a g√∂re JFIN emirlerini a√ß (BB Long / SAS Short / Her ikisi)"""
        try:
            # ADDNEWPOS modunu al
            mode = self.get_addnewpos_mode()
            
            if mode == 'addlong_only':
                # Sadece BB Long
                self.log_message("üìã Adƒ±m 7: JFIN %50 BB Long a√ßƒ±lƒ±yor (AddLong Only)...")
                self.addnewpos_execute_bb_long()
            elif mode == 'addshort_only':
                # Sadece SAS Short - Short filtrelerini uygula
                self.log_message("üìã Adƒ±m 7: Short filtreleri uygulanƒ±yor ve JFIN %50 SAS Short a√ßƒ±lƒ±yor (AddShort Only)...")
                self.addnewpos_apply_short_filters_and_execute_sas()
            elif mode == 'addboth':
                # √ñnce BB Long, sonra SAS Short
                self.log_message("üìã Adƒ±m 7: AddBoth modu - √ñnce BB Long, sonra SAS Short yapƒ±lacak...")
                self.addnewpos_addboth_phase = 'bb_long'  # Hangi a≈üamada olduƒüumuzu sakla
                self.addnewpos_execute_bb_long()
            else:
                # Bilinmeyen mod, varsayƒ±lan olarak BB Long yap
                self.log_message(f"‚ö†Ô∏è Bilinmeyen mod: {mode}, varsayƒ±lan BB Long yapƒ±lƒ±yor...")
                self.addnewpos_execute_bb_long()
                
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Adƒ±m 7 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 7 hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_execute_bb_long(self):
        """BB Long emirlerini a√ß (Long filtreleri zaten uygulanmƒ±≈ü durumda)"""
        try:
            # FinalThgLotDistributor referansƒ±nƒ± al
            final_thg = self._get_final_thg_reference()
            
            if final_thg and hasattr(final_thg, 'show_jfin_orders'):
                # JFIN %50 BB emirlerini g√∂ster
                final_thg.show_jfin_orders('BB', 50)
                self.addnewpos_current_jfin_tab = 'BB'
                print("[ADDNEWPOS] ‚úÖ JFIN %50 BB Long penceresi a√ßƒ±ldƒ±")
                self.log_message("‚úÖ JFIN %50 BB Long penceresi a√ßƒ±ldƒ±")
                
                # Popup'larƒ± kapat ve excluded ticker kontrol√º yap
                def proceed_to_step_8():
                    self.addnewpos_close_messagebox()
                    self.addnewpos_step_8_exclude_check()
                    # Sonra emirleri g√∂nder
                    self.after(2000, lambda: self.addnewpos_step_9_auto_send_orders())
                
                self.after(2000, proceed_to_step_8)
            else:
                print("[ADDNEWPOS] ‚ùå FinalThgLotDistributor veya show_jfin_orders bulunamadƒ±")
                self.log_message("‚ùå JFIN %50 BB butonu bulunamadƒ±")
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå BB Long hatasƒ±: {e}")
            self.log_message(f"‚ùå BB Long hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_apply_short_filters_and_execute_sas(self):
        """Short filtrelerini uygula ve SAS Short emirlerini a√ß"""
        try:
            final_thg = self._get_final_thg_reference()
            
            if not final_thg:
                print("[ADDNEWPOS] ‚ùå FinalThgLotDistributor referansƒ± bulunamadƒ±")
                self.log_message("‚ùå Final FB & SFS penceresi bulunamadƒ±")
                return
            
            # SAS Short sekmesine ge√ß (notebook'u kontrol et)
            if hasattr(final_thg, 'win') and final_thg.win.winfo_exists():
                try:
                    for widget in final_thg.win.winfo_children():
                        if isinstance(widget, ttk.Notebook):
                            # SAS Short sekmesine ge√ß (index 2 - BB=0, FB=1, SAS=2, SFS=3)
                            widget.select(2)
                            print("[ADDNEWPOS] ‚úÖ SAS Short sekmesine ge√ßildi")
                            break
                except Exception as e:
                    print(f"[ADDNEWPOS] ‚ö†Ô∏è SAS sekmesine ge√ßi≈ü hatasƒ±: {e}")
            
            # Psfalgo'dan Short filtrelerini al
            short_sma_value = self.short_sma_filter_var.get().strip() if hasattr(self, 'short_sma_filter_var') else ""
            short_sma_type = self.short_sma_filter_type.get() if hasattr(self, 'short_sma_filter_type') else "below"
            short_sfstot_value = self.short_sfstot_filter_var.get().strip() if hasattr(self, 'short_sfstot_filter_var') else ""
            short_sfstot_type = self.short_sfstot_filter_type.get() if hasattr(self, 'short_sfstot_filter_type') else "below"
            short_gort_value = self.short_gort_filter_var.get().strip() if hasattr(self, 'short_gort_filter_var') else "1"
            short_gort_type = self.short_gort_filter_type.get() if hasattr(self, 'short_gort_filter_type') else "above"
            
            print(f"[ADDNEWPOS] üìä Short Filtreler: SMA={short_sma_type} {short_sma_value}, SFStot={short_sfstot_type} {short_sfstot_value}, Gort={short_gort_type} {short_gort_value}")
            self.log_message(f"üìä Short Filtreler: SMA={short_sma_type} {short_sma_value}, SFStot={short_sfstot_type} {short_sfstot_value}, Gort={short_gort_type} {short_gort_value}")
            
            # SAS Short filtrelerini uygula
            if hasattr(final_thg, 'sas_sma_filter_var'):
                try:
                    # SMA63 Chg filtresi
                    final_thg.sas_sma_filter_var.set(short_sma_value)
                    if hasattr(final_thg, 'sas_filter_type'):
                        final_thg.sas_filter_type.set(short_sma_type)
                    
                    # SFStot filtresi (Short i√ßin FBtot yerine SFStot)
                    if hasattr(final_thg, 'sas_sfstot_filter_var'):
                        final_thg.sas_sfstot_filter_var.set(short_sfstot_value)
                    if hasattr(final_thg, 'sas_sfstot_filter_type'):
                        final_thg.sas_sfstot_filter_type.set(short_sfstot_type)
                    
                    # Gort filtresi
                    if hasattr(final_thg, 'sas_gort_filter_var'):
                        final_thg.sas_gort_filter_var.set(short_gort_value)
                    if hasattr(final_thg, 'sas_gort_filter_type'):
                        final_thg.sas_gort_filter_type.set(short_gort_type)
                    
                    # Filtreyi uygula
                    if hasattr(final_thg, 'apply_sas_filter'):
                        final_thg.apply_sas_filter()
                        print("[ADDNEWPOS] ‚úÖ SAS Short filtreleri uygulandƒ±")
                        self.log_message("‚úÖ SAS Short filtreleri uygulandƒ±")
                except Exception as e:
                    print(f"[ADDNEWPOS] ‚ùå SAS Short filtre ayarlama hatasƒ±: {e}")
                    self.log_message(f"‚ùå SAS Short filtre ayarlama hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
            
            # Kƒ±sa bekleme sonrasƒ± SAS Short emirlerini a√ß
            self.after(1500, self.addnewpos_execute_sas_short)
            
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Short filtre uygulama hatasƒ±: {e}")
            self.log_message(f"‚ùå Short filtre uygulama hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_execute_sas_short(self):
        """SAS Short emirlerini a√ß"""
        try:
            final_thg = self._get_final_thg_reference()
            
            if final_thg and hasattr(final_thg, 'show_jfin_orders'):
                # JFIN %50 SAS emirlerini g√∂ster (ASK SELL)
                final_thg.show_jfin_orders('SAS', 50)
                self.addnewpos_current_jfin_tab = 'SAS'
                print("[ADDNEWPOS] ‚úÖ JFIN %50 SAS Short penceresi a√ßƒ±ldƒ± (ASK SELL)")
                self.log_message("‚úÖ JFIN %50 SAS Short penceresi a√ßƒ±ldƒ± (ASK SELL)")
                
                # Popup'larƒ± kapat ve excluded ticker kontrol√º yap
                def proceed_to_step_8():
                    self.addnewpos_close_messagebox()
                    self.addnewpos_step_8_exclude_check()
                    # Sonra emirleri g√∂nder
                    self.after(2000, lambda: self.addnewpos_step_9_auto_send_orders())
                
                self.after(2000, proceed_to_step_8)
            else:
                print("[ADDNEWPOS] ‚ùå FinalThgLotDistributor veya show_jfin_orders bulunamadƒ±")
                self.log_message("‚ùå JFIN %50 SAS butonu bulunamadƒ±")
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå SAS Short hatasƒ±: {e}")
            self.log_message(f"‚ùå SAS Short hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_addboth_continue_with_sas(self):
        """AddBoth modunda BB Long tamamlandƒ±ktan sonra SAS Short'a ge√ß"""
        try:
            print("[ADDNEWPOS] üîÑ AddBoth: BB Long tamamlandƒ±, ≈üimdi SAS Short ba≈ülatƒ±lƒ±yor...")
            self.log_message("üîÑ AddBoth: BB Long tamamlandƒ±, ≈üimdi SAS Short ba≈ülatƒ±lƒ±yor...")
            
            # Mevcut JFIN penceresini kapat
            self.addnewpos_close_all_jfin_windows()
            
            # Kƒ±sa bekleme sonrasƒ± SAS Short'u ba≈ülat
            self.addnewpos_addboth_phase = 'sas_short'
            self.after(2000, self.addnewpos_apply_short_filters_and_execute_sas)
            
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå AddBoth SAS ge√ßi≈ü hatasƒ±: {e}")
            self.log_message(f"‚ùå AddBoth SAS ge√ßi≈ü hatasƒ±: {e}")
    
    def addnewpos_close_all_jfin_windows(self):
        """T√ºm JFIN pencerelerini kapat"""
        try:
            final_thg = self._get_final_thg_reference()
            if final_thg and hasattr(final_thg, 'win'):
                for widget in final_thg.win.winfo_children():
                    if isinstance(widget, tk.Toplevel):
                        try:
                            if "JFIN" in widget.title():
                                widget.destroy()
                                print("[ADDNEWPOS] üóëÔ∏è JFIN penceresi kapatƒ±ldƒ±")
                        except:
                            pass
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ö†Ô∏è JFIN pencere kapatma hatasƒ±: {e}")
    
    def _get_final_thg_reference(self):
        """FinalThgLotDistributor referansƒ±nƒ± al (yardƒ±mcƒ± fonksiyon)"""
        final_thg = None
        if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
            final_thg = self.addnewpos_final_thg
        elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
            final_thg = self.addnewpos_port_adjuster.final_thg_distributor
            self.addnewpos_final_thg = final_thg
        return final_thg
    
    # Eski fonksiyon adƒ±nƒ± koruyalƒ±m (geriye uyumluluk i√ßin)
    def addnewpos_step_7_jfin_50_bb(self):
        """Adƒ±m 7: Mode'a g√∂re JFIN emirlerini a√ß (eski isim, yeni fonksiyona y√∂nlendirir)"""
        self.addnewpos_step_7_jfin_mode_based()
    
    def addnewpos_step_8_exclude_check(self):
        """Adƒ±m 8: Excluded ticker kontrol√º ve onay penceresinde excluded ticker'larƒ± √ßƒ±kar"""
        try:
            self.log_message("üìã Adƒ±m 8: Excluded ticker kontrol√º yapƒ±lƒ±yor...")
            
            # FinalThgLotDistributor referansƒ±nƒ± al
            final_thg = None
            if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                final_thg = self.addnewpos_final_thg
            elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                self.addnewpos_final_thg = final_thg
            
            # FinalThgLotDistributor'daki JFIN onay penceresini bul
            if final_thg and hasattr(final_thg, 'win'):
                # T√ºm a√ßƒ±k pencereleri kontrol et
                for child in final_thg.win.winfo_children():
                    if isinstance(child, tk.Toplevel):
                        # JFIN onay penceresi bulundu
                        self.addnewpos_exclude_from_jfin_window(child)
                        return
                
                # Eƒüer doƒürudan win'in altƒ±nda deƒüilse, t√ºm toplevel'leri kontrol et
                all_windows = []
                def find_toplevels(parent):
                    for widget in parent.winfo_children():
                        if isinstance(widget, tk.Toplevel):
                            all_windows.append(widget)
                        find_toplevels(widget)
                
                find_toplevels(final_thg.win)
                
                # JFIN onay penceresini bul (ba≈ülƒ±ƒüƒ±nda "JFIN" ge√ßen)
                for win in all_windows:
                    try:
                        if "JFIN" in win.title():
                            self.addnewpos_exclude_from_jfin_window(win)
                            return
                    except:
                        continue
                
                # Eƒüer hala bulunamadƒ±ysa, t√ºm a√ßƒ±k Toplevel pencerelerini kontrol et
                self.addnewpos_find_jfin_window_recursive(final_thg.win)
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Adƒ±m 8 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 8 hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            
            # Hata olsa bile sonraki adƒ±ma ge√ß (RUNALL'dan √ßaƒürƒ±ldƒ±ysa)
            if hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started:
                print("[ADDNEWPOS] ‚ö†Ô∏è Adƒ±m 8 hatasƒ± nedeniyle Adƒ±m 9'a ge√ßiliyor...")
                self.log_message("‚ö†Ô∏è Adƒ±m 8 hatasƒ± nedeniyle Adƒ±m 9'a ge√ßiliyor...")
                # Sonraki adƒ±ma ge√ß
                self.after(2000, self.addnewpos_step_9_auto_send_orders)
    
    def addnewpos_exclude_from_jfin_window(self, jfin_window):
        """JFIN onay penceresinde excluded ticker'larƒ± i≈üaretleme kaldƒ±r ve toplam lot bildirimi g√∂ster"""
        try:
            from tkinter import messagebox
            
            # Excluded ticker'larƒ± y√ºkle
            self.load_excluded_tickers_from_csv()
            
            excluded_tickers_exist = hasattr(self, 'excluded_tickers') and self.excluded_tickers
            if not excluded_tickers_exist:
                print("[ADDNEWPOS] ‚ÑπÔ∏è Excluded ticker yok, t√ºm emirler g√∂nderilecek")
                self.log_message("‚ÑπÔ∏è Excluded ticker yok, t√ºm emirler g√∂nderilecek")
            
            # JFIN penceresindeki treeview'ƒ± bul
            order_tree = None
            for widget in jfin_window.winfo_children():
                if isinstance(widget, ttk.Treeview):
                    order_tree = widget
                    break
                # Frame i√ßinde de olabilir
                for child in widget.winfo_children():
                    if isinstance(child, ttk.Treeview):
                        order_tree = child
                        break
                    for grandchild in child.winfo_children():
                        if isinstance(grandchild, ttk.Treeview):
                            order_tree = grandchild
                            break
            
            if not order_tree:
                print("[ADDNEWPOS] ‚ö†Ô∏è JFIN onay penceresinde treeview bulunamadƒ±")
                self.log_message("‚ö†Ô∏è JFIN onay penceresinde treeview bulunamadƒ±")
                return
            
            # Excluded ticker'larƒ± i≈üaretleme kaldƒ±r ve toplam lot hesapla
            excluded_count = 0
            excluded_lot_total = 0
            remaining_lot_total = 0
            total_orders = 0
            remaining_orders = 0
            
            # Emir t√ºr√ºn√º belirle (Long mu Short mu?)
            order_type = "pozisyon arttƒ±rma"  # Varsayƒ±lan
            try:
                window_title = jfin_window.title()
                if "BB" in window_title or "FB" in window_title or "SoftFB" in window_title:
                    order_type = "pozisyon arttƒ±rma"  # Long
                elif "SAS" in window_title or "SFS" in window_title or "SoftFS" in window_title:
                    order_type = "pozisyon azaltma"  # Short
            except:
                pass
            
            for item in order_tree.get_children():
                values = list(order_tree.item(item)['values'])
                if len(values) >= 10:  # En az 10 kolon olmalƒ± (Hesaplanan Lot kolonu i√ßin)
                    symbol = values[2]  # Sembol kolonu
                    # Hesaplanan Lot kolonu (index 9)
                    try:
                        calculated_lot_str = str(values[9]).replace(',', '').strip()
                        calculated_lot = int(float(calculated_lot_str)) if calculated_lot_str and calculated_lot_str != 'N/A' else 0
                    except (ValueError, TypeError, IndexError):
                        calculated_lot = 0
                    
                    total_orders += 1
                    
                    # Se√ßili emirlerin lot toplamƒ±nƒ± hesapla (excluded olmayanlar i√ßin)
                    if values[0] == '‚òë':  # Se√ßili ise
                        if excluded_tickers_exist and self.is_ticker_excluded(symbol):
                            # Excluded ticker - checkbox'ƒ± kaldƒ±r (‚òê yap)
                            values[0] = '‚òê'
                            order_tree.item(item, values=values, tags=('unselected',))
                            excluded_count += 1
                            excluded_lot_total += calculated_lot
                            print(f"[ADDNEWPOS] üö´ {symbol} excluded - i≈üaretleme kaldƒ±rƒ±ldƒ± ({calculated_lot:,} lot)")
                        else:
                            # Se√ßili emir (excluded deƒüil)
                            remaining_lot_total += calculated_lot
                            remaining_orders += 1
            
            # Bildirim mesajƒ± olu≈ütur
            if excluded_count > 0:
                self.log_message(f"‚úÖ {excluded_count} excluded ticker i≈üaretlemesi kaldƒ±rƒ±ldƒ± ({excluded_lot_total:,} lot)")
                print(f"[ADDNEWPOS] ‚úÖ {excluded_count} excluded ticker i≈üaretlemesi kaldƒ±rƒ±ldƒ± ({excluded_lot_total:,} lot)")
            
            # Toplam lot bildirimi g√∂ster
            if remaining_lot_total > 0:
                message = f"üìä {remaining_lot_total:,} lot {order_type} emri onay penceresine a√ßƒ±ldƒ±"
                if excluded_count > 0:
                    message += f"\nüö´ {excluded_count} ticker excluded ({excluded_lot_total:,} lot √ßƒ±karƒ±ldƒ±)"
                message += f"\n‚úÖ {remaining_orders} emir g√∂nderilecek"
                
                print(f"[ADDNEWPOS] {message}")
                self.log_message(message)
                
                # Bildirim penceresi g√∂ster (Allowed modunda g√∂sterme)
                if not (hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode):
                    messagebox.showinfo("ADDNEWPOS - Emir √ñzeti", message)
                else:
                    print(f"[ADDNEWPOS] ‚ÑπÔ∏è Allowed modu aktif - Bildirim penceresi g√∂sterilmedi")
            else:
                warning_msg = "‚ö†Ô∏è Hi√ß emir kalmadƒ±! T√ºm emirler excluded edilmi≈ü olabilir."
                print(f"[ADDNEWPOS] {warning_msg}")
                self.log_message(warning_msg)
                messagebox.showwarning("Uyarƒ±", warning_msg)
            
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Exclude kontrol hatasƒ±: {e}")
            self.log_message(f"‚ùå Exclude kontrol hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def addnewpos_find_jfin_window_recursive(self, parent):
        """Recursive olarak JFIN penceresini bul"""
        try:
            for widget in parent.winfo_children():
                if isinstance(widget, tk.Toplevel):
                    try:
                        if "JFIN" in widget.title():
                            self.addnewpos_exclude_from_jfin_window(widget)
                            # JFIN penceresini sakla (emir g√∂nderme i√ßin)
                            self.addnewpos_jfin_window = widget
                            return
                    except:
                        pass
                # Recursive olarak devam et
                self.addnewpos_find_jfin_window_recursive(widget)
        except:
            pass
    
    def addnewpos_step_9_auto_send_orders(self):
        """Adƒ±m 9: JFIN onay penceresinde Emirleri G√∂nder butonuna otomatik tƒ±kla"""
        try:
            # RUNALL Allowed modunda emirler zaten otomatik g√∂nderiliyor, bu adƒ±mƒ± atla
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print("[ADDNEWPOS] ‚ÑπÔ∏è Allowed modu aktif - Emirler zaten otomatik g√∂nderildi, Adƒ±m 9 atlanƒ±yor")
                self.log_message("‚ÑπÔ∏è Adƒ±m 9: Allowed modu aktif - Emirler zaten otomatik g√∂nderildi")
                return
            
            self.log_message("üìã Adƒ±m 9: Emirleri G√∂nder butonuna otomatik tƒ±klanƒ±yor...")
            
            # JFIN penceresini bul - √ñNCE attribute'u kontrol et
            jfin_window = None
            
            # 1. √ñnce kaydedilmi≈ü JFIN penceresini kontrol et (hala var mƒ±?)
            if hasattr(self, 'addnewpos_jfin_window') and self.addnewpos_jfin_window:
                try:
                    if self.addnewpos_jfin_window.winfo_exists():
                        jfin_window = self.addnewpos_jfin_window
                        print("[ADDNEWPOS] ‚úÖ JFIN penceresi attribute'dan bulundu")
                except:
                    # Pencere kapanmƒ±≈ü olabilir, attribute'u temizle
                    self.addnewpos_jfin_window = None
            
            # 2. Eƒüer bulunamadƒ±ysa, FinalThgLotDistributor penceresi i√ßinde ara
            if not jfin_window:
                final_thg = None
                if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                    final_thg = self.addnewpos_final_thg
                elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                    final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                
                if final_thg and hasattr(final_thg, 'win'):
                    try:
                        # T√ºm a√ßƒ±k pencereleri kontrol et
                        all_windows = []
                        def find_toplevels(parent):
                            try:
                                for widget in parent.winfo_children():
                                    if isinstance(widget, tk.Toplevel):
                                        all_windows.append(widget)
                                    find_toplevels(widget)
                            except:
                                pass
                        
                        find_toplevels(final_thg.win)
                        
                        # JFIN onay penceresini bul
                        for win in all_windows:
                            try:
                                if win.winfo_exists() and "JFIN" in win.title():
                                    jfin_window = win
                                    self.addnewpos_jfin_window = win
                                    print("[ADDNEWPOS] ‚úÖ JFIN penceresi final_thg.win i√ßinde bulundu")
                                    break
                            except:
                                continue
                    except Exception as e:
                        print(f"[ADDNEWPOS] ‚ö†Ô∏è final_thg.win i√ßinde arama hatasƒ±: {e}")
            
            # 3. Hala bulunamadƒ±ysa, main_window altƒ±nda t√ºm Toplevel pencereleri kontrol et
            if not jfin_window:
                try:
                    all_toplevels = []
                    def find_all_toplevels(parent, depth=0):
                        if depth > 10:  # Recursion limit
                            return
                        try:
                            for widget in parent.winfo_children():
                                if isinstance(widget, tk.Toplevel):
                                    try:
                                        if widget.winfo_exists() and "JFIN" in widget.title():
                                            all_toplevels.append(widget)
                                    except:
                                        pass
                                find_all_toplevels(widget, depth + 1)
                        except:
                            pass
                    
                    # Ana pencereden ba≈üla
                    find_all_toplevels(self)
                    
                    # JFIN penceresini bul
                    for win in all_toplevels:
                        try:
                            if win.winfo_exists():
                                jfin_window = win
                                self.addnewpos_jfin_window = win
                                print("[ADDNEWPOS] ‚úÖ JFIN penceresi main_window altƒ±nda bulundu")
                                break
                        except:
                            continue
                except Exception as e:
                    print(f"[ADDNEWPOS] ‚ö†Ô∏è main_window altƒ±nda arama hatasƒ±: {e}")
            
            # 4. Son √ßare: addnewpos_find_jfin_window_recursive fonksiyonunu kullan
            if not jfin_window:
                try:
                    # √ñnce final_thg.win'den ba≈üla
                    final_thg = None
                    if hasattr(self, 'addnewpos_final_thg') and self.addnewpos_final_thg:
                        final_thg = self.addnewpos_final_thg
                    elif hasattr(self, 'addnewpos_port_adjuster') and hasattr(self.addnewpos_port_adjuster, 'final_thg_distributor'):
                        final_thg = self.addnewpos_port_adjuster.final_thg_distributor
                    
                    if final_thg and hasattr(final_thg, 'win'):
                        self.addnewpos_find_jfin_window_recursive(final_thg.win)
                        if hasattr(self, 'addnewpos_jfin_window') and self.addnewpos_jfin_window:
                            try:
                                if self.addnewpos_jfin_window.winfo_exists():
                                    jfin_window = self.addnewpos_jfin_window
                                    print("[ADDNEWPOS] ‚úÖ JFIN penceresi recursive fonksiyon ile bulundu")
                            except:
                                pass
                    
                    # Eƒüer hala bulunamadƒ±ysa, main_window'dan ba≈üla
                    if not jfin_window:
                        self.addnewpos_find_jfin_window_recursive(self)
                        if hasattr(self, 'addnewpos_jfin_window') and self.addnewpos_jfin_window:
                            try:
                                if self.addnewpos_jfin_window.winfo_exists():
                                    jfin_window = self.addnewpos_jfin_window
                                    print("[ADDNEWPOS] ‚úÖ JFIN penceresi main_window recursive ile bulundu")
                            except:
                                pass
                except Exception as e:
                    print(f"[ADDNEWPOS] ‚ö†Ô∏è Recursive arama hatasƒ±: {e}")
            
            if jfin_window:
                # "Emirleri G√∂nder" butonunu bul ve tƒ±kla
                send_button = None
                
                def find_send_button(parent):
                    nonlocal send_button
                    if send_button:
                        return
                    try:
                        for widget in parent.winfo_children():
                            try:
                                # Button kontrol√º
                                if isinstance(widget, (tk.Button, ttk.Button)):
                                    try:
                                        text = str(widget.cget('text')).lower()
                                        # "Emirleri G√∂nder" butonunu bul
                                        if 'g√∂nder' in text or 'send' in text or ('emir' in text and 'g√∂nder' in text):
                                            send_button = widget
                                            print(f"[ADDNEWPOS] ‚úÖ Buton bulundu: '{widget.cget('text')}'")
                                            return
                                    except Exception as e:
                                        pass
                                
                                # Recursive olarak devam et
                                find_send_button(widget)
                            except Exception as e:
                                # Widget eri≈üilemez olabilir, devam et
                                pass
                    except Exception as e:
                        pass
                
                find_send_button(jfin_window)
                
                if send_button:
                    # Retry saya√ßlarƒ±nƒ± sƒ±fƒ±rla (ba≈üarƒ±lƒ± oldu)
                    if hasattr(self, 'addnewpos_send_retry_count'):
                        self.addnewpos_send_retry_count = 0
                    if hasattr(self, 'addnewpos_window_retry_count'):
                        self.addnewpos_window_retry_count = 0
                    
                    print("[ADDNEWPOS] ‚úÖ Emirleri G√∂nder butonu bulundu, tƒ±klanƒ±yor...")
                    self.log_message("‚úÖ Adƒ±m 9: Emirleri G√∂nder butonuna tƒ±klanƒ±yor...")
                    try:
                        send_button.invoke()
                        print("[ADDNEWPOS] ‚úÖ Emirleri G√∂nder butonuna tƒ±klandƒ±")
                        self.log_message("‚úÖ Adƒ±m 9: Emirleri G√∂nder butonuna tƒ±klandƒ±")
                        
                        # AddBoth modunda: BB Long tamamlandƒ±ysa SAS Short'a ge√ß
                        mode = self.get_addnewpos_mode()
                        if mode == 'addboth' and hasattr(self, 'addnewpos_addboth_phase'):
                            if self.addnewpos_addboth_phase == 'bb_long':
                                print("[ADDNEWPOS] üîÑ AddBoth: BB Long emirleri g√∂nderildi, SAS Short'a ge√ßiliyor...")
                                self.log_message("üîÑ AddBoth: BB Long emirleri g√∂nderildi, SAS Short'a ge√ßiliyor...")
                                # 3 saniye bekle ve SAS Short'a ge√ß
                                self.after(3000, self.addnewpos_addboth_continue_with_sas)
                            elif self.addnewpos_addboth_phase == 'sas_short':
                                print("[ADDNEWPOS] ‚úÖ AddBoth: SAS Short emirleri de g√∂nderildi, t√ºm i≈ülemler tamamlandƒ±!")
                                self.log_message("‚úÖ AddBoth: T√ºm i≈ülemler tamamlandƒ± (BB Long + SAS Short)")
                                # Phase'i temizle
                                delattr(self, 'addnewpos_addboth_phase')
                        
                    except Exception as e:
                        print(f"[ADDNEWPOS] ‚ö†Ô∏è Buton tƒ±klama hatasƒ±: {e}")
                        self.log_message(f"‚ö†Ô∏è Adƒ±m 9: Buton tƒ±klama hatasƒ±: {e}")
                else:
                    # Hala bulunamadƒ±ysa tekrar dene (max 5 kez)
                    if not hasattr(self, 'addnewpos_send_retry_count'):
                        self.addnewpos_send_retry_count = 0
                    
                    self.addnewpos_send_retry_count += 1
                    if self.addnewpos_send_retry_count < 5:
                        print(f"[ADDNEWPOS] ‚ö†Ô∏è Emirleri G√∂nder butonu bulunamadƒ±, tekrar denenecek... ({self.addnewpos_send_retry_count}/5)")
                        self.log_message(f"‚ö†Ô∏è Adƒ±m 9: Emirleri G√∂nder butonu bulunamadƒ±, tekrar denenecek... ({self.addnewpos_send_retry_count}/5)")
                        # 2 saniye sonra tekrar dene
                        self.after(2000, lambda: self.addnewpos_step_9_auto_send_orders())
                    else:
                        print("[ADDNEWPOS] ‚ùå Emirleri G√∂nder butonu 5 denemede bulunamadƒ±, manuel g√∂nderilmesi gerekiyor")
                        self.log_message("‚ùå Adƒ±m 9: Emirleri G√∂nder butonu bulunamadƒ±, l√ºtfen manuel g√∂nderin")
                        self.addnewpos_send_retry_count = 0  # Reset
            else:
                # JFIN penceresi bulunamadƒ±, retry yap
                if not hasattr(self, 'addnewpos_window_retry_count'):
                    self.addnewpos_window_retry_count = 0
                
                self.addnewpos_window_retry_count += 1
                if self.addnewpos_window_retry_count < 10:  # 10 deneme yap (pencere a√ßƒ±lmasƒ± zaman alabilir)
                    print(f"[ADDNEWPOS] ‚ö†Ô∏è JFIN onay penceresi bulunamadƒ±, tekrar denenecek... ({self.addnewpos_window_retry_count}/10)")
                    self.log_message(f"‚ö†Ô∏è Adƒ±m 9: JFIN onay penceresi bulunamadƒ±, tekrar denenecek... ({self.addnewpos_window_retry_count}/10)")
                    # 2 saniye sonra tekrar dene
                    self.after(2000, lambda: self.addnewpos_step_9_auto_send_orders())
                else:
                    print("[ADDNEWPOS] ‚ùå JFIN onay penceresi 10 denemede bulunamadƒ±")
                    self.log_message("‚ùå Adƒ±m 9: JFIN onay penceresi bulunamadƒ±, l√ºtfen manuel kontrol edin")
                    self.addnewpos_window_retry_count = 0  # Reset
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Adƒ±m 9 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 9 hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def toggle_controller(self):
        """Controller ON/OFF toggle"""
        try:
            self.controller_enabled = not self.controller_enabled
            
            if self.controller_enabled:
                self.controller_btn.config(text="üéõÔ∏è Controller: ON")
                self.controller_btn.config(style='Success.TButton')
                print("[CONTROLLER] ‚úÖ Controller: ON")
                self.log_message("‚úÖ Controller: ON - Pozisyon kontrol√º aktif")
            else:
                self.controller_btn.config(text="üéõÔ∏è Controller: OFF")
                self.controller_btn.config(style='Accent.TButton')
                print("[CONTROLLER] ‚ùå Controller: OFF")
                self.log_message("‚ùå Controller: OFF - Pozisyon kontrol√º kapalƒ±")
                
        except Exception as e:
            print(f"[CONTROLLER] ‚ùå Toggle hatasƒ±: {e}")
            self.log_message(f"‚ùå Controller toggle hatasƒ±: {e}")
    
    def start_karbotu_automation(self):
        """KARBOTU otomasyonunu ba≈ülat"""
        try:
            print("[KARBOTU] üéØ KARBOTU otomasyonu ba≈ülatƒ±lƒ±yor...")
            self.log_message("üéØ KARBOTU otomasyonu ba≈ülatƒ±lƒ±yor...")
            
            # KARBOTU adƒ±mlarƒ±nƒ± ba≈ülat
            self.karbotu_current_step = 1
            self.karbotu_total_steps = 13
            self.karbotu_running = True
            
            # ƒ∞lk adƒ±m: Take Profit Longs penceresini a√ß (non-blocking)
            # after() kullanarak GUI'yi bloklamadan ba≈ülat
            self.after(100, self.karbotu_step_1_open_take_profit_longs)
            
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Otomasyon ba≈ülatma hatasƒ±: {e}")
            self.log_message(f"‚ùå KARBOTU ba≈ülatma hatasƒ±: {e}")
            self.after(0, lambda: messagebox.showerror("Hata", f"KARBOTU ba≈ülatƒ±lamadƒ±: {e}"))
    
    def karbotu_step_1_open_take_profit_longs(self):
        """Adƒ±m 1: Take Profit Longs penceresini a√ß"""
        try:
            print("[KARBOTU] üìã Adƒ±m 1: Take Profit Longs penceresi a√ßƒ±lƒ±yor...")
            self.log_message("üìã Adƒ±m 1: Take Profit Longs penceresi a√ßƒ±lƒ±yor...")
            
            # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
            self.update_idletasks()
            
            # Take Profit Longs penceresini a√ß (non-blocking)
            from .take_profit_panel import TakeProfitPanel
            self.take_profit_longs_panel = TakeProfitPanel(self, "longs")
            
            # GUI'yi g√ºncelle (pencere a√ßƒ±ldƒ±ktan sonra)
            self.update_idletasks()
            
            # Gort kontrol√º yap (Take Profit Longs i√ßin) - non-blocking
            self.after(200, self.karbotu_gort_check_take_profit_longs)
            
            # Adƒ±m 2'ye ge√ß (Gort kontrol√º bitince)
            self.karbotu_current_step = 2
            # Gort kontrol√º bitince adƒ±m 2'ye ge√ßilecek (karbotu_gort_check_take_profit_longs i√ßinde)
            
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 1 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 1 hatasƒ±: {e}")
    
    def karbotu_step_2_fbtot_lt_110(self):
        """Adƒ±m 2: Fbtot < 1.10 ve Ask Sell pahalƒ±lƒ±k > -0.10"""
        try:
            print("[KARBOTU] üìã Adƒ±m 2: Fbtot < 1.10 kontrol√º...")
            self.log_message("üìã Adƒ±m 2: Fbtot < 1.10 ve Ask Sell pahalƒ±lƒ±k > -0.10")
            
            # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
            self.update_idletasks()
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]  # Fbtot kolonu
                ask_sell_pahalilik_str = values[8]  # Ask Sell Pahalƒ±lƒ±k kolonu
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            # $ i≈üaretini kaldƒ±r ve float'a √ßevir
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot < 1.10 ve Ask Sell pahalƒ±lƒ±k > -0.10
                    if fbtot < 1.10 and ask_sell_pahalilik > -0.10:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 2: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 2: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell Pahalƒ±lƒ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Ask Sell onay penceresi a√ß
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "Adƒ±m 2")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 2: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 2: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 3'e ge√ß
                self.karbotu_current_step = 3
                self.karbotu_step_3_fbtot_111_145_low()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 2 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 2 hatasƒ±: {e}")
    
    def karbotu_step_3_fbtot_111_145_low(self):
        """Adƒ±m 3: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k -0.05 ile +0.04 arasƒ±"""
        try:
            print("[KARBOTU] üìã Adƒ±m 3: Fbtot 1.11-1.45 kontrol√º...")
            self.log_message("üìã Adƒ±m 3: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k -0.05 ile +0.04 arasƒ±")
            
            # Lot y√ºzdesi: %25
            lot_percentage = 25
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k -0.05 ile +0.04 arasƒ±
                    if 1.11 <= fbtot <= 1.45 and -0.05 <= ask_sell_pahalilik <= 0.04:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 3: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 3: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell Pahalƒ±lƒ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %25 lot ile Ask Sell onay penceresi a√ß
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 25, "Adƒ±m 3")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 3: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 3: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 4'e ge√ß
                self.karbotu_current_step = 4
                self.karbotu_step_4_fbtot_111_145_high()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 3 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 3 hatasƒ±: {e}")
    
    def karbotu_step_4_fbtot_111_145_high(self):
        """Adƒ±m 4: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k > +0.05"""
        try:
            print("[KARBOTU] üìã Adƒ±m 4: Fbtot 1.11-1.45 y√ºksek kontrol√º...")
            self.log_message("üìã Adƒ±m 4: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k > +0.05")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k > +0.05
                    if 1.11 <= fbtot <= 1.45 and ask_sell_pahalilik > 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 4: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 4: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell Pahalƒ±lƒ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Ask Sell onay penceresi a√ß
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "Adƒ±m 4")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 4: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 4: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 5'e ge√ß
                self.karbotu_current_step = 5
                self.karbotu_step_5_fbtot_146_185_low()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 4 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 4 hatasƒ±: {e}")
    
    def karbotu_step_5_fbtot_146_185_low(self):
        """Adƒ±m 5: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k +0.05 ile +0.10 arasƒ±"""
        try:
            print("[KARBOTU] üìã Adƒ±m 5: Fbtot 1.46-1.85 kontrol√º...")
            self.log_message("üìã Adƒ±m 5: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k +0.05 ile +0.10 arasƒ±")
            
            # Lot y√ºzdesi: %25
            lot_percentage = 25
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k +0.05 ile +0.10 arasƒ±
                    if 1.46 <= fbtot <= 1.85 and 0.05 <= ask_sell_pahalilik <= 0.10:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 5: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 5: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell Pahalƒ±lƒ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %25 lot ile Ask Sell onay penceresi a√ß
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 25, "Adƒ±m 5")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 5: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 5: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 6'ya ge√ß
                self.karbotu_current_step = 6
                self.karbotu_step_6_fbtot_146_185_high()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 5 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 5 hatasƒ±: {e}")
    
    def karbotu_step_6_fbtot_146_185_high(self):
        """Adƒ±m 6: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k > +0.10"""
        try:
            print("[KARBOTU] üìã Adƒ±m 6: Fbtot 1.46-1.85 y√ºksek kontrol√º...")
            self.log_message("üìã Adƒ±m 6: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k > +0.10")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k > +0.10
                    if 1.46 <= fbtot <= 1.85 and ask_sell_pahalilik > 0.10:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 6: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 6: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell Pahalƒ±lƒ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Ask Sell onay penceresi a√ß
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "Adƒ±m 6")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 6: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 6: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 7'ye ge√ß
                self.karbotu_current_step = 7
                self.karbotu_step_7_fbtot_186_210()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 6 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 6 hatasƒ±: {e}")
    
    def karbotu_step_7_fbtot_186_210(self):
        """Adƒ±m 7: Fbtot 1.86-2.10 ve Ask Sell pahalƒ±lƒ±k > +0.20"""
        try:
            print("[KARBOTU] üìã Adƒ±m 7: Fbtot 1.86-2.10 kontrol√º...")
            self.log_message("üìã Adƒ±m 7: Fbtot 1.86-2.10 ve Ask Sell pahalƒ±lƒ±k > +0.20")
            
            # Lot y√ºzdesi: %25
            lot_percentage = 25
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.86-2.10 ve Ask Sell pahalƒ±lƒ±k > +0.20
                    if 1.86 <= fbtot <= 2.10 and ask_sell_pahalilik > 0.20:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 7: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 7: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, Fbtot={pos['fbtot']:.2f}, Ask Sell Pahalƒ±lƒ±k=${pos['ask_sell_pahalilik']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %25 lot ile Ask Sell onay penceresi a√ß
                self.karbotu_select_positions_and_confirm(filtered_positions, "Ask Sell", 25, "Adƒ±m 7")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 7: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 7: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 8'e ge√ß - Take Profit Shorts a√ß
                self.karbotu_current_step = 8
                self.karbotu_step_8_open_take_profit_shorts()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 7 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 7 hatasƒ±: {e}")
    
    def karbotu_step_8_open_take_profit_shorts(self):
        """Adƒ±m 8: Take Profit Longs kapat ve Take Profit Shorts a√ß"""
        try:
            print("[KARBOTU] üìã Adƒ±m 8: Take Profit Shorts penceresi a√ßƒ±lƒ±yor...")
            self.log_message("üìã Adƒ±m 8: Take Profit Shorts penceresi a√ßƒ±lƒ±yor...")
            
            # Take Profit Longs penceresini kapat
            if hasattr(self, 'take_profit_longs_panel') and self.take_profit_longs_panel:
                self.take_profit_longs_panel.win.destroy()
            
            # Take Profit Shorts penceresini a√ß
            from .take_profit_panel import TakeProfitPanel
            self.take_profit_shorts_panel = TakeProfitPanel(self, "shorts")
            
            # Gort kontrol√º yap (Take Profit Shorts i√ßin)
            self.karbotu_gort_check_take_profit_shorts()
            
            # Adƒ±m 9'a ge√ß
            self.karbotu_current_step = 9
            self.karbotu_step_9_sfstot_170_high()
            
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 8 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 8 hatasƒ±: {e}")
    
    def karbotu_step_9_sfstot_170_high(self):
        """Adƒ±m 9: SFStot > 1.70 ve Bid Buy ucuzluk < +0.10"""
        try:
            print("[KARBOTU] üìã Adƒ±m 9: SFStot > 1.70 kontrol√º...")
            self.log_message("üìã Adƒ±m 9: SFStot > 1.70 ve Bid Buy ucuzluk < +0.10")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]  # SFStot kolonu
                bid_buy_ucuzluk_str = values[8]  # Bid Buy Ucuzluk kolonu
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot > 1.70 ve Bid Buy ucuzluk < +0.10
                    if sfstot > 1.70 and bid_buy_ucuzluk < 0.10:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 9: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 9: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Bid Buy onay penceresi a√ß
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "Adƒ±m 9")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 9: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 9: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 10'a ge√ß
                self.karbotu_current_step = 10
                self.karbotu_step_10_sfstot_140_169_low()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 9 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 9 hatasƒ±: {e}")
    
    def karbotu_step_10_sfstot_140_169_low(self):
        """Adƒ±m 10: SFStot 1.40-1.69 ve Bid Buy ucuzluk +0.05 ile -0.04 arasƒ±"""
        try:
            print("[KARBOTU] üìã Adƒ±m 10: SFStot 1.40-1.69 kontrol√º...")
            self.log_message("üìã Adƒ±m 10: SFStot 1.40-1.69 ve Bid Buy ucuzluk +0.05 ile -0.04 arasƒ±")
            
            # Lot y√ºzdesi: %25
            lot_percentage = 25
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot 1.40-1.69 ve Bid Buy ucuzluk +0.05 ile -0.04 arasƒ±
                    if 1.40 <= sfstot <= 1.69 and -0.04 <= bid_buy_ucuzluk <= 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 10: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 10: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %25 lot ile Bid Buy onay penceresi a√ß
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 25, "Adƒ±m 10")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 10: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 10: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 11'e ge√ß
                self.karbotu_current_step = 11
                self.karbotu_step_11_sfstot_140_169_high()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 10 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 10 hatasƒ±: {e}")
    
    def karbotu_select_shorts_positions_and_confirm(self, positions, order_type, lot_percentage, step_name):
        """Shorts pozisyonlarƒ± se√ß ve onay penceresi a√ß"""
        try:
            # Pozisyonlarƒ± se√ß
            for pos in positions:
                self.take_profit_shorts_panel.tree.set(pos['item'], "select", "‚úì")
                
                # Avg cost'u g√ºvenli ≈üekilde parse et
                avg_cost_str = self.take_profit_shorts_panel.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_shorts_panel.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_shorts_panel.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Lot y√ºzdesini ayarla
            if lot_percentage == 25:
                self.take_profit_shorts_panel.set_lot_percentage(25)
            elif lot_percentage == 50:
                self.take_profit_shorts_panel.set_lot_percentage(50)
            
            # Onay penceresini a√ß
            self.karbotu_show_shorts_confirmation_window(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Shorts pozisyon se√ßimi hatasƒ±: {e}")
            self.log_message(f"‚ùå Shorts pozisyon se√ßimi hatasƒ±: {e}")
    
    def karbotu_send_shorts_orders_direct(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Shorts emirlerini direkt g√∂nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[KARBOTU SHORTS] üîÑ {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            self.log_message(f"üîÑ {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            
            # Pozisyon verilerini hazƒ±rla
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Negatif gelebilir
                abs_qty = abs(qty)
                
                # Lot hesapla
                calculated_lot = abs_qty * (lot_percentage / 100)
                
                # Lot yuvarlama
                if lot_percentage == 100:
                    lot_qty = int(calculated_lot)
                elif calculated_lot > 0:
                    if calculated_lot <= 0:
                        lot_qty = 0
                    elif calculated_lot <= 100:
                        lot_qty = 100
                    elif calculated_lot <= 200:
                        lot_qty = 200
                    elif calculated_lot <= 300:
                        lot_qty = 300
                    elif calculated_lot <= 400:
                        lot_qty = 400
                    elif calculated_lot <= 500:
                        lot_qty = 500
                    else:
                        lot_qty = int((calculated_lot + 99) // 100) * 100
                else:
                    lot_qty = 0
                
                # MAXALW limit kontrol√º (kural bazlƒ±)
                maxalw = self.get_maxalw_for_symbol(symbol)
                multiplier = getattr(self, 'rule_max_change_multiplier', 0.75)
                max_change_limit = maxalw * multiplier if maxalw > 0 else 0
                
                # G√ºn ba≈üƒ± pozisyon
                befday_qty = self.load_bef_position(symbol)
                
                # Mevcut pozisyon ve a√ßƒ±k emirler
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                
                # G√ºnl√ºk deƒüi≈üim (mutlak deƒüer)
                current_daily_change = abs(current_potential - befday_qty)
                
                # Yeni emir sonrasƒ± potansiyel deƒüi≈üim (Bid Buy = short pozisyonu azaltƒ±r)
                new_potential = current_potential + lot_qty  # Short pozisyonu azaltƒ±r (daha az negatif)
                potential_daily_change = abs(new_potential - befday_qty)
                
                # MAXALW limit kontrol√º (kural bazlƒ±)
                if potential_daily_change > max_change_limit:
                    print(f"[KARBOTU SHORTS] ‚ö†Ô∏è {symbol}: Max Change limiti a≈üƒ±lacak ({potential_daily_change:.0f} > {max_change_limit:.0f}), emir atlandƒ±")
                    self.log_message(f"‚ö†Ô∏è {symbol}: Max Change limiti a≈üƒ±lacak, emir atlandƒ±")
                    continue
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                if not market_data:
                    print(f"[KARBOTU SHORTS] ‚ùå {symbol} market_data bulunamadƒ±, atlandƒ±")
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                emir_fiyat = 0
                if order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                elif order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        continue
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri g√∂nder
            success_count = 0
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if abs(lot_qty) < 200:
                    continue
                
                # Controller kontrol√º (MAXALW limitleri dahil)
                if hasattr(self, 'controller_enabled') and self.controller_enabled:
                    order_side = "BUY"  # Short pozisyonu kapatmak i√ßin BUY
                    allowed, adjusted_qty, reason = self.controller_check_order(symbol, order_side, abs(lot_qty))
                    
                    if not allowed or adjusted_qty == 0:
                        print(f"[KARBOTU SHORTS] ‚ö†Ô∏è {symbol}: Controller engelledi - {reason}")
                        self.log_message(f"‚ö†Ô∏è {symbol}: Controller engelledi - {reason}")
                        continue
                    
                    lot_qty = adjusted_qty
                
                # Emir g√∂nder
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success or "new order sent" in str(success):
                            success_count += 1
                            print(f"[KARBOTU SHORTS] ‚úÖ {symbol}: Bid Buy {lot_qty} lot @ ${emir_fiyat:.2f}")
                    except Exception as e:
                        if "new order sent" in str(e).lower():
                            success_count += 1
                        else:
                            print(f"[KARBOTU SHORTS] ‚ùå {symbol}: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT",
                        hidden=True
                    )
                    if success:
                        success_count += 1
                        print(f"[KARBOTU SHORTS] ‚úÖ {symbol}: Bid Buy {lot_qty} lot @ ${emir_fiyat:.2f}")
            
            print(f"[KARBOTU SHORTS] ‚úÖ {step_name} tamamlandƒ±: {success_count} emir g√∂nderildi")
            self.log_message(f"‚úÖ {step_name} tamamlandƒ±: {success_count} emir g√∂nderildi")
            
            # Sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile - adƒ±mlar sƒ±ralƒ± ilerlesin)
            self.after(1000, self.karbotu_proceed_to_next_step)
            
        except Exception as e:
            print(f"[KARBOTU SHORTS] ‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            self.log_message(f"‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile)
            self.after(1000, self.karbotu_proceed_to_next_step)
    
    def karbotu_show_shorts_confirmation_window(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Shorts onay penceresi g√∂ster"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrol√º
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU SHORTS] ‚úÖ Allowed modu aktif - Onay penceresi atlanƒ±yor, emirler direkt g√∂nderiliyor")
                self.log_message(f"‚úÖ Allowed modu: {step_name} (Shorts) - Emirler otomatik g√∂nderiliyor")
                # Emirleri direkt g√∂nder (onay penceresi a√ßmadan)
                self.karbotu_send_shorts_orders_direct(positions, order_type, lot_percentage, step_name)
                return
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"KARBOTU - {step_name}")
            confirm_win.geometry("600x400")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            # Ba≈ülƒ±k frame - minimize butonu ile
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            # Sol taraf - ba≈ülƒ±k bilgileri
            title_left = ttk.Frame(title_frame)
            title_left.pack(side='left', fill='x', expand=True)
            
            ttk.Label(title_left, text=f"KARBOTU - {step_name}", font=('Arial', 14, 'bold')).pack(anchor='w')
            ttk.Label(title_left, text=f"{order_type} - %{lot_percentage} Lot", font=('Arial', 12)).pack(anchor='w')
            ttk.Label(title_left, text=f"{len(positions)} pozisyon se√ßildi", font=('Arial', 10)).pack(anchor='w')
            
            # Saƒü taraf - minimize butonu
            window_controls = ttk.Frame(title_frame)
            window_controls.pack(side='right')
            
            # Alta Al (Minimize) butonu
            minimize_btn = ttk.Button(window_controls, text="üóï Alta Al", width=10,
                                      command=lambda: confirm_win.iconify())
            minimize_btn.pack(side='left', padx=2)
            
            # Pozisyon listesi
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Treeview
            columns = ('Symbol', 'Qty', 'Lot', 'SFStot', 'Bid Buy Ucuzluk', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=10)
            
            # Kolon geni≈ülikleri
            col_widths = {'Symbol': 80, 'Qty': 60, 'Lot': 60, 'SFStot': 60, 'Bid Buy Ucuzluk': 100, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            # Scrollbar
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # ‚úÖ Fƒ∞YAT VE LOT DEPOSU - pencereye √∂zel
            order_data = {}  # {symbol: {'price': emir_fiyat, 'lot': lot_qty}}
            
            # Pozisyonlarƒ± ekle
            for pos in positions:
                # Pozisyon verilerini al
                item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                qty = float(item_values[2])  # Negatif gelebilir (-276 gibi)
                
                # Short pozisyonlar i√ßin ABS deƒüer ile hesapla
                abs_qty = abs(qty)  # -276 -> 276
                calculated_lot = abs_qty * (lot_percentage / 100)  # 276 * 0.75 = 207
                
                # %100 lot i√ßin yuvarlama YAPILMAZ - tam lot miktarƒ± kullanƒ±lƒ±r
                if lot_percentage == 100:
                    lot_qty = int(calculated_lot)  # 276 (pozitif)
                # Lot yuvarlama (%50 ve %25 i√ßin) - pozitif deƒüer ile yuvarlama yap
                elif calculated_lot > 0:
                    # Pozitif sayƒ±lar i√ßin normal yuvarlama
                    if calculated_lot <= 0:
                        lot_qty = 0
                    elif calculated_lot <= 100:
                        lot_qty = 100
                    elif calculated_lot <= 200:
                        lot_qty = 200
                    elif calculated_lot <= 300:
                        lot_qty = 300
                    elif calculated_lot <= 400:
                        lot_qty = 400
                    elif calculated_lot <= 500:
                        lot_qty = 500
                    elif calculated_lot <= 600:
                        lot_qty = 600
                    elif calculated_lot <= 700:
                        lot_qty = 700
                    elif calculated_lot <= 800:
                        lot_qty = 800
                    elif calculated_lot <= 900:
                        lot_qty = 900
                    elif calculated_lot <= 1000:
                        lot_qty = 1000
                    else:
                        lot_qty = int((calculated_lot + 99) // 100) * 100
                else:
                    lot_qty = 0
                
                # Lot her zaman pozitif olmalƒ± (BUY emri i√ßin short pozisyonu kapatmak i√ßin)
                # qty negatif olsa bile (short pozisyon), lot pozitif hesaplanƒ±r
                
                # Emir fiyatƒ±nƒ± hesapla (emir tipine g√∂re)
                symbol = pos['symbol']
                emir_fiyat = 0
                
                # JFIN ile BIREBIR aynƒ± mantƒ±k - Longs ile BIREBIR AYNI
                print(f"[KARBOTU SHORTS] üîç {symbol} JFIN mantƒ±ƒüƒ± ile fiyat hesaplanƒ±yor...")
                
                # JFIN'in calculate_order_price metodunu kopyala - AYNI MANTIK
                market_data = None
                
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        emir_fiyat = 0
                        print(f"[KARBOTU SHORTS] ‚ùå {symbol} market_data bo≈ü - JFIN gibi N/A d√∂nd√ºr√ºl√ºyor")
                        continue
                else:
                    emir_fiyat = 0
                    print(f"[KARBOTU SHORTS] ‚ùå {symbol} Hammer yok - JFIN gibi N/A d√∂nd√ºr√ºl√ºyor")
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                print(f"[KARBOTU SHORTS DEBUG] üìä {symbol} JFIN market_data: bid=${bid:.2f}, ask=${ask:.2f}, last=${last:.2f}")
                
                # JFIN'in tam mantƒ±ƒüƒ±nƒ± kopyala
                if order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                        print(f"[KARBOTU SHORTS] ‚úÖ {symbol} Bid Buy (JFIN): bid=${bid:.2f} + spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU SHORTS] ‚ùå {symbol} Bid Buy: bid/ask deƒüerleri ge√ßersiz")
                elif order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                        print(f"[KARBOTU SHORTS] ‚úÖ {symbol} Ask Sell (JFIN): ask=${ask:.2f} - spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU SHORTS] ‚ùå {symbol} Ask Sell: bid/ask deƒüerleri ge√ßersiz")
                else:
                    # Bilinmeyen emir tipi i√ßin Bid Buy form√ºl√º kullan (shorts i√ßin)
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                        print(f"[KARBOTU SHORTS] ‚úÖ {symbol} {order_type} (JFIN default): bid=${bid:.2f} + spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU SHORTS] ‚ùå {symbol} {order_type}: bid/ask deƒüerleri ge√ßersiz")
                
                pos_tree.insert('', 'end', values=(
                    pos['symbol'],
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['sfstot']:.2f}",
                    f"${pos['bid_buy_ucuzluk']:.4f}",
                    f"${emir_fiyat:.2f}"
                ))
                
                # ‚úÖ Fƒ∞YAT VE LOT DEPOSAYA KAYDET
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
                    print(f"[KARBOTU SHORTS] ‚úÖ {symbol} depoya kaydedildi: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
                else:
                    print(f"[KARBOTU SHORTS] ‚ö†Ô∏è {symbol} ge√ßersiz: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
            
            # Butonlar
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                """Onay verildi - Emirleri g√∂nder - DEPODAN Fƒ∞YATLARI KULLAN"""
                try:
                    print(f"[KARBOTU] üîÑ {step_name} emirleri g√∂nderiliyor...")
                    self.log_message(f"üîÑ {step_name} emirleri g√∂nderiliyor...")
                    
                    # ‚úÖ DEPODAN Fƒ∞YATLARI KULLAN - Market data √ßekme YOK
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        # ‚úÖ Minimum 200 lot kontrol√º - 200'den azsa skip et
                        if abs(lot_qty) < 200:
                            print(f"[KARBOTU] ‚ö†Ô∏è {symbol}: lot={lot_qty} < 200, atlandƒ±")
                            continue
                        
                        print(f"[KARBOTU] üì§ {symbol}: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
                        
                        # Emir g√∂nder
                        if self.mode_manager.is_hammer_mode():
                            # Hammer Pro - Symbol d√∂n√º≈ü√ºm√º
                            hammer_symbol = symbol.replace(" PR", "-")
                            
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="BUY",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                
                                if success or "new order sent" in str(success):
                                    print(f"[KARBOTU] ‚úÖ {symbol} ‚Üí {hammer_symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f}")
                                else:
                                    print(f"[KARBOTU] ‚ùå {symbol} ‚Üí {hammer_symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f}")
                            except Exception as e:
                                if "new order sent" in str(e).lower():
                                    print(f"[KARBOTU] ‚úÖ {symbol} ‚Üí {hammer_symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f} (new order sent)")
                                else:
                                    print(f"[KARBOTU] ‚ùå {symbol} ‚Üí {hammer_symbol}: {e}")
                        else:
                            # IBKR
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="BUY",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT",
                                hidden=True
                            )
                            
                            if success:
                                print(f"[KARBOTU] ‚úÖ {symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f}")
                            else:
                                print(f"[KARBOTU] ‚ùå {symbol}: BUY {lot_qty} lot @ ${emir_fiyat:.2f}")
                    
                    print(f"[KARBOTU] ‚úÖ {step_name} emirleri g√∂nderildi")
                    self.log_message(f"‚úÖ {step_name} emirleri g√∂nderildi")
                    
                    # Popup'larƒ± kapat
                    self.addnewpos_close_messagebox()
                    if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                        self.runall_auto_confirm_messagebox()
                    
                except Exception as e:
                    print(f"[KARBOTU] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    self.log_message(f"‚ùå Emir g√∂nderme hatasƒ±: {e}")
                
                confirm_win.destroy()
                # Sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile - adƒ±mlar sƒ±ralƒ± ilerlesin)
                self.after(1000, self.karbotu_proceed_to_next_step)
            
            def on_cancel():
                """ƒ∞ptal edildi"""
                print(f"[KARBOTU] ‚ùå {step_name} iptal edildi")
                self.log_message(f"‚ùå {step_name} iptal edildi")
                confirm_win.destroy()
                # Sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile - adƒ±mlar sƒ±ralƒ± ilerlesin)
                self.after(1000, self.karbotu_proceed_to_next_step)
            
            def save_to_trades_csv():
                """Se√ßili emirleri trades.csv formatƒ±nda kaydet - PENCERE'DEKƒ∞ Fƒ∞YATLAR kullan"""
                try:
                    print(f"[KARBOTU CSV SHORTS] üîÑ trades.csv'ye kaydediliyor...")
                    self.log_message(f"üîÑ trades.csv'ye kaydediliyor...")
                    
                    # CSV satƒ±rlarƒ±
                    csv_rows = []
                    
                    # PENCERE'DEKƒ∞ tablodan verileri al (zaten hesaplanmƒ±≈ü fiyatlar var)
                    for item in pos_tree.get_children():
                        values = pos_tree.item(item)['values']
                        symbol = values[0]
                        qty = float(values[1])
                        lot_qty = float(values[2])
                        
                        # Emir fiyatƒ±nƒ± PENCERE'DEKƒ∞ DEƒûERDEN al (zaten hesaplanmƒ±≈ü)
                        emir_fiyat_str = values[5]  # "Emir Fiyat" kolonu
                        try:
                            # $ i≈üaretini ve format karakterlerini temizle
                            emir_fiyat = float(str(emir_fiyat_str).replace('$', '').replace(',', '').strip())
                            print(f"[KARBOTU CSV SHORTS] ‚úÖ {symbol}: Emir fiyatƒ± pencereden alƒ±ndƒ±: ${emir_fiyat:.2f}")
                        except (ValueError, TypeError, IndexError):
                            print(f"[KARBOTU CSV SHORTS] ‚ùå {symbol}: Emir fiyatƒ± okunamadƒ±: {emir_fiyat_str}")
                            emir_fiyat = 0
                            continue
                        
                        # Lot ve fiyat ZATEN PENCREDEN ALINDI - market data √ßekmeye GEREK YOK!
                        # Minimum lot kontrol√º
                        if abs(lot_qty) < 200:
                            continue
                        
                        # CSV'ye kaydet (fiyat ve lot zaten hazƒ±r)
                        if emir_fiyat > 0:
                            # CSV formatƒ± (orijinal format)
                            csv_row = [
                                'BUY',                     # Action
                                int(lot_qty),             # Quantity
                                symbol,                    # Symbol
                                'STK',                    # SecType
                                'SMART/AMEX',              # Exchange
                                'USD',                    # Currency
                                'DAY',                    # TimeInForce
                                'LMT',                    # OrderType
                                f"{emir_fiyat:.2f}",      # LmtPrice
                                'Basket',                 # BasketTag
                                'U21016730',              # Account
                                'Basket',                 # OrderRef
                                'TRUE',                   # Hidden
                                'TRUE'                    # OutsideRth
                            ]
                            
                            csv_rows.append(csv_row)
                            print(f"[KARBOTU CSV] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    if csv_rows:
                        # CSV dosyasƒ±na kaydet
                        import csv
                        
                        csv_filename = 'trades.csv'
                        
                        # Dosyayƒ± sƒ±fƒ±rdan yaz (write mode)
                        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                            writer = csv.writer(csvfile)
                            
                            # Ba≈ülƒ±k satƒ±rƒ± (orijinal format)
                            writer.writerow(['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 'OrderRef', 'Hidden', 'OutsideRth'])
                            
                            # Emir satƒ±rlarƒ±
                            writer.writerows(csv_rows)
                        
                        print(f"[KARBOTU CSV] ‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        self.log_message(f"‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                    else:
                        messagebox.showwarning("Uyarƒ±", "Kaydedilecek ge√ßerli emir bulunamadƒ±!")
                        
                except Exception as e:
                    print(f"[KARBOTU CSV] ‚ùå Kaydetme hatasƒ±: {e}")
                    self.log_message(f"‚ùå Kaydetme hatasƒ±: {e}")
                    messagebox.showerror("Hata", f"trades.csv kaydetme hatasƒ±: {e}")
            
            ttk.Button(button_frame, text="Emirleri G√∂nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Shorts onay penceresi hatasƒ±: {e}")
            self.log_message(f"‚ùå Shorts onay penceresi hatasƒ±: {e}")
    
    def karbotu_step_11_sfstot_140_169_high(self):
        """Adƒ±m 11: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05"""
        try:
            print("[KARBOTU] üìã Adƒ±m 11: SFStot 1.40-1.69 y√ºksek kontrol√º...")
            self.log_message("üìã Adƒ±m 11: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05
                    if 1.40 <= sfstot <= 1.69 and bid_buy_ucuzluk < -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 11: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 11: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Bid Buy onay penceresi a√ß
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "Adƒ±m 11")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 11: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 11: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 12'ye ge√ß
                self.karbotu_current_step = 12
                self.karbotu_step_12_sfstot_110_139_low()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 11 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 11 hatasƒ±: {e}")
    
    def karbotu_step_12_sfstot_110_139_low(self):
        """Adƒ±m 12: SFStot 1.10-1.39 ve Bid Buy ucuzluk +0.05 ile -0.04 arasƒ±"""
        try:
            print("[KARBOTU] üìã Adƒ±m 12: SFStot 1.10-1.39 kontrol√º...")
            self.log_message("üìã Adƒ±m 12: SFStot 1.10-1.39 ve Bid Buy ucuzluk +0.05 ile -0.04 arasƒ±")
            
            # Lot y√ºzdesi: %25
            lot_percentage = 25
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot 1.10-1.39 ve Bid Buy ucuzluk +0.05 ile -0.04 arasƒ±
                    if 1.10 <= sfstot <= 1.39 and -0.04 <= bid_buy_ucuzluk <= 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 12: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 12: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %25 lot ile Bid Buy onay penceresi a√ß
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 25, "Adƒ±m 12")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 12: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 12: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 13'e ge√ß
                self.karbotu_current_step = 13
                self.karbotu_step_13_sfstot_110_139_high()
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 12 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 12 hatasƒ±: {e}")
    
    def karbotu_step_13_sfstot_110_139_high(self):
        """Adƒ±m 13: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05"""
        try:
            print("[KARBOTU] üìã Adƒ±m 13: SFStot 1.10-1.39 y√ºksek kontrol√º...")
            self.log_message("üìã Adƒ±m 13: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05
                    if 1.10 <= sfstot <= 1.39 and bid_buy_ucuzluk < -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU] ‚úÖ Adƒ±m 13: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 13: {len(filtered_positions)} pozisyon bulundu")
                
                # Debug: Bulunan pozisyonlarƒ± listele
                for pos in filtered_positions:
                    # Lot hesaplama debug'u
                    item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                    qty = float(item_values[2])
                    calculated_lot = qty * (lot_percentage / 100)
                    
                    # Lot yuvarlama mantƒ±ƒüƒ± (debug i√ßin - negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                    
                    print(f"[KARBOTU DEBUG] ‚úÖ {pos['symbol']}: Qty={qty:.0f} ‚Üí %{lot_percentage}={calculated_lot:.1f} ‚Üí {lot_qty} lot, SFStot={pos['sfstot']:.2f}, Bid Buy Ucuzluk=${pos['bid_buy_ucuzluk']:.4f}")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Bid Buy onay penceresi a√ß
                self.karbotu_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "Adƒ±m 13")
            else:
                print("[KARBOTU] ‚ö†Ô∏è Adƒ±m 13: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 13: Ko≈üula uygun pozisyon bulunamadƒ±")
                # T√ºm adƒ±mlar tamamlandƒ±
                print("[KARBOTU] üéØ T√ºm adƒ±mlar tamamlandƒ±!")
                self.log_message("üéØ KARBOTU otomasyonu tamamlandƒ±!")
                self.karbotu_running = False
                
                # RUNALL'dan √ßaƒürƒ±ldƒ±ysa ADDNEWPOS kontrol√º yap (SADECE Bƒ∞R KEZ)
                if hasattr(self, 'runall_waiting_for_karbotu') and self.runall_waiting_for_karbotu:
                    if not hasattr(self, 'runall_addnewpos_triggered') or not self.runall_addnewpos_triggered:
                        self.runall_waiting_for_karbotu = False
                        self.runall_addnewpos_triggered = True  # ƒ∞≈üaretle ki tekrar tetiklenmesin
                        self.after(2000, self.runall_check_karbotu_and_addnewpos)  # 2 saniye sonra kontrol et
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Adƒ±m 13 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 13 hatasƒ±: {e}")
            # Hata olsa bile otomasyonu sonlandƒ±r
            self.karbotu_running = False
    
    # ==================== REDUCEMORE OTOMASYONU ====================
    
    def start_reducemore_automation(self):
        """REDUCEMORE otomasyonunu ba≈ülat"""
        try:
            print("[REDUCEMORE] üìâ REDUCEMORE otomasyonu ba≈ülatƒ±lƒ±yor...")
            self.log_message("üìâ REDUCEMORE otomasyonu ba≈ülatƒ±lƒ±yor...")
            
            # REDUCEMORE adƒ±mlarƒ±nƒ± ba≈ülat
            self.reducemore_current_step = 1
            self.reducemore_total_steps = 13
            self.reducemore_running = True
            
            # ƒ∞lk adƒ±m: Take Profit Longs penceresini a√ß
            self.reduce_more_step_1_open_take_profit_longs()
            
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Otomasyon ba≈ülatma hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE ba≈ülatma hatasƒ±: {e}")
            messagebox.showerror("Hata", f"REDUCEMORE ba≈ülatƒ±lamadƒ±: {e}")
    
    def karbotu_gort_check_take_profit_longs(self):
        """KARBOTU: Take Profit Longs i√ßin Gort kontrol√º - Gort > -1 ve Ask Sell pahalƒ±lƒ±k > -0.05"""
        try:
            print("[KARBOTU GORT] üìã Take Profit Longs i√ßin Gort kontrol√º yapƒ±lƒ±yor...")
            self.log_message("üìã KARBOTU Gort kontrol√º (Longs): Gort > -1 ve Ask Sell pahalƒ±lƒ±k > -0.05")
            
            if not hasattr(self, 'take_profit_longs_panel') or not self.take_profit_longs_panel:
                print("[KARBOTU GORT] ‚ö†Ô∏è Take Profit Longs paneli bulunamadƒ±")
                return
            
            # Lot y√ºzdesi: %10 (ama min 200 lot)
            lot_percentage = 10
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel.tree.get_children():
                values = self.take_profit_longs_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                gort_str = values[6]  # Gort kolonu (indeks 6)
                ask_sell_pahalilik_str = values[9]  # Ask Sell Pahalƒ±lƒ±k kolonu (indeks 9)
                
                try:
                    # Gort'u g√ºvenli ≈üekilde parse et
                    gort = 0
                    if gort_str != 'N/A' and gort_str:
                        try:
                            gort = float(gort_str)
                        except (ValueError, TypeError):
                            gort = 0
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Gort tam 0.0 ise exclude et (N/A deƒüeri)
                    if gort == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ko≈üul: Gort > -1 ve Ask Sell pahalƒ±lƒ±k > -0.05
                    if gort > -1 and ask_sell_pahalilik > -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'gort': gort,
                            'ask_sell_pahalilik': ask_sell_pahalilik,
                            'qty': qty
                        })
                        
                except (ValueError, TypeError) as e:
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU GORT] ‚úÖ {len(filtered_positions)} pozisyon bulundu (Gort > -1 ve Ask Sell pahalƒ±lƒ±k > -0.05)")
                self.log_message(f"‚úÖ KARBOTU Gort kontrol√º: {len(filtered_positions)} pozisyon bulundu")
                
                # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
                self.update_idletasks()
                
                # Pozisyonlarƒ± se√ß ve √∂zel lot hesaplama ile emir g√∂nder (non-blocking)
                self.after(100, lambda: self.karbotu_gort_select_and_send_longs(filtered_positions, "Ask Sell", lot_percentage, "KARBOTU Gort Kontrol√º (Longs)"))
            else:
                print("[KARBOTU GORT] ‚ö†Ô∏è Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è KARBOTU Gort kontrol√º: Ko≈üula uygun pozisyon bulunamadƒ±")
                
                # Pozisyon bulunamadƒ±ysa direkt adƒ±m 2'ye ge√ß (non-blocking)
                self.after(200, self.karbotu_step_2_fbtot_lt_110)
                
        except Exception as e:
            print(f"[KARBOTU GORT] ‚ùå Hata: {e}")
            self.log_message(f"‚ùå KARBOTU Gort kontrol√º hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def karbotu_gort_check_take_profit_shorts(self):
        """KARBOTU: Take Profit Shorts i√ßin Gort kontrol√º - Gort < 1 ve Bid Buy ucuzluk < +0.05"""
        try:
            print("[KARBOTU GORT] üìã Take Profit Shorts i√ßin Gort kontrol√º yapƒ±lƒ±yor...")
            self.log_message("üìã KARBOTU Gort kontrol√º (Shorts): Gort < 1 ve Bid Buy ucuzluk < +0.05")
            
            if not hasattr(self, 'take_profit_shorts_panel') or not self.take_profit_shorts_panel:
                print("[KARBOTU GORT] ‚ö†Ô∏è Take Profit Shorts paneli bulunamadƒ±")
                return
            
            # Lot y√ºzdesi: %10 (ama min 200 lot)
            lot_percentage = 10
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel.tree.get_children():
                values = self.take_profit_shorts_panel.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                gort_str = values[6]  # Gort kolonu (indeks 6)
                bid_buy_ucuzluk_str = values[9]  # Bid Buy Ucuzluk kolonu (indeks 9)
                
                try:
                    # Gort'u g√ºvenli ≈üekilde parse et
                    gort = 0
                    if gort_str != 'N/A' and gort_str:
                        try:
                            gort = float(gort_str)
                        except (ValueError, TypeError):
                            gort = 0
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Gort tam 0.0 ise exclude et (N/A deƒüeri)
                    if gort == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu (negatif deƒüer)
                    if abs(qty) < 100:
                        continue
                    
                    # Ko≈üul: Gort < 1 ve Bid Buy ucuzluk < +0.05
                    if gort < 1 and bid_buy_ucuzluk < 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'gort': gort,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk,
                            'qty': qty
                        })
                        
                except (ValueError, TypeError) as e:
                    continue
            
            if filtered_positions:
                print(f"[KARBOTU GORT] ‚úÖ {len(filtered_positions)} pozisyon bulundu (Gort < 1 ve Bid Buy ucuzluk < +0.05)")
                self.log_message(f"‚úÖ KARBOTU Gort kontrol√º: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve √∂zel lot hesaplama ile emir g√∂nder
                self.karbotu_gort_select_and_send_shorts(filtered_positions, "Bid Buy", lot_percentage, "KARBOTU Gort Kontrol√º (Shorts)")
            else:
                print("[KARBOTU GORT] ‚ö†Ô∏è Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è KARBOTU Gort kontrol√º: Ko≈üula uygun pozisyon bulunamadƒ±")
                
        except Exception as e:
            print(f"[KARBOTU GORT] ‚ùå Hata: {e}")
            self.log_message(f"‚ùå KARBOTU Gort kontrol√º hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reduce_more_step_1_open_take_profit_longs(self):
        """Adƒ±m 1: Take Profit Longs penceresini a√ß"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 1: Take Profit Longs penceresi a√ßƒ±lƒ±yor...")
            self.log_message("üìã Adƒ±m 1: Take Profit Longs penceresi a√ßƒ±lƒ±yor...")
            
            # Take Profit Longs penceresini a√ß
            from .take_profit_panel import TakeProfitPanel
            self.take_profit_longs_panel_reducemore = TakeProfitPanel(self, "longs")
            
            # GUI'yi g√ºncelle (pencere a√ßƒ±ldƒ±ktan sonra)
            self.update_idletasks()
            
            # Gort kontrol√º yap (Take Profit Longs i√ßin) - non-blocking
            self.after(200, self.reducemore_gort_check_take_profit_longs)
            
            # Adƒ±m 2'ye ge√ß (Gort kontrol√º bitince)
            self.reducemore_current_step = 2
            # Gort kontrol√º bitince adƒ±m 2'ye ge√ßilecek (reducemore_gort_check_take_profit_longs i√ßinde)
            
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 1 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 1 hatasƒ±: {e}")
    
    def reduce_more_step_2_fbtot_lt_110(self):
        """Adƒ±m 2: Fbtot < 1.10 ve Ask Sell pahalƒ±lƒ±k > -0.20"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 2: Fbtot < 1.10 kontrol√º...")
            self.log_message("üìã Adƒ±m 2: Fbtot < 1.10 ve Ask Sell pahalƒ±lƒ±k > -0.20")
            
            # Lot y√ºzdesi: %100
            lot_percentage = 100
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]  # Fbtot kolonu
                ask_sell_pahalilik_str = values[8]  # Ask Sell Pahalƒ±lƒ±k kolonu
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            # $ i≈üaretini kaldƒ±r ve float'a √ßevir
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot < 1.10 ve Ask Sell pahalƒ±lƒ±k > -0.20
                    if fbtot < 1.10 and ask_sell_pahalilik > -0.20:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 2: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 2: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %100 lot ile Ask Sell onay penceresi a√ß
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 100, "Adƒ±m 2")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 2: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 2: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 3'e ge√ß
                self.reducemore_current_step = 3
                self.reduce_more_step_3_fbtot_111_145_low()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 2 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 2 hatasƒ±: {e}")
    
    def reduce_more_step_3_fbtot_111_145_low(self):
        """Adƒ±m 3: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k -0.08 ile +0.01 arasƒ±"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 3: Fbtot 1.11-1.45 kontrol√º...")
            self.log_message("üìã Adƒ±m 3: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k -0.08 ile +0.01 arasƒ±")
            
            # Lot y√ºzdesi: %75
            lot_percentage = 75
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k -0.08 ile +0.01 arasƒ±
                    if 1.11 <= fbtot <= 1.45 and -0.08 <= ask_sell_pahalilik <= 0.01:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 3: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 3: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %75 lot ile Ask Sell onay penceresi a√ß
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 75, "Adƒ±m 3")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 3: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 3: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 4'e ge√ß
                self.reducemore_current_step = 4
                self.reduce_more_step_4_fbtot_111_145_high()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 3 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 3 hatasƒ±: {e}")
    
    def reduce_more_step_4_fbtot_111_145_high(self):
        """Adƒ±m 4: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k > +0.01"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 4: Fbtot 1.11-1.45 y√ºksek kontrol√º...")
            self.log_message("üìã Adƒ±m 4: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k > +0.01")
            
            # Lot y√ºzdesi: %100
            lot_percentage = 100
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.11-1.45 ve Ask Sell pahalƒ±lƒ±k > +0.01
                    if 1.11 <= fbtot <= 1.45 and ask_sell_pahalilik > 0.01:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 4: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 4: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %100 lot ile Ask Sell onay penceresi a√ß
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 100, "Adƒ±m 4")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 4: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 4: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 5'e ge√ß
                self.reducemore_current_step = 5
                self.reduce_more_step_5_fbtot_146_185_low()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 4 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 4 hatasƒ±: {e}")
    
    def reduce_more_step_5_fbtot_146_185_low(self):
        """Adƒ±m 5: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k +0.01 ile +0.07 arasƒ±"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 5: Fbtot 1.46-1.85 kontrol√º...")
            self.log_message("üìã Adƒ±m 5: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k +0.01 ile +0.07 arasƒ±")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k +0.01 ile +0.07 arasƒ±
                    if 1.46 <= fbtot <= 1.85 and 0.01 <= ask_sell_pahalilik <= 0.07:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 5: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 5: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Ask Sell onay penceresi a√ß
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "Adƒ±m 5")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 5: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 5: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 6'ya ge√ß
                self.reducemore_current_step = 6
                self.reduce_more_step_6_fbtot_146_185_high()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 5 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 5 hatasƒ±: {e}")
    
    def reduce_more_step_6_fbtot_146_185_high(self):
        """Adƒ±m 6: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k > +0.07"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 6: Fbtot 1.46-1.85 y√ºksek kontrol√º...")
            self.log_message("üìã Adƒ±m 6: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k > +0.07")
            
            # Lot y√ºzdesi: %75
            lot_percentage = 75
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.46-1.85 ve Ask Sell pahalƒ±lƒ±k > +0.07
                    if 1.46 <= fbtot <= 1.85 and ask_sell_pahalilik > 0.07:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 6: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 6: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %75 lot ile Ask Sell onay penceresi a√ß
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 75, "Adƒ±m 6")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 6: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 6: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 7'ye ge√ß
                self.reducemore_current_step = 7
                self.reduce_more_step_7_fbtot_186_210()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 6 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 6 hatasƒ±: {e}")
    
    def reduce_more_step_7_fbtot_186_210(self):
        """Adƒ±m 7: Fbtot 1.86-2.10 ve Ask Sell pahalƒ±lƒ±k > +0.18"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 7: Fbtot 1.86-2.10 kontrol√º...")
            self.log_message("üìã Adƒ±m 7: Fbtot 1.86-2.10 ve Ask Sell pahalƒ±lƒ±k > +0.18")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                fbtot_str = values[5]
                ask_sell_pahalilik_str = values[8]
                
                try:
                    # Fbtot'u g√ºvenli ≈üekilde parse et
                    fbtot = 0
                    if fbtot_str != 'N/A' and fbtot_str:
                        try:
                            fbtot = float(fbtot_str)
                        except (ValueError, TypeError):
                            fbtot = 0
                    
                    # Fbtot tam 0.0 ise exclude et (N/A deƒüeri)
                    if fbtot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Ko≈üul: Fbtot 1.86-2.10 ve Ask Sell pahalƒ±lƒ±k > +0.18
                    if 1.86 <= fbtot <= 2.10 and ask_sell_pahalilik > 0.18:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'fbtot': fbtot,
                            'ask_sell_pahalilik': ask_sell_pahalilik
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 7: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 7: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Ask Sell onay penceresi a√ß
                self.reduce_more_select_positions_and_confirm(filtered_positions, "Ask Sell", 50, "Adƒ±m 7")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 7: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 7: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 8'e ge√ß - Take Profit Shorts a√ß
                self.reducemore_current_step = 8
                self.reduce_more_step_8_open_take_profit_shorts()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 7 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 7 hatasƒ±: {e}")
    
    def reduce_more_step_8_open_take_profit_shorts(self):
        """Adƒ±m 8: Take Profit Longs kapat ve Take Profit Shorts a√ß"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 8: Take Profit Shorts penceresi a√ßƒ±lƒ±yor...")
            self.log_message("üìã Adƒ±m 8: Take Profit Shorts penceresi a√ßƒ±lƒ±yor...")
            
            # Take Profit Longs penceresini kapat
            if hasattr(self, 'take_profit_longs_panel_reducemore') and self.take_profit_longs_panel_reducemore:
                self.take_profit_longs_panel_reducemore.win.destroy()
            
            # Take Profit Shorts penceresini a√ß
            from .take_profit_panel import TakeProfitPanel
            self.take_profit_shorts_panel_reducemore = TakeProfitPanel(self, "shorts")
            
            # Gort kontrol√º yap (Take Profit Shorts i√ßin)
            self.reducemore_gort_check_take_profit_shorts()
            
            # Adƒ±m 9'a ge√ß
            self.reducemore_current_step = 9
            self.reduce_more_step_9_sfstot_170_high()
            
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 8 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 8 hatasƒ±: {e}")
    
    def reduce_more_step_9_sfstot_170_high(self):
        """Adƒ±m 9: SFStot > 1.70 ve Bid Buy ucuzluk < +0.14"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 9: SFStot > 1.70 kontrol√º...")
            self.log_message("üìã Adƒ±m 9: SFStot > 1.70 ve Bid Buy ucuzluk < +0.14")
            
            # Lot y√ºzdesi: %100
            lot_percentage = 100
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]  # SFStot kolonu
                bid_buy_ucuzluk_str = values[8]  # Bid Buy Ucuzluk kolonu
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot > 1.70 ve Bid Buy ucuzluk < +0.14
                    if sfstot > 1.70 and bid_buy_ucuzluk < 0.14:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 9: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 9: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %100 lot ile Bid Buy onay penceresi a√ß
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 100, "Adƒ±m 9")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 9: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 9: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 10'a ge√ß
                self.reducemore_current_step = 10
                self.reduce_more_step_10_sfstot_140_169_low()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 9 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 9 hatasƒ±: {e}")
    
    def reduce_more_step_10_sfstot_140_169_low(self):
        """Adƒ±m 10: SFStot 1.40-1.69 ve Bid Buy ucuzluk -0.04 ile +0.05 arasƒ±"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 10: SFStot 1.40-1.69 kontrol√º...")
            self.log_message("üìã Adƒ±m 10: SFStot 1.40-1.69 ve Bid Buy ucuzluk -0.04 ile +0.05 arasƒ±")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot 1.40-1.69 ve Bid Buy ucuzluk -0.04 ile +0.05 arasƒ±
                    if 1.40 <= sfstot <= 1.69 and -0.04 <= bid_buy_ucuzluk <= 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 10: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 10: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Bid Buy onay penceresi a√ß
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "Adƒ±m 10")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 10: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 10: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 11'e ge√ß
                self.reducemore_current_step = 11
                self.reduce_more_step_11_sfstot_140_169_high()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 10 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 10 hatasƒ±: {e}")
    
    def reduce_more_step_11_sfstot_140_169_high(self):
        """Adƒ±m 11: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 11: SFStot 1.40-1.69 y√ºksek kontrol√º...")
            self.log_message("üìã Adƒ±m 11: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05")
            
            # Lot y√ºzdesi: %75
            lot_percentage = 75
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot 1.40-1.69 ve Bid Buy ucuzluk < -0.05
                    if 1.40 <= sfstot <= 1.69 and bid_buy_ucuzluk < -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 11: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 11: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %75 lot ile Bid Buy onay penceresi a√ß
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 75, "Adƒ±m 11")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 11: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 11: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 12'ye ge√ß
                self.reducemore_current_step = 12
                self.reduce_more_step_12_sfstot_110_139_low()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 11 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 11 hatasƒ±: {e}")
    
    def reduce_more_step_12_sfstot_110_139_low(self):
        """Adƒ±m 12: SFStot 1.10-1.39 ve Bid Buy ucuzluk -0.04 ile +0.05 arasƒ±"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 12: SFStot 1.10-1.39 kontrol√º...")
            self.log_message("üìã Adƒ±m 12: SFStot 1.10-1.39 ve Bid Buy ucuzluk -0.04 ile +0.05 arasƒ±")
            
            # Lot y√ºzdesi: %50
            lot_percentage = 50
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot 1.10-1.39 ve Bid Buy ucuzluk -0.04 ile +0.05 arasƒ±
                    if 1.10 <= sfstot <= 1.39 and -0.04 <= bid_buy_ucuzluk <= 0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 12: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 12: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %50 lot ile Bid Buy onay penceresi a√ß
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 50, "Adƒ±m 12")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 12: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 12: Ko≈üula uygun pozisyon bulunamadƒ±")
                # Adƒ±m 13'e ge√ß
                self.reducemore_current_step = 13
                self.reduce_more_step_13_sfstot_110_139_high()
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 12 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 12 hatasƒ±: {e}")
    
    def reduce_more_step_13_sfstot_110_139_high(self):
        """Adƒ±m 13: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05"""
        try:
            print("[REDUCEMORE] üìã Adƒ±m 13: SFStot 1.10-1.39 y√ºksek kontrol√º...")
            self.log_message("üìã Adƒ±m 13: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05")
            
            # Lot y√ºzdesi: %75
            lot_percentage = 75
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                sfstot_str = values[5]
                bid_buy_ucuzluk_str = values[8]
                
                try:
                    # SFStot'u g√ºvenli ≈üekilde parse et
                    sfstot = 0
                    if sfstot_str != 'N/A' and sfstot_str:
                        try:
                            sfstot = float(sfstot_str)
                        except (ValueError, TypeError):
                            sfstot = 0
                    
                    # SFStot tam 0.0 ise exclude et (N/A deƒüeri)
                    if sfstot == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Ko≈üul: SFStot 1.10-1.39 ve Bid Buy ucuzluk < -0.05
                    if 1.10 <= sfstot <= 1.39 and bid_buy_ucuzluk < -0.05:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'sfstot': sfstot,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk
                        })
                        
                except (ValueError, TypeError):
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE] ‚úÖ Adƒ±m 13: {len(filtered_positions)} pozisyon bulundu")
                self.log_message(f"‚úÖ Adƒ±m 13: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve %75 lot ile Bid Buy onay penceresi a√ß
                self.reduce_more_select_shorts_positions_and_confirm(filtered_positions, "Bid Buy", 75, "Adƒ±m 13")
            else:
                print("[REDUCEMORE] ‚ö†Ô∏è Adƒ±m 13: Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è Adƒ±m 13: Ko≈üula uygun pozisyon bulunamadƒ±")
                # T√ºm adƒ±mlar tamamlandƒ±
                print("[REDUCEMORE] üéØ T√ºm adƒ±mlar tamamlandƒ±!")
                self.log_message("üéØ REDUCEMORE otomasyonu tamamlandƒ±!")
                self.reducemore_running = False
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Adƒ±m 13 hatasƒ±: {e}")
            self.log_message(f"‚ùå Adƒ±m 13 hatasƒ±: {e}")
            # Hata olsa bile otomasyonu sonlandƒ±r
            self.reducemore_running = False
    
    def reducemore_gort_check_take_profit_longs(self):
        """REDUCEMORE: Take Profit Longs i√ßin Gort kontrol√º - Gort > -1 ve Ask Sell pahalƒ±lƒ±k > -0.08"""
        try:
            print("[REDUCEMORE GORT] üìã Take Profit Longs i√ßin Gort kontrol√º yapƒ±lƒ±yor...")
            self.log_message("üìã REDUCEMORE Gort kontrol√º (Longs): Gort > -1 ve Ask Sell pahalƒ±lƒ±k > -0.08")
            
            if not hasattr(self, 'take_profit_longs_panel_reducemore') or not self.take_profit_longs_panel_reducemore:
                print("[REDUCEMORE GORT] ‚ö†Ô∏è Take Profit Longs paneli bulunamadƒ±")
                return
            
            # Lot y√ºzdesi: %20 (ama min 200 lot)
            lot_percentage = 20
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_longs_panel_reducemore.tree.get_children():
                values = self.take_profit_longs_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                gort_str = values[6]  # Gort kolonu (indeks 6)
                ask_sell_pahalilik_str = values[9]  # Ask Sell Pahalƒ±lƒ±k kolonu (indeks 9)
                
                try:
                    # Gort'u g√ºvenli ≈üekilde parse et
                    gort = 0
                    if gort_str != 'N/A' and gort_str:
                        try:
                            gort = float(gort_str)
                        except (ValueError, TypeError):
                            gort = 0
                    
                    # Ask Sell pahalƒ±lƒ±k skorunu g√ºvenli ≈üekilde parse et
                    ask_sell_pahalilik = 0
                    if ask_sell_pahalilik_str != 'N/A' and ask_sell_pahalilik_str:
                        try:
                            clean_str = str(ask_sell_pahalilik_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                ask_sell_pahalilik = float(clean_str)
                        except (ValueError, TypeError):
                            ask_sell_pahalilik = 0
                    
                    # Gort tam 0.0 ise exclude et (N/A deƒüeri)
                    if gort == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu
                    if abs(qty) < 100:
                        continue
                    
                    # Ko≈üul: Gort > -1 ve Ask Sell pahalƒ±lƒ±k > -0.08
                    if gort > -1 and ask_sell_pahalilik > -0.08:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'gort': gort,
                            'ask_sell_pahalilik': ask_sell_pahalilik,
                            'qty': qty
                        })
                        
                except (ValueError, TypeError) as e:
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE GORT] ‚úÖ {len(filtered_positions)} pozisyon bulundu (Gort > -1 ve Ask Sell pahalƒ±lƒ±k > -0.08)")
                self.log_message(f"‚úÖ REDUCEMORE Gort kontrol√º: {len(filtered_positions)} pozisyon bulundu")
                
                # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
                self.update_idletasks()
                
                # Pozisyonlarƒ± se√ß ve √∂zel lot hesaplama ile emir g√∂nder (non-blocking)
                self.after(100, lambda: self.reducemore_gort_select_and_send_longs(filtered_positions, "Ask Sell", lot_percentage, "REDUCEMORE Gort Kontrol√º (Longs)"))
            else:
                print("[REDUCEMORE GORT] ‚ö†Ô∏è Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è REDUCEMORE Gort kontrol√º: Ko≈üula uygun pozisyon bulunamadƒ±")
                
                # Pozisyon bulunamadƒ±ysa direkt adƒ±m 2'ye ge√ß (non-blocking)
                self.after(200, self.reduce_more_step_2_fbtot_lt_110)
                
        except Exception as e:
            print(f"[REDUCEMORE GORT] ‚ùå Hata: {e}")
            self.log_message(f"‚ùå REDUCEMORE Gort kontrol√º hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reducemore_gort_check_take_profit_shorts(self):
        """REDUCEMORE: Take Profit Shorts i√ßin Gort kontrol√º - Gort < 1 ve Bid Buy ucuzluk < +0.08"""
        try:
            print("[REDUCEMORE GORT] üìã Take Profit Shorts i√ßin Gort kontrol√º yapƒ±lƒ±yor...")
            self.log_message("üìã REDUCEMORE Gort kontrol√º (Shorts): Gort < 1 ve Bid Buy ucuzluk < +0.08")
            
            if not hasattr(self, 'take_profit_shorts_panel_reducemore') or not self.take_profit_shorts_panel_reducemore:
                print("[REDUCEMORE GORT] ‚ö†Ô∏è Take Profit Shorts paneli bulunamadƒ±")
                return
            
            # Lot y√ºzdesi: %20 (ama min 200 lot)
            lot_percentage = 20
            
            # Pozisyonlarƒ± filtrele
            filtered_positions = []
            for item in self.take_profit_shorts_panel_reducemore.tree.get_children():
                values = self.take_profit_shorts_panel_reducemore.tree.item(item)['values']
                symbol = values[1] if values[0] == '' else values[0]
                gort_str = values[6]  # Gort kolonu (indeks 6)
                bid_buy_ucuzluk_str = values[9]  # Bid Buy Ucuzluk kolonu (indeks 9)
                
                try:
                    # Gort'u g√ºvenli ≈üekilde parse et
                    gort = 0
                    if gort_str != 'N/A' and gort_str:
                        try:
                            gort = float(gort_str)
                        except (ValueError, TypeError):
                            gort = 0
                    
                    # Bid Buy ucuzluk skorunu g√ºvenli ≈üekilde parse et
                    bid_buy_ucuzluk = 0
                    if bid_buy_ucuzluk_str != 'N/A' and bid_buy_ucuzluk_str:
                        try:
                            clean_str = str(bid_buy_ucuzluk_str).replace('$', '').replace(',', '').strip()
                            if clean_str and clean_str != 'nan':
                                bid_buy_ucuzluk = float(clean_str)
                        except (ValueError, TypeError):
                            bid_buy_ucuzluk = 0
                    
                    # Gort tam 0.0 ise exclude et (N/A deƒüeri)
                    if gort == 0.0:
                        continue
                    
                    # 100 lot altƒ± pozisyonlarƒ± g√∂z ardƒ± et
                    qty = float(values[2])  # Quantity kolonu (negatif deƒüer)
                    if abs(qty) < 100:
                        continue
                    
                    # Ko≈üul: Gort < 1 ve Bid Buy ucuzluk < +0.08
                    if gort < 1 and bid_buy_ucuzluk < 0.08:
                        filtered_positions.append({
                            'symbol': symbol,
                            'item': item,
                            'gort': gort,
                            'bid_buy_ucuzluk': bid_buy_ucuzluk,
                            'qty': qty
                        })
                        
                except (ValueError, TypeError) as e:
                    continue
            
            if filtered_positions:
                print(f"[REDUCEMORE GORT] ‚úÖ {len(filtered_positions)} pozisyon bulundu (Gort < 1 ve Bid Buy ucuzluk < +0.08)")
                self.log_message(f"‚úÖ REDUCEMORE Gort kontrol√º: {len(filtered_positions)} pozisyon bulundu")
                
                # Pozisyonlarƒ± se√ß ve √∂zel lot hesaplama ile emir g√∂nder
                self.reducemore_gort_select_and_send_shorts(filtered_positions, "Bid Buy", lot_percentage, "REDUCEMORE Gort Kontrol√º (Shorts)")
            else:
                print("[REDUCEMORE GORT] ‚ö†Ô∏è Ko≈üula uygun pozisyon bulunamadƒ±")
                self.log_message("‚ö†Ô∏è REDUCEMORE Gort kontrol√º: Ko≈üula uygun pozisyon bulunamadƒ±")
                
        except Exception as e:
            print(f"[REDUCEMORE GORT] ‚ùå Hata: {e}")
            self.log_message(f"‚ùå REDUCEMORE Gort kontrol√º hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reduce_more_select_positions_and_confirm(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE: Pozisyonlarƒ± se√ß ve onay penceresi a√ß"""
        try:
            # Pozisyonlarƒ± se√ß
            for pos in positions:
                self.take_profit_longs_panel_reducemore.tree.set(pos['item'], "select", "‚úì")
                
                # Avg cost'u g√ºvenli ≈üekilde parse et
                avg_cost_str = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_longs_panel_reducemore.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Lot y√ºzdesini ayarla
            if lot_percentage == 25:
                self.take_profit_longs_panel_reducemore.set_lot_percentage(25)
            elif lot_percentage == 50:
                self.take_profit_longs_panel_reducemore.set_lot_percentage(50)
            elif lot_percentage == 75:
                self.take_profit_longs_panel_reducemore.set_lot_percentage(75)
            elif lot_percentage == 100:
                self.take_profit_longs_panel_reducemore.set_lot_percentage(100)
            
            # Onay penceresini a√ß
            print(f"[REDUCEMORE DEBUG] üîÑ Onay penceresi a√ßƒ±lƒ±yor: {step_name}")
            self.reduce_more_show_confirmation_window(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Pozisyon se√ßimi hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE pozisyon se√ßimi hatasƒ±: {e}")
    
    def reducemore_send_orders_direct(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE emirlerini direkt g√∂nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[REDUCEMORE] üîÑ {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            self.log_message(f"üîÑ {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            
            # Pozisyon verilerini hazƒ±rla
            order_data = {}
            
            # Panel se√ßimi (order_type'a g√∂re)
            if order_type in ["Ask Sell", "Front Sell"]:
                panel = self.take_profit_longs_panel_reducemore
            else:
                panel = self.take_profit_shorts_panel_reducemore
            
            for pos in positions:
                item_values = panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])
                
                # Lot hesapla
                calculated_lot = qty * (lot_percentage / 100)
                
                # 200 lot altƒ± pozisyonlar i√ßin tamamƒ±nƒ± g√∂nder
                abs_qty = abs(qty)
                if abs_qty < 200:
                    # Eldeki lot < 200 ise tamamƒ±nƒ± g√∂nder
                    lot_qty = int(abs_qty) if qty >= 0 else -int(abs_qty)
                else:
                    # Lot yuvarlama
                    if calculated_lot >= 0:
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                
                # YENƒ∞ KURAL Sƒ∞STEMƒ∞: REDUCE limitleri (BefQty/Portf√∂y oranƒ±na g√∂re)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                
                # G√ºnl√ºk reduce limitini hesapla
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                # Mevcut pozisyon ve a√ßƒ±k emirler
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                
                # G√ºnl√ºk deƒüi≈üim (mutlak deƒüer)
                current_daily_change = abs(current_potential - befday_qty)
                
                # Kalan g√ºnl√ºk hak
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                # Emir miktarƒ±nƒ± kontrol et ve gerekirse ayarla
                if lot_qty > remaining_allowance and not is_unlimited:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[REDUCEMORE] ‚ö†Ô∏è {symbol}: G√ºnl√ºk limit doldu ({current_daily_change:.0f}/{daily_limit:.0f}), emir atlandƒ±")
                        self.log_message(f"‚ö†Ô∏è {symbol}: G√ºnl√ºk REDUCE limit doldu, emir atlandƒ±")
                        continue
                    else:
                        # Lot miktarƒ±nƒ± ayarla
                        lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                        print(f"[REDUCEMORE] üìä {symbol}: Emir miktarƒ± ayarlandƒ± ‚Üí {lot_qty} lot ({limit_reason})")
                
                # Ters pozisyona ge√ßi≈ü kontrol√º (sƒ±nƒ±rsƒ±z bile olsa)
                if order_type == "Ask Sell":
                    new_potential = current_potential - lot_qty
                else:
                    new_potential = current_potential + lot_qty
                
                # Long iken short'a veya short iken long'a ge√ßi≈üi engelle
                if befday_qty > 0 and new_potential < 0:
                    lot_qty = int(current_potential)  # 0'a getir
                    print(f"[REDUCEMORE] ‚ö†Ô∏è {symbol}: Ters poz. yasak, lot ayarlandƒ± ‚Üí {lot_qty}")
                elif befday_qty < 0 and new_potential > 0:
                    lot_qty = int(abs(current_potential))  # 0'a getir
                    print(f"[REDUCEMORE] ‚ö†Ô∏è {symbol}: Ters poz. yasak, lot ayarlandƒ± ‚Üí {lot_qty}")
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                if not market_data:
                    print(f"[REDUCEMORE] ‚ùå {symbol} market_data bulunamadƒ±, atlandƒ±")
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                emir_fiyat = 0
                if order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        continue
                elif order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                elif order_type == "Front Sell":
                    if last > 0:
                        emir_fiyat = last - 0.01
                    else:
                        continue
                elif order_type == "Front Buy":
                    if last > 0:
                        emir_fiyat = last + 0.01
                    else:
                        continue
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri g√∂nder
            success_count = 0
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if abs(lot_qty) < 200:
                    continue
                
                # Controller kontrol√º (MAXALW limitleri dahil)
                if hasattr(self, 'controller_enabled') and self.controller_enabled:
                    order_side = "SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY"
                    allowed, adjusted_qty, reason = self.controller_check_order(symbol, order_side, abs(lot_qty))
                    
                    if not allowed or adjusted_qty == 0:
                        print(f"[REDUCEMORE] ‚ö†Ô∏è {symbol}: Controller engelledi - {reason}")
                        self.log_message(f"‚ö†Ô∏è {symbol}: Controller engelledi - {reason}")
                        continue
                    
                    lot_qty = adjusted_qty if order_side == "SELL" else adjusted_qty
                
                # Emir g√∂nder
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success or "new order sent" in str(success):
                            success_count += 1
                            print(f"[REDUCEMORE] ‚úÖ {symbol}: {order_type} {lot_qty} lot @ ${emir_fiyat:.2f}")
                    except Exception as e:
                        if "new order sent" in str(e).lower():
                            success_count += 1
                        else:
                            print(f"[REDUCEMORE] ‚ùå {symbol}: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT",
                        hidden=True
                    )
                    if success:
                        success_count += 1
                        print(f"[REDUCEMORE] ‚úÖ {symbol}: {order_type} {lot_qty} lot @ ${emir_fiyat:.2f}")
            
            print(f"[REDUCEMORE] ‚úÖ {step_name} tamamlandƒ±: {success_count} emir g√∂nderildi")
            self.log_message(f"‚úÖ {step_name} tamamlandƒ±: {success_count} emir g√∂nderildi")
            
            # Sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile - adƒ±mlar sƒ±ralƒ± ilerlesin)
            self.after(1000, self.reduce_more_proceed_to_next_step)
            
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            self.log_message(f"‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile)
            self.after(1000, self.reduce_more_proceed_to_next_step)
    
    def reduce_more_show_confirmation_window(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE onay penceresi g√∂ster - KARBOTU ile birebir aynƒ± mantƒ±k"""
        # Bu fonksiyon KARBOTU'nun karbotu_show_confirmation_window ile birebir aynƒ±
        # Sadece panel adlarƒ± (take_profit_longs_panel_reducemore) ve log mesajlarƒ± deƒüi≈üir
        # Kod √ßok uzun olduƒüu i√ßin karbotu_show_confirmation_window'u kullanƒ±yoruz
        # Ancak panel adƒ±nƒ± deƒüi≈ütirmemiz gerekiyor
        try:
            # RUNALL Allowed modunda otomatik onay kontrol√º
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[REDUCEMORE] ‚úÖ Allowed modu aktif - Onay penceresi atlanƒ±yor, emirler direkt g√∂nderiliyor")
                self.log_message(f"‚úÖ Allowed modu: {step_name} - Emirler otomatik g√∂nderiliyor")
                # Emirleri direkt g√∂nder (onay penceresi a√ßmadan)
                self.reducemore_send_orders_direct(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[REDUCEMORE DEBUG] üîÑ Onay penceresi fonksiyonu ba≈üladƒ±: {step_name}")
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"REDUCEMORE - {step_name}")
            confirm_win.geometry("600x400")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            # Ba≈ülƒ±k frame - minimize butonu ile
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            # Sol taraf - ba≈ülƒ±k bilgileri
            title_left = ttk.Frame(title_frame)
            title_left.pack(side='left', fill='x', expand=True)
            
            ttk.Label(title_left, text=f"REDUCEMORE - {step_name}", font=('Arial', 14, 'bold')).pack(anchor='w')
            ttk.Label(title_left, text=f"{order_type} - %{lot_percentage} Lot", font=('Arial', 12)).pack(anchor='w')
            ttk.Label(title_left, text=f"{len(positions)} pozisyon se√ßildi", font=('Arial', 10)).pack(anchor='w')
            
            # Saƒü taraf - minimize butonu
            window_controls = ttk.Frame(title_frame)
            window_controls.pack(side='right')
            
            # Alta Al (Minimize) butonu
            minimize_btn = ttk.Button(window_controls, text="üóï Alta Al", width=10,
                                      command=lambda: confirm_win.iconify())
            minimize_btn.pack(side='left', padx=2)
            
            # Pozisyon listesi
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Treeview
            columns = ('Symbol', 'Qty', 'Lot', 'Fbtot', 'Ask Sell Pahalƒ±lƒ±k', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=10)
            
            # Kolon geni≈ülikleri
            col_widths = {'Symbol': 80, 'Qty': 60, 'Lot': 60, 'Fbtot': 60, 'Ask Sell Pahalƒ±lƒ±k': 100, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            # Scrollbar
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # ‚úÖ Fƒ∞YAT VE LOT DEPOSU - pencereye √∂zel
            order_data = {}  # {symbol: {'price': emir_fiyat, 'lot': lot_qty}}
            
            # Pozisyonlarƒ± ekle
            for pos in positions:
                # Pozisyon verilerini al
                item_values = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Quantity
                
                # Lot hesapla (%50, %75 veya %100)
                calculated_lot = qty * (lot_percentage / 100)
                
                # %100 lot i√ßin yuvarlama YAPILMAZ - tam lot miktarƒ± kullanƒ±lƒ±r
                if lot_percentage == 100:
                    lot_qty = int(calculated_lot)
                # Lot yuvarlama mantƒ±ƒüƒ± (%50 ve %75 i√ßin)
                elif calculated_lot >= 0:
                    if calculated_lot <= 0:
                        lot_qty = 0
                    elif calculated_lot <= 100:
                        lot_qty = 100
                    elif calculated_lot <= 200:
                        lot_qty = 200
                    elif calculated_lot <= 300:
                        lot_qty = 300
                    elif calculated_lot <= 400:
                        lot_qty = 400
                    elif calculated_lot <= 500:
                        lot_qty = 500
                    elif calculated_lot <= 600:
                        lot_qty = 600
                    elif calculated_lot <= 700:
                        lot_qty = 700
                    elif calculated_lot <= 800:
                        lot_qty = 800
                    elif calculated_lot <= 900:
                        lot_qty = 900
                    elif calculated_lot <= 1000:
                        lot_qty = 1000
                    else:
                        lot_qty = int((calculated_lot + 99) // 100) * 100
                else:
                    abs_calculated = abs(calculated_lot)
                    if abs_calculated <= 100:
                        lot_qty = 100
                    elif abs_calculated <= 200:
                        lot_qty = 200
                    elif abs_calculated <= 300:
                        lot_qty = 300
                    elif abs_calculated <= 400:
                        lot_qty = -400
                    elif abs_calculated <= 500:
                        lot_qty = -500
                    elif abs_calculated <= 600:
                        lot_qty = -600
                    elif abs_calculated <= 700:
                        lot_qty = -700
                    elif abs_calculated <= 800:
                        lot_qty = -800
                    elif abs_calculated <= 900:
                        lot_qty = -900
                    elif abs_calculated <= 1000:
                        lot_qty = 1000
                    else:
                        lot_qty = int((abs_calculated + 99) // 100) * 100
                
                # Emir fiyatƒ±nƒ± hesapla (JFIN mantƒ±ƒüƒ± - KARBOTU ile aynƒ±)
                emir_fiyat = 0
                market_data = None
                
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        emir_fiyat = 0
                        continue
                else:
                    emir_fiyat = 0
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                
                if order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        emir_fiyat = 0
                        continue
                else:
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        emir_fiyat = 0
                        continue
                
                pos_tree.insert('', 'end', values=(
                    pos['symbol'],
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['fbtot']:.2f}",
                    f"${pos['ask_sell_pahalilik']:.4f}",
                    f"${emir_fiyat:.2f}"
                ))
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Butonlar
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[REDUCEMORE] üîÑ {step_name} emirleri g√∂nderiliyor...")
                    self.log_message(f"üîÑ {step_name} emirleri g√∂nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if abs(lot_qty) < 200:
                            continue
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="SELL",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                            except Exception as e:
                                pass
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="SELL",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT",
                                hidden=True
                            )
                    
                    print(f"[REDUCEMORE] ‚úÖ {step_name} emirleri g√∂nderildi")
                    self.log_message(f"‚úÖ {step_name} emirleri g√∂nderildi")
                    
                except Exception as e:
                    print(f"[REDUCEMORE] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    self.log_message(f"‚ùå Emir g√∂nderme hatasƒ±: {e}")
                
                confirm_win.destroy()
                self.reduce_more_proceed_to_next_step()
            
            def on_cancel():
                print(f"[REDUCEMORE] ‚ùå {step_name} iptal edildi")
                self.log_message(f"‚ùå {step_name} iptal edildi")
                confirm_win.destroy()
                self.reduce_more_proceed_to_next_step()
            
            def save_to_trades_csv():
                """Se√ßili emirleri trades.csv formatƒ±nda kaydet"""
                try:
                    print(f"[REDUCEMORE CSV] üîÑ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    self.log_message(f"üîÑ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    
                    # CSV satƒ±rlarƒ±
                    csv_rows = []
                    
                    # PENCERE'DEKƒ∞ tablodan verileri al (zaten hesaplanmƒ±≈ü fiyatlar var)
                    for item in pos_tree.get_children():
                        values = pos_tree.item(item)['values']
                        symbol = values[0]
                        qty = float(values[1])
                        lot_qty = float(values[2])
                        
                        # Emir fiyatƒ±nƒ± PENCERE'DEKƒ∞ DEƒûERDEN al (zaten hesaplanmƒ±≈ü)
                        emir_fiyat_str = values[5]  # "Emir Fiyat" kolonu
                        try:
                            # $ i≈üaretini ve format karakterlerini temizle
                            emir_fiyat = float(str(emir_fiyat_str).replace('$', '').replace(',', '').strip())
                            print(f"[REDUCEMORE CSV] ‚úÖ {symbol}: Emir fiyatƒ± pencereden alƒ±ndƒ±: ${emir_fiyat:.2f}")
                        except (ValueError, TypeError, IndexError):
                            print(f"[REDUCEMORE CSV] ‚ùå {symbol}: Emir fiyatƒ± okunamadƒ±: {emir_fiyat_str}")
                            emir_fiyat = 0
                            continue
                        
                        # Lot ve fiyat ZATEN PENCREDEN ALINDI - market data √ßekmeye GEREK YOK!
                        # Minimum lot kontrol√º
                        if abs(lot_qty) < 200:
                            continue
                        
                        # CSV'ye kaydet (fiyat ve lot zaten hazƒ±r)
                        if emir_fiyat > 0:
                            # CSV formatƒ± (orijinal format)
                            csv_row = [
                                'SELL',                    # Action
                                int(lot_qty),             # Quantity
                                symbol,                    # Symbol
                                'STK',                    # SecType
                                'SMART/AMEX',              # Exchange
                                'USD',                    # Currency
                                'DAY',                    # TimeInForce
                                'LMT',                    # OrderType
                                f"{emir_fiyat:.2f}",      # LmtPrice
                                'Basket',                 # BasketTag
                                'U21016730',              # Account
                                'Basket',                 # OrderRef
                                'TRUE',                   # Hidden
                                'TRUE'                    # OutsideRth
                            ]
                            
                            csv_rows.append(csv_row)
                            print(f"[REDUCEMORE CSV] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    if csv_rows:
                        # CSV dosyasƒ±na kaydet
                        import csv
                        
                        csv_filename = 'trades.csv'
                        
                        # Dosyayƒ± sƒ±fƒ±rdan yaz (write mode)
                        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                            writer = csv.writer(csvfile)
                            
                            # Ba≈ülƒ±k satƒ±rƒ± (orijinal format)
                            writer.writerow(['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 'OrderRef', 'Hidden', 'OutsideRth'])
                            
                            # Emir satƒ±rlarƒ±
                            writer.writerows(csv_rows)
                        
                        print(f"[REDUCEMORE CSV] ‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        self.log_message(f"‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                    else:
                        messagebox.showwarning("Uyarƒ±", "Kaydedilecek ge√ßerli emir bulunamadƒ±!")
                        
                except Exception as e:
                    print(f"[REDUCEMORE CSV] ‚ùå Kaydetme hatasƒ±: {e}")
                    self.log_message(f"‚ùå Kaydetme hatasƒ±: {e}")
                    messagebox.showerror("Hata", f"trades.csv kaydetme hatasƒ±: {e}")
            
            ttk.Button(button_frame, text="Emirleri G√∂nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Onay penceresi hatasƒ±: {e}")
            self.log_message(f"‚ùå Onay penceresi hatasƒ±: {e}")
    
    def reduce_more_select_shorts_positions_and_confirm(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE: Shorts pozisyonlarƒ± se√ß ve onay penceresi a√ß"""
        try:
            for pos in positions:
                self.take_profit_shorts_panel_reducemore.tree.set(pos['item'], "select", "‚úì")
                
                avg_cost_str = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_shorts_panel_reducemore.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Lot y√ºzdesini ayarla
            if lot_percentage == 25:
                self.take_profit_shorts_panel_reducemore.set_lot_percentage(25)
            elif lot_percentage == 50:
                self.take_profit_shorts_panel_reducemore.set_lot_percentage(50)
            elif lot_percentage == 75:
                self.take_profit_shorts_panel_reducemore.set_lot_percentage(75)
            elif lot_percentage == 100:
                self.take_profit_shorts_panel_reducemore.set_lot_percentage(100)
            
            self.reduce_more_show_shorts_confirmation_window(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Shorts pozisyon se√ßimi hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE Shorts pozisyon se√ßimi hatasƒ±: {e}")
    
    def reduce_more_show_shorts_confirmation_window(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Shorts onay penceresi g√∂ster - KARBOTU ile birebir aynƒ± mantƒ±k"""
        try:
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"REDUCEMORE - {step_name}")
            confirm_win.geometry("600x400")
            # transient ve grab_set kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"REDUCEMORE - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - %{lot_percentage} Lot", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon se√ßildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Qty', 'Lot', 'SFStot', 'Bid Buy Ucuzluk', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=10)
            
            col_widths = {'Symbol': 80, 'Qty': 60, 'Lot': 60, 'SFStot': 60, 'Bid Buy Ucuzluk': 100, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values']
                qty = float(item_values[2])  # Negatif gelebilir (-276 gibi)
                
                # Short pozisyonlar i√ßin ABS deƒüer ile hesapla
                abs_qty = abs(qty)  # -276 -> 276
                calculated_lot = abs_qty * (lot_percentage / 100)  # 276 * 0.75 = 207
                
                # %100 lot i√ßin yuvarlama YAPILMAZ - tam lot miktarƒ± kullanƒ±lƒ±r
                if lot_percentage == 100:
                    lot_qty = int(calculated_lot)  # 276 (pozitif)
                # Lot yuvarlama (%50 ve %75 i√ßin) - pozitif deƒüer ile yuvarlama yap
                elif calculated_lot > 0:
                    if calculated_lot <= 0:
                        lot_qty = 0
                    elif calculated_lot <= 100:
                        lot_qty = 100
                    elif calculated_lot <= 200:
                        lot_qty = 200
                    elif calculated_lot <= 300:
                        lot_qty = 300
                    elif calculated_lot <= 400:
                        lot_qty = 400
                    elif calculated_lot <= 500:
                        lot_qty = 500
                    elif calculated_lot <= 600:
                        lot_qty = 600
                    elif calculated_lot <= 700:
                        lot_qty = 700
                    elif calculated_lot <= 800:
                        lot_qty = 800
                    elif calculated_lot <= 900:
                        lot_qty = 900
                    elif calculated_lot <= 1000:
                        lot_qty = 1000
                    else:
                        lot_qty = int((calculated_lot + 99) // 100) * 100
                else:
                    lot_qty = 0
                
                # Lot her zaman pozitif olmalƒ± (BUY emri i√ßin short pozisyonu kapatmak i√ßin)
                # qty negatif olsa bile (short pozisyon), lot pozitif hesaplanƒ±r
                
                symbol = pos['symbol']
                emir_fiyat = 0
                market_data = None
                
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        continue
                else:
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                
                if order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                else:
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                
                pos_tree.insert('', 'end', values=(
                    pos['symbol'],
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['sfstot']:.2f}",
                    f"${pos['bid_buy_ucuzluk']:.4f}",
                    f"${emir_fiyat:.2f}"
                ))
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[REDUCEMORE] üîÑ {step_name} emirleri g√∂nderiliyor...")
                    self.log_message(f"üîÑ {step_name} emirleri g√∂nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if abs(lot_qty) < 200:
                            continue
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="BUY",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                            except Exception as e:
                                pass
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="BUY",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT",
                                hidden=True
                            )
                    
                    print(f"[REDUCEMORE] ‚úÖ {step_name} emirleri g√∂nderildi")
                    self.log_message(f"‚úÖ {step_name} emirleri g√∂nderildi")
                    
                except Exception as e:
                    print(f"[REDUCEMORE] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    self.log_message(f"‚ùå Emir g√∂nderme hatasƒ±: {e}")
                
                confirm_win.destroy()
                self.reduce_more_proceed_to_next_step()
            
            def on_cancel():
                print(f"[REDUCEMORE] ‚ùå {step_name} iptal edildi")
                self.log_message(f"‚ùå {step_name} iptal edildi")
                confirm_win.destroy()
                self.reduce_more_proceed_to_next_step()
            
            def save_to_trades_csv():
                """Se√ßili emirleri trades.csv formatƒ±nda kaydet - SHORTS i√ßin BUY"""
                try:
                    print(f"[REDUCEMORE CSV SHORTS] üîÑ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    self.log_message(f"üîÑ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    
                    # CSV satƒ±rlarƒ±
                    csv_rows = []
                    
                    # PENCERE'DEKƒ∞ tablodan verileri al (zaten hesaplanmƒ±≈ü fiyatlar var)
                    for item in pos_tree.get_children():
                        values = pos_tree.item(item)['values']
                        symbol = values[0]
                        qty = float(values[1])
                        lot_qty = float(values[2])
                        
                        # Emir fiyatƒ±nƒ± PENCERE'DEKƒ∞ DEƒûERDEN al (zaten hesaplanmƒ±≈ü)
                        emir_fiyat_str = values[5]  # "Emir Fiyat" kolonu
                        try:
                            # $ i≈üaretini ve format karakterlerini temizle
                            emir_fiyat = float(str(emir_fiyat_str).replace('$', '').replace(',', '').strip())
                            print(f"[REDUCEMORE CSV SHORTS] ‚úÖ {symbol}: Emir fiyatƒ± pencereden alƒ±ndƒ±: ${emir_fiyat:.2f}")
                        except (ValueError, TypeError, IndexError):
                            print(f"[REDUCEMORE CSV SHORTS] ‚ùå {symbol}: Emir fiyatƒ± okunamadƒ±: {emir_fiyat_str}")
                            emir_fiyat = 0
                            continue
                        
                        # Lot ve fiyat ZATEN PENCREDEN ALINDI - market data √ßekmeye GEREK YOK!
                        # Minimum lot kontrol√º
                        if abs(lot_qty) < 200:
                            continue
                        
                        # CSV'ye kaydet (fiyat ve lot zaten hazƒ±r) - SHORTS i√ßin BUY
                        if emir_fiyat > 0:
                            # CSV formatƒ± (orijinal format) - Short pozisyon i√ßin BUY
                            csv_row = [
                                'BUY',                     # Action (short pozisyonu kapatmak i√ßin BUY)
                                int(lot_qty),             # Quantity
                                symbol,                    # Symbol
                                'STK',                    # SecType
                                'SMART/AMEX',              # Exchange
                                'USD',                    # Currency
                                'DAY',                    # TimeInForce
                                'LMT',                    # OrderType
                                f"{emir_fiyat:.2f}",      # LmtPrice
                                'Basket',                 # BasketTag
                                'U21016730',              # Account
                                'Basket',                 # OrderRef
                                'TRUE',                   # Hidden
                                'TRUE'                    # OutsideRth
                            ]
                            
                            csv_rows.append(csv_row)
                            print(f"[REDUCEMORE CSV SHORTS] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    if csv_rows:
                        # CSV dosyasƒ±na kaydet
                        import csv
                        
                        csv_filename = 'trades.csv'
                        
                        # Dosyayƒ± sƒ±fƒ±rdan yaz (write mode)
                        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                            writer = csv.writer(csvfile)
                            
                            # Ba≈ülƒ±k satƒ±rƒ± (orijinal format)
                            writer.writerow(['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 'OrderRef', 'Hidden', 'OutsideRth'])
                            
                            # Emir satƒ±rlarƒ±
                            writer.writerows(csv_rows)
                        
                        print(f"[REDUCEMORE CSV SHORTS] ‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        self.log_message(f"‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                    else:
                        messagebox.showwarning("Uyarƒ±", "Kaydedilecek ge√ßerli emir bulunamadƒ±!")
                        
                except Exception as e:
                    print(f"[REDUCEMORE CSV SHORTS] ‚ùå Kaydetme hatasƒ±: {e}")
                    self.log_message(f"‚ùå Kaydetme hatasƒ±: {e}")
                    messagebox.showerror("Hata", f"trades.csv kaydetme hatasƒ±: {e}")
            
            ttk.Button(button_frame, text="Emirleri G√∂nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Shorts onay penceresi hatasƒ±: {e}")
            self.log_message(f"‚ùå Shorts onay penceresi hatasƒ±: {e}")
    
    def reduce_more_proceed_to_next_step(self):
        """REDUCEMORE: Sonraki adƒ±ma ge√ß"""
        try:
            if self.reducemore_current_step >= self.reducemore_total_steps:
                print("[REDUCEMORE] üéØ T√ºm adƒ±mlar tamamlandƒ±!")
                self.log_message("üéØ REDUCEMORE otomasyonu tamamlandƒ±!")
                self.reducemore_running = False
                
                # RUNALL'dan √ßaƒürƒ±ldƒ±ysa ADDNEWPOS kontrol√º yap (SADECE Bƒ∞R KEZ)
                if hasattr(self, 'runall_waiting_for_reducemore') and self.runall_waiting_for_reducemore:
                    if not hasattr(self, 'runall_addnewpos_triggered') or not self.runall_addnewpos_triggered:
                        self.runall_waiting_for_reducemore = False
                        self.runall_addnewpos_triggered = True  # ƒ∞≈üaretle ki tekrar tetiklenmesin
                        self.after(2000, self.runall_check_karbotu_and_addnewpos)  # 2 saniye sonra kontrol et
                
                return
            
            next_step = self.reducemore_current_step + 1
            
            step_methods = {
                2: self.reduce_more_step_2_fbtot_lt_110,
                3: self.reduce_more_step_3_fbtot_111_145_low,
                4: self.reduce_more_step_4_fbtot_111_145_high,
                5: self.reduce_more_step_5_fbtot_146_185_low,
                6: self.reduce_more_step_6_fbtot_146_185_high,
                7: self.reduce_more_step_7_fbtot_186_210,
                8: self.reduce_more_step_8_open_take_profit_shorts,
                9: self.reduce_more_step_9_sfstot_170_high,
                10: self.reduce_more_step_10_sfstot_140_169_low,
                11: self.reduce_more_step_11_sfstot_140_169_high,
                12: self.reduce_more_step_12_sfstot_110_139_low,
                13: self.reduce_more_step_13_sfstot_110_139_high
            }
            
            if next_step in step_methods:
                self.reducemore_current_step = next_step
                step_methods[next_step]()
            else:
                print(f"[REDUCEMORE] ‚ö†Ô∏è Adƒ±m {next_step} hen√ºz implement edilmedi")
                self.log_message(f"‚ö†Ô∏è Adƒ±m {next_step} hen√ºz implement edilmedi")
                
        except Exception as e:
            print(f"[REDUCEMORE] ‚ùå Sonraki adƒ±m hatasƒ±: {e}")
            self.log_message(f"‚ùå Sonraki adƒ±m hatasƒ±: {e}")
    
    def karbotu_select_positions_and_confirm(self, positions, order_type, lot_percentage, step_name):
        """Pozisyonlarƒ± se√ß ve onay penceresi a√ß"""
        try:
            # Pozisyonlarƒ± se√ß
            for pos in positions:
                self.take_profit_longs_panel.tree.set(pos['item'], "select", "‚úì")
                
                # Avg cost'u g√ºvenli ≈üekilde parse et
                avg_cost_str = self.take_profit_longs_panel.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_longs_panel.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_longs_panel.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # Lot y√ºzdesini ayarla
            if lot_percentage == 25:
                self.take_profit_longs_panel.set_lot_percentage(25)
            elif lot_percentage == 50:
                self.take_profit_longs_panel.set_lot_percentage(50)
            
            # Onay penceresini a√ß
            print(f"[KARBOTU DEBUG] üîÑ Onay penceresi a√ßƒ±lƒ±yor: {step_name}")
            self.karbotu_show_confirmation_window(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Pozisyon se√ßimi hatasƒ±: {e}")
            self.log_message(f"‚ùå Pozisyon se√ßimi hatasƒ±: {e}")
    
    def karbotu_send_orders_direct(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU emirlerini direkt g√∂nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[KARBOTU] üîÑ {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            self.log_message(f"üîÑ {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            
            # Pozisyon verilerini hazƒ±rla
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])
                
                # Lot hesapla
                calculated_lot = qty * (lot_percentage / 100)
                
                # 200 lot altƒ± pozisyonlar i√ßin tamamƒ±nƒ± g√∂nder
                abs_qty = abs(qty)
                if abs_qty < 200:
                    # Eldeki lot < 200 ise tamamƒ±nƒ± g√∂nder
                    lot_qty = int(abs_qty) if qty >= 0 else -int(abs_qty)
                else:
                    # Lot yuvarlama
                    if calculated_lot >= 0:
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                
                # YENƒ∞ KURAL Sƒ∞STEMƒ∞: REDUCE limitleri (BefQty/Portf√∂y oranƒ±na g√∂re)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                
                # G√ºnl√ºk reduce limitini hesapla
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                # Mevcut pozisyon ve a√ßƒ±k emirler
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                
                # G√ºnl√ºk deƒüi≈üim (mutlak deƒüer)
                current_daily_change = abs(current_potential - befday_qty)
                
                # Kalan g√ºnl√ºk hak
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                # Emir miktarƒ±nƒ± kontrol et ve gerekirse ayarla
                if lot_qty > remaining_allowance and not is_unlimited:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[KARBOTU] ‚ö†Ô∏è {symbol}: G√ºnl√ºk limit doldu ({current_daily_change:.0f}/{daily_limit:.0f}), emir atlandƒ±")
                        self.log_message(f"‚ö†Ô∏è {symbol}: G√ºnl√ºk REDUCE limit doldu, emir atlandƒ±")
                        continue
                    else:
                        # Lot miktarƒ±nƒ± ayarla
                        lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                        print(f"[KARBOTU] üìä {symbol}: Emir miktarƒ± ayarlandƒ± ‚Üí {lot_qty} lot ({limit_reason})")
                
                # Ters pozisyona ge√ßi≈ü kontrol√º (sƒ±nƒ±rsƒ±z bile olsa)
                if order_type == "Ask Sell":
                    new_potential = current_potential - lot_qty
                else:
                    new_potential = current_potential + lot_qty
                
                # Long iken short'a veya short iken long'a ge√ßi≈üi engelle
                if befday_qty > 0 and new_potential < 0:
                    lot_qty = int(current_potential)  # 0'a getir
                    print(f"[KARBOTU] ‚ö†Ô∏è {symbol}: Ters poz. yasak, lot ayarlandƒ± ‚Üí {lot_qty}")
                elif befday_qty < 0 and new_potential > 0:
                    lot_qty = int(abs(current_potential))  # 0'a getir
                    print(f"[KARBOTU] ‚ö†Ô∏è {symbol}: Ters poz. yasak, lot ayarlandƒ± ‚Üí {lot_qty}")
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                if not market_data:
                    print(f"[KARBOTU] ‚ùå {symbol} market_data bulunamadƒ±, atlandƒ±")
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                emir_fiyat = 0
                if order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                    else:
                        continue
                elif order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                    else:
                        continue
                elif order_type == "Front Sell":
                    if last > 0:
                        emir_fiyat = last - 0.01
                    else:
                        continue
                elif order_type == "Front Buy":
                    if last > 0:
                        emir_fiyat = last + 0.01
                    else:
                        continue
                
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri g√∂nder
            success_count = 0
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if abs(lot_qty) < 200:
                    continue
                
                # Controller kontrol√º (MAXALW limitleri dahil)
                if hasattr(self, 'controller_enabled') and self.controller_enabled:
                    order_side = "SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY"
                    allowed, adjusted_qty, reason = self.controller_check_order(symbol, order_side, abs(lot_qty))
                    
                    if not allowed or adjusted_qty == 0:
                        print(f"[KARBOTU] ‚ö†Ô∏è {symbol}: Controller engelledi - {reason}")
                        self.log_message(f"‚ö†Ô∏è {symbol}: Controller engelledi - {reason}")
                        continue
                    
                    lot_qty = adjusted_qty if order_side == "SELL" else adjusted_qty
                
                # Emir g√∂nder
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success or "new order sent" in str(success):
                            success_count += 1
                            print(f"[KARBOTU] ‚úÖ {symbol}: {order_type} {lot_qty} lot @ ${emir_fiyat:.2f}")
                    except Exception as e:
                        if "new order sent" in str(e).lower():
                            success_count += 1
                        else:
                            print(f"[KARBOTU] ‚ùå {symbol}: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="SELL" if order_type in ["Ask Sell", "Front Sell"] else "BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT",
                        hidden=True
                    )
                    if success:
                        success_count += 1
                        print(f"[KARBOTU] ‚úÖ {symbol}: {order_type} {lot_qty} lot @ ${emir_fiyat:.2f}")
            
            print(f"[KARBOTU] ‚úÖ {step_name} tamamlandƒ±: {success_count} emir g√∂nderildi")
            self.log_message(f"‚úÖ {step_name} tamamlandƒ±: {success_count} emir g√∂nderildi")
            
            # Sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile - adƒ±mlar sƒ±ralƒ± ilerlesin)
            self.after(1000, self.karbotu_proceed_to_next_step)
            
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            self.log_message(f"‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile)
            self.after(1000, self.karbotu_proceed_to_next_step)
    
    def karbotu_gort_select_and_send_longs(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort: Longs pozisyonlarƒ± se√ß ve √∂zel lot hesaplama ile emir g√∂nder"""
        try:
            # Pozisyonlarƒ± se√ß
            for pos in positions:
                self.take_profit_longs_panel.tree.set(pos['item'], "select", "‚úì")
                
                # Avg cost'u g√ºvenli ≈üekilde parse et
                avg_cost_str = self.take_profit_longs_panel.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_longs_panel.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_longs_panel.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # √ñzel lot hesaplama ile onay penceresi a√ß
            self.karbotu_gort_show_confirmation_window_longs(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[KARBOTU GORT] ‚ùå Pozisyon se√ßimi hatasƒ±: {e}")
            self.log_message(f"‚ùå KARBOTU Gort pozisyon se√ßimi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def karbotu_gort_select_and_send_shorts(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort: Shorts pozisyonlarƒ± se√ß ve √∂zel lot hesaplama ile emir g√∂nder"""
        try:
            # Pozisyonlarƒ± se√ß
            for pos in positions:
                self.take_profit_shorts_panel.tree.set(pos['item'], "select", "‚úì")
                
                # Avg cost'u g√ºvenli ≈üekilde parse et
                avg_cost_str = self.take_profit_shorts_panel.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_shorts_panel.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_shorts_panel.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # √ñzel lot hesaplama ile onay penceresi a√ß
            self.karbotu_gort_show_confirmation_window_shorts(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[KARBOTU GORT] ‚ùå Pozisyon se√ßimi hatasƒ±: {e}")
            self.log_message(f"‚ùå KARBOTU Gort pozisyon se√ßimi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reducemore_gort_send_orders_direct_longs(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Longs i√ßin direkt emir g√∂nderme (Allowed modu i√ßin)"""
        try:
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (pozitif)
                
                # √ñzel lot hesaplama: %20 ama min 200 lot, eƒüer eldeki lot < 200 ise eldeki lotun tamamƒ±
                calculated_lot = qty * (lot_percentage / 100)  # %20 hesapla
                
                if qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamƒ±
                    lot_qty = int(qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %20 hesaplanan deƒüer 200'den k√º√ß√ºkse ‚Üí 200 lot (min 200 kuralƒ±)
                        lot_qty = 200
                    else:
                        # %20 hesaplanan deƒüer 200'den b√ºy√ºk veya e≈üitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrol√º (yuvarlama sonrasƒ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # YENƒ∞ KURAL Sƒ∞STEMƒ∞: REDUCE limitleri
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                current_daily_change = abs(current_potential - befday_qty)
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                if not is_unlimited and lot_qty > remaining_allowance:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[REDUCEMORE GORT] ‚ö†Ô∏è {symbol}: G√ºnl√ºk limit doldu, emir atlandƒ±")
                        continue
                    lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                    print(f"[REDUCEMORE GORT] üìä {symbol}: Emir miktarƒ± ayarlandƒ± ‚Üí {lot_qty} lot")
                
                # Ters pozisyona ge√ßi≈ü kontrol√º
                new_potential = current_potential - lot_qty
                if befday_qty > 0 and new_potential < 0:
                    lot_qty = int(current_potential)
                    print(f"[REDUCEMORE GORT] ‚ö†Ô∏è {symbol}: Ters poz. yasak, lot ayarlandƒ± ‚Üí {lot_qty}")
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)  # Ask Sell
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri g√∂nder
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="SELL",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success:
                            print(f"[REDUCEMORE GORT] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                            self.log_message(f"‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                    except Exception as e:
                        print(f"[REDUCEMORE GORT] ‚ùå {symbol} emir hatasƒ±: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="SELL",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT"
                    )
                    if success:
                        print(f"[REDUCEMORE GORT] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                        self.log_message(f"‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
            
            print(f"[REDUCEMORE GORT] ‚úÖ {len(order_data)} emir g√∂nderildi")
            self.log_message(f"‚úÖ REDUCEMORE Gort {step_name}: {len(order_data)} emir g√∂nderildi")
            
            # Sonraki adƒ±ma ge√ß (Gort kontrol√º bitince sonraki adƒ±ma ge√ßilecek)
            self.after(500, self.reduce_more_proceed_to_next_step)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] ‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE Gort direkt emir g√∂nderme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß
            self.after(500, self.reduce_more_proceed_to_next_step)
    
    def reducemore_gort_select_and_send_longs(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Longs pozisyonlarƒ± se√ß ve √∂zel lot hesaplama ile emir g√∂nder"""
        try:
            # Pozisyonlarƒ± se√ß
            for pos in positions:
                self.take_profit_longs_panel_reducemore.tree.set(pos['item'], "select", "‚úì")
                
                # Avg cost'u g√ºvenli ≈üekilde parse et
                avg_cost_str = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_longs_panel_reducemore.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # √ñzel lot hesaplama ile onay penceresi a√ß
            self.reducemore_gort_show_confirmation_window_longs(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] ‚ùå Pozisyon se√ßimi hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE Gort pozisyon se√ßimi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reducemore_gort_select_and_send_shorts(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Shorts pozisyonlarƒ± se√ß ve √∂zel lot hesaplama ile emir g√∂nder"""
        try:
            # Pozisyonlarƒ± se√ß
            for pos in positions:
                self.take_profit_shorts_panel_reducemore.tree.set(pos['item'], "select", "‚úì")
                
                # Avg cost'u g√ºvenli ≈üekilde parse et
                avg_cost_str = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values'][3]
                avg_cost = 0
                if avg_cost_str and avg_cost_str != 'N/A':
                    try:
                        clean_str = str(avg_cost_str).replace('$', '').replace(',', '').strip()
                        if clean_str and clean_str != 'nan':
                            avg_cost = float(clean_str)
                    except (ValueError, TypeError):
                        avg_cost = 0
                
                self.take_profit_shorts_panel_reducemore.selected_positions[pos['symbol']] = {
                    'qty': float(self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values'][2]),
                    'avg_cost': avg_cost
                }
            
            # √ñzel lot hesaplama ile onay penceresi a√ß
            self.reducemore_gort_show_confirmation_window_shorts(positions, order_type, lot_percentage, step_name)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] ‚ùå Pozisyon se√ßimi hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE Gort pozisyon se√ßimi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def karbotu_show_confirmation_window(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU onay penceresi g√∂ster"""
        try:
            print(f"[KARBOTU DEBUG] üîÑ Onay penceresi fonksiyonu ba≈üladƒ±: {step_name}")
            
            # RUNALL Allowed modunda otomatik onay kontrol√º
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU] ‚úÖ Allowed modu aktif - Onay penceresi atlanƒ±yor, emirler direkt g√∂nderiliyor")
                self.log_message(f"‚úÖ Allowed modu: {step_name} - Emirler otomatik g√∂nderiliyor")
                # Emirleri direkt g√∂nder (onay penceresi a√ßmadan)
                self.karbotu_send_orders_direct(positions, order_type, lot_percentage, step_name)
                return
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"KARBOTU - {step_name}")
            confirm_win.geometry("600x400")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            # Ba≈ülƒ±k frame - minimize butonu ile
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            # Sol taraf - ba≈ülƒ±k bilgileri
            title_left = ttk.Frame(title_frame)
            title_left.pack(side='left', fill='x', expand=True)
            
            ttk.Label(title_left, text=f"KARBOTU - {step_name}", font=('Arial', 14, 'bold')).pack(anchor='w')
            ttk.Label(title_left, text=f"{order_type} - %{lot_percentage} Lot", font=('Arial', 12)).pack(anchor='w')
            ttk.Label(title_left, text=f"{len(positions)} pozisyon se√ßildi", font=('Arial', 10)).pack(anchor='w')
            
            # Saƒü taraf - minimize butonu
            window_controls = ttk.Frame(title_frame)
            window_controls.pack(side='right')
            
            # Alta Al (Minimize) butonu
            minimize_btn = ttk.Button(window_controls, text="üóï Alta Al", width=10,
                                      command=lambda: confirm_win.iconify())
            minimize_btn.pack(side='left', padx=2)
            
            # Pozisyon listesi
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Treeview
            columns = ('Symbol', 'Qty', 'Lot', 'Fbtot', 'Ask Sell Pahalƒ±lƒ±k', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=10)
            
            # Kolon geni≈ülikleri
            col_widths = {'Symbol': 80, 'Qty': 60, 'Lot': 60, 'Fbtot': 60, 'Ask Sell Pahalƒ±lƒ±k': 100, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            # Scrollbar
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # ‚úÖ Fƒ∞YAT VE LOT DEPOSU - pencereye √∂zel
            order_data = {}  # {symbol: {'price': emir_fiyat, 'lot': lot_qty}}
            
            # Pozisyonlarƒ± ekle
            for pos in positions:
                # Pozisyon verilerini al
                item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Quantity
                
                # Lot hesapla (%50 veya %25)
                calculated_lot = qty * (lot_percentage / 100)
                
                # 200 lot altƒ± pozisyonlar i√ßin tamamƒ±nƒ± g√∂nder
                abs_qty = abs(qty)
                if abs_qty < 200:
                    # Eldeki lot < 200 ise tamamƒ±nƒ± g√∂nder
                    lot_qty = int(abs_qty) if qty >= 0 else -int(abs_qty)
                else:
                    # Lot yuvarlama mantƒ±ƒüƒ± (negatif sayƒ±lar i√ßin)
                    if calculated_lot >= 0:
                        # Pozitif sayƒ±lar i√ßin normal yuvarlama
                        if calculated_lot <= 0:
                            lot_qty = 0
                        elif calculated_lot <= 100:
                            lot_qty = 100
                        elif calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        elif calculated_lot <= 600:
                            lot_qty = 600
                        elif calculated_lot <= 700:
                            lot_qty = 700
                        elif calculated_lot <= 800:
                            lot_qty = 800
                        elif calculated_lot <= 900:
                            lot_qty = 900
                        elif calculated_lot <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                    else:
                        # Negatif sayƒ±lar i√ßin a≈üaƒüƒ± yuvarlama (daha negatif)
                        abs_calculated = abs(calculated_lot)
                        if abs_calculated <= 100:
                            lot_qty = 100
                        elif abs_calculated <= 200:
                            lot_qty = 200
                        elif abs_calculated <= 300:
                            lot_qty = 300
                        elif abs_calculated <= 400:
                            lot_qty = -400
                        elif abs_calculated <= 500:
                            lot_qty = -500
                        elif abs_calculated <= 600:
                            lot_qty = -600
                        elif abs_calculated <= 700:
                            lot_qty = -700
                        elif abs_calculated <= 800:
                            lot_qty = -800
                        elif abs_calculated <= 900:
                            lot_qty = -900
                        elif abs_calculated <= 1000:
                            lot_qty = 1000
                        else:
                            lot_qty = int((abs_calculated + 99) // 100) * 100
                
                # Emir fiyatƒ±nƒ± hesapla (emir tipine g√∂re)
                symbol = pos['symbol']
                emir_fiyat = 0
                
                # JFIN ile BIREBIR aynƒ± mantƒ±k - calculate_order_price metodunu kopyala
                print(f"[KARBOTU DEBUG] üîç {symbol} JFIN mantƒ±ƒüƒ± ile fiyat hesaplanƒ±yor...")
                
                # JFIN'in calculate_order_price metodunu kopyala - AYNI MANTIK
                # Ana sayfadan market data al (JFIN ile TAMAMEN AYNI)
                market_data = None
                
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                    if not market_data:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} market_data bo≈ü - JFIN gibi N/A d√∂nd√ºr√ºl√ºyor")
                        continue
                else:
                    emir_fiyat = 0
                    print(f"[KARBOTU] ‚ùå {symbol} Hammer yok - JFIN gibi N/A d√∂nd√ºr√ºl√ºyor")
                    continue
                
                bid = float(market_data.get('bid', 0))
                ask = float(market_data.get('ask', 0))
                last = float(market_data.get('last', 0))
                
                print(f"[KARBOTU DEBUG] üìä {symbol} JFIN market_data: bid=${bid:.2f}, ask=${ask:.2f}, last=${last:.2f}")
                
                # JFIN'in tam mantƒ±ƒüƒ±nƒ± kopyala
                if order_type == "Bid Buy":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)
                        print(f"[KARBOTU] ‚úÖ {symbol} Bid Buy (JFIN): bid=${bid:.2f} + spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} Bid Buy: bid/ask deƒüerleri ge√ßersiz")
                elif order_type == "Ask Sell":
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                        print(f"[KARBOTU] ‚úÖ {symbol} Ask Sell (JFIN): ask=${ask:.2f} - spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} Ask Sell: bid/ask deƒüerleri ge√ßersiz")
                elif order_type == "Front Buy":
                    if last > 0:
                        emir_fiyat = last + 0.01
                        print(f"[KARBOTU] ‚úÖ {symbol} Front Buy (JFIN): last=${last:.2f} + 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} Front Buy: last deƒüeri ge√ßersiz")
                elif order_type == "Front Sell":
                    if last > 0:
                        emir_fiyat = last - 0.01
                        print(f"[KARBOTU] ‚úÖ {symbol} Front Sell (JFIN): last=${last:.2f} - 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} Front Sell: last deƒüeri ge√ßersiz")
                elif order_type == "SoftFront Buy":
                    if last > 0:
                        emir_fiyat = last + 0.01
                        print(f"[KARBOTU] ‚úÖ {symbol} SoftFront Buy (JFIN): last=${last:.2f} + 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} SoftFront Buy: last deƒüeri ge√ßersiz")
                elif order_type == "SoftFront Sell":
                    if last > 0:
                        emir_fiyat = last - 0.01
                        print(f"[KARBOTU] ‚úÖ {symbol} SoftFront Sell (JFIN): last=${last:.2f} - 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} SoftFront Sell: last deƒüeri ge√ßersiz")
                elif order_type == "Bid Sell":
                    if bid > 0:
                        emir_fiyat = bid - 0.01
                        print(f"[KARBOTU] ‚úÖ {symbol} Bid Sell (JFIN): bid=${bid:.2f} - 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} Bid Sell: bid deƒüeri ge√ßersiz")
                elif order_type == "Ask Buy":
                    if ask > 0:
                        emir_fiyat = ask + 0.01
                        print(f"[KARBOTU] ‚úÖ {symbol} Ask Buy (JFIN): ask=${ask:.2f} + 0.01 = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} Ask Buy: ask deƒüeri ge√ßersiz")
                else:
                    # Bilinmeyen emir tipi i√ßin Ask Sell form√ºl√º kullan
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)
                        print(f"[KARBOTU] ‚úÖ {symbol} {order_type} (JFIN default): ask=${ask:.2f} - spread*0.15=${spread*0.15:.2f} = ${emir_fiyat:.2f}")
                    else:
                        emir_fiyat = 0
                        print(f"[KARBOTU] ‚ùå {symbol} {order_type}: bid/ask deƒüerleri ge√ßersiz")
                
                pos_tree.insert('', 'end', values=(
                    pos['symbol'],
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['fbtot']:.2f}",
                    f"${pos['ask_sell_pahalilik']:.4f}",
                    f"${emir_fiyat:.2f}"
                ))
                
                # ‚úÖ Fƒ∞YAT VE LOT DEPOSAYA KAYDET
                if emir_fiyat > 0 and lot_qty != 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
                    print(f"[KARBOTU] ‚úÖ {symbol} depoya kaydedildi: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
                else:
                    print(f"[KARBOTU] ‚ö†Ô∏è {symbol} ge√ßersiz: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
            
            # Butonlar
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                """Onay verildi - Emirleri g√∂nder - DEPODAN Fƒ∞YATLARI KULLAN"""
                try:
                    print(f"[KARBOTU] üîÑ {step_name} emirleri g√∂nderiliyor...")
                    self.log_message(f"üîÑ {step_name} emirleri g√∂nderiliyor...")
                    
                    # ‚úÖ DEPODAN Fƒ∞YATLARI KULLAN - Market data √ßekme YOK
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        # ‚úÖ Minimum 200 lot kontrol√º - 200'den azsa skip et
                        if abs(lot_qty) < 200:
                            print(f"[KARBOTU] ‚ö†Ô∏è {symbol}: lot={lot_qty} < 200, atlandƒ±")
                            continue
                        
                        print(f"[KARBOTU] üì§ {symbol}: fiyat=${emir_fiyat:.2f}, lot={lot_qty}")
                        
                        # Emir g√∂nder
                        if self.mode_manager.is_hammer_mode():
                            # Hammer Pro - Symbol d√∂n√º≈ü√ºm√º
                            hammer_symbol = symbol.replace(" PR", "-")
                            
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="SELL",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                
                                if success or "new order sent" in str(success):
                                    print(f"[KARBOTU] ‚úÖ {symbol} ‚Üí {hammer_symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                                else:
                                    print(f"[KARBOTU] ‚ùå {symbol} ‚Üí {hammer_symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                            except Exception as e:
                                if "new order sent" in str(e).lower():
                                    print(f"[KARBOTU] ‚úÖ {symbol} ‚Üí {hammer_symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f} (new order sent)")
                                else:
                                    print(f"[KARBOTU] ‚ùå {symbol} ‚Üí {hammer_symbol}: {e}")
                        else:
                            # IBKR
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="SELL",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT",
                                hidden=True
                            )
                            
                            if success:
                                print(f"[KARBOTU] ‚úÖ {symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                            else:
                                print(f"[KARBOTU] ‚ùå {symbol}: SELL {lot_qty} lot @ ${emir_fiyat:.2f}")
                    
                    print(f"[KARBOTU] ‚úÖ {step_name} emirleri g√∂nderildi")
                    self.log_message(f"‚úÖ {step_name} emirleri g√∂nderildi")
                    
                    # Pencereyi hemen kapat (i≈üi bitti)
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    
                    # Popup'larƒ± kapat
                    self.addnewpos_close_messagebox()
                    if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                        self.runall_auto_confirm_messagebox()
                    
                    # Sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile - adƒ±mlar sƒ±ralƒ± ilerlesin)
                    self.after(500, self.karbotu_proceed_to_next_step)
                    
                except Exception as e:
                    print(f"[KARBOTU] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    self.log_message(f"‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    # Hata olsa bile pencereyi kapat
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    # Sonraki adƒ±ma ge√ß
                    self.after(500, self.karbotu_proceed_to_next_step)
            
            def on_cancel():
                """ƒ∞ptal edildi"""
                print(f"[KARBOTU] ‚ùå {step_name} iptal edildi")
                self.log_message(f"‚ùå {step_name} iptal edildi")
                confirm_win.destroy()
                # Sonraki adƒ±ma ge√ß (kƒ±sa bir bekleme ile - adƒ±mlar sƒ±ralƒ± ilerlesin)
                self.after(1000, self.karbotu_proceed_to_next_step)
            
            def save_to_trades_csv():
                """Se√ßili emirleri trades.csv formatƒ±nda kaydet"""
                try:
                    print(f"[KARBOTU CSV] üîÑ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    self.log_message(f"üîÑ {len(positions)} emir trades.csv'ye kaydediliyor...")
                    
                    # CSV satƒ±rlarƒ±
                    csv_rows = []
                    
                    # PENCERE'DEKƒ∞ tablodan verileri al (zaten hesaplanmƒ±≈ü fiyatlar var)
                    for item in pos_tree.get_children():
                        values = pos_tree.item(item)['values']
                        symbol = values[0]
                        qty = float(values[1])
                        lot_qty = float(values[2])
                        
                        # Emir fiyatƒ±nƒ± PENCERE'DEKƒ∞ DEƒûERDEN al (zaten hesaplanmƒ±≈ü)
                        emir_fiyat_str = values[5]  # "Emir Fiyat" kolonu
                        try:
                            # $ i≈üaretini ve format karakterlerini temizle
                            emir_fiyat = float(str(emir_fiyat_str).replace('$', '').replace(',', '').strip())
                            print(f"[KARBOTU CSV] ‚úÖ {symbol}: Emir fiyatƒ± pencereden alƒ±ndƒ±: ${emir_fiyat:.2f}")
                        except (ValueError, TypeError, IndexError):
                            print(f"[KARBOTU CSV] ‚ùå {symbol}: Emir fiyatƒ± okunamadƒ±: {emir_fiyat_str}")
                            emir_fiyat = 0
                            continue
                        
                        # Lot ve fiyat ZATEN PENCREDEN ALINDI - market data √ßekmeye GEREK YOK!
                        # Minimum lot kontrol√º
                        if abs(lot_qty) < 200:
                            continue
                        
                        # CSV'ye kaydet (fiyat ve lot zaten hazƒ±r)
                        if emir_fiyat > 0:
                            # CSV formatƒ± (orijinal format)
                            csv_row = [
                                'SELL',                    # Action
                                int(lot_qty),             # Quantity
                                symbol,                    # Symbol
                                'STK',                    # SecType
                                'SMART/AMEX',              # Exchange
                                'USD',                    # Currency
                                'DAY',                    # TimeInForce
                                'LMT',                    # OrderType
                                f"{emir_fiyat:.2f}",      # LmtPrice
                                'Basket',                 # BasketTag
                                'U21016730',              # Account
                                'Basket',                 # OrderRef
                                'TRUE',                   # Hidden
                                'TRUE'                    # OutsideRth
                            ]
                            
                            csv_rows.append(csv_row)
                            print(f"[KARBOTU CSV] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    if csv_rows:
                        # CSV dosyasƒ±na kaydet
                        import csv
                        
                        csv_filename = 'trades.csv'
                        
                        # Dosyayƒ± sƒ±fƒ±rdan yaz (write mode)
                        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
                            writer = csv.writer(csvfile)
                            
                            # Ba≈ülƒ±k satƒ±rƒ± (orijinal format)
                            writer.writerow(['Action', 'Quantity', 'Symbol', 'SecType', 'Exchange', 'Currency', 'TimeInForce', 'OrderType', 'LmtPrice', 'BasketTag', 'Account', 'OrderRef', 'Hidden', 'OutsideRth'])
                            
                            # Emir satƒ±rlarƒ±
                            writer.writerows(csv_rows)
                        
                        print(f"[KARBOTU CSV] ‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        self.log_message(f"‚úÖ {len(csv_rows)} emir trades.csv'ye kaydedildi")
                        messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(csv_rows)} emir trades.csv'ye kaydedildi!")
                    else:
                        messagebox.showwarning("Uyarƒ±", "Kaydedilecek ge√ßerli emir bulunamadƒ±!")
                        
                except Exception as e:
                    print(f"[KARBOTU CSV] ‚ùå Kaydetme hatasƒ±: {e}")
                    self.log_message(f"‚ùå Kaydetme hatasƒ±: {e}")
                    messagebox.showerror("Hata", f"trades.csv kaydetme hatasƒ±: {e}")
            
            ttk.Button(button_frame, text="Emirleri G√∂nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="trades.csv'ye Kaydet", command=save_to_trades_csv).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Onay penceresi hatasƒ±: {e}")
            self.log_message(f"‚ùå Onay penceresi hatasƒ±: {e}")
    
    def karbotu_gort_send_orders_direct_longs(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort Longs: Emirleri direkt g√∂nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[KARBOTU GORT] üîÑ {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            self.log_message(f"üîÑ KARBOTU Gort {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (pozitif)
                
                # √ñzel lot hesaplama: %10 ama min 200 lot, eƒüer eldeki lot < 200 ise eldeki lotun tamamƒ±
                calculated_lot = qty * (lot_percentage / 100)  # %10 hesapla
                
                if qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamƒ±
                    lot_qty = int(qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %10 hesaplanan deƒüer 200'den k√º√ß√ºkse ‚Üí 200 lot (min 200 kuralƒ±)
                        lot_qty = 200
                    else:
                        # %10 hesaplanan deƒüer 200'den b√ºy√ºk veya e≈üitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrol√º (yuvarlama sonrasƒ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)  # Ask Sell
                
                # YENƒ∞ KURAL Sƒ∞STEMƒ∞: REDUCE limitleri (BefQty/Portf√∂y oranƒ±na g√∂re)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                
                # G√ºnl√ºk reduce limitini hesapla
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                # Mevcut pozisyon ve a√ßƒ±k emirler
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                
                # G√ºnl√ºk deƒüi≈üim
                current_daily_change = abs(current_potential - befday_qty)
                
                # Kalan g√ºnl√ºk hak
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                # Emir miktarƒ±nƒ± kontrol et ve gerekirse ayarla
                if not is_unlimited and lot_qty > remaining_allowance:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[KARBOTU GORT] ‚ö†Ô∏è {symbol}: G√ºnl√ºk limit doldu, emir atlandƒ±")
                        continue
                    lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs(current_qty))
                    print(f"[KARBOTU GORT] üìä {symbol}: Emir miktarƒ± ayarlandƒ± ‚Üí {lot_qty} lot")
                
                # Ters pozisyona ge√ßi≈ü kontrol√º
                new_potential = current_potential - lot_qty
                if befday_qty > 0 and new_potential < 0:
                    lot_qty = int(current_potential)
                    print(f"[KARBOTU GORT] ‚ö†Ô∏è {symbol}: Ters poz. yasak, lot ayarlandƒ± ‚Üí {lot_qty}")
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri g√∂nder
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="SELL",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success:
                            print(f"[KARBOTU GORT] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                            self.log_message(f"‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                    except Exception as e:
                        print(f"[KARBOTU GORT] ‚ùå {symbol} emir hatasƒ±: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="SELL",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT"
                    )
                    if success:
                        print(f"[KARBOTU GORT] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                        self.log_message(f"‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
            
            print(f"[KARBOTU GORT] ‚úÖ {len(order_data)} emir g√∂nderildi")
            self.log_message(f"‚úÖ KARBOTU Gort {step_name}: {len(order_data)} emir g√∂nderildi")
            
            # Sonraki adƒ±ma ge√ß (Gort kontrol√º bitince adƒ±m 2'ye ge√ßilecek)
            self.after(500, self.karbotu_step_2_fbtot_lt_110)
            
        except Exception as e:
            print(f"[KARBOTU GORT] ‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            self.log_message(f"‚ùå KARBOTU Gort direkt emir g√∂nderme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß
            self.after(500, self.karbotu_step_2_fbtot_lt_110)
    
    def karbotu_gort_send_orders_direct_shorts(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort Shorts: Emirleri direkt g√∂nder (Allowed modunda onay penceresi olmadan)"""
        try:
            print(f"[KARBOTU GORT] üîÑ {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            self.log_message(f"üîÑ KARBOTU Gort {step_name} emirleri direkt g√∂nderiliyor (Allowed modu)...")
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (negatif, √∂rn: -276)
                abs_qty = abs(qty)  # Mutlak deƒüer
                
                # √ñzel lot hesaplama: %10 ama min 200 lot, eƒüer eldeki lot < 200 ise eldeki lotun tamamƒ±
                calculated_lot = abs_qty * (lot_percentage / 100)  # %10 hesapla
                
                if abs_qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamƒ±
                    lot_qty = int(abs_qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %10 hesaplanan deƒüer 200'den k√º√ß√ºkse ‚Üí 200 lot (min 200 kuralƒ±)
                        lot_qty = 200
                    else:
                        # %10 hesaplanan deƒüer 200'den b√ºy√ºk veya e≈üitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrol√º (yuvarlama sonrasƒ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # YENƒ∞ KURAL Sƒ∞STEMƒ∞: REDUCE limitleri (Shorts i√ßin)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                current_daily_change = abs(current_potential - befday_qty)
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                if not is_unlimited and lot_qty > remaining_allowance:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[KARBOTU GORT SHORTS] ‚ö†Ô∏è {symbol}: G√ºnl√ºk limit doldu, emir atlandƒ±")
                        continue
                    lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs_qty)
                    print(f"[KARBOTU GORT SHORTS] üìä {symbol}: Emir miktarƒ± ayarlandƒ± ‚Üí {lot_qty} lot")
                
                # Ters pozisyona ge√ßi≈ü kontrol√º (short iken long'a ge√ßi≈ü yasak)
                new_potential = current_potential + lot_qty  # BUY emri ekleniyor
                if befday_qty < 0 and new_potential > 0:
                    lot_qty = int(abs(current_potential))
                    print(f"[KARBOTU GORT SHORTS] ‚ö†Ô∏è {symbol}: Ters poz. yasak, lot ayarlandƒ± ‚Üí {lot_qty}")
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)  # Bid Buy
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri g√∂nder
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success:
                            print(f"[KARBOTU GORT] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                            self.log_message(f"‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                    except Exception as e:
                        print(f"[KARBOTU GORT] ‚ùå {symbol} emir hatasƒ±: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT"
                    )
                    if success:
                        print(f"[KARBOTU GORT] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                        self.log_message(f"‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
            
            print(f"[KARBOTU GORT] ‚úÖ {len(order_data)} emir g√∂nderildi")
            self.log_message(f"‚úÖ KARBOTU Gort {step_name}: {len(order_data)} emir g√∂nderildi")
            
            # Sonraki adƒ±ma ge√ß (Gort kontrol√º bitince sonraki adƒ±ma ge√ßilecek)
            self.after(500, self.karbotu_proceed_to_next_step)
            
        except Exception as e:
            print(f"[KARBOTU GORT] ‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            self.log_message(f"‚ùå KARBOTU Gort direkt emir g√∂nderme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß
            self.after(500, self.karbotu_proceed_to_next_step)
    
    def karbotu_gort_show_confirmation_window_longs(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort: Longs i√ßin √∂zel lot hesaplama ile onay penceresi"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrol√º
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU GORT] ‚úÖ Allowed modu aktif - Onay penceresi atlanƒ±yor, emirler direkt g√∂nderiliyor")
                self.log_message(f"‚úÖ Allowed modu: {step_name} (GORT Longs) - Emirler otomatik g√∂nderiliyor")
                # Emirleri direkt g√∂nder (onay penceresi a√ßmadan)
                self.karbotu_gort_send_orders_direct_longs(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[KARBOTU GORT] üîÑ Onay penceresi a√ßƒ±lƒ±yor: {step_name}")
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"KARBOTU GORT - {step_name}")
            confirm_win.geometry("700x500")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"KARBOTU GORT - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - √ñzel Lot Hesaplama (Min 200 lot veya eldeki lotun tamamƒ±)", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon se√ßildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Eldeki Lot', 'Hesaplanan Lot', 'Gort', 'Ask Sell Pahalƒ±lƒ±k', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=15)
            
            col_widths = {'Symbol': 80, 'Eldeki Lot': 80, 'Hesaplanan Lot': 100, 'Gort': 60, 'Ask Sell Pahalƒ±lƒ±k': 120, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (pozitif)
                
                # √ñzel lot hesaplama: %10 ama min 200 lot, eƒüer eldeki lot < 200 ise eldeki lotun tamamƒ±
                calculated_lot = qty * (lot_percentage / 100)  # %10 hesapla
                
                if qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamƒ±
                    lot_qty = int(qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %10 hesaplanan deƒüer 200'den k√º√ß√ºkse ‚Üí 200 lot (min 200 kuralƒ±)
                        lot_qty = 200
                    else:
                        # %10 hesaplanan deƒüer 200'den b√ºy√ºk veya e≈üitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrol√º (yuvarlama sonrasƒ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)  # Ask Sell
                
                pos_tree.insert('', 'end', values=(
                    symbol,
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['gort']:.2f}",
                    f"${pos['ask_sell_pahalilik']:.4f}",
                    f"${emir_fiyat:.2f}" if emir_fiyat > 0 else "N/A"
                ))
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[KARBOTU GORT] üîÑ {step_name} emirleri g√∂nderiliyor...")
                    self.log_message(f"üîÑ KARBOTU Gort {step_name} emirleri g√∂nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="SELL",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                if success:
                                    print(f"[KARBOTU GORT] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                    self.log_message(f"‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                            except Exception as e:
                                print(f"[KARBOTU GORT] ‚ùå {symbol} emir hatasƒ±: {e}")
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="SELL",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT"
                            )
                            if success:
                                print(f"[KARBOTU GORT] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                self.log_message(f"‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    print(f"[KARBOTU GORT] ‚úÖ {len(order_data)} emir g√∂nderildi")
                    self.log_message(f"‚úÖ KARBOTU Gort {step_name}: {len(order_data)} emir g√∂nderildi")
                    
                    # Pencereyi hemen kapat (i≈üi bitti)
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    
                    # Messagebox g√∂sterme (Allowed modunda otomatik kapanacak)
                    if not (hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode):
                        # Allowed modu kapalƒ±ysa messagebox g√∂ster
                        self.after(100, lambda: messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(order_data)} emir g√∂nderildi!"))
                    
                    # Sonraki adƒ±ma ge√ß (Gort kontrol√º bitince adƒ±m 2'ye ge√ßilecek)
                    self.after(500, self.karbotu_step_2_fbtot_lt_110)
                    
                except Exception as e:
                    print(f"[KARBOTU GORT] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    self.log_message(f"‚ùå KARBOTU Gort emir g√∂nderme hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile pencereyi kapat
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    # Sonraki adƒ±ma ge√ß
                    self.after(500, self.karbotu_step_2_fbtot_lt_110)
            
            def on_cancel():
                # Pencereyi kapat
                try:
                    if confirm_win.winfo_exists():
                        confirm_win.destroy()
                except:
                    pass
                # Sonraki adƒ±ma ge√ß
                self.after(500, self.karbotu_step_2_fbtot_lt_110)
            
            ttk.Button(button_frame, text="Emirleri G√∂nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KARBOTU GORT] ‚ùå Onay penceresi hatasƒ±: {e}")
            self.log_message(f"‚ùå KARBOTU Gort onay penceresi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def karbotu_gort_show_confirmation_window_shorts(self, positions, order_type, lot_percentage, step_name):
        """KARBOTU Gort: Shorts i√ßin √∂zel lot hesaplama ile onay penceresi"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrol√º
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[KARBOTU GORT] ‚úÖ Allowed modu aktif - Onay penceresi atlanƒ±yor, emirler direkt g√∂nderiliyor")
                self.log_message(f"‚úÖ Allowed modu: {step_name} (GORT Shorts) - Emirler otomatik g√∂nderiliyor")
                # Emirleri direkt g√∂nder (onay penceresi a√ßmadan)
                self.karbotu_gort_send_orders_direct_shorts(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[KARBOTU GORT] üîÑ Onay penceresi a√ßƒ±lƒ±yor: {step_name}")
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"KARBOTU GORT - {step_name}")
            confirm_win.geometry("700x500")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"KARBOTU GORT - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - √ñzel Lot Hesaplama (Min 200 lot veya eldeki lotun tamamƒ±)", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon se√ßildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Eldeki Lot', 'Hesaplanan Lot', 'Gort', 'Bid Buy Ucuzluk', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=15)
            
            col_widths = {'Symbol': 80, 'Eldeki Lot': 80, 'Hesaplanan Lot': 100, 'Gort': 60, 'Bid Buy Ucuzluk': 120, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (negatif, √∂rn: -276)
                abs_qty = abs(qty)  # Mutlak deƒüer
                
                # √ñzel lot hesaplama: %10 ama min 200 lot, eƒüer eldeki lot < 200 ise eldeki lotun tamamƒ±
                calculated_lot = abs_qty * (lot_percentage / 100)  # %10 hesapla
                
                if abs_qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamƒ±
                    lot_qty = int(abs_qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %10 hesaplanan deƒüer 200'den k√º√ß√ºkse ‚Üí 200 lot (min 200 kuralƒ±)
                        lot_qty = 200
                    else:
                        # %10 hesaplanan deƒüer 200'den b√ºy√ºk veya e≈üitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrol√º (yuvarlama sonrasƒ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)  # Bid Buy
                
                pos_tree.insert('', 'end', values=(
                    symbol,
                    f"{abs_qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['gort']:.2f}",
                    f"${pos['bid_buy_ucuzluk']:.4f}",
                    f"${emir_fiyat:.2f}" if emir_fiyat > 0 else "N/A"
                ))
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[KARBOTU GORT] üîÑ {step_name} emirleri g√∂nderiliyor...")
                    self.log_message(f"üîÑ KARBOTU Gort {step_name} emirleri g√∂nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="BUY",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                if success:
                                    print(f"[KARBOTU GORT] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                    self.log_message(f"‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                            except Exception as e:
                                print(f"[KARBOTU GORT] ‚ùå {symbol} emir hatasƒ±: {e}")
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="BUY",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT"
                            )
                            if success:
                                print(f"[KARBOTU GORT] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                self.log_message(f"‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    print(f"[KARBOTU GORT] ‚úÖ {len(order_data)} emir g√∂nderildi")
                    self.log_message(f"‚úÖ KARBOTU Gort {step_name}: {len(order_data)} emir g√∂nderildi")
                    
                    # Pencereyi hemen kapat (i≈üi bitti)
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    
                    # Messagebox g√∂sterme (Allowed modunda otomatik kapanacak)
                    if not (hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode):
                        # Allowed modu kapalƒ±ysa messagebox g√∂ster
                        self.after(100, lambda: messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(order_data)} emir g√∂nderildi!"))
                    
                    # Sonraki adƒ±ma ge√ß (Gort kontrol√º bitince sonraki adƒ±ma ge√ßilecek)
                    self.after(500, self.karbotu_proceed_to_next_step)
                    
                except Exception as e:
                    print(f"[KARBOTU GORT] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    self.log_message(f"‚ùå KARBOTU Gort emir g√∂nderme hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile pencereyi kapat
                    try:
                        if confirm_win.winfo_exists():
                            confirm_win.destroy()
                    except:
                        pass
                    # Sonraki adƒ±ma ge√ß
                    self.after(500, self.karbotu_proceed_to_next_step)
            
            def on_cancel():
                # Pencereyi kapat
                try:
                    if confirm_win.winfo_exists():
                        confirm_win.destroy()
                except:
                    pass
                # Sonraki adƒ±ma ge√ß
                self.after(500, self.karbotu_proceed_to_next_step)
            
            ttk.Button(button_frame, text="Emirleri G√∂nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[KARBOTU GORT] ‚ùå Onay penceresi hatasƒ±: {e}")
            self.log_message(f"‚ùå KARBOTU Gort onay penceresi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def reducemore_gort_show_confirmation_window_longs(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Longs i√ßin √∂zel lot hesaplama ile onay penceresi"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrol√º
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[REDUCEMORE GORT] ‚úÖ Allowed modu aktif - Onay penceresi atlanƒ±yor, emirler direkt g√∂nderiliyor")
                self.log_message(f"‚úÖ Allowed modu: {step_name} (GORT Longs) - Emirler otomatik g√∂nderiliyor")
                # Emirleri direkt g√∂nder (onay penceresi a√ßmadan)
                self.reducemore_gort_send_orders_direct_longs(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[REDUCEMORE GORT] üîÑ Onay penceresi a√ßƒ±lƒ±yor: {step_name}")
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"REDUCEMORE GORT - {step_name}")
            confirm_win.geometry("700x500")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"REDUCEMORE GORT - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - √ñzel Lot Hesaplama (Min 200 lot veya eldeki lotun tamamƒ±)", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon se√ßildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Eldeki Lot', 'Hesaplanan Lot', 'Gort', 'Ask Sell Pahalƒ±lƒ±k', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=15)
            
            col_widths = {'Symbol': 80, 'Eldeki Lot': 80, 'Hesaplanan Lot': 100, 'Gort': 60, 'Ask Sell Pahalƒ±lƒ±k': 120, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_longs_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (pozitif)
                
                # √ñzel lot hesaplama: %20 ama min 200 lot, eƒüer eldeki lot < 200 ise eldeki lotun tamamƒ±
                calculated_lot = qty * (lot_percentage / 100)  # %20 hesapla
                
                if qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamƒ±
                    lot_qty = int(qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %20 hesaplanan deƒüer 200'den k√º√ß√ºkse ‚Üí 200 lot (min 200 kuralƒ±)
                        lot_qty = 200
                    else:
                        # %20 hesaplanan deƒüer 200'den b√ºy√ºk veya e≈üitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrol√º (yuvarlama sonrasƒ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = ask - (spread * 0.15)  # Ask Sell
                
                pos_tree.insert('', 'end', values=(
                    symbol,
                    f"{qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['gort']:.2f}",
                    f"${pos['ask_sell_pahalilik']:.4f}",
                    f"${emir_fiyat:.2f}" if emir_fiyat > 0 else "N/A"
                ))
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[REDUCEMORE GORT] üîÑ {step_name} emirleri g√∂nderiliyor...")
                    self.log_message(f"üîÑ REDUCEMORE Gort {step_name} emirleri g√∂nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="SELL",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                if success:
                                    print(f"[REDUCEMORE GORT] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                    self.log_message(f"‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                            except Exception as e:
                                print(f"[REDUCEMORE GORT] ‚ùå {symbol} emir hatasƒ±: {e}")
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="SELL",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT"
                            )
                            if success:
                                print(f"[REDUCEMORE GORT] ‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                                self.log_message(f"‚úÖ {symbol}: SELL {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    print(f"[REDUCEMORE GORT] ‚úÖ {len(order_data)} emir g√∂nderildi")
                    self.log_message(f"‚úÖ REDUCEMORE Gort {step_name}: {len(order_data)} emir g√∂nderildi")
                    
                    confirm_win.destroy()
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(order_data)} emir g√∂nderildi!")
                    
                    # Sonraki adƒ±ma ge√ß (Gort kontrol√º bitince sonraki adƒ±ma ge√ßilecek)
                    self.after(500, self.reduce_more_proceed_to_next_step)
                    
                except Exception as e:
                    print(f"[REDUCEMORE GORT] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    self.log_message(f"‚ùå REDUCEMORE Gort emir g√∂nderme hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile sonraki adƒ±ma ge√ß
                    self.after(500, self.reduce_more_proceed_to_next_step)
            
            def on_cancel():
                confirm_win.destroy()
                # ƒ∞ptal edildiƒüinde de sonraki adƒ±ma ge√ß
                self.after(500, self.reduce_more_proceed_to_next_step)
            
            ttk.Button(button_frame, text="Emirleri G√∂nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] ‚ùå Onay penceresi hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE Gort onay penceresi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß
            self.after(500, self.reduce_more_proceed_to_next_step)
    
    def reducemore_gort_send_orders_direct_shorts(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Shorts i√ßin direkt emir g√∂nderme (Allowed modu i√ßin)"""
        try:
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (negatif, √∂rn: -276)
                abs_qty = abs(qty)  # Mutlak deƒüer
                
                # √ñzel lot hesaplama: %20 ama min 200 lot, eƒüer eldeki lot < 200 ise eldeki lotun tamamƒ±
                calculated_lot = abs_qty * (lot_percentage / 100)  # %20 hesapla
                
                if abs_qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamƒ±
                    lot_qty = int(abs_qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %20 hesaplanan deƒüer 200'den k√º√ß√ºkse ‚Üí 200 lot (min 200 kuralƒ±)
                        lot_qty = 200
                    else:
                        # %20 hesaplanan deƒüer 200'den b√ºy√ºk veya e≈üitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrol√º (yuvarlama sonrasƒ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # YENƒ∞ KURAL Sƒ∞STEMƒ∞: REDUCE limitleri (Shorts i√ßin)
                maxalw = self.get_maxalw_for_symbol(symbol)
                befday_qty = self.load_bef_position(symbol)
                daily_limit, limit_reason, is_unlimited = self.get_reduce_limit(symbol, maxalw, befday_qty)
                
                current_qty = qty
                open_orders_qty = self.get_open_orders_sum(symbol, use_cache=True)
                current_potential = current_qty + open_orders_qty
                current_daily_change = abs(current_potential - befday_qty)
                remaining_allowance = max(0, daily_limit - current_daily_change)
                
                if not is_unlimited and lot_qty > remaining_allowance:
                    if remaining_allowance < self.rule_min_lot:
                        print(f"[REDUCEMORE GORT SHORTS] ‚ö†Ô∏è {symbol}: G√ºnl√ºk limit doldu, emir atlandƒ±")
                        continue
                    lot_qty = self.round_lot(remaining_allowance, is_reduce=True, remaining_position=abs_qty)
                    print(f"[REDUCEMORE GORT SHORTS] üìä {symbol}: Emir miktarƒ± ayarlandƒ± ‚Üí {lot_qty} lot")
                
                # Ters pozisyona ge√ßi≈ü kontrol√º (short iken long'a ge√ßi≈ü yasak)
                new_potential = current_potential + lot_qty  # BUY emri ekleniyor
                if befday_qty < 0 and new_potential > 0:
                    lot_qty = int(abs(current_potential))
                    print(f"[REDUCEMORE GORT SHORTS] ‚ö†Ô∏è {symbol}: Ters poz. yasak, lot ayarlandƒ± ‚Üí {lot_qty}")
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)  # Bid Buy
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            # Emirleri g√∂nder
            for symbol in order_data:
                data = order_data[symbol]
                emir_fiyat = data['price']
                lot_qty = data['lot']
                
                if self.mode_manager.is_hammer_mode():
                    hammer_symbol = symbol.replace(" PR", "-")
                    try:
                        success = self.hammer.place_order(
                            symbol=hammer_symbol,
                            side="BUY",
                            quantity=lot_qty,
                            price=emir_fiyat,
                            order_type="LIMIT",
                            hidden=True
                        )
                        if success:
                            print(f"[REDUCEMORE GORT] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                            self.log_message(f"‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                    except Exception as e:
                        print(f"[REDUCEMORE GORT] ‚ùå {symbol} emir hatasƒ±: {e}")
                else:
                    success = self.mode_manager.place_order(
                        symbol=symbol,
                        side="BUY",
                        quantity=lot_qty,
                        price=emir_fiyat,
                        order_type="LIMIT"
                    )
                    if success:
                        print(f"[REDUCEMORE GORT] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                        self.log_message(f"‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
            
            print(f"[REDUCEMORE GORT] ‚úÖ {len(order_data)} emir g√∂nderildi")
            self.log_message(f"‚úÖ REDUCEMORE Gort {step_name}: {len(order_data)} emir g√∂nderildi")
            
            # Sonraki adƒ±ma ge√ß (Gort kontrol√º bitince sonraki adƒ±ma ge√ßilecek)
            self.after(500, self.reduce_more_proceed_to_next_step)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] ‚ùå Direkt emir g√∂nderme hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE Gort direkt emir g√∂nderme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß
            self.after(500, self.reduce_more_proceed_to_next_step)
    
    def reducemore_gort_show_confirmation_window_shorts(self, positions, order_type, lot_percentage, step_name):
        """REDUCEMORE Gort: Shorts i√ßin √∂zel lot hesaplama ile onay penceresi"""
        try:
            # RUNALL Allowed modunda otomatik onay kontrol√º
            if hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode:
                print(f"[REDUCEMORE GORT] ‚úÖ Allowed modu aktif - Onay penceresi atlanƒ±yor, emirler direkt g√∂nderiliyor")
                self.log_message(f"‚úÖ Allowed modu: {step_name} (GORT Shorts) - Emirler otomatik g√∂nderiliyor")
                # Emirleri direkt g√∂nder (onay penceresi a√ßmadan)
                self.reducemore_gort_send_orders_direct_shorts(positions, order_type, lot_percentage, step_name)
                return
            
            print(f"[REDUCEMORE GORT] üîÑ Onay penceresi a√ßƒ±lƒ±yor: {step_name}")
            
            # Onay penceresi
            confirm_win = tk.Toplevel(self.psfalgo_window)
            confirm_win.title(f"REDUCEMORE GORT - {step_name}")
            confirm_win.geometry("700x500")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            title_frame = ttk.Frame(confirm_win)
            title_frame.pack(fill='x', padx=10, pady=10)
            
            ttk.Label(title_frame, text=f"REDUCEMORE GORT - {step_name}", font=('Arial', 14, 'bold')).pack()
            ttk.Label(title_frame, text=f"{order_type} - √ñzel Lot Hesaplama (Min 200 lot veya eldeki lotun tamamƒ±)", font=('Arial', 12)).pack()
            ttk.Label(title_frame, text=f"{len(positions)} pozisyon se√ßildi", font=('Arial', 10)).pack()
            
            list_frame = ttk.Frame(confirm_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            columns = ('Symbol', 'Eldeki Lot', 'Hesaplanan Lot', 'Gort', 'Bid Buy Ucuzluk', 'Emir Fiyat')
            pos_tree = ttk.Treeview(list_frame, columns=columns, show='headings', height=15)
            
            col_widths = {'Symbol': 80, 'Eldeki Lot': 80, 'Hesaplanan Lot': 100, 'Gort': 60, 'Bid Buy Ucuzluk': 120, 'Emir Fiyat': 80}
            for col in columns:
                pos_tree.heading(col, text=col)
                pos_tree.column(col, width=col_widths[col])
            
            scrollbar = ttk.Scrollbar(list_frame, orient='vertical', command=pos_tree.yview)
            pos_tree.configure(yscrollcommand=scrollbar.set)
            
            pos_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            order_data = {}
            
            for pos in positions:
                item_values = self.take_profit_shorts_panel_reducemore.tree.item(pos['item'])['values']
                symbol = pos['symbol']
                qty = float(item_values[2])  # Eldeki lot (negatif, √∂rn: -276)
                abs_qty = abs(qty)  # Mutlak deƒüer
                
                # √ñzel lot hesaplama: %20 ama min 200 lot, eƒüer eldeki lot < 200 ise eldeki lotun tamamƒ±
                calculated_lot = abs_qty * (lot_percentage / 100)  # %20 hesapla
                
                if abs_qty < 200:
                    # Eldeki lot < 200 ise eldeki lotun tamamƒ±
                    lot_qty = int(abs_qty)
                else:
                    # Eldeki lot >= 200 ise
                    if calculated_lot < 200:
                        # %20 hesaplanan deƒüer 200'den k√º√ß√ºkse ‚Üí 200 lot (min 200 kuralƒ±)
                        lot_qty = 200
                    else:
                        # %20 hesaplanan deƒüer 200'den b√ºy√ºk veya e≈üitse yuvarlama yap
                        if calculated_lot <= 200:
                            lot_qty = 200
                        elif calculated_lot <= 300:
                            lot_qty = 300
                        elif calculated_lot <= 400:
                            lot_qty = 400
                        elif calculated_lot <= 500:
                            lot_qty = 500
                        else:
                            lot_qty = int((calculated_lot + 99) // 100) * 100
                        # Min 200 kontrol√º (yuvarlama sonrasƒ±)
                        if lot_qty < 200:
                            lot_qty = 200
                
                # Emir fiyatƒ±nƒ± hesapla
                market_data = None
                if hasattr(self, 'hammer') and self.hammer:
                    market_data = self.hammer.get_market_data(symbol)
                
                emir_fiyat = 0
                if market_data:
                    bid = float(market_data.get('bid', 0))
                    ask = float(market_data.get('ask', 0))
                    if bid > 0 and ask > 0:
                        spread = ask - bid
                        emir_fiyat = bid + (spread * 0.15)  # Bid Buy
                
                pos_tree.insert('', 'end', values=(
                    symbol,
                    f"{abs_qty:.0f}",
                    f"{lot_qty:.0f}",
                    f"{pos['gort']:.2f}",
                    f"${pos['bid_buy_ucuzluk']:.4f}",
                    f"${emir_fiyat:.2f}" if emir_fiyat > 0 else "N/A"
                ))
                
                if emir_fiyat > 0 and lot_qty > 0:
                    order_data[symbol] = {'price': emir_fiyat, 'lot': lot_qty}
            
            button_frame = ttk.Frame(confirm_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def on_confirm():
                try:
                    print(f"[REDUCEMORE GORT] üîÑ {step_name} emirleri g√∂nderiliyor...")
                    self.log_message(f"üîÑ REDUCEMORE Gort {step_name} emirleri g√∂nderiliyor...")
                    
                    for symbol in order_data:
                        data = order_data[symbol]
                        emir_fiyat = data['price']
                        lot_qty = data['lot']
                        
                        if self.mode_manager.is_hammer_mode():
                            hammer_symbol = symbol.replace(" PR", "-")
                            try:
                                success = self.hammer.place_order(
                                    symbol=hammer_symbol,
                                    side="BUY",
                                    quantity=lot_qty,
                                    price=emir_fiyat,
                                    order_type="LIMIT",
                                    hidden=True
                                )
                                if success:
                                    print(f"[REDUCEMORE GORT] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                    self.log_message(f"‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                            except Exception as e:
                                print(f"[REDUCEMORE GORT] ‚ùå {symbol} emir hatasƒ±: {e}")
                        else:
                            success = self.mode_manager.place_order(
                                symbol=symbol,
                                side="BUY",
                                quantity=lot_qty,
                                price=emir_fiyat,
                                order_type="LIMIT"
                            )
                            if success:
                                print(f"[REDUCEMORE GORT] ‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                                self.log_message(f"‚úÖ {symbol}: BUY {lot_qty} @ ${emir_fiyat:.2f}")
                    
                    print(f"[REDUCEMORE GORT] ‚úÖ {len(order_data)} emir g√∂nderildi")
                    self.log_message(f"‚úÖ REDUCEMORE Gort {step_name}: {len(order_data)} emir g√∂nderildi")
                    
                    confirm_win.destroy()
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{len(order_data)} emir g√∂nderildi!")
                    
                    # Sonraki adƒ±ma ge√ß (Gort kontrol√º bitince sonraki adƒ±ma ge√ßilecek)
                    self.after(500, self.reduce_more_proceed_to_next_step)
                    
                except Exception as e:
                    print(f"[REDUCEMORE GORT] ‚ùå Emir g√∂nderme hatasƒ±: {e}")
                    self.log_message(f"‚ùå REDUCEMORE Gort emir g√∂nderme hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile sonraki adƒ±ma ge√ß
                    self.after(500, self.reduce_more_proceed_to_next_step)
            
            def on_cancel():
                confirm_win.destroy()
                # ƒ∞ptal edildiƒüinde de sonraki adƒ±ma ge√ß
                self.after(500, self.reduce_more_proceed_to_next_step)
            
            ttk.Button(button_frame, text="Emirleri G√∂nder", command=on_confirm, style='Accent.TButton').pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal Et", command=on_cancel).pack(side='right', padx=5)
            
        except Exception as e:
            print(f"[REDUCEMORE GORT] ‚ùå Onay penceresi hatasƒ±: {e}")
            self.log_message(f"‚ùå REDUCEMORE Gort onay penceresi hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile sonraki adƒ±ma ge√ß
            self.after(500, self.reduce_more_proceed_to_next_step)
    
    def karbotu_proceed_to_next_step(self):
        """Sonraki adƒ±ma ge√ß"""
        try:
            if self.karbotu_current_step >= self.karbotu_total_steps:
                self.log_message("üéØ KARBOTU otomasyonu tamamlandƒ±!")
                self.karbotu_running = False
                
                # T√ºm Take Profit pencerelerini kapat
                def close_karbotu_windows():
                    try:
                        # Take Profit Shorts penceresini kapat
                        if hasattr(self, 'take_profit_shorts_panel') and self.take_profit_shorts_panel:
                            try:
                                if hasattr(self.take_profit_shorts_panel, 'win') and self.take_profit_shorts_panel.win.winfo_exists():
                                    self.take_profit_shorts_panel.win.destroy()
                            except:
                                pass
                        
                        # Take Profit Longs penceresini kapat
                        if hasattr(self, 'take_profit_longs_panel') and self.take_profit_longs_panel:
                            try:
                                if hasattr(self.take_profit_longs_panel, 'win') and self.take_profit_longs_panel.win.winfo_exists():
                                    self.take_profit_longs_panel.win.destroy()
                            except:
                                pass
                        
                        # KARBOTU onay pencerelerini kapat
                        for widget in self.winfo_children():
                            try:
                                if isinstance(widget, tk.Toplevel):
                                    title = widget.title()
                                    if 'KARBOTU' in title or 'Emir Onayƒ±' in title:
                                        widget.destroy()
                            except:
                                pass
                    except:
                        pass
                
                # Pencereleri hemen kapat
                close_karbotu_windows()
                
                # RUNALL'dan √ßaƒürƒ±ldƒ±ysa ADDNEWPOS kontrol√º yap (SADECE Bƒ∞R KEZ)
                if hasattr(self, 'runall_waiting_for_karbotu') and self.runall_waiting_for_karbotu:
                    if not hasattr(self, 'runall_addnewpos_triggered') or not self.runall_addnewpos_triggered:
                        self.runall_waiting_for_karbotu = False
                        self.runall_addnewpos_triggered = True  # ƒ∞≈üaretle ki tekrar tetiklenmesin
                        self.after(2000, self.runall_check_karbotu_and_addnewpos)  # 2 saniye sonra kontrol et
                
                return
            
            # Sonraki adƒ±mƒ± √ßaƒüƒ±r
            next_step = self.karbotu_current_step + 1
            
            # GUI'yi g√ºncelle (donmasƒ±nƒ± √∂nle)
            self.update_idletasks()
            
            # Adƒ±m fonksiyonlarƒ±nƒ± mapping
            step_methods = {
                2: self.karbotu_step_2_fbtot_lt_110,
                3: self.karbotu_step_3_fbtot_111_145_low,
                4: self.karbotu_step_4_fbtot_111_145_high,
                5: self.karbotu_step_5_fbtot_146_185_low,
                6: self.karbotu_step_6_fbtot_146_185_high,
                7: self.karbotu_step_7_fbtot_186_210,
                8: self.karbotu_step_8_open_take_profit_shorts,
                9: self.karbotu_step_9_sfstot_170_high,
                10: self.karbotu_step_10_sfstot_140_169_low,
                11: self.karbotu_step_11_sfstot_140_169_high,
                12: self.karbotu_step_12_sfstot_110_139_low,
                13: self.karbotu_step_13_sfstot_110_139_high
            }
            
            if next_step in step_methods:
                self.karbotu_current_step = next_step
                # Sonraki adƒ±mƒ± non-blocking olarak √ßaƒüƒ±r (GUI donmasƒ±nƒ± √∂nle)
                self.after(200, step_methods[next_step])
            else:
                print(f"[KARBOTU] ‚ö†Ô∏è Adƒ±m {next_step} hen√ºz implement edilmedi")
                self.log_message(f"‚ö†Ô∏è Adƒ±m {next_step} hen√ºz implement edilmedi")
                
        except Exception as e:
            print(f"[KARBOTU] ‚ùå Sonraki adƒ±m hatasƒ±: {e}")
            self.log_message(f"‚ùå Sonraki adƒ±m hatasƒ±: {e}")
    
    def runall_check_karbotu_and_addnewpos(self):
        """KARBOTU bitince exposure kontrol√º yap ve ADDNEWPOS tetikle (SADECE Bƒ∞R KEZ)"""
        try:
            # Eƒüer zaten tetiklendiyse tekrar √ßalƒ±≈ütƒ±rma
            if hasattr(self, 'runall_addnewpos_triggered') and self.runall_addnewpos_triggered:
                # Ama hen√ºz start_addnewpos_automation √ßaƒürƒ±lmadƒ±ysa devam et
                if hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started:
                    print("[RUNALL] ‚ö†Ô∏è ADDNEWPOS zaten ba≈ülatƒ±ldƒ±, tekrar tetiklenmeyecek")
                    return
            
            # KARBOTU veya REDUCEMORE hala √ßalƒ±≈üƒ±yorsa tekrar kontrol et
            karbotu_running = hasattr(self, 'karbotu_running') and self.karbotu_running
            reducemore_running = hasattr(self, 'reducemore_running') and self.reducemore_running
            if karbotu_running or reducemore_running:
                self.after(5000, self.runall_check_karbotu_and_addnewpos)
                return
            
            print("[RUNALL] üîç KARBOTU/REDUCEMORE tamamlandƒ±, exposure kontrol√º yapƒ±lƒ±yor...")
            self.log_message("üîç KARBOTU/REDUCEMORE tamamlandƒ±, exposure kontrol√º yapƒ±lƒ±yor...")
            
            # Exposure kontrol√ºn√º thread'de yap (bloklayƒ±cƒ± i≈ülem)
            def check_exposure_thread():
                try:
                    exposure_info = self.check_exposure_limits()
                    pot_total = exposure_info.get('pot_total', 0)
                    pot_max_lot = exposure_info.get('pot_max_lot', 63636)
                    total_lots = exposure_info.get('total_lots', 0)
                    max_lot = exposure_info.get('max_lot', 54545)
                    mode = exposure_info.get('mode', 'UNKNOWN')
                    
                    # UI thread'ine ge√ßi≈ü yaparak ADDNEWPOS kontrol√º yap
                    def process_addnewpos():
                        # Pot Toplam kontrol√º - Limit dolduracak emirler var mƒ±?
                        if mode == "OFANSIF" and pot_total < pot_max_lot:
                            # Eƒüer zaten ba≈ülatƒ±ldƒ±ysa tekrar ba≈ülatma
                            if hasattr(self, 'runall_addnewpos_started') and self.runall_addnewpos_started:
                                print("[RUNALL] ‚ö†Ô∏è ADDNEWPOS zaten ba≈ülatƒ±ldƒ±, tekrar tetiklenmeyecek")
                                self.log_message("‚ö†Ô∏è ADDNEWPOS zaten ba≈ülatƒ±ldƒ±, tekrar tetiklenmeyecek")
                                return
                            
                            available_lot = pot_max_lot - pot_total
                            print(f"[RUNALL] ‚úÖ ADDNEWPOS tetikleniyor: Pot Toplam {pot_total:,} < Pot Max {pot_max_lot:,} (A√ßƒ±labilir: {available_lot:,} lot)")
                            self.log_message(f"‚úÖ ADDNEWPOS tetikleniyor: Pot Toplam {pot_total:,} < Pot Max {pot_max_lot:,} (A√ßƒ±labilir: {available_lot:,} lot)")
                            
                            # ADDNEWPOS'un ba≈ülatƒ±ldƒ±ƒüƒ±nƒ± i≈üaretle
                            self.runall_addnewpos_started = True
                            
                            # ADDNEWPOS'u otomatik ba≈ülat (RUNALL'dan √ßaƒürƒ±ldƒ±ƒüƒ±nƒ± belirt)
                            # ADDNEWPOS bitince callback ekle
                            self.runall_addnewpos_callback_set = True
                            self.after(2000, lambda: self.start_addnewpos_automation(from_runall=True))
                            
                            # Timeout mekanizmasƒ±: Eƒüer ADDNEWPOS 5 dakika i√ßinde tamamlanmazsa otomatik restart yap
                            def addnewpos_timeout():
                                # Eƒüer callback zaten tetiklendiyse (emirler g√∂nderildiyse) timeout'u iptal et
                                if hasattr(self, 'runall_addnewpos_callback_set') and not self.runall_addnewpos_callback_set:
                                    print("[RUNALL] ‚è∞ ADDNEWPOS timeout: Callback zaten tetiklendi, timeout iptal edildi")
                                    return
                                
                                runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                                runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                                should_continue = runall_running or runall_allowed
                                
                                if should_continue:
                                    print("[RUNALL] ‚è∞ ADDNEWPOS timeout (5 dakika): Emirler g√∂nderilmedi, 2 dakika bekleniyor, sonra restart yapƒ±lacak...")
                                    self.log_message("‚è∞ ADDNEWPOS timeout (5 dakika): Emirler g√∂nderilmedi, 2 dakika bekleniyor, sonra restart yapƒ±lacak...")
                                    # 2 dakika bekle, sonra emirleri iptal et
                                    self.after(120000, lambda: self.runall_cancel_orders_and_restart())
                            
                            # 5 dakika sonra timeout kontrol√º yap
                            self.after(300000, addnewpos_timeout)  # 5 dakika = 300000 ms
                        else:
                            print(f"[RUNALL] ‚ÑπÔ∏è ADDNEWPOS gerekmiyor: Mode={mode}, Pot Toplam={pot_total:,}, Pot Max={pot_max_lot:,}")
                            self.log_message(f"‚ÑπÔ∏è ADDNEWPOS gerekmiyor: Mode={mode}, Pot Toplam={pot_total:,}, Pot Max={pot_max_lot:,}")
                            
                            # ADDNEWPOS gerekmiyorsa 2 dakika bekle, sonra emirleri iptal et ve tekrar ba≈üla
                            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                            should_continue = runall_running or runall_allowed
                            
                            if should_continue:
                                print("[RUNALL] üîÑ ADDNEWPOS gerekmiyor, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                                self.log_message("üîÑ ADDNEWPOS gerekmiyor, 2 dakika bekleniyor, sonra emirler iptal edilecek...")
                                # 2 dakika bekle, sonra emirleri iptal et
                                self.after(120000, lambda: self.runall_cancel_orders_and_restart())
                        
                        print("[RUNALL] ‚úÖ RUNALL sƒ±rasƒ± tamamlandƒ±!")
                        self.log_message("‚úÖ RUNALL sƒ±rasƒ± tamamlandƒ±!")
                    
                    # UI thread'ine ge√ßi≈ü yap
                    self.after(0, process_addnewpos)
                    
                except Exception as e:
                    print(f"[RUNALL] ‚ùå Exposure kontrol√º hatasƒ±: {e}")
                    self.log_message(f"‚ùå Exposure kontrol√º hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
            
            # Exposure kontrol√ºn√º thread'de ba≈ülat
            import threading
            exposure_thread = threading.Thread(target=check_exposure_thread, daemon=True)
            exposure_thread.start()
            
            # Not: ADDNEWPOS emirleri g√∂nderildikten sonra callback final_thg_lot_distributor.py'de tetiklenecek
            
        except Exception as e:
            print(f"[RUNALL] ‚ùå KARBOTU sonrasƒ± kontrol hatasƒ±: {e}")
            self.log_message(f"‚ùå KARBOTU sonrasƒ± kontrol hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def runall_cancel_orders_and_restart(self):
        """RUNALL d√∂ng√ºs√º: T√ºm emirleri iptal et ve tekrar ba≈üla (thread'de √ßalƒ±≈üƒ±r)"""
        print("[RUNALL] üóëÔ∏è Emir iptal i≈ülemi ba≈ülatƒ±lƒ±yor...")
        self.log_message("üóëÔ∏è Emir iptal i≈ülemi ba≈ülatƒ±lƒ±yor...")
        
        # Restart flag'ini initialize et
        self._runall_restart_pending = False
        
        def cancel_orders_thread():
            """Emir iptal i≈ülemini thread'de yap"""
            try:
                print("[RUNALL] üóëÔ∏è T√ºm emirleri iptal ediliyor...")
                self.log_message("üóëÔ∏è T√ºm emirleri iptal ediliyor...")
                
                # Aktif modu kontrol et
                if hasattr(self, 'mode_manager'):
                    active_account = self.mode_manager.get_active_account()
                else:
                    if self.hampro_mode:
                        active_account = "HAMPRO"
                    elif self.ibkr_gun_mode:
                        active_account = "IBKR_GUN"
                    elif self.ibkr_ped_mode:
                        active_account = "IBKR_PED"
                    else:
                        active_account = "HAMPRO"
                
                # IBKR modunda: Doƒürudan t√ºm emirleri iptal et (pencere a√ßmadan)
                if active_account in ["IBKR_GUN", "IBKR_PED"]:
                    try:
                        print("[RUNALL] üóëÔ∏è IBKR emirleri doƒürudan iptal ediliyor...")
                        self.log_message("üóëÔ∏è IBKR emirleri doƒürudan iptal ediliyor...")
                        
                        # IBKR client'ƒ± al
                        ibkr_client = None
                        if hasattr(self.mode_manager, 'ibkr_native_client') and self.mode_manager.ibkr_native_client.is_connected():
                            ibkr_client = self.mode_manager.ibkr_native_client
                        elif hasattr(self.mode_manager, 'ibkr_client') and self.mode_manager.ibkr_client.is_connected():
                            ibkr_client = self.mode_manager.ibkr_client
                        
                        if ibkr_client and ibkr_client.is_connected():
                            # A√ßƒ±k emirleri al
                            try:
                                open_orders = []
                                if hasattr(ibkr_client, 'get_open_orders'):
                                    open_orders = ibkr_client.get_open_orders()
                                elif hasattr(ibkr_client, 'get_orders_direct'):
                                    open_orders = ibkr_client.get_orders_direct()
                            except Exception as e:
                                print(f"[RUNALL] ‚ö†Ô∏è Emir alma hatasƒ±: {e}")
                                open_orders = []
                            
                            if open_orders:
                                print(f"[RUNALL] üìä {len(open_orders)} a√ßƒ±k emir bulundu, iptal ediliyor...")
                                cancel_count = 0
                                for order in open_orders:
                                    # D√∂ng√º durdurulmu≈üsa √ßƒ±k (ama runall_allowed_mode aktifse devam et)
                                    runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                                    runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                                    if not runall_running and not runall_allowed:
                                        print("[RUNALL] ‚èπÔ∏è D√∂ng√º durduruldu, emir iptal i≈ülemi durduruluyor")
                                        break
                                    
                                    try:
                                        order_id = order.get('order_id') or order.get('orderId')
                                        if order_id:
                                            if hasattr(ibkr_client, 'cancelOrder'):
                                                ibkr_client.cancelOrder(int(order_id))
                                            elif hasattr(ibkr_client, 'cancel_order'):
                                                ibkr_client.cancel_order(order_id)
                                            cancel_count += 1
                                            print(f"[RUNALL] üì§ ƒ∞ptal isteƒüi g√∂nderildi: {order_id}")
                                    except Exception as e:
                                        print(f"[RUNALL] ‚ö†Ô∏è Emir iptal hatasƒ±: {e}")
                                
                                print(f"[RUNALL] ‚úÖ {cancel_count} emir iptal isteƒüi g√∂nderildi")
                            else:
                                print("[RUNALL] ‚ÑπÔ∏è ƒ∞ptal edilecek emir bulunamadƒ±")
                        else:
                            print("[RUNALL] ‚ùå IBKR baƒülantƒ±sƒ± yok")
                        
                    except Exception as e:
                        print(f"[RUNALL] ‚ùå IBKR emir iptal hatasƒ±: {e}")
                        self.log_message(f"‚ùå IBKR emir iptal hatasƒ±: {e}")
                
                # HAMPRO modunda: Doƒürudan t√ºm emirleri iptal et (pencere a√ßmadan)
                else:  # HAMPRO
                    try:
                        print("[RUNALL] üóëÔ∏è HAMPRO emirleri doƒürudan iptal ediliyor...")
                        self.log_message("üóëÔ∏è HAMPRO emirleri doƒürudan iptal ediliyor...")
                        
                        if self.hammer and self.hammer.connected:
                            try:
                                open_orders = self.hammer.get_orders_direct() if hasattr(self.hammer, 'get_orders_direct') else []
                            except Exception as e:
                                print(f"[RUNALL] ‚ö†Ô∏è Emir alma hatasƒ±: {e}")
                                open_orders = []
                            
                            if open_orders:
                                print(f"[RUNALL] üìä {len(open_orders)} a√ßƒ±k emir bulundu, iptal ediliyor...")
                                cancel_count = 0
                                for order in open_orders:
                                    # D√∂ng√º durdurulmu≈üsa √ßƒ±k (ama runall_allowed_mode aktifse devam et)
                                    runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                                    runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                                    if not runall_running and not runall_allowed:
                                        print("[RUNALL] ‚èπÔ∏è D√∂ng√º durduruldu, emir iptal i≈ülemi durduruluyor")
                                        break
                                    
                                    try:
                                        order_id = order.get('order_id') or order.get('orderId')
                                        if order_id:
                                            if hasattr(self.hammer, 'trade_command_cancel'):
                                                self.hammer.trade_command_cancel("ALARIC:TOPI002240A7", order_id)
                                            cancel_count += 1
                                            print(f"[RUNALL] üì§ ƒ∞ptal isteƒüi g√∂nderildi: {order_id}")
                                    except Exception as e:
                                        print(f"[RUNALL] ‚ö†Ô∏è Emir iptal hatasƒ±: {e}")
                                
                                print(f"[RUNALL] ‚úÖ {cancel_count} emir iptal isteƒüi g√∂nderildi")
                            else:
                                print("[RUNALL] ‚ÑπÔ∏è ƒ∞ptal edilecek emir bulunamadƒ±")
                        else:
                            print("[RUNALL] ‚ùå HAMPRO baƒülantƒ±sƒ± yok")
                        
                    except Exception as e:
                        print(f"[RUNALL] ‚ùå HAMPRO emir iptal hatasƒ±: {e}")
                        self.log_message(f"‚ùå HAMPRO emir iptal hatasƒ±: {e}")
                
                # Thread'den UI thread'ine ge√ßi≈ü yaparak restart'ƒ± ba≈ülat (non-blocking)
                print("[RUNALL] ‚úÖ Emir iptal i≈ülemi tamamlandƒ±, restart flag'i set edildi...")
                self.log_message("‚úÖ Emir iptal i≈ülemi tamamlandƒ±, restart flag'i set edildi...")
                
                # Thread i√ßinde widget metodlarƒ±nƒ± √ßaƒüƒ±rmak thread-safe deƒüil
                # Bunun yerine flag set edelim ve ana thread'de kontrol edelim
                # Flag'i set et (restart i√ßin)
                self._runall_restart_pending = True
                print("[RUNALL] ‚úÖ _runall_restart_pending flag'i True yapƒ±ldƒ±")
                
            except Exception as e:
                print(f"[RUNALL] ‚ùå Emir iptal ve restart hatasƒ±: {e}")
                self.log_message(f"‚ùå Emir iptal ve restart hatasƒ±: {e}")
                import traceback
                traceback.print_exc()
                # Hata olsa bile devam et - UI thread'ine ge√ßi≈ü yap
                try:
                    # after_idle() kullan (thread-safe)
                    self.after_idle(lambda: self.runall_close_orders_window_and_restart(None))
                except:
                    try:
                        self.after(0, lambda: self.runall_close_orders_window_and_restart(None))
                    except:
                        # Hi√ßbiri √ßalƒ±≈ümazsa direkt √ßaƒüƒ±r
                        try:
                            self.runall_close_orders_window_and_restart(None)
                        except:
                            pass
        
        # Emir iptal i≈ülemini thread'de ba≈ülat
        import threading
        thread = threading.Thread(target=cancel_orders_thread, daemon=True)
        thread.start()
        
        # Thread bitince restart yapmak i√ßin kontrol d√∂ng√ºs√º ba≈ülat
        def check_thread_and_restart():
            # runall_allowed_mode aktifse veya _runall_restart_pending True ise devam et
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            restart_pending = hasattr(self, '_runall_restart_pending') and self._runall_restart_pending
            
            print(f"[RUNALL] üîç check_thread_and_restart: restart_pending={restart_pending}, runall_allowed={runall_allowed}, runall_running={runall_running}, thread.is_alive()={thread.is_alive()}")
            
            # Eƒüer ne flag set edilmi≈ü ne de runall_allowed_mode aktifse √ßƒ±k
            if not restart_pending and not runall_allowed:
                print(f"[RUNALL] ‚èπÔ∏è Restart flag'i set edilmemi≈ü ve runall_allowed_mode aktif deƒüil, restart yapƒ±lmayacak")
                return
            
            # Thread hala √ßalƒ±≈üƒ±yor mu kontrol et
            if thread.is_alive():
                # Thread hala √ßalƒ±≈üƒ±yor, tekrar kontrol et
                self.after(500, check_thread_and_restart)
                return
            
            # Thread bitti, restart yap
            print("[RUNALL] ‚úÖ Thread tamamlandƒ±, restart ba≈ülatƒ±lƒ±yor...")
            self.log_message("‚úÖ Thread tamamlandƒ±, restart ba≈ülatƒ±lƒ±yor...")
            self._runall_restart_pending = False
            
            # runall_allowed_mode aktifse runall_loop_running'i True yap
            if runall_allowed and not runall_running:
                self.runall_loop_running = True
                print("[RUNALL] ‚úÖ runall_loop_running True yapƒ±ldƒ± (runall_allowed_mode aktif)")
            
            self.runall_close_orders_window_and_restart(None)
        
        # ƒ∞lk kontrol√º ba≈ülat (500ms sonra)
        self.after(500, check_thread_and_restart)
    
    def start_runall_auto_confirm_loop(self):
        """RUNALL Allowed modunda otomatik onay d√∂ng√ºs√ºn√º ba≈ülat"""
        if not self.runall_allowed_mode or not self.runall_loop_running:
            return
        
        # Tƒ±klanmƒ±≈ü butonlarƒ± ve kapatƒ±lmƒ±≈ü pencereleri takip et (tekrar tƒ±klamayƒ± √∂nlemek i√ßin)
        if not hasattr(self, '_clicked_buttons'):
            self._clicked_buttons = set()
        if not hasattr(self, '_closed_windows'):
            self._closed_windows = set()
        
        # Her 200ms'de bir onay mesajlarƒ±nƒ± kontrol et (daha sƒ±k kontrol)
        self.runall_auto_confirm_messagebox()
        self.after(200, self.start_runall_auto_confirm_loop)
    
    def runall_auto_confirm_messagebox(self):
        """Onay mesajlarƒ±nƒ± otomatik olarak kabul et (Evet/Yes butonuna tƒ±kla)"""
        if not self.runall_allowed_mode:
            return
        
        # Tƒ±klanmƒ±≈ü butonlarƒ± ve kapatƒ±lmƒ±≈ü pencereleri takip et (tekrar tƒ±klamayƒ± √∂nlemek i√ßin)
        if not hasattr(self, '_clicked_buttons'):
            self._clicked_buttons = set()
        if not hasattr(self, '_closed_windows'):
            self._closed_windows = set()
        
        try:
            # T√ºm Toplevel pencereleri bul (daha agresif y√∂ntem)
            all_toplevels = []
            
            # Ana pencereden ba≈üla
            try:
                for widget in self.winfo_children():
                    if isinstance(widget, tk.Toplevel):
                        all_toplevels.append(widget)
            except:
                pass
            
            # Psfalgo penceresinden
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        for widget in self.psfalgo_window.winfo_children():
                            if isinstance(widget, tk.Toplevel):
                                all_toplevels.append(widget)
                except:
                    pass
            
            # Take Profit pencerelerinden
            if hasattr(self, 'take_profit_longs_panel') and hasattr(self.take_profit_longs_panel, 'win'):
                try:
                    if self.take_profit_longs_panel.win.winfo_exists():
                        for widget in self.take_profit_longs_panel.win.winfo_children():
                            if isinstance(widget, tk.Toplevel):
                                all_toplevels.append(widget)
                except:
                    pass
            
            if hasattr(self, 'take_profit_shorts_panel') and hasattr(self.take_profit_shorts_panel, 'win'):
                try:
                    if self.take_profit_shorts_panel.win.winfo_exists():
                        for widget in self.take_profit_shorts_panel.win.winfo_children():
                            if isinstance(widget, tk.Toplevel):
                                all_toplevels.append(widget)
                except:
                    pass
            
            # T√ºm a√ßƒ±k Toplevel pencereleri bul (recursive)
            def find_all_toplevels(parent, found_list, depth=0):
                if depth > 5:  # Recursion limit
                    return
                try:
                    for widget in parent.winfo_children():
                        if isinstance(widget, tk.Toplevel):
                            if widget not in found_list:
                                found_list.append(widget)
                            find_all_toplevels(widget, found_list, depth + 1)
                        else:
                            find_all_toplevels(widget, found_list, depth + 1)
                except:
                    pass
            
            find_all_toplevels(self, all_toplevels)
            
            # T√ºm butonlarƒ± recursive olarak bul (fonksiyon tanƒ±mƒ±)
            def find_all_buttons_recursive(widget, buttons_list, depth=0):
                if depth > 15:  # Recursion limit
                    return
                try:
                    for child in widget.winfo_children():
                        try:
                            if isinstance(child, (tk.Button, ttk.Button)):
                                buttons_list.append(child)
                            find_all_buttons_recursive(child, buttons_list, depth + 1)
                        except:
                            pass
                except:
                    pass
            
            # Her Toplevel penceresinde buton ara
            for toplevel in all_toplevels:
                try:
                    # Pencere hala var mƒ± kontrol et
                    if not toplevel.winfo_exists():
                        continue
                    
                    title = toplevel.title().lower()
                    
                    # "Emir Sonucu" ve "Ba≈üarƒ±lƒ±" (TUMCSV) pencerelerini √∂zel olarak kontrol et
                    if 'emir sonucu' in title or ('ba≈üarƒ±lƒ±' in title):
                        # Bu pencere zaten kapatƒ±ldƒ± mƒ± kontrol et
                        window_id = id(toplevel)
                        if window_id in self._closed_windows:
                            continue  # Zaten kapatƒ±ldƒ±, atla
                        
                        # TUMCSV popup'ƒ± kontrol et
                        is_tumcsv_popup = False
                        try:
                            # Pencere i√ßeriƒüini kontrol et
                            for widget in toplevel.winfo_children():
                                try:
                                    widget_text = str(widget).lower()
                                    if 'tumcsv' in widget_text or 'ayarlamasƒ±' in widget_text:
                                        is_tumcsv_popup = True
                                        break
                                    # Label'larƒ± kontrol et
                                    if isinstance(widget, (tk.Label, ttk.Label)):
                                        label_text = widget.cget('text').lower() if hasattr(widget, 'cget') else ''
                                        if 'tumcsv' in label_text or 'ayarlamasƒ±' in label_text:
                                            is_tumcsv_popup = True
                                            break
                                except:
                                    pass
                        except:
                            pass
                        
                        print(f"[RUNALL] üîç Popup penceresi bulundu: {toplevel.title()} (TUMCSV: {is_tumcsv_popup})")
                        buttons = []
                        find_all_buttons_recursive(toplevel, buttons)
                        # "Tamam" butonunu bul ve tƒ±kla
                        for btn in buttons:
                            try:
                                if not btn.winfo_exists():
                                    continue
                                
                                # Bu buton zaten tƒ±klandƒ± mƒ± kontrol et
                                button_id = id(btn)
                                if button_id in self._clicked_buttons:
                                    continue  # Zaten tƒ±klandƒ±, atla
                                
                                text = str(btn.cget('text')).lower().strip()
                                if 'tamam' in text or 'ok' in text:
                                    print(f"[RUNALL] ‚úÖ Popup penceresindeki '{text}' butonu bulundu, tƒ±klanƒ±yor... ({toplevel.title()})")
                                    # Butonu i≈üaretle (tekrar tƒ±klanmasƒ±n)
                                    self._clicked_buttons.add(button_id)
                                    btn.invoke()
                                    # Pencereyi de kapat ve i≈üaretle
                                    try:
                                        if toplevel.winfo_exists():
                                            toplevel.destroy()
                                            self._closed_windows.add(window_id)
                                    except:
                                        pass
                                    break
                            except:
                                pass
                        continue  # Bu pencereyi i≈üledik, diƒüerlerine ge√ß
                    
                    buttons = []
                    find_all_buttons_recursive(toplevel, buttons)
                    
                    # Eƒüer pencere zaten kapatƒ±ldƒ±ysa atla
                    window_id = id(toplevel)
                    if window_id in self._closed_windows:
                        continue
                    
                    # Eƒüer sadece 1 buton varsa, ne olduƒüuna bakmaksƒ±zƒ±n tƒ±kla (tek se√ßenekli mesaj kutusu)
                    if len(buttons) == 1:
                        btn = buttons[0]
                        try:
                            if not btn.winfo_exists():
                                continue
                            
                            # Bu buton zaten tƒ±klandƒ± mƒ± kontrol et
                            button_id = id(btn)
                            if button_id in self._clicked_buttons:
                                continue  # Zaten tƒ±klandƒ±, atla
                            
                            text = str(btn.cget('text')).lower().strip()
                            print(f"[RUNALL] ‚úÖ Tek se√ßenekli mesaj kutusu bulundu: '{text}' (Pencere: '{title}'), tƒ±klanƒ±yor...")
                            self.log_message(f"‚úÖ Otomatik onay (tek se√ßenek): '{text}' ({title})")
                            
                            # Butonu i≈üaretle (tekrar tƒ±klanmasƒ±n)
                            self._clicked_buttons.add(button_id)
                            
                            # Butonu tƒ±kla
                            try:
                                btn.invoke()
                                self.after(100, lambda: None)
                                
                                # Pencere kapatƒ±ldƒ±ysa i≈üaretle
                                try:
                                    if not toplevel.winfo_exists():
                                        self._closed_windows.add(window_id)
                                except:
                                    pass
                            except:
                                # invoke √ßalƒ±≈ümazsa event_generate dene
                                try:
                                    btn.event_generate('<Button-1>')
                                    self.after(100, lambda: None)
                                    
                                    # Pencere kapatƒ±ldƒ±ysa i≈üaretle
                                    try:
                                        if not toplevel.winfo_exists():
                                            self._closed_windows.add(window_id)
                                    except:
                                        pass
                                except:
                                    pass
                            
                            continue  # Bu pencereyi i≈üledik, diƒüerlerine ge√ß
                        except Exception as e:
                            pass
                    
                    # Birden fazla buton varsa, onay butonlarƒ±nƒ± ara
                    # Her butonu kontrol et
                    for btn in buttons:
                        try:
                            if not btn.winfo_exists():
                                continue
                            
                            text = str(btn.cget('text')).lower().strip()
                            
                            # Onay butonlarƒ± i√ßin geni≈ületilmi≈ü keyword listesi
                            confirm_keywords = [
                                'ok', 'tamam', 'yes', 'evet', 'kabul', 'accept', 'onayla', 'confirm',
                                'g√∂nder', 'send', 'emirleri g√∂nder', 'okay', 'devam', 'continue',
                                'ilerle', 'proceed', 'ba≈ülat', 'start', '√ßalƒ±≈ütƒ±r', 'run'
                            ]
                            
                            if any(keyword in text for keyword in confirm_keywords):
                                # ƒ∞ptal/Reddet butonlarƒ±nƒ± atla
                                if any(cancel_keyword in text for cancel_keyword in ['iptal', 'cancel', 'reddet', 'no', 'hayƒ±r', 'kapat', 'close']):
                                    continue
                                
                                # Bu buton zaten tƒ±klandƒ± mƒ± kontrol et
                                button_id = id(btn)
                                if button_id in self._clicked_buttons:
                                    continue  # Zaten tƒ±klandƒ±, atla
                                
                                # Bu pencere zaten kapatƒ±ldƒ± mƒ± kontrol et
                                if window_id in self._closed_windows:
                                    continue  # Pencere zaten kapatƒ±ldƒ±, atla
                                
                                print(f"[RUNALL] ‚úÖ Onay butonu bulundu: '{text}' (Pencere: '{title}'), tƒ±klanƒ±yor...")
                                self.log_message(f"‚úÖ Otomatik onay: '{text}' ({title})")
                                
                                # Butonu i≈üaretle (tekrar tƒ±klanmasƒ±n)
                                self._clicked_buttons.add(button_id)
                                
                                # Butonu tƒ±kla
                                try:
                                    btn.invoke()
                                    # invoke sonrasƒ± kƒ±sa bir bekleme ekle
                                    self.after(100, lambda: None)
                                    
                                    # Pencere kapatƒ±ldƒ±ysa i≈üaretle
                                    try:
                                        if not toplevel.winfo_exists():
                                            self._closed_windows.add(window_id)
                                    except:
                                        pass
                                except:
                                    # invoke √ßalƒ±≈ümazsa event_generate dene
                                    try:
                                        btn.event_generate('<Button-1>')
                                        self.after(100, lambda: None)
                                        
                                        # Pencere kapatƒ±ldƒ±ysa i≈üaretle
                                        try:
                                            if not toplevel.winfo_exists():
                                                self._closed_windows.add(window_id)
                                        except:
                                            pass
                                    except:
                                        pass
                                
                                # Bir buton bulundu ve tƒ±klandƒ±, diƒüerlerini kontrol etmeye devam et
                                break
                        except Exception as e:
                            continue
                            
                except Exception as e:
                    continue
            
            # Ek olarak: Tkinter'ƒ±n messagebox'larƒ±nƒ± bulmak i√ßin √∂zel bir y√∂ntem
            # Messagebox'lar genellikle bo≈ü ba≈ülƒ±klƒ± Toplevel pencereler olarak olu≈üturulur
            try:
                # T√ºm widget'larƒ± tarayarak messagebox benzeri pencereleri bul
                def find_messagebox_windows(parent, found_list, depth=0):
                    if depth > 10:
                        return
                    try:
                        for widget in parent.winfo_children():
                            if isinstance(widget, tk.Toplevel):
                                try:
                                    title = widget.title()
                                    # Bo≈ü ba≈ülƒ±k veya bilgi mesajƒ± i√ßeren pencereler
                                    if title == '' or any(keyword in title.lower() for keyword in ['bilgi', 'info', 'onay', 'confirm', 'uyarƒ±', 'warning']):
                                        if widget not in found_list:
                                            found_list.append(widget)
                                except:
                                    pass
                            find_messagebox_windows(widget, found_list, depth + 1)
                    except:
                        pass
                
                messagebox_windows = []
                find_messagebox_windows(self, messagebox_windows)
                
                # Messagebox pencerelerindeki butonlarƒ± bul
                for mb_window in messagebox_windows:
                    try:
                        if not mb_window.winfo_exists():
                            continue
                        
                        # T√ºm butonlarƒ± bul
                        mb_buttons = []
                        find_all_buttons_recursive(mb_window, mb_buttons)
                        
                        for btn in mb_buttons:
                            try:
                                # Bu buton zaten tƒ±klandƒ± mƒ± kontrol et
                                button_id = id(btn)
                                if button_id in self._clicked_buttons:
                                    continue  # Zaten tƒ±klandƒ±, atla
                                
                                text = str(btn.cget('text')).lower().strip()
                                if any(keyword in text for keyword in ['ok', 'tamam', 'yes', 'evet', 'kabul', 'accept']):
                                    if not any(cancel_keyword in text for cancel_keyword in ['iptal', 'cancel', 'reddet', 'no', 'hayƒ±r']):
                                        print(f"[RUNALL] ‚úÖ Messagebox butonu bulundu: '{text}', tƒ±klanƒ±yor...")
                                        self.log_message(f"‚úÖ Otomatik onay (messagebox): '{text}'")
                                        
                                        # Butonu i≈üaretle (tekrar tƒ±klanmasƒ±n)
                                        self._clicked_buttons.add(button_id)
                                        
                                        try:
                                            btn.invoke()
                                            self.after(100, lambda: None)
                                            
                                            # Pencere kapatƒ±ldƒ±ysa i≈üaretle
                                            try:
                                                if not mb_window.winfo_exists():
                                                    self._closed_windows.add(id(mb_window))
                                            except:
                                                pass
                                        except:
                                            try:
                                                btn.event_generate('<Button-1>')
                                                self.after(100, lambda: None)
                                                
                                                # Pencere kapatƒ±ldƒ±ysa i≈üaretle
                                                try:
                                                    if not mb_window.winfo_exists():
                                                        self._closed_windows.add(id(mb_window))
                                                except:
                                                    pass
                                            except:
                                                pass
                                        break
                            except:
                                continue
                    except:
                        continue
            except:
                pass
            
        except Exception as e:
            print(f"[RUNALL] ‚ö†Ô∏è Onay mesajƒ± bulma hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def on_addnewpos_mode_changed(self):
        """ADDNEWPOS mod deƒüi≈üikliƒüi callback'i
        
        Modlar:
        - addlong_only: Sadece BB Long i≈ülemleri (varsayƒ±lan, mevcut davranƒ±≈ü)
        - addshort_only: Sadece FB Short i≈ülemleri (hen√ºz aktif deƒüil)
        - addboth: Hem BB Long hem FB Short i≈ülemleri (hen√ºz aktif deƒüil)
        """
        try:
            mode = self.addnewpos_mode_var.get()
            
            mode_display = {
                'addlong_only': 'üìà AddLong Only (Sadece BB Long)',
                'addshort_only': 'üìâ AddShort Only (Sadece FB Short)',
                'addboth': 'üîÑ AddBoth (Hem Long hem Short)'
            }
            
            print(f"[ADDNEWPOS] üîÑ Mod deƒüi≈üti: {mode_display.get(mode, mode)}")
            self.log_message(f"üîÑ ADDNEWPOS Mod: {mode_display.get(mode, mode)}")
            
            # ≈ûu an sadece addlong_only aktif
            if mode != 'addlong_only':
                print(f"[ADDNEWPOS] ‚ö†Ô∏è {mode} modu hen√ºz aktif deƒüil, sadece se√ßim yapƒ±ldƒ±")
            
        except Exception as e:
            print(f"[ADDNEWPOS] ‚ùå Mod deƒüi≈üikliƒüi hatasƒ±: {e}")
    
    def get_addnewpos_mode(self):
        """Mevcut ADDNEWPOS modunu d√∂nd√ºr
        
        Returns:
            str: 'addlong_only', 'addshort_only' veya 'addboth'
        """
        if hasattr(self, 'addnewpos_mode_var'):
            return self.addnewpos_mode_var.get()
        return 'addlong_only'  # Varsayƒ±lan
    
    def stop_runall_loop(self):
        """RUNALL d√∂ng√ºs√ºn√º durdur"""
        try:
            print("[RUNALL] ‚èπÔ∏è RUNALL d√∂ng√ºs√º durduruluyor...")
            self.log_message("‚èπÔ∏è RUNALL d√∂ng√ºs√º durduruluyor...")
            
            # D√∂ng√º flag'ini hemen False yap
            self.runall_loop_running = False
            
            # T√ºm pending after √ßaƒürƒ±larƒ±nƒ± iptal etmek i√ßin bir mekanizma yok ama
            # en azƒ±ndan flag'i kontrol ederek yeni i≈ülemlerin ba≈ülamasƒ±nƒ± engelleyebiliriz
            
            # Buton metnini g√ºncelle
            if hasattr(self, 'runall_btn'):
                self.runall_btn.config(text="‚ñ∂Ô∏è RUNALL", state='normal')
                self.runall_btn.config(style='Accent.TButton')
            if hasattr(self, 'runall_stop_btn'):
                self.runall_stop_btn.config(state='disabled')
            
            # Flag'leri resetle
            self.runall_addnewpos_triggered = False
            self.runall_addnewpos_started = False
            self.runall_waiting_for_karbotu = False
            self.runall_addnewpos_callback_set = False
            
            print("[RUNALL] ‚úÖ RUNALL d√∂ng√ºs√º durduruldu")
            self.log_message("‚úÖ RUNALL d√∂ng√ºs√º durduruldu")
            
        except Exception as e:
            print(f"[RUNALL] ‚ùå Durdurma hatasƒ±: {e}")
            self.log_message(f"‚ùå Durdurma hatasƒ±: {e}")
    
    def runall_close_orders_window_and_restart(self, orders_window):
        """Emirlerim penceresini kapat ve RUNALL d√∂ng√ºs√ºn√º tekrar ba≈ülat"""
        try:
            # D√∂ng√º durdurulmu≈üsa devam etme (ama runall_allowed_mode aktifse devam et)
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            if not runall_running and not runall_allowed:
                print("[RUNALL] ‚èπÔ∏è D√∂ng√º durdurulmu≈ü, tekrar ba≈ülatƒ±lmayacak")
                self.log_message("‚èπÔ∏è D√∂ng√º durdurulmu≈ü, tekrar ba≈ülatƒ±lmayacak")
                return
            
            # runall_allowed_mode aktifse runall_loop_running'i True yap
            if runall_allowed and not runall_running:
                self.runall_loop_running = True
                print("[RUNALL] ‚úÖ runall_loop_running True yapƒ±ldƒ± (runall_allowed_mode aktif)")
            
            # Pencereyi kapat
            if orders_window:
                try:
                    orders_window.destroy()
                except:
                    pass
            
            # Tamamlanan d√∂ng√º sayƒ±sƒ±nƒ± g√∂ster (mevcut d√∂ng√º sayacƒ± - 1, √ß√ºnk√º yeni d√∂ng√º hen√ºz ba≈ülamadƒ±)
            completed_loops = self.runall_loop_count - 1 if hasattr(self, 'runall_loop_count') else 0
            
            print(f"[RUNALL] ‚úÖ {completed_loops}. d√∂ng√º tamamlandƒ±! Emirler iptal edildi, yeni d√∂ng√º ba≈ülatƒ±lƒ±yor...")
            self.log_message(f"‚úÖ {completed_loops}. d√∂ng√º tamamlandƒ±! Emirler iptal edildi, yeni d√∂ng√º ba≈ülatƒ±lƒ±yor...")
            
            # D√∂ng√º sayacƒ± label'ƒ±nƒ± g√ºncelle
            if hasattr(self, 'runall_loop_label'):
                self.runall_loop_label.config(text=f"D√∂ng√º: {completed_loops} tamamlandƒ±")
            
            # Psfalgo penceresini √∂ne getir (kullanƒ±cƒ± botu durdurabilsin)
            if hasattr(self, 'psfalgo_window') and self.psfalgo_window:
                try:
                    if self.psfalgo_window.winfo_exists():
                        self.psfalgo_window.lift()  # Pencereyi √∂ne getir
                        self.psfalgo_window.focus_force()  # Odaklan
                        self.psfalgo_window.attributes('-topmost', True)  # En √ºste getir
                        self.after(100, lambda: self.psfalgo_window.attributes('-topmost', False))  # 100ms sonra normal moda d√∂nd√ºr
                except Exception as e:
                    print(f"[RUNALL] ‚ö†Ô∏è Psfalgo penceresi √∂ne getirilemedi: {e}")
            
            # Flag'leri resetle - YENƒ∞ D√ñNG√ú ƒ∞√áƒ∞N HAZIRLA
            self.runall_addnewpos_triggered = False
            self.runall_addnewpos_started = False
            self.runall_waiting_for_karbotu = False
            self.runall_waiting_for_reducemore = False
            self.runall_addnewpos_callback_set = False
            
            # KARBOTU ve REDUCEMORE flag'lerini de resetle
            if hasattr(self, 'karbotu_running'):
                self.karbotu_running = False
            if hasattr(self, 'reducemore_running'):
                self.reducemore_running = False
            
            # Controller'ƒ±n a√ßƒ±k olduƒüundan emin ol (UI thread'inde)
            if not self.controller_enabled:
                self.controller_enabled = True
                if hasattr(self, 'controller_btn'):
                    self.controller_btn.config(text="üéõÔ∏è Controller: ON")
                    self.controller_btn.config(style='Success.TButton')
            
            # ƒ∞ptal i≈ülemi tamamlandƒ±ktan sonra hemen yeni d√∂ng√ºye ba≈üla (2 dakika zaten ADDNEWPOS bitince beklendi)
            # after() kullanarak UI thread'ini bloklamadan restart yap
            def restart_loop():
                print("[RUNALL] üîÑ restart_loop() √ßaƒürƒ±ldƒ±")
                # D√∂ng√º durumu kontrol√º (her seferinde kontrol et)
                runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
                runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
                print(f"[RUNALL] üîç restart_loop kontrol√º: runall_running={runall_running}, runall_allowed={runall_allowed}")
                if not runall_running and not runall_allowed:
                    print("[RUNALL] ‚èπÔ∏è D√∂ng√º durdurulmu≈ü, tekrar ba≈ülatƒ±lmayacak")
                    self.log_message("‚èπÔ∏è D√∂ng√º durdurulmu≈ü, tekrar ba≈ülatƒ±lmayacak")
                    return
                
                # runall_allowed_mode aktifse runall_loop_running'i True yap
                if runall_allowed and not runall_running:
                    self.runall_loop_running = True
                    print("[RUNALL] ‚úÖ runall_loop_running True yapƒ±ldƒ± (runall_allowed_mode aktif)")
                
                # Yeni d√∂ng√º ba≈ülatƒ±lacak (sayacƒ± run_all_sequence i√ßinde artƒ±racak)
                next_loop = (self.runall_loop_count + 1) if hasattr(self, 'runall_loop_count') else 1
                print(f"[RUNALL] üîÑ {next_loop}. d√∂ng√º ba≈ülatƒ±lƒ±yor (KARBOTU ile)...")
                self.log_message(f"üîÑ {next_loop}. d√∂ng√º ba≈ülatƒ±lƒ±yor (KARBOTU ile)...")
                
                # run_all_sequence'ƒ± √ßaƒüƒ±r (KARBOTU ile ba≈ülayacak) - restart'tan geldiƒüini belirt
                # Direkt √ßaƒüƒ±r (zaten UI thread'indeyiz)
                try:
                    print(f"[RUNALL] üöÄ run_all_sequence(from_restart=True) √ßaƒürƒ±lƒ±yor...")
                    self.run_all_sequence(from_restart=True)
                    print(f"[RUNALL] ‚úÖ run_all_sequence(from_restart=True) √ßaƒürƒ±ldƒ±")
                except Exception as e:
                    print(f"[RUNALL] ‚ùå Restart hatasƒ±: {e}")
                    self.log_message(f"‚ùå Restart hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    # Hata olsa bile tekrar dene (d√∂ng√º hala √ßalƒ±≈üƒ±yorsa)
                    if hasattr(self, 'runall_loop_running') and self.runall_loop_running:
                        print("[RUNALL] üîÑ Hata sonrasƒ± tekrar denenecek (2 saniye sonra)...")
                        self.after(2000, restart_loop)
            
            # ƒ∞ptal i≈ülemi tamamlandƒ±ktan sonra hemen yeni d√∂ng√ºye ba≈üla (2 dakika zaten ADDNEWPOS bitince beklendi)
            # after() kullanarak UI thread'ini bloklamadan restart yap
            runall_running = hasattr(self, 'runall_loop_running') and self.runall_loop_running
            runall_allowed = hasattr(self, 'runall_allowed_mode') and self.runall_allowed_mode
            should_restart = runall_running or runall_allowed
            print(f"[RUNALL] üîç Restart kontrol√º: runall_running={runall_running}, runall_allowed={runall_allowed}, should_restart={should_restart}")
            
            if should_restart:
                # runall_allowed_mode aktifse runall_loop_running'i True yap
                if runall_allowed and not runall_running:
                    self.runall_loop_running = True
                    print("[RUNALL] ‚úÖ runall_loop_running True yapƒ±ldƒ± (runall_allowed_mode aktif)")
                
                # Emir iptalleri tamamlanƒ±r tamamlanmaz hemen yeni d√∂ng√ºye ba≈üla (non-blocking)
                # Kƒ±sa bir gecikme ile ba≈ülat (emir iptallerinin tamamlanmasƒ± i√ßin)
                print("[RUNALL] ‚è∞ Restart fonksiyonu √ßaƒürƒ±lƒ±yor (500ms sonra)...")
                self.after(500, restart_loop)
            else:
                print("[RUNALL] ‚èπÔ∏è D√∂ng√º durdurulmu≈ü, tekrar ba≈ülatƒ±lmayacak")
                self.log_message("‚èπÔ∏è D√∂ng√º durdurulmu≈ü, tekrar ba≈ülatƒ±lmayacak")
            
        except Exception as e:
            print(f"[RUNALL] ‚ùå Restart hatasƒ±: {e}")
            self.log_message(f"‚ùå Restart hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile tekrar dene (d√∂ng√º hala √ßalƒ±≈üƒ±yorsa)
            if hasattr(self, 'runall_loop_running') and self.runall_loop_running:
                self.after(2000, self.run_all_sequence)
    
    def toggle_lot_divider(self):
        """Lot b√∂l√ºc√º modunu a√ß/kapat"""
        self.lot_divider_enabled = not self.lot_divider_enabled
        
        if self.lot_divider_enabled:
            self.btn_lot_divider.config(text="üì¶ Lot B√∂l√ºc√º: ON")
            self.btn_lot_divider.config(style='Success.TButton')
            print("‚úÖ Lot B√∂l√ºc√º: A√áIK - Emirler 200er lotlar halinde b√∂l√ºnecek")
        else:
            self.btn_lot_divider.config(text="üì¶ Lot B√∂l√ºc√º: OFF")
            self.btn_lot_divider.config(style='Accent.TButton')
            print("‚ùå Lot B√∂l√ºc√º: KAPALI - Emirler normal g√∂nderilecek")
    
    def divide_lot_size(self, total_lot):
        """
        Lot miktarƒ±nƒ± akƒ±llƒ±ca b√∂l - YENƒ∞ MANTIK:
        - 0-399 lot: Direkt o kadar g√∂nder (130 lot varsa 130, 250 lot varsa 250)
        - 400+ lot: 200'√ºn katlarƒ± + kalan (kalan 200-399 arasƒ± olmalƒ±)
          √ñrnek: 500 lot = 200 + 300 (200+200+100 deƒüil!)
          √ñrnek: 600 lot = 200 + 200 + 200
          √ñrnek: 700 lot = 200 + 200 + 300
          √ñrnek: 800 lot = 200 + 200 + 200 + 200
          √ñrnek: 900 lot = 200 + 200 + 200 + 300
        """
        try:
            if total_lot <= 0:
                return []
            
            # 0-399 lot arasƒ±: Direkt g√∂nder
            if total_lot <= 399:
                return [total_lot]
            
            # 400+ lot: 200'√ºn katlarƒ± + kalan (kalan 200-399 arasƒ± olmalƒ±)
            lot_parts = []
            remaining = total_lot
            
            # 200'√ºn katlarƒ±nƒ± √ßƒ±kar (kalan 200-399 arasƒ± kalacak ≈üekilde)
            while remaining >= 400:
                lot_parts.append(200)
                remaining -= 200
            
            # Kalan miktarƒ± ekle (200-399 arasƒ± veya 0)
            if remaining > 0:
                lot_parts.append(remaining)
            
            return lot_parts
            
        except Exception as e:
            print(f"‚ùå Lot b√∂lme hatasƒ±: {e}")
            return [total_lot]  # Hata durumunda orijinal miktarƒ± d√∂nd√ºr
    
    def determine_position_change_type(self, symbol, current_qty, new_qty):
        """Pozisyon deƒüi≈üim t√ºr√ºn√º belirle"""
        try:
            # Mevcut pozisyon t√ºr√º
            if current_qty > 0:
                current_type = "LONG"
            elif current_qty < 0:
                current_type = "SHORT"
            else:
                current_type = "FLAT"
            
            # Yeni pozisyon t√ºr√º
            if new_qty > 0:
                new_type = "LONG"
            elif new_qty < 0:
                new_type = "SHORT"
            else:
                new_type = "FLAT"
            
            # Deƒüi≈üim miktarƒ±
            change = new_qty - current_qty
            
            # Pozisyon deƒüi≈üim t√ºr√ºn√º belirle
            if current_type == "LONG" and new_qty > current_qty:
                return "LONG_ARTTIRMA", change
            elif current_type == "LONG" and new_qty < current_qty:
                return "LONG_AZALTMA", change
            elif current_type == "SHORT" and new_qty < current_qty:
                return "SHORT_ARTTIRMA", change
            elif current_type == "SHORT" and new_qty > current_qty:
                return "SHORT_AZALTMA", change
            elif current_type == "FLAT" and new_qty > 0:
                return "LONG_ARTTIRMA", change
            elif current_type == "FLAT" and new_qty < 0:
                return "SHORT_ARTTIRMA", change
            else:
                return "UNKNOWN", change
                
        except Exception as e:
            self.log_message(f"‚ùå Pozisyon t√ºr√º belirleme hatasƒ± ({symbol}): {e}")
            return "ERROR", 0
    
    def check_maxalw_limit(self, symbol, change_type, change_amount):
        """MAXALW limitini kontrol et (1/4 kuralƒ±)"""
        try:
            # MAXALW deƒüerini al
            maxalw = self.get_maxalw_for_symbol(symbol)
            if maxalw <= 0:
                return True, "MAXALW deƒüeri bulunamadƒ±"
            
            # Maksimum deƒüi≈üim limiti (MAXALW/4)
            max_change_limit = maxalw / 4
            
            # Mutlak deƒüi≈üim miktarƒ±nƒ± kontrol et
            abs_change = abs(change_amount)
            
            if abs_change > max_change_limit:
                return False, f"MAXALW limiti a≈üƒ±ldƒ±: {abs_change:.0f} > {max_change_limit:.0f}"
            else:
                return True, f"MAXALW limiti OK: {abs_change:.0f} <= {max_change_limit:.0f}"
                
        except Exception as e:
            self.log_message(f"‚ùå MAXALW kontrol hatasƒ± ({symbol}): {e}")
            return False, f"Hata: {e}"
    
    def check_three_hour_limit(self, symbol, change_amount):
        """3 saatlik s√ºre limitini kontrol et"""
        try:
            current_time = datetime.now()
            
            # Bu hisse i√ßin son trade zamanƒ±nƒ± kontrol et
            if symbol in self.psfalgo_positions:
                last_trade_time = self.psfalgo_positions[symbol].get('last_trade_time')
                
                if last_trade_time:
                    # 3 saat ge√ßmi≈ü mi kontrol et
                    time_diff = current_time - last_trade_time
                    if time_diff.total_seconds() < 3 * 3600:  # 3 saat = 10800 saniye
                        # 3 saat i√ßinde, toplam deƒüi≈üimi kontrol et
                        three_hour_change = self.psfalgo_positions[symbol].get('three_hour_change', 0)
                        new_total_change = three_hour_change + change_amount
                        
                        # MAXALW/4 limitini kontrol et
                        maxalw = self.get_maxalw_for_symbol(symbol)
                        max_change_limit = maxalw / 4
                        
                        if abs(new_total_change) > max_change_limit:
                            return False, f"3 saatlik limit a≈üƒ±ldƒ±: {abs(new_total_change):.0f} > {max_change_limit:.0f}"
                        else:
                            return True, f"3 saatlik limit OK: {abs(new_total_change):.0f} <= {max_change_limit:.0f}"
                    else:
                        # 3 saat ge√ßmi≈ü, sƒ±fƒ±rla
                        self.psfalgo_positions[symbol]['three_hour_change'] = 0
                        self.psfalgo_positions[symbol]['last_trade_time'] = current_time
                        return True, "3 saatlik s√ºre sƒ±fƒ±rlandƒ±"
                else:
                    # ƒ∞lk trade
                    self.psfalgo_positions[symbol]['last_trade_time'] = current_time
                    return True, "ƒ∞lk trade"
            else:
                return True, "Pozisyon bulunamadƒ±"
                
        except Exception as e:
            self.log_message(f"‚ùå 3 saatlik limit kontrol hatasƒ± ({symbol}): {e}")
            return False, f"Hata: {e}"
    
    def setup_mode_buttons(self):
        """Mod butonlarƒ±nƒ±n ba≈ülangƒ±√ß g√∂r√ºn√ºm√ºn√º ayarla"""
        try:
            # HAMPRO modu varsayƒ±lan olarak aktif
            self.btn_hampro_mode.configure(style="Accent.TButton")
            self.btn_ibkr_gun_mode.configure(style="TButton")
            self.btn_ibkr_ped_mode.configure(style="TButton")
            
            # Mode manager callback'lerini ayarla
            self.mode_manager.on_mode_changed = self.on_mode_changed
            self.mode_manager.on_positions_changed = self.on_positions_changed
            self.mode_manager.on_orders_changed = self.on_orders_changed
            
            print("[MAIN] OK Mod butonlari ayarlandi")
        except Exception as e:
            print(f"[MAIN] ERROR Mod butonlari ayarlama hatasi: {e}")
    
    def on_mode_changed(self, mode):
        """Mod deƒüi≈ütiƒüinde √ßaƒürƒ±lƒ±r"""
        print(f"[MAIN] üîÑ Mod deƒüi≈üti: {mode}")
    
    def on_positions_changed(self, positions):
        """Pozisyonlar deƒüi≈ütiƒüinde √ßaƒürƒ±lƒ±r"""
        print(f"[MAIN] üìä Pozisyonlar g√ºncellendi: {len(positions)} pozisyon")
        # Exposure bilgisini g√ºncelle
        self.update_exposure_display()
    
    def on_orders_changed(self, orders):
        """Emirler deƒüi≈ütiƒüinde √ßaƒürƒ±lƒ±r"""
        print(f"[MAIN] üìã Emirler g√ºncellendi: {len(orders)} emir")
    
    def open_exception_list(self):
        """Exception listesi penceresini a√ßar."""
        try:
            ExceptionListWindow(self, self.exception_manager)
        except Exception as e:
            messagebox.showerror("Hata", f"Exception listesi penceresi a√ßƒ±lamadƒ±: {e}")
    
    def check_exception_tickers(self, ticker_list):
        """
        Verilen ticker listesinde exception olanlarƒ± kontrol eder.
        
        Args:
            ticker_list: Kontrol edilecek ticker listesi
            
        Returns:
            tuple: (allowed_tickers, exception_tickers, message)
        """
        allowed_tickers, exception_tickers = self.exception_manager.filter_exception_tickers(ticker_list)
        
        if exception_tickers:
            message = f"Exception listesinde bulunan hisseler: {', '.join(exception_tickers)}"
        else:
            message = "T√ºm hisseler trade edilebilir."
        
        return allowed_tickers, exception_tickers, message
    
    def update_exposure_display(self):
        """Aktif mod i√ßin exposure bilgisini hesapla ve g√∂ster"""
        try:
            print(f"[EXPOSURE] OK Exposure guncelleniyor... Aktif mod: {self.current_mode}")
            
            if self.current_mode == "HAMPRO":
                long_exposure, short_exposure = self.calculate_hammer_exposure()
                mode_text = "HAMPRO mod a√ßƒ±k"
            elif self.current_mode == "IBKR":
                long_exposure, short_exposure = self.calculate_ibkr_exposure()
                mode_text = "IBKR mod a√ßƒ±k"
            else:
                long_exposure, short_exposure = 0.0, 0.0
                mode_text = "Mod belirsiz"
            
            # Total exposure hesapla
            total_exposure = long_exposure + short_exposure
            
            # Exposure bilgisini g√ºncelle - Kƒ±sa format
            exposure_text = f"{mode_text} - Long: {long_exposure:,.0f} | Short: {short_exposure:,.0f} | Total: {total_exposure:,.0f}"
            self.exposure_label.configure(text=exposure_text)
            
            print(f"[EXPOSURE] OK {exposure_text}")
            
        except Exception as e:
            print(f"[EXPOSURE] ERROR Exposure hesaplama hatasi: {e}")
            import traceback
            traceback.print_exc()
            self.exposure_label.configure(text="Exposure hesaplanamadƒ±")
    
    def calculate_hammer_exposure(self):
        """HAMMER PRO pozisyonlarƒ±ndan exposure hesapla"""
        try:
            if not self.hammer.connected:
                return 0.0, 0.0
            
            positions = self.hammer.get_positions_direct()  # Direct pozisyonlarƒ± al
            long_exposure = 0.0
            short_exposure = 0.0
            
            print(f"[EXPOSURE] üîç HAMMER pozisyonlarƒ± kontrol ediliyor: {len(positions)} pozisyon")
            
            for position in positions:
                symbol = position.get('symbol', '')
                quantity = float(position.get('qty', 0))  # HAMMER'da 'qty' kullanƒ±lƒ±yor
                
                # Pozisyonlardan gelen price bilgisini kullan
                price_for_exposure = position.get('price_for_exposure')
                last_price = position.get('last_price')
                prev_close = position.get('prev_close')
                avg_cost = position.get('avg_cost', 0)
                
                print(f"[EXPOSURE] üìä {symbol}: Qty={quantity}, AvgCost={avg_cost}, LastPrice={last_price}, PrevClose={prev_close}, PriceForExposure={price_for_exposure}")
                
                # Price bilgisini belirle - √ñncelik sƒ±rasƒ±:
                # 1. Pozisyonlardan gelen price_for_exposure
                # 2. Pozisyonlardan gelen last_price
                # 3. Pozisyonlardan gelen prev_close
                # 4. Avg cost (fallback)
                
                price = None
                
                if price_for_exposure and price_for_exposure > 0:
                    price = float(price_for_exposure)
                    print(f"[EXPOSURE] üìä {symbol}: Pozisyon price_for_exposure={price}")
                elif last_price and last_price > 0:
                    price = float(last_price)
                    print(f"[EXPOSURE] üìä {symbol}: Pozisyon last_price={price}")
                elif prev_close and prev_close > 0:
                    price = float(prev_close)
                    print(f"[EXPOSURE] üìä {symbol}: Pozisyon prev_close={price}")
                else:
                    # Fallback: Avg cost kullan
                    if avg_cost and avg_cost > 0:
                        price = float(avg_cost)
                        print(f"[EXPOSURE] üìä {symbol}: Avg cost={price}")
                    else:
                        print(f"[EXPOSURE] ‚ö†Ô∏è {symbol}: Price bulunamadƒ±, exposure hesaplanamadƒ±")
                        continue
                
                if price and price > 0:
                    exposure = quantity * price
                    
                    if quantity > 0:  # Long pozisyon
                        long_exposure += exposure
                        print(f"[EXPOSURE] üìà {symbol}: Long exposure += {exposure:.2f}")
                    elif quantity < 0:  # Short pozisyon
                        short_exposure += abs(exposure)  # Short exposure pozitif g√∂ster
                        print(f"[EXPOSURE] üìâ {symbol}: Short exposure += {abs(exposure):.2f}")
                else:
                    print(f"[EXPOSURE] ‚ö†Ô∏è {symbol}: Price bulunamadƒ±, exposure hesaplanamadƒ±")
            
            print(f"[EXPOSURE] üìä HAMMER Toplam - Long: {long_exposure:.2f}, Short: {short_exposure:.2f}")
            return long_exposure, short_exposure
            
        except Exception as e:
            print(f"[EXPOSURE] ‚ùå HAMMER exposure hesaplama hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return 0.0, 0.0
    
    def calculate_ibkr_exposure(self):
        """IBKR pozisyonlarƒ±ndan exposure hesapla"""
        try:
            # √ñnce native client'i dene (averageCost bilgisi i√ßin)
            if self.ibkr_native.is_connected():
                positions = self.ibkr_native.get_positions()
            elif self.ibkr.is_connected():
                positions = self.ibkr.get_positions()
            else:
                print("[EXPOSURE] ‚ùå IBKR baƒülantƒ±sƒ± yok")
                return 0.0, 0.0
            
            long_exposure = 0.0
            short_exposure = 0.0
            
            print(f"[EXPOSURE] üîç IBKR pozisyonlarƒ± kontrol ediliyor: {len(positions)} pozisyon")
            
            for position in positions:
                symbol = position.get('symbol', '')
                quantity = float(position.get('qty', 0))  # IBKR'da da 'qty' kullanƒ±lƒ±yor
                
                # IBKR pozisyonlarƒ±ndan price bilgisini al
                market_price = position.get('market_price', 0)
                avg_cost = position.get('avg_cost', 0)
                
                print(f"[EXPOSURE] üìä {symbol}: Qty={quantity}, MarketPrice={market_price}, AvgCost={avg_cost}")
                
                # Price bilgisini belirle - √ñncelik sƒ±rasƒ±:
                # 1. Market price (ger√ßek zamanlƒ± fiyat)
                # 2. Avg cost (fallback)
                
                price = None
                
                if market_price and market_price > 0:
                    price = float(market_price)
                    print(f"[EXPOSURE] üìä {symbol}: Market price={price}")
                elif avg_cost and avg_cost > 0:
                    price = float(avg_cost)
                    print(f"[EXPOSURE] üìä {symbol}: Avg cost={price}")
                else:
                    print(f"[EXPOSURE] ‚ö†Ô∏è {symbol}: Price bulunamadƒ±, exposure hesaplanamadƒ±")
                    continue
                
                if price and price > 0:
                    exposure = quantity * price
                    
                    if quantity > 0:  # Long pozisyon
                        long_exposure += exposure
                        print(f"[EXPOSURE] üìà {symbol}: Long exposure += {exposure:.2f}")
                    elif quantity < 0:  # Short pozisyon
                        short_exposure += abs(exposure)  # Short exposure pozitif g√∂ster
                        print(f"[EXPOSURE] üìâ {symbol}: Short exposure += {abs(exposure):.2f}")
                else:
                    print(f"[EXPOSURE] ‚ö†Ô∏è {symbol}: Price bulunamadƒ±, exposure hesaplanamadƒ±")
            
            print(f"[EXPOSURE] üìä IBKR Toplam - Long: {long_exposure:.2f}, Short: {short_exposure:.2f}")
            return long_exposure, short_exposure
            
        except Exception as e:
            print(f"[EXPOSURE] ‚ùå IBKR exposure hesaplama hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return 0.0, 0.0
    
    def get_group_from_symbol(self, symbol):
        """Symbol'√ºn hangi gruba ait olduƒüunu bul - Take Profit Panel mantƒ±ƒüƒ±yla"""
        try:
            # Grup dosya e≈üle≈ümesi
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            # Her grup dosyasƒ±nƒ± kontrol et
            for group, file_name in group_file_map.items():
                if os.path.exists(file_name):
                    try:
                        df = pd.read_csv(file_name)
                        group_symbols = df['PREF IBKR'].tolist()
                        
                        # Tam e≈üle≈üme kontrol et
                        if symbol in group_symbols:
                            return group
                        
                        # Esnek e≈üle≈üme kontrol et (b√ºy√ºk/k√º√ß√ºk harf, bo≈üluk vs.)
                        symbol_upper = symbol.upper().strip()
                        for group_symbol in group_symbols:
                            if group_symbol and isinstance(group_symbol, str):
                                group_symbol_upper = group_symbol.upper().strip()
                                if symbol_upper == group_symbol_upper:
                                    return group
                    except Exception as e:
                        continue
            
            return "N/A"
            
        except Exception as e:
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[GORT] ‚ùå {symbol} grup bulma hatasƒ±: {e}")
            return "N/A"
    
    def get_cgrup_from_symbol(self, symbol):
        """Symbol'√ºn CGRUP deƒüerini bul (kuponlu gruplar i√ßin)"""
        try:
            if self.df.empty:
                return None
            
            row = self.df[self.df['PREF IBKR'] == symbol]
            if not row.empty and 'CGRUP' in self.df.columns:
                cgrup = row['CGRUP'].iloc[0]
                if pd.notna(cgrup) and cgrup != '' and cgrup != 'N/A':
                    return str(cgrup).strip()
            
            return None
            
        except Exception as e:
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[GORT] ‚ùå {symbol} CGRUP bulma hatasƒ±: {e}")
            return None
    
    def show_majbina_window(self):
        """MAJBINA filtreleme ve analiz penceresini g√∂ster"""
        try:
            # Pencere zaten a√ßƒ±ksa focus et
            if hasattr(self, 'majbina_window') and self.majbina_window:
                try:
                    self.majbina_window.lift()
                    self.majbina_window.focus()
                    return
                except:
                    pass
            
            # Yeni pencere olu≈ütur
            win = tk.Toplevel(self)
            win.title("MAJBINA - Filtreleme ve Analiz")
            win.geometry("1400x800")
            self.majbina_window = win
            
            # Filtre paneli (√ºstte)
            filter_frame = ttk.LabelFrame(win, text="Filtreler", padding=10)
            filter_frame.pack(fill='x', padx=10, pady=5)
            
            # Filtre deƒüerleri i√ßin dictionary
            filter_vars = {}
            
            # Filtre satƒ±rlarƒ± (2 s√ºtun halinde)
            filter_left = ttk.Frame(filter_frame)
            filter_left.pack(side='left', fill='both', expand=True, padx=5)
            
            filter_right = ttk.Frame(filter_frame)
            filter_right.pack(side='left', fill='both', expand=True, padx=5)
            
            # Filtre listesi
            filters = [
                ('SMA63 CHG', 'SMA63 chg', filter_left),
                ('Gort', 'GORT', filter_left),
                ('Final BB', 'Final_BB_skor', filter_left),
                ('Final FB', 'Final_FB_skor', filter_left),
                ('Final AB', 'Final_AB_skor', filter_left),
                ('Final SAS', 'Final_SAS_skor', filter_left),
                ('Final SFS', 'Final_SFS_skor', filter_left),
                ('Final SBS', 'Final_SBS_skor', filter_left),
                ('Bid buy ucuzluk', 'Bid_buy_ucuzluk_skoru', filter_left),
                ('Front buy ucuzluk', 'Front_buy_ucuzluk_skoru', filter_left),
                ('Ask buy ucuzluk', 'Ask_buy_ucuzluk_skoru', filter_left),
                ('BGGG Ayrƒ±≈üma', 'BGGG AYRISMA', filter_left),
                ('Ask sell pahalilik', 'Ask_sell_pahalilik_skoru', filter_right),
                ('Front sell pahalilik', 'Front_sell_pahalilik_skoru', filter_right),
                ('Bid sell pahalilik', 'Bid_sell_pahalilik_skoru', filter_right),
                ('Fbtot', 'Fbtot', filter_right),
                ('SFStot', 'SFStot', filter_right),
                ('Spread', 'Spread', filter_right),
                ('AVG_ADV', 'AVG_ADV', filter_right)
            ]
            
            # Her filtre i√ßin input olu≈ütur
            for i, (label, column, parent_frame) in enumerate(filters):
                row_frame = ttk.Frame(parent_frame)
                row_frame.pack(fill='x', pady=2)
                
                ttk.Label(row_frame, text=f"{label}:", width=20, anchor='w').pack(side='left', padx=2)
                
                # Min deƒüer
                min_var = tk.StringVar()
                ttk.Label(row_frame, text="Min:").pack(side='left', padx=2)
                min_entry = ttk.Entry(row_frame, textvariable=min_var, width=10)
                min_entry.pack(side='left', padx=2)
                
                # Max deƒüer
                max_var = tk.StringVar()
                ttk.Label(row_frame, text="Max:").pack(side='left', padx=2)
                max_entry = ttk.Entry(row_frame, textvariable=max_var, width=10)
                max_entry.pack(side='left', padx=2)
                
                filter_vars[column] = {'min': min_var, 'max': max_var}
            
            # Butonlar (Save Filter, Load Filter, Apply Filter)
            button_frame = ttk.Frame(filter_frame)
            button_frame.pack(fill='x', pady=10)
            
            ttk.Button(button_frame, text="Filtrele", command=lambda: self.apply_majbina_filters(win, filter_vars)).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Kaydet", command=lambda: self.save_majbina_filter(filter_vars)).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Y√ºkle", command=lambda: self.load_majbina_filter(filter_vars)).pack(side='left', padx=5)
            ttk.Button(button_frame, text="Temizle", command=lambda: self.clear_majbina_filters(filter_vars)).pack(side='left', padx=5)
            
            # Sonu√ß tablosu (altta, scrollable canvas)
            result_canvas_frame = ttk.Frame(win)
            result_canvas_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Canvas ve scrollbar
            canvas = tk.Canvas(result_canvas_frame)
            scrollbar = ttk.Scrollbar(result_canvas_frame, orient='vertical', command=canvas.yview)
            scrollable_frame = ttk.Frame(canvas)
            
            scrollable_frame.bind(
                "<Configure>",
                lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
            )
            
            canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
            canvas.configure(yscrollcommand=scrollbar.set)
            
            canvas.pack(side="left", fill="both", expand=True)
            scrollbar.pack(side="right", fill="y")
            
            # √ústte t√ºm gruplarƒ± se√ß/kaldƒ±r butonu
            top_button_frame = ttk.Frame(win)
            top_button_frame.pack(fill='x', padx=10, pady=5)
            ttk.Button(top_button_frame, text="T√ºm Gruplarƒ± Se√ß", 
                     command=lambda: self.majbina_select_all_groups(win, True)).pack(side='left', padx=5)
            ttk.Button(top_button_frame, text="T√ºm Gruplarƒ± Kaldƒ±r", 
                     command=lambda: self.majbina_select_all_groups(win, False)).pack(side='left', padx=5)
            
            # Sonu√ßlarƒ± saklamak i√ßin
            win.majbina_scrollable_frame = scrollable_frame
            win.majbina_filter_vars = filter_vars
            win.majbina_group_trees = {}  # group -> tree widget
            win.majbina_group_checkboxes = {}  # group -> checkbox variable
            
            # Pencere kapatƒ±ldƒ±ƒüƒ±nda referansƒ± temizle
            def on_close():
                self.majbina_window = None
                win.destroy()
            
            win.protocol("WM_DELETE_WINDOW", on_close)
            
            print("[MAJBINA] ‚úÖ MAJBINA penceresi a√ßƒ±ldƒ±")
            
        except Exception as e:
            print(f"[MAJBINA] ‚ùå Pencere a√ßma hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"MAJBINA penceresi a√ßƒ±lamadƒ±: {e}")
    
    def apply_majbina_filters(self, win, filter_vars):
        """Filtreleri uygula ve sonu√ßlarƒ± g√∂ster"""
        try:
            # Mini450'den veriyi al
            if not hasattr(self, 'df') or self.df.empty:
                messagebox.showwarning("Uyarƒ±", "Mini450 verisi yok! √ñnce mini450'yi a√ßƒ±n.")
                return
            
            df = self.df.copy()
            
            # Filtreleri uygula
            for column, vars_dict in filter_vars.items():
                min_val = vars_dict['min'].get().strip()
                max_val = vars_dict['max'].get().strip()
                
                if column not in df.columns:
                    continue
                
                if min_val:
                    try:
                        min_num = float(min_val)
                        df = df[pd.to_numeric(df[column], errors='coerce') >= min_num]
                    except:
                        pass
                
                if max_val:
                    try:
                        max_num = float(max_val)
                        df = df[pd.to_numeric(df[column], errors='coerce') <= max_num]
                    except:
                        pass
            
            # Sonu√ßlarƒ± gruplara b√∂l ve g√∂ster
            self.display_majbina_results(win, df)
            
        except Exception as e:
            print(f"[MAJBINA] ‚ùå Filtreleme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Filtreleme hatasƒ±: {e}")
    
    def display_majbina_results(self, win, df):
        """Sonu√ßlarƒ± gruplara b√∂l√ºnm√º≈ü ≈üekilde Treeview tablolarƒ±nda g√∂ster"""
        try:
            scrollable_frame = win.majbina_scrollable_frame
            
            # √ñnceki tablolarƒ± temizle
            for widget in scrollable_frame.winfo_children():
                widget.destroy()
            win.majbina_group_trees = {}
            
            if df.empty:
                ttk.Label(scrollable_frame, text="Filtreleme sonucu: Hi√ß hisse bulunamadƒ±.", 
                         font=('Arial', 12)).pack(pady=20)
                return
            
            # GRUP kolonu yoksa, dosyalardan grup bilgisini al
            if 'GRUP' not in df.columns:
                # Grup dosya e≈üle≈ümesi
                group_file_map = {
                    'heldff': 'ssfinekheldff.csv',
                    'helddeznff': 'ssfinekhelddeznff.csv', 
                    'heldkuponlu': 'ssfinekheldkuponlu.csv',
                    'heldnff': 'ssfinekheldnff.csv',
                    'heldflr': 'ssfinekheldflr.csv',
                    'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                    'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                    'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                    'heldotelremorta': 'ssfinekheldotelremorta.csv',
                    'heldsolidbig': 'ssfinekheldsolidbig.csv',
                    'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                    'highmatur': 'ssfinekhighmatur.csv',
                    'notcefilliquid': 'ssfineknotcefilliquid.csv',
                    'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                    'nottitrekhc': 'ssfineknottitrekhc.csv',
                    'salakilliquid': 'ssfineksalakilliquid.csv',
                    'shitremhc': 'ssfinekshitremhc.csv'
                }
                
                # Her grup i√ßin sembolleri topla
                group_symbols_map = {}
                for group, file_name in group_file_map.items():
                    if os.path.exists(file_name):
                        try:
                            group_df = pd.read_csv(file_name)
                            group_symbols_map[group] = set(group_df['PREF IBKR'].tolist())
                        except:
                            pass
                
                # DataFrame'e GRUP kolonu ekle
                def get_group(symbol):
                    for group, symbols in group_symbols_map.items():
                        if symbol in symbols:
                            return group
                    return 'N/A'
                
                df['GRUP'] = df['PREF IBKR'].apply(get_group)
            
            # Gruplara g√∂re grupla
            groups = sorted(df['GRUP'].dropna().unique())
            
            for group in groups:
                if group == 'N/A':
                    continue
                
                group_rows = df[df['GRUP'] == group]
                if group_rows.empty:
                    continue
                
                # heldkuponlu i√ßin CGRUP'lara ayƒ±r
                if group == 'heldkuponlu':
                    # CGRUP'larƒ± al ve sƒ±rala
                    cgrups = []
                    for cgrup in group_rows['CGRUP'].dropna().unique():
                        if pd.notna(cgrup) and str(cgrup).strip():
                            cgrups.append(str(cgrup).strip())
                    
                    def cgrup_sort_key(cgrup_str):
                        try:
                            num = int(cgrup_str.replace('C', ''))
                            return num
                        except:
                            return 9999
                    
                    cgrups = sorted(cgrups, key=cgrup_sort_key)
                    
                    for cgrup in cgrups:
                        cgrup_rows = group_rows[group_rows['CGRUP'].astype(str).str.strip() == cgrup]
                        if cgrup_rows.empty:
                            continue
                        
                        # CGRUP i√ßin LabelFrame
                        cgrup_frame = ttk.LabelFrame(scrollable_frame, text=f"{group.upper()} - CGRUP: {cgrup} ({len(cgrup_rows)} hisse)", padding=5)
                        cgrup_frame.pack(fill='x', padx=5, pady=5)
                        
                        # Grup se√ßim checkbox'ƒ± ve butonlar
                        header_frame = ttk.Frame(cgrup_frame)
                        header_frame.pack(fill='x', pady=5)
                        
                        group_key = f"{group}_{cgrup}"
                        group_checkbox_var = tk.BooleanVar(value=False)
                        group_checkbox = ttk.Checkbutton(header_frame, text="Grup Se√ß", variable=group_checkbox_var,
                                                        command=lambda gk=group_key, var=group_checkbox_var: 
                                                        self.majbina_toggle_group_selection(win, gk, var.get()))
                        group_checkbox.pack(side='left', padx=5)
                        
                        win.majbina_group_checkboxes[group_key] = group_checkbox_var
                        
                        btn_frame = ttk.Frame(header_frame)
                        btn_frame.pack(side='right')
                        
                        tree = self.create_majbina_table(cgrup_frame, cgrup_rows, group_key)
                        
                        ttk.Button(btn_frame, text="T√ºm√ºn√º Se√ß", 
                                 command=lambda t=tree, gk=group_key, var=group_checkbox_var: 
                                 [self.majbina_select_all(t, True), var.set(True)]).pack(side='left', padx=5)
                        ttk.Button(btn_frame, text="T√ºm√ºn√º Kaldƒ±r", 
                                 command=lambda t=tree, gk=group_key, var=group_checkbox_var: 
                                 [self.majbina_select_all(t, False), var.set(False)]).pack(side='left', padx=5)
                        
                        win.majbina_group_trees[group_key] = tree
                else:
                    # Diƒüer gruplar i√ßin direkt g√∂ster
                    group_frame = ttk.LabelFrame(scrollable_frame, text=f"{group.upper()} ({len(group_rows)} hisse)", padding=5)
                    group_frame.pack(fill='x', padx=5, pady=5)
                    
                    # Grup se√ßim checkbox'ƒ± ve butonlar
                    header_frame = ttk.Frame(group_frame)
                    header_frame.pack(fill='x', pady=5)
                    
                    group_checkbox_var = tk.BooleanVar(value=False)
                    group_checkbox = ttk.Checkbutton(header_frame, text="Grup Se√ß", variable=group_checkbox_var,
                                                    command=lambda gk=group, var=group_checkbox_var: 
                                                    self.majbina_toggle_group_selection(win, gk, var.get()))
                    group_checkbox.pack(side='left', padx=5)
                    
                    win.majbina_group_checkboxes[group] = group_checkbox_var
                    
                    btn_frame = ttk.Frame(header_frame)
                    btn_frame.pack(side='right')
                    
                    tree = self.create_majbina_table(group_frame, group_rows, group)
                    
                    ttk.Button(btn_frame, text="T√ºm√ºn√º Se√ß", 
                             command=lambda t=tree, gk=group, var=group_checkbox_var: 
                             [self.majbina_select_all(t, True), var.set(True)]).pack(side='left', padx=5)
                    ttk.Button(btn_frame, text="T√ºm√ºn√º Kaldƒ±r", 
                             command=lambda t=tree, gk=group, var=group_checkbox_var: 
                             [self.majbina_select_all(t, False), var.set(False)]).pack(side='left', padx=5)
                    
                    win.majbina_group_trees[group] = tree
            
            # Toplam bilgisi
            total_label = ttk.Label(scrollable_frame, text=f"TOPLAM: {len(df)} hisse", 
                                   font=('Arial', 10, 'bold'))
            total_label.pack(pady=10)
            
        except Exception as e:
            print(f"[MAJBINA] ‚ùå Sonu√ß g√∂sterim hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
    
    def create_majbina_table(self, parent, df_rows, group_key):
        """MAJBINA i√ßin Treeview tablosu olu≈ütur"""
        columns = ('Se√ß', 'Symbol', 'Final_BB', 'Final_FB', 'Fbtot', 'SFStot', 'SMA63', 'GORT', 
                   'Final_SAS', 'Final_SFS', 'Spread', 'AVG_ADV')
        headers = ('‚úì', 'Symbol', 'Final BB', 'Final FB', 'Fbtot', 'SFStot', 'SMA63', 'GORT',
                   'Final SAS', 'Final SFS', 'Spread', 'AVG_ADV')
        
        tree = ttk.Treeview(parent, columns=columns, show='headings', height=min(len(df_rows), 15))
        
        # Kolon ba≈ülƒ±klarƒ±
        for col, header in zip(columns, headers):
            tree.heading(col, text=header)
            if col == 'Se√ß':
                tree.column(col, width=40, anchor='center')
            elif col == 'Symbol':
                tree.column(col, width=100, anchor='center')
            else:
                tree.column(col, width=90, anchor='center')
        
        # Satƒ±rlarƒ± ekle
        for _, row in df_rows.iterrows():
            symbol = row.get('PREF IBKR', 'N/A')
            final_bb = row.get('Final_BB_skor', 'N/A')
            final_fb = row.get('Final_FB_skor', 'N/A')
            fbtot = row.get('Fbtot', 'N/A')
            sfstot = row.get('SFStot', 'N/A')
            sma63 = row.get('SMA63 chg', 'N/A')
            gort = row.get('GORT', 'N/A')
            final_sas = row.get('Final_SAS_skor', 'N/A')
            final_sfs = row.get('Final_SFS_skor', 'N/A')
            spread = row.get('Spread', 'N/A')
            avg_adv = row.get('AVG_ADV', 'N/A')
            
            # Deƒüerleri formatla
            final_bb_str = f"{final_bb:.4f}" if isinstance(final_bb, (int, float)) and not pd.isna(final_bb) else str(final_bb)
            final_fb_str = f"{final_fb:.4f}" if isinstance(final_fb, (int, float)) and not pd.isna(final_fb) else str(final_fb)
            fbtot_str = str(fbtot) if fbtot != 'N/A' and pd.notna(fbtot) else 'N/A'
            sfstot_str = str(sfstot) if sfstot != 'N/A' and pd.notna(sfstot) else 'N/A'
            sma63_str = f"{sma63:.2f}" if isinstance(sma63, (int, float)) and not pd.isna(sma63) else str(sma63)
            gort_str = f"{gort:.2f}" if isinstance(gort, (int, float)) and not pd.isna(gort) else str(gort)
            final_sas_str = f"{final_sas:.4f}" if isinstance(final_sas, (int, float)) and not pd.isna(final_sas) else str(final_sas)
            final_sfs_str = f"{final_sfs:.4f}" if isinstance(final_sfs, (int, float)) and not pd.isna(final_sfs) else str(final_sfs)
            spread_str = f"${spread:.2f}" if isinstance(spread, (int, float)) and not pd.isna(spread) else str(spread)
            avg_adv_str = f"{avg_adv:.0f}" if isinstance(avg_adv, (int, float)) and not pd.isna(avg_adv) else str(avg_adv)
            
            tree.insert('', 'end', values=(
                '‚òê',  # Se√ßim kutusu
                symbol,
                final_bb_str,
                final_fb_str,
                fbtot_str,
                sfstot_str,
                sma63_str,
                gort_str,
                final_sas_str,
                final_sfs_str,
                spread_str,
                avg_adv_str
            ), tags=(symbol,))
        
        # Se√ßim tƒ±klama
        def on_click(event):
            region = tree.identify_region(event.x, event.y)
            if region == "cell":
                column = tree.identify_column(event.x)
                if column == "#1":  # Se√ß kolonu
                    item = tree.identify_row(event.y)
                    if item:
                        values = list(tree.item(item)['values'])
                        if values[0] == "‚úì":
                            values[0] = "‚òê"
                        else:
                            values[0] = "‚úì"
                        tree.item(item, values=values)
        
        tree.bind('<Button-1>', on_click)
        tree.pack(fill='both', expand=True)
        
        return tree
    
    def majbina_select_all(self, tree, select=True):
        """T√ºm√ºn√º se√ß/kaldƒ±r"""
        for item in tree.get_children():
            values = list(tree.item(item)['values'])
            values[0] = "‚úì" if select else "‚òê"
            tree.item(item, values=values)
    
    def majbina_toggle_group_selection(self, win, group_key, selected):
        """Grup se√ßim checkbox'ƒ±na tƒ±klandƒ±ƒüƒ±nda"""
        if group_key in win.majbina_group_trees:
            tree = win.majbina_group_trees[group_key]
            self.majbina_select_all(tree, selected)
    
    def majbina_select_all_groups(self, win, select=True):
        """T√ºm gruplarƒ± se√ß/kaldƒ±r"""
        for group_key, tree in win.majbina_group_trees.items():
            self.majbina_select_all(tree, select)
            # Checkbox'larƒ± da g√ºncelle
            if group_key in win.majbina_group_checkboxes:
                win.majbina_group_checkboxes[group_key].set(select)
    
    def save_majbina_filter(self, filter_vars):
        """Filtreleri kaydet"""
        try:
            # ƒ∞sim al
            filter_name = simpledialog.askstring("Filtre Kaydet", "Filtre ismi girin:")
            if not filter_name:
                return
            
            # Filtre deƒüerlerini topla
            filter_data = {}
            for column, vars_dict in filter_vars.items():
                min_val = vars_dict['min'].get().strip()
                max_val = vars_dict['max'].get().strip()
                if min_val or max_val:
                    filter_data[column] = {'min': min_val, 'max': max_val}
            
            # JSON formatƒ±nda kaydet (daha kolay y√ºkleme i√ßin)
            import json
            filename = f"majbina_{filter_name}.json"
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(filter_data, f, indent=2, ensure_ascii=False)
            
            messagebox.showinfo("Ba≈üarƒ±lƒ±", f"Filtre '{filter_name}' kaydedildi: {filename}")
            print(f"[MAJBINA] ‚úÖ Filtre kaydedildi: {filename}")
            
        except Exception as e:
            print(f"[MAJBINA] ‚ùå Filtre kaydetme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Filtre kaydedilemedi: {e}")
    
    def load_majbina_filter(self, filter_vars):
        """Filtreleri y√ºkle - Kayƒ±tlƒ± filtreleri listele"""
        try:
            # T√ºm majbina_*.json dosyalarƒ±nƒ± bul
            import glob
            filter_files = glob.glob("majbina_*.json")
            
            if not filter_files:
                messagebox.showinfo("Bilgi", "Kayƒ±tlƒ± filtre bulunamadƒ±.")
                return
            
            # Dosya isimlerinden filtre isimlerini √ßƒ±kar
            filter_names = []
            for filename in sorted(filter_files):
                # majbina_abc.json -> abc
                name = filename.replace("majbina_", "").replace(".json", "")
                filter_names.append(name)
            
            # Se√ßim penceresi
            load_win = tk.Toplevel(self)
            load_win.title("Filtre Y√ºkle")
            load_win.geometry("400x300")
            load_win.transient(self)
            load_win.grab_set()
            
            ttk.Label(load_win, text="Kayƒ±tlƒ± Filtreler:", font=('Arial', 10, 'bold')).pack(pady=10)
            
            # Liste kutusu
            list_frame = ttk.Frame(load_win)
            list_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            scrollbar = ttk.Scrollbar(list_frame)
            scrollbar.pack(side='right', fill='y')
            
            filter_listbox = tk.Listbox(list_frame, yscrollcommand=scrollbar.set)
            filter_listbox.pack(side='left', fill='both', expand=True)
            scrollbar.config(command=filter_listbox.yview)
            
            for name in filter_names:
                filter_listbox.insert(tk.END, name)
            
            # Butonlar
            button_frame = ttk.Frame(load_win)
            button_frame.pack(fill='x', padx=10, pady=10)
            
            def load_selected():
                selection = filter_listbox.curselection()
                if not selection:
                    messagebox.showwarning("Uyarƒ±", "L√ºtfen bir filtre se√ßin!")
                    return
                
                filter_name = filter_listbox.get(selection[0])
                filename = f"majbina_{filter_name}.json"
                
                try:
                    import json
                    with open(filename, 'r', encoding='utf-8') as f:
                        filter_data = json.load(f)
                    
                    # Filtre deƒüerlerini y√ºkle
                    for column, vars_dict in filter_vars.items():
                        if column in filter_data:
                            data = filter_data[column]
                            vars_dict['min'].set(data.get('min', ''))
                            vars_dict['max'].set(data.get('max', ''))
                    
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", f"Filtre '{filter_name}' y√ºklendi")
                    print(f"[MAJBINA] ‚úÖ Filtre y√ºklendi: {filename}")
                    load_win.destroy()
                    
                except Exception as e:
                    print(f"[MAJBINA] ‚ùå Filtre y√ºkleme hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    messagebox.showerror("Hata", f"Filtre y√ºklenemedi: {e}")
            
            ttk.Button(button_frame, text="Y√ºkle", command=load_selected).pack(side='left', padx=5)
            ttk.Button(button_frame, text="ƒ∞ptal", command=load_win.destroy).pack(side='left', padx=5)
            
            # √áift tƒ±klama ile y√ºkle
            filter_listbox.bind('<Double-Button-1>', lambda e: load_selected())
            
        except Exception as e:
            print(f"[MAJBINA] ‚ùå Filtre y√ºkleme hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Filtre y√ºklenemedi: {e}")
    
    def clear_majbina_filters(self, filter_vars):
        """Filtreleri temizle"""
        try:
            for column, vars_dict in filter_vars.items():
                vars_dict['min'].set('')
                vars_dict['max'].set('')
            
            # Sonu√ßlarƒ± da temizle
            if hasattr(self, 'majbina_window') and self.majbina_window:
                if hasattr(self.majbina_window, 'majbina_scrollable_frame'):
                    for widget in self.majbina_window.majbina_scrollable_frame.winfo_children():
                        widget.destroy()
                    self.majbina_window.majbina_group_trees = {}
                    self.majbina_window.majbina_group_checkboxes = {}
            
            print("[MAJBINA] ‚úÖ Filtreler temizlendi")
            
        except Exception as e:
            print(f"[MAJBINA] ‚ùå Filtre temizleme hatasƒ±: {e}")
    
    def calculate_fbtot_sfstot_for_mini450(self, df):
        """Mini450 i√ßin Fbtot ve SFStot kolonlarƒ±nƒ± hesapla ve ekle - Her hisse kendi grubuna g√∂re"""
        try:
            print("üîÑ Mini450 i√ßin Fbtot ve SFStot hesaplanƒ±yor...")
            
            # Fbtot ve SFStot kolonlarƒ±nƒ± ba≈ülat
            df['Fbtot'] = 'N/A'
            df['SFStot'] = 'N/A'
            
            # Grup dosya e≈üle≈ümesi
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            # Her grup i√ßin ayrƒ± ayrƒ± hesapla
            for group, file_name in group_file_map.items():
                if not os.path.exists(file_name):
                    continue
                
                try:
                    group_df = pd.read_csv(file_name)
                    group_symbols = set(group_df['PREF IBKR'].tolist())
                    
                    # Bu gruba ait hisseleri filtrele
                    group_rows = df[df['PREF IBKR'].isin(group_symbols)]
                    
                    if group_rows.empty:
                        continue
                    
                    # Grup i√ßindeki Final_FB ve Final_SFS skorlarƒ±nƒ± al (N/A deƒüerleri tamamen ignore et)
                    if 'Final_FB_skor' in df.columns:
                        # N/A, NaN, string "N/A", 0 ve negatif deƒüerleri tamamen filtrele
                        final_fb_values = group_rows['Final_FB_skor'].copy()
                        # String "N/A" deƒüerlerini NaN'a √ßevir
                        final_fb_values = final_fb_values.replace('N/A', np.nan)
                        # NaN'larƒ± drop et
                        final_fb_values = final_fb_values.dropna()
                        # Sayƒ±sal deƒüerlere √ßevir
                        final_fb_values = pd.to_numeric(final_fb_values, errors='coerce')
                        # Tekrar NaN'larƒ± drop et (sayƒ±sal olmayan deƒüerler i√ßin)
                        final_fb_values = final_fb_values.dropna()
                        # 0 ve negatif deƒüerleri filtrele
                        final_fb_values = final_fb_values[final_fb_values > 0]
                        # Ortalama hesapla (sadece ge√ßerli deƒüerlerle)
                        avg_final_fb = final_fb_values.mean() if not final_fb_values.empty else 0
                    else:
                        avg_final_fb = 0
                    
                    if 'Final_SFS_skor' in df.columns:
                        # N/A, NaN, string "N/A", 0 ve negatif deƒüerleri tamamen filtrele
                        final_sfs_values = group_rows['Final_SFS_skor'].copy()
                        # String "N/A" deƒüerlerini NaN'a √ßevir
                        final_sfs_values = final_sfs_values.replace('N/A', np.nan)
                        # NaN'larƒ± drop et
                        final_sfs_values = final_sfs_values.dropna()
                        # Sayƒ±sal deƒüerlere √ßevir
                        final_sfs_values = pd.to_numeric(final_sfs_values, errors='coerce')
                        # Tekrar NaN'larƒ± drop et (sayƒ±sal olmayan deƒüerler i√ßin)
                        final_sfs_values = final_sfs_values.dropna()
                        # 0 ve negatif deƒüerleri filtrele
                        final_sfs_values = final_sfs_values[final_sfs_values > 0]
                        # Ortalama hesapla (sadece ge√ßerli deƒüerlerle)
                        avg_final_sfs = final_sfs_values.mean() if not final_sfs_values.empty else 0
                    else:
                        avg_final_sfs = 0
                    
                    # Her hisse i√ßin Fbtot ve SFStot hesapla
                    calculated_fbtot = 0
                    calculated_sfstot = 0
                    for idx, row in group_rows.iterrows():
                        symbol = row['PREF IBKR']
                        
                        # FBPlagr hesapla (sadece ge√ßerli skor varsa)
                        if 'Final_FB_skor' in df.columns and avg_final_fb > 0 and len(final_fb_values) > 0:
                            symbol_fb_raw = row.get('Final_FB_skor', 0)
                            
                            # N/A kontrol√º: String "N/A" veya NaN ise ignore et
                            if pd.isna(symbol_fb_raw) or symbol_fb_raw == 'N/A' or symbol_fb_raw == '':
                                df.at[idx, 'Fbtot'] = 'N/A'
                            else:
                                symbol_fb = pd.to_numeric(symbol_fb_raw, errors='coerce')
                                
                                # Sayƒ±sal deƒüilse veya 0'dan k√º√ß√ºkse ignore et
                                if pd.isna(symbol_fb) or symbol_fb <= 0:
                                    df.at[idx, 'Fbtot'] = 'N/A'
                                else:
                                    # Bu hisse'nin grup i√ßindeki sƒ±ralamasƒ±nƒ± hesapla (sadece ge√ßerli deƒüerlerle)
                                    rank = (final_fb_values >= symbol_fb).sum()
                                    total_count = len(final_fb_values)
                                    fbplagr = rank / total_count if total_count > 0 else 0
                                    
                                    # FBRatgr hesapla
                                    fbratgr = symbol_fb / avg_final_fb if avg_final_fb > 0 else 0
                                    
                                    # Fbtot hesapla: FBPlagr * 0.5 + FBRatgr * 1.5
                                    fbtot = (fbplagr * 0.5) + (fbratgr * 1.5)
                                    df.at[idx, 'Fbtot'] = f"{fbtot:.4f}"
                                    calculated_fbtot += 1
                        else:
                            df.at[idx, 'Fbtot'] = 'N/A'
                        
                        # SFSPlagr hesapla (sadece ge√ßerli skor varsa)
                        if 'Final_SFS_skor' in df.columns and avg_final_sfs > 0 and len(final_sfs_values) > 0:
                            symbol_sfs_raw = row.get('Final_SFS_skor', 0)
                            
                            # N/A kontrol√º: String "N/A" veya NaN ise ignore et
                            if pd.isna(symbol_sfs_raw) or symbol_sfs_raw == 'N/A' or symbol_sfs_raw == '':
                                df.at[idx, 'SFStot'] = 'N/A'
                            else:
                                symbol_sfs = pd.to_numeric(symbol_sfs_raw, errors='coerce')
                                
                                # Sayƒ±sal deƒüilse veya 0'dan k√º√ß√ºkse ignore et
                                if pd.isna(symbol_sfs) or symbol_sfs <= 0:
                                    df.at[idx, 'SFStot'] = 'N/A'
                                else:
                                    # Bu hisse'nin grup i√ßindeki sƒ±ralamasƒ±nƒ± hesapla (sadece ge√ßerli deƒüerlerle)
                                    rank = (final_sfs_values >= symbol_sfs).sum()
                                    total_count = len(final_sfs_values)
                                    sfsplagr = rank / total_count if total_count > 0 else 0
                                    
                                    # SFSRatgr hesapla
                                    sfsratgr = symbol_sfs / avg_final_sfs if avg_final_sfs > 0 else 0
                                    
                                    # SFStot hesapla: SFSPlagr * 0.5 + SFSRatgr * 1.5
                                    sfstot = (sfsplagr * 0.5) + (sfsratgr * 1.5)
                                    df.at[idx, 'SFStot'] = f"{sfstot:.4f}"
                                    calculated_sfstot += 1
                        else:
                            df.at[idx, 'SFStot'] = 'N/A'
                    
                    print(f"‚úÖ {group} grubu: {len(group_rows)} hisse, Fbtot hesaplanan: {calculated_fbtot}, SFStot hesaplanan: {calculated_sfstot}")
                    
                    print(f"‚úÖ {group} grubu: {len(group_rows)} hisse i√ßin Fbtot ve SFStot hesaplandƒ±")
                    
                except Exception as e:
                    print(f"‚ùå {group} grubu Fbtot/SFStot hesaplama hatasƒ±: {e}")
                    continue
            
            print(f"‚úÖ Mini450 i√ßin Fbtot ve SFStot hesaplama tamamlandƒ±")
            return df
            
        except Exception as e:
            print(f"‚ùå Mini450 Fbtot/SFStot hesaplama hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            return df
    
    def calculate_group_avg_sma63chg(self, symbol, group, cgrup=None):
        """Grup ortalama SMA 63 CHG hesapla"""
        try:
            # Kuponlu gruplar i√ßin CGRUP'a g√∂re gruplama
            kuponlu_groups = ['heldkuponlu', 'heldkuponlukreciliz', 'heldkuponlukreorta']
            
            if group.lower() in kuponlu_groups and cgrup:
                # CGRUP'a g√∂re gruplama
                if self.df.empty:
                    return 0.01
                
                # Aynƒ± CGRUP'a sahip hisseleri bul
                cgrup_rows = self.df[(self.df['CGRUP'] == cgrup) & (self.df['PREF IBKR'] != symbol)]
                
                # SMA 63 CHG i√ßin farklƒ± kolon isimlerini dene
                sma63_col_names = ['SMA63 chg', 'SMA63CHG', 'SMA63_CHG', 'SMA 63 CHG']
                for col_name in sma63_col_names:
                    if col_name in self.df.columns:
                        sma63_values = cgrup_rows[col_name].dropna()
                        sma63_values = pd.to_numeric(sma63_values, errors='coerce').dropna()
                        if not sma63_values.empty:
                            avg = sma63_values.mean()
                            # Sadece ilk birka√ß i√ßin log
                            if not hasattr(self, '_gort_group_avg_log_count'):
                                self._gort_group_avg_log_count = 0
                            if self._gort_group_avg_log_count < 3:
                                # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
                                # print(f"[GORT] üìä {symbol} ({group}, CGRUP={cgrup}): SMA63 grup ortalamasƒ± = {avg:.2f} ({len(sma63_values)} hisse)")
                                self._gort_group_avg_log_count += 1
                            return avg if avg != 0 else 0.01
                
                return 0.01
            
            # Normal gruplar i√ßin grup dosyasƒ±ndan
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            file_name = group_file_map.get(group.lower())
            if not file_name or not os.path.exists(file_name):
                return 0.01
            
            # Grup dosyasƒ±ndan hisseleri al
            df = pd.read_csv(file_name)
            group_symbols = set(df['PREF IBKR'].tolist())
            
            # Parent DataFrame'den bu gruba ait hisselerin SMA 63 CHG deƒüerlerini al
            if not self.df.empty:
                group_rows = self.df[self.df['PREF IBKR'].isin(group_symbols)]
                
                # SMA 63 CHG i√ßin farklƒ± kolon isimlerini dene
                sma63_col_names = ['SMA63 chg', 'SMA63CHG', 'SMA63_CHG', 'SMA 63 CHG']
                for col_name in sma63_col_names:
                    if col_name in self.df.columns:
                        sma63_values = group_rows[col_name].dropna()
                        sma63_values = pd.to_numeric(sma63_values, errors='coerce').dropna()
                        if not sma63_values.empty:
                            avg = sma63_values.mean()
                            # Sadece ilk birka√ß i√ßin log
                            if not hasattr(self, '_gort_group_avg_log_count'):
                                self._gort_group_avg_log_count = 0
                            if self._gort_group_avg_log_count < 3:
                                # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
                                # print(f"[GORT] üìä {symbol} ({group}): SMA63 grup ortalamasƒ± = {avg:.2f} ({len(sma63_values)} hisse)")
                                self._gort_group_avg_log_count += 1
                            return avg if avg != 0 else 0.01
            
            return 0.01
            
        except Exception as e:
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[GORT] ‚ùå {symbol} grup ortalama SMA 63 CHG hesaplama hatasƒ±: {e}")
            return 0.01
    
    def calculate_group_avg_sma246chg(self, symbol, group, cgrup=None):
        """Grup ortalama SMA 246 CHG hesapla"""
        try:
            # Kuponlu gruplar i√ßin CGRUP'a g√∂re gruplama
            kuponlu_groups = ['heldkuponlu', 'heldkuponlukreciliz', 'heldkuponlukreorta']
            
            if group.lower() in kuponlu_groups and cgrup:
                # CGRUP'a g√∂re gruplama
                if self.df.empty:
                    return 0.01
                
                # Aynƒ± CGRUP'a sahip hisseleri bul
                cgrup_rows = self.df[(self.df['CGRUP'] == cgrup) & (self.df['PREF IBKR'] != symbol)]
                
                # SMA 246 CHG i√ßin farklƒ± kolon isimlerini dene - "SMA246 chg" formatƒ±nƒ± √∂ncelikli yap
                sma246_col_names = ['SMA246 chg', 'SMA 246 CHG', 'SMA246CHG', 'SMA246_CHG', 'SMA 246 chg']
                for col_name in sma246_col_names:
                    if col_name in self.df.columns:
                        sma246_values = cgrup_rows[col_name].dropna()
                        sma246_values = pd.to_numeric(sma246_values, errors='coerce').dropna()
                        if not sma246_values.empty:
                            avg = sma246_values.mean()
                            # Sadece ilk birka√ß i√ßin log
                            if not hasattr(self, '_gort_group_avg_log_count'):
                                self._gort_group_avg_log_count = 0
                            if self._gort_group_avg_log_count < 3:
                                # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
                                # print(f"[GORT] üìä {symbol} ({group}, CGRUP={cgrup}): SMA246 grup ortalamasƒ± = {avg:.2f} ({len(sma246_values)} hisse)")
                                self._gort_group_avg_log_count += 1
                            return avg if avg != 0 else 0.01
                
                return 0.01
            
            # Normal gruplar i√ßin grup dosyasƒ±ndan
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            file_name = group_file_map.get(group.lower())
            if not file_name or not os.path.exists(file_name):
                return 0.01
            
            # Grup dosyasƒ±ndan hisseleri al
            df = pd.read_csv(file_name)
            group_symbols = set(df['PREF IBKR'].tolist())
            
            # Parent DataFrame'den bu gruba ait hisselerin SMA 246 CHG deƒüerlerini al
            if not self.df.empty:
                group_rows = self.df[self.df['PREF IBKR'].isin(group_symbols)]
                
                # SMA 246 CHG i√ßin farklƒ± kolon isimlerini dene - "SMA246 chg" formatƒ±nƒ± √∂ncelikli yap
                sma246_col_names = ['SMA246 chg', 'SMA 246 CHG', 'SMA246CHG', 'SMA246_CHG', 'SMA 246 chg']
                for col_name in sma246_col_names:
                    if col_name in self.df.columns:
                        sma246_values = group_rows[col_name].dropna()
                        sma246_values = pd.to_numeric(sma246_values, errors='coerce').dropna()
                        if not sma246_values.empty:
                            avg = sma246_values.mean()
                            # Sadece ilk birka√ß i√ßin log
                            if not hasattr(self, '_gort_group_avg_log_count'):
                                self._gort_group_avg_log_count = 0
                            if self._gort_group_avg_log_count < 3:
                                # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
                                # print(f"[GORT] üìä {symbol} ({group}): SMA246 grup ortalamasƒ± = {avg:.2f} ({len(sma246_values)} hisse)")
                                self._gort_group_avg_log_count += 1
                            return avg if avg != 0 else 0.01
            
            return 0.01
            
        except Exception as e:
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[GORT] ‚ùå {symbol} grup ortalama SMA 246 CHG hesaplama hatasƒ±: {e}")
            return 0.01
    
    def calculate_gort_from_group_file(self, symbol):
        """GORT deƒüerini grup dosyasƒ±ndan direkt √ßek - Grup pencerelerindeki mantƒ±kla aynƒ± (CACHE'LENMƒ∞≈û)"""
        try:
            import time
            current_time = time.time()
            
            # Cache kontrol√º - GORT deƒüeri cache'de var mƒ±?
            if hasattr(self, 'gort_cache') and symbol in self.gort_cache:
                # Cache s√ºresi dolmu≈ü mu kontrol et
                if hasattr(self, 'gort_cache_time') and (current_time - self.gort_cache_time) < self.gort_cache_interval:
                    return self.gort_cache[symbol]
            
            # Grup bilgisini al
            group = self.get_group_from_symbol(symbol)
            if group == "N/A":
                return 0.0
            
            # Grup dosya e≈üle≈ümesi
            group_file_map = {
                'heldff': 'ssfinekheldff.csv',
                'helddeznff': 'ssfinekhelddeznff.csv', 
                'heldkuponlu': 'ssfinekheldkuponlu.csv',
                'heldnff': 'ssfinekheldnff.csv',
                'heldflr': 'ssfinekheldflr.csv',
                'heldgarabetaltiyedi': 'ssfinekheldgarabetaltiyedi.csv',
                'heldkuponlukreciliz': 'ssfinekheldkuponlukreciliz.csv',
                'heldkuponlukreorta': 'ssfinekheldkuponlukreorta.csv',
                'heldotelremorta': 'ssfinekheldotelremorta.csv',
                'heldsolidbig': 'ssfinekheldsolidbig.csv',
                'heldtitrekhc': 'ssfinekheldtitrekhc.csv',
                'highmatur': 'ssfinekhighmatur.csv',
                'notcefilliquid': 'ssfineknotcefilliquid.csv',
                'notbesmaturlu': 'ssfineknotbesmaturlu.csv',
                'nottitrekhc': 'ssfineknottitrekhc.csv',
                'salakilliquid': 'ssfineksalakilliquid.csv',
                'shitremhc': 'ssfinekshitremhc.csv'
            }
            
            file_name = group_file_map.get(group.lower())
            if not file_name or not os.path.exists(file_name):
                return 0.0
            
            # Grup dosyasƒ±nƒ± cache'den al veya oku
            if hasattr(self, 'group_file_cache') and group.lower() in self.group_file_cache:
                group_df = self.group_file_cache[group.lower()]
            else:
                # Cache'de yok, oku ve cache'le
                group_df = pd.read_csv(file_name)
                if not hasattr(self, 'group_file_cache'):
                    self.group_file_cache = {}
                self.group_file_cache[group.lower()] = group_df
            
            # Symbol'√º bul
            symbol_row = group_df[group_df['PREF IBKR'] == symbol]
            if symbol_row.empty:
                return 0.0
            
            # SMA 63 CHG ve SMA 246 CHG deƒüerlerini al
            sma63chg = None
            sma246chg = None
            
            # SMA 63 CHG i√ßin farklƒ± isimleri dene
            sma63_col_names = ['SMA63 chg', 'SMA63CHG', 'SMA63_chg', 'SMA 63 CHG']
            for col_name in sma63_col_names:
                if col_name in group_df.columns:
                    sma63chg_val = symbol_row[col_name].iloc[0]
                    if pd.notna(sma63chg_val):
                        sma63chg = pd.to_numeric(sma63chg_val, errors='coerce')
                        if not pd.isna(sma63chg):
                            break
            
            # SMA 246 CHG i√ßin farklƒ± isimleri dene - "SMA246 chg" formatƒ±nƒ± √∂ncelikli yap
            sma246_col_names = ['SMA246 chg', 'SMA 246 CHG', 'SMA246CHG', 'SMA246_CHG', 'SMA 246 chg']
            for col_name in sma246_col_names:
                if col_name in group_df.columns:
                    sma246chg_val = symbol_row[col_name].iloc[0]
                    if pd.notna(sma246chg_val):
                        sma246chg = pd.to_numeric(sma246chg_val, errors='coerce')
                        if not pd.isna(sma246chg):
                            break
            
            if sma63chg is None or sma246chg is None:
                return 0.0
            
            # CGRUP bilgisini al (kuponlu gruplar i√ßin)
            cgrup = None
            if 'CGRUP' in group_df.columns:
                cgrup_val = symbol_row['CGRUP'].iloc[0]
                if pd.notna(cgrup_val) and cgrup_val != '' and cgrup_val != 'N/A':
                    cgrup = str(cgrup_val).strip()
            
            # Grup ortalamalarƒ±nƒ± hesapla - Cache'den al veya hesapla
            kuponlu_groups = ['heldkuponlu', 'heldkuponlukreciliz', 'heldkuponlukreorta']
            
            # Cache key olu≈ütur
            cache_key_sma63 = (group.lower(), cgrup if (group.lower() in kuponlu_groups and cgrup) else None, 'sma63')
            cache_key_sma246 = (group.lower(), cgrup if (group.lower() in kuponlu_groups and cgrup) else None, 'sma246')
            
            # SMA 63 CHG ortalama - Cache'den al
            if hasattr(self, 'group_avg_cache') and cache_key_sma63 in self.group_avg_cache:
                group_avg_sma63 = self.group_avg_cache[cache_key_sma63]
            else:
                # Cache'de yok, hesapla
                if group.lower() in kuponlu_groups and cgrup:
                    # CGRUP'a g√∂re gruplama
                    cgrup_rows = group_df[(group_df['CGRUP'] == cgrup) & (group_df['PREF IBKR'] != symbol)]
                    
                    # SMA 63 CHG ortalama
                    for col_name in sma63_col_names:
                        if col_name in group_df.columns:
                            sma63_values = cgrup_rows[col_name].dropna()
                            sma63_values = pd.to_numeric(sma63_values, errors='coerce').dropna()
                            if not sma63_values.empty:
                                group_avg_sma63 = sma63_values.mean()
                                if group_avg_sma63 == 0:
                                    group_avg_sma63 = 0.01
                                break
                    else:
                        group_avg_sma63 = 0.01
                else:
                    # Normal gruplar i√ßin - Grup dosyasƒ±ndaki t√ºm hisselerin ortalamasƒ±
                    for col_name in sma63_col_names:
                        if col_name in group_df.columns:
                            sma63_values = group_df[col_name].dropna()
                            sma63_values = pd.to_numeric(sma63_values, errors='coerce').dropna()
                            if not sma63_values.empty:
                                group_avg_sma63 = sma63_values.mean()
                                if group_avg_sma63 == 0:
                                    group_avg_sma63 = 0.01
                                break
                    else:
                        group_avg_sma63 = 0.01
                
                # Cache'le
                if not hasattr(self, 'group_avg_cache'):
                    self.group_avg_cache = {}
                self.group_avg_cache[cache_key_sma63] = group_avg_sma63
            
            # SMA 246 CHG ortalama - Cache'den al
            if hasattr(self, 'group_avg_cache') and cache_key_sma246 in self.group_avg_cache:
                group_avg_sma246 = self.group_avg_cache[cache_key_sma246]
            else:
                # Cache'de yok, hesapla
                if group.lower() in kuponlu_groups and cgrup:
                    # CGRUP'a g√∂re gruplama
                    cgrup_rows = group_df[(group_df['CGRUP'] == cgrup) & (group_df['PREF IBKR'] != symbol)]
                    
                    # SMA 246 CHG ortalama
                    for col_name in sma246_col_names:
                        if col_name in group_df.columns:
                            sma246_values = cgrup_rows[col_name].dropna()
                            sma246_values = pd.to_numeric(sma246_values, errors='coerce').dropna()
                            if not sma246_values.empty:
                                group_avg_sma246 = sma246_values.mean()
                                if group_avg_sma246 == 0:
                                    group_avg_sma246 = 0.01
                                break
                    else:
                        group_avg_sma246 = 0.01
                else:
                    # Normal gruplar i√ßin - Grup dosyasƒ±ndaki t√ºm hisselerin ortalamasƒ±
                    for col_name in sma246_col_names:
                        if col_name in group_df.columns:
                            sma246_values = group_df[col_name].dropna()
                            sma246_values = pd.to_numeric(sma246_values, errors='coerce').dropna()
                            if not sma246_values.empty:
                                group_avg_sma246 = sma246_values.mean()
                                if group_avg_sma246 == 0:
                                    group_avg_sma246 = 0.01
                                break
                    else:
                        group_avg_sma246 = 0.01
                
                # Cache'le
                if not hasattr(self, 'group_avg_cache'):
                    self.group_avg_cache = {}
                self.group_avg_cache[cache_key_sma246] = group_avg_sma246
            
            # GORT hesapla (SMA63: %25, SMA246: %75 aƒüƒ±rlƒ±k)
            gort = (0.25 * (sma63chg - group_avg_sma63)) + (0.75 * (sma246chg - group_avg_sma246))
            
            # GORT'u cache'le
            if not hasattr(self, 'gort_cache'):
                self.gort_cache = {}
            if not hasattr(self, 'gort_cache_time'):
                self.gort_cache_time = current_time
            self.gort_cache[symbol] = gort
            self.gort_cache_time = current_time  # Cache zamanƒ±nƒ± g√ºncelle
            
            return gort
            
        except Exception as e:
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[GORT] ‚ùå {symbol} grup dosyasƒ±ndan GORT hesaplama hatasƒ±: {e}")
            return 0.0
    
    def calculate_gort(self, symbol):
        """GORT deƒüerini hesapla - √ñnce grup dosyasƒ±ndan √ßek, yoksa normal hesapla"""
        try:
            # √ñnce grup dosyasƒ±ndan √ßek (grup pencerelerindeki mantƒ±kla aynƒ±)
            gort = self.calculate_gort_from_group_file(symbol)
            if gort != 0.0:
                return gort
            
            # Fallback: Normal hesaplama (eski mantƒ±k)
            if self.df.empty:
                return 0.0
            
            # Symbol'√ºn satƒ±rƒ±nƒ± bul
            row = self.df[self.df['PREF IBKR'] == symbol]
            if row.empty:
                return 0.0
            
            # SMA 63 CHG ve SMA 246 CHG deƒüerlerini al
            sma63chg = None
            sma246chg = None
            
            # SMA 63 CHG i√ßin farklƒ± isimleri dene
            sma63_col_names = ['SMA63 chg', 'SMA63CHG', 'SMA63_chg', 'SMA 63 CHG']
            for col_name in sma63_col_names:
                if col_name in self.df.columns:
                    sma63chg_val = row[col_name].iloc[0]
                    if pd.notna(sma63chg_val):
                        sma63chg = pd.to_numeric(sma63chg_val, errors='coerce')
                        if not pd.isna(sma63chg):
                            break
            
            # SMA 246 CHG i√ßin farklƒ± isimleri dene
            sma246_col_names = ['SMA246 chg', 'SMA 246 CHG', 'SMA246CHG', 'SMA246_CHG', 'SMA 246 chg']
            for col_name in sma246_col_names:
                if col_name in self.df.columns:
                    sma246chg_val = row[col_name].iloc[0]
                    if pd.notna(sma246chg_val):
                        sma246chg = pd.to_numeric(sma246chg_val, errors='coerce')
                        if not pd.isna(sma246chg):
                            break
            
            if sma63chg is None or sma246chg is None:
                return 0.0
            
            # Grup bilgisini al
            group = self.get_group_from_symbol(symbol)
            cgrup = self.get_cgrup_from_symbol(symbol)
            
            if group == "N/A":
                return 0.0
            
            # Grup ortalamalarƒ±nƒ± hesapla
            group_avg_sma63 = self.calculate_group_avg_sma63chg(symbol, group, cgrup)
            group_avg_sma246 = self.calculate_group_avg_sma246chg(symbol, group, cgrup)
            
            # GORT hesapla (SMA63: %25, SMA246: %75 aƒüƒ±rlƒ±k)
            gort = (0.25 * (sma63chg - group_avg_sma63)) + (0.75 * (sma246chg - group_avg_sma246))
            
            return gort
            
        except Exception as e:
            # Debug mesajƒ± kapatƒ±ldƒ± - performans i√ßin
            # print(f"[GORT] ‚ùå {symbol} GORT hesaplama hatasƒ±: {e}")
            return 0.0
    
    def get_srpan_values(self, symbol):
        """
        SRPAN (Spread Real Print Analyzer) - √áift taraflƒ± fiyat yoƒüunluƒüu analizi
        
        Son 30 tick'te (9 lot altƒ± √ßƒ±karƒ±ldƒ±ktan sonra) iki ayrƒ± fiyat yoƒüunluƒüu arar:
        1. Ana GRPAN deƒüeri (birincil yoƒüunla≈üma)
        2. ƒ∞kincil GRPAN deƒüeri (farklƒ± bir b√∂lgedeki yoƒüunla≈üma, en az 0.08¬¢ uzakta)
        
        SRPAN Skoru (0-100):
        - %60: G1-G2 yoƒüunluk farkƒ±nƒ±n minimal olmasƒ± (50-50'ye yakƒ±nlƒ±k)
        - %15: G1+G2 toplamƒ±nƒ±n 100'e yakƒ±nlƒ±ƒüƒ±
        - %25: Spread geni≈üliƒüi
        
        Returns:
            dict: {..., 'srpan_score': Kompozit skor}
        """
        try:
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                return None
            
            # Son 30 tick'i al (9 lot altƒ± filtrelenecek)
            tick_data = self.hammer.get_ticks(symbol, lastFew=60, tradesOnly=False, regHoursOnly=True)
            
            if not tick_data or 'data' not in tick_data or not tick_data['data']:
                return None
            
            all_ticks = tick_data['data']
            
            # 9 lot ve altƒ±ndaki print'leri IGNORE et
            filtered_ticks = [tick for tick in all_ticks if tick.get('s', 0) > 9]
            
            # Son 30 tick'i al
            last_30_ticks = filtered_ticks[-30:] if len(filtered_ticks) >= 30 else filtered_ticks
            
            if len(last_30_ticks) < 8:
                print(f"[SRPAN] ‚ö†Ô∏è {symbol}: Yetersiz tick verisi ({len(last_30_ticks)} tick)")
                return None
            
            # Fiyatlarƒ± ve aƒüƒ±rlƒ±klarƒ± topla
            from collections import defaultdict
            price_weights = defaultdict(float)
            
            for tick in last_30_ticks:
                price = tick.get('p', 0)
                size = tick.get('s', 0)
                
                if price > 0:
                    price = round(price, 2)
                    
                    # Aƒüƒ±rlƒ±k: 100/200/300 lot = 1.00, diƒüer = 0.25
                    if size in [100, 200, 300]:
                        weight = 1.00
                    else:
                        weight = 0.25
                    
                    price_weights[price] += weight
            
            if len(price_weights) < 2:
                return None
            
            # Toplam aƒüƒ±rlƒ±k
            total_weight = sum(price_weights.values())
            
            # 1. En y√ºksek aƒüƒ±rlƒ±klƒ± fiyatƒ± bul (GRPAN1)
            grpan1 = max(price_weights.keys(), key=lambda p: price_weights[p])
            
            # GRPAN1 ¬±0.04 aralƒ±ƒüƒ±ndaki toplam aƒüƒ±rlƒ±ƒüƒ± hesapla
            grpan1_range_min = grpan1 - 0.04
            grpan1_range_max = grpan1 + 0.04
            grpan1_range_weight = sum(w for p, w in price_weights.items() if grpan1_range_min <= p <= grpan1_range_max)
            grpan1_conf = (grpan1_range_weight / total_weight) * 100 if total_weight > 0 else 0
            
            # 2. GRPAN1 aralƒ±ƒüƒ± dƒ±≈üƒ±ndaki fiyatlardan ikincil yoƒüunluƒüu bul (GRPAN2)
            # En az 0.08¬¢ uzakta olmalƒ±
            excluded_prices = {p: w for p, w in price_weights.items() 
                             if abs(p - grpan1) >= 0.08}
            
            if not excluded_prices:
                # ƒ∞kincil yoƒüunluk bulunamadƒ±
                return {
                    'grpan1': grpan1,
                    'grpan1_conf': grpan1_conf,
                    'grpan2': None,
                    'grpan2_conf': 0,
                    'spread': 0,
                    'direction': 'N/A',
                    'srpan_score': 0
                }
            
            # GRPAN2'yi bul
            grpan2 = max(excluded_prices.keys(), key=lambda p: excluded_prices[p])
            
            # GRPAN2 ¬±0.04 aralƒ±ƒüƒ±ndaki toplam aƒüƒ±rlƒ±ƒüƒ± hesapla
            grpan2_range_min = grpan2 - 0.04
            grpan2_range_max = grpan2 + 0.04
            grpan2_range_weight = sum(w for p, w in price_weights.items() 
                                     if grpan2_range_min <= p <= grpan2_range_max 
                                     and abs(p - grpan1) >= 0.08)
            grpan2_conf = (grpan2_range_weight / total_weight) * 100 if total_weight > 0 else 0
            
            # Spread hesapla
            spread = abs(grpan2 - grpan1)
            direction = 'UP' if grpan2 > grpan1 else 'DOWN'
            
            # ============ SRPAN SKOR HESAPLAMA ============
            # 1. G1-G2 yoƒüunluk farkƒ±nƒ±n minimal olmasƒ± (%60 aƒüƒ±rlƒ±k)
            # En iyi durum: fark = 0 (50-50)
            # En k√∂t√º durum: fark = 100 (tek taraf)
            conf_diff = abs(grpan1_conf - grpan2_conf)
            # Fark 0 ise 100 puan, fark 100 ise 0 puan
            balance_score = max(0, 100 - conf_diff)
            
            # 2. G1+G2 toplamƒ±nƒ±n 100'e yakƒ±nlƒ±ƒüƒ± (%15 aƒüƒ±rlƒ±k)
            # En iyi durum: toplam = 100
            # Toplam ne kadar y√ºksekse o kadar iyi
            total_conf = grpan1_conf + grpan2_conf
            # Toplam 100 ise 100 puan, toplam 0 ise 0 puan
            total_score = min(100, total_conf)
            
            # 3. Spread geni≈üliƒüi (%25 aƒüƒ±rlƒ±k)
            # Spread $0.30+ m√ºkemmel, $0.08 minimum
            # 0.08 = 0 puan, 0.30+ = 100 puan
            if spread >= 0.30:
                spread_score = 100
            elif spread <= 0.08:
                spread_score = 0
            else:
                # Linear interpolation between 0.08 and 0.30
                spread_score = ((spread - 0.08) / (0.30 - 0.08)) * 100
            
            # Kompozit SRPAN skoru
            srpan_score = (0.60 * balance_score) + (0.15 * total_score) + (0.25 * spread_score)
            
            print(f"[SRPAN] ‚úÖ {symbol}: G1=${grpan1:.2f} ({grpan1_conf:.0f}%), G2=${grpan2:.2f} ({grpan2_conf:.0f}%), Spread=${spread:.2f}")
            print(f"[SRPAN] üìä {symbol}: BalanceScore={balance_score:.0f}, TotalScore={total_score:.0f}, SpreadScore={spread_score:.0f} ‚Üí SRPAN={srpan_score:.1f}")
            
            return {
                'grpan1': grpan1,
                'grpan1_conf': grpan1_conf,
                'grpan2': grpan2,
                'grpan2_conf': grpan2_conf,
                'spread': spread,
                'direction': direction,
                'balance_score': balance_score,
                'total_score': total_score,
                'spread_score': spread_score,
                'srpan_score': srpan_score
            }
            
        except Exception as e:
            print(f"[SRPAN] ‚ùå {symbol} SRPAN hesaplama hatasƒ±: {e}")
            return None
    
    def show_srpan_analysis(self):
        """SRPAN analiz penceresi - Se√ßili gruptaki hisseler i√ßin √ßift taraflƒ± spread analizi"""
        try:
            print(f"[SRPAN] üîç Spread Real Print analizi ba≈ülatƒ±lƒ±yor...")
            
            # Mevcut grup verisi var mƒ± kontrol et
            if self.srpan_current_data is None or self.srpan_current_data.empty:
                messagebox.showwarning("Uyarƒ±", "√ñnce bir grup se√ßin (heldkuponlu, heldff vb.)")
                return
            
            # Hammer Pro baƒülƒ± mƒ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("Uyarƒ±", "Hammer Pro baƒülantƒ±sƒ± gerekli!")
                return
            
            group_name = self.srpan_current_group
            df = self.srpan_current_data
            
            # SRPAN sonu√ßlarƒ± penceresi
            import tkinter as tk
            from tkinter import ttk
            
            srpan_win = tk.Toplevel(self)
            srpan_win.title(f"SRPAN - Spread Real Print Analyzer [{group_name}]")
            srpan_win.geometry("1200x600")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            # Ba≈ülƒ±k
            title_label = ttk.Label(srpan_win, 
                text=f"SRPAN - √áift Taraflƒ± Fiyat Yoƒüunluƒüu Analizi [{group_name}]", 
                font=("Arial", 12, "bold"))
            title_label.pack(pady=5)
            
            # A√ßƒ±klama
            info_label = ttk.Label(srpan_win, 
                text="SRPAN Skoru: %60 G1-G2 denge + %15 Toplam yoƒüunluk + %25 Spread geni≈üliƒüi",
                font=("Arial", 9, 'italic'))
            info_label.pack(pady=3)
            
            # Progress label
            progress_label = ttk.Label(srpan_win, text="Analiz ba≈ülƒ±yor...")
            progress_label.pack(pady=5)
            
            # Tree frame
            tree_frame = ttk.Frame(srpan_win)
            tree_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # SRPAN sonu√ßlarƒ± tablosu - SRPAN Score eklendi
            columns = ('Symbol', 'SRPAN', 'G1', 'G1%', 'G2', 'G2%', 'Spread', 'Bal', 'Tot', 'Spr', 'Dir')
            srpan_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=20)
            
            col_widths = {
                'Symbol': 100, 'SRPAN': 70, 'G1': 80, 'G1%': 50, 'G2': 80, 
                'G2%': 50, 'Spread': 70, 'Bal': 50, 'Tot': 50, 'Spr': 50, 'Dir': 50
            }
            
            headers = {
                'Symbol': 'Symbol', 'SRPAN': 'SRPAN', 'G1': 'GRPAN1', 'G1%': 'G1%',
                'G2': 'GRPAN2', 'G2%': 'G2%', 'Spread': 'Spread', 
                'Bal': 'Bal', 'Tot': 'Tot', 'Spr': 'Spr', 'Dir': 'Dir'
            }
            
            for col in columns:
                srpan_tree.heading(col, text=headers[col])
                srpan_tree.column(col, width=col_widths.get(col, 60), anchor='center')
            
            scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=srpan_tree.yview)
            srpan_tree.configure(yscrollcommand=scrollbar.set)
            srpan_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # Sonu√ßlarƒ± hesapla
            srpan_results = []
            symbols = df['PREF IBKR'].tolist() if 'PREF IBKR' in df.columns else []
            
            total = len(symbols)
            for i, symbol in enumerate(symbols):
                progress_label.config(text=f"Analiz ediliyor: {symbol} ({i+1}/{total})")
                srpan_win.update()
                
                srpan_data = self.get_srpan_values(symbol)
                
                if srpan_data:
                    srpan_results.append({
                        'symbol': symbol,
                        'grpan1': srpan_data['grpan1'],
                        'grpan1_conf': srpan_data['grpan1_conf'],
                        'grpan2': srpan_data['grpan2'],
                        'grpan2_conf': srpan_data['grpan2_conf'],
                        'spread': srpan_data['spread'],
                        'direction': srpan_data['direction'],
                        'balance_score': srpan_data.get('balance_score', 0),
                        'total_score': srpan_data.get('total_score', 0),
                        'spread_score': srpan_data.get('spread_score', 0),
                        'srpan_score': srpan_data.get('srpan_score', 0)
                    })
                else:
                    srpan_results.append({
                        'symbol': symbol,
                        'grpan1': None,
                        'grpan1_conf': 0,
                        'grpan2': None,
                        'grpan2_conf': 0,
                        'spread': 0,
                        'direction': 'N/A',
                        'balance_score': 0,
                        'total_score': 0,
                        'spread_score': 0,
                        'srpan_score': 0
                    })
            
            # SRPAN skoruna g√∂re b√ºy√ºkten k√º√ß√ºƒüe sƒ±rala
            srpan_results.sort(key=lambda x: x['srpan_score'], reverse=True)
            
            # Tabloya ekle
            for result in srpan_results:
                srpan_score = result['srpan_score']
                
                if result['grpan1'] is not None:
                    grpan1_str = f"${result['grpan1']:.2f}"
                    g1_conf_str = f"{result['grpan1_conf']:.0f}%"
                else:
                    grpan1_str = "N/A"
                    g1_conf_str = "N/A"
                
                if result['grpan2'] is not None:
                    grpan2_str = f"${result['grpan2']:.2f}"
                    g2_conf_str = f"{result['grpan2_conf']:.0f}%"
                    spread_str = f"${result['spread']:.2f}"
                    direction_str = result['direction']
                    bal_str = f"{result['balance_score']:.0f}"
                    tot_str = f"{result['total_score']:.0f}"
                    spr_str = f"{result['spread_score']:.0f}"
                    
                    # Tag belirleme - SRPAN skoruna g√∂re
                    if srpan_score >= 70:
                        tag = 'excellent'
                    elif srpan_score >= 50:
                        tag = 'good'
                    elif srpan_score >= 30:
                        tag = 'fair'
                    else:
                        tag = 'low'
                else:
                    grpan2_str = "N/A"
                    g2_conf_str = "N/A"
                    spread_str = "N/A"
                    direction_str = "N/A"
                    bal_str = "0"
                    tot_str = "0"
                    spr_str = "0"
                    tag = 'no_second'
                
                srpan_str = f"{srpan_score:.1f}"
                
                values = [
                    result['symbol'],
                    srpan_str,
                    grpan1_str,
                    g1_conf_str,
                    grpan2_str,
                    g2_conf_str,
                    spread_str,
                    bal_str,
                    tot_str,
                    spr_str,
                    direction_str
                ]
                
                srpan_tree.insert('', 'end', values=values, tags=(tag,))
            
            # Tag renkleri
            srpan_tree.tag_configure('excellent', background='#32CD32')  # Lime ye≈üil (SRPAN ‚â•70)
            srpan_tree.tag_configure('good', background='#90EE90')  # A√ßƒ±k ye≈üil (SRPAN ‚â•50)
            srpan_tree.tag_configure('fair', background='#FFFFE0')  # A√ßƒ±k sarƒ± (SRPAN ‚â•30)
            srpan_tree.tag_configure('low', background='#FFD700')  # Altƒ±n sarƒ± (SRPAN <30)
            srpan_tree.tag_configure('no_second', background='#D3D3D3')  # Gri
            
            # Sonu√ß √∂zeti
            excellent_count = sum(1 for r in srpan_results if r['srpan_score'] >= 70)
            good_count = sum(1 for r in srpan_results if 50 <= r['srpan_score'] < 70)
            
            progress_label.config(
                text=f"‚úÖ Tamamlandƒ±! üéØ M√ºkemmel (‚â•70): {excellent_count} | ‚úÖ ƒ∞yi (‚â•50): {good_count} | Toplam: {len(srpan_results)}"
            )
            
            print(f"[SRPAN] ‚úÖ Analiz tamamlandƒ±: {len(srpan_results)} hisse")
            
        except Exception as e:
            print(f"[SRPAN] ‚ùå Analiz hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"SRPAN analiz hatasƒ±: {e}")
    
    def show_ticker_alerts(self):
        """Ticker Alerts penceresi - Se√ßili gruptaki hisseler i√ßin Daily High/Low takibi"""
        try:
            print(f"[TICKER ALERTS] üîî Ticker Alerts ba≈ülatƒ±lƒ±yor...")
            
            # Mevcut grup verisi var mƒ± kontrol et
            if self.srpan_current_data is None or self.srpan_current_data.empty:
                messagebox.showwarning("Uyarƒ±", "√ñnce bir grup se√ßin (heldkuponlu, heldff vb.)")
                return
            
            # Hammer Pro baƒülƒ± mƒ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("Uyarƒ±", "Hammer Pro baƒülantƒ±sƒ± gerekli!")
                return
            
            group_name = self.srpan_current_group
            df = self.srpan_current_data
            
            # Ticker Alerts penceresi
            import tkinter as tk
            from tkinter import ttk
            
            alerts_win = tk.Toplevel(self)
            alerts_win.title(f"üìä Ticker Alerts - Daily High/Low [{group_name}]")
            alerts_win.geometry("1300x700")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            # Ba≈ülƒ±k frame
            header_frame = ttk.Frame(alerts_win)
            header_frame.pack(fill='x', padx=10, pady=5)
            
            title_label = ttk.Label(header_frame, 
                text=f"üìä Ticker Alerts - Daily High/Low Monitor [{group_name}]", 
                font=("Arial", 12, "bold"))
            title_label.pack(side='left', pady=5)
            
            # Kontrol butonlarƒ±
            control_frame = ttk.Frame(alerts_win)
            control_frame.pack(fill='x', padx=10, pady=5)
            
            # Progress label
            progress_label = ttk.Label(control_frame, text="Veri y√ºkleniyor...")
            progress_label.pack(side='left', padx=5)
            
            # Refresh butonu
            def refresh_data():
                load_ticker_data()
            
            btn_refresh = ttk.Button(control_frame, text="üîÑ Yenile", command=refresh_data)
            btn_refresh.pack(side='right', padx=5)
            
            # =============== SOL PANEL - HIGH/LOW TABLOSU ===============
            left_frame = ttk.LabelFrame(alerts_win, text="üìà Hisse Durumlarƒ±")
            left_frame.pack(side='left', fill='both', expand=True, padx=5, pady=5)
            
            # Ana tablo
            columns = ('Symbol', 'Last', 'High', 'Low', 'H-Dist', 'L-Dist', 'Range', 'Vol')
            main_tree = ttk.Treeview(left_frame, columns=columns, show='headings', height=25)
            
            col_widths = {
                'Symbol': 100, 'Last': 70, 'High': 70, 'Low': 70, 
                'H-Dist': 70, 'L-Dist': 70, 'Range': 70, 'Vol': 90
            }
            
            for col in columns:
                main_tree.heading(col, text=col)
                main_tree.column(col, width=col_widths.get(col, 70), anchor='center')
            
            scrollbar_main = ttk.Scrollbar(left_frame, orient='vertical', command=main_tree.yview)
            main_tree.configure(yscrollcommand=scrollbar_main.set)
            main_tree.pack(side='left', fill='both', expand=True)
            scrollbar_main.pack(side='right', fill='y')
            
            # =============== SAƒû PANEL - ALERT GE√áMƒ∞≈ûƒ∞ ===============
            right_frame = ttk.LabelFrame(alerts_win, text="üîî Alert Ge√ßmi≈üi (New High/Low)")
            right_frame.pack(side='right', fill='both', expand=False, padx=5, pady=5, ipadx=5)
            
            # Alert tablosu
            alert_columns = ('Time', 'Symbol', 'Type', 'Price', 'Chg%')
            alert_tree = ttk.Treeview(right_frame, columns=alert_columns, show='headings', height=25)
            
            alert_col_widths = {'Time': 80, 'Symbol': 80, 'Type': 60, 'Price': 70, 'Chg%': 60}
            
            for col in alert_columns:
                alert_tree.heading(col, text=col)
                alert_tree.column(col, width=alert_col_widths.get(col, 60), anchor='center')
            
            scrollbar_alert = ttk.Scrollbar(right_frame, orient='vertical', command=alert_tree.yview)
            alert_tree.configure(yscrollcommand=scrollbar_alert.set)
            alert_tree.pack(side='left', fill='both', expand=True)
            scrollbar_alert.pack(side='right', fill='y')
            
            # Tag renkleri
            main_tree.tag_configure('near_high', background='#90EE90')  # A√ßƒ±k ye≈üil - High'a yakƒ±n
            main_tree.tag_configure('near_low', background='#FFB6C1')   # A√ßƒ±k kƒ±rmƒ±zƒ± - Low'a yakƒ±n
            main_tree.tag_configure('neutral', background='#FFFACD')    # A√ßƒ±k sarƒ± - Ortada
            main_tree.tag_configure('new_high', background='#32CD32')   # Koyu ye≈üil - NEW HIGH!
            main_tree.tag_configure('new_low', background='#FF6347')    # Kƒ±rmƒ±zƒ± - NEW LOW!
            
            alert_tree.tag_configure('high', background='#32CD32')
            alert_tree.tag_configure('low', background='#FF6347')
            
            # Veri yapƒ±larƒ±
            # baseline_data: ƒ∞lk y√ºklemede kaydedilen daily high/low deƒüerleri (deƒüi≈ümez referans)
            # ticker_data: ≈ûu anki fiyatlar ve hesaplanan high/low
            baseline_data = {}  # {symbol: {'baseline_high': x, 'baseline_low': y, 'prev_close': p}}
            ticker_data = {}    # {symbol: {'last': z, 'volume': v}}
            alert_history = []
            is_first_load = [True]  # Mutable container for nonlocal access
            
            def load_ticker_data():
                """T√ºm tickerlar i√ßin veri y√ºkle ve kar≈üƒ±la≈ütƒ±r
                
                MANTIK:
                - ƒ∞lk y√ºklemede: market_data'dan gelen HIGH ve LOW deƒüerlerini baseline olarak kaydet
                - Sonraki kontrollerde: Mevcut HIGH/LOW'u baseline ile kar≈üƒ±la≈ütƒ±r
                - Sadece baseline_high A≈ûILIRSA veya baseline_low'un ALTINA d√º≈ü√ºl√ºrse alert
                """
                nonlocal baseline_data, ticker_data, alert_history
                
                symbols = df['PREF IBKR'].tolist() if 'PREF IBKR' in df.columns else []
                total = len(symbols)
                
                print(f"[TICKER ALERTS] üìä {'ƒ∞lk y√ºkleme - getSymbolSnapshot ile Daily High/Low kaydediliyor' if is_first_load[0] else '30sn kontrol - getSymbolSnapshot ile kar≈üƒ±la≈ütƒ±rma'} - {total} sembol")
                
                main_tree.delete(*main_tree.get_children())
                new_high_count = 0
                new_low_count = 0
                
                for i, symbol in enumerate(symbols):
                    if i % 50 == 0:
                        progress_label.config(text=f"Kontrol: {symbol} ({i+1}/{total})")
                        alerts_win.update()
                    
                    try:
                        # getSymbolSnapshot kullanarak GER√áEK daily high/low al
                        snapshot = self.hammer.get_symbol_snapshot(symbol)
                        
                        if snapshot:
                            # Documentation'a g√∂re: high = Session high, low = Session low
                            last = float(snapshot.get('last', 0) or 0)
                            current_daily_high = float(snapshot.get('high', 0) or 0)
                            current_daily_low = float(snapshot.get('low', 0) or 0)
                            volume = snapshot.get('volume', 0)
                            prev_close = float(snapshot.get('prevClose', 0) or 0)
                            
                            if last <= 0:
                                continue
                            
                            # Eƒüer high/low yoksa last kullan (nadiren olur)
                            if current_daily_high <= 0:
                                current_daily_high = last
                            if current_daily_low <= 0 or current_daily_low > last:
                                current_daily_low = last
                            
                            # ƒ∞lk y√ºklemede: Daily High/Low'u baseline olarak kaydet
                            if is_first_load[0]:
                                baseline_data[symbol] = {
                                    'baseline_high': current_daily_high,  # DAILY HIGH
                                    'baseline_low': current_daily_low,    # DAILY LOW
                                    'prev_close': prev_close
                                }
                                ticker_data[symbol] = {'last': last, 'volume': volume}
                                tag = 'neutral'
                                # Debug: ƒ∞lk y√ºklemede sadece ilk 5 hisseyi logla
                                if len(baseline_data) <= 5:
                                    print(f"[BASELINE] {symbol}: Last=${last:.2f}, DailyHigh=${current_daily_high:.2f}, DailyLow=${current_daily_low:.2f}, PrevClose=${prev_close:.2f}")
                            else:
                                # Sonraki kontrollerde: Mevcut daily high/low'u baseline ile kar≈üƒ±la≈ütƒ±r
                                if symbol not in baseline_data:
                                    # Yeni sembol, baseline kaydet
                                    baseline_data[symbol] = {
                                        'baseline_high': current_daily_high,
                                        'baseline_low': current_daily_low,
                                        'prev_close': prev_close
                                    }
                                    tag = 'neutral'
                                else:
                                    baseline_high = baseline_data[symbol]['baseline_high']
                                    baseline_low = baseline_data[symbol]['baseline_low']
                                    stored_prev_close = baseline_data[symbol]['prev_close']
                                    
                                    tag = 'neutral'
                                    
                                    # NEW HIGH: Mevcut daily high, baseline high'ƒ± A≈ûTI mƒ±?
                                    if current_daily_high > baseline_high + 0.001:  # 0.001 tolerans
                                        tag = 'new_high'
                                        new_high_count += 1
                                        # Baseline'ƒ± g√ºncelle
                                        baseline_data[symbol]['baseline_high'] = current_daily_high
                                        # Alert ekle
                                        chg = ((last - stored_prev_close) / stored_prev_close * 100) if stored_prev_close > 0 else 0
                                        alert_entry = {
                                            'time': datetime.now().strftime('%H:%M:%S'),
                                            'symbol': symbol,
                                            'type': 'üî∫ HIGH',
                                            'price': last,
                                            'chg': chg
                                        }
                                        alert_history.insert(0, alert_entry)
                                        print(f"[TICKER ALERTS] üî∫ NEW DAILY HIGH: {symbol} ${current_daily_high:.2f} (√∂nceki: ${baseline_high:.2f})")
                                    
                                    # NEW LOW: Mevcut daily low, baseline low'un ALTINA d√º≈üt√º m√º?
                                    elif current_daily_low < baseline_low - 0.001:  # 0.001 tolerans
                                        tag = 'new_low'
                                        new_low_count += 1
                                        # Baseline'ƒ± g√ºncelle
                                        baseline_data[symbol]['baseline_low'] = current_daily_low
                                        # Alert ekle
                                        chg = ((last - stored_prev_close) / stored_prev_close * 100) if stored_prev_close > 0 else 0
                                        alert_entry = {
                                            'time': datetime.now().strftime('%H:%M:%S'),
                                            'symbol': symbol,
                                            'type': 'üîª LOW',
                                            'price': last,
                                            'chg': chg
                                        }
                                        alert_history.insert(0, alert_entry)
                                        print(f"[TICKER ALERTS] üîª NEW DAILY LOW: {symbol} ${current_daily_low:.2f} (√∂nceki: ${baseline_low:.2f})")
                                    else:
                                        # High/Low'a yakƒ±nlƒ±k
                                        range_val = baseline_high - baseline_low
                                        if range_val > 0:
                                            position = ((last - baseline_low) / range_val) * 100
                                            if position >= 80:
                                                tag = 'near_high'
                                            elif position <= 20:
                                                tag = 'near_low'
                                
                                ticker_data[symbol] = {'last': last, 'volume': volume}
                            
                            # Tabloda g√∂sterilecek deƒüerler (baseline veya g√ºncel)
                            if symbol in baseline_data:
                                high = baseline_data[symbol]['baseline_high']
                                low = baseline_data[symbol]['baseline_low']
                            else:
                                high = current_daily_high
                                low = current_daily_low
                            
                            # Hesaplamalar
                            range_val = high - low
                            h_dist = high - last
                            l_dist = last - low
                            
                            # Volume formatla
                            if volume:
                                vol_int = int(float(volume))
                                if vol_int >= 1000000:
                                    vol_str = f"{vol_int/1000000:.1f}M"
                                elif vol_int >= 1000:
                                    vol_str = f"{vol_int/1000:.0f}K"
                                else:
                                    vol_str = str(vol_int)
                            else:
                                vol_str = "N/A"
                            
                            values = [
                                symbol,
                                f"${last:.2f}",
                                f"${high:.2f}",
                                f"${low:.2f}",
                                f"${h_dist:.2f}",
                                f"${l_dist:.2f}",
                                f"${range_val:.2f}",
                                vol_str
                            ]
                            
                            main_tree.insert('', 'end', values=values, tags=(tag,))
                                
                    except Exception as e:
                        print(f"[TICKER ALERTS] ‚ö†Ô∏è {symbol} veri hatasƒ±: {e}")
                
                # Alert ge√ßmi≈üini g√ºncelle
                alert_tree.delete(*alert_tree.get_children())
                for alert in alert_history[:50]:  # Son 50 alert
                    alert_tag = 'high' if 'HIGH' in alert['type'] else 'low'
                    alert_tree.insert('', 'end', values=[
                        alert['time'],
                        alert['symbol'],
                        alert['type'],
                        f"${alert['price']:.2f}",
                        f"{alert['chg']:+.2f}%"
                    ], tags=(alert_tag,))
                
                # ƒ∞lk y√ºkleme tamamlandƒ±
                is_first_load[0] = False
                
                # Sonu√ß √∂zeti
                progress_label.config(
                    text=f"‚úÖ {len(baseline_data)} hisse | üî∫ {new_high_count} New High | üîª {new_low_count} New Low | Son: {datetime.now().strftime('%H:%M:%S')}"
                )
                
                print(f"[TICKER ALERTS] ‚úÖ {len(baseline_data)} hisse | New High: {new_high_count} | New Low: {new_low_count}")
            
            # ƒ∞lk y√ºkleme
            from datetime import datetime
            load_ticker_data()
            
            # Otomatik yenileme (her 30 saniye)
            def auto_refresh():
                if alerts_win.winfo_exists():
                    load_ticker_data()
                    alerts_win.after(30000, auto_refresh)
            
            # ƒ∞lk otomatik yenileme zamanlamasƒ±
            alerts_win.after(30000, auto_refresh)
            
            print(f"[TICKER ALERTS] ‚úÖ Pencere a√ßƒ±ldƒ±: {group_name}")
            
        except Exception as e:
            print(f"[TICKER ALERTS] ‚ùå Hata: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Ticker Alerts hatasƒ±: {e}")
    
    def show_etf_cardinal(self):
        """ETF Cardinal penceresi - ETF bazlƒ± emir iptal sistemi"""
        try:
            print(f"[ETF CARDINAL] üéØ ETF Cardinal ba≈ülatƒ±lƒ±yor...")
            
            # Hammer Pro baƒülƒ± mƒ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("Uyarƒ±", "Hammer Pro baƒülantƒ±sƒ± gerekli!")
                return
            
            # ETF Cardinal penceresi
            import tkinter as tk
            from tkinter import ttk
            from datetime import datetime
            import os
            
            # Eƒüer pencere zaten a√ßƒ±ksa, √∂ne getir
            if self.cardinal_window and self.cardinal_window.winfo_exists():
                self.cardinal_window.lift()
                return
            
            cardinal_win = tk.Toplevel(self)
            cardinal_win.title("üéØ ETF Cardinal - Otomatik Emir ƒ∞ptal Sistemi")
            cardinal_win.geometry("900x700")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            self.cardinal_window = cardinal_win
            
            # Pencere kapatƒ±ldƒ±ƒüƒ±nda tracker'ƒ± durdur
            def on_closing():
                self.stop_cardinal_tracker()
                cardinal_win.destroy()
                self.cardinal_window = None
            
            cardinal_win.protocol("WM_DELETE_WINDOW", on_closing)
            
            # =============== BA≈ûLIK ===============
            header_frame = ttk.Frame(cardinal_win)
            header_frame.pack(fill='x', padx=10, pady=5)
            
            title_label = ttk.Label(header_frame, 
                text="üéØ ETF Cardinal - Otomatik Emir ƒ∞ptal Sistemi", 
                font=("Arial", 14, "bold"))
            title_label.pack(side='left', pady=5)
            
            # Durum g√∂stergesi
            self.cardinal_status_label = ttk.Label(header_frame, text="‚ö™ Durduruldu", 
                                                   font=("Arial", 10, "bold"))
            self.cardinal_status_label.pack(side='right', padx=10)
            
            # =============== AYARLAR FRAME ===============
            settings_frame = ttk.LabelFrame(cardinal_win, text="‚öôÔ∏è E≈üik Ayarlarƒ± (D√º≈ü√º≈ü/Y√ºkseli≈ü Tetikleyicileri)")
            settings_frame.pack(fill='x', padx=10, pady=5)
            
            # Tablo ba≈ülƒ±klarƒ±
            header_row = ttk.Frame(settings_frame)
            header_row.pack(fill='x', padx=5, pady=2)
            
            ttk.Label(header_row, text="ETF", width=8, font=("Arial", 9, "bold")).pack(side='left', padx=5)
            ttk.Label(header_row, text="2dk E≈üik", width=12, font=("Arial", 9, "bold")).pack(side='left', padx=5)
            ttk.Label(header_row, text="5dk E≈üik", width=12, font=("Arial", 9, "bold")).pack(side='left', padx=5)
            ttk.Label(header_row, text="Tip", width=10, font=("Arial", 9, "bold")).pack(side='left', padx=5)
            
            # Entry'ler i√ßin dictionary
            self.cardinal_entries = {}
            
            etf_configs = [
                ('PFF', 'absolute', '$'),
                ('SPY', 'percent', '%'),
                ('KRE', 'percent', '%'),
                ('IWM', 'percent', '%'),
                ('TLT', 'absolute', '$')
            ]
            
            for etf, typ, symbol in etf_configs:
                row = ttk.Frame(settings_frame)
                row.pack(fill='x', padx=5, pady=2)
                
                ttk.Label(row, text=etf, width=8, font=("Arial", 10, "bold")).pack(side='left', padx=5)
                
                # 2dk entry
                entry_2min = ttk.Entry(row, width=10)
                entry_2min.insert(0, str(self.cardinal_settings[etf]['threshold_2min']))
                entry_2min.pack(side='left', padx=5)
                
                # 5dk entry
                entry_5min = ttk.Entry(row, width=10)
                entry_5min.insert(0, str(self.cardinal_settings[etf]['threshold_5min']))
                entry_5min.pack(side='left', padx=5)
                
                # Tip label
                ttk.Label(row, text=f"{symbol} ({typ})", width=12).pack(side='left', padx=5)
                
                self.cardinal_entries[etf] = {
                    'entry_2min': entry_2min,
                    'entry_5min': entry_5min,
                    'type': typ
                }
            
            # =============== KONTROL BUTONLARI ===============
            control_frame = ttk.Frame(cardinal_win)
            control_frame.pack(fill='x', padx=10, pady=10)
            
            def save_settings():
                """Ayarlarƒ± kaydet"""
                try:
                    for etf, entries in self.cardinal_entries.items():
                        val_2min = float(entries['entry_2min'].get())
                        val_5min = float(entries['entry_5min'].get())
                        self.cardinal_settings[etf]['threshold_2min'] = val_2min
                        self.cardinal_settings[etf]['threshold_5min'] = val_5min
                    
                    # CSV'ye kaydet
                    settings_path = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 
                                                'etf_cardinal_settings.csv')
                    with open(settings_path, 'w') as f:
                        f.write("etf,threshold_2min,threshold_5min,type\n")
                        for etf, settings in self.cardinal_settings.items():
                            f.write(f"{etf},{settings['threshold_2min']},{settings['threshold_5min']},{settings['type']}\n")
                    
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", "Ayarlar kaydedildi!")
                    print(f"[ETF CARDINAL] ‚úÖ Ayarlar kaydedildi: {settings_path}")
                except Exception as e:
                    messagebox.showerror("Hata", f"Ayar kaydetme hatasƒ±: {e}")
            
            def load_settings():
                """Ayarlarƒ± y√ºkle"""
                try:
                    settings_path = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 
                                                'etf_cardinal_settings.csv')
                    if os.path.exists(settings_path):
                        import pandas as pd
                        df = pd.read_csv(settings_path)
                        for _, row in df.iterrows():
                            etf = row['etf']
                            if etf in self.cardinal_settings:
                                self.cardinal_settings[etf]['threshold_2min'] = float(row['threshold_2min'])
                                self.cardinal_settings[etf]['threshold_5min'] = float(row['threshold_5min'])
                                # Entry'leri g√ºncelle
                                if etf in self.cardinal_entries:
                                    self.cardinal_entries[etf]['entry_2min'].delete(0, 'end')
                                    self.cardinal_entries[etf]['entry_2min'].insert(0, str(row['threshold_2min']))
                                    self.cardinal_entries[etf]['entry_5min'].delete(0, 'end')
                                    self.cardinal_entries[etf]['entry_5min'].insert(0, str(row['threshold_5min']))
                        print(f"[ETF CARDINAL] ‚úÖ Ayarlar y√ºklendi")
                except Exception as e:
                    print(f"[ETF CARDINAL] ‚ö†Ô∏è Ayar y√ºkleme hatasƒ±: {e}")
            
            # Ayarlarƒ± y√ºkle (ba≈ülangƒ±√ßta)
            load_settings()
            
            btn_save = ttk.Button(control_frame, text="üíæ Kaydet", command=save_settings)
            btn_save.pack(side='left', padx=5)
            
            self.btn_start_cardinal = ttk.Button(control_frame, text="‚ñ∂Ô∏è Cardinal Tracker Ba≈ülat", 
                                                command=lambda: self.start_cardinal_tracker(cardinal_win))
            self.btn_start_cardinal.pack(side='left', padx=5)
            
            self.btn_stop_cardinal = ttk.Button(control_frame, text="‚èπÔ∏è Durdur", 
                                               command=self.stop_cardinal_tracker, state='disabled')
            self.btn_stop_cardinal.pack(side='left', padx=5)
            
            # =============== CANLI DURUM FRAME ===============
            live_frame = ttk.LabelFrame(cardinal_win, text="üìä Canlƒ± ETF Durumu")
            live_frame.pack(fill='x', padx=10, pady=5)
            
            # Canlƒ± durum tablosu
            live_columns = ('ETF', 'Last', '2dk √ñnce', '2dk Chg', '5dk √ñnce', '5dk Chg', 'Durum')
            self.cardinal_live_tree = ttk.Treeview(live_frame, columns=live_columns, show='headings', height=5)
            
            col_widths = {'ETF': 60, 'Last': 80, '2dk √ñnce': 80, '2dk Chg': 80, '5dk √ñnce': 80, '5dk Chg': 80, 'Durum': 100}
            for col in live_columns:
                self.cardinal_live_tree.heading(col, text=col)
                self.cardinal_live_tree.column(col, width=col_widths.get(col, 80), anchor='center')
            
            self.cardinal_live_tree.pack(fill='x', padx=5, pady=5)
            
            # Tag renkleri
            self.cardinal_live_tree.tag_configure('bearish', background='#FF6347')  # Kƒ±rmƒ±zƒ±
            self.cardinal_live_tree.tag_configure('bullish', background='#32CD32')  # Ye≈üil
            self.cardinal_live_tree.tag_configure('neutral', background='#FFFACD')  # Sarƒ±
            
            # =============== LOG FRAME ===============
            log_frame = ttk.LabelFrame(cardinal_win, text="üìú ƒ∞≈ülem Logu")
            log_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Log text widget
            self.cardinal_log_text = tk.Text(log_frame, height=15, width=80, font=("Consolas", 9))
            log_scrollbar = ttk.Scrollbar(log_frame, orient='vertical', command=self.cardinal_log_text.yview)
            self.cardinal_log_text.configure(yscrollcommand=log_scrollbar.set)
            self.cardinal_log_text.pack(side='left', fill='both', expand=True, padx=5, pady=5)
            log_scrollbar.pack(side='right', fill='y')
            
            # Tag renkleri log i√ßin
            self.cardinal_log_text.tag_configure('cancel_buys', foreground='red', font=("Consolas", 9, "bold"))
            self.cardinal_log_text.tag_configure('cancel_sells', foreground='green', font=("Consolas", 9, "bold"))
            self.cardinal_log_text.tag_configure('info', foreground='blue')
            self.cardinal_log_text.tag_configure('normal', foreground='black')
            
            # Ba≈ülangƒ±√ß mesajƒ±
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] ETF Cardinal ba≈ülatƒ±ldƒ±. Tracker'ƒ± ba≈ülatmak i√ßin '‚ñ∂Ô∏è Cardinal Tracker Ba≈ülat' butonuna tƒ±klayƒ±n.", 'info')
            
            print(f"[ETF CARDINAL] ‚úÖ Pencere a√ßƒ±ldƒ±")
            
        except Exception as e:
            print(f"[ETF CARDINAL] ‚ùå Hata: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"ETF Cardinal hatasƒ±: {e}")
    
    def log_cardinal(self, message, tag='normal'):
        """Cardinal log'a mesaj ekle"""
        try:
            if hasattr(self, 'cardinal_log_text') and self.cardinal_log_text.winfo_exists():
                self.cardinal_log_text.insert('end', message + '\n', tag)
                self.cardinal_log_text.see('end')
        except:
            pass
    
    def start_cardinal_tracker(self, window):
        """Cardinal Tracker'ƒ± ba≈ülat"""
        try:
            from datetime import datetime
            
            self.cardinal_running = True
            self.cardinal_price_history = []
            
            # UI g√ºncelle
            self.btn_start_cardinal.config(state='disabled')
            self.btn_stop_cardinal.config(state='normal')
            self.cardinal_status_label.config(text="üü¢ √áalƒ±≈üƒ±yor", foreground='green')
            
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] ‚ñ∂Ô∏è Cardinal Tracker ba≈ülatƒ±ldƒ±!", 'info')
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] Her 1 dakikada veri √ßekilecek, 2dk ve 5dk deƒüi≈üimler kontrol edilecek.", 'info')
            
            # ƒ∞lk veri √ßekimi
            self.cardinal_check_etfs()
            
            print(f"[ETF CARDINAL] ‚ñ∂Ô∏è Tracker ba≈ülatƒ±ldƒ±")
            
        except Exception as e:
            print(f"[ETF CARDINAL] ‚ùå Ba≈ülatma hatasƒ±: {e}")
            self.cardinal_running = False
    
    def stop_cardinal_tracker(self):
        """Cardinal Tracker'ƒ± durdur"""
        try:
            from datetime import datetime
            
            self.cardinal_running = False
            
            # Zamanlayƒ±cƒ±yƒ± iptal et
            if self.cardinal_after_id:
                try:
                    if self.cardinal_window and self.cardinal_window.winfo_exists():
                        self.cardinal_window.after_cancel(self.cardinal_after_id)
                except:
                    pass
                self.cardinal_after_id = None
            
            # UI g√ºncelle
            if hasattr(self, 'btn_start_cardinal'):
                try:
                    self.btn_start_cardinal.config(state='normal')
                    self.btn_stop_cardinal.config(state='disabled')
                    self.cardinal_status_label.config(text="‚ö™ Durduruldu", foreground='gray')
                except:
                    pass
            
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] ‚èπÔ∏è Cardinal Tracker durduruldu.", 'info')
            
            print(f"[ETF CARDINAL] ‚èπÔ∏è Tracker durduruldu")
            
        except Exception as e:
            print(f"[ETF CARDINAL] ‚ùå Durdurma hatasƒ±: {e}")
    
    def cardinal_check_etfs(self):
        """ETF'leri kontrol et ve gerekirse cancel at"""
        if not self.cardinal_running:
            return
        
        try:
            from datetime import datetime
            import time
            
            current_time = datetime.now()
            timestamp = current_time.strftime('%H:%M:%S')
            
            # ETF fiyatlarƒ±nƒ± √ßek
            etf_list = ['PFF', 'SPY', 'KRE', 'IWM', 'TLT']
            current_prices = {'timestamp': current_time}
            
            for etf in etf_list:
                try:
                    market_data = self.hammer.get_market_data(etf)
                    if market_data:
                        last_price = float(market_data.get('last', 0) or 0)
                        current_prices[etf] = last_price
                    else:
                        current_prices[etf] = 0
                except Exception as e:
                    current_prices[etf] = 0
                    print(f"[ETF CARDINAL] ‚ö†Ô∏è {etf} veri hatasƒ±: {e}")
            
            # Ge√ßmi≈üe ekle
            self.cardinal_price_history.append(current_prices)
            
            # Son 6 dakikalƒ±k veriyi tut (5dk + 1 buffer)
            if len(self.cardinal_price_history) > 6:
                self.cardinal_price_history = self.cardinal_price_history[-6:]
            
            # Canlƒ± tabloyu g√ºncelle
            self.update_cardinal_live_table(current_prices)
            
            # Yeterli veri var mƒ± kontrol et (en az 2 dakika i√ßin 2 veri gerekli)
            if len(self.cardinal_price_history) >= 2:
                self.check_cardinal_thresholds(current_prices, timestamp)
            else:
                self.log_cardinal(f"[{timestamp}] ‚è≥ Veri toplama: {len(self.cardinal_price_history)}/2 (2dk i√ßin bekleniyor...)", 'info')
            
            # 1 dakika sonra tekrar √ßaƒüƒ±r
            if self.cardinal_running and self.cardinal_window and self.cardinal_window.winfo_exists():
                self.cardinal_after_id = self.cardinal_window.after(60000, self.cardinal_check_etfs)
            
        except Exception as e:
            print(f"[ETF CARDINAL] ‚ùå Check hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            # Hata olsa bile devam et
            if self.cardinal_running and self.cardinal_window and self.cardinal_window.winfo_exists():
                self.cardinal_after_id = self.cardinal_window.after(60000, self.cardinal_check_etfs)
    
    def update_cardinal_live_table(self, current_prices):
        """Canlƒ± tabloyu g√ºncelle"""
        try:
            # Tabloyu temizle
            for item in self.cardinal_live_tree.get_children():
                self.cardinal_live_tree.delete(item)
            
            etf_list = ['PFF', 'SPY', 'KRE', 'IWM', 'TLT']
            
            for etf in etf_list:
                current = current_prices.get(etf, 0)
                
                # 2dk √∂nceki fiyat
                price_2min_ago = 0
                if len(self.cardinal_price_history) >= 2:
                    price_2min_ago = self.cardinal_price_history[-2].get(etf, 0)
                
                # 5dk √∂nceki fiyat
                price_5min_ago = 0
                if len(self.cardinal_price_history) >= 5:
                    price_5min_ago = self.cardinal_price_history[-5].get(etf, 0)
                
                # Deƒüi≈üim hesapla
                settings = self.cardinal_settings[etf]
                
                if settings['type'] == 'absolute':
                    chg_2min = current - price_2min_ago if price_2min_ago > 0 else 0
                    chg_5min = current - price_5min_ago if price_5min_ago > 0 else 0
                    chg_2min_str = f"${chg_2min:+.2f}"
                    chg_5min_str = f"${chg_5min:+.2f}"
                else:
                    chg_2min = ((current - price_2min_ago) / price_2min_ago * 100) if price_2min_ago > 0 else 0
                    chg_5min = ((current - price_5min_ago) / price_5min_ago * 100) if price_5min_ago > 0 else 0
                    chg_2min_str = f"{chg_2min:+.2f}%"
                    chg_5min_str = f"{chg_5min:+.2f}%"
                
                # Durum belirleme
                threshold_2min = settings['threshold_2min']
                threshold_5min = settings['threshold_5min']
                
                if settings['type'] == 'absolute':
                    is_bearish = chg_2min <= -threshold_2min or chg_5min <= -threshold_5min
                    is_bullish = chg_2min >= threshold_2min or chg_5min >= threshold_5min
                else:
                    is_bearish = chg_2min <= -threshold_2min or chg_5min <= -threshold_5min
                    is_bullish = chg_2min >= threshold_2min or chg_5min >= threshold_5min
                
                if is_bearish:
                    status = "üî¥ BEARISH"
                    tag = 'bearish'
                elif is_bullish:
                    status = "üü¢ BULLISH"
                    tag = 'bullish'
                else:
                    status = "‚ö™ N√∂tr"
                    tag = 'neutral'
                
                values = [
                    etf,
                    f"${current:.2f}" if current > 0 else "N/A",
                    f"${price_2min_ago:.2f}" if price_2min_ago > 0 else "N/A",
                    chg_2min_str if price_2min_ago > 0 else "N/A",
                    f"${price_5min_ago:.2f}" if price_5min_ago > 0 else "N/A",
                    chg_5min_str if price_5min_ago > 0 else "N/A",
                    status
                ]
                
                self.cardinal_live_tree.insert('', 'end', values=values, tags=(tag,))
                
        except Exception as e:
            print(f"[ETF CARDINAL] ‚ùå Tablo g√ºncelleme hatasƒ±: {e}")
    
    def check_cardinal_thresholds(self, current_prices, timestamp):
        """E≈üikleri kontrol et ve gerekirse cancel at"""
        try:
            etf_list = ['PFF', 'SPY', 'KRE', 'IWM', 'TLT']
            
            bearish_triggers = []
            bullish_triggers = []
            
            for etf in etf_list:
                current = current_prices.get(etf, 0)
                settings = self.cardinal_settings[etf]
                
                # 2dk √∂nceki fiyat
                price_2min_ago = 0
                if len(self.cardinal_price_history) >= 2:
                    price_2min_ago = self.cardinal_price_history[-2].get(etf, 0)
                
                # 5dk √∂nceki fiyat
                price_5min_ago = 0
                if len(self.cardinal_price_history) >= 5:
                    price_5min_ago = self.cardinal_price_history[-5].get(etf, 0)
                
                threshold_2min = settings['threshold_2min']
                threshold_5min = settings['threshold_5min']
                
                if settings['type'] == 'absolute':
                    # Mutlak deƒüi≈üim (cent)
                    chg_2min = current - price_2min_ago if price_2min_ago > 0 else 0
                    chg_5min = current - price_5min_ago if price_5min_ago > 0 else 0
                    
                    # 2dk kontrol
                    if price_2min_ago > 0:
                        if chg_2min <= -threshold_2min:
                            bearish_triggers.append(f"{etf} 2dk: ${chg_2min:.2f} (e≈üik: -${threshold_2min})")
                        elif chg_2min >= threshold_2min:
                            bullish_triggers.append(f"{etf} 2dk: +${chg_2min:.2f} (e≈üik: +${threshold_2min})")
                    
                    # 5dk kontrol
                    if price_5min_ago > 0 and len(self.cardinal_price_history) >= 5:
                        if chg_5min <= -threshold_5min:
                            bearish_triggers.append(f"{etf} 5dk: ${chg_5min:.2f} (e≈üik: -${threshold_5min})")
                        elif chg_5min >= threshold_5min:
                            bullish_triggers.append(f"{etf} 5dk: +${chg_5min:.2f} (e≈üik: +${threshold_5min})")
                else:
                    # Y√ºzde deƒüi≈üim
                    chg_2min = ((current - price_2min_ago) / price_2min_ago * 100) if price_2min_ago > 0 else 0
                    chg_5min = ((current - price_5min_ago) / price_5min_ago * 100) if price_5min_ago > 0 else 0
                    
                    # 2dk kontrol
                    if price_2min_ago > 0:
                        if chg_2min <= -threshold_2min:
                            bearish_triggers.append(f"{etf} 2dk: {chg_2min:.2f}% (e≈üik: -{threshold_2min}%)")
                        elif chg_2min >= threshold_2min:
                            bullish_triggers.append(f"{etf} 2dk: +{chg_2min:.2f}% (e≈üik: +{threshold_2min}%)")
                    
                    # 5dk kontrol
                    if price_5min_ago > 0 and len(self.cardinal_price_history) >= 5:
                        if chg_5min <= -threshold_5min:
                            bearish_triggers.append(f"{etf} 5dk: {chg_5min:.2f}% (e≈üik: -{threshold_5min}%)")
                        elif chg_5min >= threshold_5min:
                            bullish_triggers.append(f"{etf} 5dk: +{chg_5min:.2f}% (e≈üik: +{threshold_5min}%)")
            
            # Tetikleyici varsa i≈ülem yap
            if bearish_triggers:
                self.log_cardinal(f"[{timestamp}] üî¥ BEARISH TETƒ∞KLEYƒ∞Cƒ∞: {', '.join(bearish_triggers)}", 'cancel_buys')
                self.log_cardinal(f"[{timestamp}] üî¥ CANCEL ALL BUYS tetikleniyor!", 'cancel_buys')
                self.cardinal_cancel_all_buys()
                
            elif bullish_triggers:
                self.log_cardinal(f"[{timestamp}] üü¢ BULLISH TETƒ∞KLEYƒ∞Cƒ∞: {', '.join(bullish_triggers)}", 'cancel_sells')
                self.log_cardinal(f"[{timestamp}] üü¢ CANCEL ALL SELLS tetikleniyor!", 'cancel_sells')
                self.cardinal_cancel_all_sells()
                
            else:
                self.log_cardinal(f"[{timestamp}] ‚úÖ T√ºm ETF'ler normal aralƒ±kta.", 'normal')
            
        except Exception as e:
            print(f"[ETF CARDINAL] ‚ùå Threshold kontrol hatasƒ±: {e}")
    
    def cardinal_cancel_all_buys(self):
        """T√ºm BUY emirlerini iptal et"""
        try:
            from datetime import datetime
            timestamp = datetime.now().strftime('%H:%M:%S')
            
            # A√ßƒ±k emirleri al
            orders = self.hammer.get_orders(self.hammer.account_key)
            
            buy_orders = [o for o in orders if o.get('Action', '').lower() in ['buy'] and o.get('IsOpen', False)]
            
            if not buy_orders:
                self.log_cardinal(f"[{timestamp}] ‚ÑπÔ∏è ƒ∞ptal edilecek BUY emri bulunamadƒ±.", 'info')
                return
            
            cancelled_count = 0
            for order in buy_orders:
                order_id = order.get('OrderID')
                symbol = order.get('Symbol', 'N/A')
                
                if order_id:
                    success = self.hammer.trade_command_cancel(self.hammer.account_key, order_id)
                    if success:
                        self.log_cardinal(f"[{timestamp}] üî¥ BUY iptal edildi: {symbol} (Order: {order_id})", 'cancel_buys')
                        cancelled_count += 1
                    else:
                        self.log_cardinal(f"[{timestamp}] ‚ö†Ô∏è BUY iptal BA≈ûARISIZ: {symbol} (Order: {order_id})", 'info')
            
            self.log_cardinal(f"[{timestamp}] üî¥ Toplam {cancelled_count} BUY emri iptal edildi.", 'cancel_buys')
            
        except Exception as e:
            print(f"[ETF CARDINAL] ‚ùå Cancel all buys hatasƒ±: {e}")
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] ‚ùå Cancel hatasƒ±: {e}", 'info')
    
    def cardinal_cancel_all_sells(self):
        """T√ºm SELL emirlerini iptal et"""
        try:
            from datetime import datetime
            timestamp = datetime.now().strftime('%H:%M:%S')
            
            # A√ßƒ±k emirleri al
            orders = self.hammer.get_orders(self.hammer.account_key)
            
            sell_orders = [o for o in orders if o.get('Action', '').lower() in ['sell', 'short'] and o.get('IsOpen', False)]
            
            if not sell_orders:
                self.log_cardinal(f"[{timestamp}] ‚ÑπÔ∏è ƒ∞ptal edilecek SELL emri bulunamadƒ±.", 'info')
                return
            
            cancelled_count = 0
            for order in sell_orders:
                order_id = order.get('OrderID')
                symbol = order.get('Symbol', 'N/A')
                
                if order_id:
                    success = self.hammer.trade_command_cancel(self.hammer.account_key, order_id)
                    if success:
                        self.log_cardinal(f"[{timestamp}] üü¢ SELL iptal edildi: {symbol} (Order: {order_id})", 'cancel_sells')
                        cancelled_count += 1
                    else:
                        self.log_cardinal(f"[{timestamp}] ‚ö†Ô∏è SELL iptal BA≈ûARISIZ: {symbol} (Order: {order_id})", 'info')
            
            self.log_cardinal(f"[{timestamp}] üü¢ Toplam {cancelled_count} SELL emri iptal edildi.", 'cancel_sells')
            
        except Exception as e:
            print(f"[ETF CARDINAL] ‚ùå Cancel all sells hatasƒ±: {e}")
            self.log_cardinal(f"[{datetime.now().strftime('%H:%M:%S')}] ‚ùå Cancel hatasƒ±: {e}", 'info')
    
    def show_tgfilterer(self):
        """TGFilterer penceresi - Grup bazlƒ± Top/Bottom 3 analizi ve filtreleme"""
        try:
            import tkinter as tk
            from tkinter import ttk
            import pandas as pd
            import os
            
            print(f"[TGFilterer] üîç TGFilterer ba≈ülatƒ±lƒ±yor...")
            
            # Hammer Pro baƒülƒ± mƒ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("Uyarƒ±", "Hammer Pro baƒülantƒ±sƒ± gerekli!")
                return
            
            # TGFilterer penceresi
            tg_win = tk.Toplevel(self)
            tg_win.title("üîç TGFilterer - Grup Bazlƒ± Top/Bottom Analizi")
            tg_win.geometry("1400x800")
            # transient kaldƒ±rƒ±ldƒ± - baƒüƒ±msƒ±z pencere, minimize edilebilir
            
            # =============== √úST PANEL - Fƒ∞LTRELER ===============
            filter_frame = ttk.LabelFrame(tg_win, text="üîß Filtreler")
            filter_frame.pack(fill='x', padx=10, pady=5)
            
            # Filtre satƒ±r 1 - Sayƒ±sal filtreler
            filter_row1 = ttk.Frame(filter_frame)
            filter_row1.pack(fill='x', padx=5, pady=3)
            
            # Spread filtresi
            ttk.Label(filter_row1, text="Spread:").pack(side='left', padx=2)
            spread_op_var = tk.StringVar(value="<")
            spread_op = ttk.Combobox(filter_row1, textvariable=spread_op_var, values=["<", ">", "=", "<=", ">="], width=3)
            spread_op.pack(side='left', padx=2)
            spread_val_var = tk.StringVar(value="0.10")
            spread_entry = ttk.Entry(filter_row1, textvariable=spread_val_var, width=8)
            spread_entry.pack(side='left', padx=2)
            
            ttk.Label(filter_row1, text="  |  ").pack(side='left')
            
            # FINAL_THG filtresi
            ttk.Label(filter_row1, text="FINAL_THG:").pack(side='left', padx=2)
            thg_op_var = tk.StringVar(value=">")
            thg_op = ttk.Combobox(filter_row1, textvariable=thg_op_var, values=["<", ">", "=", "<=", ">="], width=3)
            thg_op.pack(side='left', padx=2)
            thg_val_var = tk.StringVar(value="0")
            thg_entry = ttk.Entry(filter_row1, textvariable=thg_val_var, width=8)
            thg_entry.pack(side='left', padx=2)
            
            ttk.Label(filter_row1, text="  |  ").pack(side='left')
            
            # SHORT_FINAL filtresi
            ttk.Label(filter_row1, text="SHORT_FINAL:").pack(side='left', padx=2)
            short_op_var = tk.StringVar(value=">")
            short_op = ttk.Combobox(filter_row1, textvariable=short_op_var, values=["<", ">", "=", "<=", ">="], width=3)
            short_op.pack(side='left', padx=2)
            short_val_var = tk.StringVar(value="0")
            short_entry = ttk.Entry(filter_row1, textvariable=short_val_var, width=8)
            short_entry.pack(side='left', padx=2)
            
            # Filtre satƒ±r 2 - Grup se√ßimi
            filter_row2 = ttk.Frame(filter_frame)
            filter_row2.pack(fill='x', padx=5, pady=3)
            
            ttk.Label(filter_row2, text="Gruplar:").pack(side='left', padx=2)
            
            # Grup checkboxlarƒ±
            group_vars = {}
            all_groups = ['FF', 'NFF', 'DEZNFF', 'KUPONLU', 'OTELREM', 'HIGHMATUR', 'C400', 'C425', 'C450', 'C475', 'C500', 'C525', 'C550', 'C575', 'C600']
            
            for grp in all_groups:
                var = tk.BooleanVar(value=True)
                group_vars[grp] = var
                cb = ttk.Checkbutton(filter_row2, text=grp, variable=var)
                cb.pack(side='left', padx=3)
            
            # T√ºm√ºn√º se√ß / kaldƒ±r butonlarƒ±
            def select_all_groups():
                for var in group_vars.values():
                    var.set(True)
            
            def deselect_all_groups():
                for var in group_vars.values():
                    var.set(False)
            
            ttk.Button(filter_row2, text="T√ºm√ºn√º Se√ß", command=select_all_groups).pack(side='left', padx=5)
            ttk.Button(filter_row2, text="T√ºm√ºn√º Kaldƒ±r", command=deselect_all_groups).pack(side='left', padx=2)
            
            # Filtre satƒ±r 3 - Metrik se√ßimi ve kontroller
            filter_row3 = ttk.Frame(filter_frame)
            filter_row3.pack(fill='x', padx=5, pady=3)
            
            ttk.Label(filter_row3, text="Metrik:").pack(side='left', padx=2)
            metric_var = tk.StringVar(value="T√ºm√º")
            metric_combo = ttk.Combobox(filter_row3, textvariable=metric_var, width=25, values=[
                "T√ºm√º",
                "Prev_Close vs Last",
                "Bid Buy Pahalilik",
                "Ask Sell Pahalilik",
                "Bid Sell Pahalilik",
                "Ask Buy Pahalilik",
                "Front Buy Pahalilik",
                "Front Sell Pahalilik"
            ])
            metric_combo.pack(side='left', padx=5)
            
            ttk.Label(filter_row3, text="Top/Bottom:").pack(side='left', padx=5)
            topbottom_var = tk.StringVar(value="T√ºm√º")
            topbottom_combo = ttk.Combobox(filter_row3, textvariable=topbottom_var, width=12, values=["T√ºm√º", "Top 3", "Bottom 3"])
            topbottom_combo.pack(side='left', padx=2)
            
            # Progress label
            progress_label = ttk.Label(filter_row3, text="")
            progress_label.pack(side='left', padx=20)
            
            # Butonlar
            btn_analyze = ttk.Button(filter_row3, text="üîç Analiz Et", command=lambda: run_analysis())
            btn_analyze.pack(side='right', padx=5)
            
            btn_filter = ttk.Button(filter_row3, text="üîß Filtre Uygula", command=lambda: apply_filters())
            btn_filter.pack(side='right', padx=5)
            
            # =============== SONU√á TABLOSU ===============
            result_frame = ttk.LabelFrame(tg_win, text="üìä Sonu√ßlar")
            result_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Tablo kolonlarƒ±
            columns = ('Symbol', 'Grup', 'Metrik', 'Rank', 'Deƒüer', 'Prev_Close', 'Last', 'Bid', 'Ask', 
                      'Spread', 'FINAL_THG', 'SHORT_FINAL', 'CGRUP')
            result_tree = ttk.Treeview(result_frame, columns=columns, show='headings', height=25)
            
            col_widths = {
                'Symbol': 90, 'Grup': 80, 'Metrik': 140, 'Rank': 70, 'Deƒüer': 80,
                'Prev_Close': 80, 'Last': 70, 'Bid': 70, 'Ask': 70,
                'Spread': 60, 'FINAL_THG': 80, 'SHORT_FINAL': 85, 'CGRUP': 60
            }
            
            for col in columns:
                result_tree.heading(col, text=col)
                result_tree.column(col, width=col_widths.get(col, 70), anchor='center')
            
            # Scrollbar
            scrollbar_y = ttk.Scrollbar(result_frame, orient='vertical', command=result_tree.yview)
            scrollbar_x = ttk.Scrollbar(result_frame, orient='horizontal', command=result_tree.xview)
            result_tree.configure(yscrollcommand=scrollbar_y.set, xscrollcommand=scrollbar_x.set)
            
            result_tree.pack(side='left', fill='both', expand=True)
            scrollbar_y.pack(side='right', fill='y')
            
            # Tag renkleri
            result_tree.tag_configure('top', background='#90EE90')  # Ye≈üil - Top
            result_tree.tag_configure('bottom', background='#FFB6C1')  # Kƒ±rmƒ±zƒ± - Bottom
            
            # Veri saklama
            all_results = []
            
            def get_group_for_symbol(symbol, cgrup, file_source):
                """Sembol i√ßin grup belirle"""
                # Dosya kaynaƒüƒ±na g√∂re ana grup
                if 'heldff' in file_source.lower():
                    return 'FF'
                elif 'heldnff' in file_source.lower():
                    return 'NFF'
                elif 'helddeznff' in file_source.lower():
                    return 'DEZNFF'
                elif 'heldotelrem' in file_source.lower():
                    return 'OTELREM'
                elif 'highmatur' in file_source.lower():
                    return 'HIGHMATUR'
                elif 'heldkuponlu' in file_source.lower():
                    # Kuponlu i√ßin CGRUP'a g√∂re grupla
                    if pd.notna(cgrup):
                        cgrup_str = str(cgrup).upper().strip()
                        # Sayƒ±sal deƒüeri √ßƒ±kar
                        cgrup_num = ''.join(filter(str.isdigit, cgrup_str))
                        if cgrup_num:
                            if cgrup_num == '400':
                                return 'C400'
                            elif cgrup_num == '425':
                                return 'C425'
                            elif cgrup_num == '450':
                                return 'C450'
                            elif cgrup_num == '475':
                                return 'C475'
                            elif cgrup_num == '500':
                                return 'C500'
                            elif cgrup_num == '525':
                                return 'C525'
                            elif cgrup_num == '550':
                                return 'C550'
                            elif cgrup_num == '575':
                                return 'C575'
                            elif cgrup_num == '600':
                                return 'C600'
                    return 'KUPONLU'
                return 'OTHER'
            
            def run_analysis():
                """T√ºm mini450 i√ßin analiz √ßalƒ±≈ütƒ±r"""
                nonlocal all_results
                all_results = []
                
                try:
                    progress_label.config(text="Analiz ba≈ülƒ±yor...")
                    tg_win.update()
                    
                    # T√ºm janek dosyalarƒ±nƒ± oku
                    janall_dir = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))
                    janek_files = [
                        ('janek_ssfinekheldff.csv', 'heldff'),
                        ('janek_ssfinekheldnff.csv', 'heldnff'),
                        ('janek_ssfinekhelddeznff.csv', 'helddeznff'),
                        ('janek_ssfinekheldkuponlu.csv', 'heldkuponlu'),
                        ('janek_ssfinekheldotelrem.csv', 'heldotelrem'),
                        ('janek_ssfinekhighmatur.csv', 'highmatur')
                    ]
                    
                    all_stocks = []
                    
                    for filename, source in janek_files:
                        filepath = os.path.join(janall_dir, filename)
                        if os.path.exists(filepath):
                            try:
                                df = pd.read_csv(filepath)
                                df['_source'] = source
                                all_stocks.append(df)
                                print(f"[TGFilterer] ‚úÖ {filename}: {len(df)} hisse")
                            except Exception as e:
                                print(f"[TGFilterer] ‚ö†Ô∏è {filename} okuma hatasƒ±: {e}")
                    
                    if not all_stocks:
                        messagebox.showwarning("Uyarƒ±", "Hi√ßbir veri dosyasƒ± bulunamadƒ±!")
                        return
                    
                    # T√ºm verileri birle≈ütir
                    combined_df = pd.concat(all_stocks, ignore_index=True)
                    total_stocks = len(combined_df)
                    
                    print(f"[TGFilterer] üìä Toplam {total_stocks} hisse analiz edilecek")
                    
                    # Her hisse i√ßin canlƒ± veri √ßek ve skorlarƒ± hesapla
                    stock_data = []
                    
                    for idx, row in combined_df.iterrows():
                        symbol = row.get('PREF IBKR', '')
                        if not symbol:
                            continue
                        
                        if idx % 50 == 0:
                            progress_label.config(text=f"Analiz: {idx+1}/{total_stocks}")
                            tg_win.update()
                        
                        try:
                            # CSV'den veriler
                            prev_close = float(row.get('prev_close', 0) or 0)
                            final_thg = float(row.get('FINAL_THG', 0) or 0)
                            short_final = float(row.get('SHORT_FINAL', 0) or 0)
                            cgrup = row.get('CGRUP', '')
                            source = row.get('_source', '')
                            
                            # Canlƒ± veri √ßek
                            market_data = self.hammer.get_market_data(symbol)
                            
                            if market_data and prev_close > 0:
                                last = float(market_data.get('last', 0) or 0)
                                bid = float(market_data.get('bid', 0) or 0)
                                ask = float(market_data.get('ask', 0) or 0)
                                
                                if last > 0 and bid > 0 and ask > 0:
                                    spread = ask - bid
                                    front = (bid + ask) / 2
                                    
                                    # Grup belirle
                                    group = get_group_for_symbol(symbol, cgrup, source)
                                    
                                    # Skorlarƒ± hesapla
                                    prev_last_diff = last - prev_close  # Prev vs Last farkƒ±
                                    bid_buy_score = bid - prev_close    # Bid Buy Pahalilik
                                    ask_sell_score = ask - prev_close   # Ask Sell Pahalilik
                                    bid_sell_score = bid - prev_close   # Bid Sell Pahalilik
                                    ask_buy_score = ask - prev_close    # Ask Buy Pahalilik
                                    front_buy_score = front - prev_close  # Front Buy Pahalilik
                                    front_sell_score = front - prev_close  # Front Sell Pahalilik
                                    
                                    stock_data.append({
                                        'symbol': symbol,
                                        'group': group,
                                        'cgrup': cgrup,
                                        'prev_close': prev_close,
                                        'last': last,
                                        'bid': bid,
                                        'ask': ask,
                                        'spread': spread,
                                        'final_thg': final_thg,
                                        'short_final': short_final,
                                        'prev_last_diff': prev_last_diff,
                                        'bid_buy_score': bid_buy_score,
                                        'ask_sell_score': ask_sell_score,
                                        'bid_sell_score': bid_sell_score,
                                        'ask_buy_score': ask_buy_score,
                                        'front_buy_score': front_buy_score,
                                        'front_sell_score': front_sell_score
                                    })
                        except Exception as e:
                            pass  # Sessizce ge√ß
                    
                    print(f"[TGFilterer] üìä {len(stock_data)} hisse i√ßin veri toplandƒ±")
                    
                    # Gruplara ayƒ±r ve Top/Bottom 3 bul
                    metrics = [
                        ('prev_last_diff', 'Prev_Close vs Last'),
                        ('bid_buy_score', 'Bid Buy Pahalilik'),
                        ('ask_sell_score', 'Ask Sell Pahalilik'),
                        ('bid_sell_score', 'Bid Sell Pahalilik'),
                        ('ask_buy_score', 'Ask Buy Pahalilik'),
                        ('front_buy_score', 'Front Buy Pahalilik'),
                        ('front_sell_score', 'Front Sell Pahalilik')
                    ]
                    
                    groups_found = set(s['group'] for s in stock_data)
                    
                    for group in groups_found:
                        group_stocks = [s for s in stock_data if s['group'] == group]
                        
                        if len(group_stocks) < 2:
                            continue
                        
                        for metric_key, metric_name in metrics:
                            # Sƒ±rala
                            sorted_stocks = sorted(group_stocks, key=lambda x: x[metric_key], reverse=True)
                            
                            # Top 3
                            for i, stock in enumerate(sorted_stocks[:3]):
                                all_results.append({
                                    'symbol': stock['symbol'],
                                    'group': group,
                                    'metric': metric_name,
                                    'rank': f"Top {i+1}",
                                    'rank_type': 'top',
                                    'value': stock[metric_key],
                                    'prev_close': stock['prev_close'],
                                    'last': stock['last'],
                                    'bid': stock['bid'],
                                    'ask': stock['ask'],
                                    'spread': stock['spread'],
                                    'final_thg': stock['final_thg'],
                                    'short_final': stock['short_final'],
                                    'cgrup': stock['cgrup']
                                })
                            
                            # Bottom 3
                            for i, stock in enumerate(sorted_stocks[-3:]):
                                all_results.append({
                                    'symbol': stock['symbol'],
                                    'group': group,
                                    'metric': metric_name,
                                    'rank': f"Bottom {3-i}",
                                    'rank_type': 'bottom',
                                    'value': stock[metric_key],
                                    'prev_close': stock['prev_close'],
                                    'last': stock['last'],
                                    'bid': stock['bid'],
                                    'ask': stock['ask'],
                                    'spread': stock['spread'],
                                    'final_thg': stock['final_thg'],
                                    'short_final': stock['short_final'],
                                    'cgrup': stock['cgrup']
                                })
                    
                    progress_label.config(text=f"‚úÖ Analiz tamamlandƒ±: {len(all_results)} sonu√ß")
                    
                    # Filtreleri uygula
                    apply_filters()
                    
                except Exception as e:
                    print(f"[TGFilterer] ‚ùå Analiz hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    progress_label.config(text=f"‚ùå Hata: {e}")
            
            def apply_filters():
                """Filtreleri uygula ve tabloyu g√ºncelle"""
                nonlocal all_results
                
                # Tabloyu temizle
                for item in result_tree.get_children():
                    result_tree.delete(item)
                
                if not all_results:
                    return
                
                try:
                    # Filtre deƒüerlerini al
                    spread_operator = spread_op_var.get()
                    spread_value = float(spread_val_var.get()) if spread_val_var.get() else None
                    
                    thg_operator = thg_op_var.get()
                    thg_value = float(thg_val_var.get()) if thg_val_var.get() else None
                    
                    short_operator = short_op_var.get()
                    short_value = float(short_val_var.get()) if short_val_var.get() else None
                    
                    selected_groups = [grp for grp, var in group_vars.items() if var.get()]
                    selected_metric = metric_var.get()
                    selected_topbottom = topbottom_var.get()
                    
                    filtered = []
                    
                    for result in all_results:
                        # Grup filtresi
                        if result['group'] not in selected_groups:
                            continue
                        
                        # Metrik filtresi
                        if selected_metric != "T√ºm√º" and result['metric'] != selected_metric:
                            continue
                        
                        # Top/Bottom filtresi
                        if selected_topbottom == "Top 3" and result['rank_type'] != 'top':
                            continue
                        if selected_topbottom == "Bottom 3" and result['rank_type'] != 'bottom':
                            continue
                        
                        # Spread filtresi
                        if spread_value is not None:
                            if not compare_value(result['spread'], spread_operator, spread_value):
                                continue
                        
                        # FINAL_THG filtresi
                        if thg_value is not None:
                            if not compare_value(result['final_thg'], thg_operator, thg_value):
                                continue
                        
                        # SHORT_FINAL filtresi
                        if short_value is not None:
                            if not compare_value(result['short_final'], short_operator, short_value):
                                continue
                        
                        filtered.append(result)
                    
                    # Tabloya ekle
                    for result in filtered:
                        tag = result['rank_type']
                        values = (
                            result['symbol'],
                            result['group'],
                            result['metric'],
                            result['rank'],
                            f"{result['value']:.4f}",
                            f"${result['prev_close']:.2f}",
                            f"${result['last']:.2f}",
                            f"${result['bid']:.2f}",
                            f"${result['ask']:.2f}",
                            f"${result['spread']:.2f}",
                            f"{result['final_thg']:.2f}",
                            f"{result['short_final']:.2f}",
                            result['cgrup']
                        )
                        result_tree.insert('', 'end', values=values, tags=(tag,))
                    
                    progress_label.config(text=f"G√∂sterilen: {len(filtered)} / {len(all_results)} sonu√ß")
                    
                except Exception as e:
                    print(f"[TGFilterer] ‚ùå Filtre hatasƒ±: {e}")
            
            def compare_value(val, operator, threshold):
                """Deƒüer kar≈üƒ±la≈ütƒ±rmasƒ±"""
                if operator == "<":
                    return val < threshold
                elif operator == ">":
                    return val > threshold
                elif operator == "=":
                    return abs(val - threshold) < 0.001
                elif operator == "<=":
                    return val <= threshold
                elif operator == ">=":
                    return val >= threshold
                return True
            
            print(f"[TGFilterer] ‚úÖ Pencere a√ßƒ±ldƒ±")
            
        except Exception as e:
            print(f"[TGFilterer] ‚ùå Hata: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"TGFilterer hatasƒ±: {e}")
    
    def show_pressure_analysis(self):
        """Pressure Analiz penceresi - Se√ßili gruptaki hisseler i√ßin alƒ±≈ü/satƒ±≈ü baskƒ±sƒ± analizi"""
        try:
            from .pressure_analyzer import PressureAnalyzer
            from .spreadkusu_panel import SpreadkusuPanel
            import tkinter as tk
            from tkinter import ttk, messagebox
            
            print(f"[PRESSURE] üîç Alƒ±≈ü/Satƒ±≈ü Baskƒ±sƒ± analizi ba≈ülatƒ±lƒ±yor...")
            
            # Mevcut grup verisi var mƒ± kontrol et
            if self.pressure_current_data is None or self.pressure_current_data.empty:
                messagebox.showwarning("Uyarƒ±", "√ñnce bir grup se√ßin (heldkuponlu, heldff vb.)")
                return
            
            # Hammer Pro baƒülƒ± mƒ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("Uyarƒ±", "Hammer Pro baƒülantƒ±sƒ± gerekli!")
                return
            
            group_name = self.pressure_current_group
            df = self.pressure_current_data
            
            # Pressure Analyzer olu≈ütur
            analyzer = PressureAnalyzer(self.hammer, self)
            
            # GRPAN i√ßin SpreadkusuPanel kullan
            spreadkusu_panel = SpreadkusuPanel(self)
            
            # Pressure Analiz sonu√ßlarƒ± penceresi
            pressure_win = tk.Toplevel(self)
            pressure_win.title(f"Pressure Analiz - Alƒ±≈ü/Satƒ±≈ü Baskƒ±sƒ± [{group_name}]")
            pressure_win.geometry("1400x700")
            
            # Ba≈ülƒ±k
            title_label = ttk.Label(pressure_win, 
                text=f"Pressure Analiz - Alƒ±≈ü/Satƒ±≈ü Baskƒ±sƒ± Skorlarƒ± [{group_name}]", 
                font=("Arial", 12, "bold"))
            title_label.pack(pady=5)
            
            # A√ßƒ±klama
            info_label = ttk.Label(pressure_win, 
                text="Buy Pressure: Alƒ±≈ü baskƒ±sƒ± skoru | Sell Pressure: Satƒ±≈ü baskƒ±sƒ± skoru | Net Pressure: Buy - Sell",
                font=("Arial", 9, 'italic'))
            info_label.pack(pady=3)
            
            # Progress label
            progress_label = ttk.Label(pressure_win, text="Analiz ba≈ülƒ±yor...")
            progress_label.pack(pady=5)
            
            # Tree frame
            tree_frame = ttk.Frame(pressure_win)
            tree_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # Pressure sonu√ßlarƒ± tablosu
            columns = ('Symbol', 'Buy Pressure', 'Sell Pressure', 'Net Pressure', 'Class', 'GRPAN', 'Bid', 'Ask', 'Spread', 'Last Print')
            pressure_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=25)
            
            col_widths = {
                'Symbol': 120, 'Buy Pressure': 100, 'Sell Pressure': 100, 'Net Pressure': 100,
                'Class': 150, 'GRPAN': 80, 'Bid': 80, 'Ask': 80, 'Spread': 70, 'Last Print': 80
            }
            
            headers = {
                'Symbol': 'Symbol', 
                'Buy Pressure': 'Buy Pressure', 
                'Sell Pressure': 'Sell Pressure',
                'Net Pressure': 'Net Pressure',
                'Class': 'Sƒ±nƒ±flandƒ±rma',
                'GRPAN': 'GRPAN',
                'Bid': 'Bid',
                'Ask': 'Ask',
                'Spread': 'Spread',
                'Last Print': 'Last Print'
            }
            
            for col in columns:
                pressure_tree.heading(col, text=headers[col])
                pressure_tree.column(col, width=col_widths.get(col, 80), anchor='center')
            
            scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=pressure_tree.yview)
            pressure_tree.configure(yscrollcommand=scrollbar.set)
            pressure_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # Sonu√ßlarƒ± hesapla
            pressure_results = []
            symbols = df['PREF IBKR'].tolist() if 'PREF IBKR' in df.columns else []
            
            total = len(symbols)
            print(f"[PRESSURE] üìä {total} hisse analiz edilecek...")
            
            for i, symbol in enumerate(symbols):
                progress_label.config(text=f"Analiz ediliyor: {symbol} ({i+1}/{total})")
                pressure_win.update()
                
                try:
                    # GRPAN fiyatƒ±nƒ± al
                    grpan_data = spreadkusu_panel.get_grpan_price(symbol)
                    grpan_price = grpan_data.get('price') if grpan_data else None
                    
                    # Pressure analizi yap
                    result = analyzer.calculate_pressure_scores(symbol, grpan_price=grpan_price)
                    
                    if result:
                        # Snapshot verilerini al
                        snapshot = result.get('snapshot', {})
                        bid = snapshot.get('bid', 0)
                        ask = snapshot.get('ask', 0)
                        last = snapshot.get('last', 0)
                        spread = snapshot.get('spread', 0)
                        
                        pressure_results.append({
                            'symbol': symbol,
                            'buy_pressure': result.get('buy_pressure_score', 0),
                            'sell_pressure': result.get('sell_pressure_score', 0),
                            'net_pressure': result.get('net_pressure', 0),
                            'pressure_class': result.get('pressure_class', 'N/A'),
                            'grpan': grpan_price if grpan_price else 'N/A',
                            'bid': bid,
                            'ask': ask,
                            'spread': spread,
                            'last': last
                        })
                    else:
                        pressure_results.append({
                            'symbol': symbol,
                            'buy_pressure': 0,
                            'sell_pressure': 0,
                            'net_pressure': 0,
                            'pressure_class': 'Veri Yok',
                            'grpan': 'N/A',
                            'bid': 0,
                            'ask': 0,
                            'spread': 0,
                            'last': 0
                        })
                        
                except Exception as e:
                    print(f"[PRESSURE] ‚ùå {symbol} analiz hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
                    pressure_results.append({
                        'symbol': symbol,
                        'buy_pressure': 0,
                        'sell_pressure': 0,
                        'net_pressure': 0,
                        'pressure_class': 'Hata',
                        'grpan': 'N/A',
                        'bid': 0,
                        'ask': 0,
                        'spread': 0,
                        'last': 0
                    })
            
            # Sonu√ßlarƒ± Net Pressure'a g√∂re sƒ±rala
            pressure_results.sort(key=lambda x: x['net_pressure'], reverse=True)
            
            # Tabloya ekle
            for result in pressure_results:
                # Net Pressure'a g√∂re renk belirle
                net_pressure = result['net_pressure']
                if net_pressure > 0.6:
                    tag = 'strong_buy'
                elif net_pressure > 0.3:
                    tag = 'moderate_buy'
                elif net_pressure > -0.3:
                    tag = 'balanced'
                elif net_pressure > -0.6:
                    tag = 'moderate_sell'
                else:
                    tag = 'strong_sell'
                
                values = (
                    result['symbol'],
                    f"{result['buy_pressure']:.3f}",
                    f"{result['sell_pressure']:.3f}",
                    f"{result['net_pressure']:.3f}",
                    result['pressure_class'],
                    f"${result['grpan']:.2f}" if isinstance(result['grpan'], (int, float)) else result['grpan'],
                    f"${result['bid']:.2f}" if result.get('bid') is not None and result['bid'] > 0 else 'N/A',
                    f"${result['ask']:.2f}" if result.get('ask') is not None and result['ask'] > 0 else 'N/A',
                    f"${result['spread']:.2f}" if result.get('spread') is not None and result['spread'] > 0 else 'N/A',
                    f"${result['last']:.2f}" if result.get('last') is not None and result['last'] > 0 else 'N/A'
                )
                
                item = pressure_tree.insert('', 'end', values=values, tags=(tag,))
            
            # Renkleri ayarla
            pressure_tree.tag_configure('strong_buy', background='#90EE90')  # A√ßƒ±k ye≈üil
            pressure_tree.tag_configure('moderate_buy', background='#E6FFE6')  # √áok a√ßƒ±k ye≈üil
            pressure_tree.tag_configure('balanced', background='white')
            pressure_tree.tag_configure('moderate_sell', background='#FFE6E6')  # √áok a√ßƒ±k kƒ±rmƒ±zƒ±
            pressure_tree.tag_configure('strong_sell', background='#FFB6C1')  # A√ßƒ±k kƒ±rmƒ±zƒ±
            
            progress_label.config(text=f"‚úÖ Analiz tamamlandƒ±: {len(pressure_results)} hisse")
            
            print(f"[PRESSURE] ‚úÖ Analiz tamamlandƒ±: {len(pressure_results)} hisse")
            
        except Exception as e:
            print(f"[PRESSURE] ‚ùå Pressure analiz hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"Pressure analiz hatasƒ±: {e}")
    
    def show_bggg_analysis(self):
        """BGGG Analiz penceresi - Bug√ºn√ºn GRPAN Grup Analizi"""
        try:
            from .bggg_analyzer import BGGGAnalyzer
            import tkinter as tk
            from tkinter import ttk, messagebox
            
            print(f"[BGGG] üîç BGGG analizi ba≈ülatƒ±lƒ±yor...")
            
            # Hammer Pro baƒülƒ± mƒ± kontrol et
            if not hasattr(self, 'hammer') or not self.hammer or not self.hammer.connected:
                messagebox.showwarning("Uyarƒ±", "Hammer Pro baƒülantƒ±sƒ± gerekli!")
                return
            
            # Mini450 sekmesi a√ßƒ±k mƒ± kontrol et
            is_mini450_mode = False
            if hasattr(self, 'df') and self.df is not None and not self.df.empty:
                # Mini450 sekmesi a√ßƒ±k
                is_mini450_mode = True
                group_name = "mini450"
                df = self.df.copy()
                print(f"[BGGG] üìä Mini450 modu aktif: {len(df)} hisse")
            elif self.pressure_current_data is not None and not self.pressure_current_data.empty:
                # Normal grup modu
                group_name = self.pressure_current_group
                df = self.pressure_current_data.copy()
                print(f"[BGGG] üìä Normal grup modu: {group_name}, {len(df)} hisse")
            else:
                messagebox.showwarning("Uyarƒ±", "√ñnce bir grup se√ßin (heldkuponlu, heldff vb.) veya mini450 sekmesini a√ßƒ±n")
                return
            
            # BGGG Analyzer olu≈ütur
            analyzer = BGGGAnalyzer(self.hammer, self)
            
            # BGGG Analiz sonu√ßlarƒ± penceresi
            bggg_win = tk.Toplevel(self)
            bggg_win.title(f"BGGG Analiz - Bug√ºn√ºn GRPAN Grup Analizi [{group_name}]")
            bggg_win.geometry("1400x700")
            
            # Ba≈ülƒ±k
            title_label = ttk.Label(bggg_win, 
                text=f"BGGG Analiz - Bug√ºn√ºn GRPAN Grup Analizi [{group_name}]", 
                font=("Arial", 12, "bold"))
            title_label.pack(pady=5)
            
            # A√ßƒ±klama
            info_label = ttk.Label(bggg_win, 
                text="BGRPAN: Bug√ºn√ºn printlerinden hesaplanan GRPAN | BGRPAN Sapmasƒ±: BGRPAN - Previous Close | BGGG AYRISMA: BGRPAN Sapmasƒ± - GRUP ORT BGRPAN Sapmasƒ±",
                font=("Arial", 9, 'italic'))
            info_label.pack(pady=3)
            
            # Progress label
            progress_label = ttk.Label(bggg_win, text="Analiz ba≈ülƒ±yor...")
            progress_label.pack(pady=5)
            
            # Tree frame
            tree_frame = ttk.Frame(bggg_win)
            tree_frame.pack(fill='both', expand=True, padx=10, pady=5)
            
            # BGGG sonu√ßlarƒ± tablosu
            columns = ('Symbol', 'Dos Grup', 'Last Print', 'BGRPAN', 'BGRPAN Sapmasƒ±', 'BGRPAN - Bid', 'BGRPAN - Ask', 
                      'GRUP ORT BGRPAN Sapmasƒ±', 'BGGG AYRISMA')
            bggg_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=25)
            
            col_widths = {
                'Symbol': 120, 'Dos Grup': 150, 'Last Print': 100, 'BGRPAN': 100, 'BGRPAN Sapmasƒ±': 120,
                'BGRPAN - Bid': 110, 'BGRPAN - Ask': 110, 'GRUP ORT BGRPAN Sapmasƒ±': 180, 'BGGG AYRISMA': 130
            }
            
            headers = {
                'Symbol': 'Symbol',
                'Dos Grup': 'Dos Grup',
                'Last Print': 'Last Print',
                'BGRPAN': 'BGRPAN',
                'BGRPAN Sapmasƒ±': 'BGRPAN Sapmasƒ±',
                'BGRPAN - Bid': 'BGRPAN - Bid',
                'BGRPAN - Ask': 'BGRPAN - Ask',
                'GRUP ORT BGRPAN Sapmasƒ±': 'GRUP ORT BGRPAN Sapmasƒ±',
                'BGGG AYRISMA': 'BGGG AYRISMA'
            }
            
            for col in columns:
                bggg_tree.heading(col, text=headers[col])
                bggg_tree.column(col, width=col_widths.get(col, 100), anchor='center')
            
            scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=bggg_tree.yview)
            bggg_tree.configure(yscrollcommand=scrollbar.set)
            
            bggg_tree.pack(side='left', fill='both', expand=True)
            scrollbar.pack(side='right', fill='y')
            
            # Analiz yap
            symbols = df['PREF IBKR'].tolist() if 'PREF IBKR' in df.columns else []
            
            if not symbols:
                messagebox.showwarning("Uyarƒ±", "DataFrame'de 'PREF IBKR' kolonu bulunamadƒ±!")
                bggg_win.destroy()
                return
            
            progress_label.config(text=f"Analiz yapƒ±lƒ±yor: 0/{len(symbols)} hisse...")
            bggg_win.update()
            
            # BGGG analizi
            bggg_results = analyzer.analyze_bggg(symbols, group_name, is_mini450=is_mini450_mode)
            
            if not bggg_results:
                messagebox.showwarning("Uyarƒ±", "BGGG analizi sonu√ß vermedi!")
                bggg_win.destroy()
                return
            
            # BGGG AYRISMA'ya g√∂re sƒ±rala
            bggg_results.sort(key=lambda x: x.get('bggg_ayrisma') if x.get('bggg_ayrisma') is not None else -999, reverse=True)
            
            # Tabloya ekle
            for result in bggg_results:
                # BGGG AYRISMA'ya g√∂re renk belirle
                bggg_ayrisma = result.get('bggg_ayrisma')
                if bggg_ayrisma is not None:
                    if bggg_ayrisma > 0.1:
                        tag = 'strong_overperform'  # G√º√ßl√º overperform
                    elif bggg_ayrisma > 0.05:
                        tag = 'moderate_overperform'  # Orta overperform
                    elif bggg_ayrisma > -0.05:
                        tag = 'balanced'  # Dengeli
                    elif bggg_ayrisma > -0.1:
                        tag = 'moderate_underperform'  # Orta underperform
                    else:
                        tag = 'strong_underperform'  # G√º√ßl√º underperform
                else:
                    tag = 'no_data'
                
                values = (
                    result['symbol'],
                    result.get('dos_grup', 'N/A'),
                    f"${result['last_print']:.2f}" if result.get('last_print') is not None else 'N/A',
                    f"${result['bgrpan']:.2f}" if result.get('bgrpan') is not None else 'N/A',
                    f"${result['bgrpan_sapma']:.4f}" if result.get('bgrpan_sapma') is not None else 'N/A',
                    f"${result['bgrpan_bid_diff']:.4f}" if result.get('bgrpan_bid_diff') is not None else 'N/A',
                    f"${result['bgrpan_ask_diff']:.4f}" if result.get('bgrpan_ask_diff') is not None else 'N/A',
                    f"${result['grup_ort_bgrpan_sapma']:.4f}" if result.get('grup_ort_bgrpan_sapma') is not None else 'N/A',
                    f"${result['bggg_ayrisma']:.4f}" if result.get('bggg_ayrisma') is not None else 'N/A'
                )
                
                item = bggg_tree.insert('', 'end', values=values, tags=(tag,))
            
            # Renkleri ayarla
            bggg_tree.tag_configure('strong_overperform', background='#90EE90')  # A√ßƒ±k ye≈üil
            bggg_tree.tag_configure('moderate_overperform', background='#E6FFE6')  # √áok a√ßƒ±k ye≈üil
            bggg_tree.tag_configure('balanced', background='white')
            bggg_tree.tag_configure('moderate_underperform', background='#FFE6E6')  # √áok a√ßƒ±k kƒ±rmƒ±zƒ±
            bggg_tree.tag_configure('strong_underperform', background='#FFB6C1')  # A√ßƒ±k kƒ±rmƒ±zƒ±
            bggg_tree.tag_configure('no_data', background='#F0F0F0')  # Gri
            
            progress_label.config(text=f"‚úÖ Analiz tamamlandƒ±: {len(bggg_results)} hisse")
            
            # Mini450 modunda ise sonu√ßlarƒ± DataFrame'e ekle
            if is_mini450_mode and hasattr(self, 'df') and self.df is not None:
                try:
                    print(f"[BGGG] üìä Mini450 DataFrame'ine BGGG sonu√ßlarƒ± ekleniyor...")
                    
                    # BGGG sonu√ßlarƒ±nƒ± dictionary'ye √ßevir (symbol -> result)
                    bggg_dict = {}
                    for result in bggg_results:
                        symbol = result.get('symbol')
                        if symbol:
                            bggg_dict[symbol] = result
                    
                    # DataFrame'e BGGG AYRISMA kolonunu ekle
                    if 'PREF IBKR' in self.df.columns:
                        self.df['BGGG AYRISMA'] = self.df['PREF IBKR'].apply(
                            lambda x: bggg_dict.get(x, {}).get('bggg_ayrisma') if x in bggg_dict else None
                        )
                        print(f"[BGGG] ‚úÖ BGGG AYRISMA kolonu mini450 DataFrame'ine eklendi")
                    else:
                        print(f"[BGGG] ‚ö†Ô∏è 'PREF IBKR' kolonu bulunamadƒ±, BGGG sonu√ßlarƒ± eklenemedi")
                        
                except Exception as e:
                    print(f"[BGGG] ‚ö†Ô∏è Mini450 DataFrame'ine ekleme hatasƒ±: {e}")
                    import traceback
                    traceback.print_exc()
            
        except Exception as e:
            print(f"[BGGG] ‚ùå BGGG analiz hatasƒ±: {e}")
            import traceback
            traceback.print_exc()
            messagebox.showerror("Hata", f"BGGG analiz hatasƒ±: {e}")
    